<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü - ‰∏âÈò∂ÊÆµÂçè‰ΩúÂàÜÊûê</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- ÊñáÊ°£Ëß£ÊûêÂ∫ì -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- OCRÂ∫ì -->
    <script src="https://unpkg.com/tesseract.js@v5.0.4/dist/tesseract.esm.min.js" type="module" onerror="console.warn('OCRÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåÂõæÁâáËß£ÊûêÂäüËÉΩÂèØËÉΩÂèóÈôê')"></script>
    <!-- PDFÂØºÂá∫Â∫ì -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" onerror="this.onerror=null; this.src='https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js'"></script>
    <!-- ÁÆÄÁπÅËΩ¨Êç¢Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            scroll-padding-top: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            scroll-margin-top: 80px;
            transition: all 0.3s ease;
            position: relative;
        }
        .card.active-generation {
            box-shadow: 0 0 30px rgba(24, 144, 255, 0.8);
            border: 2px solid rgba(24, 144, 255, 0.6);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(24, 144, 255, 0.8); }
            50% { box-shadow: 0 0 45px rgba(24, 144, 255, 1); }
        }
        .card.active-generation::before {
            content: '‚ú® Ê≠£Âú®ÁîüÊàê‰∏≠...';
            position: absolute;
            top: -30px;
            right: 20px;
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
            animation: float 2s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ÁîüÊàêÊùêÊñôÊåâÈíÆhoverÊïàÊûú */
        .material-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 32px rgba(19, 194, 194, 0.6);
        }
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover { border-color: #1890ff; }
        input[type="file"] { display: none; }
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #40a9ff; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .message.success { background: rgba(82, 196, 26, 0.1); border-left: 4px solid #52c41a; }
        .message.error { background: rgba(255, 77, 79, 0.1); border-left: 4px solid #ff4d4f; }
        .message.info { background: rgba(24, 144, 255, 0.1); border-left: 4px solid #1890ff; }
        #messageBox { display: none; }
        .hidden { display: none; }

        /* ÊïôÊ°àËæìÂÖ•ÂØπËØùÊ°ÜÊ†∑Âºè */
        #lessonPlanInput label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
        }

        #lessonPlanInput input[type="text"],
        #lessonPlanInput textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #lessonPlanInput input[type="text"]:focus,
        #lessonPlanInput textarea:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        #lessonPlanInput textarea {
            resize: vertical;
            min-height: 100px;
        }

        #lessonPlanInput .btn {
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        #lessonPlanInput .btn:hover {
            transform: translateY(-1px);
        }

        /* Êñá‰ª∂È¢ÑËßàÊ†∑ÂºèÂ¢ûÂº∫ */
        .file-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .file-preview .image-info {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: 15px;
        }

        .file-preview pre {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Èò∂ÊÆµÂÆπÂô®Ê†∑Âºè */
        .stage-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stage-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stage-header i {
            font-size: 1.5rem;
            color: #1890ff;
        }

        .stage-header span {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        /* ËøõÂ∫¶Êù°Ê†∑Âºè */
        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #40a9ff);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-align: center;
        }

        /* ‰∏ìÂÆ∂Âç°ÁâáÊ†∑Âºè */
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .agent-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .agent-specialty {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .agent-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .agent-status.waiting {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }

        .agent-status.analyzing {
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
        }

        .agent-status.completed {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
        }

        .agent-analysis {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        /* ÊµÅÂºèËæìÂá∫Ê†∑Âºè */
        .streaming {
            position: relative;
            color: rgba(255, 255, 255, 0.7);
        }

        .streaming::after {
            content: '|';
            animation: blink 1s infinite;
            color: #1890ff;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 4px 12px rgba(114, 46, 209, 0.4);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 8px 24px rgba(114, 46, 209, 0.6);
            }
        }

        .analysis-content {
            min-height: 1.2em;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
        }

        /* ÂàùÊ≠•ÊïôÊ°à‰∏ìÁî®Ê†∑Âºè */
        #initialPlanText {
            background: rgba(0, 0, 0, 0.2);
            padding: 25px;
            border-radius: 10px;
            line-height: 2;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.95);
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) rgba(0, 0, 0, 0.1);
        }

        #initialPlanText::-webkit-scrollbar {
            width: 8px;
        }

        #initialPlanText::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        #initialPlanText::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        #initialPlanText::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* ‰∏ªÊåÅ‰∫∫Âç°ÁâáÊ†∑Âºè */
        .moderator-card {
            background: linear-gradient(135deg, rgba(250, 140, 22, 0.15), rgba(250, 140, 22, 0.05));
            border: 2px solid rgba(250, 140, 22, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(250, 140, 22, 0.1);
        }

        .moderator-content {
            margin-top: 20px;
        }

        .moderator-speech {
            background: rgba(0, 0, 0, 0.2);
            border-left: 4px solid #fa8c16;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .moderator-speech:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: translateX(5px);
        }

        .moderator-speech.summary {
            border-left-color: #52c41a;
            background: rgba(82, 196, 26, 0.1);
        }

        .moderator-speech.intervention {
            border-left-color: #ff4d4f;
            background: rgba(255, 77, 79, 0.1);
            animation: pulseWarning 0.5s ease-in-out;
        }

        @keyframes pulseWarning {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 77, 79, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 77, 79, 0.5); }
        }

        .intervention-target {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .moderator-intervention {
            animation: pulseWarning 0.5s ease-in-out;
        }
        
        .moderator-intervention .intervention-target {
            margin-left: auto;
        }

        .speech-label {
            font-size: 0.85rem;
            color: #fa8c16;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .topic-label {
            display: inline-block;
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .speech-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* 5EÊ®°ÂûãÊ†∑Âºè */
        .five-e-container {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(75, 0, 130, 0.05));
            border: 2px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.15);
        }

        .five-e-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(138, 43, 226, 0.2);
        }

        .five-e-header h3 {
            font-size: 1.4rem;
            color: white;
            margin: 0;
        }

        .five-e-stages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .five-e-stage {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .five-e-stage.active {
            border-color: currentColor;
            box-shadow: 0 0 20px currentColor;
            transform: scale(1.05);
        }

        .five-e-stage-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .five-e-stage-icon {
            font-size: 1.8rem;
        }

        .five-e-stage-name {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .five-e-stage-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-top: 8px;
        }

        .five-e-stage-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            min-height: 60px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .five-e-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .five-e-badge-engage {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
            border: 1px solid rgba(255, 77, 79, 0.4);
        }

        .five-e-badge-explore {
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            border: 1px solid rgba(24, 144, 255, 0.4);
        }

        .five-e-badge-explain {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.4);
        }

        .five-e-badge-extend {
            background: rgba(114, 46, 209, 0.2);
            color: #722ed1;
            border: 1px solid rgba(114, 46, 209, 0.4);
        }

        .five-e-badge-evaluate {
            background: rgba(250, 140, 22, 0.2);
            color: #fa8c16;
            border: 1px solid rgba(250, 140, 22, 0.4);
        }

        /* ËÆ®ËÆ∫ËΩÆÊ¨°Ê†∑Âºè */
        .discussion-round {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ËÆ®ËÆ∫Âå∫ÂüüÊ†∑ÂºèÂ¢ûÂº∫ */
        .discussion-area {
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            margin-top: 15px;
        }

        .discussion-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 12px 0;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .discussion-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(3px);
        }

        /* ‰∏ìÂÆ∂ÊîπËøõÂêéÁöÑËßÇÁÇπ - ÁâπÊÆäÊ†∑Âºè */
        .discussion-item.expert-improved {
            background: linear-gradient(135deg, rgba(82, 196, 26, 0.15), rgba(82, 196, 26, 0.05));
            border: 2px solid rgba(82, 196, 26, 0.4);
            box-shadow: 0 4px 20px rgba(82, 196, 26, 0.2);
            animation: slideInImproved 0.5s ease-out;
        }

        @keyframes slideInImproved {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes slideInSave {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .improved-badge {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);
        }

        .improved-badge i {
            font-size: 0.9rem;
        }

        .discussion-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .discussion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .discussion-info {
            flex: 1;
        }

        .discussion-expert {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            margin-bottom: 2px;
        }

        .discussion-specialty {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .discussion-tag {
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            white-space: nowrap;
        }

        .discussion-content {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
            padding-left: 52px;
        }

        /* ÊäïÁ•®Áõ∏ÂÖ≥Ê†∑Âºè */
        .vote-section {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vote-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .vote-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .vote-btn.agree {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
        }

        .vote-btn.disagree {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
        }

        .vote-btn.abstain {
            background: rgba(156, 156, 156, 0.2);
            color: #9ca3af;
        }

        .vote-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .vote-results {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .vote-count {
            margin-right: 15px;
        }

        .agree-count {
            color: #52c41a;
        }

        .disagree-count {
            color: #ff4d4f;
        }

        .abstain-count {
            color: #9ca3af;
        }

        /* ÊäïÁ•®Èò∂ÊÆµÊ†áÈ¢ò */
        .discussion-voting-header {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.2), rgba(24, 144, 255, 0.1));
            border: 1px solid rgba(24, 144, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .voting-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 8px;
        }

        .voting-instruction {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ÊäïÁ•®Âç°ÁâáÊ†∑Âºè */
        .vote-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .vote-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .vote-card-header {
            margin-bottom: 12px;
        }

        .vote-opinion-author {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vote-opinion-content {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 15px;
            border-left: 4px solid rgba(24, 144, 255, 0.5);
        }

        .vote-section {
            margin-top: 15px;
        }

        .vote-summary {
            display: flex;
            gap: 20px;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .vote-count {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }

        .vote-count.agree-count {
            color: #52c41a;
        }

        .vote-count.disagree-count {
            color: #ff4d4f;
        }

        .vote-count strong {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .toggle-reasons-btn {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.8), rgba(24, 144, 255, 0.6));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-reasons-btn:hover {
            background: linear-gradient(135deg, rgba(24, 144, 255, 1), rgba(24, 144, 255, 0.8));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
        }

        .vote-reasons {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            display: none;
        }

        .vote-reason-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .vote-reason-item.agree {
            border-left-color: #52c41a;
            background: rgba(82, 196, 26, 0.05);
        }

        .vote-reason-item.disagree {
            border-left-color: #ff4d4f;
            background: rgba(255, 77, 79, 0.05);
        }

        .vote-reason-item.failed {
            border-left-color: #faad14;
            background: rgba(250, 173, 20, 0.05);
            opacity: 0.8;
        }

        .failed-badge {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            color: white !important;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .voter-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .voter-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
        }

        .voter-name {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .vote-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: auto;
        }

        .vote-badge.agree {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
        }

        .vote-badge.disagree {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
        }

        .vote-reason-text {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            font-size: 0.9rem;
            padding-left: 38px;
        }

        /* ÈááÁ∫≥ËßÇÁÇπÊ†∑Âºè */
        .accepted-opinion {
            background: linear-gradient(135deg, rgba(82, 196, 26, 0.15), rgba(82, 196, 26, 0.05));
            border: 2px solid rgba(82, 196, 26, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            animation: acceptedPulse 2s ease-in-out;
        }

        .accepted-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .accepted-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
        }

        .accepted-info {
            flex: 1;
        }

        .accepted-expert {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            margin-bottom: 2px;
        }

        .accepted-specialty {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .accepted-badge {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .accepted-content {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.5;
            padding-left: 47px;
        }

        @keyframes acceptedPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(82, 196, 26, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(82, 196, 26, 0); }
        }

        /* ÊúÄÁªàÊäïÁ•®Ê†∑Âºè */
        .final-vote-header {
            background: linear-gradient(135deg, rgba(250, 140, 22, 0.2), rgba(250, 140, 22, 0.1));
            border: 2px solid rgba(250, 140, 22, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .final-vote-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fa8c16;
            margin-bottom: 10px;
        }

        .final-vote-instruction {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .final-vote-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .final-vote-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .final-vote-btn.approve {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            border: 2px solid rgba(82, 196, 26, 0.3);
        }

        .final-vote-btn.reject {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
            border: 2px solid rgba(255, 77, 79, 0.3);
        }

        .final-vote-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .final-vote-results {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .final-vote-count {
            margin: 0 10px;
        }

        .approve-count {
            color: #52c41a;
        }

        .reject-count {
            color: #ff4d4f;
        }

        /* ÊúÄÁªàÁªìÊûúÈ¢ÑËßàÊ†∑Âºè */
        .final-results-preview {
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.15), rgba(24, 144, 255, 0.05));
            border: 2px solid rgba(24, 144, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(24, 144, 255, 0.3);
        }

        .preview-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            font-size: 0.9rem;
        }

        /* ÊúÄÁªàÊâπÂáÜÊ†∑Âºè */
        .final-approval {
            background: linear-gradient(135deg, rgba(82, 196, 26, 0.2), rgba(82, 196, 26, 0.1));
            border: 2px solid rgba(82, 196, 26, 0.4);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            animation: celebration 2s ease-in-out;
        }

        .approval-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #52c41a;
            margin-bottom: 15px;
        }

        .approval-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .approval-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .approval-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .approval-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* ÈáçÊñ∞ËÆ®ËÆ∫Ê†∑Âºè */
        .re-discussion {
            background: linear-gradient(135deg, rgba(250, 140, 22, 0.2), rgba(250, 140, 22, 0.1));
            border: 2px solid rgba(250, 140, 22, 0.4);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .re-discussion-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fa8c16;
            margin-bottom: 15px;
        }

        .re-discussion-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .re-discussion-actions {
            display: flex;
            justify-content: center;
        }

        .re-discussion-btn {
            padding: 12px 24px;
            background: rgba(250, 140, 22, 0.2);
            color: #fa8c16;
            border: 2px solid rgba(250, 140, 22, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .re-discussion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* OCRÈ¢ÑËßàÊ†∑Âºè */
        .ocr-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #1890ff;
        }

        .ocr-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #1890ff;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .ocr-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            font-size: 0.85rem;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* ËØæÁ®ãÊùêÊñôÁîüÊàêÈÉ®ÂàÜÊ†∑Âºè */
        .course-material-section {
            background: linear-gradient(135deg, rgba(19, 194, 194, 0.15), rgba(19, 194, 194, 0.05));
            border: 2px solid rgba(19, 194, 194, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .material-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #13c2c2;
            margin-bottom: 20px;
        }

        .material-header i {
            font-size: 1.5rem;
        }

        .material-progress {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }

        .material-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .material-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .material-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preview-btn {
            background: linear-gradient(135deg, #1890ff, #36cfc9);
            color: white;
        }

        .open-btn {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            color: white;
        }

        .download-btn {
            background: linear-gradient(135deg, #722ed1, #9254de);
            color: white;
        }

        .material-preview-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .material-preview-container .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .material-preview-container .preview-header span {
            font-size: 1.1rem;
            font-weight: 600;
            color: #13c2c2;
        }

        .close-preview-btn {
            padding: 8px 16px;
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
            border: 1px solid rgba(255, 77, 79, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .close-preview-btn:hover {
            background: rgba(255, 77, 79, 0.3);
        }

        /* iframeÊéßÂà∂ÊåâÈíÆÊ†∑Âºè */
        .frame-control-btn {
            padding: 8px 12px;
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            border: 1px solid rgba(24, 144, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .frame-control-btn:hover {
            background: rgba(24, 144, 255, 0.3);
            transform: translateY(-1px);
        }

        .frame-nav-btn {
            padding: 8px 16px;
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .frame-nav-btn:hover {
            background: rgba(82, 196, 26, 0.3);
            transform: scale(1.05);
        }

        .frame-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ÂÖ®Â±èÊ†∑Âºè */
        .fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .fullscreen-container iframe {
            flex: 1;
            height: 100% !important;
        }

        /* ÊùêÊñôÂàóË°®Âç°ÁâáÊ†∑Âºè */
        .material-card {
            transition: all 0.3s ease;
        }

        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .list-material-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .list-material-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* È°∂ÈÉ®Âø´Êç∑ËÆøÈóÆÊ†è */
        .quick-access-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            animation: slideDown 0.5s ease;
        }
        
        .quick-access-bar.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .quick-access-title {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-access-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .quick-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .quick-btn.primary {
            background: linear-gradient(135deg, #722ed1, #eb2f96);
            border-color: transparent;
            animation: pulse 2s infinite;
        }
        
        .quick-btn.primary:hover {
            transform: translateY(-2px) scale(1.05);
        }
        
        /* ‰∏ìÂÆ∂Ë¥°ÁåÆË°®Ê†ºÊ†∑Âºè */
        .contribution-table {
            width: 100%;
            color: rgba(255,255,255,0.9);
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .contribution-table thead tr {
            background: rgba(255,255,255,0.1);
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        
        .contribution-table th {
            padding: 12px;
            text-align: left;
            border-right: 1px solid rgba(255,255,255,0.2);
            font-weight: 600;
        }
        
        .contribution-table tbody tr {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .contribution-table tbody tr:nth-child(even) {
            background: rgba(255,255,255,0.03);
        }
        
        .contribution-table tbody tr:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(3px);
        }
        
        .contribution-table td {
            padding: 12px;
            border-right: 1px solid rgba(255,255,255,0.1);
            line-height: 1.6;
        }
        
        /* ‰∏ìÂÆ∂Ë¥°ÁåÆÁªüËÆ°Âç°Áâá */
        .contribution-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        /* Âè≥‰∏äËßíËØ≠Ë®ÄÂíåÂú∞Âå∫ÈÄâÊã©Âô® */
        .language-area-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .language-area-selector label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            white-space: nowrap;
        }

        .language-area-selector select {
            padding: 8px 15px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .language-area-selector select:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .language-area-selector select option {
            background: #2a2a3e;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Âè≥‰∏äËßíËØ≠Ë®ÄÂíåÂú∞Âå∫ÈÄâÊã©Âô® -->
    <div class="language-area-selector">
        <label id="languageAreaLabel">Language and Area</label>
        <select id="regionSelector" onchange="updateRegionAndLanguage()">
            <option value="Â§ßÈôÜ">Â§ßÈôÜ / Mainland</option>
            <option value="Êæ≥Èó®">Êæ≥ÈñÄ / Macau</option>
            <option value="È¶ôÊ∏Ø">È¶ôÊ∏Ø / Hong Kong</option>
            <option value="Âè∞Êπæ">Âè∞ÁÅ£ / Taiwan</option>
            <option value="Êñ∞Âä†Âù°">Êñ∞Âä†Âù° / Singapore</option>
            <option value="È©¨Êù•Ë•ø‰∫ö">Malaysia</option>
            <option value="Ëã±ÂõΩ">United Kingdom</option>
        </select>
    </div>
    <!-- È°∂ÈÉ®Âø´Êç∑ËÆøÈóÆÊ†è -->
    <div class="quick-access-bar" id="quickAccessBar">
        <div class="quick-access-title">
            <i class="fas fa-bolt"></i>
            <span>Âø´Êç∑ËÆøÈóÆ</span>
        </div>
        <div class="quick-access-buttons">
            <button class="quick-btn primary" onclick="openKnowledgePointViewer()">
                <i class="fas fa-book-open"></i> Áü•ËØÜÁÇπÊµèËßàÂô®
            </button>
            <button class="quick-btn" onclick="generateSummaryPage()">
                <i class="fas fa-file-invoice"></i> ÊùêÊñôÊ±áÊÄªÈ°µÈù¢
            </button>
            <button class="quick-btn" onclick="downloadAllDiscussionFiles()" title="‰∏ÄÈîÆ‰∏ãËΩΩÊâÄÊúâËÆ®ËÆ∫Êñá‰ª∂Âà∞Áªü‰∏ÄÊñá‰ª∂Â§π" style="background: rgba(235, 47, 150, 0.4);">
                <i class="fas fa-download"></i> ‰∏ÄÈîÆ‰∏ãËΩΩÂÖ®ÈÉ®
            </button>
            <button class="quick-btn" onclick="downloadCurrentOpinionsRecord()" title="‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ÔºàJSON+TXTÊ†ºÂºèÔºâ" style="background: rgba(19, 194, 194, 0.3);">
                <i class="fas fa-file-download"></i> ‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩï
            </button>
            <button class="quick-btn" onclick="viewSavedOpinions()" title="Êü•ÁúãÊâÄÊúâÂ∑≤‰øùÂ≠òÁöÑ‰∏ìÂÆ∂ËßÇÁÇπ">
                <i class="fas fa-database"></i> Â∑≤‰øùÂ≠òËßÇÁÇπ
            </button>
            <button class="quick-btn" onclick="showFileOrganizationGuide()" title="Êü•ÁúãÊñá‰ª∂Â§πÁªÑÁªáÊåáÂçó" style="background: rgba(250, 140, 22, 0.3);">
                <i class="fas fa-folder-tree"></i> Êñá‰ª∂Â§πÊåáÂçó
            </button>
            <button class="quick-btn" onclick="ScrollManager.scrollTo(document.getElementById('inspectorSection'))">
                <i class="fas fa-arrow-down"></i> Êü•ÁúãËØ¶ÊÉÖ
            </button>
            <button class="quick-btn" onclick="document.getElementById('quickAccessBar').classList.remove('show')" style="background: rgba(255,77,79,0.3);">
                <i class="fas fa-times"></i> ÂÖ≥Èó≠
            </button>
        </div>
    </div>
    
        <div class="container">
        <h1 style="text-align: center; margin-bottom: 15px;"><i class="fas fa-robot"></i> EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü</h1>
        <p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 1.1rem; margin-bottom: 30px;">
            made by <strong>ÈªÑÊµ∑ÂçöÂ£´</strong> ‚Ä¢ <strong>Èíü‰∏ΩÈúûÂçöÂ£´</strong>  ‚Ä¢ <strong>Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü</strong>
        </p>

        <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
        <div class="card">
            <h3 id="fileUploadTitle" data-i18n="‰∏ä‰º†ÊïôÊ°àÊñá‰ª∂"><i class="fas fa-upload"></i> ‰∏ä‰º†ÊïôÊ°àÊñá‰ª∂</h3>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; margin-bottom: 20px; color: rgba(255,255,255,0.7);"></i>
                <div id="uploadAreaText" data-i18n="ÁÇπÂáªÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü">ÁÇπÂáªÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 10px;">
                    <span data-i18n="ÊîØÊåÅ">ÊîØÊåÅ</span> TXT„ÄÅDOC„ÄÅDOCX„ÄÅRTF„ÄÅPPT„ÄÅPPTX„ÄÅPDF„ÄÅPNG„ÄÅJPG„ÄÅJPEG„ÄÅGIF„ÄÅBMP Ê†ºÂºè<br>
                    <span data-i18n="Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá">Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá</span> 20MB
                </div>
            </div>
            <input type="file" id="fileInput" accept=".txt,.doc,.docx,.rtf,.ppt,.pptx,.pdf,.png,.jpg,.jpeg,.gif,.bmp,image/*" />
            <div id="messageBox" class="message"></div>
        </div>

        <!-- ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ -->
        <div class="card" id="teachingConfig">
            <h3 id="teachingConfigTitle" data-i18n="ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ"><i class="fas fa-cog"></i> ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label id="gradeLevelLabel" for="gradeLevel" data-i18n="Â≠¶ÊÆµ">Â≠¶ÊÆµÔºö</label>
                    <select id="gradeLevel" onchange="updateGradeOptions()" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="Â∞èÂ≠¶" style="background: #2a2a3e; color: white;">Â∞èÂ≠¶</option>
                        <option value="Âàù‰∏≠" style="background: #2a2a3e; color: white;">Âàù‰∏≠</option>
                        <option value="È´ò‰∏≠" style="background: #2a2a3e; color: white;">È´ò‰∏≠</option>
                        <option value="Â§ßÂ≠¶" style="background: #2a2a3e; color: white;">Â§ßÂ≠¶</option>
                    </select>
                </div>
                <div>
                    <label id="specificGradeLabel" for="specificGrade" data-i18n="Âπ¥Á∫ß">Âπ¥Á∫ßÔºö</label>
                    <select id="specificGrade" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="‰∏ÄÂπ¥Á∫ß" style="background: #2a2a3e; color: white;">‰∏ÄÂπ¥Á∫ß</option>
                        <option value="‰∫åÂπ¥Á∫ß" style="background: #2a2a3e; color: white;">‰∫åÂπ¥Á∫ß</option>
                        <option value="‰∏âÂπ¥Á∫ß" style="background: #2a2a3e; color: white;">‰∏âÂπ¥Á∫ß</option>
                        <option value="ÂõõÂπ¥Á∫ß" style="background: #2a2a3e; color: white;">ÂõõÂπ¥Á∫ß</option>
                        <option value="‰∫îÂπ¥Á∫ß" style="background: #2a2a3e; color: white;">‰∫îÂπ¥Á∫ß</option>
                        <option value="ÂÖ≠Âπ¥Á∫ß" style="background: #2a2a3e; color: white;">ÂÖ≠Âπ¥Á∫ß</option>
                    </select>
                </div>
                <!-- Âú∞Âå∫ÈÄâÊã©Â∑≤ÁßªËá≥Âè≥‰∏äËßíÔºå‰øùÁïôÈöêËóèÁöÑÈÄâÊã©Âô®‰ª•‰øùÊåÅÂÖºÂÆπÊÄß -->
                <select id="region" style="display: none;" onchange="updateRegionSettings()">
                    <option value="Â§ßÈôÜ">Â§ßÈôÜ</option>
                    <option value="Êæ≥Èó®">Êæ≥Èó®</option>
                    <option value="È¶ôÊ∏Ø">È¶ôÊ∏Ø</option>
                    <option value="Âè∞Êπæ">Âè∞Êπæ</option>
                    <option value="Êñ∞Âä†Âù°">Êñ∞Âä†Âù°</option>
                    <option value="È©¨Êù•Ë•ø‰∫ö">È©¨Êù•Ë•ø‰∫ö</option>
                    <option value="Ëã±ÂõΩ">Ëã±ÂõΩ</option>
                </select>
                <div id="macauCaseIndicator" style="display: none; background: linear-gradient(135deg, #ff6b6b, #ffa500); padding: 10px; border-radius: 6px; color: white; font-size: 12px; text-align: center;">
                    <i class="fas fa-star"></i> <span data-i18n="Â∞Ü‰ºòÂÖà‰ΩøÁî®Êæ≥Èó®‰ºòÁßÄÊïôÂ≠¶Ê°à‰æã‰Ωú‰∏∫ÂèÇËÄÉ">Â∞Ü‰ºòÂÖà‰ΩøÁî®Êæ≥Èó®‰ºòÁßÄÊïôÂ≠¶Ê°à‰æã‰Ωú‰∏∫ÂèÇËÄÉ</span>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label id="courseNameLabel" for="courseName" data-i18n="ËØæÁ®ãÂêçÁß∞">ËØæÁ®ãÂêçÁß∞Ôºö</label>
                <input type="text" id="courseName" data-i18n="‰æãÂ¶ÇÔºöÁßëÂ≠¶„ÄÅÊï∞Â≠¶„ÄÅËØ≠ÊñáÁ≠â" placeholder="‰æãÂ¶ÇÔºöÁßëÂ≠¶„ÄÅÊï∞Â≠¶„ÄÅËØ≠ÊñáÁ≠â" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);" />
            </div>
            <div style="margin-bottom: 15px;">
                <label id="studentCategoryLabel" for="studentCategory" data-i18n="Â≠¶ÁîüÁ±ªÂà´">Â≠¶ÁîüÁ±ªÂà´Ôºö</label>
                <input type="text" id="studentCategory" data-i18n="‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂÆûÈ™åÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â" placeholder="‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂÆûÈ™åÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);" />
            </div>
            <div style="margin-bottom: 15px;">
                <label id="avoidProblemsLabel" for="avoidProblems" data-i18n="ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢ò">ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢òÔºö</label>
                <textarea id="avoidProblems" data-i18n="ËØ∑ÊèèËø∞Âú®ÊïôÂ≠¶ËøáÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÈÅøÂÖçÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ≠¶ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â..." placeholder="ËØ∑ÊèèËø∞Âú®ÊïôÂ≠¶ËøáÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÈÅøÂÖçÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ≠¶ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â..." style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); min-height: 80px; resize: vertical;"></textarea>
            </div>
        </div>

        <!-- ÊïôÊ°àËæìÂÖ•ÂØπËØùÊ°Ü -->
        <div class="card" id="lessonPlanInput">
            <h3 id="lessonPlanInputTitle" data-i18n="ÊïôÊ°àËæìÂÖ•"><i class="fas fa-edit"></i> ÊïôÊ°àËæìÂÖ•</h3>
            <div style="margin-bottom: 15px;">
                <label id="lessonTitleLabel" for="lessonTitle" data-i18n="ÊïôÊ°à‰∏ªÈ¢ò">ÊïôÊ°à‰∏ªÈ¢òÔºö</label>
                <input type="text" id="lessonTitle" data-i18n="ËØ∑ËæìÂÖ•ÊïôÊ°à‰∏ªÈ¢òÔºå‰æãÂ¶ÇÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü" placeholder="ËØ∑ËæìÂÖ•ÊïôÊ°à‰∏ªÈ¢òÔºå‰æãÂ¶ÇÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü" />
            </div>
            <div style="margin-bottom: 15px;">
                <label id="lessonContentLabel" for="lessonContent" data-i18n="ÊïôÊ°àÂÜÖÂÆπË¶ÅÁÇπ">ÊïôÊ°àÂÜÖÂÆπË¶ÅÁÇπÔºö</label>
                <textarea id="lessonContent" data-i18n="ËØ∑ËæìÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπ„ÄÅÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπÁ≠â..." placeholder="ËØ∑ËæìÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπ„ÄÅÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπÁ≠â..."></textarea>
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="submitLessonPlan()" id="generateBtn">
                    <i class="fas fa-paper-plane"></i> <span data-i18n="Êèê‰∫§ÊïôÊ°à">Êèê‰∫§ÊïôÊ°à</span>
                </button>
                <button class="btn" onclick="clearLessonPlan()" style="background: #ff4d4f;">
                    <i class="fas fa-trash"></i> <span data-i18n="Ê∏ÖÁ©∫">Ê∏ÖÁ©∫</span>
                </button>
            </div>
        </div>

        <!-- Êñá‰ª∂È¢ÑËßàÂå∫Âüü -->
        <div class="card hidden" id="filePreview">
            <h3><i class="fas fa-file-text"></i> Êñá‰ª∂È¢ÑËßà</h3>
            <pre id="fileContent" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto;"></pre>
        </div>

        <!-- Ëß£ÊûêÁªìÊûúÂ±ïÁ§∫ -->
        <div class="card hidden" id="parsedContentPreview">
            <h3><i class="fas fa-robot"></i> ÊïôÊ°àËß£ÊûêÁªìÊûú</h3>
            <div style="background: rgba(24, 144, 255, 0.1); border: 1px solid rgba(24, 144, 255, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <strong style="color: #1890ff;">ü§ñ ÊïôÊ°àËß£ÊûêAIÂ∑≤ÂÆåÊàêÊ∑±Â∫¶Ëß£Êûê</strong><br>
                <span style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">Ëß£ÊûêÁªìÊûúÂ∞Ü‰º†ÈÄíÁªôÊïôÁ†îÁªÑËøõË°åÂçè‰ΩúÂàÜÊûê</span>
            </div>
            <!-- ÈÖçÁΩÆ‰ø°ÊÅØÈ™åËØÅÊèêÁ§∫ -->
            <div id="configVerification" style="background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px; display: none;">
                <strong style="color: #52c41a;">‚úÖ ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØÂ∑≤ÊàêÂäüÂä†ÂÖ•</strong><br>
                <span id="configSummary" style="color: rgba(255,255,255,0.8); font-size: 0.85rem;"></span>
            </div>
            <pre id="parsedContent" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 6px;"></pre>
        </div>

        <!-- APIÊµãËØïÂå∫Âüü -->
        <div class="card hidden" id="apiTestSection">
            <h3><i class="fas fa-plug"></i> APIËøûÊé•ÊµãËØï</h3>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="testQwenAPI()" id="testQwenBtn">
                    <i class="fas fa-wifi"></i> ÊµãËØïÈÄö‰πâÂçÉÈóÆ
                </button>
                <button class="btn" onclick="testDoubaoAPI()" id="testDoubaoBtn">
                    <i class="fas fa-wifi"></i> ÊµãËØïË±ÜÂåÖ
                </button>
                <button class="btn" onclick="testKimiAPI()" id="testKimiBtn">
                    <i class="fas fa-wifi"></i> ÊµãËØïKimi
                </button>
                <button class="btn" onclick="testChatGLMAPI()" id="testChatGLMBtn">
                    <i class="fas fa-wifi"></i> ÊµãËØïÊô∫Ë∞±Ê∏ÖË®Ä
                </button>
                <button class="btn" onclick="testDeepSeekAPI()" id="testDeepSeekBtn">
                    <i class="fas fa-wifi"></i> ÊµãËØïDeepSeek
                </button>
            </div>
            <div id="apiTestResult" style="margin-top: 15px;"></div>
        </div>
        
        <!-- ÁîüÊàêÁöÑÊºîÁ§∫ÊùêÊñôÂàóË°® (Âä®ÊÄÅÊòæÁ§∫) -->
        <div class="card hidden" id="generatedMaterialsList">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3><i class="fas fa-layer-group"></i> ÁîüÊàêÁöÑËØæÁ®ãÊºîÁ§∫ÊùêÊñô</h3>
                <button class="btn" onclick="generateSummaryPage()" style="background: linear-gradient(135deg, #fa8c16, #faad14);">
                    <i class="fas fa-file-invoice"></i> ÁîüÊàêÊ±áÊÄªÈ°µÈù¢
                </button>
            </div>
            <div id="materialsListContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                <!-- Âä®ÊÄÅÊ∑ªÂä†ÊºîÁ§∫ÊùêÊñôÂç°Áâá -->
            </div>
        </div>
    </div>

    <script>
        // ========== ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂíåÁºìÂ≠òÊ£ÄÊµã ==========
        
        // ÁâàÊú¨Âè∑ÔºàÁî®‰∫éÊ£ÄÊµãÊµèËßàÂô®ÁºìÂ≠òÔºâ
        const SCRIPT_VERSION = '2024-11-23-v2';
        console.log(`%cüìå ËÑöÊú¨ÁâàÊú¨: ${SCRIPT_VERSION}`, 'color: #52c41a; font-weight: bold; font-size: 1.2rem;');
        
        // ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('error', function(event) {
            console.error('‚ùå ÂÖ®Â±ÄÈîôËØØÊçïËé∑:', event.error);
            console.error('ÈîôËØØ‰ΩçÁΩÆ:', event.filename, 'Ë°å:', event.lineno, 'Âàó:', event.colno);
            
            // Ê£ÄÊµãÊòØÂê¶ÊòØDOMÊìç‰ΩúÈîôËØØ
            if (event.error && event.error.message) {
                const errorMsg = event.error.message;
                if (errorMsg.includes('insertBefore') || errorMsg.includes('appendChild') || 
                    errorMsg.includes('Cannot read properties of null')) {
                    console.error('%c‚ö†Ô∏è Ê£ÄÊµãÂà∞DOMÊìç‰ΩúÈîôËØØÔºÅ', 'color: #ff4d4f; font-weight: bold; font-size: 1.2rem;');
                    console.error('%cüí° Âª∫ËÆÆÔºöËØ∑Êåâ Ctrl+Shift+R (Windows) Êàñ Cmd+Shift+R (Mac) ËøõË°åÁ°¨Âà∑Êñ∞ÔºåÊ∏ÖÈô§ÊµèËßàÂô®ÁºìÂ≠ò', 'color: #fa8c16; font-weight: bold;');
                    
                    // Âú®È°µÈù¢‰∏äÊòæÁ§∫ÊèêÁ§∫
                    setTimeout(() => {
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #ff4d4f, #ff7a45);
                            color: white;
                            padding: 20px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(255, 77, 79, 0.4);
                            z-index: 999999;
                            max-width: 400px;
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                        `;
                        warningDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem;"></i>
                                <strong style="font-size: 1.1rem;">Ê£ÄÊµãÂà∞DOMÈîôËØØ</strong>
                            </div>
                            <div style="line-height: 1.6;">
                                ËØ∑Êåâ‰ª•‰∏ãÂø´Êç∑ÈîÆÊ∏ÖÈô§ÁºìÂ≠òÂπ∂Âà∑Êñ∞Ôºö<br>
                                <strong>Windows/Linux:</strong> Ctrl + Shift + R<br>
                                <strong>Mac:</strong> Cmd + Shift + R
                            </div>
                            <button onclick="this.parentElement.remove()" style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.5);
                                color: white;
                                padding: 8px 16px;
                                border-radius: 6px;
                                cursor: pointer;
                                margin-top: 12px;
                                width: 100%;
                            ">ÊàëÁü•ÈÅì‰∫Ü</button>
                        `;
                        document.body.appendChild(warningDiv);
                    }, 100);
                }
            }
        });
        
        // PromiseÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('unhandledrejection', function(event) {
            console.error('‚ùå Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ:', event.reason);
            if (event.reason && event.reason.message) {
                const errorMsg = event.reason.message;
                if (errorMsg.includes('insertBefore') || errorMsg.includes('appendChild') || 
                    errorMsg.includes('Cannot read properties of null')) {
                    console.error('%cüí° ÊèêÁ§∫ÔºöËøôÂèØËÉΩÊòØÊµèËßàÂô®ÁºìÂ≠òÈóÆÈ¢òÔºåËØ∑Á°¨Âà∑Êñ∞È°µÈù¢ÔºàCtrl+Shift+RÔºâ', 'color: #fa8c16; font-weight: bold;');
                }
            }
        });
        
        console.log('%c‚úÖ ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂ∑≤ÂàùÂßãÂåñ', 'color: #52c41a; font-weight: bold;');
        
        // ========== APIÈÖçÁΩÆ ==========
        
        // APIÈÖçÁΩÆ
        const API_CONFIG = {
            // ÊïôÊ°àËß£ÊûêAIÔºàÈÄö‰πâÂçÉÈóÆÂ§öÊ®°ÊÄÅÔºâ
            parser: {
                apiKey: 'sk-f3ca2c7e114f47d88dabf1cf5f4ac527',
                baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                model: 'qwen-vl-plus' // ‰ΩøÁî®Â§öÊ®°ÊÄÅÊ®°Âûã
            },
            // ÊïôÁ†îÁªÑAI
            qwen: {
                apiKey: 'sk-f3ca2c7e114f47d88dabf1cf5f4ac527',
                baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                model: 'qwen-plus'
            },
            doubao: {
                apiKey: 'ec261b07-7c2c-46b0-a805-219e61b3a8c8',
                baseUrl: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                model: 'doubao-seed-1-6-251015'
            },
            kimi: {
                apiKey: 'sk-nivVNHOoNeo4w7OwCSDRRPZrkXddK76ne11T27YBvh9qQ2Qi',
                baseUrl: 'https://api.moonshot.cn/v1',
                model: 'kimi-k2-0905-preview'
            },
            chatglm: {
                apiKey: '9e627097bc2d4db7b9285c2a00676ff8.3BPsT449Jobmepru',
                baseUrl: 'https://open.bigmodel.cn/api/paas/v4',
                model: 'GLM-4.5-AirX'
            },
            gemini: {
                apiKey: 'AIzaSyAxIy5dM8wL7cB2L0EY8bqQWb9_tWCQbPY',
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
                model: 'gemini-2.5-flash'
            },
            deepseek: {
                apiKey: 'sk-0c0aa24f297f46c28610f9a46bd7d03c',
                baseUrl: 'https://api.deepseek.com',
                model: 'deepseek-reasoner'
            },
            lessonGenerator: {
                apiKey: 'sk-0c0aa24f297f46c28610f9a46bd7d03c',
                baseUrl: 'https://api.deepseek.com',
                model: 'deepseek-reasoner'
            },
            spark: {
                appId: 'e1247cfc',
                apiKey: 'd9878372f7dcd17d1f66dbdfb99800da',
                apiSecret: 'NDYxZjE2NmU2NzM3YmNhOTQwNTcxZGNm',
                url: 'wss://spark-api.xf-yun.com/v3.5/chat',
                domain: 'generalv3.5'
            }
        };

        // ===== üéì 5EÊïôÂ≠¶Ê®°ÂûãÈÖçÁΩÆÔºàÈùôÊÄÅÂèÇÊï∞Ôºâ=====
        const FIVE_E_MODEL = {
            name: '5EÊïôÂ≠¶Ê®°Âûã',
            description: 'Âü∫‰∫éÂª∫ÊûÑ‰∏ª‰πâÂ≠¶‰π†ÁêÜËÆ∫ÁöÑ‰∫îÈò∂ÊÆµÊïôÂ≠¶Ê®°Âºè',
            stages: [
                {
                    key: 'engage',
                    name: 'ÂºïÂÖ•ÔºàEngageÔºâ',
                    nameEn: 'Engage',
                    color: '#eb2f96',
                    icon: 'üéØ',
                    description: 'Âê∏ÂºïÂ≠¶ÁîüÁöÑÊ≥®ÊÑèÂäõÂπ∂ÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇÊïôÂ∏àÂèØÊèêÂá∫ÈóÆÈ¢òÔºàÊÉÖÂ¢ÉÔºâÊàñÂà©Áî®ËÆ§Áü•ÂÜ≤Á™Å„ÄÇ',
                    keyPoints: ['ÊøÄÂèëÂÖ¥Ë∂£', 'ÊèêÂá∫ÈóÆÈ¢ò', 'ËÆ§Áü•ÂÜ≤Á™Å', 'ÂàõËÆæÊÉÖÂ¢É'],
                    teacherRole: 'ÊÉÖÂ¢ÉÂàõËÆæËÄÖ',
                    studentRole: 'ËßÇÂØüËÄÖÂíåÊèêÈóÆËÄÖ',
                    timeAllocation: '5-8ÂàÜÈíü',
                    evaluationFocus: 'Â≠¶ÁîüÁöÑÂèÇ‰∏éÂ∫¶„ÄÅÂ•ΩÂ•áÂøÉË°®Áé∞'
                },
                {
                    key: 'explore',
                    name: 'Êé¢Á©∂ÔºàExploreÔºâ',
                    nameEn: 'Explore',
                    color: '#1890ff',
                    icon: 'üî¨',
                    description: 'Â≠¶ÁîüÂü∫‰∫éÂ∑≤ÊúâÁü•ËØÜËøõË°åÊé¢Á©∂ÔºåÂª∫ÊûÑÊñ∞ÁöÑÊÑè‰πâÔºå‰π†ÂæóÊñ∞ÊäÄËÉΩ„ÄÇÊïôÂ∏à‰∏∫‰øÉËøõËÄÖÂíåÊøÄÊ¥ªËÄÖÔºåÊûÑÂª∫Â≠¶‰π†ÂÖ±Âêå‰Ωì„ÄÇ',
                    keyPoints: ['Âä®ÊâãÂÆûË∑µ', 'Ëá™‰∏ªÊé¢Á¥¢', 'Â∞èÁªÑÂêà‰Ωú', 'ÈóÆÈ¢òÂèëÁé∞'],
                    teacherRole: '‰øÉËøõËÄÖÂíåÊøÄÊ¥ªËÄÖ',
                    studentRole: 'Êé¢Á©∂ËÄÖÂíåÂêà‰ΩúËÄÖ',
                    timeAllocation: '15-20ÂàÜÈíü',
                    evaluationFocus: 'Êé¢Á©∂ËøáÁ®ã„ÄÅÂêà‰ΩúËÉΩÂäõ„ÄÅÈóÆÈ¢òÂèëÁé∞'
                },
                {
                    key: 'explain',
                    name: 'Ëß£ÈáäÔºàExplainÔºâ',
                    nameEn: 'Explain',
                    color: '#52c41a',
                    icon: 'üí°',
                    description: 'Â≠¶ÁîüËß£ÈáäÔºàËæìÂá∫ÔºâÊé¢Á¥¢ÁöÑÊî∂Ëé∑‰ª•‰øÉËøõÊàñÊ£ÄÈ™åÁêÜËß£ÂÖ≥ÈîÆÁöÑÁü•ËØÜÂíåÊ¶ÇÂøµÔºàÁªÑÂÜÖ‰∫§ÊµÅÊàñÂ∞èÁªÑÊ±áÊä•ÔºåÊïôÂ∏àÂºïÂØºÊàñËÆ≤ÊéàÔºâ„ÄÇ',
                    keyPoints: ['Ê¶ÇÂøµÁêÜËß£', 'ËØ≠Ë®ÄË°®Ëææ', 'Áü•ËØÜÂª∫ÊûÑ', 'ÊïôÂ∏àÂºïÂØº'],
                    teacherRole: 'ÂºïÂØºËÄÖÂíåËÆ≤ÊéàËÄÖ',
                    studentRole: 'Ëß£ÈáäËÄÖÂíå‰∫§ÊµÅËÄÖ',
                    timeAllocation: '10-12ÂàÜÈíü',
                    evaluationFocus: 'Ê¶ÇÂøµÁêÜËß£„ÄÅË°®ËææËÉΩÂäõ„ÄÅÁü•ËØÜÁ≥ªÁªüÊÄß'
                },
                {
                    key: 'extend',
                    name: 'ËøÅÁßªÔºàExtendÔºâ',
                    nameEn: 'Extend',
                    color: '#722ed1',
                    icon: 'üöÄ',
                    description: 'Â≠¶ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÂ∫îÁî®Áü•ËØÜÊù•Ëß£ÈáäÂèäËß£ÂÜ≥Êñ∞ÈóÆÈ¢òÔºàÂü∫‰∫éÊúÄËøëÂèëÂ±ïÂå∫Ôºâ„ÄÇ',
                    keyPoints: ['Áü•ËØÜÂ∫îÁî®', 'ÈóÆÈ¢òËß£ÂÜ≥', 'ÊÉÖÂ¢ÉËøÅÁßª', 'ËÉΩÂäõÊèêÂçá'],
                    teacherRole: 'ÂºïÂØºËÄÖÂíåÊåëÊàòËÄÖ',
                    studentRole: 'Â∫îÁî®ËÄÖÂíåÂàõÈÄ†ËÄÖ',
                    timeAllocation: '8-10ÂàÜÈíü',
                    evaluationFocus: 'Áü•ËØÜËøÅÁßªËÉΩÂäõ„ÄÅÈóÆÈ¢òËß£ÂÜ≥ËÉΩÂäõ'
                },
                {
                    key: 'evaluate',
                    name: 'ËØÑ‰ª∑ÔºàEvaluateÔºâ',
                    nameEn: 'Evaluate',
                    color: '#fa8c16',
                    icon: 'üìä',
                    description: 'Â§öÂÖÉËØÑ‰ª∑ÁúüÂÆûÂèçÈ¶àÂ≠¶‰π†„ÄÇÂΩ¢ÊàêÊÄßËØÑ‰º∞Ë¥ØÁ©øÊï¥‰∏™5EËøáÁ®ãÔºåÊÄªÁªìÊÄßËØÑ‰º∞ÂØπÁªìÊûúËøõË°åËØÑ‰ª∑„ÄÇ',
                    keyPoints: ['Â§öÂÖÉËØÑ‰ª∑', 'ÂΩ¢ÊàêÊÄßËØÑ‰º∞', 'ÊÄªÁªìÊÄßËØÑ‰º∞', 'ÂèçÈ¶àÊîπËøõ'],
                    teacherRole: 'ËØÑ‰ª∑ËÄÖÂíåÂèçÈ¶àËÄÖ',
                    studentRole: 'Ëá™ËØÑËÄÖÂíå‰∫íËØÑËÄÖ',
                    timeAllocation: 'Ë¥ØÁ©øÂÖ®Á®ã+5ÂàÜÈíüÊÄªÁªì',
                    evaluationFocus: 'Â≠¶‰π†ÊàêÊïà„ÄÅÁõÆÊ†áËææÊàêÂ∫¶„ÄÅÂÖÉËÆ§Áü•ËÉΩÂäõ'
                }
            ],
            getStageByKey(key) {
                return this.stages.find(s => s.key === key);
            },
            getStageColor(key) {
                const stage = this.getStageByKey(key);
                return stage ? stage.color : '#666';
            },
            getStageIcon(key) {
                const stage = this.getStageByKey(key);
                return stage ? stage.icon : 'üìù';
            },
            getStageName(key) {
                const stage = this.getStageByKey(key);
                return stage ? stage.name : 'Êú™Áü•Èò∂ÊÆµ';
            }
        };

        // ===== Âú∞Âå∫‰ºòÁßÄÊ°à‰æãÂ∫ìÈÖçÁΩÆ =====
        const REGIONAL_EXCELLENT_CASES = {
            macau: {
                title: "Êæ≥Èó®Á§æÂå∫Â∞èÂØºÊ∏∏Âú∞ÂõæÂà∂‰ΩúÊïôÂ≠¶Ê°à‰æã",
                description: "Âü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÁöÑ‰ºòÁßÄÁ§æÂå∫Êé¢Á¥¢ÊïôÂ≠¶Ê°à‰æãÔºåÈÄÇÂêàÊæ≥Èó®Âú∞Âå∫Â≠¶ÁîüÁâπÁÇπ",
                subject: "ÁªºÂêàÂÆûË∑µÊ¥ªÂä®",
                grade: "Â∞èÂ≠¶4-6Âπ¥Á∫ß",
                duration: "45ÂàÜÈíü",
                activities: [
                    {
                        phase: "ÂáÜÂ§áÊ¥ªÂä®ÔºöÂàõËÆæÊÉÖÂ¢ÉÔºåÊòéÁ°Æ‰ªªÂä°",
                        time: "15ÂàÜÈíü",
                        objectives: ["1-1", "2-1"],
                        content: `1. ÊÉÖÂ¢ÉÂØºÂÖ•Ôºö
ÊïôÂ∏àÊí≠ÊîæÂ≠¶Ê†°ÂÆ£‰º†ÁâáÁâáÊÆµÔºåÊèêÂá∫Ôºö"Êñ∞Â≠¶ÊúüÊúâÂæàÂ§öÊñ∞ÂêåÂ≠¶Âä†ÂÖ•Ôºå‰ªñ‰ª¨ÂØπÂ≠¶Ê†°Âë®Âõ¥ÁöÑÁéØÂ¢É‰∏çÁÜüÊÇâ„ÄÇÂ≠¶Ê†°ÊÉ≥ÊãõÂãü'Á§æÂå∫Â∞èÂØºÊ∏∏'ÔºåÂπ∂Âà∂‰Ωú‰∏Ä‰ªΩÊ∏©È¶®ÁöÑÁ§æÂå∫ÊåáÂºïÂú∞Âõæ„ÄÇ‰Ω†‰ª¨ÊÑøÊÑèÊé•ÂèóËøô‰∏™ÊåëÊàòÂêóÔºü"
2. ËåÉ‰æãÂàÜÊûê‰∏éÁü•ËØÜÂáÜÂ§áÔºö
‚Ä¢ Â±ïÁ§∫Âá†Áßç‰∏çÂêåÁöÑÂú∞ÂõæÔºàÊóÖÊ∏∏ÊôØÁÇπÂõæ„ÄÅÂïÜÂú∫ÊåáÂºïÂõæÔºâ„ÄÇÂ∏àÁîüÂÖ±ÂêåËÆ®ËÆ∫Ôºå‰∏Ä‰ªΩÂ•ΩÂú∞ÂõæÁöÑË¶ÅÁ¥†ÔºàÊ†áÈ¢ò„ÄÅÊñπÂêëÊ†á„ÄÅÂõæ‰æã„ÄÅ‰∏ªË¶ÅÂú∞ÁÇπÔºâ„ÄÇ
‚Ä¢ Âø´ÈÄüÂõûÈ°æÊñπ‰ΩçÔºöÁé©"Âø´ÈÄüÊåáÊå•ÂÆò"Ê∏∏ÊàèÔºåÊïôÂ∏àËØ¥Êñπ‰ΩçÔºåÂ≠¶ÁîüÁî®ÊâãÂø´ÈÄüÊåáÂá∫„ÄÇ`,
                        resources: ["PPT", "ÂÆ£‰º†ÁâáÁâáÊÆµ", "ÂêÑÁßçÂú∞ÂõæËåÉ‰æã"],
                        assessment: "Âè£ËØ≠ËØÑÈáèÔºöËßÇÂØüÂ≠¶ÁîüÊòØÂê¶ÁêÜËß£‰ªªÂä°Âπ∂Ë°®Áé∞Âá∫ÂèëË∂£„ÄÇÈÄöËøáÊèêÈóÆÔºåÊ£ÄÈ™åÂ≠¶ÁîüÊòØÂê¶ËÉΩËØ¥Âá∫Âú∞ÂõæË¶ÅÁ¥†Ôºà1-1Ôºâ„ÄÇ"
                    },
                    {
                        phase: "ÂèëÂ±ïÊ¥ªÂä®ÔºöÂêà‰ΩúÊé¢Á©∂ÔºåÂä®ÊâãÂàõ‰Ωú",
                        time: "55ÂàÜÈíü",
                        objectives: ["2-1", "3-3", "3-1", "3-2", "1-2"],
                        content: `3. Â∞èÁªÑÁªÑÂª∫‰∏é‰ªªÂä°Â∏ÉÁΩÆÔºö
‚Ä¢ ËøõË°åÂºÇË¥®ÂàÜÁªÑÔºåÊØèÁªÑ5-6‰∫∫„ÄÇ
‚Ä¢ ÂàÜÂèë"Á§æÂå∫Êé¢Á¥¢‰ªªÂä°ÂåÖ"ÔºåÊòéÁ°ÆÂ∞èÁªÑËßíËâ≤‰∏éËÅåË¥£„ÄÇ
‚Ä¢ ËÆ≤Ëß£‰ªªÂä°ÔºöÂú®Â≠¶Ê†°ÊåáÂÆöËåÉÂõ¥ÂÜÖÔºåÂØªÊâæÂπ∂ËÆ∞ÂΩïËá≥Â∞ë5‰∏™ÈáçË¶ÅÂú∞Ê†áÔºàÂ¶ÇÔºö‰æøÂà©Â∫ó„ÄÅÂÖ¨Âõ≠„ÄÅÂ∑¥Â£´Á´ô„ÄÅÂõæ‰π¶È¶ÜÁ≠âÔºâÔºåÁî®ÊãçÁÖß„ÄÅÁîªËçâÂõæ„ÄÅÊñáÂ≠óËÆ∞ÂΩïÊñπÂºè„ÄÇ

4. ÂÆûÂú∞ËÄÉÂØü‰∏éÊï∞ÊçÆÊî∂ÈõÜÔºö
‚Ä¢ ÂêÑÂ∞èÁªÑÂú®ÊïôÂ∏àÂèäÂä©ÊïôÈô™Âêå‰∏ãÔºåÂâçÂæÄÈ¢ÑÂÆöÂå∫ÂüüËøõË°åÊé¢Á¥¢„ÄÇ
‚Ä¢ ÊïôÂ∏àÊèê‰æõ"ËßÇÂØüÊèêÁ§∫Âç°"ÔºàÂ¶ÇÔºöËøô‰∏™Âª∫Á≠ëÁâ©Âú®Â≠¶Ê†°ÁöÑÂì™‰∏™ÊñπÂêëÔºüÂÆÉÊúâ‰ªÄ‰πàÁâπÁÇπÔºüÁî®‰ªÄ‰πàÂõæÊ†á‰ª£Ë°®ÂÆÉÊúÄÂ•ΩÔºüÔºâÔºåÂºïÂØºÂ≠¶ÁîüÊúâÁõÆÁöÑÂú∞ËßÇÂØüÂíåËÆ∞ÂΩï„ÄÇ

5. ÂàùÊ≠•ÁªòÂõæ‰∏éËÆæËÆ°Ôºö
‚Ä¢ ËøîÂõûÊïôÂÆ§ÔºåÂ∞èÁªÑÊï¥ÂêàÊî∂ÈõÜÁöÑËµÑËÆØ„ÄÇ
‚Ä¢ Âú®ÁΩëÊ†ºÁ∫∏ÊàñÁ©∫ÁôΩÊµ∑Êä•‰∏äÔºåÂêà‰ΩúÁªòË£ΩÁ§æÂå∫Á§∫ÊÑèÂõæ„ÄÇÈºìÂä±‰ΩøÁî®Êèê‰æõÁöÑÂõæ‰æãË¥¥Á∫∏ÊàñËá™ÂàõÂõæÊ†á„ÄÇ
‚Ä¢ ÊïôÂ∏àÂ∑°ËßÜÔºåÊèê‰æõ‰∏™Âà´ÂåñÊåáÂØºÔºàÂ¶ÇÔºöÂ¶Ç‰ΩïÁ°ÆÂÆöÁõ∏ÂØπ‰ΩçÁΩÆÔºåÂõæ‰æãËÆæËÆ°ÊòØÂê¶Ê∏ÖÊô∞Ôºâ„ÄÇ`,
                        resources: ["Â∞èÁªÑËßíËâ≤Âç°", "‰ªªÂä°ÂåÖ", "Âπ≥ÊùøÁîµËÑë", "ËßÇÂØüËÆ∞ÂΩïË°®", "ÊèêÁ§∫Âç°", "Âπ≥Êùø", "ÂÆâÂÖ®ËÉåÂøÉ", "ÁΩëÊ†ºÁ∫∏", "Êµ∑Êä•Á∫∏", "ÂΩ©Á¨î", "Âõæ‰æãË¥¥Á∫∏", "ËÆ∞ÂΩïË°®"],
                        assessment: `ÂÆû‰ΩúËØÑÈáèÔºöÂ∑°ËßÜËßÇÂØüÂ∞èÁªÑÂàÜÂ∑•ÊòØÂê¶È°∫Âà©ÔºåÊàêÂëòÊòØÂê¶ÊòéÁ°ÆËÅåË¥£Ôºà2-1Ôºâ„ÄÇËßÇÂØüÂ≠¶ÁîüÊòØÂê¶ÁßØÊûÅÂèÇ‰∏éËÄÉÂØüÔºåËÉΩÂê¶‰ΩøÁî®Êñπ‰ΩçËØçËøõË°åÂ∞èÁªÑÂÜÖËÆ®ËÆ∫Ôºà3-1Ôºâ„ÄÇ‰ΩúÂìÅËØÑÈáèÔºàËøáÁ®ãÊÄßÔºâÔºöËßÇÂØüÂ∞èÁªÑÁªòÂõæËøáÁ®ãÔºåÊ£ÄÈ™åÂú∞Ê†áÊñπ‰ΩçÊòØÂê¶ÂêàÁêÜÔºà1-2Ôºâ„ÄÅÂêà‰ΩúÊòØÂê¶ÊúâÊïàÔºà2-1Ôºâ„ÄÇ`
                    },
                    {
                        phase: "ÊÄªÁªìÊ¥ªÂä®ÔºöÂàÜ‰∫´ÂõûÈ¶àÔºåÂ±ïÊúõÂª∂‰º∏",
                        time: "10ÂàÜÈíü",
                        objectives: ["3-1", "2-2"],
                        content: `6. ËØæÂ†ÇÂ∞èÁªì‰∏éÊàêÊûúÈ¢ÑËßàÔºö
‚Ä¢ ÈÇÄËØ∑1-2‰∏™ËøõÂ∫¶ËæÉÂø´ÁöÑÂ∞èÁªÑËøõË°å30ÁßíÈó™ÁîµÂàÜ‰∫´Ôºå‰ªãÁªç‰ªñ‰ª¨ÊúÄÊª°ÊÑèÁöÑ‰∏Ä‰∏™Âú∞Ê†áËÆæËÆ°ÂèäÂÖ∂Êñπ‰Ωç„ÄÇ
‚Ä¢ ÊïôÂ∏àÊÄªÁªì‰ªäÊó•ÊàêÊûúÔºåÈ¢ÑÂëä‰∏ãËäÇËØæÂ∞ÜÂÆåÊàêÂú∞ÂõæÂπ∂ËøõË°å"Â∞èÂØºÊ∏∏"Ê®°ÊãüÊé®‰ªã‰ºö„ÄÇ
‚Ä¢ ÊèêÈÜíÂêÑÁªÑÂ¶•ÂñÑ‰øùÁÆ°‰ΩúÂìÅÔºåÊï¥ÁêÜÊùêÊñô„ÄÇ`,
                        resources: ["ÂêÑÂ∞èÁªÑÂàùÊ≠•‰ΩúÂìÅ"],
                        assessment: "Âè£ËØ≠ËØÑÈáèÔºöËØÑ‰º∞Â≠¶ÁîüÂàÜ‰∫´Êó∂Êñπ‰ΩçÊèèËø∞ÁöÑÂáÜÁ°ÆÊÄßÔºà3-1Ôºâ„ÄÇÊÉÖÊÑèËØÑÈáèÔºöËßÇÂØü‰ªñÁªÑÂ≠¶ÁîüÊòØÂê¶‰∏ìÂøÉËÅÜÂê¨Ôºà2-2Ôºâ„ÄÇ"
                    }
                ]
            }
        };

        // ===== 5EÊïôÂ≠¶Ê®°ÂûãÈÖçÁΩÆ =====
        const FiveE_Model = {
            engage: {
                key: 'engage',
                name: 'ÂºïÂÖ•ÔºàEngageÔºâ',
                nameEn: 'Engage',
                description: 'Âê∏ÂºïÂ≠¶ÁîüÁöÑÊ≥®ÊÑèÂäõÂπ∂ÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇÊïôÂ∏àÂèØÊèêÂá∫ÈóÆÈ¢òÔºàÊÉÖÂ¢ÉÔºâÊàñÂà©Áî®ËÆ§Áü•ÂÜ≤Á™Å„ÄÇ',
                color: '#eb2f96',
                icon: 'fa-rocket',
                keyWords: ['ÂØºÂÖ•', 'ÂºïÂÖ•', 'ÊÉÖÂ¢ÉÂàõËÆæ', 'ÊøÄÂèëÂÖ¥Ë∂£', 'ÈóÆÈ¢òÊèêÂá∫', 'ËÆ§Áü•ÂÜ≤Á™Å'],
                prompt: 'Â¶Ç‰ΩïÊúâÊïàÂºïÂÖ•ËØæÈ¢ò„ÄÅÂàõËÆæÊÉÖÂ¢É„ÄÅÊøÄÂèëÂ≠¶ÁîüÊé¢Á©∂ÂÖ¥Ë∂£Ôºü'
            },
            explore: {
                key: 'explore',
                name: 'Êé¢Á©∂ÔºàExploreÔºâ',
                nameEn: 'Explore',
                description: 'Â≠¶ÁîüÂü∫‰∫éÂ∑≤ÊúâÁü•ËØÜËøõË°åÊé¢Á©∂ÔºåÂª∫ÊûÑÊñ∞ÁöÑÊÑè‰πâÔºå‰π†ÂæóÊñ∞ÊäÄËÉΩ„ÄÇÊïôÂ∏à‰∏∫‰øÉËøõËÄÖÂíåÊøÄÊ¥ªËÄÖÔºåÊûÑÂª∫Â≠¶‰π†ÂÖ±Âêå‰Ωì„ÄÇ',
                color: '#1890ff',
                icon: 'fa-search',
                keyWords: ['Êé¢Á©∂', 'ÂÆûÈ™å', 'ËßÇÂØü', 'Â∞èÁªÑÂêà‰Ωú', 'Âä®ÊâãÊìç‰Ωú', 'Ëá™‰∏ªÂ≠¶‰π†'],
                prompt: 'Â¶Ç‰ΩïÁªÑÁªáÂ≠¶ÁîüÊé¢Á©∂Ê¥ªÂä®Ôºå‰øÉËøõÁü•ËØÜÂª∫ÊûÑÂíåÊäÄËÉΩ‰π†ÂæóÔºü'
            },
            explain: {
                key: 'explain',
                name: 'Ëß£ÈáäÔºàExplainÔºâ',
                nameEn: 'Explain',
                description: 'Â≠¶ÁîüËß£ÈáäÔºàËæìÂá∫ÔºâÊé¢Á¥¢ÁöÑÊî∂Ëé∑‰ª•‰øÉËøõÊàñÊ£ÄÈ™åÁêÜËß£ÂÖ≥ÈîÆÁöÑÁü•ËØÜÂíåÊ¶ÇÂøµÔºàÁªÑÂÜÖ‰∫§ÊµÅÊàñÂ∞èÁªÑÊ±áÊä•ÔºåÊïôÂ∏àÂºïÂØºÊàñËÆ≤ÊéàÔºâ„ÄÇ',
                color: '#52c41a',
                icon: 'fa-comments',
                keyWords: ['Ëß£Èáä', '‰∫§ÊµÅ', 'Ê±áÊä•', 'ËÆ≤Êéà', 'Ê¶ÇÂøµÁêÜËß£', 'Áü•ËØÜËæìÂá∫'],
                prompt: 'Â¶Ç‰ΩïÂºïÂØºÂ≠¶ÁîüËß£ÈáäÂíåËæìÂá∫Â≠¶‰π†ÊàêÊûúÔºåÊ∑±ÂåñÊ¶ÇÂøµÁêÜËß£Ôºü'
            },
            extend: {
                key: 'extend',
                name: 'Â∫îÁî®ÔºàExtendÔºâ',
                nameEn: 'Extend',
                description: 'Â≠¶ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÂ∫îÁî®Áü•ËØÜÊù•Ëß£ÈáäÂèäËß£ÂÜ≥Êñ∞ÈóÆÈ¢òÔºàÂü∫‰∫éÊúÄËøëÂèëÂ±ïÂå∫Ôºâ„ÄÇ',
                color: '#fa8c16',
                icon: 'fa-lightbulb',
                keyWords: ['Â∫îÁî®', 'ËøÅÁßª', 'ÊãìÂ±ï', 'Êñ∞ÊÉÖÂ¢É', 'ÈóÆÈ¢òËß£ÂÜ≥', 'Áü•ËØÜËøêÁî®'],
                prompt: 'Â¶Ç‰ΩïËÆæËÆ°Â∫îÁî®Ê¥ªÂä®Ôºå‰øÉËøõÁü•ËØÜËøÅÁßªÂíåËÉΩÂäõÊèêÂçáÔºü'
            },
            evaluate: {
                key: 'evaluate',
                name: 'ËØÑ‰º∞ÔºàEvaluateÔºâ',
                nameEn: 'Evaluate',
                description: 'Â§öÂÖÉËØÑ‰ª∑ÁúüÂÆûÂèçÈ¶àÂ≠¶‰π†„ÄÇÂΩ¢ÊàêÊÄßËØÑ‰º∞Ë¥ØÁ©øÊï¥‰∏™5EËøáÁ®ãÔºåÊÄªÁªìÊÄßËØÑ‰º∞ÂØπÁªìÊûúËøõË°åËØÑ‰ª∑„ÄÇ',
                color: '#722ed1',
                icon: 'fa-chart-line',
                keyWords: ['ËØÑ‰ª∑', 'ËØÑ‰º∞', 'ÂèçÈ¶à', 'Ê£ÄÊµã', 'ÊÄªÁªì', 'ÂèçÊÄù'],
                prompt: 'Â¶Ç‰ΩïËÆæËÆ°Â§öÂÖÉËØÑ‰ª∑‰ΩìÁ≥ªÔºåÂÖ®Èù¢ËØÑ‰º∞Â≠¶‰π†ÊïàÊûúÔºü'
            }
        };
        
        // 5EÊ®°ÂûãÈò∂ÊÆµÈ°∫Â∫è
        const FiveE_Stages = ['engage', 'explore', 'explain', 'extend', 'evaluate'];
        
        // ÂÖ®Â±ÄÂèòÈáè
        let currentFile = null;
        let fileContent = '';
        let parsedFileContent = '';
        let analysisInProgress = false;
        let analysisResults = {};
        let finalTeachingPlan = null;
        let acceptedOpinions = null;
        let finalVotes = null;
        let fiveEMapping = {}; // Â≠òÂÇ®ÊïôÊ°àÁ´†ËäÇÂà∞5EÊ®°ÂûãÁöÑÊò†Â∞Ñ
        let fiveEAnalysisResults = null; // Â≠òÂÇ®5EÊ®°ÂûãÂàÜÊûêÁªìÊûú
        
        // ===== üíæ Êï∞ÊçÆÁõëÊéßÔºö‰ΩøÁî®ProxyÁõëÂê¨Êï∞ÊçÆÂèòÂåñÔºåÈò≤Ê≠¢ÊÑèÂ§ñÊ∏ÖÁ©∫ =====
        let _allAcceptedOpinions = [];
        Object.defineProperty(window, 'allAcceptedOpinions', {
            get: function() {
                return _allAcceptedOpinions;
            },
            set: function(value) {
                const oldLength = _allAcceptedOpinions?.length || 0;
                const newLength = value?.length || 0;
                
                console.log(`\n%cüîÑ window.allAcceptedOpinions Êï∞ÊçÆÂèòÂåñÁõëÊéß`, 'color: #fa8c16; font-weight: bold;');
                console.log(`   ÊóßÊï∞ÊçÆ: ${oldLength} Êù°`);
                console.log(`   Êñ∞Êï∞ÊçÆ: ${newLength} Êù°`);
                console.log(`   ÂèòÂåñ: ${newLength > oldLength ? `+${newLength - oldLength}` : newLength - oldLength}`);
                
                // Â¶ÇÊûúÊòØÊ∏ÖÁ©∫Êìç‰ΩúÔºà‰∏î‰∏çÊòØÂàùÂßãÂåñÔºâÔºåÂèëÂá∫Ë≠¶ÂëäÂπ∂ÈòªÊ≠¢
                if (oldLength > 0 && newLength === 0) {
                    console.error('%c‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ£ÄÊµãÂà∞Ê∏ÖÁ©∫Êìç‰ΩúÔºåËá™Âä®ÈòªÊ≠¢ÔºÅ', 'color: #ff4d4f; font-size: 14px; font-weight: bold;');
                    console.trace('Ë∞ÉÁî®Ê†àËøΩË∏™Ôºö');
                    
                    // Áõ¥Êé•ÈòªÊ≠¢Ê∏ÖÁ©∫Ôºå‰øùÁïôÂéüÊï∞ÊçÆ
                    console.log(`%cüõ°Ô∏è Êï∞ÊçÆ‰øùÊä§Ôºö‰øùÁïôÂéüÊúâÁöÑ ${oldLength} Êù°Êï∞ÊçÆ`, 'color: #52c41a; font-weight: bold;');
                    
                    // Êõ¥Êñ∞ËÆ°Êï∞Âô®
                    if (typeof updateSavedOpinionsCounter === 'function') {
                        updateSavedOpinionsCounter();
                    }
                    return; // ÈòªÊ≠¢Ê∏ÖÁ©∫
                }
                
                _allAcceptedOpinions = value;
                
                // ÊØèÊ¨°ÂèòÂåñÈÉΩÁ´ãÂç≥Â§á‰ªΩÂà∞localStorage
                try {
                    const backupData = {
                        opinions: _allAcceptedOpinions,
                        timestamp: new Date().toISOString(),
                        totalCount: _allAcceptedOpinions.length
                    };
                    localStorage.setItem('allAcceptedOpinions_backup', JSON.stringify(backupData));
                    console.log(`üíæ Â∑≤Ëá™Âä®Â§á‰ªΩÂà∞localStorageÔºö${_allAcceptedOpinions.length} Êù°`);
                } catch (e) {
                    console.error('localStorageÂ§á‰ªΩÂ§±Ë¥•:', e);
                }
                
                // ÊØèÊ¨°ÂèòÂåñÈÉΩÊõ¥Êñ∞ËÆ°Êï∞Âô®
                setTimeout(() => {
                    if (typeof updateSavedOpinionsCounter === 'function') {
                        updateSavedOpinionsCounter();
                    }
                }, 100);
            },
            configurable: true
        });
        
        // ===== üíæ Êñ∞Â¢ûÂäüËÉΩÔºöÊâãÂä®‰∏ãËΩΩÂΩìÂâçËßÇÁÇπËÆ∞ÂΩï =====
        window.downloadCurrentOpinionsRecord = function() {
            const opinions = getAllAcceptedOpinions();
            if (!opinions || opinions.length === 0) {
                showMessage('‚ùå ÊöÇÊó†ËßÇÁÇπËÆ∞ÂΩïÂèØ‰∏ãËΩΩ', 'error');
                return;
            }
            
            const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            
            // ‰∏ãËΩΩJSONÊ†ºÂºè
            if (window.opinionsRecordJSON) {
                const jsonBlob = new Blob([JSON.stringify(window.opinionsRecordJSON, null, 2)], { type: 'application/json' });
                const jsonUrl = URL.createObjectURL(jsonBlob);
                const jsonLink = document.createElement('a');
                jsonLink.href = jsonUrl;
                jsonLink.download = `${folderName}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json`;
                document.body.appendChild(jsonLink);
                jsonLink.click();
                document.body.removeChild(jsonLink);
                URL.revokeObjectURL(jsonUrl);
            }
            
            // Âª∂Ëøü‰∏ãËΩΩTXTÊ†ºÂºè
            setTimeout(() => {
                if (window.opinionsRecordTXT) {
                    const txtBlob = new Blob([window.opinionsRecordTXT], { type: 'text/plain;charset=utf-8' });
                    const txtUrl = URL.createObjectURL(txtBlob);
                    const txtLink = document.createElement('a');
                    txtLink.href = txtUrl;
                    txtLink.download = `${folderName}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt`;
                    document.body.appendChild(txtLink);
                    txtLink.click();
                    document.body.removeChild(txtLink);
                    URL.revokeObjectURL(txtUrl);
                }
            }, 500);
            
            showMessage('‚úÖ ËßÇÁÇπËÆ∞ÂΩïÂ∑≤ÈáçÊñ∞‰∏ãËΩΩÔºàJSON + TXTÊ†ºÂºèÔºâ', 'success');
            console.log('üì• Áî®Êà∑ÊâãÂä®‰∏ãËΩΩ‰∫ÜËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂');
        };
        
        // ===== Êñ∞Â¢ûÔºö‰∏ÄÈîÆ‰∏ãËΩΩÊâÄÊúâËÆ®ËÆ∫Êñá‰ª∂ =====
        window.downloadAllDiscussionFiles = async function() {
            const opinions = getAllAcceptedOpinions();
            const folderName = window.currentFolderName || `${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 10)}`;
            
            const filesToDownload = [];
            
            // 1. ÂàùÊ≠•ÊïôÊ°à
            if (window.initialTeachingPlan && window.initialTeachingPlan.trim().length >= 50) {
                filesToDownload.push({
                    name: 'ÂàùÊ≠•ÊïôÊ°à.txt',
                    content: window.initialTeachingPlan,
                    type: 'text/plain;charset=utf-8'
                });
            }
            
            // 2. ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩïÔºàJSON + TXTÔºâ
            if (window.opinionsRecordJSON) {
                filesToDownload.push({
                    name: 'ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json',
                    content: JSON.stringify(window.opinionsRecordJSON, null, 2),
                    type: 'application/json'
                });
            }
            if (window.opinionsRecordTXT) {
                filesToDownload.push({
                    name: 'ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt',
                    content: window.opinionsRecordTXT,
                    type: 'text/plain;charset=utf-8'
                });
            }
            
            // 3. ‰ºòÂåñÊïôÊ°àÔºàÁ∫ØÂáÄÁâà + Ê†áÊ≥®ÁâàÔºâ
            if (window.finalTeachingPlanClean && window.finalTeachingPlanClean.trim().length >= 50) {
                filesToDownload.push({
                    name: '‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt',
                    content: window.finalTeachingPlanClean,
                    type: 'text/plain;charset=utf-8'
                });
            }
            if (window.finalTeachingPlanAnnotated && window.finalTeachingPlanAnnotated.trim().length >= 50) {
                filesToDownload.push({
                    name: '‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt',
                    content: window.finalTeachingPlanAnnotated,
                    type: 'text/plain;charset=utf-8'
                });
            }
            
            // 4. ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï
            if (opinions && opinions.length > 0) {
                const recordContent = buildDiscussionRecordText();
                filesToDownload.push({
                    name: 'ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt',
                    content: recordContent,
                    type: 'text/plain;charset=utf-8'
                });
            }
            
            // 5. READMEÊñá‰ª∂ÔºàËØ¥ÊòéÊñá‰ª∂Â§πÁªìÊûÑÔºâ
            const readmeContent = generateReadmeContent();
            filesToDownload.push({
                name: 'README.txt',
                content: readmeContent,
                type: 'text/plain;charset=utf-8'
            });
            
            if (filesToDownload.length === 0) {
                showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊñá‰ª∂', 'error');
                return;
            }
            
            // Á°ÆËÆ§‰∏ãËΩΩ
            if (!confirm(`ÂáÜÂ§á‰∏ÄÈîÆ‰∏ãËΩΩ ${filesToDownload.length} ‰∏™Êñá‰ª∂\n\nüìÅ Êé®ËçêÊñá‰ª∂Â§πÔºö${folderName}\n\nÂåÖÂê´Êñá‰ª∂Ôºö\n${filesToDownload.map(f => '‚Ä¢ ' + f.name).join('\n')}\n\nÊèêÁ§∫ÔºöChromeÊµèËßàÂô®ÂèØËÉΩÈúÄË¶ÅÂÖÅËÆ∏"Â§öÊñá‰ª∂‰∏ãËΩΩ"\n\nÁ°ÆÂÆö‰∏ãËΩΩÂêóÔºü`)) {
                return;
            }
            
            showMessage(`üì• Ê≠£Âú®‰∏ãËΩΩ ${filesToDownload.length} ‰∏™Êñá‰ª∂...`, 'info');
            
            // ‰æùÊ¨°‰∏ãËΩΩÔºàÂª∂ËøüÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢Ôºâ
            for (let i = 0; i < filesToDownload.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const file = filesToDownload[i];
                const blob = new Blob([file.content], { type: file.type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${folderName}/${file.name}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log(`‚úÖ Â∑≤‰∏ãËΩΩ (${i+1}/${filesToDownload.length})Ôºö${file.name}`);
            }
            
            setTimeout(() => {
                showMessage(`‚úÖ ÊâÄÊúâÊñá‰ª∂‰∏ãËΩΩÂÆåÊàêÔºÅÂÖ± ${filesToDownload.length} ‰∏™Êñá‰ª∂`, 'success');
                
                // ÊòæÁ§∫ÂÆåÊàêÊèêÁ§∫ÂíåÊñá‰ª∂Â§πÊåáÂçó
                const completeNotice = document.createElement('div');
                completeNotice.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, rgba(82, 196, 26, 0.95), rgba(82, 196, 26, 0.85));
                    color: white;
                    padding: 40px;
                    border-radius: 16px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    z-index: 10002;
                    max-width: 600px;
                    text-align: center;
                    animation: slideUp 0.5s ease;
                `;
                
                completeNotice.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="font-size: 1.8rem; margin-bottom: 15px;">Êñá‰ª∂‰∏ãËΩΩÂÆåÊàêÔºÅ</h2>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-bottom: 25px;">
                        Â∑≤‰∏ãËΩΩ <strong>${filesToDownload.length}</strong> ‰∏™Êñá‰ª∂Âà∞ÊµèËßàÂô®‰∏ãËΩΩÊñá‰ª∂Â§π<br>
                        Êé®ËçêÊñá‰ª∂Â§πÔºö<strong style="color: #ffd700;">${folderName.split('/').pop()}</strong>
                    </p>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: left;">
                        <strong style="display: block; margin-bottom: 12px; font-size: 1.1rem;">
                            <i class="fas fa-folder"></i> Âª∫ËÆÆÊìç‰ΩúÔºö
                        </strong>
                        <ol style="padding-left: 25px; line-height: 2; font-size: 1rem;">
                            <li>Âú®Ê°åÈù¢ÂàõÂª∫"<strong>ËÆ®ËÆ∫ÁªìÊûú</strong>"Êñá‰ª∂Â§π</li>
                            <li>Âú®ÂÖ∂‰∏≠ÂàõÂª∫"<strong>${folderName.split('/').pop()}</strong>"Â≠êÊñá‰ª∂Â§π</li>
                            <li>Â∞ÜÊâÄÊúâ‰∏ãËΩΩÁöÑÊñá‰ª∂ÁßªÂä®Âà∞ËØ•Êñá‰ª∂Â§π‰∏≠</li>
                            <li>ÊâìÂºÄREADME.txtÊü•ÁúãËØ¶ÁªÜËØ¥Êòé</li>
                        </ol>
                    </div>
                    <button onclick="this.closest('[style*=fixed]').remove(); showFileOrganizationGuide();" style="background: white; color: #52c41a; border: none; padding: 15px 40px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-right: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <i class="fas fa-folder-tree"></i> Êü•ÁúãËØ¶ÁªÜÊåáÂçó
                    </button>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 15px 40px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <i class="fas fa-check"></i> ÊàëÁü•ÈÅì‰∫Ü
                    </button>
                `;
                
                document.body.appendChild(completeNotice);
                
                // 5ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
                setTimeout(() => {
                    if (document.body.contains(completeNotice)) {
                        completeNotice.style.transition = 'all 0.5s ease';
                        completeNotice.style.opacity = '0';
                        completeNotice.style.transform = 'translate(-50%, -50%) scale(0.9)';
                        setTimeout(() => {
                            if (document.body.contains(completeNotice)) {
                                completeNotice.remove();
                            }
                        }, 500);
                    }
                }, 8000);
            }, 1000);
        };
        
        // ===== ÊòæÁ§∫Êñá‰ª∂Â§πÁªÑÁªáÊåáÂçóÔºàÈ°µÈù¢ÂºπÁ™óÔºâ=====
        window.showFileOrganizationGuide = function() {
            const folderName = window.currentFolderName || 'ËÆ®ËÆ∫ÁªìÊûú_[ËØæÁ®ãÂêç]_[Êó∂Èó¥Êà≥]';
            const roundCount = window.discussionRoundCounter || 0;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            `;
            
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                border-radius: 16px;
                padding: 40px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: slideUp 0.3s ease;
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 20px;">
                    <h2 style="color: white; margin: 0; font-size: 2rem; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-folder-tree"></i>
                        Êñá‰ª∂Â§πÁªÑÁªáÊåáÂçó
                    </h2>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="background: rgba(255,77,79,0.3); color: #ff4d4f; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-times"></i> ÂÖ≥Èó≠
                    </button>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                    <h3 style="color: #52c41a; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-info-circle"></i> 
                        Êé®ËçêÁöÑÊñá‰ª∂Â§πÁªìÊûÑ
                    </h3>
                    <div style="background: rgba(0,0,0,0.4); border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace; color: #52c41a; font-size: 0.95rem; line-height: 2;">
                        <div>üìÅ ËÆ®ËÆ∫ÁªìÊûú/</div>
                        <div style="padding-left: 20px;">‚îî‚îÄ üìÅ ${folderName}/</div>
                        <div style="padding-left: 40px; color: #1890ff;">‚îú‚îÄ üìÑ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json <span style="color: rgba(255,255,255,0.6);">(ÁªìÊûÑÂåñÊï∞ÊçÆ)</span></div>
                        <div style="padding-left: 40px; color: #1890ff;">‚îú‚îÄ üìÑ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt <span style="color: rgba(255,255,255,0.6);">(‰∫∫Á±ªÂèØËØª)</span></div>
                        ${roundCount > 0 ? Array.from({length: roundCount}, (_, i) => {
                            return `<div style="padding-left: 40px; color: #faad14;">‚îú‚îÄ üìÑ Á¨¨${i+1}ËΩÆ_[‰∏ªÈ¢ò]_ËßÇÁÇπ.txt <span style="color: rgba(255,255,255,0.6);">(ÂçïËΩÆËÆ∞ÂΩï)</span></div>`;
                        }).join('\n') : ''}
                        <div style="padding-left: 40px; color: #eb2f96;">‚îú‚îÄ üìÑ ÂàùÊ≠•ÊïôÊ°à.txt <span style="color: rgba(255,255,255,0.6);">(ËÆ®ËÆ∫Ââç)</span></div>
                        <div style="padding-left: 40px; color: #52c41a;">‚îú‚îÄ üìÑ ‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt <span style="color: rgba(255,255,255,0.6);">(ËûçÂêàÂêé)</span></div>
                        <div style="padding-left: 40px; color: #722ed1;">‚îî‚îÄ üìÑ ‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt <span style="color: rgba(255,255,255,0.6);">(Â∏¶ÂØπÊØî)</span></div>
                    </div>
                </div>
                
                <div style="background: rgba(24,144,255,0.2); border: 2px solid rgba(24,144,255,0.4); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="color: #1890ff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-lightbulb"></i> 
                        ‰ΩøÁî®ËØ¥Êòé
                    </h3>
                    <div style="color: rgba(255,255,255,0.95); font-size: 1rem; line-height: 2;">
                        <p style="margin-bottom: 15px;"><strong>1Ô∏è‚É£ Êñá‰ª∂Ëá™Âä®‰∏ãËΩΩ</strong></p>
                        <ul style="padding-left: 25px; margin-bottom: 20px;">
                            <li>ÊØèËΩÆËÆ®ËÆ∫ÁªìÊùüÂêéÔºåÁ≥ªÁªü‰ºöËá™Âä®‰∏ãËΩΩËØ•ËΩÆÁöÑËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂</li>
                            <li>Êñá‰ª∂ÂêçÂåÖÂê´ÔºöËΩÆÊ¨°ÁºñÂè∑„ÄÅËÆ®ËÆ∫‰∏ªÈ¢ò„ÄÅÊó∂Èó¥Êà≥</li>
                            <li>ÊµèËßàÂô®‰ºöÂºπÂá∫‰∏ãËΩΩÊèêÁ§∫ÔºàChromeÂèØËÉΩÈúÄË¶ÅÂÖÅËÆ∏Â§öÊñá‰ª∂‰∏ãËΩΩÔºâ</li>
                        </ul>
                        
                        <p style="margin-bottom: 15px;"><strong>2Ô∏è‚É£ ÊâãÂä®ÁªÑÁªáÊñá‰ª∂ÔºàÊé®ËçêÔºâ</strong></p>
                        <ul style="padding-left: 25px; margin-bottom: 20px;">
                            <li>Âú®Ê°åÈù¢ÊàñÂêàÈÄÇ‰ΩçÁΩÆÂàõÂª∫"<strong style="color: #52c41a;">ËÆ®ËÆ∫ÁªìÊûú</strong>"Êñá‰ª∂Â§π</li>
                            <li>Âú®ÂÖ∂‰∏≠ÂàõÂª∫ËØæÁ®ã‰∏ìÁî®Êñá‰ª∂Â§πÔºàÂ¶Ç"<strong style="color: #1890ff;">${folderName}</strong>"Ôºâ</li>
                            <li>Â∞ÜÊâÄÊúâ‰∏ãËΩΩÁöÑÊñá‰ª∂ÁßªÂä®Âà∞ËØ•Êñá‰ª∂Â§π‰∏≠</li>
                            <li>‰øùÊåÅÊñá‰ª∂Âêç‰∏çÂèòÔºåÊñπ‰æøÂêéÁª≠Êü•Êâæ</li>
                        </ul>
                        
                        <p style="margin-bottom: 15px;"><strong>3Ô∏è‚É£ AIËûçÂêà‰ΩøÁî®</strong></p>
                        <ul style="padding-left: 25px;">
                            <li>ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ÔºåÁ≥ªÁªü‰ºöËØªÂèñÂÜÖÂ≠ò‰∏≠ÁöÑËßÇÁÇπÊï∞ÊçÆ</li>
                            <li>‰∏ãËΩΩÁöÑÊñá‰ª∂ÂèØÁî®‰∫éÔºöÂ§á‰ªΩ„ÄÅÂÆ°Êü•„ÄÅÂàÜ‰∫´„ÄÅ‰∫åÊ¨°ÂàÜÊûê</li>
                            <li>JSONÊ†ºÂºè‰æø‰∫éÁ®ãÂ∫èÂ§ÑÁêÜÔºåTXTÊ†ºÂºè‰æø‰∫é‰∫∫Â∑•Êü•Áúã</li>
                        </ul>
                    </div>
                </div>
                
                <div style="background: rgba(250,173,20,0.2); border: 2px solid rgba(250,173,20,0.4); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #faad14; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        ÊµèËßàÂô®ÈôêÂà∂ËØ¥Êòé
                    </h3>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                        <p style="margin-bottom: 12px;">
                            Áî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÁ∫ØHTMLÈ°µÈù¢<strong>Êó†Ê≥ïÁõ¥Êé•ÂàõÂª∫Êñá‰ª∂Â§πÁªìÊûÑ</strong>„ÄÇ
                        </p>
                        <p style="margin-bottom: 12px;">
                            <strong>ÂΩìÂâçÊñπÊ°àÔºö</strong>Á≥ªÁªü‰ºöËá™Âä®‰∏ãËΩΩÊñá‰ª∂ÔºàÊñá‰ª∂ÂêçÂåÖÂê´Êé®ËçêË∑ØÂæÑÔºâÔºåÊÇ®ÈúÄË¶ÅÊâãÂä®Â∞ÜÂÆÉ‰ª¨ÁªÑÁªáÂà∞ÂØπÂ∫îÊñá‰ª∂Â§π‰∏≠„ÄÇ
                        </p>
                        <p style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; border-left: 4px solid #1890ff; margin-bottom: 15px;">
                            <strong style="color: #1890ff;">üí° È´òÁ∫ßÊñπÊ°àÔºàÂèØÈÄâÔºâÔºö</strong><br>
                            Â¶ÇÊûúÊÇ®‰ΩøÁî®Chrome/EdgeÊµèËßàÂô®ÔºåÂèØ‰ª•‰ΩøÁî®<strong>File System Access API</strong>ËÆ©Á≥ªÁªüÁõ¥Êé•‰øùÂ≠òÂà∞ÊåáÂÆöÊñá‰ª∂Â§π„ÄÇ
                            <br>ÈúÄË¶ÅÊÇ®ÊâãÂä®ÊéàÊùÉÊñá‰ª∂Â§πËÆøÈóÆÊùÉÈôê„ÄÇ
                        </p>
                        <details style="margin-top: 15px; cursor: pointer;">
                            <summary style="color: #13c2c2; font-weight: 600; padding: 10px; background: rgba(19,194,194,0.2); border-radius: 8px; list-style: none;">
                                <i class="fas fa-cog"></i> ChromeÊµèËßàÂô®Â§öÊñá‰ª∂‰∏ãËΩΩËÆæÁΩÆ
                            </summary>
                            <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.4); border-radius: 8px; font-size: 0.9rem; line-height: 2;">
                                <p style="margin-bottom: 10px;"><strong>Â¶ÇÊûúChromeÈòªÊ≠¢‰∫ÜÂ§öÊñá‰ª∂‰∏ãËΩΩÔºö</strong></p>
                                <ol style="padding-left: 25px;">
                                    <li>Âú®ChromeÂú∞ÂùÄÊ†èËæìÂÖ•Ôºö<code style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; color: #52c41a;">chrome://settings/content/automaticDownloads</code></li>
                                    <li>ÊàñËÄÖÔºöËÆæÁΩÆ ‚Üí ÈöêÁßÅÂíåÂÆâÂÖ® ‚Üí ÁΩëÁ´ôËÆæÁΩÆ ‚Üí Ëá™Âä®‰∏ãËΩΩ</li>
                                    <li>Â∞ÜÊú¨ÁΩëÁ´ôÊ∑ªÂä†Âà∞"ÂÖÅËÆ∏"ÂàóË°®</li>
                                    <li>Âà∑Êñ∞È°µÈù¢ÂêéÈáçÊñ∞‰∏ãËΩΩ</li>
                                </ol>
                                <p style="margin-top: 12px; padding: 10px; background: rgba(82,196,26,0.2); border-radius: 6px; border-left: 3px solid #52c41a;">
                                    <i class="fas fa-check-circle" style="color: #52c41a;"></i>
                                    <strong>ÊèêÁ§∫Ôºö</strong>ËÆæÁΩÆÂêéÔºåÁ≥ªÁªüÂèØ‰ª•ËøûÁª≠‰∏ãËΩΩÂ§ö‰∏™Êñá‰ª∂ËÄå‰∏çË¢´ÈòªÊ≠¢
                                </p>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 25px; background: rgba(114,46,209,0.2); border: 2px solid rgba(114,46,209,0.3); border-radius: 12px;">
                    <button onclick="downloadAllDiscussionFiles()" style="background: linear-gradient(135deg, #eb2f96, #f759ab); color: white; border: none; padding: 15px 40px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(235, 47, 150, 0.4); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(235, 47, 150, 0.6)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(235, 47, 150, 0.4)'">
                        <i class="fas fa-download"></i> ‰∏ÄÈîÆ‰∏ãËΩΩÊâÄÊúâËÆ®ËÆ∫Êñá‰ª∂
                    </button>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 15px;">
                        ÁÇπÂáªÂêéÂ∞ÜËá™Âä®‰∏ãËΩΩÂàùÊ≠•ÊïôÊ°à„ÄÅËßÇÁÇπËÆ∞ÂΩï„ÄÅ‰ºòÂåñÊïôÊ°à„ÄÅËÆ®ËÆ∫ËÆ∞ÂΩïÁ≠âÊâÄÊúâÊñá‰ª∂
                    </div>
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        };
        
        // ===== Ë∞ÉËØïÂ∑•ÂÖ∑ÔºöÊü•ÁúãÂ∑≤‰øùÂ≠òÁöÑËßÇÁÇπÔºàÊéßÂà∂Âè∞ + ÊµÆÂ±ÇÈù¢ÊùøÔºâ=====
        window.viewSavedOpinions = function() {
            // ‰ºòÂÖàËØªÂèñÂÜÖÈÉ®Êï∞ÁªÑ
            const opinions = (typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions : null) || 
                            window.allAcceptedOpinions || [];
            const allDiscussed = window.allDiscussedOpinions || [];
            
            console.log(`%cüîç viewSavedOpinions Ë¢´Ë∞ÉÁî®`, 'color: #1890ff; font-weight: bold;');
            console.log(`   _allAcceptedOpinionsÔºàÂ∑≤ÈááÁ∫≥Ôºâ: ${typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions.length : 'Êú™ÂÆö‰πâ'} Êù°`);
            console.log(`   window.allAcceptedOpinionsÔºàÂ∑≤ÈááÁ∫≥Ôºâ: ${window.allAcceptedOpinions?.length || 0} Êù°`);
            console.log(`   window.allDiscussedOpinionsÔºàÊâÄÊúâËÆ®ËÆ∫Ôºâ: ${allDiscussed.length} Êù°`);
            console.log(`   ÊúÄÁªà‰ΩøÁî®: ${opinions.length} Êù°ÔºàÂ∑≤ÈááÁ∫≥Ôºâ`);
            
            if ((!opinions || opinions.length === 0) && (!allDiscussed || allDiscussed.length === 0)) {
                console.log('‚ùå ÊöÇÊó†Â∑≤‰øùÂ≠òÁöÑËßÇÁÇπÔºàÂ∞öÊú™ÂºÄÂßãËÆ®ËÆ∫Ôºâ');
                showMessage('ÊöÇÊó†Â∑≤‰øùÂ≠òÁöÑËßÇÁÇπ„ÄÇÊèêÁ§∫ÔºöÈúÄË¶ÅÂÆåÊàêËÆ®ËÆ∫ÂêéÊâç‰ºöÊúâËÆ∞ÂΩï', 'info');
                return;
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπ‰ΩÜÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÔºåÊèêÁ§∫Áî®Êà∑
            if (opinions.length === 0 && allDiscussed.length > 0) {
                console.log(`%c‚ö†Ô∏è Ê≤°ÊúâÈááÁ∫≥ÁöÑËßÇÁÇπÔºå‰ΩÜÊúâ ${allDiscussed.length} ‰∏™ËÆ®ËÆ∫ËÆ∞ÂΩï`, 'color: #faad14; font-weight: bold;');
                
                // ÊòæÁ§∫ËÆ®ËÆ∫ËÆ∞ÂΩïËÄå‰∏çÊòØÈááÁ∫≥ËßÇÁÇπ
                const overlay = document.createElement('div');
                overlay.id = 'savedOpinionsOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    animation: fadeIn 0.3s ease;
                `;
                
                const panel = document.createElement('div');
                panel.style.cssText = `
                    background: linear-gradient(135deg, #fa8c16, #faad14);
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 900px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    animation: slideUp 0.3s ease;
                `;
                
                panel.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.3);">
                        <h2 style="color: white; margin: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-comments"></i>
                            ÊâÄÊúâËÆ®ËÆ∫ËßÇÁÇπÔºàÊó†ÈááÁ∫≥Ôºâ
                        </h2>
                        <button onclick="document.getElementById('savedOpinionsOverlay').remove()" style="background: rgba(255,77,79,0.3); color: #ff4d4f; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-times"></i> ÂÖ≥Èó≠
                        </button>
                    </div>
                    
                    <div style="background: rgba(255,77,79,0.15); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; color: white; font-weight: bold; margin-bottom: 10px;">${allDiscussed.length}</div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">‰∏™ËßÇÁÇπÂèÇ‰∏éËÆ®ËÆ∫</div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: left;">
                            <strong style="color: white;">‚ö†Ô∏è ËØ¥ÊòéÔºö</strong><br>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.8; margin-top: 8px;">
                                ‚Ä¢ ÊâÄÊúâ${allDiscussed.length}‰∏™ËßÇÁÇπÁöÑÊäïÁ•®ÂêåÊÑèÁéáÂùáÊú™ËææÂà∞40%ÈòàÂÄº<br>
                                ‚Ä¢ ËøôËØ¥Êòé‰∏ìÂÆ∂ÊÑèËßÅÂàÜÊ≠ßËæÉÂ§ßÔºåÊàñÂàùÂßãÊïôÊ°àÂ∑≤ËæÉÂÆåÂñÑ<br>
                                ‚Ä¢ ‰ºòÂåñÊïôÊ°àÂ∞ÜÂü∫‰∫éÂàùÂßãÊïôÊ°àÂÜÖÂÆπÁîüÊàêÔºà‰∏çËûçÂêàËßÇÁÇπÔºâ<br>
                                ‚Ä¢ ÊÇ®ÂèØ‰ª•‰∏ãËΩΩËÆ®ËÆ∫ËÆ∞ÂΩïÔºåÂèÇËÄÉ‰∏ìÂÆ∂ËßÇÁÇπÊâãÂä®Ë∞ÉÊï¥
                            </div>
                        </div>
                    </div>
                    
                    ${allDiscussed.map((op, i) => {
                        const totalVotes = op.votes.agree + op.votes.disagree;
                        const passRate = totalVotes > 0 ? ((op.votes.agree / totalVotes) * 100).toFixed(1) : 0;
                        const isNearThreshold = passRate >= 35 && passRate < 40;
                        
                        return `
                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 3px solid ${isNearThreshold ? '#faad14' : '#ff4d4f'};">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="background: ${op.expert.color}; color: white; padding: 5px 12px; border-radius: 50%; font-size: 0.9rem; font-weight: bold;">${op.expert.avatar}</span>
                                    <div>
                                        <strong style="color: white; font-size: 1rem;">${op.expert.name}</strong>
                                        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">${op.expert.specialty}</div>
                                    </div>
                                    <span style="background: ${isNearThreshold ? 'rgba(250,173,20,0.3)' : 'rgba(255,77,79,0.3)'}; color: ${isNearThreshold ? '#faad14' : '#ff4d4f'}; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; margin-left: auto;">
                                        ${passRate}% ${isNearThreshold ? '(Êé•ËøëÈòàÂÄº)' : '(Êú™ÈÄöËøá)'}
                                    </span>
                                </div>
                                <div style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.7; margin-bottom: 10px;">
                                    ${op.content}
                                </div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                                    üìä ‚úÖ ${op.votes.agree} | ‚ùå ${op.votes.disagree} | ÂêåÊÑèÁéá ${passRate}% (ÈòàÂÄº40%)
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div style="text-align: center; margin-top: 25px; padding: 20px; background: rgba(24,144,255,0.2); border-radius: 12px;">
                        <button onclick="downloadDiscussionRecord()" style="background: linear-gradient(135deg, #1890ff, #40a9ff); color: white; border: none; padding: 15px 40px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩï
                        </button>
                    </div>
                `;
                
                overlay.appendChild(panel);
                document.body.appendChild(overlay);
                
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });
                
                return;
            }
            
            // ===== ÊéßÂà∂Âè∞ËæìÂá∫ =====
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üìã Â∑≤‰øùÂ≠òÁöÑÊâÄÊúâ‰∏ìÂÆ∂ËßÇÁÇπÊ±áÊÄª');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log(`üíæ ÊÄªÊï∞Ôºö${opinions.length} ‰∏™ËßÇÁÇπ`);
            console.log('');
            
            // ÊåâÁ´†ËäÇÂ±ïÁ§∫
            const bySection = {};
            opinions.forEach(op => {
                const sec = op.section || 'ÂÖ∂‰ªñ';
                if (!bySection[sec]) bySection[sec] = [];
                bySection[sec].push(op);
            });
            
            Object.entries(bySection).forEach(([section, sectionOpinions]) => {
                console.log(`\nüìÅ „Äê${section}„Äë- ${sectionOpinions.length} ‰∏™ËßÇÁÇπÔºö`);
                sectionOpinions.forEach((op, i) => {
                    console.log(`\n   ${i+1}. ${op.expert.name}Ôºà${op.expert.specialty}Ôºâ#${op.globalIndex || '?'}`);
                    console.log(`      ÂÜÖÂÆπÔºö${op.content}`);
                    if (op.votes) {
                        console.log(`      ÊäïÁ•®Ôºö‚úÖ${op.votes.agree} ‚ùå${op.votes.disagree} ÈÄöËøáÁéá${((op.votes.agree/(op.votes.agree+op.votes.disagree))*100).toFixed(1)}%`);
                    }
                    console.log(`      ‰øùÂ≠òÊó∂Èó¥Ôºö${op.timestamp || 'Êú™ËÆ∞ÂΩï'}`);
                });
            });
            
            console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üí° ÊèêÁ§∫ÔºöËøô‰∫õËßÇÁÇπÂ∞ÜÂú®ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ËûçÂêàËøõÂéª');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
            
            // ===== È°µÈù¢ÊµÆÂ±ÇÊòæÁ§∫ =====
            const existingOverlay = document.getElementById('savedOpinionsOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            const overlay = document.createElement('div');
            overlay.id = 'savedOpinionsOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            `;
            
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                border-radius: 16px;
                padding: 30px;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: slideUp 0.3s ease;
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.3); flex-wrap: wrap; gap: 10px;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-database"></i>
                        Â∑≤‰øùÂ≠òÁöÑ‰∏ìÂÆ∂ËßÇÁÇπ
                    </h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="downloadCurrentOpinionsRecord()" style="background: rgba(19, 194, 194, 0.3); color: #13c2c2; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(19, 194, 194, 0.5)'" onmouseout="this.style.background='rgba(19, 194, 194, 0.3)'">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩËÆ∞ÂΩïÊñá‰ª∂
                        </button>
                        <button onclick="document.getElementById('savedOpinionsOverlay').remove()" style="background: rgba(255,77,79,0.3); color: #ff4d4f; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-times"></i> ÂÖ≥Èó≠
                        </button>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; color: #52c41a; font-weight: bold;">${opinions.length}</div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">ÊÄªËßÇÁÇπÊï∞</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; color: #1890ff; font-weight: bold;">${Object.keys(bySection).length}</div>
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">ËÆ®ËÆ∫‰∏ªÈ¢ò</div>
                        </div>
                    </div>
                </div>
                
                ${Object.entries(bySection).map(([section, sectionOpinions]) => `
                    <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin: 15px 0; border-left: 4px solid #52c41a;">
                        <h3 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">
                            <i class="fas fa-folder-open"></i> „Äê${section}„Äë- ${sectionOpinions.length} ‰∏™ËßÇÁÇπ
                        </h3>
                        ${sectionOpinions.map((op, i) => `
                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 3px solid ${op.expert.color};">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="background: ${op.expert.color}; color: white; padding: 5px 12px; border-radius: 50%; font-size: 0.9rem; font-weight: bold;">${op.expert.avatar}</span>
                                    <div>
                                        <strong style="color: white; font-size: 1rem;">${op.expert.name}</strong>
                                        <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">${op.expert.specialty}</div>
                                    </div>
                                    <span style="background: rgba(82,196,26,0.3); color: #52c41a; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; margin-left: auto;">
                                        #${op.globalIndex || i+1}
                                    </span>
                                </div>
                                <div style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.7; margin-bottom: 10px;">
                                    ${op.content}
                                </div>
                                ${op.votes ? `
                                    <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                                        üìä ‚úÖ ${op.votes.agree} | ‚ùå ${op.votes.disagree} | ÈÄöËøáÁéá ${((op.votes.agree/(op.votes.agree+op.votes.disagree))*100).toFixed(1)}%
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 25px; padding: 20px; background: rgba(114,46,209,0.2); border-radius: 12px;">
                    <i class="fas fa-info-circle" style="color: #722ed1; font-size: 1.3rem; margin-bottom: 10px; display: block;"></i>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                        Ëøô‰∫õËßÇÁÇπÂ∞ÜÂú®ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ËûçÂêàÂà∞ÂØπÂ∫îÁ´†ËäÇ<br>
                        Ê†áÊ≥®ÁâàÊïôÊ°à‰ºöÊ∏ÖÊ•öÊ†áÊòéÊØèÂ§Ñ‰ºòÂåñÁöÑÊù•Ê∫ê
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: rgba(19, 194, 194, 0.2); border: 2px solid rgba(19, 194, 194, 0.3); border-radius: 12px;">
                    <h3 style="color: #13c2c2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-database"></i>
                        ËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ËØ¥Êòé
                    </h3>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.8; text-align: left;">
                        üíæ <strong>Ëá™Âä®‰øùÂ≠òÔºö</strong>Á≥ªÁªüÂ∑≤Â∞ÜÊâÄÊúâËßÇÁÇπ‰øùÂ≠ò‰∏∫Êú¨Âú∞Êñá‰ª∂<br>
                        üìÅ <strong>Ê†ºÂºèÔºö</strong>JSONÔºàÁªìÊûÑÂåñÊï∞ÊçÆÔºâ+ TXTÔºàÂèØËØªÊñáÊú¨Ôºâ<br>
                        üìä <strong>ÂÜÖÂÆπÔºö</strong>ËßÇÁÇπ„ÄÅ‰∏ìÂÆ∂‰ø°ÊÅØ„ÄÅÊäïÁ•®ËØ¶ÊÉÖ„ÄÅÈÄöËøáÁéáÁªüËÆ°<br>
                        ü§ñ <strong>AI‰ΩøÁî®Ôºö</strong>ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂Ëá™Âä®‰º†ÈÄíÁªôAIÂèÇËÄÉ<br>
                        üîÑ <strong>ÂèØËøΩÊ∫ØÔºö</strong>ÊØèÂ§Ñ‰ºòÂåñÈÉΩËÉΩËøΩÊ∫ØÂà∞ÂéüÂßãËßÇÁÇπÂíåÊäïÁ•®
                    </div>
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            // Ê∑ªÂä†CSSÂä®Áîª
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { 
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to { 
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            if (!document.getElementById('savedOpinionsStyles')) {
                style.id = 'savedOpinionsStyles';
                document.head.appendChild(style);
            }
        };
        
        // ===== ÂÆûÊó∂ÊòæÁ§∫Â∑≤‰øùÂ≠òËßÇÁÇπÊï∞ÈáèÔºàÈ°µÈù¢ËÆ°Êï∞Âô®Ôºâ=====
        function updateSavedOpinionsCounter() {
            // Áõ¥Êé•ËØªÂèñÂÜÖÈÉ®Êï∞ÁªÑÔºåÈÅøÂÖçÈÄöËøágetter
            const count = (typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions.length : 0) || 
                          (window.allAcceptedOpinions?.length || 0);
            
            console.log(`%cüìä Êõ¥Êñ∞ËÆ°Êï∞Âô®Ôºö${count} ‰∏™ËßÇÁÇπ`, 'color: #1890ff; font-weight: bold;');
            
            // 1. Êõ¥Êñ∞Âè≥‰∏äËßíÊµÆÂä®ËÆ°Êï∞Âô®
            let counter = document.getElementById('savedOpinionsCounter');
            if (!counter) {
                counter = document.createElement('div');
                counter.id = 'savedOpinionsCounter';
                counter.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, rgba(82, 196, 26, 0.9), rgba(82, 196, 26, 0.7));
                    color: white;
                    padding: 12px 20px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 9998;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(10px);
                `;
                counter.onclick = () => viewSavedOpinions();
                counter.onmouseover = function() {
                    this.style.transform = 'scale(1.05)';
                };
                counter.onmouseout = function() {
                    this.style.transform = 'scale(1)';
                };
                document.body.appendChild(counter);
            }
            
            counter.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-database"></i>
                    <div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Â∑≤‰øùÂ≠òËßÇÁÇπ</div>
                        <div style="font-size: 1.5rem; font-weight: bold;">${count}</div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
            counter.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
                counter.style.animation = '';
            }, 500);
            
            // 2. Êõ¥Êñ∞Á¨¨‰∫åÈò∂ÊÆµÂÜÖÁöÑËÆ°Êï∞ÊòæÁ§∫
            const inlineCounter = document.getElementById('savedOpinionsCount');
            if (inlineCounter) {
                inlineCounter.textContent = count;
                inlineCounter.style.animation = 'pulse 0.3s ease';
                setTimeout(() => {
                    inlineCounter.style.animation = '';
                }, 300);
            }
            
            console.log(`üìä ÂÆûÊó∂ËÆ°Êï∞Âô®Êõ¥Êñ∞ÂÆåÊàêÔºö${count} ‰∏™ËßÇÁÇπÂ∑≤‰øùÂ≠ò`);
        }
        
        // ===== ËæÖÂä©ÂáΩÊï∞ÔºöÁªü‰∏ÄËé∑ÂèñËßÇÁÇπÊï∞ÁªÑ =====
        function getAllAcceptedOpinions() {
            // ‰ºòÂÖàËøîÂõûÂÜÖÈÉ®Êï∞ÁªÑ
            if (typeof _allAcceptedOpinions !== 'undefined') {
                return _allAcceptedOpinions;
            }
            // ÈôçÁ∫ßÂà∞windowËÆøÈóÆ
            return window.allAcceptedOpinions || [];
        }

        // ===== ËæÖÂä©ÂáΩÊï∞ÔºöÁπÅ‰ΩìÂ≠óËΩ¨Êç¢ÔºàÊæ≥Èó®ÂíåÈ¶ôÊ∏ØÂú∞Âå∫‰∏ìÁî®Ôºâ=====
        function convertToTraditionalChinese(content) {
            if (!content) return content;
            const region = document.getElementById('region').value;
            // Ëã±ÊñáÂú∞Âå∫‰∏çËΩ¨Êç¢
            if (region === 'Ëã±ÂõΩ' || region === 'È©¨Êù•Ë•ø‰∫ö') {
                return content;
            }
            // Êæ≥Èó®ÂíåÈ¶ôÊ∏ØÂú∞Âå∫ËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó
            if (region === 'Êæ≥Èó®' || region === 'È¶ôÊ∏Ø') {
                try {
                    const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
                    const converted = converter(content);
                    console.log('Â∑≤Â∞ÜÂÜÖÂÆπËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó');
                    return converted;
                } catch (error) {
                    console.warn('ÁπÅ‰ΩìÂ≠óËΩ¨Êç¢Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÊñá:', error);
                    return content;
                }
            }
            return content;
        }
        
        // ===== Êñ∞Â¢ûÔºöÊµãËØïËßÇÁÇπ‰øùÂ≠òÊú∫Âà∂ =====
        window.testOpinionSave = function() {
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #722ed1; font-weight: bold;');
            console.log('%cüß™ ÊµãËØïËßÇÁÇπ‰øùÂ≠òÊú∫Âà∂', 'color: #722ed1; font-size: 16px; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #722ed1; font-weight: bold;');
            
            const testOpinion = {
                expert: {
                    key: 'test',
                    name: 'ÊµãËØï‰∏ìÂÆ∂',
                    specialty: 'ÊµãËØïÈ¢ÜÂüü',
                    color: '#722ed1',
                    avatar: 'Êµã'
                },
                content: 'ËøôÊòØ‰∏Ä‰∏™ÊµãËØïËßÇÁÇπÔºåÁî®‰∫éÈ™åËØÅÊï∞ÊçÆ‰øùÂ≠òÊú∫Âà∂ÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú',
                votes: {
                    agree: 3,
                    disagree: 1,
                    voters: []
                },
                section: 'ÊµãËØïÁ´†ËäÇ',
                topicTitle: 'ÊµãËØï‰∏ªÈ¢ò',
                timestamp: new Date().toISOString(),
                globalIndex: (_allAcceptedOpinions?.length || 0) + 1
            };
            
            console.log('üìù Ê∑ªÂä†ÊµãËØïËßÇÁÇπ...');
            _allAcceptedOpinions.push(testOpinion);
            
            console.log(`‚úÖ ÊµãËØïËßÇÁÇπÂ∑≤Ê∑ªÂä†ÔºåÂΩìÂâçÂÖ± ${_allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
            
            // Â§á‰ªΩÂà∞localStorage
            try {
                const backupData = {
                    opinions: _allAcceptedOpinions,
                    timestamp: new Date().toISOString(),
                    totalCount: _allAcceptedOpinions.length
                };
                localStorage.setItem('allAcceptedOpinions_backup', JSON.stringify(backupData));
                console.log('üíæ Â∑≤Â§á‰ªΩÂà∞localStorage');
            } catch (e) {
                console.error('‚ùå localStorageÂ§á‰ªΩÂ§±Ë¥•:', e);
            }
            
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            updateSavedOpinionsCounter();
            
            console.log('\nüîç È™åËØÅÊï∞ÊçÆ:');
            console.log(`   ‚Ä¢ _allAcceptedOpinions.length: ${_allAcceptedOpinions.length}`);
            console.log(`   ‚Ä¢ getAllAcceptedOpinions().length: ${getAllAcceptedOpinions().length}`);
            console.log(`   ‚Ä¢ ËÆ°Êï∞Âô®ÊòæÁ§∫: ${document.getElementById('savedOpinionsCounter')?.textContent || 'Êú™ÊòæÁ§∫'}`);
            
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #722ed1; font-weight: bold;');
            console.log('%c‚úÖ ÊµãËØïÂÆåÊàêÔºÅÂ¶ÇÊûúÁúãÂà∞ËÆ°Êï∞Âô®Êõ¥Êñ∞ÔºåËØ¥ÊòéÊú∫Âà∂Ê≠£Â∏∏', 'color: #52c41a; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #722ed1; font-weight: bold;');
            
            showMessage(`‚úÖ ÊµãËØïËßÇÁÇπÂ∑≤‰øùÂ≠òÔºÅÂΩìÂâçÂÖ± ${getAllAcceptedOpinions().length} ‰∏™ËßÇÁÇπ`, 'success');
        };
        
        // ===== Êñ∞Â¢ûÔºöÊü•ÁúãÊâÄÊúâËÆ®ËÆ∫ËßÇÁÇπÔºàÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑÔºâ=====
        window.viewAllDiscussedOpinions = function() {
            const allDiscussed = window.allDiscussedOpinions || [];
            const accepted = getAllAcceptedOpinions();
            
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            console.log('%cüìä ÊâÄÊúâËÆ®ËÆ∫ËßÇÁÇπÊ±áÊÄªÔºàÂåÖÂê´Êú™ÈááÁ∫≥Ôºâ', 'color: #fa8c16; font-size: 16px; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            console.log(`üí¨ ÊÄªËÆ®ËÆ∫Êï∞Ôºö${allDiscussed.length} ‰∏™ËßÇÁÇπ`);
            console.log(`‚úÖ Â∑≤ÈááÁ∫≥Ôºö${accepted.length} ‰∏™ÔºàÂêåÊÑèÁéá‚â•40%Ôºâ`);
            console.log(`‚ùå Êú™ÈááÁ∫≥Ôºö${allDiscussed.length - accepted.length} ‰∏™ÔºàÂêåÊÑèÁéá<40%Ôºâ`);
            console.log('');
            
            if (allDiscussed.length === 0) {
                console.log('‚ö†Ô∏è Â∞öÊú™ÂºÄÂßãËÆ®ËÆ∫ÊàñËÆ®ËÆ∫ËÆ∞ÂΩï‰∏¢Â§±');
                showMessage('ÊöÇÊó†ËÆ®ËÆ∫ËÆ∞ÂΩï„ÄÇËØ∑ÂÖàÂÆåÊàêÁ¨¨‰∫åÈò∂ÊÆµÁöÑ‰∏ìÂÆ∂ËÆ®ËÆ∫„ÄÇ', 'info');
                return;
            }
            
            // ÊåâÁ´†ËäÇÂíåÈááÁ∫≥Áä∂ÊÄÅÂ±ïÁ§∫
            const bySection = {};
            allDiscussed.forEach(op => {
                const sec = op.section || 'ÂÖ∂‰ªñ';
                if (!bySection[sec]) bySection[sec] = { accepted: [], rejected: [] };
                if (op.isAccepted) {
                    bySection[sec].accepted.push(op);
                } else {
                    bySection[sec].rejected.push(op);
                }
            });
            
            Object.entries(bySection).forEach(([section, groups]) => {
                console.log(`\nüìÅ „Äê${section}„Äë:`);
                
                if (groups.accepted.length > 0) {
                    console.log(`  ‚úÖ Â∑≤ÈááÁ∫≥ (${groups.accepted.length}‰∏™):`);
                    groups.accepted.forEach((op, i) => {
                        const rate = ((op.votes.agree/(op.votes.agree+op.votes.disagree))*100).toFixed(1);
                        console.log(`     ${i+1}. ${op.expert.name}Ôºà${rate}%Ôºâ: ${op.content.substring(0, 50)}...`);
                    });
                }
                
                if (groups.rejected.length > 0) {
                    console.log(`  ‚ùå Êú™ÈááÁ∫≥ (${groups.rejected.length}‰∏™):`);
                    groups.rejected.forEach((op, i) => {
                        const rate = ((op.votes.agree/(op.votes.agree+op.votes.disagree))*100).toFixed(1);
                        console.log(`     ${i+1}. ${op.expert.name}Ôºà${rate}%Ôºâ: ${op.content.substring(0, 50)}...`);
                    });
                }
            });
            
            console.log('\n%cüí° ÊèêÁ§∫ÔºöËøêË°å downloadDiscussionRecord() ÂèØ‰∏ãËΩΩÂÆåÊï¥ËÆ∞ÂΩï', 'color: #1890ff; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
            
            // Ë∞ÉÁî®ÂéüÂáΩÊï∞ÊòæÁ§∫ÊµÆÂ±Ç
            viewSavedOpinions();
        };
        
        // È°µÈù¢Âä†ËΩΩÊó∂Âú®ÊéßÂà∂Âè∞ËæìÂá∫ÊèêÁ§∫
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea');
        console.log('%cüí° EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü - Ë∞ÉËØïÂ∑•ÂÖ∑', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea');
        console.log('%cüìã Êü•ÁúãÈááÁ∫≥ËßÇÁÇπÔºöviewSavedOpinions()', 'color: #52c41a; font-size: 14px; font-weight: bold;');
        console.log('%cüìä Êü•ÁúãÊâÄÊúâËÆ®ËÆ∫ÔºöviewAllDiscussedOpinions()', 'color: #fa8c16; font-size: 14px; font-weight: bold;');
        console.log('%cüíæ ‰∏ãËΩΩËÆ∞ÂΩïÔºödownloadCurrentOpinionsRecord()', 'color: #13c2c2; font-size: 14px; font-weight: bold;');
        console.log('%cüì¶ ‰∏ÄÈîÆ‰∏ãËΩΩÔºödownloadAllDiscussionFiles()', 'color: #eb2f96; font-size: 14px; font-weight: bold;');
        console.log('%cüìÅ Êñá‰ª∂Â§πÊåáÂçóÔºöshowFileOrganizationGuide()', 'color: #fa8c16; font-size: 14px; font-weight: bold;');
        console.log('%cüîç Ê£ÄÊü•Êï∞ÊçÆÔºöcheckOpinionsData()', 'color: #1890ff; font-size: 14px; font-weight: bold;');
        console.log('%cüß™ ÊµãËØï‰øùÂ≠òÔºötestOpinionSave()', 'color: #722ed1; font-size: 14px; font-weight: bold;');
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea');
        console.log('%cüìÇ Êñá‰ª∂ÁÆ°ÁêÜÔºö', 'color: #fa8c16; font-size: 12px; font-weight: bold;');
        console.log('%c   ‚Ä¢ ‰øùÂ≠òË∑ØÂæÑÔºöE:\\edu material\\disscussion_result\\[ËØæÁ®ãÂêç]_[Êó•Êúü]\\', 'color: #fa8c16; font-size: 12px;');
        console.log('%c   ‚Ä¢ ÊØèËΩÆËÆ®ËÆ∫ÁªìÊùüÔºåËá™Âä®‰∏ãËΩΩËØ•ËΩÆËßÇÁÇπÊñá‰ª∂', 'color: #fa8c16; font-size: 12px;');
        console.log('%c   ‚Ä¢ ÊâÄÊúâÊñá‰ª∂Ëá™Âä®ÁªÑÁªáÂà∞Áõ∏ÂêåÊñá‰ª∂Â§πÁªìÊûÑ', 'color: #fa8c16; font-size: 12px;');
        console.log('%cü§ñ AI‰ΩøÁî®ÔºöÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ÔºåËÆ∞ÂΩïÊñá‰ª∂‰ºöËá™Âä®‰º†ÈÄíÁªôAI‰Ωú‰∏∫ÂèÇËÄÉ', 'color: #722ed1; font-size: 12px;');
        console.log('%cüéØ ÈááÁ∫≥ÈòàÂÄºÔºö40%ÔºàÊäïÁ•®ÂêåÊÑèÁéá‚â•40%ÁöÑËßÇÁÇπ‰ºöË¢´ÈááÁ∫≥Ôºâ', 'color: #faad14; font-size: 12px;');
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea');
        
        // ===== Êñ∞Â¢ûÔºöÊï∞ÊçÆÂÆåÊï¥ÊÄßÊ£ÄÊü•Â∑•ÂÖ∑ =====
        window.checkOpinionsData = function() {
            console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üîç ËßÇÁÇπÊï∞ÊçÆÂÆåÊï¥ÊÄßÊ£ÄÊü•');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            // Ê£ÄÊü•ÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ
            console.log('\nüìä ÂÜÖÂ≠òÊï∞ÊçÆÁä∂ÊÄÅ:');
            console.log(`   ‚Ä¢ _allAcceptedOpinions (ÂÜÖÈÉ®): ${typeof _allAcceptedOpinions !== 'undefined' ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}`);
            console.log(`   ‚Ä¢ ÂÜÖÈÉ®Êï∞ÁªÑÊï∞Èáè: ${typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions.length : 0}`);
            console.log(`   ‚Ä¢ window.allAcceptedOpinions: ${window.allAcceptedOpinions ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}`);
            console.log(`   ‚Ä¢ Â§ñÈÉ®ËÆøÈóÆÊï∞Èáè: ${window.allAcceptedOpinions?.length || 0}`);
            console.log(`   ‚Ä¢ window.opinionsRecordJSON: ${window.opinionsRecordJSON ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}`);
            console.log(`   ‚Ä¢ window.opinionsRecordTXT: ${window.opinionsRecordTXT ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}`);
            
            // Ê£ÄÊü•localStorage
            console.log('\nüíæ localStorageÂ§á‰ªΩ:');
            const backupData = localStorage.getItem('allAcceptedOpinions_backup');
            if (backupData) {
                try {
                    const parsed = JSON.parse(backupData);
                    console.log(`   ‚úÖ Â§á‰ªΩÂ≠òÂú®`);
                    console.log(`   ‚Ä¢ Â§á‰ªΩÊó∂Èó¥: ${parsed.timestamp}`);
                    console.log(`   ‚Ä¢ Â§á‰ªΩÊï∞Èáè: ${parsed.totalCount} ‰∏™ËßÇÁÇπ`);
                } catch (e) {
                    console.log(`   ‚ö†Ô∏è Â§á‰ªΩÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•: ${e.message}`);
                }
            } else {
                console.log(`   ‚ùå Êó†Â§á‰ªΩÊï∞ÊçÆ`);
            }
            
            // ‰ΩøÁî®ÂÜÖÈÉ®Êï∞ÁªÑÊòæÁ§∫ËßÇÁÇπËØ¶ÊÉÖ
            const opinions = typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions : 
                            (window.allAcceptedOpinions || []);
            
            if (opinions && opinions.length > 0) {
                console.log('\nüìã Â∑≤‰øùÂ≠òÁöÑËßÇÁÇπÂàóË°®:');
                opinions.forEach((op, i) => {
                    console.log(`\n   ${i+1}. [${op.section}] ${op.expert.name}`);
                    console.log(`      ËßÇÁÇπ: ${op.content.substring(0, 60)}...`);
                    if (op.votes) {
                        console.log(`      ÊäïÁ•®: ‚úÖ${op.votes.agree} ‚ùå${op.votes.disagree} (${((op.votes.agree/(op.votes.agree+op.votes.disagree))*100).toFixed(1)}%)`);
                    }
                });
            } else {
                console.log('\n‚ö†Ô∏è ÂΩìÂâçÊ≤°ÊúâÂ∑≤‰øùÂ≠òÁöÑËßÇÁÇπ');
            }
            
            console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
        };
        
        // APIÈÖçÈ¢ùÁÆ°ÁêÜ
        const apiQuotaStatus = {
            qwen: { available: true, errorCount: 0 },
            doubao: { available: true, errorCount: 0 },
            kimi: { available: true, errorCount: 0 },
            chatglm: { available: true, errorCount: 0 },
            deepseek: { available: true, errorCount: 0 }
        };
        
        // Ê†áËÆ∞APIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω
        function markAPIQuotaExhausted(apiKey) {
            if (apiQuotaStatus[apiKey]) {
                apiQuotaStatus[apiKey].available = false;
                console.warn(`‚ö†Ô∏è ${apiKey} APIÂ∑≤Ê†áËÆ∞‰∏∫ÈÖçÈ¢ùÁî®Â∞ΩÔºåÂ∞ÜË∑≥ËøáÂêéÁª≠Ë∞ÉÁî®`);
            }
        }
        
        // Ê£ÄÊü•APIÊòØÂê¶ÂèØÁî®
        function isAPIAvailable(apiKey) {
            return apiQuotaStatus[apiKey]?.available !== false;
        }

        // ========== ÂÆâÂÖ®DOMÊìç‰ΩúËæÖÂä©ÂáΩÊï∞ ==========
        
        /**
         * ÂÆâÂÖ®Âú∞Â∞ÜÂÖÉÁ¥†ÊèíÂÖ•Âà∞Áà∂ÂÆπÂô®‰∏≠
         * @param {HTMLElement} parent - Áà∂ÂÆπÂô®
         * @param {HTMLElement} child - Ë¶ÅÊèíÂÖ•ÁöÑÂ≠êÂÖÉÁ¥†
         * @param {HTMLElement|null} referenceNode - ÂèÇËÄÉËäÇÁÇπÔºàinsertBefore‰ΩøÁî®Ôºâ
         * @returns {boolean} - ÊòØÂê¶ÊàêÂäüÊèíÂÖ•
         */
        function safeInsertElement(parent, child, referenceNode = null) {
            try {
                // È™åËØÅÁà∂ÂÖÉÁ¥†
                if (!parent || !(parent instanceof HTMLElement)) {
                    console.error('‚ùå safeInsertElement: Áà∂ÂÖÉÁ¥†Êó†Êïà', { parent });
                    return false;
                }
                
                if (!document.body.contains(parent)) {
                    console.error('‚ùå safeInsertElement: Áà∂ÂÖÉÁ¥†‰∏çÂú®ÊñáÊ°£‰∏≠', { parent });
                    return false;
                }
                
                // È™åËØÅÂ≠êÂÖÉÁ¥†
                if (!child || !(child instanceof HTMLElement)) {
                    console.error('‚ùå safeInsertElement: Â≠êÂÖÉÁ¥†Êó†Êïà', { child });
                    return false;
                }
                
                // ÊâßË°åÊèíÂÖ•
                if (referenceNode) {
                    // ‰ΩøÁî®insertBefore
                    if (referenceNode instanceof HTMLElement && parent.contains(referenceNode)) {
                        parent.insertBefore(child, referenceNode);
                        console.log('‚úÖ safeInsertElement: ÂÖÉÁ¥†Â∑≤ÈÄöËøáinsertBeforeÊèíÂÖ•');
                        return true;
                    } else {
                        // referenceNodeÊó†ÊïàÔºåÈôçÁ∫ß‰∏∫appendChild
                        console.warn('‚ö†Ô∏è safeInsertElement: ÂèÇËÄÉËäÇÁÇπÊó†ÊïàÔºå‰ΩøÁî®appendChild');
                        parent.appendChild(child);
                        return true;
                    }
                } else {
                    // ‰ΩøÁî®appendChild
                    parent.appendChild(child);
                    console.log('‚úÖ safeInsertElement: ÂÖÉÁ¥†Â∑≤ÈÄöËøáappendChildÊèíÂÖ•');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå safeInsertElementÂ§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', {
                    message: error.message,
                    stack: error.stack,
                    parentExists: !!parent,
                    childExists: !!child,
                    referenceNodeExists: !!referenceNode
                });
                return false;
            }
        }
        
        /**
         * ÂÆâÂÖ®Âú∞Ëé∑ÂèñÂÖÉÁ¥†ÔºàÂ∏¶ÈáçËØïÊú∫Âà∂Ôºâ
         * @param {string} elementId - ÂÖÉÁ¥†ID
         * @param {number} maxRetries - ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞
         * @param {number} retryDelay - ÈáçËØïÂª∂ËøüÔºàÊØ´ÁßíÔºâ
         * @returns {Promise<HTMLElement|null>} - ÂÖÉÁ¥†Êàñnull
         */
        async function safeGetElement(elementId, maxRetries = 3, retryDelay = 300) {
            for (let i = 0; i < maxRetries; i++) {
                const element = document.getElementById(elementId);
                if (element && element instanceof HTMLElement && document.body.contains(element)) {
                    return element;
                }
                
                if (i < maxRetries - 1) {
                    console.warn(`‚ö†Ô∏è safeGetElement: ÂÖÉÁ¥† ${elementId} Êú™ÊâæÂà∞ÔºåÈáçËØï ${i + 1}/${maxRetries}`);
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                }
            }
            
            console.error(`‚ùå safeGetElement: ÂÖÉÁ¥† ${elementId} Âú® ${maxRetries} Ê¨°Â∞ùËØïÂêé‰ªçÊú™ÊâæÂà∞`);
            return null;
        }
        
        console.log('%c‚úÖ ÂÆâÂÖ®DOMÊìç‰ΩúÂáΩÊï∞Â∑≤Âä†ËΩΩ', 'color: #52c41a; font-weight: bold;');
        
        // ========== ÊòæÁ§∫Ê∂àÊÅØ ==========
        
        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(message, type = 'info', duration = 5000) {
            const messageBox = document.getElementById('messageBox');
            // Ê£ÄÊü•messageÊòØÂê¶ÂåÖÂê´HTMLÊ†áÁ≠æ
            if (message.includes('<') && message.includes('>')) {
                messageBox.innerHTML = message;
            } else {
                messageBox.textContent = message;
            }
            messageBox.className = `message ${type}`;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // Êõ¥Êñ∞Â≠¶ÊÆµÈÄâÈ°π
        function updateGradeLevelOptions() {
            const gradeLevel = document.getElementById('gradeLevel');
            if (!gradeLevel) return;
            
            const langPack = getCurrentLanguagePack();
            const currentValue = gradeLevel.value; // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÄº
            
            // Â≠¶ÊÆµÈÄâÈ°πÁöÑÂéüÂßãÂÄºÔºàÁî®‰∫évalueÂ±ûÊÄßÔºâ
            const gradeLevelValues = ['Â∞èÂ≠¶', 'Âàù‰∏≠', 'È´ò‰∏≠', 'Â§ßÂ≠¶'];
            
            // Êõ¥Êñ∞ÈÄâÈ°πÊñáÊú¨
            gradeLevelValues.forEach((value, index) => {
                const option = gradeLevel.options[index];
                if (option) {
                    option.value = value; // value‰øùÊåÅ‰∏çÂèò
                    option.textContent = langPack[value] || value; // ÊñáÊú¨Ê†πÊçÆËØ≠Ë®ÄÂåÖÊõ¥Êñ∞
                }
            });
            
            // ÊÅ¢Â§ç‰πãÂâçÈÄâ‰∏≠ÁöÑÂÄº
            gradeLevel.value = currentValue;
        }

        // Êõ¥Êñ∞Âπ¥Á∫ßÈÄâÈ°π
        function updateGradeOptions() {
            const gradeLevel = document.getElementById('gradeLevel').value;
            const specificGrade = document.getElementById('specificGrade');
            if (!specificGrade) return;
            
            const langPack = getCurrentLanguagePack();
            const currentValue = specificGrade.value; // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÄº
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            specificGrade.innerHTML = '';
            
            // Ê†πÊçÆÂ≠¶ÊÆµÊ∑ªÂä†ÂØπÂ∫îÁöÑÂπ¥Á∫ßÈÄâÈ°π
            let grades = [];
            if (gradeLevel === 'Â∞èÂ≠¶') {
                grades = ['‰∏ÄÂπ¥Á∫ß', '‰∫åÂπ¥Á∫ß', '‰∏âÂπ¥Á∫ß', 'ÂõõÂπ¥Á∫ß', '‰∫îÂπ¥Á∫ß', 'ÂÖ≠Âπ¥Á∫ß'];
            } else if (gradeLevel === 'Âàù‰∏≠') {
                grades = ['Âàù‰∏ÄÔºà‰∏ÉÂπ¥Á∫ßÔºâ', 'Âàù‰∫åÔºàÂÖ´Âπ¥Á∫ßÔºâ', 'Âàù‰∏âÔºà‰πùÂπ¥Á∫ßÔºâ'];
            } else if (gradeLevel === 'È´ò‰∏≠') {
                grades = ['È´ò‰∏ÄÔºàÂçÅÂπ¥Á∫ßÔºâ', 'È´ò‰∫åÔºàÂçÅ‰∏ÄÂπ¥Á∫ßÔºâ', 'È´ò‰∏âÔºàÂçÅ‰∫åÂπ¥Á∫ßÔºâ'];
            } else if (gradeLevel === 'Â§ßÂ≠¶') {
                grades = ['Â§ß‰∏Ä', 'Â§ß‰∫å', 'Â§ß‰∏â', 'Â§ßÂõõ'];
            }
            
            // Ê∑ªÂä†ÈÄâÈ°π
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade; // value‰øùÊåÅ‰∏çÂèò
                option.textContent = langPack[grade] || grade; // ÊñáÊú¨Ê†πÊçÆËØ≠Ë®ÄÂåÖÊõ¥Êñ∞
                option.style.background = '#2a2a3e';
                option.style.color = 'white';
                specificGrade.appendChild(option);
            });
            
            // ÊÅ¢Â§ç‰πãÂâçÈÄâ‰∏≠ÁöÑÂÄºÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if (currentValue && Array.from(specificGrade.options).some(opt => opt.value === currentValue)) {
                specificGrade.value = currentValue;
            }
        }

        // ========== ËØ≠Ë®ÄÂåÖÁ≥ªÁªü ==========
        const LANGUAGE_PACKS = {
            'ÁÆÄ‰Ωì‰∏≠Êñá': {
                'Language and Area': 'ËØ≠Ë®ÄÂíåÂú∞Âå∫',
                '‰∏ä‰º†ÊïôÊ°àÊñá‰ª∂': '‰∏ä‰º†ÊïôÊ°àÊñá‰ª∂',
                'ÁÇπÂáªÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü': 'ÁÇπÂáªÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü',
                'ÊîØÊåÅ': 'ÊîØÊåÅ',
                'Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá': 'Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá',
                'ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ': 'ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ',
                'Â≠¶ÊÆµ': 'Â≠¶ÊÆµ',
                'Âπ¥Á∫ß': 'Âπ¥Á∫ß',
                'Âú∞Âå∫': 'Âú∞Âå∫',
                'ËØæÁ®ãÂêçÁß∞': 'ËØæÁ®ãÂêçÁß∞',
                'Â≠¶ÁîüÁ±ªÂà´': 'Â≠¶ÁîüÁ±ªÂà´',
                'ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢ò': 'ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢ò',
                'ÊïôÊ°àËæìÂÖ•': 'ÊïôÊ°àËæìÂÖ•',
                'ÊïôÊ°à‰∏ªÈ¢ò': 'ÊïôÊ°à‰∏ªÈ¢ò',
                'ÊïôÊ°àÂÜÖÂÆπË¶ÅÁÇπ': 'ÊïôÊ°àÂÜÖÂÆπË¶ÅÁÇπ',
                'Êèê‰∫§ÊïôÊ°à': 'Êèê‰∫§ÊïôÊ°à',
                'Ê∏ÖÁ©∫': 'Ê∏ÖÁ©∫',
                'Êñá‰ª∂È¢ÑËßà': 'Êñá‰ª∂È¢ÑËßà',
                'ÊïôÊ°àËß£ÊûêÁªìÊûú': 'ÊïôÊ°àËß£ÊûêÁªìÊûú',
                'Âø´Êç∑ËÆøÈóÆ': 'Âø´Êç∑ËÆøÈóÆ',
                'Áü•ËØÜÁÇπÊµèËßàÂô®': 'Áü•ËØÜÁÇπÊµèËßàÂô®',
                'ÊùêÊñôÊ±áÊÄªÈ°µÈù¢': 'ÊùêÊñôÊ±áÊÄªÈ°µÈù¢',
                '‰∏ÄÈîÆ‰∏ãËΩΩÂÖ®ÈÉ®': '‰∏ÄÈîÆ‰∏ãËΩΩÂÖ®ÈÉ®',
                '‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩï': '‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩï',
                'Â∑≤‰øùÂ≠òËßÇÁÇπ': 'Â∑≤‰øùÂ≠òËßÇÁÇπ',
                'Êñá‰ª∂Â§πÊåáÂçó': 'Êñá‰ª∂Â§πÊåáÂçó',
                'Êü•ÁúãËØ¶ÊÉÖ': 'Êü•ÁúãËØ¶ÊÉÖ',
                'ÂÖ≥Èó≠': 'ÂÖ≥Èó≠',
                '‰æãÂ¶ÇÔºöÁßëÂ≠¶„ÄÅÊï∞Â≠¶„ÄÅËØ≠ÊñáÁ≠â': '‰æãÂ¶ÇÔºöÁßëÂ≠¶„ÄÅÊï∞Â≠¶„ÄÅËØ≠ÊñáÁ≠â',
                '‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂÆûÈ™åÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â': '‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂÆûÈ™åÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â',
                'ËØ∑ÊèèËø∞Âú®ÊïôÂ≠¶ËøáÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÈÅøÂÖçÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ≠¶ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â...': 'ËØ∑ÊèèËø∞Âú®ÊïôÂ≠¶ËøáÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÈÅøÂÖçÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ≠¶ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â...',
                'ËØ∑ËæìÂÖ•ÊïôÊ°à‰∏ªÈ¢òÔºå‰æãÂ¶ÇÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü': 'ËØ∑ËæìÂÖ•ÊïôÊ°à‰∏ªÈ¢òÔºå‰æãÂ¶ÇÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü',
                'ËØ∑ËæìÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπ„ÄÅÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπÁ≠â...': 'ËØ∑ËæìÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπ„ÄÅÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπÁ≠â...',
                'Â∞Ü‰ºòÂÖà‰ΩøÁî®Êæ≥Èó®‰ºòÁßÄÊïôÂ≠¶Ê°à‰æã‰Ωú‰∏∫ÂèÇËÄÉ': 'Â∞Ü‰ºòÂÖà‰ΩøÁî®Êæ≥Èó®‰ºòÁßÄÊïôÂ≠¶Ê°à‰æã‰Ωú‰∏∫ÂèÇËÄÉ',
                // Â≠¶ÊÆµÈÄâÈ°π
                'Â∞èÂ≠¶': 'Â∞èÂ≠¶',
                'Âàù‰∏≠': 'Âàù‰∏≠',
                'È´ò‰∏≠': 'È´ò‰∏≠',
                'Â§ßÂ≠¶': 'Â§ßÂ≠¶',
                // Âπ¥Á∫ßÈÄâÈ°π
                '‰∏ÄÂπ¥Á∫ß': '‰∏ÄÂπ¥Á∫ß',
                '‰∫åÂπ¥Á∫ß': '‰∫åÂπ¥Á∫ß',
                '‰∏âÂπ¥Á∫ß': '‰∏âÂπ¥Á∫ß',
                'ÂõõÂπ¥Á∫ß': 'ÂõõÂπ¥Á∫ß',
                '‰∫îÂπ¥Á∫ß': '‰∫îÂπ¥Á∫ß',
                'ÂÖ≠Âπ¥Á∫ß': 'ÂÖ≠Âπ¥Á∫ß',
                'Âàù‰∏ÄÔºà‰∏ÉÂπ¥Á∫ßÔºâ': 'Âàù‰∏ÄÔºà‰∏ÉÂπ¥Á∫ßÔºâ',
                'Âàù‰∫åÔºàÂÖ´Âπ¥Á∫ßÔºâ': 'Âàù‰∫åÔºàÂÖ´Âπ¥Á∫ßÔºâ',
                'Âàù‰∏âÔºà‰πùÂπ¥Á∫ßÔºâ': 'Âàù‰∏âÔºà‰πùÂπ¥Á∫ßÔºâ',
                'È´ò‰∏ÄÔºàÂçÅÂπ¥Á∫ßÔºâ': 'È´ò‰∏ÄÔºàÂçÅÂπ¥Á∫ßÔºâ',
                'È´ò‰∫åÔºàÂçÅ‰∏ÄÂπ¥Á∫ßÔºâ': 'È´ò‰∫åÔºàÂçÅ‰∏ÄÂπ¥Á∫ßÔºâ',
                'È´ò‰∏âÔºàÂçÅ‰∫åÂπ¥Á∫ßÔºâ': 'È´ò‰∏âÔºàÂçÅ‰∫åÂπ¥Á∫ßÔºâ',
                'Â§ß‰∏Ä': 'Â§ß‰∏Ä',
                'Â§ß‰∫å': 'Â§ß‰∫å',
                'Â§ß‰∏â': 'Â§ß‰∏â',
                'Â§ßÂõõ': 'Â§ßÂõõ',
                'ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf': 'ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf'
            },
            'ÁπÅÈ´î‰∏≠Êñá': {
                'Language and Area': 'Ë™ûË®ÄÂíåÂú∞ÂçÄ',
                '‰∏ä‰º†ÊïôÊ°àÊñá‰ª∂': '‰∏äÂÇ≥ÊïôÊ°àÊñá‰ª∂',
                'ÁÇπÂáªÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü': 'ÈªûÊìäÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§ÂçÄÂüü',
                'ÊîØÊåÅ': 'ÊîØÊåÅ',
                'Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá': 'Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖÈÅé',
                'ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ': 'ÊïôÂ≠∏‰ø°ÊÅØÈÖçÁΩÆ',
                'Â≠¶ÊÆµ': 'Â≠∏ÊÆµ',
                'Âπ¥Á∫ß': 'Âπ¥Á¥ö',
                'Âú∞Âå∫': 'Âú∞ÂçÄ',
                'ËØæÁ®ãÂêçÁß∞': 'Ë™≤Á®ãÂêçÁ®±',
                'Â≠¶ÁîüÁ±ªÂà´': 'Â≠∏ÁîüÈ°ûÂà•',
                'ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢ò': 'ÈúÄË¶ÅÈÅøÂÖçÁöÑÂïèÈ°å',
                'ÊïôÊ°àËæìÂÖ•': 'ÊïôÊ°àËº∏ÂÖ•',
                'ÊïôÊ°à‰∏ªÈ¢ò': 'ÊïôÊ°à‰∏ªÈ°å',
                'ÊïôÊ°àÂÜÖÂÆπË¶ÅÁÇπ': 'ÊïôÊ°àÂÖßÂÆπË¶ÅÈªû',
                'Êèê‰∫§ÊïôÊ°à': 'Êèê‰∫§ÊïôÊ°à',
                'Ê∏ÖÁ©∫': 'Ê∏ÖÁ©∫',
                'Êñá‰ª∂È¢ÑËßà': 'Êñá‰ª∂È†êË¶Ω',
                'ÊïôÊ°àËß£ÊûêÁªìÊûú': 'ÊïôÊ°àËß£ÊûêÁµêÊûú',
                'Âø´Êç∑ËÆøÈóÆ': 'Âø´Êç∑Ë®™Âïè',
                'Áü•ËØÜÁÇπÊµèËßàÂô®': 'Áü•Ë≠òÈªûÁÄèË¶ΩÂô®',
                'ÊùêÊñôÊ±áÊÄªÈ°µÈù¢': 'ÊùêÊñôÂåØÁ∏ΩÈ†ÅÈù¢',
                '‰∏ÄÈîÆ‰∏ãËΩΩÂÖ®ÈÉ®': '‰∏ÄÈçµ‰∏ãËºâÂÖ®ÈÉ®',
                '‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩï': '‰∏ãËºâËßÄÈªûË®òÈåÑ',
                'Â∑≤‰øùÂ≠òËßÇÁÇπ': 'Â∑≤‰øùÂ≠òËßÄÈªû',
                'Êñá‰ª∂Â§πÊåáÂçó': 'Êñá‰ª∂Â§æÊåáÂçó',
                'Êü•ÁúãËØ¶ÊÉÖ': 'Êü•ÁúãË©≥ÊÉÖ',
                'ÂÖ≥Èó≠': 'ÈóúÈñâ',
                '‰æãÂ¶ÇÔºöÁßëÂ≠¶„ÄÅÊï∞Â≠¶„ÄÅËØ≠ÊñáÁ≠â': '‰æãÂ¶ÇÔºöÁßëÂ≠∏„ÄÅÊï∏Â≠∏„ÄÅË™ûÊñáÁ≠â',
                '‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂÆûÈ™åÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â': '‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂØ¶È©óÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â',
                'ËØ∑ÊèèËø∞Âú®ÊïôÂ≠¶ËøáÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÈÅøÂÖçÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ≠¶ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â...': 'Ë´ãÊèèËø∞Âú®ÊïôÂ≠∏ÈÅéÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà•Ê≥®ÊÑèÈÅøÂÖçÁöÑÂïèÈ°åÔºå‰æãÂ¶ÇÔºöÂ≠∏ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â...',
                'ËØ∑ËæìÂÖ•ÊïôÊ°à‰∏ªÈ¢òÔºå‰æãÂ¶ÇÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü': 'Ë´ãËº∏ÂÖ•ÊïôÊ°à‰∏ªÈ°åÔºå‰æãÂ¶ÇÔºöËÅ≤Èü≥ÁöÑÁî¢Áîü',
                'ËØ∑ËæìÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπ„ÄÅÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπÁ≠â...': 'Ë´ãËº∏ÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÖßÂÆπË¶ÅÈªû„ÄÅÊïôÂ≠∏ÁõÆÊ®ô„ÄÅÈáçÈªûÈõ£ÈªûÁ≠â...',
                'Â∞Ü‰ºòÂÖà‰ΩøÁî®Êæ≥Èó®‰ºòÁßÄÊïôÂ≠¶Ê°à‰æã‰Ωú‰∏∫ÂèÇËÄÉ': 'Â∞áÂÑ™ÂÖà‰ΩøÁî®Êæ≥ÈñÄÂÑ™ÁßÄÊïôÂ≠∏Ê°à‰æã‰ΩúÁÇ∫ÂèÉËÄÉ',
                // Â≠∏ÊÆµÈÅ∏È†Ö
                'Â∞èÂ≠¶': 'Â∞èÂ≠∏',
                'Âàù‰∏≠': 'Âàù‰∏≠',
                'È´ò‰∏≠': 'È´ò‰∏≠',
                'Â§ßÂ≠¶': 'Â§ßÂ≠∏',
                // Âπ¥Á¥öÈÅ∏È†Ö
                '‰∏ÄÂπ¥Á∫ß': '‰∏ÄÂπ¥Á¥ö',
                '‰∫åÂπ¥Á∫ß': '‰∫åÂπ¥Á¥ö',
                '‰∏âÂπ¥Á∫ß': '‰∏âÂπ¥Á¥ö',
                'ÂõõÂπ¥Á∫ß': 'ÂõõÂπ¥Á¥ö',
                '‰∫îÂπ¥Á∫ß': '‰∫îÂπ¥Á¥ö',
                'ÂÖ≠Âπ¥Á∫ß': 'ÂÖ≠Âπ¥Á¥ö',
                'Âàù‰∏ÄÔºà‰∏ÉÂπ¥Á∫ßÔºâ': 'Âàù‰∏ÄÔºà‰∏ÉÂπ¥Á¥öÔºâ',
                'Âàù‰∫åÔºàÂÖ´Âπ¥Á∫ßÔºâ': 'Âàù‰∫åÔºàÂÖ´Âπ¥Á¥öÔºâ',
                'Âàù‰∏âÔºà‰πùÂπ¥Á∫ßÔºâ': 'Âàù‰∏âÔºà‰πùÂπ¥Á¥öÔºâ',
                'È´ò‰∏ÄÔºàÂçÅÂπ¥Á∫ßÔºâ': 'È´ò‰∏ÄÔºàÂçÅÂπ¥Á¥öÔºâ',
                'È´ò‰∫åÔºàÂçÅ‰∏ÄÂπ¥Á∫ßÔºâ': 'È´ò‰∫åÔºàÂçÅ‰∏ÄÂπ¥Á¥öÔºâ',
                'È´ò‰∏âÔºàÂçÅ‰∫åÂπ¥Á∫ßÔºâ': 'È´ò‰∏âÔºàÂçÅ‰∫åÂπ¥Á¥öÔºâ',
                'Â§ß‰∏Ä': 'Â§ß‰∏Ä',
                'Â§ß‰∫å': 'Â§ß‰∫å',
                'Â§ß‰∏â': 'Â§ß‰∏â',
                'Â§ßÂõõ': 'Â§ßÂõõ',
                'ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf': 'Â∞éÂá∫Êú¨Âú∞È¢®Ê†ºÊïôÊ°àÁöÑpdf'
            },
            'English': {
                'Language and Area': 'Language and Area',
                '‰∏ä‰º†ÊïôÊ°àÊñá‰ª∂': 'Upload Lesson Plan File',
                'ÁÇπÂáªÊàñÊãñÊãΩÊïôÊ°àÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü': 'Click or drag lesson plan file to this area',
                'ÊîØÊåÅ': 'Supported formats',
                'Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá': 'File size limit',
                'ÊïôÂ≠¶‰ø°ÊÅØÈÖçÁΩÆ': 'Teaching Information Configuration',
                'Â≠¶ÊÆµ': 'Education Level',
                'Âπ¥Á∫ß': 'Grade',
                'Âú∞Âå∫': 'Region',
                'ËØæÁ®ãÂêçÁß∞': 'Course Name',
                'Â≠¶ÁîüÁ±ªÂà´': 'Student Category',
                'ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢ò': 'Problems to Avoid',
                'ÊïôÊ°àËæìÂÖ•': 'Lesson Plan Input',
                'ÊïôÊ°à‰∏ªÈ¢ò': 'Lesson Plan Topic',
                'ÊïôÊ°àÂÜÖÂÆπË¶ÅÁÇπ': 'Lesson Plan Content Points',
                'Êèê‰∫§ÊïôÊ°à': 'Submit Lesson Plan',
                'Ê∏ÖÁ©∫': 'Clear',
                'Êñá‰ª∂È¢ÑËßà': 'File Preview',
                'ÊïôÊ°àËß£ÊûêÁªìÊûú': 'Lesson Plan Analysis Result',
                'Âø´Êç∑ËÆøÈóÆ': 'Quick Access',
                'Áü•ËØÜÁÇπÊµèËßàÂô®': 'Knowledge Point Browser',
                'ÊùêÊñôÊ±áÊÄªÈ°µÈù¢': 'Materials Summary Page',
                '‰∏ÄÈîÆ‰∏ãËΩΩÂÖ®ÈÉ®': 'Download All',
                '‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩï': 'Download Opinion Records',
                'Â∑≤‰øùÂ≠òËßÇÁÇπ': 'Saved Opinions',
                'Êñá‰ª∂Â§πÊåáÂçó': 'Folder Guide',
                'Êü•ÁúãËØ¶ÊÉÖ': 'View Details',
                'ÂÖ≥Èó≠': 'Close',
                '‰æãÂ¶ÇÔºöÁßëÂ≠¶„ÄÅÊï∞Â≠¶„ÄÅËØ≠ÊñáÁ≠â': 'e.g., Science, Mathematics, Language, etc.',
                '‰æãÂ¶ÇÔºöÊôÆÈÄöÁè≠„ÄÅÂÆûÈ™åÁè≠„ÄÅÁâπÊÆäÊïôËÇ≤Á≠â': 'e.g., Regular Class, Experimental Class, Special Education, etc.',
                'ËØ∑ÊèèËø∞Âú®ÊïôÂ≠¶ËøáÁ®ã‰∏≠ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÈÅøÂÖçÁöÑÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöÂ≠¶ÁîüÊ≥®ÊÑèÂäõ‰∏çÈõÜ‰∏≠„ÄÅÊ¶ÇÂøµÊ∑∑Ê∑ÜÁ≠â...': 'Please describe problems that need special attention to avoid during teaching, e.g., students\' lack of attention, concept confusion, etc...',
                'ËØ∑ËæìÂÖ•ÊïôÊ°à‰∏ªÈ¢òÔºå‰æãÂ¶ÇÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü': 'Please enter lesson plan topic, e.g., Sound Production',
                'ËØ∑ËæìÂÖ•ÊïôÊ°àÁöÑ‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπ„ÄÅÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπÁ≠â...': 'Please enter main content points, teaching objectives, key points and difficulties, etc...',
                'Â∞Ü‰ºòÂÖà‰ΩøÁî®Êæ≥Èó®‰ºòÁßÄÊïôÂ≠¶Ê°à‰æã‰Ωú‰∏∫ÂèÇËÄÉ': 'Will prioritize using Macau excellent teaching cases as reference',
                // Education Level Options
                'Â∞èÂ≠¶': 'Primary School',
                'Âàù‰∏≠': 'Middle School',
                'È´ò‰∏≠': 'High School',
                'Â§ßÂ≠¶': 'University',
                // Grade Options
                '‰∏ÄÂπ¥Á∫ß': 'Grade 1',
                '‰∫åÂπ¥Á∫ß': 'Grade 2',
                '‰∏âÂπ¥Á∫ß': 'Grade 3',
                'ÂõõÂπ¥Á∫ß': 'Grade 4',
                '‰∫îÂπ¥Á∫ß': 'Grade 5',
                'ÂÖ≠Âπ¥Á∫ß': 'Grade 6',
                'Âàù‰∏ÄÔºà‰∏ÉÂπ¥Á∫ßÔºâ': 'Grade 7',
                'Âàù‰∫åÔºàÂÖ´Âπ¥Á∫ßÔºâ': 'Grade 8',
                'Âàù‰∏âÔºà‰πùÂπ¥Á∫ßÔºâ': 'Grade 9',
                'È´ò‰∏ÄÔºàÂçÅÂπ¥Á∫ßÔºâ': 'Grade 10',
                'È´ò‰∫åÔºàÂçÅ‰∏ÄÂπ¥Á∫ßÔºâ': 'Grade 11',
                'È´ò‰∏âÔºàÂçÅ‰∫åÂπ¥Á∫ßÔºâ': 'Grade 12',
                'Â§ß‰∏Ä': 'Year 1',
                'Â§ß‰∫å': 'Year 2',
                'Â§ß‰∏â': 'Year 3',
                'Â§ßÂõõ': 'Year 4',
                'ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf': 'Export Local Style Lesson Plan PDF'
            }
        };

        // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÂåÖ
        function getCurrentLanguagePack() {
            const region = document.getElementById('regionSelector')?.value || document.getElementById('region')?.value || 'Â§ßÈôÜ';
            
            if (region === 'Ëã±ÂõΩ' || region === 'È©¨Êù•Ë•ø‰∫ö') {
                return LANGUAGE_PACKS['English'];
            } else if (region === 'Êæ≥Èó®' || region === 'È¶ôÊ∏Ø') {
                return LANGUAGE_PACKS['ÁπÅÈ´î‰∏≠Êñá'];
            } else {
                return LANGUAGE_PACKS['ÁÆÄ‰Ωì‰∏≠Êñá'];
            }
        }

        // ÁøªËØëÊñáÊú¨
        function t(key) {
            const langPack = getCurrentLanguagePack();
            return langPack[key] || key;
        }

        // Êõ¥Êñ∞UIÊñáÊú¨
        function updateUITexts() {
            const langPack = getCurrentLanguagePack();
            
            // Êõ¥Êñ∞ÊâÄÊúâÂ∏¶Êúâdata-i18nÂ±ûÊÄßÁöÑÂÖÉÁ¥†
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langPack[key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = langPack[key];
                    } else if (element.tagName === 'LABEL') {
                        // ‰øùÁïôÂÜíÂè∑
                        const text = element.textContent;
                        if (text.includes('Ôºö') || text.includes(':')) {
                            element.textContent = langPack[key] + (text.includes('Ôºö') ? 'Ôºö' : ':');
                        } else {
                            element.textContent = langPack[key];
                        }
                    } else if (element.tagName === 'H3' || element.tagName === 'H1' || element.tagName === 'H2') {
                        // ‰øùÁïôÂõæÊ†á
                        const iconMatch = element.innerHTML.match(/<i[^>]*>.*?<\/i>/);
                        if (iconMatch) {
                            element.innerHTML = iconMatch[0] + ' ' + langPack[key];
                        } else {
                            element.textContent = langPack[key];
                        }
                    } else if (element.tagName === 'BUTTON') {
                        // ‰øùÁïôÂõæÊ†á
                        const iconMatch = element.innerHTML.match(/<i[^>]*>.*?<\/i>/);
                        if (iconMatch) {
                            element.innerHTML = iconMatch[0] + ' ' + langPack[key];
                        } else {
                            element.innerHTML = langPack[key];
                        }
                    } else {
                        element.textContent = langPack[key];
                    }
                }
            });

            // Êõ¥Êñ∞Âè≥‰∏äËßíÊ†áÁ≠æ
            const languageAreaLabel = document.getElementById('languageAreaLabel');
            if (languageAreaLabel && langPack['Language and Area']) {
                languageAreaLabel.textContent = langPack['Language and Area'];
            }
            
            // Êõ¥Êñ∞Â≠¶ÊÆµÂíåÂπ¥Á∫ß‰∏ãÊãâÊ°ÜÈÄâÈ°π
            updateGradeLevelOptions();
            updateGradeOptions();
        }

        // Êõ¥Êñ∞Âú∞Âå∫ËÆæÁΩÆ
        function updateRegionSettings() {
            const region = document.getElementById('region')?.value || document.getElementById('regionSelector')?.value || 'Â§ßÈôÜ';
            const macauIndicator = document.getElementById('macauCaseIndicator');

            // ÂêåÊ≠•‰∏§‰∏™ÈÄâÊã©Âô®
            const regionSelector = document.getElementById('regionSelector');
            const regionOld = document.getElementById('region');
            if (regionSelector && regionOld && regionSelector.value !== regionOld.value) {
                if (region === regionSelector.value) {
                    regionOld.value = region;
                } else {
                    regionSelector.value = region;
                }
            }

            if (region === 'Êæ≥Èó®' || region === 'È¶ôÊ∏Ø') {
                if (macauIndicator) macauIndicator.style.display = 'block';
                window.currentRegion = 'macau';
                window.isEnglishRegion = false;
                document.documentElement.lang = 'zh-TW';
            } else if (region === 'Ëã±ÂõΩ' || region === 'È©¨Êù•Ë•ø‰∫ö') {
                if (macauIndicator) macauIndicator.style.display = 'none';
                window.currentRegion = region;
                window.isEnglishRegion = true;
                document.documentElement.lang = 'en';
            } else {
                if (macauIndicator) macauIndicator.style.display = 'none';
                window.currentRegion = region;
                window.isEnglishRegion = false;
                document.documentElement.lang = 'zh-CN';
            }

            // Êõ¥Êñ∞UIÊñáÊú¨
            updateUITexts();
        }

        // Êõ¥Êñ∞Âú∞Âå∫ÂíåËØ≠Ë®ÄÔºà‰ªéÂè≥‰∏äËßíÈÄâÊã©Âô®Ôºâ
        window.updateRegionAndLanguage = function() {
            const region = document.getElementById('regionSelector').value;
            
            // ÂêåÊ≠•Âà∞ÂéüÊù•ÁöÑÂú∞Âå∫ÈÄâÊã©Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const regionOld = document.getElementById('region');
            if (regionOld) {
                regionOld.value = region;
            }

            updateRegionSettings();
        }

        // ÂàùÂßãÂåñÂú∞Âå∫ËÆæÁΩÆ
        window.currentRegion = 'Â§ßÈôÜ';
        window.isEnglishRegion = false;

        // Ëé∑ÂèñÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
        function getTeachingConfig() {
            const gradeLevel = document.getElementById('gradeLevel').value;
            const specificGrade = document.getElementById('specificGrade').value;
            const courseName = document.getElementById('courseName').value.trim();
            const studentCategory = document.getElementById('studentCategory').value.trim();
            const avoidProblems = document.getElementById('avoidProblems').value.trim();
            
            let configText = `\n„ÄêÊïôÂ≠¶ËÉåÊôØ‰ø°ÊÅØ„Äë\n`;
            configText += `Â≠¶ÊÆµÔºö${gradeLevel}\n`;
            configText += `Âπ¥Á∫ßÔºö${specificGrade}\n`;
            
            if (courseName) {
                configText += `ËØæÁ®ãÂêçÁß∞Ôºö${courseName}\n`;
            }
            
            if (studentCategory) {
                configText += `Â≠¶ÁîüÁ±ªÂà´Ôºö${studentCategory}\n`;
            }
            
            if (avoidProblems) {
                configText += `ÈúÄË¶ÅÈÅøÂÖçÁöÑÈóÆÈ¢òÔºö${avoidProblems}\n`;
            }
            
            // Âú®ÊéßÂà∂Âè∞ÊòæÁ§∫ÈÖçÁΩÆ‰ø°ÊÅØÔºå‰æø‰∫éË∞ÉËØï
            console.log('üìù ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØÂ∑≤Ëé∑Âèñ:');
            console.log(configText);
            console.log('-------------------');
            
            return configText;
        }

        // Êèê‰∫§ÊïôÊ°àÔºàÁªü‰∏ÄÂÖ•Âè£Ôºâ
        window.submitLessonPlan = function() {
            const lessonTitle = document.getElementById('lessonTitle').value.trim();
            const lessonContent = document.getElementById('lessonContent').value.trim();
            
            if (!lessonTitle || !lessonContent) {
                showMessage('‚ùå ËØ∑Â°´ÂÜôÊïôÊ°à‰∏ªÈ¢òÂíåÂÜÖÂÆπË¶ÅÁÇπ', 'error');
                return;
            }
            
            // Ëé∑ÂèñÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
            const teachingConfig = getTeachingConfig();
            
            // ===== Ë∞ÉËØï‰ø°ÊÅØÔºöÊòæÁ§∫ÊïôÂ≠¶ÈÖçÁΩÆ =====
            console.log('========================================');
            console.log('üìã Êèê‰∫§ÊïôÊ°à - ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØÔºö');
            console.log('========================================');
            console.log(teachingConfig);
            console.log('========================================');
            
            // ÊûÑÂª∫ÊïôÊ°àÂÜÖÂÆπ
            const manualLessonPlan = `„ÄêÊïôÊ°à‰∏ªÈ¢ò„Äë
${lessonTitle}

„ÄêÊïôÂ≠¶ÂÜÖÂÆπË¶ÅÁÇπ„Äë
${lessonContent}
${teachingConfig}
„ÄêËØ¥Êòé„Äë
Êú¨ÊïôÊ°àÁî±ÊïôÂ∏àÊâãÂä®ËæìÂÖ•ÔºåÂ∞ÜÁî±AIÊïôÁ†îÁªÑËøõË°åÊ∑±Â∫¶ÂàÜÊûêÂíå‰ºòÂåñ„ÄÇ`;
            
            // ===== Ë∞ÉËØï‰ø°ÊÅØÔºöÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ =====
            console.log('üìÑ Â∞ÜË¶Å‰º†ÈÄíÁªôAIÁöÑÂÆåÊï¥ÊïôÊ°àÂÜÖÂÆπÔºö');
            console.log('----------------------------------------');
            console.log(manualLessonPlan);
            console.log('========================================');
            
            // ËÆæÁΩÆ‰∏∫Â∑≤Ëß£ÊûêÂÜÖÂÆπ
            parsedFileContent = manualLessonPlan;
            
            // ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
            showParsedContent(manualLessonPlan);
            showMessage('‚úÖ ÊïôÊ°àÂÜÖÂÆπÂ∑≤ÂΩïÂÖ•ÔºÅÊïôÂ≠¶ÈÖçÁΩÆÂ∑≤Ê∑ªÂä†ÔºàËØ∑Êü•ÁúãÊéßÂà∂Âè∞ÊàñÈ¢ÑËßàÂå∫ÂüüÔºâ', 'success');
            
            // ÂºÄÂßã‰∏âÈò∂ÊÆµÂàÜÊûê
            setTimeout(() => {
                startThreeStageAnalysis();
            }, 1500);
        };

        // ÁîüÊàêÊïôÊ°àÔºàÂΩìÊ≤°Êúâ‰∏ä‰º†Êñá‰ª∂Êó∂Ôºâ- ÊèêÂâçÂÆö‰πâÁ°Æ‰øùÊåâÈíÆÂèØ‰ª•Ë∞ÉÁî®
        window.generateLessonPlan = async function() {
            const lessonTitle = document.getElementById('lessonTitle').value.trim();
            const lessonContent = document.getElementById('lessonContent').value.trim();

            if (!lessonTitle || !lessonContent) {
                showMessage('‚ùå ËØ∑Â°´ÂÜôÊïôÊ°à‰∏ªÈ¢òÂíåÂÜÖÂÆπ', 'error');
                return;
            }

            showMessage('ü§ñ Ê≠£Âú®ÁîüÊàê45ÂàÜÈíüÊïôÊ°à...', 'info');

            try {
                // Ëé∑ÂèñÂú∞Âå∫‰ø°ÊÅØÂíå‰ºòÁßÄÊ°à‰æã
                const region = document.getElementById('region').value;
                let regionalReference = '';

                if (region === 'Êæ≥Èó®' && REGIONAL_EXCELLENT_CASES.macau) {
                    const macauCase = REGIONAL_EXCELLENT_CASES.macau;
                    regionalReference = `

„ÄêÊæ≥Èó®Âú∞Âå∫‰ºòÁßÄÊïôÂ≠¶Ê°à‰æãÂèÇËÄÉ„Äë
ËØ∑‰ºòÂÖàÂèÇËÄÉ‰ª•‰∏ãÊæ≥Èó®Âú∞Âå∫ÁöÑ‰ºòÁßÄÊïôÂ≠¶Ê°à‰æãÊù•ËÆæËÆ°ÊïôÊ°àÔºö

Ê°à‰æãÊ†áÈ¢òÔºö${macauCase.title}
ÈÄÇÁî®Âπ¥Á∫ßÔºö${macauCase.grade}
ËØæÁ®ãÊó∂ÈïøÔºö${macauCase.duration}

ÊïôÂ≠¶Ê¥ªÂä®ÊµÅÁ®ãÔºö
${macauCase.activities.map(activity => `
${activity.phase}Ôºà${activity.time}Ôºâ
ÁõÆÊ†á‰ª£Âè∑Ôºö${activity.objectives.join('„ÄÅ')}
Ê¥ªÂä®ÂÜÖÂÆπÔºö
${activity.content}
ÊïôÂ≠¶ËµÑÊ∫êÔºö${activity.resources.join('„ÄÅ')}
ËØÑ‰ª∑ÊñπÂºèÔºö${activity.assessment}
`).join('\n')}

ËØ∑Ê†πÊçÆÊæ≥Èó®Â≠¶ÁîüÁöÑÂ≠¶‰π†ÁâπÁÇπÂíåËøô‰∏™‰ºòÁßÄÊ°à‰æãÁöÑÁªìÊûÑÔºåËÆæËÆ°ÈÄÇÂêàÊæ≥Èó®Âú∞Âå∫ÁöÑÊïôÊ°à„ÄÇ`;
                }

                const regionForPrompt = document.getElementById('region').value;
                const isEnglishPrompt = regionForPrompt === 'Ëã±ÂõΩ' || regionForPrompt === 'È©¨Êù•Ë•ø‰∫ö';
                
                let prompt = '';
                if (isEnglishPrompt) {
                    prompt = `Please generate a complete 45-minute lesson plan based on the following topic and content:

Topic: ${lessonTitle}

Main Content Points:
${lessonContent}${regionalReference}

Please generate a standard 45-minute lesson plan that includes:
1. Learning Objectives (3-4 specific objectives)
2. Teaching Focus and Difficulties
3. Teaching Preparation
4. Teaching Process (Introduction, New Teaching, Practice, Summary, etc.)
5. Blackboard Design
6. Homework Assignment
7. Teaching Evaluation

Please ensure the lesson plan structure is complete, time allocation is reasonable, and each section has specific content and time allocation.`;
                } else {
                    prompt = `ËØ∑Ê†πÊçÆ‰ª•‰∏ã‰∏ªÈ¢òÂíåÂÜÖÂÆπÔºåÁîüÊàê‰∏Ä‰ªΩÂÆåÊï¥ÁöÑ45ÂàÜÈíüÊïôÊ°àÔºö

‰∏ªÈ¢òÔºö${lessonTitle}

‰∏ªË¶ÅÂÜÖÂÆπË¶ÅÁÇπÔºö
${lessonContent}${regionalReference}

ËØ∑ÁîüÊàê‰∏Ä‰∏™Ê†áÂáÜÁöÑ45ÂàÜÈíüÊïôÊ°àÔºåÂåÖÂê´Ôºö
1. ÊïôÂ≠¶ÁõÆÊ†áÔºà3-4‰∏™ÂÖ∑‰ΩìÁõÆÊ†áÔºâ
2. ÊïôÂ≠¶ÈáçÁÇπÂíåÈöæÁÇπ
3. ÊïôÂ≠¶ÂáÜÂ§á
4. ÊïôÂ≠¶ËøáÁ®ãÔºàÂØºÂÖ•„ÄÅÊñ∞Êéà„ÄÅÂ∑©Âõ∫„ÄÅÊÄªÁªìÁ≠âÁéØËäÇÔºâ
5. Êùø‰π¶ËÆæËÆ°
6. ‰Ωú‰∏öÂ∏ÉÁΩÆ
7. ÊïôÂ≠¶ËØÑ‰ª∑

ËØ∑Á°Æ‰øùÊïôÊ°àÁªìÊûÑÂÆåÊï¥ÔºåÊó∂Èó¥ÂàÜÈÖçÂêàÁêÜÔºåÊØè‰∏™ÁéØËäÇÈÉΩÊúâÂÖ∑‰ΩìÂÜÖÂÆπÂíåÊó∂Èó¥ÂàÜÈÖç„ÄÇ`;
                }

                const generatedContent = await callLessonGeneratorAPI(prompt);

                if (generatedContent) {
                    // Ê∑ªÂä†ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
                    const teachingConfig = getTeachingConfig();
                    let fullContent = generatedContent + teachingConfig;

                    // Â¶ÇÊûúÊòØÊæ≥Èó®ÊàñÈ¶ôÊ∏ØÂú∞Âå∫ÔºåËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó
                    if (region === 'Êæ≥Èó®' || region === 'È¶ôÊ∏Ø') {
                        try {
                            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
                            fullContent = converter(fullContent);
                            console.log('Â∑≤Â∞ÜÊïôÊ°àËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó');
                        } catch (error) {
                            console.warn('ÁπÅ‰ΩìÂ≠óËΩ¨Êç¢Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÊñá:', error);
                        }
                    }

                    // ÊòæÁ§∫ÁîüÊàêÁöÑÊïôÊ°à
                    showParsedContent(fullContent);
                    parsedFileContent = fullContent;

                    // ÁîüÊàêHTMLÊ†ºÂºèÂπ∂‰øùÂ≠ò‰∏∫PDF
                    showMessage('‚úÖ ÊïôÊ°àÁîüÊàêÂÆåÊàêÔºÅÊ≠£Âú®Ê†ºÂºèÂåñ‰∏∫HTMLÂπ∂ÁîüÊàêPDF...', 'success');
                    try {
                        const htmlContent = await formatLessonPlanToHTML(fullContent);
                        await saveLessonPlanAsPDF(htmlContent, lessonTitle);
                    } catch (error) {
                        console.error('HTMLÊ†ºÂºèÂåñÂíåPDF‰øùÂ≠òÂ§±Ë¥•:', error);
                        showMessage(`‚ö†Ô∏è HTMLÊ†ºÂºèÂåñÂíåPDF‰øùÂ≠òÂ§±Ë¥•: ${error.message}`, 'warning');
                    }

                    // ÂÖàÁîüÊàêÂàùÊ≠•ÁöÑËØæÁ®ãÊºîÁ§∫ÊùêÊñôÔºà‰∏çÈòªÂ°ûÂêéÁª≠ÊµÅÁ®ãÔºâ
                    generateInitialCourseMaterial(generatedContent, lessonTitle).then(() => {
                        console.log('ÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàêÂÆåÊàê');
                    }).catch(err => {
                        console.error('ÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàêÂ§±Ë¥•:', err);
                    });

                    // Á≠âÂæÖ1.5ÁßíÂêéÂºÄÂßãÊïôÁ†îÁªÑÂàÜÊûê
                    setTimeout(() => {
                        showMessage('‚úÖ ÂºÄÂßãÊïôÁ†îÁªÑÂçè‰ΩúÂàÜÊûê...', 'info');
                        startThreeStageAnalysis();
                    }, 1500);
                } else {
                    showMessage('‚ùå ÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }
            } catch (error) {
                console.error('ÊïôÊ°àÁîüÊàêÂ§±Ë¥•:', error);
                showMessage('‚ùå ÊïôÊ°àÁîüÊàêÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        };

        // Ê∏ÖÁ©∫ÊïôÊ°àËæìÂÖ•
        window.clearLessonPlan = function() {
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonContent').value = '';
            showMessage('ÊïôÊ°àËæìÂÖ•Â∑≤Ê∏ÖÁ©∫', 'info');
        };

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÂπ¥Á∫ßÈÄâÈ°πÂíåÊÅ¢Â§çËßÇÁÇπÊï∞ÊçÆ
        window.addEventListener('load', function() {
            updateGradeOptions();
            
            // ===== ÂàùÂßãÂåñ window.allAcceptedOpinionsÔºàÁ°Æ‰øùÂ≠òÂú®Ôºâ=====
            if (!window.allAcceptedOpinions) {
                window.allAcceptedOpinions = [];
                console.log('üîß ÂàùÂßãÂåñ window.allAcceptedOpinions');
            }
            
            // ===== Â∞ùËØï‰ªélocalStorageÊÅ¢Â§çËßÇÁÇπÊï∞ÊçÆ =====
            try {
                const backupData = localStorage.getItem('allAcceptedOpinions_backup');
                if (backupData) {
                    const parsed = JSON.parse(backupData);
                    if (parsed.opinions && parsed.opinions.length > 0) {
                        window.allAcceptedOpinions = parsed.opinions;
                        
                        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #52c41a; font-weight: bold;');
                        console.log(`%cüîÑ È°µÈù¢Âä†ËΩΩÔºö‰ªélocalStorageÊÅ¢Â§ç‰∫Ü ${window.allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`, 'color: #52c41a; font-size: 14px; font-weight: bold;');
                        console.log(`%c   Â§á‰ªΩÊó∂Èó¥Ôºö${new Date(parsed.timestamp).toLocaleString('zh-CN')}`, 'color: #13c2c2;');
                        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #52c41a; font-weight: bold;');
                        
                        // ÊòæÁ§∫ÊÅ¢Â§çÊèêÁ§∫ÂíåÊõ¥Êñ∞ËÆ°Êï∞Âô®
                        setTimeout(() => {
                            showMessage(`‚úÖ Â∑≤ÊÅ¢Â§ç ${window.allAcceptedOpinions.length} ‰∏™‰πãÂâç‰øùÂ≠òÁöÑËßÇÁÇπÔºàÊù•Ëá™‰∏äÊ¨°‰ºöËØùÔºâ`, 'success');
                            updateSavedOpinionsCounter();
                        }, 1000);
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è localStorageÊÅ¢Â§çÂ§±Ë¥•:', e.message);
            }
            
            // ===== ÂàùÂßãÂåñËÆ°Êï∞Âô®ÔºàÁ°Æ‰øùÊòæÁ§∫Ôºâ=====
            setTimeout(() => {
                updateSavedOpinionsCounter();
            }, 500);
        });

        // Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂêåÊ≠•Âú∞Âå∫ÈÄâÊã©Âô®
            const regionSelector = document.getElementById('regionSelector');
            const regionOld = document.getElementById('region');
            if (regionSelector && regionOld) {
                regionOld.value = regionSelector.value;
            }
            
            // ÂàùÂßãÂåñÂú∞Âå∫ËÆæÁΩÆ
            updateRegionSettings();
            
            // ÂàùÂßãÂåñUIÊñáÊú¨
            updateUITexts();
            
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileSelect);
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file).catch(error => {
                    console.error('Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜÂ§±Ë¥•:', error);
                    showMessage('‚ùå Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜÂ§±Ë¥•Ôºö' + error.message, 'error');
                });
            }
        }

        async function handleFile(file) {
            // È™åËØÅÊñá‰ª∂ÂØπË±°
            if (!file || !file.name) {
                showMessage('Êó†ÊïàÁöÑÊñá‰ª∂ÂØπË±°', 'error');
                return;
            }

            const fileName = file.name.toLowerCase();
            // Êõ¥ÂÆâÂÖ®ÁöÑÊâ©Â±ïÂêçÊèêÂèñ
            const lastDotIndex = fileName.lastIndexOf('.');
            const fileExtension = lastDotIndex > 0 ? '.' + fileName.substring(lastDotIndex + 1) : '';

            console.log('Êñá‰ª∂‰ø°ÊÅØ:', {
                name: file.name,
                size: file.size,
                type: file.type,
                extension: fileExtension,
                lastDotIndex: lastDotIndex,
                fileName: fileName
            });

            // ÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã
            const supportedExtensions = ['.txt', '.doc', '.docx', '.rtf', '.pdf', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.ppt', '.pptx'];

            // È¢ùÂ§ñÁöÑMIMEÁ±ªÂûãÈ™åËØÅÔºà‰Ωú‰∏∫Êâ©Â±ïÂêçÈ™åËØÅÁöÑË°•ÂÖÖÔºâ
            const mimeToExtension = {
                'text/plain': '.txt',
                'application/msword': '.doc',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',
                'application/rtf': '.rtf',
                'application/pdf': '.pdf',
                'image/png': '.png',
                'image/jpeg': '.jpg',
                'image/gif': '.gif',
                'image/bmp': '.bmp',
                'application/vnd.ms-powerpoint': '.ppt',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': '.pptx'
            };

            // Â¶ÇÊûúMIMEÁ±ªÂûãÂåπÈÖçÔºå‰ºòÂÖà‰ΩøÁî®MIMEÁ±ªÂûãÂØπÂ∫îÁöÑÊâ©Â±ïÂêç
            if (file.type && mimeToExtension[file.type]) {
                const mimeExtension = mimeToExtension[file.type];
                console.log('‰ΩøÁî®MIMEÁ±ªÂûãÁ°ÆÂÆöÁöÑÊâ©Â±ïÂêç:', mimeExtension);
            }

            // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºà20MBÔºâ
            if (file.size > 20 * 1024 * 1024) {
                showMessage('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá 20MBÔºÅ', 'error');
                return;
            }

            // È™åËØÅÊñá‰ª∂Á±ªÂûã
            console.log('È™åËØÅÊñá‰ª∂Á±ªÂûã:', fileExtension, 'ÊòØÂê¶Âú®ÊîØÊåÅÂàóË°®‰∏≠:', supportedExtensions.includes(fileExtension));

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑMIMEÁ±ªÂûã‰Ωú‰∏∫Â§áÈÄâ
            let isValidType = supportedExtensions.includes(fileExtension);
            let actualExtension = fileExtension;
            if (!isValidType && file.type && mimeToExtension[file.type]) {
                const mimeExtension = mimeToExtension[file.type];
                if (supportedExtensions.includes(mimeExtension)) {
                    isValidType = true;
                    actualExtension = mimeExtension;
                    console.log('‰ΩøÁî®MIMEÁ±ªÂûãÂ§áÈÄâÊñπÊ°à:', mimeExtension);
                }
            }

            if (!isValidType) {
                const supportedTypes = supportedExtensions.join(', ');
                showMessage('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºèÔºö' + fileExtension + '„ÄÇÊîØÊåÅÊ†ºÂºèÔºö' + supportedTypes, 'error');
                console.log('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Êâ©Â±ïÂêç:', fileExtension, 'MIMEÁ±ªÂûã:', file.type);
                return;
            }

            currentFile = file;
            console.log('Êñá‰ª∂Â§ÑÁêÜÂºÄÂßã:', file.name);
            showMessage('Ê≠£Âú®Â§ÑÁêÜÊñá‰ª∂Ôºö' + file.name, 'info');

            // ‰ΩøÁî®Â§öÊ®°ÊÄÅAIËß£ÊûêÊñá‰ª∂
            try {
                await parseFileWithMultimodalAI(file, fileExtension);
            } catch (error) {
                console.error('Êñá‰ª∂Â§ÑÁêÜËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', error);
                showMessage('‚ùå Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }

        // ‰ΩøÁî®Â§öÊ®°ÊÄÅAIËß£ÊûêÊñá‰ª∂
        async function parseFileWithMultimodalAI(file, extension) {
            try {
                console.log('ÂºÄÂßã‰ΩøÁî®Â§öÊ®°ÊÄÅAIËß£ÊûêÊñá‰ª∂:', file.name);

                // ‰ΩøÁî®‰º†ÂÖ•ÁöÑÊâ©Â±ïÂêç
                const fileExtension = extension;

                // ÊòæÁ§∫Êñá‰ª∂È¢ÑËßà
                const preview = document.getElementById('filePreview');
                const contentElement = document.getElementById('fileContent');

                if (!preview) {
                    console.error('Êó†Ê≥ïÊâæÂà∞Êñá‰ª∂È¢ÑËßàÂÖÉÁ¥†');
                    throw new Error('Êó†Ê≥ïÊâæÂà∞Êñá‰ª∂È¢ÑËßàÂÖÉÁ¥†');
                }

                preview.classList.remove('hidden');

                // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÊòæÁ§∫È¢ÑËßà
                
                if (['.png', '.jpg', '.jpeg', '.gif', '.bmp'].includes(fileExtension)) {
                    // ÂõæÁâáÊñá‰ª∂È¢ÑËßà
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        contentElement.innerHTML = `
                            <div class="image-preview">
                                <img src="${e.target.result}" alt="‰∏ä‰º†ÁöÑÂõæÁâá" style="max-width: 100%; height: auto; border-radius: 8px;">
                                <div class="image-info">
                                    <p><strong>Êñá‰ª∂ÂêçÔºö</strong>${file.name}</p>
                                    <p><strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${(file.size / 1024).toFixed(2)} KB</p>
                                    <p><strong>Êñá‰ª∂Á±ªÂûãÔºö</strong>ÂõæÁâáÊñá‰ª∂</p>
                                    <p><strong>Â§ÑÁêÜÁä∂ÊÄÅÔºö</strong>Ê≠£Âú®‰ΩøÁî®OCRËØÜÂà´ÊñáÂ≠óÂÜÖÂÆπ...</p>
                                </div>
                            </div>
                        `;
                        // ÂºÇÊ≠•ÊâßË°åÂø´ÈÄüOCRÁî®‰∫éÈ¢ÑËßàÔºà‰ΩøÁî®setTimeoutÈÅøÂÖçÈòªÂ°ûÔºâ
                        setTimeout(() => {
                            quickOcr(file).catch(error => {
                                console.warn('Âø´ÈÄüOCRÈ¢ÑËßàÂ§±Ë¥•:', error);
                            });
                        }, 100);
                    };
                    reader.readAsDataURL(file);
                } else if (['.pdf'].includes(fileExtension)) {
                    // PDFÊñá‰ª∂È¢ÑËßà
                    contentElement.innerHTML = `
                        <div class="pdf-preview">
                            <div class="pdf-info">
                                <p><strong>Êñá‰ª∂ÂêçÔºö</strong>${file.name}</p>
                                <p><strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${(file.size / 1024).toFixed(2)} KB</p>
                                <p><strong>Êñá‰ª∂Á±ªÂûãÔºö</strong>PDFÊñáÊ°£</p>
                                <p><strong>Â§ÑÁêÜÁä∂ÊÄÅÔºö</strong>Ê≠£Âú®‰ΩøÁî®AIÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ...</p>
                            </div>
                        </div>
                    `;
                } else if (['.docx', '.doc', '.rtf'].includes(fileExtension)) {
                    // WordÊñáÊ°£È¢ÑËßà
                    contentElement.innerHTML = `
                        <div class="word-preview">
                            <div class="word-info">
                                <p><strong>Êñá‰ª∂ÂêçÔºö</strong>${file.name}</p>
                                <p><strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${(file.size / 1024).toFixed(2)} KB</p>
                                <p><strong>Êñá‰ª∂Á±ªÂûãÔºö</strong>WordÊñáÊ°£</p>
                                <p><strong>Â§ÑÁêÜÁä∂ÊÄÅÔºö</strong>Ê≠£Âú®‰ΩøÁî®AIÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ...</p>
                            </div>
                        </div>
                    `;
                } else if (['.ppt', '.pptx'].includes(fileExtension)) {
                    // PowerPointÊñáÊ°£È¢ÑËßà
                    contentElement.innerHTML = `
                        <div class="ppt-preview">
                            <div class="ppt-info">
                                <p><strong>Êñá‰ª∂ÂêçÔºö</strong>${file.name}</p>
                                <p><strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${(file.size / 1024).toFixed(2)} KB</p>
                                <p><strong>Êñá‰ª∂Á±ªÂûãÔºö</strong>PowerPointÊñáÊ°£</p>
                                <p><strong>Â§ÑÁêÜÁä∂ÊÄÅÔºö</strong>Ê≠£Âú®‰ΩøÁî®AIÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ...</p>
                            </div>
                        </div>
                    `;
                } else {
                    // ÊñáÊú¨Êñá‰ª∂È¢ÑËßà
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        fileContent = e.target.result;
                        contentElement.textContent = fileContent;
                        console.log('ÊñáÊú¨Êñá‰ª∂È¢ÑËßàÂÆåÊàêÔºåÈïøÂ∫¶:', fileContent.length);
                    };
                    reader.onerror = function() {
                        console.error('ÊñáÊú¨Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                        contentElement.textContent = 'Êñá‰ª∂ËØªÂèñÂ§±Ë¥•';
                    };
                    reader.readAsText(file, 'UTF-8');
                }

                // Ë∞ÉÁî®Â§öÊ®°ÊÄÅAIËß£Êûê
                console.log('ÂºÄÂßãË∞ÉÁî®Â§öÊ®°ÊÄÅAIËß£Êûê...');
                const parsedContent = await callMultimodalParserAPI(file, fileExtension);
                console.log('Â§öÊ®°ÊÄÅAIËß£ÊûêÂÆåÊàêÔºåÁªìÊûúÈïøÂ∫¶:', parsedContent ? parsedContent.length : 0);

                if (parsedContent && parsedContent.trim().length > 0) {
                    // Ê∑ªÂä†ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
                    const teachingConfig = getTeachingConfig();
                    let fullContent = parsedContent + teachingConfig;

                    // Â¶ÇÊûúÊòØÊæ≥Èó®ÊàñÈ¶ôÊ∏ØÂú∞Âå∫ÔºåËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó
                    const region = document.getElementById('region').value;
                    if (region === 'Êæ≥Èó®' || region === 'È¶ôÊ∏Ø') {
                        try {
                            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
                            fullContent = converter(fullContent);
                            console.log('Â∑≤Â∞ÜËß£ÊûêÁªìÊûúËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó');
                        } catch (error) {
                            console.warn('ÁπÅ‰ΩìÂ≠óËΩ¨Êç¢Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÊñá:', error);
                        }
                    }

                    showParsedContent(fullContent);
                    parsedFileContent = fullContent;
                    showMessage('‚úÖ Êñá‰ª∂Ëß£ÊûêÂÆåÊàêÔºÅÂºÄÂßãÊïôÁ†îÁªÑÂçè‰ΩúÂàÜÊûê...', 'success');

                    setTimeout(() => {
                        startThreeStageAnalysis();
                    }, 1500);
                } else {
                    // Â¶ÇÊûúAPIËøîÂõûÁ©∫ÁªìÊûúÔºå‰ΩøÁî®Ê®°ÊãüËß£ÊûêÁªìÊûú
                    console.warn('APIËøîÂõûÁ©∫ÁªìÊûúÔºå‰ΩøÁî®Ê®°ÊãüËß£ÊûêÁªìÊûú');
                    const fallbackParsedContent = `„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞ÔºöÂ∞èÂ≠¶ÁßëÂ≠¶ËØæÁ®ã
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºöÂ∞èÂ≠¶‰∏âÂπ¥Á∫ß
- ËØæÊó∂ÂÆâÊéíÔºö1ËØæÊó∂
- ÊïôÂ≠¶ÁõÆÊ†áÔºöÂ≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîüÂéüÁêÜ

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü‰∏éÊåØÂä®
- ÊïôÂ≠¶ÈáçÁÇπÔºöÂ£∞Èü≥ÊòØÁî±Áâ©‰ΩìÊåØÂä®‰∫ßÁîüÁöÑ
- ÊïôÂ≠¶ÈöæÁÇπÔºöÁêÜËß£ÊåØÂä®‰∏éÂ£∞Èü≥ÁöÑÂÖ≥Á≥ª
- ÊïôÂ≠¶ÊñπÊ≥ïÔºöÂÆûÈ™åËßÇÂØü„ÄÅËÆ®ËÆ∫‰∫§ÊµÅ

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºöÊí≠ÊîæÂ£∞Èü≥ÔºåÂºïËµ∑ÂÖ¥Ë∂£
- Êñ∞ÊéàÁéØËäÇÔºöÂÆûÈ™åËßÇÂØüÊåØÂä®Áé∞Ë±°
- ÁªÉ‰π†ÁéØËäÇÔºöÂ∞èÁªÑÂÆûÈ™åÈ™åËØÅ
- ÊÄªÁªìÁéØËäÇÔºöÂΩíÁ∫≥Â£∞Èü≥‰∫ßÁîüÂéüÁêÜ

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑ÔºöÈü≥Âèâ„ÄÅÊ©°ÁöÆÁ≠ã„ÄÅÈºì
- Â≠¶‰π†ÊùêÊñôÔºöÂÆûÈ™åÂô®Êùê
- ËØÑ‰ª∑ÊñπÂºèÔºöËßÇÂØüÂ≠¶ÁîüÂÆûÈ™åË°®Áé∞

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºöÂ¢ûÂä†È¢ÑÊµãÁéØËäÇ
- ÂÜÖÂÆπ‰ºòÂåñÔºöË°•ÂÖÖÁîüÊ¥ªÂÆû‰æã
- ÊñπÊ≥ï‰ºòÂåñÔºöÂ¢ûÂä†‰∫íÂä®ÂÆûÈ™å`;

                    // Ê∑ªÂä†ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
                    const teachingConfig = getTeachingConfig();
                    let fullFallbackContent = fallbackParsedContent + teachingConfig;

                    // Â¶ÇÊûúÊòØÊæ≥Èó®ÊàñÈ¶ôÊ∏ØÂú∞Âå∫ÔºåËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó
                    const region = document.getElementById('region').value;
                    if (region === 'Êæ≥Èó®' || region === 'È¶ôÊ∏Ø') {
                        try {
                            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
                            fullFallbackContent = converter(fullFallbackContent);
                            console.log('Â∑≤Â∞ÜÂ§áÁî®Ëß£ÊûêÁªìÊûúËΩ¨Êç¢‰∏∫ÁπÅ‰ΩìÂ≠ó');
                        } catch (error) {
                            console.warn('ÁπÅ‰ΩìÂ≠óËΩ¨Êç¢Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÊñá:', error);
                        }
                    }

                    showParsedContent(fullFallbackContent);
                    parsedFileContent = fullFallbackContent;
                    showMessage('‚úÖ Êñá‰ª∂Ëß£ÊûêÂÆåÊàêÔºÅÂºÄÂßãÊïôÁ†îÁªÑÂçè‰ΩúÂàÜÊûê...', 'success');

                    setTimeout(() => {
                        startThreeStageAnalysis();
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Â§öÊ®°ÊÄÅAIËß£ÊûêÂ§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', error.message, error.stack);
                showMessage('‚ùå Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }

        // Ë∞ÉÁî®Â§öÊ®°ÊÄÅËß£ÊûêAPI
        async function callMultimodalParserAPI(file, extension) {
            try {
                console.log('Ë∞ÉÁî®Â§öÊ®°ÊÄÅËß£ÊûêAPI...');

                // ‰ΩøÁî®‰º†ÂÖ•ÁöÑÊâ©Â±ïÂêç
                const fileExtension = extension;
                
                let prompt = '';
                let messages = [];
                
                if (['.png', '.jpg', '.jpeg', '.gif', '.bmp'].includes(fileExtension)) {
                    // ÂõæÁâáÊñá‰ª∂ - ÂÖàÂ∞ùËØïOCRÔºåÁÑ∂ÂêéÁî®Â§öÊ®°ÊÄÅAPI
                    try {
                        // ÂÖàÁî®OCRÂø´ÈÄüËØÜÂà´ÊñáÊú¨
                        const ocrText = await ocrImage(file);
                        console.log('OCRËØÜÂà´ÊàêÂäüÔºåÊñáÊú¨ÈïøÂ∫¶:', ocrText.length);

                        // Â¶ÇÊûúOCRËØÜÂà´ÊúâÂÜÖÂÆπÔºåÁî®ÊñáÊú¨Ëß£Êûê
                        if (ocrText && ocrText.trim().length > 0) {
                            prompt = `ËØ∑‰ªîÁªÜÂàÜÊûê‰ª•‰∏ãÈÄöËøáOCRËØÜÂà´ÁöÑÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫ÁªìÊûÑÂåñ‰ø°ÊÅØÔºö

${ocrText}

ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËæìÂá∫Ôºö
„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞Ôºö
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºö
- ËØæÊó∂ÂÆâÊéíÔºö
- ÊïôÂ≠¶ÁõÆÊ†áÔºö

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºö
- ÊïôÂ≠¶ÈáçÁÇπÔºö
- ÊïôÂ≠¶ÈöæÁÇπÔºö
- ÊïôÂ≠¶ÊñπÊ≥ïÔºö

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºö
- Êñ∞ÊéàÁéØËäÇÔºö
- ÁªÉ‰π†ÁéØËäÇÔºö
- ÊÄªÁªìÁéØËäÇÔºö

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑Ôºö
- Â≠¶‰π†ÊùêÊñôÔºö
- ËØÑ‰ª∑ÊñπÂºèÔºö

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºö
- ÂÜÖÂÆπ‰ºòÂåñÔºö
- ÊñπÊ≥ï‰ºòÂåñÔºö`;

                            messages = [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ];
                        } else {
                            // OCRËØÜÂà´Â§±Ë¥•ÊàñÊó†ÂÜÖÂÆπÔºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPI
                            throw new Error('OCRËØÜÂà´Êó†ÊúâÊïàÂÜÖÂÆπ');
                        }
                    } catch (ocrError) {
                        console.warn('OCRÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Â§öÊ®°ÊÄÅAPI:', ocrError);
                        const base64Content = await fileToBase64(file);
                        prompt = 'ËØ∑‰ªîÁªÜÂàÜÊûêËøôÂº†ÂõæÁâá‰∏≠ÁöÑÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫‰ª•‰∏ã‰ø°ÊÅØÔºö\n\n1. ÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØÔºàËØæÁ®ãÂêçÁß∞„ÄÅÂπ¥Á∫ß„ÄÅËØæÊó∂Á≠âÔºâ\n2. ÊïôÂ≠¶ÁõÆÊ†á\n3. ÊïôÂ≠¶ÈáçÁÇπÂíåÈöæÁÇπ\n4. ÊïôÂ≠¶ÊµÅÁ®ãÔºàÂØºÂÖ•„ÄÅÊñ∞Êéà„ÄÅÁªÉ‰π†„ÄÅÊÄªÁªìÁ≠âÁéØËäÇÔºâ\n5. ÊïôÂ≠¶ÊñπÊ≥ïÂíåÊ¥ªÂä®ËÆæËÆ°\n6. ÊïôÂ≠¶ËµÑÊ∫ê\n7. ËØÑ‰ª∑ÊñπÂºè\n8. ÂÖ∂‰ªñÈáçË¶Å‰ø°ÊÅØ\n\nËØ∑ÊåâÁÖßÁªìÊûÑÂåñÊ†ºÂºèËæìÂá∫ÔºåÁ°Æ‰øù‰ø°ÊÅØÂÆåÊï¥ÂáÜÁ°Æ„ÄÇ';

                        messages = [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: prompt
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:image/${fileExtension.slice(1)};base64,${base64Content}`
                                        }
                                    }
                                ]
                            }
                        ];
                    }
                } else if (['.pdf'].includes(fileExtension)) {
                    // PDFÊñá‰ª∂ - ÂÖàÂ∞ùËØïÊñáÊú¨ÊèêÂèñÔºåÂ¶ÇÊûúÂ§±Ë¥•‰ΩøÁî®Â§öÊ®°ÊÄÅAPI
                    try {
                        // ÂÖàÂ∞ùËØïÊñáÊú¨ÊèêÂèñ
                        const textContent = await extractPdfText(file);
                        console.log('PDFÊñáÊú¨ÊèêÂèñÊàêÂäüÔºåÈïøÂ∫¶:', textContent.length);

                        // Â¶ÇÊûúÊñáÊú¨ÊèêÂèñÊúâÂÜÖÂÆπÔºåÁî®ÊñáÊú¨Ëß£Êûê
                        if (textContent && textContent.trim().length > 0) {
                            prompt = `ËØ∑‰ªîÁªÜÂàÜÊûê‰ª•‰∏ãPDFÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫ÁªìÊûÑÂåñ‰ø°ÊÅØÔºö

${textContent}

ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËæìÂá∫Ôºö
„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞Ôºö
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºö
- ËØæÊó∂ÂÆâÊéíÔºö
- ÊïôÂ≠¶ÁõÆÊ†áÔºö

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºö
- ÊïôÂ≠¶ÈáçÁÇπÔºö
- ÊïôÂ≠¶ÈöæÁÇπÔºö
- ÊïôÂ≠¶ÊñπÊ≥ïÔºö

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºö
- Êñ∞ÊéàÁéØËäÇÔºö
- ÁªÉ‰π†ÁéØËäÇÔºö
- ÊÄªÁªìÁéØËäÇÔºö

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑Ôºö
- Â≠¶‰π†ÊùêÊñôÔºö
- ËØÑ‰ª∑ÊñπÂºèÔºö

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºö
- ÂÜÖÂÆπ‰ºòÂåñÔºö
- ÊñπÊ≥ï‰ºòÂåñÔºö`;

                            messages = [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ];
                        } else {
                            throw new Error('PDFÊñáÊú¨ÊèêÂèñÊó†ÊúâÊïàÂÜÖÂÆπ');
                        }
                    } catch (textError) {
                        console.warn('PDFÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPI:', textError);
                        // ÈôçÁ∫ßÂà∞Â§öÊ®°ÊÄÅAPI
                        const base64Content = await fileToBase64(file);
                        prompt = 'ËØ∑‰ªîÁªÜÂàÜÊûêËøô‰∏™PDFÊñáÊ°£‰∏≠ÁöÑÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫‰ª•‰∏ã‰ø°ÊÅØÔºö\n\n1. ÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØÔºàËØæÁ®ãÂêçÁß∞„ÄÅÂπ¥Á∫ß„ÄÅËØæÊó∂Á≠âÔºâ\n2. ÊïôÂ≠¶ÁõÆÊ†á\n3. ÊïôÂ≠¶ÈáçÁÇπÂíåÈöæÁÇπ\n4. ÊïôÂ≠¶ÊµÅÁ®ãÔºàÂØºÂÖ•„ÄÅÊñ∞Êéà„ÄÅÁªÉ‰π†„ÄÅÊÄªÁªìÁ≠âÁéØËäÇÔºâ\n5. ÊïôÂ≠¶ÊñπÊ≥ïÂíåÊ¥ªÂä®ËÆæËÆ°\n6. ÊïôÂ≠¶ËµÑÊ∫ê\n7. ËØÑ‰ª∑ÊñπÂºè\n8. ÂÖ∂‰ªñÈáçË¶Å‰ø°ÊÅØ\n\nËØ∑ÊåâÁÖßÁªìÊûÑÂåñÊ†ºÂºèËæìÂá∫ÔºåÁ°Æ‰øù‰ø°ÊÅØÂÆåÊï¥ÂáÜÁ°Æ„ÄÇ';

                        messages = [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: prompt
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:application/pdf;base64,${base64Content}`
                                        }
                                    }
                                ]
                            }
                        ];
                    }
                } else if (['.docx', '.doc', '.rtf'].includes(fileExtension)) {
                    // WordÊñáÊ°£ - ÂÖàÂ∞ùËØïÊñáÊú¨ÊèêÂèñÔºåÂ¶ÇÊûúÂ§±Ë¥•‰ΩøÁî®Â§öÊ®°ÊÄÅAPI
                    try {
                        // ÂÖàÂ∞ùËØïÊñáÊú¨ÊèêÂèñ
                        const textContent = await extractWordText(file);
                        console.log('WordÊñáÊú¨ÊèêÂèñÊàêÂäüÔºåÈïøÂ∫¶:', textContent.length);

                        // Ê£ÄÊü•ÊòØÂê¶ÊòØËΩ¨Êç¢ÊèêÁ§∫‰ø°ÊÅØÔºàË°®Á§∫ÊèêÂèñÂ§±Ë¥•Ôºâ
                        if (textContent && textContent.includes('ËΩ¨Êç¢ÊèêÁ§∫') && textContent.includes('Âª∫ËÆÆËß£ÂÜ≥ÊñπÊ°à')) {
                            console.log('WordÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPIÂ§áÈÄâÊñπÊ°à');
                            throw new Error('ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅÂ§áÈÄâ');
                        }

                        // Â¶ÇÊûúÊñáÊú¨ÊèêÂèñÊúâÂÜÖÂÆπÔºåÁî®ÊñáÊú¨Ëß£Êûê
                        if (textContent && textContent.trim().length > 0) {
                            prompt = `ËØ∑‰ªîÁªÜÂàÜÊûê‰ª•‰∏ãWordÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫ÁªìÊûÑÂåñ‰ø°ÊÅØÔºö

${textContent}

ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËæìÂá∫Ôºö
„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞Ôºö
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºö
- ËØæÊó∂ÂÆâÊéíÔºö
- ÊïôÂ≠¶ÁõÆÊ†áÔºö

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºö
- ÊïôÂ≠¶ÈáçÁÇπÔºö
- ÊïôÂ≠¶ÈöæÁÇπÔºö
- ÊïôÂ≠¶ÊñπÊ≥ïÔºö

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºö
- Êñ∞ÊéàÁéØËäÇÔºö
- ÁªÉ‰π†ÁéØËäÇÔºö
- ÊÄªÁªìÁéØËäÇÔºö

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑Ôºö
- Â≠¶‰π†ÊùêÊñôÔºö
- ËØÑ‰ª∑ÊñπÂºèÔºö

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºö
- ÂÜÖÂÆπ‰ºòÂåñÔºö
- ÊñπÊ≥ï‰ºòÂåñÔºö`;

                            messages = [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ];
                        } else {
                            throw new Error('WordÊñáÊú¨ÊèêÂèñÊó†ÊúâÊïàÂÜÖÂÆπ');
                        }
                    } catch (textError) {
                        console.warn('WordÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPI:', textError);
                        // ÈôçÁ∫ßÂà∞Â§öÊ®°ÊÄÅAPI
                        const base64Content = await fileToBase64(file);
                        prompt = 'ËØ∑‰ªîÁªÜÂàÜÊûêËøô‰∏™WordÊñáÊ°£‰∏≠ÁöÑÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫‰ª•‰∏ã‰ø°ÊÅØÔºö\n\n1. ÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØÔºàËØæÁ®ãÂêçÁß∞„ÄÅÂπ¥Á∫ß„ÄÅËØæÊó∂Á≠âÔºâ\n2. ÊïôÂ≠¶ÁõÆÊ†á\n3. ÊïôÂ≠¶ÈáçÁÇπÂíåÈöæÁÇπ\n4. ÊïôÂ≠¶ÊµÅÁ®ãÔºàÂØºÂÖ•„ÄÅÊñ∞Êéà„ÄÅÁªÉ‰π†„ÄÅÊÄªÁªìÁ≠âÁéØËäÇÔºâ\n5. ÊïôÂ≠¶ÊñπÊ≥ïÂíåÊ¥ªÂä®ËÆæËÆ°\n6. ÊïôÂ≠¶ËµÑÊ∫ê\n7. ËØÑ‰ª∑ÊñπÂºè\n8. ÂÖ∂‰ªñÈáçË¶Å‰ø°ÊÅØ\n\nËØ∑ÊåâÁÖßÁªìÊûÑÂåñÊ†ºÂºèËæìÂá∫ÔºåÁ°Æ‰øù‰ø°ÊÅØÂÆåÊï¥ÂáÜÁ°Æ„ÄÇ';

                        messages = [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: prompt
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,${base64Content}`
                                        }
                                    }
                                ]
                            }
                        ];
                    }
                } else if (['.ppt', '.pptx'].includes(fileExtension)) {
                    // PowerPointÊñáÊ°£ - ÂÖàÂ∞ùËØïÊñáÊú¨ÊèêÂèñÔºåÂ¶ÇÊûúÂ§±Ë¥•‰ΩøÁî®Â§öÊ®°ÊÄÅAPI
                    try {
                        // ÂÖàÂ∞ùËØïÊñáÊú¨ÊèêÂèñ
                        const textContent = await extractPptText(file);
                        console.log('PPTÊñáÊú¨ÊèêÂèñÊàêÂäüÔºåÈïøÂ∫¶:', textContent.length);

                        // Ê£ÄÊü•ÊòØÂê¶ÊòØËΩ¨Êç¢ÊèêÁ§∫‰ø°ÊÅØÔºàË°®Á§∫ÊèêÂèñÂ§±Ë¥•Ôºâ
                        if (textContent && textContent.includes('ËΩ¨Êç¢ÊèêÁ§∫') && textContent.includes('Âª∫ËÆÆËß£ÂÜ≥ÊñπÊ°à')) {
                            console.log('PPTÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPIÂ§áÈÄâÊñπÊ°à');
                            throw new Error('ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅÂ§áÈÄâ');
                        }

                        // Â¶ÇÊûúÊñáÊú¨ÊèêÂèñÊúâÂÜÖÂÆπÔºåÁî®ÊñáÊú¨Ëß£Êûê
                        if (textContent && textContent.trim().length > 0) {
                            prompt = `ËØ∑‰ªîÁªÜÂàÜÊûê‰ª•‰∏ãPPTÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫ÁªìÊûÑÂåñ‰ø°ÊÅØÔºö

${textContent}

ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËæìÂá∫Ôºö
„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞Ôºö
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºö
- ËØæÊó∂ÂÆâÊéíÔºö
- ÊïôÂ≠¶ÁõÆÊ†áÔºö

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºö
- ÊïôÂ≠¶ÈáçÁÇπÔºö
- ÊïôÂ≠¶ÈöæÁÇπÔºö
- ÊïôÂ≠¶ÊñπÊ≥ïÔºö

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºö
- Êñ∞ÊéàÁéØËäÇÔºö
- ÁªÉ‰π†ÁéØËäÇÔºö
- ÊÄªÁªìÁéØËäÇÔºö

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑Ôºö
- Â≠¶‰π†ÊùêÊñôÔºö
- ËØÑ‰ª∑ÊñπÂºèÔºö

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºö
- ÂÜÖÂÆπ‰ºòÂåñÔºö
- ÊñπÊ≥ï‰ºòÂåñÔºö`;

                            messages = [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ];
                        } else {
                            throw new Error('PPTÊñáÊú¨ÊèêÂèñÊó†ÊúâÊïàÂÜÖÂÆπ');
                        }
                    } catch (textError) {
                        console.warn('PPTÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPI:', textError);
                        // ÈôçÁ∫ßÂà∞Â§öÊ®°ÊÄÅAPI
                        const base64Content = await fileToBase64(file);
                        prompt = 'ËØ∑‰ªîÁªÜÂàÜÊûêËøô‰∏™PPTÊñáÊ°£‰∏≠ÁöÑÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫‰ª•‰∏ã‰ø°ÊÅØÔºö\n\n1. ÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØÔºàËØæÁ®ãÂêçÁß∞„ÄÅÂπ¥Á∫ß„ÄÅËØæÊó∂Á≠âÔºâ\n2. ÊïôÂ≠¶ÁõÆÊ†á\n3. ÊïôÂ≠¶ÈáçÁÇπÂíåÈöæÁÇπ\n4. ÊïôÂ≠¶ÊµÅÁ®ãÔºàÂØºÂÖ•„ÄÅÊñ∞Êéà„ÄÅÁªÉ‰π†„ÄÅÊÄªÁªìÁ≠âÁéØËäÇÔºâ\n5. ÊïôÂ≠¶ÊñπÊ≥ïÂíåÊ¥ªÂä®ËÆæËÆ°\n6. ÊïôÂ≠¶ËµÑÊ∫ê\n7. ËØÑ‰ª∑ÊñπÂºè\n8. ÂÖ∂‰ªñÈáçË¶Å‰ø°ÊÅØ\n\nËØ∑ÊåâÁÖßÁªìÊûÑÂåñÊ†ºÂºèËæìÂá∫ÔºåÁ°Æ‰øù‰ø°ÊÅØÂÆåÊï¥ÂáÜÁ°Æ„ÄÇ';

                        messages = [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: prompt
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:application/vnd.openxmlformats-officedocument.presentationml.presentation;base64,${base64Content}`
                                        }
                                    }
                                ]
                            }
                        ];
                    }
                } else {
                    // Á∫ØÊñáÊú¨Êñá‰ª∂
                    try {
                        const textContent = await fileToText(file);

                        if (textContent && textContent.trim().length > 0) {
                            prompt = `ËØ∑‰ªîÁªÜÂàÜÊûê‰ª•‰∏ãÊïôÊ°àÂÜÖÂÆπÔºåÊèêÂèñÂπ∂Êï¥ÁêÜÂá∫ÁªìÊûÑÂåñ‰ø°ÊÅØÔºö

${textContent}

ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËæìÂá∫Ôºö
„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞Ôºö
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºö
- ËØæÊó∂ÂÆâÊéíÔºö
- ÊïôÂ≠¶ÁõÆÊ†áÔºö

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºö
- ÊïôÂ≠¶ÈáçÁÇπÔºö
- ÊïôÂ≠¶ÈöæÁÇπÔºö
- ÊïôÂ≠¶ÊñπÊ≥ïÔºö

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºö
- Êñ∞ÊéàÁéØËäÇÔºö
- ÁªÉ‰π†ÁéØËäÇÔºö
- ÊÄªÁªìÁéØËäÇÔºö

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑Ôºö
- Â≠¶‰π†ÊùêÊñôÔºö
- ËØÑ‰ª∑ÊñπÂºèÔºö

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºö
- ÂÜÖÂÆπ‰ºòÂåñÔºö
- ÊñπÊ≥ï‰ºòÂåñÔºö`;

                            messages = [
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ];
                        } else {
                            throw new Error('Á∫ØÊñáÊú¨Êñá‰ª∂Êó†ÊúâÊïàÂÜÖÂÆπ');
                        }
                    } catch (error) {
                        console.warn('ÊñáÊú¨Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÈÄöÁî®Â§áÈÄâÊñπÊ°à:', error);
                        // ÈÄöÁî®Â§áÈÄâÊñπÊ°àÔºöÂ∞ùËØïÂ§öÊ®°ÊÄÅAPIÂ§ÑÁêÜ
                        const base64Content = await fileToBase64(file);
                        prompt = 'ËøôÊòØ‰∏Ä‰∏™ÊñáÊú¨Êñá‰ª∂„ÄÇËØ∑Â∞ùËØï‰ªé‰∏≠ÊèêÂèñÊïôÊ°àÂÜÖÂÆπÂπ∂ËøõË°åÂàÜÊûê„ÄÇ';

                        messages = [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: prompt
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:text/plain;base64,${base64Content}`
                                        }
                                    }
                                ]
                            }
                        ];
                    }
                }

                // Ê∑ªÂä†Ë∂ÖÊó∂Êú∫Âà∂ÁöÑfetchËØ∑Ê±Ç
                const fetchPromise = fetch(API_CONFIG.parser.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.parser.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.parser.model,
                        messages: messages,
                        temperature: 0.3
                    })
                });

                // Ê∑ªÂä†Ë∂ÖÊó∂Êú∫Âà∂
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('APIËØ∑Ê±ÇË∂ÖÊó∂')), 120000); // 120ÁßíË∂ÖÊó∂
                });

                const response = await Promise.race([fetchPromise, timeoutPromise]);

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }

                const parsedContent = data.choices[0].message.content.trim();

                console.log('Â§öÊ®°ÊÄÅAIËß£ÊûêÂÆåÊàêÔºåÂÜÖÂÆπÈïøÂ∫¶:', parsedContent.length);
                return convertToTraditionalChinese(parsedContent);
                
            } catch (error) {
                console.error('Â§öÊ®°ÊÄÅËß£ÊûêAPIË∞ÉÁî®Â§±Ë¥•:', error);
                return null;
            }
        }

        // Êñá‰ª∂ËΩ¨base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Êñá‰ª∂ËΩ¨ÊñáÊú¨
        function fileToText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Êñá‰ª∂ËΩ¨ArrayBuffer
        function fileToArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ‰ªéWordÊñáÊ°£ÊèêÂèñÊñáÊú¨ÔºàÁúüÂÆûÂÆûÁé∞Ôºâ
        async function extractTextFromWord(arrayBuffer) {
            try {
                console.log('WordÊñáÊ°£ArrayBufferÂ§ßÂ∞è:', arrayBuffer.byteLength);

                // ‰ΩøÁî®mammoth.jsÂ∫ìÊèêÂèñWordÊñáÊ°£ÊñáÊú¨
                if (typeof mammoth !== 'undefined') {
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    console.log('WordÊñáÊ°£ÊñáÊú¨ÊèêÂèñÊàêÂäüÔºåÈïøÂ∫¶:', result.value.length);
                    return result.value;
                } else {
                    throw new Error('mammoth.jsÂ∫ìÊú™Âä†ËΩΩ');
                }
            } catch (error) {
                console.error('WordÊñáÊ°£ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÁõ¥Êé•ÊèêÂèñÂ§±Ë¥•ÔºåÂ∞ùËØïËΩ¨Êç¢‰∏∫PDFÂÜçÊèêÂèñ
                console.log('Â∞ùËØïËΩ¨Êç¢‰∏∫PDFÊ†ºÂºèÂÜçÊèêÂèñ...');
                return await convertToPdfAndExtract(arrayBuffer, 'word');
            }
        }

        // ‰ªéPDFÊñáÊ°£ÊèêÂèñÊñáÊú¨ÔºàÁúüÂÆûÂÆûÁé∞Ôºâ
        async function extractTextFromPdf(arrayBuffer) {
            try {
                console.log('PDFÊñáÊ°£ArrayBufferÂ§ßÂ∞è:', arrayBuffer.byteLength);

                // ‰ΩøÁî®pdf.jsÂ∫ìÊèêÂèñPDFÊñáÊ°£ÊñáÊú¨
                if (typeof pdfjsLib !== 'undefined') {
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let text = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        text += pageText + '\n';
                    }

                    console.log('PDFÊñáÊ°£ÊñáÊú¨ÊèêÂèñÊàêÂäüÔºåÈïøÂ∫¶:', text.length);
                    return text;
                } else {
                    throw new Error('pdf.jsÂ∫ìÊú™Âä†ËΩΩ');
                }
            } catch (error) {
                console.error('PDFÊñáÊ°£ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•:', error);
                throw error;
            }
        }

        // ÈÄöÁî®ÊñáÊ°£ËΩ¨PDFÂπ∂ÊèêÂèñÊñáÊú¨
        async function convertToPdfAndExtract(arrayBuffer, sourceType) {
            try {
                console.log(`${sourceType}ÊñáÊ°£ËΩ¨Êç¢‰∏≠...`);

                // Âú®ÊµèËßàÂô®ÁéØÂ¢É‰∏≠ÔºåÊàë‰ª¨Êó†Ê≥ïÁõ¥Êé•ËΩ¨Êç¢ÊñáÊ°£Ê†ºÂºè
                // ËøôÈáåÊèê‰æõ‰∏Ä‰∏™Ê®°ÊãüÁöÑËΩ¨Êç¢ÊèêÁ§∫
                const fileSizeMB = (arrayBuffer.byteLength / 1024 / 1024).toFixed(2);

                return `${sourceType.toUpperCase()}ÊñáÊ°£ËΩ¨Êç¢ÊèêÁ§∫Ôºö

Êñá‰ª∂Â§ßÂ∞èÔºö${fileSizeMB} MB

Áî±‰∫éÊµèËßàÂô®ÁéØÂ¢ÉÁöÑÈôêÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•Â∞Ü${sourceType.toUpperCase()}ÊñáÊ°£ËΩ¨Êç¢‰∏∫PDFÊ†ºÂºè„ÄÇ

Âª∫ËÆÆËß£ÂÜ≥ÊñπÊ°àÔºö
1. ‰ΩøÁî®Âú®Á∫øËΩ¨Êç¢Â∑•ÂÖ∑Â∞Ü${sourceType.toUpperCase()}Êñá‰ª∂ËΩ¨Êç¢‰∏∫PDFÊ†ºÂºè
2. ÊàñËÄÖÂ∞ÜÊñáÊ°£ÂÜÖÂÆπÂ§çÂà∂‰∏∫Á∫ØÊñáÊú¨Ê†ºÂºè
3. ÊàñËÄÖÊà™Âõæ‰øùÂ≠ò‰∏∫ÂõæÁâáÊ†ºÂºè

ËΩ¨Êç¢ÂêéËØ∑ÈáçÊñ∞‰∏ä‰º†Êñá‰ª∂ËøõË°åÂàÜÊûê„ÄÇ

Â¶ÇÊûúÊÇ®ÂùöÊåÅË¶ÅÂàÜÊûêÊ≠§Êñá‰ª∂ÔºåÂèØ‰ª•Â∞ùËØïÔºö
- Áõ¥Êé•‰ΩøÁî®Â§öÊ®°ÊÄÅAIËøõË°åËØÜÂà´ÔºàÂèØËÉΩÊïàÊûú‰∏ç‰Ω≥Ôºâ
- ÊâãÂä®ÊèêÂèñÂÖ≥ÈîÆÂÜÖÂÆπÂêéÈáçÊñ∞‰∏ä‰º†`;
            } catch (error) {
                console.error('ÊñáÊ°£ËΩ¨Êç¢Â§±Ë¥•:', error);
                throw error;
            }
        }

        // OCRËØÜÂà´ÂõæÁâáÊñáÂ≠óÔºà‰ΩøÁî®Tesseract.jsÔºâ
        async function ocrImage(file) {
            try {
                console.log('ÂºÄÂßãOCRËØÜÂà´ÂõæÁâá:', file.name);

                // Ê£ÄÊü•TesseractÂ∫ìÊòØÂê¶ÂèØÁî®
                if (typeof Tesseract === 'undefined') {
                    console.error('Tesseract.jsÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËøõË°åOCRËØÜÂà´');
                    throw new Error('Tesseract.jsÂ∫ìÊú™Âä†ËΩΩ');
                }

                // Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫base64
                const base64 = await fileToBase64(file);

                console.log('ÂºÄÂßãTesseract OCRËØÜÂà´...');

                // ‰ΩøÁî®Tesseract.jsËøõË°åOCRËØÜÂà´ÔºåÊ∑ªÂä†Ë∂ÖÊó∂
                const ocrPromise = Tesseract.recognize(
                    base64,
                    'chi_sim+eng', // ‰∏≠ÊñáÁÆÄ‰Ωì+Ëã±Êñá
                    {
                        logger: m => console.log('OCRËøõÂ∫¶:', m)
                    }
                );

                // Ê∑ªÂä†Ë∂ÖÊó∂Êú∫Âà∂
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('OCRËØÜÂà´Ë∂ÖÊó∂')), 30000); // 30ÁßíË∂ÖÊó∂
                });

                const { data: { text } } = await Promise.race([ocrPromise, timeoutPromise]);

                console.log('OCRËØÜÂà´ÂÆåÊàêÔºåÊñáÊú¨ÈïøÂ∫¶:', text.length);
                return text;
            } catch (error) {
                console.error('OCRËØÜÂà´Â§±Ë¥•:', error);
                throw error;
            }
        }

        // Âø´ÈÄüOCRËØÜÂà´ÔºàÁî®‰∫éÊñáÊ°£È¢ÑËßàÔºâ
        async function quickOcr(file) {
            try {
                console.log('Âø´ÈÄüOCRËØÜÂà´:', file.name);

                // Ê£ÄÊü•TesseractÂ∫ìÊòØÂê¶ÂèØÁî®
                if (typeof Tesseract === 'undefined') {
                    console.warn('Tesseract.jsÂ∫ìÊú™Âä†ËΩΩÔºåË∑≥ËøáÂø´ÈÄüOCR');
                    return null;
                }

                const base64 = await fileToBase64(file);

                // ‰ΩøÁî®‰ΩéÁ≤æÂ∫¶Âø´ÈÄüËØÜÂà´ÔºåÊ∑ªÂä†Ë∂ÖÊó∂
                const ocrPromise = Tesseract.recognize(
                    base64,
                    'chi_sim+eng',
                    {
                        logger: m => console.log('Âø´ÈÄüOCRËøõÂ∫¶:', m),
                        tessedit_pageseg_mode: '6', // Áªü‰∏ÄÂùóÊñáÂ≠ó
                        tessedit_ocr_engine_mode: '1' // LSTM only
                    }
                );

                // Ê∑ªÂä†Ë∂ÖÊó∂Êú∫Âà∂
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Âø´ÈÄüOCRË∂ÖÊó∂')), 15000); // 15ÁßíË∂ÖÊó∂
                });

                const { data: { text } } = await Promise.race([ocrPromise, timeoutPromise]);

                console.log('Âø´ÈÄüOCRÂÆåÊàêÔºåÊñáÊú¨ÈïøÂ∫¶:', text.length);

                // Âú®È¢ÑËßàÂå∫ÂüüÊòæÁ§∫OCRÁªìÊûú
                const preview = document.getElementById('filePreview');
                if (preview && text.trim().length > 0) {
                    const ocrPreview = document.createElement('div');
                    ocrPreview.className = 'ocr-preview';
                    ocrPreview.innerHTML = `
                        <div class="ocr-header">
                            <i class="fas fa-search"></i>
                            <span>OCRËØÜÂà´È¢ÑËßà</span>
                        </div>
                        <div class="ocr-content">
                            ${text.substring(0, 300)}${text.length > 300 ? '...' : ''}
                        </div>
                    `;
                    preview.appendChild(ocrPreview);
                }

                return text;
            } catch (error) {
                console.warn('Âø´ÈÄüOCRÂ§±Ë¥•:', error);
                return null;
            }
        }

        // ÊèêÂèñWordÊñáÊ°£ÊñáÊú¨ÂÜÖÂÆπ
        async function extractWordText(file) {
            try {
                console.log('ÂºÄÂßãÊèêÂèñWordÊñáÊ°£ÊñáÊú¨...');
                
                // Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫ArrayBuffer
                const arrayBuffer = await fileToArrayBuffer(file);
                
                // ‰ΩøÁî®mammoth.jsÊèêÂèñÊñáÊú¨ÔºàÈúÄË¶ÅÂºïÂÖ•mammoth.jsÂ∫ìÔºâ
                // ËøôÈáåÊèê‰æõ‰∏Ä‰∏™ÁÆÄÂåñÁöÑÂÆûÁé∞ÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠ÈúÄË¶ÅÂºïÂÖ•mammoth.js
                const textContent = await extractTextFromWord(arrayBuffer);
                
                return textContent;
            } catch (error) {
                console.error('WordÊñáÊ°£ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊèêÂèñÂ§±Ë¥•ÔºåËøîÂõûÊñá‰ª∂Âü∫Êú¨‰ø°ÊÅØ
                return `WordÊñáÊ°£Ôºö${file.name}\nÊñá‰ª∂Â§ßÂ∞èÔºö${(file.size / 1024).toFixed(2)} KB\n\nÁî±‰∫éÊµèËßàÂô®ÁéØÂ¢ÉÈôêÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•ÊèêÂèñWordÊñáÊ°£ÂÜÖÂÆπ„ÄÇÂª∫ËÆÆÂ∞ÜÊñáÊ°£ËΩ¨Êç¢‰∏∫ÊñáÊú¨Ê†ºÂºèÂêéÈáçÊñ∞‰∏ä‰º†„ÄÇ`;
            }
        }

        // ÊèêÂèñPDFÊñáÊ°£ÊñáÊú¨ÂÜÖÂÆπ
        async function extractPdfText(file) {
            try {
                console.log('ÂºÄÂßãÊèêÂèñPDFÊñáÊ°£ÊñáÊú¨...');
                
                // Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫ArrayBuffer
                const arrayBuffer = await fileToArrayBuffer(file);
                
                // ‰ΩøÁî®pdf.jsÊèêÂèñÊñáÊú¨ÔºàÈúÄË¶ÅÂºïÂÖ•pdf.jsÂ∫ìÔºâ
                // ËøôÈáåÊèê‰æõ‰∏Ä‰∏™ÁÆÄÂåñÁöÑÂÆûÁé∞ÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠ÈúÄË¶ÅÂºïÂÖ•pdf.js
                const textContent = await extractTextFromPdf(arrayBuffer);
                
                return textContent;
            } catch (error) {
                console.error('PDFÊñáÊ°£ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊèêÂèñÂ§±Ë¥•ÔºåËøîÂõûÊñá‰ª∂Âü∫Êú¨‰ø°ÊÅØ
                return `PDFÊñáÊ°£Ôºö${file.name}\nÊñá‰ª∂Â§ßÂ∞èÔºö${(file.size / 1024).toFixed(2)} KB\n\nÁî±‰∫éÊµèËßàÂô®ÁéØÂ¢ÉÈôêÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•ÊèêÂèñPDFÊñáÊ°£ÂÜÖÂÆπ„ÄÇÂª∫ËÆÆÂ∞ÜÊñáÊ°£ËΩ¨Êç¢‰∏∫ÊñáÊú¨Ê†ºÂºèÂêéÈáçÊñ∞‰∏ä‰º†„ÄÇ`;
            }
        }

        // ÊèêÂèñPowerPointÊñáÊ°£ÊñáÊú¨ÂÜÖÂÆπ
        async function extractPptText(file) {
            try {
                console.log('ÂºÄÂßãÊèêÂèñPPTÊñáÊ°£ÊñáÊú¨...');
                
                // Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫ArrayBuffer
                const arrayBuffer = await fileToArrayBuffer(file);
                
                // ‰ΩøÁî®mammoth.jsÊèêÂèñPPTÊñáÊú¨ÔºàÈúÄË¶ÅÂºïÂÖ•mammoth.jsÂ∫ìÔºâ
                // ËøôÈáåÊèê‰æõ‰∏Ä‰∏™ÁÆÄÂåñÁöÑÂÆûÁé∞ÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠ÈúÄË¶ÅÂºïÂÖ•mammoth.js
                const textContent = await extractTextFromPpt(arrayBuffer);
                
                return textContent;
            } catch (error) {
                console.error('PPTÊñáÊ°£ÊñáÊú¨ÊèêÂèñÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊèêÂèñÂ§±Ë¥•ÔºåËøîÂõûÊñá‰ª∂Âü∫Êú¨‰ø°ÊÅØ
                return `PPTÊñáÊ°£Ôºö${file.name}\nÊñá‰ª∂Â§ßÂ∞èÔºö${(file.size / 1024).toFixed(2)} KB\n\nÁî±‰∫éÊµèËßàÂô®ÁéØÂ¢ÉÈôêÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•ÊèêÂèñPPTÊñáÊ°£ÂÜÖÂÆπ„ÄÇÂª∫ËÆÆÂ∞ÜÊñáÊ°£ËΩ¨Êç¢‰∏∫ÊñáÊú¨Ê†ºÂºèÂêéÈáçÊñ∞‰∏ä‰º†„ÄÇ`;
            }
        }

        // ËØªÂèñÊñáÊú¨Êñá‰ª∂Ôºà‰øùÁïô‰Ωú‰∏∫Â§áÁî®Ôºâ
        function readTextFile(file) {
            console.log('ÂºÄÂßãËØªÂèñÊñáÊú¨Êñá‰ª∂:', file.name);
            const reader = new FileReader();

            reader.onload = function(e) {
                fileContent = e.target.result;
                console.log('ÊñáÊú¨Êñá‰ª∂ËØªÂèñÂÆåÊàêÔºåÈïøÂ∫¶:', fileContent.length);

                // ÊòæÁ§∫Êñá‰ª∂È¢ÑËßà
                const preview = document.getElementById('filePreview');
                const contentElement = document.getElementById('fileContent');

                // Ê∏ÖÁêÜÂíåÊ†ºÂºèÂåñÂÜÖÂÆπ
                const cleanedContent = cleanTextContent(fileContent);

                // ÈôêÂà∂È¢ÑËßàÈïøÂ∫¶
                const previewContent = cleanedContent.length > 1000
                    ? cleanedContent.substring(0, 1000) + '\n\n...(ÂÜÖÂÆπÂ∑≤Êà™Êñ≠ÔºåÂÆåÊï¥ÂÜÖÂÆπÂ∞ÜÁî®‰∫éÂàÜÊûê)'
                    : cleanedContent;

                contentElement.textContent = previewContent;
                preview.style.display = 'block';

                console.log('Êñá‰ª∂È¢ÑËßàÊòæÁ§∫ÂÆåÊàêÔºåÂºÄÂßãËß£Êûê...');

                // ÂºÄÂßãÊïôÊ°àËß£Êûê
                setTimeout(() => {
                    parseLessonPlan();
                }, 1000);
            };

            reader.onerror = function() {
                console.error('ÊñáÊú¨Êñá‰ª∂ËØªÂèñÂ§±Ë¥•:', reader.error);
                showMessage('ÊñáÊú¨Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºÅËØ∑Á°Æ‰øùÊñá‰ª∂Ê†ºÂºèÊ≠£Á°Æ‰∏îÊñá‰ª∂Êú™ÊçüÂùè„ÄÇ', 'error');
            };

            // ‰ºòÂÖà‰ΩøÁî®UTF-8ÁºñÁ†ÅÔºåÂ¶ÇÊûúÂ§±Ë¥•Â∞ùËØïGBK
            try {
                reader.readAsText(file, 'utf-8');
            } catch (error) {
                // Â¶ÇÊûúUTF-8Â§±Ë¥•ÔºåÂ∞ùËØïGBKÔºàÊüê‰∫õÊµèËßàÂô®ÂèØËÉΩ‰∏çÊîØÊåÅÔºâ
                try {
                    reader.readAsText(file, 'gbk');
                } catch (gbkError) {
                    console.error('ÁºñÁ†ÅËØªÂèñÂ§±Ë¥•ÔºåÂ∞ùËØïÈªòËÆ§ÁºñÁ†Å');
                    reader.readAsText(file);
                }
            }
        }

        // ÊóßÁöÑÊñá‰ª∂Â§ÑÁêÜÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®Â§öÊ®°ÊÄÅAIÁªü‰∏ÄÂ§ÑÁêÜ

        // ÊóßÁöÑÊñá‰ª∂Â§ÑÁêÜÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®Â§öÊ®°ÊÄÅAIÁªü‰∏ÄÂ§ÑÁêÜ

        // ÊóßÁöÑÊñá‰ª∂Â§ÑÁêÜÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®Â§öÊ®°ÊÄÅAIÁªü‰∏ÄÂ§ÑÁêÜ

        // Ê∏ÖÁêÜÊñáÊú¨ÂÜÖÂÆπ
        function cleanTextContent(text) {
            return text
                .replace(/\uFFFD/g, '') // ÁßªÈô§UnicodeÊõøÊç¢Â≠óÁ¨¶
                .replace(/\r\n/g, '\n') // Áªü‰∏ÄÊç¢Ë°åÁ¨¶
                .replace(/\r/g, '\n') // Áªü‰∏ÄÊç¢Ë°åÁ¨¶
                .replace(/\n{3,}/g, '\n\n') // ÈôêÂà∂ËøûÁª≠Êç¢Ë°å
                .replace(/\s{2,}/g, ' ') // ÈôêÂà∂ËøûÁª≠Á©∫Ê†º
                .trim();
        }

        // ÊïôÊ°àËß£ÊûêAIËß£ÊûêÊïôÊ°àÂÜÖÂÆπ
        async function parseLessonPlan() {
            console.log('ÂºÄÂßãËß£ÊûêÊïôÊ°àÔºåÊñá‰ª∂ÈïøÂ∫¶:', fileContent.length);
            showMessage('ü§ñ ÊïôÊ°àËß£ÊûêAIÊ≠£Âú®Ëß£ÊûêÊïôÊ°àÂÜÖÂÆπ...', 'info');

            const parserPrompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àËß£Êûê‰∏ìÂÆ∂ÔºåËØ∑ÂØπ‰ª•‰∏ãÊïôÊ°àÂÜÖÂÆπËøõË°åÊ∑±Â∫¶Ëß£ÊûêÂíåÁªìÊûÑÂåñÊï¥ÁêÜ„ÄÇ

ÊïôÊ°àÂéüÂßãÂÜÖÂÆπÔºö
${fileContent}

ËØ∑Êåâ‰ª•‰∏ãÁªìÊûÑËøõË°åËß£ÊûêÔºö

„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞Ôºö
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºö
- ËØæÊó∂ÂÆâÊéíÔºö
- ÊïôÂ≠¶ÁõÆÊ†áÔºö

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºö
- ÊïôÂ≠¶ÈáçÁÇπÔºö
- ÊïôÂ≠¶ÈöæÁÇπÔºö
- ÊïôÂ≠¶ÊñπÊ≥ïÔºö

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºö
- Êñ∞ÊéàÁéØËäÇÔºö
- ÁªÉ‰π†ÁéØËäÇÔºö
- ÊÄªÁªìÁéØËäÇÔºö

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑Ôºö
- Â≠¶‰π†ÊùêÊñôÔºö
- ËØÑ‰ª∑ÊñπÂºèÔºö

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºö
- ÂÜÖÂÆπ‰ºòÂåñÔºö
- ÊñπÊ≥ï‰ºòÂåñÔºö

ËØ∑Á°Æ‰øùËß£ÊûêËØ¶ÁªÜ„ÄÅÂáÜÁ°ÆÔºå‰∏∫ÂêéÁª≠ÊïôÁ†îÁªÑÂàÜÊûêÊèê‰æõÂÆåÊï¥ÁöÑÊïôÊ°à‰ø°ÊÅØ„ÄÇ`;

            try {
                const parsedContent = await callParserAPI(parserPrompt);
                if (parsedContent) {
                    // Ê∑ªÂä†ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
                    const teachingConfig = getTeachingConfig();
                    const fullContent = parsedContent + teachingConfig;
                    
                    // ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
                    showParsedContent(fullContent);
                    // Â∞ÜËß£ÊûêÁªìÊûú‰º†ÈÄíÁªôÊïôÁ†îÁªÑ
                    parsedFileContent = fullContent;
                    showMessage('‚úÖ ÊïôÊ°àËß£ÊûêÂÆåÊàêÔºÅÂºÄÂßãÊïôÁ†îÁªÑÂçè‰ΩúÂàÜÊûê...', 'success');

                    // ÂºÄÂßã‰∏âÈò∂ÊÆµÂàÜÊûê
                    setTimeout(() => {
                        startThreeStageAnalysis();
                    }, 1500);
                } else {
                    // Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüËß£ÊûêÁªìÊûú
                    console.warn('ÊïôÊ°àËß£ÊûêAPIËøîÂõûÁ©∫Ôºå‰ΩøÁî®Ê®°ÊãüËß£ÊûêÁªìÊûú');
                    const fallbackParsedContent = `„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞ÔºöÂ∞èÂ≠¶ÁßëÂ≠¶ËØæÁ®ã
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºöÂ∞èÂ≠¶‰∏âÂπ¥Á∫ß
- ËØæÊó∂ÂÆâÊéíÔºö1ËØæÊó∂
- ÊïôÂ≠¶ÁõÆÊ†áÔºöÂ≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîüÂéüÁêÜ

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü‰∏éÊåØÂä®
- ÊïôÂ≠¶ÈáçÁÇπÔºöÂ£∞Èü≥ÊòØÁî±Áâ©‰ΩìÊåØÂä®‰∫ßÁîüÁöÑ
- ÊïôÂ≠¶ÈöæÁÇπÔºöÁêÜËß£ÊåØÂä®‰∏éÂ£∞Èü≥ÁöÑÂÖ≥Á≥ª
- ÊïôÂ≠¶ÊñπÊ≥ïÔºöÂÆûÈ™åËßÇÂØü„ÄÅËÆ®ËÆ∫‰∫§ÊµÅ

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºöÊí≠ÊîæÂ£∞Èü≥ÔºåÂºïËµ∑ÂÖ¥Ë∂£
- Êñ∞ÊéàÁéØËäÇÔºöÂÆûÈ™åËßÇÂØüÊåØÂä®Áé∞Ë±°
- ÁªÉ‰π†ÁéØËäÇÔºöÂ∞èÁªÑÂÆûÈ™åÈ™åËØÅ
- ÊÄªÁªìÁéØËäÇÔºöÂΩíÁ∫≥Â£∞Èü≥‰∫ßÁîüÂéüÁêÜ

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑ÔºöÈü≥Âèâ„ÄÅÊ©°ÁöÆÁ≠ã„ÄÅÈºì
- Â≠¶‰π†ÊùêÊñôÔºöÂÆûÈ™åÂô®Êùê
- ËØÑ‰ª∑ÊñπÂºèÔºöËßÇÂØüÂ≠¶ÁîüÂÆûÈ™åË°®Áé∞

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºöÂ¢ûÂä†È¢ÑÊµãÁéØËäÇ
- ÂÜÖÂÆπ‰ºòÂåñÔºöË°•ÂÖÖÁîüÊ¥ªÂÆû‰æã
- ÊñπÊ≥ï‰ºòÂåñÔºöÂ¢ûÂä†‰∫íÂä®ÂÆûÈ™å`;

                    // Ê∑ªÂä†ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
                    const teachingConfig = getTeachingConfig();
                    const fullFallbackContent = fallbackParsedContent + teachingConfig;
                    
                    showParsedContent(fullFallbackContent);
                    parsedFileContent = fullFallbackContent;
                    showMessage('‚úÖ ÊïôÊ°àËß£ÊûêÂÆåÊàêÔºÅÂºÄÂßãÊïôÁ†îÁªÑÂçè‰ΩúÂàÜÊûê...', 'success');

                    setTimeout(() => {
                        startThreeStageAnalysis();
                    }, 1500);
                }
            } catch (error) {
                console.error('ÊïôÊ°àËß£ÊûêÂ§±Ë¥•:', error);
                // ‰ΩøÁî®Ê®°ÊãüËß£ÊûêÁªìÊûú
                const fallbackParsedContent = `„ÄêÊïôÊ°àÂü∫Êú¨‰ø°ÊÅØ„Äë
- ËØæÁ®ãÂêçÁß∞ÔºöÂ∞èÂ≠¶ÁßëÂ≠¶ËØæÁ®ã
- Âπ¥Á∫ßÂ≠¶ÊÆµÔºöÂ∞èÂ≠¶‰∏âÂπ¥Á∫ß
- ËØæÊó∂ÂÆâÊéíÔºö1ËØæÊó∂
- ÊïôÂ≠¶ÁõÆÊ†áÔºöÂ≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîüÂéüÁêÜ

„ÄêÊïôÂ≠¶ÂÜÖÂÆπÂàÜÊûê„Äë
- ‰∏ªË¶ÅÁü•ËØÜÁÇπÔºöÂ£∞Èü≥ÁöÑ‰∫ßÁîü‰∏éÊåØÂä®
- ÊïôÂ≠¶ÈáçÁÇπÔºöÂ£∞Èü≥ÊòØÁî±Áâ©‰ΩìÊåØÂä®‰∫ßÁîüÁöÑ
- ÊïôÂ≠¶ÈöæÁÇπÔºöÁêÜËß£ÊåØÂä®‰∏éÂ£∞Èü≥ÁöÑÂÖ≥Á≥ª
- ÊïôÂ≠¶ÊñπÊ≥ïÔºöÂÆûÈ™åËßÇÂØü„ÄÅËÆ®ËÆ∫‰∫§ÊµÅ

„ÄêÊïôÂ≠¶ÊµÅÁ®ãÂàÜÊûê„Äë
- ÂØºÂÖ•ÁéØËäÇÔºöÊí≠ÊîæÂ£∞Èü≥ÔºåÂºïËµ∑ÂÖ¥Ë∂£
- Êñ∞ÊéàÁéØËäÇÔºöÂÆûÈ™åËßÇÂØüÊåØÂä®Áé∞Ë±°
- ÁªÉ‰π†ÁéØËäÇÔºöÂ∞èÁªÑÂÆûÈ™åÈ™åËØÅ
- ÊÄªÁªìÁéØËäÇÔºöÂΩíÁ∫≥Â£∞Èü≥‰∫ßÁîüÂéüÁêÜ

„ÄêÊïôÂ≠¶ËµÑÊ∫êÂàÜÊûê„Äë
- ÊïôÂ≠¶Â∑•ÂÖ∑ÔºöÈü≥Âèâ„ÄÅÊ©°ÁöÆÁ≠ã„ÄÅÈºì
- Â≠¶‰π†ÊùêÊñôÔºöÂÆûÈ™åÂô®Êùê
- ËØÑ‰ª∑ÊñπÂºèÔºöËßÇÂØüÂ≠¶ÁîüÂÆûÈ™åË°®Áé∞

„Äê‰ºòÂåñÂª∫ËÆÆ„Äë
- ÁªìÊûÑ‰ºòÂåñÔºöÂ¢ûÂä†È¢ÑÊµãÁéØËäÇ
- ÂÜÖÂÆπ‰ºòÂåñÔºöË°•ÂÖÖÁîüÊ¥ªÂÆû‰æã
- ÊñπÊ≥ï‰ºòÂåñÔºöÂ¢ûÂä†‰∫íÂä®ÂÆûÈ™å`;

                // Ê∑ªÂä†ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
                const teachingConfig = getTeachingConfig();
                const fullFallbackContent = fallbackParsedContent + teachingConfig;
                
                showParsedContent(fullFallbackContent);
                parsedFileContent = fullFallbackContent;
                showMessage('‚úÖ ÊïôÊ°àËß£ÊûêÂÆåÊàêÔºÅÂºÄÂßãÊïôÁ†îÁªÑÂçè‰ΩúÂàÜÊûê...', 'success');

                setTimeout(() => {
                    startThreeStageAnalysis();
                }, 1500);
            }
        }

        // ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
        function showParsedContent(parsedContent) {
            const parsedPreview = document.getElementById('parsedContentPreview');
            const parsedContentElement = document.getElementById('parsedContent');

            parsedContentElement.textContent = parsedContent;
            parsedPreview.style.display = 'block';

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊïôÂ≠¶ÈÖçÁΩÆ‰ø°ÊÅØ
            if (parsedContent.includes('„ÄêÊïôÂ≠¶ËÉåÊôØ‰ø°ÊÅØ„Äë')) {
                const configVerification = document.getElementById('configVerification');
                const configSummary = document.getElementById('configSummary');
                
                // ÊèêÂèñÈÖçÁΩÆ‰ø°ÊÅØ
                const configMatch = parsedContent.match(/„ÄêÊïôÂ≠¶ËÉåÊôØ‰ø°ÊÅØ„Äë\n([\s\S]*?)(?:\n„Äê|$)/);
                if (configMatch) {
                    const configInfo = configMatch[1].trim().split('\n');
                    configSummary.textContent = `Â∑≤Âä†ÂÖ•ÈÖçÁΩÆ: ${configInfo.join(' | ')}`;
                } else {
                    configSummary.textContent = 'ÈÖçÁΩÆ‰ø°ÊÅØÊ†ºÂºèÊ≠£Á°Æ';
                }
                
                configVerification.style.display = 'block';
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆ‰ø°ÊÅØÔºåÈöêËóèÈ™åËØÅÊèêÁ§∫
                document.getElementById('configVerification').style.display = 'none';
            }

            // Ê∑ªÂä†Ê∑°ÂÖ•Âä®ÁîªÊïàÊûú
            parsedPreview.style.opacity = '0';
            parsedPreview.style.transform = 'translateY(20px)';

            setTimeout(() => {
                parsedPreview.style.transition = 'all 0.5s ease';
                parsedPreview.style.opacity = '1';
                parsedPreview.style.transform = 'translateY(0)';
            }, 100);
        }

        // ÂºÄÂßã‰∏âÈò∂ÊÆµÂàÜÊûê
        function startThreeStageAnalysis() {
            if (analysisInProgress || !parsedFileContent) return;

            analysisInProgress = true;
            showMessage('ÂºÄÂßã‰∏âÈò∂ÊÆµÂçè‰ΩúÂàÜÊûê...', 'info');

            // ÂàõÂª∫Âπ∂ÊòæÁ§∫Á¨¨‰∏ÄÈò∂ÊÆµ
            createStage1Analysis();
        }

        // ÂàõÂª∫Á¨¨‰∏ÄÈò∂ÊÆµÂàÜÊûêÁïåÈù¢
        async function createStage1Analysis() {
            const container = document.querySelector('.container');
            
            // ===== ÂÖ≥ÈîÆÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÂ≠òÂú® =====
            if (!container) {
                console.error('‚ùå Ëá¥ÂëΩÈîôËØØÔºö.containerÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÂàõÂª∫Á¨¨‰∏ÄÈò∂ÊÆµ');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÆπÂô®‰∏¢Â§±ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            const parsedContentPreview = document.getElementById('parsedContentPreview');

            // ÂÖàÁîüÊàêÂàùÊ≠•ÊïôÊ°à
            await generateInitialTeachingPlan();

            // ÂàõÂª∫Á¨¨‰∏ÄÈò∂ÊÆµÂÆπÂô®
            const stage1Div = document.createElement('div');
            stage1Div.className = 'card';
            stage1Div.id = 'stage1Container';
            stage1Div.innerHTML = `
                <h3><i class="fas fa-user-graduate"></i> Á¨¨‰∏ÄÈò∂ÊÆµÔºö‰∏ìÂÆ∂Áã¨Á´ãÂàÜÊûê</h3>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="stage1Progress"></div>
                    </div>
                    <div class="progress-text" id="stage1ProgressText">ÂáÜÂ§áÂºÄÂßãÂàÜÊûê...</div>
                </div>
                <div class="agents-grid" id="stage1Agents"></div>
            `;

            // ÊèíÂÖ•Âà∞ÂàùÊ≠•ÊïôÊ°à‰πãÂêéÔºàÂÆâÂÖ®ÊèíÂÖ•Ôºâ
            const initialPlanDiv = document.getElementById('initialTeachingPlan');
            const apiTestSection = document.getElementById('apiTestSection');
            
            // ÂÆâÂÖ®ÊèíÂÖ•Ôºö‰ΩøÁî®ËæÖÂä©ÂáΩÊï∞
            if (!safeInsertElement(container, stage1Div, [
                { ref: initialPlanDiv, position: 'after' },
                { ref: parsedContentPreview, position: 'after' },
                { ref: apiTestSection, position: 'before' }
            ])) {
                console.error('‚ùå stage1DivÊèíÂÖ•Â§±Ë¥•ÔºåÁªàÊ≠¢Êìç‰Ωú');
                return;
            }

            // ‰ΩøÁî®ÊªöÂä®ÁÆ°ÁêÜÂô®Ëá™Âä®ÊªöÂä®Âà∞Êñ∞ÂàõÂª∫ÁöÑÈò∂ÊÆµ
            setTimeout(() => {
                ScrollManager.scrollTo(stage1Div, { offset: 80 });
            }, 100);

            // ÂàùÂßãÂåñ‰∏ìÂÆ∂Âç°Áâá
            initializeAgentCards();
            startStage1Analysis();
        }

        // ÁîüÊàêÂàùÊ≠•ÊïôÊ°à
        // Ê†ºÂºèÂåñÊïôÊ°àÂÜÖÂÆπÔºåÂ¢ûÂº∫ÂèØËØªÊÄß
        function formatTeachingPlan(content) {
            if (!content) return '';
            
            let formatted = content;
            
            // 1. È´ò‰∫Æ5EÊ®°ÂûãÊ†áÊ≥®ÔºàÁâπÊÆäÂ§ÑÁêÜÔºå‰ΩøÁî®È¢úËâ≤Ê†áËÆ∞Ôºâ
            const fiveEColors = {
                '5E-ÂºïÂÖ•': '#ff4d4f',
                '5E-Êé¢Á©∂': '#1890ff',
                '5E-Ëß£Èáä': '#52c41a',
                '5E-Â∫îÁî®': '#722ed1',
                '5E-ËøÅÁßª': '#722ed1',
                '5E-ËØÑ‰º∞': '#fa8c16'
            };
            
            for (const [key, color] of Object.entries(fiveEColors)) {
                const regex = new RegExp(`„Äê(${key})„Äë`, 'g');
                formatted = formatted.replace(regex, `<span style="display: inline-block; background: ${color}25; color: ${color}; border: 2px solid ${color}; border-radius: 6px; padding: 4px 12px; margin: 0 8px; font-weight: 600; font-size: 0.9em; box-shadow: 0 2px 6px ${color}30;">üéØ $1</span>`);
            }
            
            // 2. ‰∏∫Ê†áÈ¢òÊ∑ªÂä†È¢ùÂ§ñÁöÑÁ©∫Ë°åÂíåÂº∫Ë∞É
            formatted = formatted.replace(/„Äê([^„Äë]+)„Äë/g, '\n\n„Äê$1„Äë');
            
            // 3. ‰∏∫ÁºñÂè∑ÂàóË°®È°πÊ∑ªÂä†ÈÄÇÂΩìÈó¥Ë∑ù
            formatted = formatted.replace(/(\d+\.\s)/g, '\n$1');
            
            // 4. ‰∏∫emojiÂºÄÂ§¥ÁöÑÈ°πÁõÆÊ∑ªÂä†ÈÄÇÂΩìÈó¥Ë∑ù
            formatted = formatted.replace(/(^|\n)(‚≠ê|üî∏|üìö|üë•|‚Ä¢)/g, '$1\n$2');
            
            // 5. ‰∏∫ÂàÜÈöîÁ∫øÂâçÂêéÊ∑ªÂä†Á©∫Ë°å
            formatted = formatted.replace(/‚îÅ+/g, '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
            
            // 6. ‰∏∫Â§ßÊ†áÈ¢òÔºà‰∏Ä„ÄÅ‰∫å„ÄÅ‰∏â„ÄÅÂõõÔºâÊ∑ªÂä†È¢ùÂ§ñÂº∫Ë∞É
            formatted = formatted.replace(/(^|\n)([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]+„ÄÅ[^\n]+)/g, '$1\n$2\n');
            
            // 7. Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑËøûÁª≠Á©∫Ë°åÔºàÊúÄÂ§ö2‰∏™ËøûÁª≠Á©∫Ë°åÔºâ
            formatted = formatted.replace(/\n{4,}/g, '\n\n\n');
            
            // 8. ÂéªÈô§È¶ñÂ∞æÁ©∫ÁôΩ
            formatted = formatted.trim();
            
            return formatted;
        }

        async function generateInitialTeachingPlan() {
            const container = document.querySelector('.container');
            
            // ===== ÂÖ≥ÈîÆÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÂ≠òÂú® =====
            if (!container) {
                console.error('‚ùå Ëá¥ÂëΩÈîôËØØÔºö.containerÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÁîüÊàêÂàùÊ≠•ÊïôÊ°à');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÆπÂô®‰∏¢Â§±ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            const parsedContentPreview = document.getElementById('parsedContentPreview');
            
            // ===== Âú®ÂºÄÂßãÁîüÊàêÂâçÔºåËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Ë¶Å‰ΩøÁî®Êñá‰ª∂Â§π‰øùÂ≠ò =====
            if (!selectedFolderHandle && 'showDirectoryPicker' in window) {
                const useFolder = await new Promise(resolve => {
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.85);
                        z-index: 10001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    `;
                    
                    const panel = document.createElement('div');
                    panel.style.cssText = `
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        border-radius: 16px;
                        padding: 40px;
                        max-width: 600px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                        text-align: center;
                    `;
                    
                    const courseTitle = extractCourseTitle();
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                    
                    panel.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìÅ</div>
                        <h2 style="color: white; font-size: 1.8rem; margin-bottom: 20px;">Êñá‰ª∂‰øùÂ≠òÊñπÂºèÈÄâÊã©</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; line-height: 1.8; margin-bottom: 30px;">
                            Á≥ªÁªüÂ∞ÜÁîüÊàêÂ§ö‰∏™Êñá‰ª∂ÔºàÂàùÊ≠•ÊïôÊ°à„ÄÅËÆ®ËÆ∫ËÆ∞ÂΩï„ÄÅ‰ºòÂåñÊïôÊ°àÁ≠âÔºâ<br>
                            ÊÇ®Â∏åÊúõÂ¶Ç‰Ωï‰øùÂ≠òËøô‰∫õÊñá‰ª∂Ôºü
                        </p>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px; text-align: left;">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: #52c41a; font-size: 1.2rem;">‚úÖ Êé®ËçêÔºöÈÄâÊã©Êñá‰ª∂Â§π</strong>
                                <p style="color: rgba(255,255,255,0.85); font-size: 0.95rem; margin-top: 8px; line-height: 1.8;">
                                    ‚Ä¢ Áõ¥Êé•‰øùÂ≠òÂà∞ E:\\edu material\\disscussion_result\\${courseTitle}_${timestamp.substring(0, 10)}\\<br>
                                    ‚Ä¢ ÊâÄÊúâÊñá‰ª∂Ëá™Âä®Êï¥ÁêÜÂà∞Âêå‰∏ÄÊñá‰ª∂Â§π<br>
                                    ‚Ä¢ Êó†ÈúÄÊâãÂä®ÁßªÂä®Êñá‰ª∂<br>
                                    ‚Ä¢ Chrome/EdgeÊµèËßàÂô®ÊîØÊåÅ
                                </p>
                            </div>
                            <div>
                                <strong style="color: #1890ff; font-size: 1.2rem;">üì• ‰º†ÁªüÊñπÂºèÔºöÊµèËßàÂô®‰∏ãËΩΩ</strong>
                                <p style="color: rgba(255,255,255,0.85); font-size: 0.95rem; margin-top: 8px; line-height: 1.8;">
                                    ‚Ä¢ Êñá‰ª∂‰∏ãËΩΩÂà∞ÊµèËßàÂô®‰∏ãËΩΩÊñá‰ª∂Â§π<br>
                                    ‚Ä¢ ÈúÄË¶ÅÊâãÂä®Êï¥ÁêÜÂà∞Âêå‰∏ÄÊñá‰ª∂Â§π<br>
                                    ‚Ä¢ ÊâÄÊúâÊµèËßàÂô®ÈÉΩÊîØÊåÅ
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="this.closest('[style*=fixed]').dataset.result='folder'; this.closest('[style*=fixed]').remove();" 
                                style="background: linear-gradient(135deg, #52c41a, #73d13d); color: white; border: none; padding: 15px 35px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(82,196,26,0.4);">
                                <i class="fas fa-folder-open"></i> ÈÄâÊã©Êñá‰ª∂Â§π
                            </button>
                            <button onclick="this.closest('[style*=fixed]').dataset.result='download'; this.closest('[style*=fixed]').remove();" 
                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 15px 35px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-download"></i> ÊµèËßàÂô®‰∏ãËΩΩ
                            </button>
                        </div>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-top: 20px;">
                            üí° ÊèêÁ§∫ÔºöÈÄâÊã©Êñá‰ª∂Â§πÂêéÔºåÈúÄË¶ÅÂÖÅËÆ∏ÊµèËßàÂô®ËÆøÈóÆÊùÉÈôê
                        </p>
                    `;
                    
                    overlay.appendChild(panel);
                    document.body.appendChild(overlay);
                    
                    // ÁõëÂê¨ÈÄâÊã©ÁªìÊûú
                    const checkResult = setInterval(() => {
                        if (overlay.dataset.result) {
                            clearInterval(checkResult);
                            resolve(overlay.dataset.result === 'folder');
                        }
                        if (!document.body.contains(overlay)) {
                            clearInterval(checkResult);
                            resolve(false);
                        }
                    }, 100);
                });
                
                if (useFolder) {
                    await requestFolderAccess();
                }
            }
            
            // ÂàõÂª∫ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂÆπÂô®
            const initialPlanDiv = document.createElement('div');
            initialPlanDiv.className = 'card';
            initialPlanDiv.id = 'initialTeachingPlan';
            initialPlanDiv.innerHTML = `
                <h3><i class="fas fa-file-alt"></i> ÂàùÊ≠•ÊïôÊ°àÁîüÊàê</h3>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="initialPlanProgress" style="width: 20%;"></div>
                    </div>
                    <div class="progress-text" id="initialPlanProgressText">Ê≠£Âú®ÁîüÊàêÂàùÊ≠•ÊïôÊ°à...</div>
                </div>
                <div id="initialPlanContent" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; display: none;">
                    <div class="analysis-item">
                        <div class="analysis-label">ÂàùÊ≠•ÊïôÊ°à:</div>
                        <div class="analysis-content" id="initialPlanText" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="downloadInitialPlan('txt')" style="background: linear-gradient(135deg, #1890ff, #40a9ff); margin-right: 10px;">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩTXT
                        </button>
                        <button class="btn" onclick="downloadInitialPlan('docx')" style="background: linear-gradient(135deg, #52c41a, #73d13d); margin-right: 10px;">
                            <i class="fas fa-file-word"></i> ‰∏ãËΩΩDOCX
                        </button>
                        <button class="btn" onclick="downloadInitialPlan('pdf')" style="background: linear-gradient(135deg, #722ed1, #9254de); margin-right: 10px;" title="Áõ¥Êé•ÂØºÂá∫PDFÔºàÂ¶ÇÂ§±Ë¥•Âª∫ËÆÆ‰∏ãËΩΩDOCXÂêéÁî®WordËΩ¨Êç¢Ôºâ">
                            <i class="fas fa-file-pdf"></i> ÂØºÂá∫PDF
                        </button>
                        <button class="btn" onclick="downloadInitialPlan('md')" style="background: linear-gradient(135deg, #fa8c16, #faad14); margin-right: 10px;">
                            <i class="fas fa-file-code"></i> Markdown
                        </button>
                        <button class="btn" onclick="exportLocalStylePDF('initial')" style="background: linear-gradient(135deg, #13c2c2, #36cfc9); margin-right: 10px;" id="exportLocalStyleBtnInitial" data-i18n="ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf">
                            <i class="fas fa-file-pdf"></i> <span>ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf</span>
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(250, 173, 20, 0.1); border: 1px solid rgba(250, 173, 20, 0.3); border-radius: 8px;">
                        <div style="color: #fa8c16; font-size: 0.9rem; line-height: 1.8;">
                            <i class="fas fa-info-circle"></i> <strong>PDFÂØºÂá∫ËØ¥ÊòéÔºö</strong>
                        </div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; line-height: 1.8; margin-top: 8px;">
                            ‚Ä¢ Êé®ËçêÊµÅÁ®ãÔºö<strong>DOCX ‚Üí WordÊâìÂºÄ ‚Üí Âè¶Â≠ò‰∏∫PDF</strong>ÔºàË¥®ÈáèÊúÄ‰Ω≥Ôºâ<br>
                            ‚Ä¢ ÊµèËßàÂô®Áõ¥Êé•ÂØºÂá∫Ôºö‰ΩøÁî®html2pdf.jsËΩ¨Êç¢ÔºàÂèØËÉΩÊúâÊ†ºÂºèÈôêÂà∂Ôºâ<br>
                            ‚Ä¢ Â¶ÇÂØºÂá∫Â§±Ë¥•ÔºöËá™Âä®ÊèêÁ§∫‰∏ãËΩΩDOCXÔºåÁî®Word/WPSËΩ¨Êç¢
                        </div>
                    </div>
                </div>
            `;
            
            // ÊèíÂÖ•Âà∞Ëß£ÊûêÁªìÊûú‰πãÂêéÔºàÂÆâÂÖ®ÊèíÂÖ•Ôºâ
            const apiTestSection = document.getElementById('apiTestSection');
            
            if (!safeInsertElement(container, initialPlanDiv, [
                { ref: parsedContentPreview, position: 'after' },
                { ref: apiTestSection, position: 'before' }
            ])) {
                console.error('‚ùå initialPlanDivÊèíÂÖ•Â§±Ë¥•Ôºå‰ΩÜÂ∑≤Â∞ùËØïappendChild');
            }
            
            // ÊªöÂä®Âà∞ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂå∫Âüü
            setTimeout(() => {
                ScrollManager.scrollTo(initialPlanDiv, { offset: 80 });
            }, 100);
            
            try {
                // Ëé∑ÂèñÂú∞Âå∫‰ø°ÊÅØÂíåÊïôÂ≠¶ÈÖçÁΩÆ
                const region = document.getElementById('region')?.value || 'Â§ßÈôÜ';
                const gradeLevel = document.getElementById('gradeLevel')?.value || '';
                const specificGrade = document.getElementById('specificGrade')?.value || '';
                const courseName = document.getElementById('courseName')?.value.trim() || '';
                const studentCategory = document.getElementById('studentCategory')?.value.trim() || '';
                const teachingConfig = getTeachingConfig();
                
                // Âà§Êñ≠ÊòØÂê¶‰∏∫Êæ≥Èó®Âú∞Âå∫
                const isMacau = region === 'Êæ≥Èó®';
                
                // ‰ΩøÁî®QwenÁîüÊàêÂàùÊ≠•ÊïôÊ°à
                let initialPlanPrompt = '';
                
                if (isMacau) {
                    // Êæ≥Èó®Âú∞Âå∫‰ΩøÁî®ÂÆåÊï¥ÁöÑÊïôÊ°àÊ†ºÂºè
                    initialPlanPrompt = `‰ΩúÁÇ∫‰∏Ä‰ΩçÁ∂ìÈ©óË±êÂØåÁöÑÊïôÁ†îÁµÑÈï∑ÔºåË´ãÂü∫Êñº‰ª•‰∏ãÊïôÊ°àËß£ÊûêÂÖßÂÆπÔºåÁîüÊàê‰∏Ä‰ªΩË¶èÁØÑ„ÄÅÁæéËßÄ„ÄÅÂ∞àÊ•≠ÁöÑÂàùÊ≠•ÊïôÊ°à„ÄÇ

ÊïôÊ°àËß£ÊûêÂÖßÂÆπÔºö
${parsedFileContent}

ÊïôÂ≠∏ÈÖçÁΩÆ‰ø°ÊÅØÔºö
${teachingConfig}

‚ö†Ô∏è Êæ≥ÈñÄÂú∞ÂçÄÊïôÊ°àË®≠Ë®àÁâπÊÆäË¶ÅÊ±ÇÔºö
1. ÊïôÂ≠∏ÁõÆÊ®ôÂøÖÈ†àÂäÉÂàÜÁÇ∫Ôºö„ÄêË™çÁü•ÁõÆÊ®ô„Äë„ÄÅ„ÄêÊÉÖÊÑèÁõÆÊ®ô„Äë„ÄÅ„ÄêÊäÄËÉΩÁõÆÊ®ô„Äë‰∏âÂÄãÁ∂≠Â∫¶
2. ÊïôÂ≠∏ÁõÆÊ®ôÂøÖÈ†àÊòéÁ¢∫Â∞çÊáâÂà∞„ÄêÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„Äë
3. ÂøÖÈ†àË©≥Á¥∞ÂàÜÊûê„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÔºàÂåÖÊã¨Ë™çÁü•ËÉΩÂäõ„ÄÅÂ≠∏ÁøíËÉΩÂäõ„ÄÅÂü∫Á§éÊ∞¥Âπ≥Ôºâ
4. ÂøÖÈ†àÊòéÁ¢∫Ê®ôË®ª„ÄêÊïôÂ≠∏ÂÖßÂÆπÁöÑÈáçÈªû„ÄëÂíå„ÄêÊïôÂ≠∏ÂÖßÂÆπÁöÑÈõ£Èªû„Äë
5. ÂøÖÈ†àÊää„ÄêÊïôÂ≠∏ÂÖßÂÆπÁöÑÈõ£Èªû„ÄÅÈáçÈªû„ÄëËàá„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÈÄ≤Ë°åÂ∞çÊáâÂàÜÊûêÔºå‰∏¶È´îÁèæÂú®ÊïôÂ≠∏ÂÖßÂÆπË®≠Ë®à‰∏≠

Ë´ãÂö¥Ê†ºÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁîüÊàê‰∏Ä‰ªΩÂÆåÊï¥ÁöÑÊïôÊ°àÔºåÊ†ºÂºèÂíåÁâàÈù¢ÂøÖÈ†àËàáÊæ≥ÈñÄÂú∞ÂçÄÊ®ôÊ∫ñÊïôÊ°àPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥ÔºåÊØèÂÄãÈÉ®ÂàÜÈÉΩË¶ÅË©≥Á¥∞„ÄÅÂÖ∑È´î„ÄÅÂèØÊìç‰ΩúÔºö

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                      ÂàùÊ≠•ÊïôÂ≠∏Ë®≠Ë®àÊñπÊ°à
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÄêË™≤È°åÂêçÁ®±„Äë
${courseName || (parsedFileContent.includes('„ÄêÊïôÊ°à‰∏ªÈ¢ò„Äë') ? parsedFileContent.match(/„ÄêÊïôÊ°à‰∏ªÈ¢ò„Äë\s*\n\s*(.+)/)?.[1] || 'ÂæÖÁ¢∫ÂÆö' : 'ÂæÖÁ¢∫ÂÆö')}

„ÄêÁè≠Á¥ö„Äë
${specificGrade || 'ÂæÖÁ¢∫ÂÆö'}

„Äê‰∫∫Êï∏„Äë
[Â°´ÂØ´Áè≠Á¥ö‰∫∫Êï∏]

„ÄêÊïôÊùê‰æÜÊ∫ê„Äë
[Â°´ÂØ´ÊïôÊùê‰æÜÊ∫êÔºå‰æãÂ¶ÇÔºöÊæ≥ÈñÄÊñ∞ÊÄùÁ∂≠Êï∏Â≠∏ 4 ‰∏ä]

„ÄêË®≠Ë®àËÄÖ„Äë
AIÊïôÂ∏´

„ÄêÊôÇÈñì„Äë
[Â°´ÂØ´ÊïôÂ≠∏Êó•ÊúüÔºåÊ†ºÂºèÔºöYYYY/MM/DD]

„ÄêÂ≠∏ÁîüËÉåÊôØÂàÜÊûê„Äë
[Ë©≥Á¥∞ÊèèËø∞Â≠∏ÁîüÂ∑≤ÊúâÁü•Ë≠òÂü∫Á§é„ÄÅÂ≠∏ÁøíÁâπÈªû„ÄÅË™çÁü•Ê∞¥Âπ≥Á≠âÔºåËá≥Â∞ë150Â≠ó]

„ÄêÊîøÁ≠ñË¶èÂÆöÁöÑ‰∏ä‰ΩçÁõÆÊ®ôÔºàÁõ∏ÈóúÁöÑÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÔºâ„Äë
[ÂàóÂá∫Áõ∏ÈóúÁöÑÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄÅÊîøÁ≠ñÊñá‰ª∂„ÄÅË™≤Á®ãÊ®ôÊ∫ñÁ≠â‰∏ä‰ΩçÁõÆÊ®ôÔºåËá≥Â∞ë100Â≠ó„ÄÇ
Ê≥®ÊÑèÔºöÂøÖÈ†àÂÖ∑È´îÂºïÁî®Êæ≥ÈñÄÊïôÈùíÂ±ÄÁõ∏ÈóúÊñá‰ª∂Ôºå‰æãÂ¶ÇÔºö„ÄäÂ∞èÂ≠∏ÊïôËÇ≤ÈöéÊÆµÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„Äã„ÄÅ„Ää‰∏≠Â≠∏ÊïôËÇ≤ÈöéÊÆµÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄãÁ≠â]

„ÄêÊú¨Ë™≤ÁõÆÊ®ô„Äë
[Ê¶ÇËø∞Êú¨ÁØÄË™≤ÁöÑÊï¥È´îÁõÆÊ®ôÔºå50-80Â≠ó]

„ÄêÊïôÂ≠∏ÁõÆÊ®ô„ÄëÔºà‚ö†Ô∏è ÈáçË¶ÅÔºöÂøÖÈ†àÊåâÁÖßË™çÁü•„ÄÅÊÉÖÊÑè„ÄÅÊäÄËÉΩ‰∏âÂÄãÁ∂≠Â∫¶ÂäÉÂàÜÔºå‰∏¶Â∞çÊáâÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫ÂäõÔºâ

‰∏Ä„ÄÅË™çÁü•ÁõÆÊ®ôÔºàCognitive GoalsÔºâ
1.1 [ÂÖ∑È´îÁöÑË™çÁü•ÁõÆÊ®ô1Ôºå‰æãÂ¶ÇÔºöÁêÜËß£XXÊ¶ÇÂøµ„ÄÅÊéåÊè°XXÁü•Ë≠òÔºå30-50Â≠ó]
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö[ÊòéÁ¢∫Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÁöÑÂì™‰∏ÄÊ¢ù]

1.2 [ÂÖ∑È´îÁöÑË™çÁü•ÁõÆÊ®ô2Ôºå30-50Â≠ó]
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö[ÊòéÁ¢∫Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÁöÑÂì™‰∏ÄÊ¢ù]

‰∫å„ÄÅÊÉÖÊÑèÁõÆÊ®ôÔºàAffective GoalsÔºâ
2.1 [ÂÖ∑È´îÁöÑÊÉÖÊÑèÁõÆÊ®ô1Ôºå‰æãÂ¶ÇÔºöÂüπÈ§äXXÊÖãÂ∫¶„ÄÅÊøÄÁôºXXËààË∂£Ôºå30-50Â≠ó]
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö[ÊòéÁ¢∫Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÁöÑÂì™‰∏ÄÊ¢ù]

2.2 [ÂÖ∑È´îÁöÑÊÉÖÊÑèÁõÆÊ®ô2Ôºå30-50Â≠ó]
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö[ÊòéÁ¢∫Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÁöÑÂì™‰∏ÄÊ¢ù]

‰∏â„ÄÅÊäÄËÉΩÁõÆÊ®ôÔºàPsychomotor GoalsÔºâ
3.1 [ÂÖ∑È´îÁöÑÊäÄËÉΩÁõÆÊ®ô1Ôºå‰æãÂ¶ÇÔºöËÉΩÂ§†ÈÅãÁî®XXÊñπÊ≥ï„ÄÅÁÜüÁ∑¥Êìç‰ΩúXXÊäÄËÉΩÔºå30-50Â≠ó]
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö[ÊòéÁ¢∫Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÁöÑÂì™‰∏ÄÊ¢ù]

3.2 [ÂÖ∑È´îÁöÑÊäÄËÉΩÁõÆÊ®ô2Ôºå30-50Â≠ó]
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö[ÊòéÁ¢∫Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÁöÑÂì™‰∏ÄÊ¢ù]

„ÄêÂÖ∑È´îÁõÆÊ®ô„Äë
[ÂàóÂá∫3-5ÂÄãÂÖ∑È´îÁöÑ„ÄÅÂèØÊ∏¨ÈáèÁöÑÂ≠∏ÁøíÁõÆÊ®ôÔºåÊØèÂÄãÁõÆÊ®ô20-30Â≠óÔºå‰∏¶Ê®ôË®ª‰ª£ËôüÔºö1„ÄÅ2„ÄÅ3Á≠â]

„ÄêÂ≠∏ÁîüËÉΩÂäõÂàÜÊûê„ÄëÔºà‚ö†Ô∏è ÈáçË¶ÅÔºöÂøÖÈ†àË©≥Á¥∞ÂàÜÊûêÔºâ

‰∏Ä„ÄÅË™çÁü•ËÉΩÂäõÊ∞¥Âπ≥
[Ë©≥Á¥∞ÂàÜÊûêÂ≠∏ÁîüÁï∂ÂâçÁöÑË™çÁü•ÁôºÂ±ïÊ∞¥Âπ≥„ÄÅÊÄùÁ∂≠ÁâπÈªû„ÄÅÁêÜËß£ËÉΩÂäõÁ≠âÔºåËá≥Â∞ë100Â≠ó]

‰∫å„ÄÅÂ≠∏ÁøíÂü∫Á§éËàáËÉΩÂäõ
[ÂàÜÊûêÂ≠∏ÁîüÂ∑≤ÊéåÊè°ÁöÑÁõ∏ÈóúÁü•Ë≠ò„ÄÅÊäÄËÉΩÂü∫Á§é„ÄÅÂ≠∏ÁøíÁøíÊÖ£Á≠âÔºåËá≥Â∞ë100Â≠ó]

‰∏â„ÄÅÂ≠∏ÁøíÂõ∞Èõ£ËàáÊåëÊà∞
[È†êÊ∏¨Â≠∏ÁîüÂèØËÉΩÈÅáÂà∞ÁöÑÂ≠∏ÁøíÂõ∞Èõ£„ÄÅÁêÜËß£ÈöúÁ§ô„ÄÅËÉΩÂäõÈôêÂà∂Á≠âÔºåËá≥Â∞ë80Â≠ó]

„ÄêÊïôÂ≠∏ÂÖßÂÆπÂàÜÊûê„ÄëÔºà‚ö†Ô∏è ÈáçË¶ÅÔºöÂøÖÈ†àÊòéÁ¢∫Ê®ôË®ªÈáçÈªûÈõ£ÈªûÔºå‰∏¶ËàáÂ≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºâ

‰∏Ä„ÄÅÊïôÂ≠∏ÂÖßÂÆπÈáçÈªû
‚≠ê ÈáçÈªû1Ôºö[ÊòéÁ¢∫ÁöÑÊïôÂ≠∏ÈáçÈªûÂÖßÂÆπÔºå20-30Â≠ó]
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºö[ÂàÜÊûêÂ≠∏ÁîüÂú®ÈÄôÂÄãÈáçÈªû‰∏äÁöÑËÉΩÂäõÊ∞¥Âπ≥ÔºåÂ¶Ç‰ΩïË®≠Ë®àÊïôÂ≠∏Á™ÅÁ†¥Ôºå50-80Â≠ó]

‚≠ê ÈáçÈªû2Ôºö[ÊòéÁ¢∫ÁöÑÊïôÂ≠∏ÈáçÈªûÂÖßÂÆπÔºå20-30Â≠ó]
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºö[ÂàÜÊûêÂ≠∏ÁîüÂú®ÈÄôÂÄãÈáçÈªû‰∏äÁöÑËÉΩÂäõÊ∞¥Âπ≥ÔºåÂ¶Ç‰ΩïË®≠Ë®àÊïôÂ≠∏Á™ÅÁ†¥Ôºå50-80Â≠ó]

‚≠ê ÈáçÈªû3Ôºö[ÊòéÁ¢∫ÁöÑÊïôÂ≠∏ÈáçÈªûÂÖßÂÆπÔºå20-30Â≠ó]
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºö[ÂàÜÊûêÂ≠∏ÁîüÂú®ÈÄôÂÄãÈáçÈªû‰∏äÁöÑËÉΩÂäõÊ∞¥Âπ≥ÔºåÂ¶Ç‰ΩïË®≠Ë®àÊïôÂ≠∏Á™ÅÁ†¥Ôºå50-80Â≠ó]

‰∫å„ÄÅÊïôÂ≠∏ÂÖßÂÆπÈõ£Èªû
üî∏ Èõ£Èªû1Ôºö[Â≠∏Áîü‰∏çÊòìÁêÜËß£ÁöÑÁü•Ë≠òÈªûÔºå20-30Â≠ó]
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºö[ÂàÜÊûêÁÇ∫‰ΩïÈÄôÊòØÈõ£ÈªûÔºàËàáÂ≠∏ÁîüËÉΩÂäõÁöÑÂ∑ÆË∑ùÔºâÔºåÂ¶Ç‰ΩïÈôç‰ΩéÈõ£Â∫¶„ÄÅÊê≠Âª∫ÈöéÊ¢ØÔºå80-100Â≠ó]
   ‚Üí Á™ÅÁ†¥Á≠ñÁï•Ôºö[ÂÖ∑È´îÁöÑÊïôÂ≠∏Á≠ñÁï•ÂíåÊñπÊ≥ïÔºå50-80Â≠ó]

üî∏ Èõ£Èªû2Ôºö[ÈúÄË¶ÅÁ™ÅÁ†¥ÁöÑÊÄùÁ∂≠ÈöúÁ§ôÔºå20-30Â≠ó]
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºö[ÂàÜÊûêÁÇ∫‰ΩïÈÄôÊòØÈõ£ÈªûÔºàËàáÂ≠∏ÁîüËÉΩÂäõÁöÑÂ∑ÆË∑ùÔºâÔºåÂ¶Ç‰ΩïÈôç‰ΩéÈõ£Â∫¶„ÄÅÊê≠Âª∫ÈöéÊ¢ØÔºå80-100Â≠ó]
   ‚Üí Á™ÅÁ†¥Á≠ñÁï•Ôºö[ÂÖ∑È´îÁöÑÊïôÂ≠∏Á≠ñÁï•ÂíåÊñπÊ≥ïÔºå50-80Â≠ó]

„ÄêÊïôÂ≠∏Á†îÁ©∂„Äë

‰∏Ä„ÄÅË®≠Ë®àÁêÜÂøµËàáÁõÆÊ®ô
[Èó°Ëø∞Êú¨Ë™≤ÁöÑË®≠Ë®àÁêÜÂøµ„ÄÅÊïôÂ≠∏ÁêÜÂøµ„ÄÅË®≠Ë®àÊÄùË∑ØÁ≠âÔºåÂøÖÈ†àÈ´îÁèæÂ¶Ç‰ΩïÂü∫ÊñºÂ≠∏ÁîüËÉΩÂäõË®≠Ë®àÊïôÂ≠∏ÔºåËá≥Â∞ë150Â≠ó]

‰∫å„ÄÅÂ≠∏ÁîüÁöÑÂàÜÊûê
[Ë©≥Á¥∞ÂàÜÊûêÂ≠∏ÁîüÁöÑË™çÁü•ÁâπÈªû„ÄÅÂ∑≤ÊúâÁü•Ë≠ò„ÄÅÂ≠∏ÁøíÂõ∞Èõ£„ÄÅËààË∂£ÊÑõÂ•ΩÁ≠âÔºåËá≥Â∞ë150Â≠ó]

‰∏â„ÄÅË™≤Á®ãÊû∂Êßã
[Ë™™ÊòéÊú¨Ë™≤Âú®Êï¥ÂÄãË™≤Á®ãÈ´îÁ≥ª‰∏≠ÁöÑ‰ΩçÁΩÆ„ÄÅËàáÂâçÂæåË™≤Á®ãÁöÑÈóúËÅØ„ÄÅË™≤Á®ãÁµêÊßãÁ≠âÔºåËá≥Â∞ë100Â≠ó]

Âõõ„ÄÅÁØÄÊ¨°ÂàÜÈÖç
[Ë™™ÊòéÊú¨Ë™≤ÁöÑË™≤ÊôÇÂÆâÊéí„ÄÅÊôÇÈñìÂàÜÈÖç„ÄÅÁØÄÊ¨°ÂÆâÊéíÁ≠âÔºåËá≥Â∞ë80Â≠ó]

‰∫î„ÄÅÊïôÂ≠∏ÊñπÊ≥ïËàáË©ïÈáè
[Ë™™ÊòéÊé°Áî®ÁöÑÊïôÂ≠∏ÊñπÊ≥ï„ÄÅË©ïÈáèÊñπÂºè„ÄÅË©ïÂÉπÁ≠ñÁï•Á≠âÔºåÂøÖÈ†àË™™ÊòéÂ¶Ç‰ΩïÈáùÂ∞ç‰∏çÂêåËÉΩÂäõÂ≠∏ÁîüÊé°Áî®Â∑ÆÁï∞ÂåñÊïôÂ≠∏ÔºåËá≥Â∞ë100Â≠ó]

ÂÖ≠„ÄÅÂèÉËÄÉË≥áÊ∫ê
[ÂàóÂá∫ÂèÉËÄÉÁöÑÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅÊñáÁçªË≥áÊñô„ÄÅÁ∂≤Áµ°Ë≥áÊ∫êÁ≠âÔºåËá≥Â∞ë80Â≠ó]

„ÄêÊïôÂ≠∏ÊµÅÁ®ã„Äë

Ë´ã‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÂëàÁèæÊïôÂ≠∏ÊµÅÁ®ãÔºåË°®Ê†ºÂøÖÈ†àÂåÖÂê´‰ª•‰∏ãÂàóÔºö
- ÁõÆÊ®ô‰ª£ËôüÔºàÂ∞çÊáâÂÖ∑È´îÁõÆÊ®ôÁöÑ‰ª£ËôüÔºåÂ¶ÇÔºö1„ÄÅ2„ÄÅ3Á≠âÔºåÂøÖÈ†àÂ∞çÊáâÂâçÈù¢ÁöÑ„ÄêÂÖ∑È´îÁõÆÊ®ô„ÄëÔºâ
- Ê¥ªÂãïÊµÅÁ®ãÔºàË©≥Á¥∞ÊèèËø∞ÊïôÂ≠∏Ê¥ªÂãïÁöÑÂÖ∑È´îÊ≠•È©üÔºåÂøÖÈ†àÈ´îÁèæÂ¶Ç‰ΩïÁ™ÅÁ†¥ÈáçÈªûÈõ£ÈªûÔºâ
- ÊôÇÈñìÔºàÊØèÂÄãÊ¥ªÂãïÁöÑÊôÇÈñìÂàÜÈÖçÔºâ
- ÊïôÂ≠∏Ë≥áÊ∫êÔºà‰ΩøÁî®ÁöÑÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅÊïôÂÖ∑„ÄÅÊùêÊñôÁ≠âÔºâ
- Ë©ïÈáèÔºàË©ïÂÉπÊñπÂºèÂíåÊ®ôÊ∫ñÔºåÂøÖÈ†àÂ∞çÊáâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩÁõÆÊ®ôÔºâ

Á§∫‰æãË°®Ê†ºÊ†ºÂºèÔºö
| ÁõÆÊ®ô‰ª£Ëôü | Ê¥ªÂãïÊµÅÁ®ã | ÊôÇÈñì | ÊïôÂ≠∏Ë≥áÊ∫ê | Ë©ïÈáè |
|---------|---------|------|---------|------|
| 1„ÄÅ2 | [Ë©≥Á¥∞ÊèèËø∞Ê¥ªÂãïÂÖßÂÆπÔºåÂøÖÈ†àË™™ÊòéÂ¶Ç‰ΩïÈáùÂ∞çÂ≠∏ÁîüËÉΩÂäõÂ±ïÈñãÊïôÂ≠∏ÔºåÂ¶Ç‰ΩïÁ™ÅÁ†¥Èõ£ÈªûÔºåËá≥Â∞ë100Â≠ó] | 5ÂàÜÈêò | [ÂàóÂá∫ÂÖ∑È´îË≥áÊ∫ê] | [Ë©ïÂÉπÊñπÂºèÔºåÂ∞çÊáâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ] |
| 1„ÄÅ3 | [Ë©≥Á¥∞ÊèèËø∞Ê¥ªÂãïÂÖßÂÆπÔºåÂøÖÈ†àÈ´îÁèæÈáçÈªûÊïôÂ≠∏Á≠ñÁï•ÔºåËá≥Â∞ë100Â≠ó] | 10ÂàÜÈêò | [ÂàóÂá∫ÂÖ∑È´îË≥áÊ∫ê] | [Ë©ïÂÉπÊñπÂºèÔºåÂ∞çÊáâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ] |

‚ö†Ô∏è ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†àÔºö
1. ÂåÖÂê´Ëá≥Â∞ë5-8ÂÄãÊ¥ªÂãïÁí∞ÁØÄÔºåÊØèÂÄãÁí∞ÁØÄÈÉΩË¶ÅË©≥Á¥∞ÊèèËø∞
2. ÊòéÁ¢∫Ê®ôË®ªÂì™‰∫õÁí∞ÁØÄÈáùÂ∞çÂì™‰∫õÈáçÈªûÂíåÈõ£Èªû
3. È´îÁèæÂ¶Ç‰ΩïÂü∫ÊñºÂ≠∏ÁîüËÉΩÂäõË®≠Ë®àÊ¥ªÂãï
4. È´îÁèæË™çÁü•„ÄÅÊÉÖÊÑè„ÄÅÊäÄËÉΩ‰∏âÂÄãÁ∂≠Â∫¶ÁöÑÂüπÈ§ä

„ÄêË©ïÂÉπÊñπÂºè„Äë
1. ÈÅéÁ®ãÊÄßË©ïÂÉπÔºö[Ë©≥Á¥∞Ë™™ÊòéÈÅéÁ®ãÊÄßË©ïÂÉπÁöÑÂÖ∑È´îÊñπÂºè„ÄÅËßÄÂØüÈªû„ÄÅË©ïÂÉπÊ®ôÊ∫ñÁ≠âÔºåÂøÖÈ†àÈ´îÁèæË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ‰∏âÂÄãÁ∂≠Â∫¶ÁöÑË©ïÂÉπÔºåËá≥Â∞ë100Â≠ó]
2. Á∏ΩÁµêÊÄßË©ïÂÉπÔºö[Ë©≥Á¥∞Ë™™ÊòéÁ∏ΩÁµêÊÄßË©ïÂÉπÁöÑÊñπÂºè„ÄÅË©ïÂÉπÊ®ôÊ∫ñ„ÄÅË©ïÂÉπÂ∑•ÂÖ∑Á≠âÔºåÂøÖÈ†àÂ∞çÊáâÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÔºåËá≥Â∞ë100Â≠ó]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Êæ≥ÈñÄÂú∞ÂçÄÊïôÊ°àÁâπÊÆäË¶ÅÊ±ÇÁ∏ΩÁµêÔºö
1. ‚úÖ ÊïôÂ≠∏ÁõÆÊ®ôÊåâ„ÄêË™çÁü•„Äë„ÄÅ„ÄêÊÉÖÊÑè„Äë„ÄÅ„ÄêÊäÄËÉΩ„Äë‰∏âÂÄãÁ∂≠Â∫¶ÂäÉÂàÜ
2. ‚úÖ ÊØèÂÄãÁõÆÊ®ôÂøÖÈ†àÂ∞çÊáâ„ÄêÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„Äë
3. ‚úÖ Ë©≥Á¥∞ÂàÜÊûê„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÔºàË™çÁü•ËÉΩÂäõ„ÄÅÂ≠∏ÁøíÂü∫Á§é„ÄÅÂ≠∏ÁøíÂõ∞Èõ£Ôºâ
4. ‚úÖ ÊòéÁ¢∫Ê®ôË®ª„ÄêÊïôÂ≠∏ÂÖßÂÆπÈáçÈªû„ÄëÂíå„ÄêÊïôÂ≠∏ÂÖßÂÆπÈõ£Èªû„Äë
5. ‚úÖ ÊØèÂÄãÈáçÈªûÈõ£ÈªûÂøÖÈ†àËàá„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÈÄ≤Ë°åÂ∞çÊáâÂàÜÊûê
6. ‚úÖ ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†àÈ´îÁèæÂ¶Ç‰ΩïÂü∫ÊñºÂ≠∏ÁîüËÉΩÂäõÁ™ÅÁ†¥ÈáçÈªûÈõ£Èªû
7. ‚úÖ Ë©ïÂÉπÊñπÂºèÂøÖÈ†àÂ∞çÊáâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ‰∏âÂÄãÁ∂≠Â∫¶
8. ‚úÖ Ê†ºÂºèÂíåÁâàÈù¢ÂøÖÈ†àËàáÊæ≥ÈñÄÂú∞ÂçÄÊ®ôÊ∫ñÊïôÊ°àPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥
9. ‚úÖ ‰ΩøÁî®ÁπÅÈ´î‰∏≠Êñá
10. ‚úÖ ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´ÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàó

Ë´ãÂÆåÊï¥Ëº∏Âá∫‰ª•‰∏äÊâÄÊúâÈÉ®ÂàÜÔºåÁ¢∫‰øùÊ†ºÂºèÁæéËßÄ„ÄÅÂÖßÂÆπÂÖÖÂØ¶„ÄÅÁ¨¶ÂêàÊæ≥ÈñÄÊïôËÇ≤Ë¶ÅÊ±Ç„ÄÇ`;
                } else {
                    // ÂÖ∂‰ªñÂú∞Âå∫‰ΩøÁî®ÂéüÊúâÊ†ºÂºè
                    initialPlanPrompt = `‰Ωú‰∏∫‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÊïôÁ†îÁªÑÈïøÔºåËØ∑Âü∫‰∫é‰ª•‰∏ãÊïôÊ°àËß£ÊûêÂÜÖÂÆπÔºåÁîüÊàê‰∏Ä‰ªΩËßÑËåÉ„ÄÅÁæéËßÇ„ÄÅ‰∏ì‰∏öÁöÑÂàùÊ≠•ÊïôÊ°à„ÄÇ

ÊïôÊ°àËß£ÊûêÂÜÖÂÆπÔºö
${parsedFileContent}

ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁîüÊàê‰∏Ä‰ªΩÂÆåÊï¥ÁöÑÊïôÊ°àÔºåÊØè‰∏™ÈÉ®ÂàÜÈÉΩË¶ÅËØ¶ÁªÜ„ÄÅÂÖ∑‰Ωì„ÄÅÂèØÊìç‰ΩúÔºö

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                      ÂàùÊ≠•ÊïôÂ≠¶ËÆæËÆ°ÊñπÊ°à
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÄêËØæÁ®ãÂêçÁß∞„Äë
${parsedFileContent.includes('„ÄêÊïôÊ°à‰∏ªÈ¢ò„Äë') ? parsedFileContent.match(/„ÄêÊïôÊ°à‰∏ªÈ¢ò„Äë\s*\n\s*(.+)/)?.[1] || 'ÂæÖÁ°ÆÂÆö' : 'ÂæÖÁ°ÆÂÆö'}

„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë
1. Áü•ËØÜ‰∏éÊäÄËÉΩÔºö[ÂÖ∑‰ΩìÊèèËø∞Â≠¶ÁîüÂ∫îÊéåÊè°ÁöÑÁü•ËØÜÂíåÊäÄËÉΩÔºå20-30Â≠ó]
2. ËøáÁ®ã‰∏éÊñπÊ≥ïÔºö[ÂÖ∑‰ΩìÊèèËø∞Â≠¶‰π†ËøáÁ®ãÂíåÊñπÊ≥ïÂüπÂÖªÔºå20-30Â≠ó]
3. ÊÉÖÊÑüÊÄÅÂ∫¶‰∏é‰ª∑ÂÄºËßÇÔºö[ÂÖ∑‰ΩìÊèèËø∞ÊÉÖÊÑüÊÄÅÂ∫¶ÂüπÂÖªÔºå20-30Â≠ó]

„ÄêÊïôÂ≠¶ÈáçÁÇπ„Äë
‚≠ê ÈáçÁÇπ‰∏ÄÔºö[ÊòéÁ°ÆÂÖ∑‰ΩìÁöÑÊïôÂ≠¶ÈáçÁÇπÔºå15-25Â≠ó]
‚≠ê ÈáçÁÇπ‰∫åÔºö[ÊòéÁ°ÆÂÖ∑‰ΩìÁöÑÊïôÂ≠¶ÈáçÁÇπÔºå15-25Â≠ó]
‚≠ê ÈáçÁÇπ‰∏âÔºö[ÊòéÁ°ÆÂÖ∑‰ΩìÁöÑÊïôÂ≠¶ÈáçÁÇπÔºå15-25Â≠ó]

„ÄêÊïôÂ≠¶ÈöæÁÇπ„Äë
üî∏ ÈöæÁÇπ‰∏ÄÔºö[Â≠¶Áîü‰∏çÊòìÁêÜËß£ÁöÑÁü•ËØÜÁÇπÔºå15-25Â≠ó]
üî∏ ÈöæÁÇπ‰∫åÔºö[ÈúÄË¶ÅÁ™ÅÁ†¥ÁöÑÊÄùÁª¥ÈöúÁ¢çÔºå15-25Â≠ó]

„ÄêÊïôÂ≠¶ÂáÜÂ§á„Äë
üìö ÊïôÂ∏àÂáÜÂ§áÔºö[ÊïôÂ≠¶ÊùêÊñô„ÄÅÊïôÂÖ∑„ÄÅËØæ‰ª∂Á≠â]
üë• Â≠¶ÁîüÂáÜÂ§áÔºö[È¢Ñ‰π†ÂÜÖÂÆπ„ÄÅÂ≠¶‰π†Áî®ÂìÅÁ≠â]

„ÄêÊïôÂ≠¶ÊµÅÁ®ã„Äë

‰∏Ä„ÄÅÂØºÂÖ•ÁéØËäÇÔºàÁ∫¶5ÂàÜÈíüÔºâ
   ÁõÆÁöÑÔºöÊøÄÂèëÂ≠¶‰π†ÂÖ¥Ë∂£ÔºåÂºïÂÖ•Êñ∞ËØæ
   Ê¥ªÂä®ËÆæËÆ°Ôºö
   ‚Ä¢ [ÂÖ∑‰ΩìÁöÑÂØºÂÖ•Ê¥ªÂä®ÊèèËø∞Ôºå30-50Â≠ó]
   ‚Ä¢ [È¢ÑÊúüÊïàÊûúËØ¥Êòé]

‰∫å„ÄÅÊñ∞Áü•Êé¢Á©∂ÔºàÁ∫¶20ÂàÜÈíüÔºâ
   ÁõÆÁöÑÔºöÂ∏ÆÂä©Â≠¶ÁîüÁêÜËß£ÂíåÊéåÊè°Ê†∏ÂøÉÁü•ËØÜ
   
   ÁéØËäÇ1ÔºöÊ¶ÇÂøµËÆ≤Ëß£
   ‚Ä¢ [ÊïôÂ∏àÊ¥ªÂä®ÔºöÂÖ∑‰ΩìÊïôÂ≠¶Ê≠•È™§Ôºå30-50Â≠ó]
   ‚Ä¢ [Â≠¶ÁîüÊ¥ªÂä®ÔºöÂ≠¶ÁîüÂ¶Ç‰ΩïÂèÇ‰∏éÔºå20-30Â≠ó]
   ‚Ä¢ [ËÆæËÆ°ÊÑèÂõæÔºö‰∏∫‰ªÄ‰πàËøôÊ†∑ËÆæËÆ°Ôºå20-30Â≠ó]
   
   ÁéØËäÇ2ÔºöÊ∑±ÂÖ•Êé¢Á©∂
   ‚Ä¢ [ÊïôÂ∏àÊ¥ªÂä®ÔºöÂºïÂØºÊé¢Á©∂ÁöÑÊñπÂºèÔºå30-50Â≠ó]
   ‚Ä¢ [Â≠¶ÁîüÊ¥ªÂä®ÔºöÊé¢Á©∂ÁöÑÂÖ∑‰ΩìÂΩ¢ÂºèÔºå20-30Â≠ó]
   ‚Ä¢ [ËÆæËÆ°ÊÑèÂõæÔºöÂüπÂÖª‰ªÄ‰πàËÉΩÂäõÔºå20-30Â≠ó]

‰∏â„ÄÅÂ∑©Âõ∫ÁªÉ‰π†ÔºàÁ∫¶10ÂàÜÈíüÔºâ
   ÁõÆÁöÑÔºöÂèäÊó∂Â∑©Âõ∫ÊâÄÂ≠¶Áü•ËØÜ
   
   ‚Ä¢ ÁªÉ‰π†1Ôºö[Âü∫Á°ÄÁªÉ‰π†È¢òÁõÆÊàñÊ¥ªÂä®Ôºå20-30Â≠ó]
   ‚Ä¢ ÁªÉ‰π†2Ôºö[ÊèêÈ´òÁªÉ‰π†È¢òÁõÆÊàñÊ¥ªÂä®Ôºå20-30Â≠ó]
   ‚Ä¢ ÂèçÈ¶àÊñπÂºèÔºö[Â¶Ç‰ΩïÊ£ÄÊü•Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ]

Âõõ„ÄÅËØæÂ†ÇÂ∞èÁªìÔºàÁ∫¶5ÂàÜÈíüÔºâ
   ÁõÆÁöÑÔºöÊ¢≥ÁêÜÁü•ËØÜÔºåÂΩ¢Êàê‰ΩìÁ≥ª
   
   ‚Ä¢ Áü•ËØÜÂõûÈ°æÔºö[Â∏àÁîüÂÖ±ÂêåÊÄªÁªìË¶ÅÁÇπ]
   ‚Ä¢ ÊÄùÁª¥ÂØºÂõæÔºö[ÂëàÁé∞Áü•ËØÜÁªìÊûÑ]
   ‚Ä¢ ÊãìÂ±ïÂª∂‰º∏Ôºö[Â∏ÉÁΩÆÊÄùËÄÉÈ¢òÊàñ‰Ωú‰∏ö]

„ÄêÂàõÊñ∞ÊïôÂ≠¶Ê¥ªÂä®„Äë

Ê¥ªÂä®‰∏ÄÔºö[Ê¥ªÂä®ÂêçÁß∞]
‚Ä¢ Ê¥ªÂä®ÁõÆÊ†áÔºö[ÂüπÂÖª‰ªÄ‰πàËÉΩÂäõÔºå20Â≠óÂ∑¶Âè≥]
‚Ä¢ Ê¥ªÂä®ÂΩ¢ÂºèÔºö[Â∞èÁªÑÂêà‰Ωú/ÂÆûË∑µÊìç‰Ωú/ËßíËâ≤ÊâÆÊºîÁ≠â]
‚Ä¢ Ê¥ªÂä®Ê≠•È™§Ôºö[ÂÖ∑‰ΩìÊìç‰ΩúÊµÅÁ®ãÔºå50-80Â≠ó]
‚Ä¢ È¢ÑÊúüÊïàÊûúÔºö[Â≠¶ÁîüËÉΩÂ§ü...Ôºå20-30Â≠ó]

Ê¥ªÂä®‰∫åÔºö[Ê¥ªÂä®ÂêçÁß∞]
‚Ä¢ Ê¥ªÂä®ÁõÆÊ†áÔºö[ÂüπÂÖª‰ªÄ‰πàËÉΩÂäõÔºå20Â≠óÂ∑¶Âè≥]
‚Ä¢ Ê¥ªÂä®ÂΩ¢ÂºèÔºö[ÂÖ∑‰ΩìÁöÑÊ¥ªÂä®ÂΩ¢Âºè]
‚Ä¢ Ê¥ªÂä®Ê≠•È™§Ôºö[ÂÖ∑‰ΩìÊìç‰ΩúÊµÅÁ®ãÔºå50-80Â≠ó]
‚Ä¢ È¢ÑÊúüÊïàÊûúÔºö[Â≠¶ÁîüËÉΩÂ§ü...Ôºå20-30Â≠ó]

„ÄêËØÑ‰ª∑ÊñπÂºè„Äë

1. ËøáÁ®ãÊÄßËØÑ‰ª∑
   ‚Ä¢ ËØæÂ†ÇËßÇÂØüÔºö[ËßÇÂØüÂ≠¶ÁîüÂèÇ‰∏éÂ∫¶„ÄÅÊÄùÁª¥Ê¥ªË∑ÉÂ∫¶]
   ‚Ä¢ Â∞èÁªÑ‰∫íËØÑÔºö[Âêå‰º¥ËØÑ‰ª∑ÁöÑÂÖ∑‰ΩìÁª¥Â∫¶]
   ‚Ä¢ Âç≥Êó∂ÂèçÈ¶àÔºö[ËØæÂ†ÇÊèêÈóÆ„ÄÅÁªÉ‰π†ÂèçÈ¶à]

2. ÊÄªÁªìÊÄßËØÑ‰ª∑
   ‚Ä¢ ‰Ωú‰∏öËØÑ‰ª∑Ôºö[‰Ωú‰∏öÁöÑËØÑ‰ª∑Ê†áÂáÜ]
   ‚Ä¢ ÊàêÊûúÂ±ïÁ§∫Ôºö[Â≠¶‰π†ÊàêÊûúÁöÑÂëàÁé∞ÂΩ¢Âºè]
   ‚Ä¢ Ëá™ÊàëËØÑ‰ª∑Ôºö[Â≠¶ÁîüÂèçÊÄùÂ≠¶‰π†ËøáÁ®ã]

„ÄêÊùø‰π¶ËÆæËÆ°„Äë
[ËÆæËÆ°ÁÆÄÊ¥ÅÁæéËßÇÁöÑÊùø‰π¶ÁªìÊûÑÔºå‰ΩìÁé∞Áü•ËØÜÈÄªËæëÂÖ≥Á≥ª]

„ÄêÊïôÂ≠¶ÂèçÊÄùÈ¢ÑËÆæ„Äë
1. Êú¨ËäÇËØæÁöÑ‰∫ÆÁÇπÔºö[È¢ÑÊúüÁöÑÊàêÂäü‰πãÂ§Ñ]
2. ÈúÄË¶ÅÂÖ≥Ê≥®Ôºö[ÂèØËÉΩÁöÑÈóÆÈ¢òÊàñÈöæÁÇπ]
3. ÊîπËøõÊñπÂêëÔºö[ÂêéÁª≠‰ºòÂåñÁöÑÊÄùË∑Ø]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Ê≥®ÊÑè‰∫ãÈ°πÔºö
1. ÊØè‰∏™ÈÉ®ÂàÜÈÉΩË¶ÅÂÜÖÂÆπÂÖÖÂÆûÔºå‰∏çË¶ÅÁ©∫Ê≥õ
2. ÊèèËø∞Ë¶ÅÂÖ∑‰ΩìÔºåÊúâÂèØÊìç‰ΩúÊÄß
3. ‰ΩìÁé∞Â≠¶Áîü‰∏∫‰∏ª‰Ωì„ÄÅÊïôÂ∏à‰∏∫‰∏ªÂØºÁöÑÁêÜÂøµ
4. ÂÖ≥Ê≥®Â≠¶ÁîüÁöÑÂÆûÈôÖÈúÄÊ±ÇÂíåËÆ§Áü•ËßÑÂæã
5. ‰øùÊåÅ‰∏ì‰∏öÊÄßÂíåËßÑËåÉÊÄß

ËØ∑ÂÆåÊï¥ËæìÂá∫‰ª•‰∏äÊâÄÊúâÈÉ®ÂàÜÔºåÁ°Æ‰øùÊ†ºÂºèÁæéËßÇ„ÄÅÂÜÖÂÆπÂÖÖÂÆû„ÄÇ`;
                }

                console.log('üéØ ÂºÄÂßãÁîüÊàêÂàùÊ≠•ÊïôÊ°à...');
                document.getElementById('initialPlanProgress').style.width = '50%';
                document.getElementById('initialPlanProgressText').textContent = 'Ê≠£Âú®Ë∞ÉÁî®AIÁîüÊàêÂàùÊ≠•ÊïôÊ°à...';
                
                const initialPlan = await callQwenAPI(initialPlanPrompt);
                
                if (initialPlan && initialPlan.trim().length > 50) {
                    // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
                    window.initialTeachingPlan = initialPlan;
                    
                    // ===== Á´ãÂç≥‰øùÂ≠òÂàùÂßãÊïôÊ°àÂà∞Êñá‰ª∂ÔºàÁ¨¨‰∏Ä‰∏™Êñá‰ª∂Ôºâ=====
                    const courseTitle = extractCourseTitle();
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                    const sessionFolderName = `${courseTitle}_${timestamp.substring(0, 10)}`;
                    
                    // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõÂÖ∂‰ªñÂú∞Êñπ‰ΩøÁî®
                    window.currentFolderName = sessionFolderName;
                    window.currentSessionFolderName = sessionFolderName;
                    
                    // ‰ΩøÁî® File System Access API Êàñ‰º†Áªü‰∏ãËΩΩ‰øùÂ≠òÂàùÂßãÊïôÊ°à
                    if (selectedFolderHandle) {
                        try {
                            let sessionFolder;
                            try {
                                sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                            } catch (e) {
                                sessionFolder = selectedFolderHandle;
                            }
                            await saveFileToFolder(sessionFolder, 'ÂàùÊ≠•ÊïôÊ°à.txt', initialPlan);
                            console.log('‚úÖ ÂàùÊ≠•ÊïôÊ°àÂ∑≤Áõ¥Êé•‰øùÂ≠òÂà∞Êñá‰ª∂Â§π');
                        } catch (e) {
                            console.error('‰øùÂ≠òÂàùÊ≠•ÊïôÊ°àÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                            downloadFileTraditional(`${sessionFolderName}/ÂàùÊ≠•ÊïôÊ°à.txt`, initialPlan, 'text/plain;charset=utf-8');
                        }
                    } else {
                        downloadFileTraditional(`${sessionFolderName}/ÂàùÊ≠•ÊïôÊ°à.txt`, initialPlan, 'text/plain;charset=utf-8');
                    }
                    
                    console.log(`üíæ ÂàùÊ≠•ÊïôÊ°àÂ∑≤‰øùÂ≠òÂà∞ÔºöE:\\edu material\\disscussion_result\\${sessionFolderName}\\ÂàùÊ≠•ÊïôÊ°à.txt`);
                    
                    // Ê†ºÂºèÂåñÂπ∂ÊòæÁ§∫ÂàùÊ≠•ÊïôÊ°à
                    document.getElementById('initialPlanContent').style.display = 'block';
                    
                    // Ê†ºÂºèÂåñÊïôÊ°àÂÜÖÂÆπÔºåÂ¢ûÂº∫ÂèØËØªÊÄß
                    const formattedPlan = formatTeachingPlan(initialPlan);
                    await typeText('initialPlanText', formattedPlan, 30);
                    
                    document.getElementById('initialPlanProgress').style.width = '100%';
                    document.getElementById('initialPlanProgressText').textContent = '‚úÖ ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂÆåÊàêÂπ∂Â∑≤‰øùÂ≠ò';
                    
                    console.log('‚úÖ ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÊàêÂäüÂπ∂Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂');
                    
                    // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËá™Âä®‰øùÂ≠ò
                    const supportsAutoSave = 'showDirectoryPicker' in window;
                    
                    if (supportsAutoSave) {
                        showMessage(`
                            <div style="text-align: left; line-height: 2;">
                                <strong style="font-size: 16px; color: #52c41a;">‚úÖ ÂàùÊ≠•ÊïôÊ°àÂ∑≤ÁîüÊàêÔºÅ</strong><br><br>
                                üöÄ ÊÇ®ÂèØ‰ª•ÁÇπÂáª‰∏ãÊñπÁöÑ<strong style="color: #13c2c2;">"ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf"</strong>ÊåâÈíÆÔºö<br><br>
                                <strong style="color: #1890ff;">‚ú® ÂÖ®Ëá™Âä®‰øùÂ≠òÊµÅÁ®ãÔºö</strong><br>
                                1Ô∏è‚É£ ÈÄâÊã©ÂèÇËÄÉPDFÊñá‰ª∂ÔºàÁî®‰∫éÊ†ºÂºèÂèÇËÄÉÔºâ<br>
                                2Ô∏è‚É£ ÈÄâÊã©‰øùÂ≠òÊñá‰ª∂Â§πÔºà<strong style="color: #faad14;">‰ªÖÈ¶ñÊ¨°ÈúÄË¶Å</strong>Ôºâ<br>
                                3Ô∏è‚É£ Á≥ªÁªüËá™Âä®ÁîüÊàêÂπ∂‰øùÂ≠òPDFÂà∞ËØ•Êñá‰ª∂Â§π<br><br>
                                üí° ‰πãÂêéÊØèÊ¨°ÂØºÂá∫ÈÉΩ‰ºö<strong style="color: #52c41a;">Ëá™Âä®‰øùÂ≠òÂà∞Áõ∏ÂêåÊñá‰ª∂Â§π</strong>ÔºåÊó†ÈúÄÈáçÂ§çÊìç‰ΩúÔºÅ<br>
                                üí° Âç≥Â∞ÜÂºÄÂßã‰∏ìÂÆ∂ÂàÜÊûêÔºåÂàÜÊûêÂÆåÊàêÂêéÂèØÂÜçÊ¨°‰∏ÄÈîÆÂØºÂá∫‰ºòÂåñÁâàÊïôÊ°à„ÄÇ
                            </div>
                        `, 'success', 10000);
                    } else {
                        showMessage(`
                            <div style="text-align: left; line-height: 2;">
                                <strong style="font-size: 16px; color: #52c41a;">‚úÖ ÂàùÊ≠•ÊïôÊ°àÂ∑≤ÁîüÊàêÔºÅ</strong><br><br>
                                üí° ÊÇ®ÂèØ‰ª•ÁÇπÂáª‰∏ãÊñπÁöÑ<strong style="color: #13c2c2;">"ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf"</strong>ÊåâÈíÆ„ÄÇ<br>
                                üí° Á≥ªÁªüÂ∞ÜËá™Âä®ÂºπÂá∫ÊâìÂç∞ÂØπËØùÊ°ÜÔºåËØ∑ÈÄâÊã©<strong style="color: #faad14;">"Âè¶Â≠ò‰∏∫PDF"</strong>‰øùÂ≠ò„ÄÇ<br>
                                üí° Âç≥Â∞ÜÂºÄÂßã‰∏ìÂÆ∂ÂàÜÊûêÔºåÂàÜÊûêÂÆåÊàêÂêéÂèØÂÜçÊ¨°ÂØºÂá∫‰ºòÂåñÁâàÊïôÊ°à„ÄÇ
                            </div>
                        `, 'success', 8000);
                    }
                } else {
                    throw new Error('ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
                }
                
                // Á≠âÂæÖ‰∏Ä‰∏ãÂÜçÁªßÁª≠
                await delay(1000);
                
            } catch (error) {
                console.error('ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂ§±Ë¥•:', error);
                document.getElementById('initialPlanProgress').style.width = '100%';
                document.getElementById('initialPlanProgress').style.background = 'linear-gradient(90deg, #ff4d4f, #ff7875)';
                document.getElementById('initialPlanProgressText').textContent = '‚ö†Ô∏è ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÂéüÂßãÊïôÊ°àÂÜÖÂÆπ';
                document.getElementById('initialPlanProgressText').style.color = '#ff4d4f';
                
                // ‰ΩøÁî®ÂéüÂßãÂÜÖÂÆπ‰Ωú‰∏∫Â§áÈÄâ
                window.initialTeachingPlan = parsedFileContent;
                showMessage('ÂàùÊ≠•ÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÂéüÂßãÊïôÊ°àÂÜÖÂÆπ', 'warning');
                
                await delay(1000);
            }
        }

        // Á¨¨‰∏ÄÈò∂ÊÆµÔºöÁã¨Á´ãÂàÜÊûê
        function startStage1Analysis() {
            updateProgress('stage1Progress', 'stage1ProgressText', 10, 'ÂºÄÂßã‰∏ìÂÆ∂Áã¨Á´ãÂàÜÊûê...');

            // Áõ¥Êé•ÂºÄÂßãÂàÜÊûêÔºå‰∏çÈúÄË¶ÅÊ∏ÖÁ©∫‰∏ìÂÆ∂Âç°Áâá
            // ‰ΩøÁî®ÂºÇÊ≠•ÊñπÂºèË∞ÉÁî®Ôºå‰∏çÂÜçÈúÄË¶Å callback
            agents.forEach((agent, index) => {
                setTimeout(() => {
                    // analyzeByAgent ÊòØ async ÂáΩÊï∞Ôºå‰ºöËá™Âä®Â§ÑÁêÜÂÆåÊàêÂêéÁöÑÈÄªËæë
                    analyzeByAgent(agent, 0).catch(error => {
                        console.error(`${agent.name} ÂàÜÊûêÂêØÂä®Â§±Ë¥•:`, error);
                    });
                }, index * 800);
            });
        }

        // ‰∏ªÊåÅ‰∫∫ÈÖçÁΩÆ
        const moderator = {
            key: 'moderator',
            name: 'ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫',
            specialty: 'ÊïôÁ†îËÆ®ËÆ∫ÂçèË∞ÉËÄÖ',
            color: '#fa8c16',
            avatar: '‰∏ª',
            model: 'qwen-plus' // ‰ΩøÁî®‰∏éqwenÁõ∏ÂêåÁöÑÊ®°Âûã
        };

        // AI‰∏ìÂÆ∂ÈÖçÁΩÆ
        const agents = [
            {
                key: 'qwen',
                name: 'ÈÄö‰πâÂçÉÈóÆ',
                specialty: 'ÊïôÊ°à‰ºòÂåñ‰∏ìÂÆ∂',
                color: '#1890ff',
                avatar: 'ÂçÉ'
            },
            {
                key: 'doubao',
                name: 'Ë±ÜÂåÖ',
                specialty: 'ÂàõÊñ∞ÊïôÂ≠¶‰∏ìÂÆ∂',
                color: '#52c41a',
                avatar: 'Ë±Ü'
            },
            {
                key: 'kimi',
                name: 'Kimi',
                specialty: 'Â≠¶ÁîüÂèÇ‰∏é‰∏ìÂÆ∂',
                color: '#722ed1',
                avatar: 'K'
            },
            {
                key: 'chatglm',
                name: 'Êô∫Ë∞±Ê∏ÖË®Ä',
                specialty: 'ËÆ§Áü•ÂèëÂ±ï‰∏ìÂÆ∂',
                color: '#eb2f96',
                avatar: 'Êô∫'
            },
            {
                key: 'deepseek',
                name: 'DeepSeek',
                specialty: 'Ê∑±Â∫¶Â≠¶‰π†‰∏ìÂÆ∂',
                color: '#13c2c2',
                avatar: 'Ê∑±'
            }
        ];

        // 5EÊïôÂ≠¶Ê®°ÂûãÈÖçÁΩÆ
        const fiveEModel = [
            {
                key: 'engage',
                name: 'ÂºïÂÖ•ÔºàEngageÔºâ',
                nameEn: 'Engage',
                description: 'Âê∏ÂºïÂ≠¶ÁîüÁöÑÊ≥®ÊÑèÂäõÂπ∂ÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇÊïôÂ∏àÂèØÊèêÂá∫ÈóÆÈ¢òÔºàÊÉÖÂ¢ÉÔºâÊàñÂà©Áî®ËÆ§Áü•ÂÜ≤Á™Å„ÄÇ',
                color: '#ff4d4f',
                icon: 'üéØ',
                keywords: ['ÂØºÂÖ•', 'ÂºïÂÖ•', 'ÊÉÖÂ¢É', 'ÊøÄË∂£', 'ÊèêÈóÆ', 'ÂºïÂØº', 'Ê≥®ÊÑèÂäõ', 'ÂÖ¥Ë∂£', 'ÈóÆÈ¢òÊÉÖÂ¢É', 'ÂØºËØæ']
            },
            {
                key: 'explore',
                name: 'Êé¢Á©∂ÔºàExploreÔºâ',
                nameEn: 'Explore',
                description: 'Â≠¶ÁîüÂü∫‰∫éÂ∑≤ÊúâÁü•ËØÜËøõË°åÊé¢Á©∂ÔºåÂª∫ÊûÑÊñ∞ÁöÑÊÑè‰πâÔºå‰π†ÂæóÊñ∞ÊäÄËÉΩ„ÄÇÊïôÂ∏à‰∏∫‰øÉËøõËÄÖÂíåÊøÄÊ¥ªËÄÖÔºåÊûÑÂª∫Â≠¶‰π†ÂÖ±Âêå‰Ωì„ÄÇ',
                color: '#1890ff',
                icon: 'üîç',
                keywords: ['Êé¢Á©∂', 'Êé¢Á¥¢', 'ÂÆûÈ™å', 'ËßÇÂØü', 'Ë∞ÉÊü•', 'Â∞èÁªÑÂêà‰Ωú', 'Ëá™‰∏ªÂ≠¶‰π†', 'Âä®ÊâãÊìç‰Ωú', 'ÂÆûË∑µÊ¥ªÂä®']
            },
            {
                key: 'explain',
                name: 'Ëß£ÈáäÔºàExplainÔºâ',
                nameEn: 'Explain',
                description: 'Â≠¶ÁîüËß£ÈáäÔºàËæìÂá∫ÔºâÊé¢Á¥¢ÁöÑÊî∂Ëé∑‰ª•‰øÉËøõÊàñÊ£ÄÈ™åÁêÜËß£ÂÖ≥ÈîÆÁöÑÁü•ËØÜÂíåÊ¶ÇÂøµÔºàÁªÑÂÜÖ‰∫§ÊµÅÊàñÂ∞èÁªÑÊ±áÊä•ÔºåÊïôÂ∏àÂºïÂØºÊàñËÆ≤ÊéàÔºâ„ÄÇ',
                color: '#52c41a',
                icon: 'üí°',
                keywords: ['Ëß£Èáä', 'ËÆ≤Ëß£', 'ÊÄªÁªì', 'ÂΩíÁ∫≥', 'Ê±áÊä•', 'ÂàÜ‰∫´', '‰∫§ÊµÅ', 'ËÆ®ËÆ∫', 'Ê¶ÇÂøµ', 'ËßÑÂæã', 'ÈòêËø∞']
            },
            {
                key: 'extend',
                name: 'Â∫îÁî®/ËøÅÁßªÔºàExtendÔºâ',
                nameEn: 'Extend',
                description: 'Â≠¶ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÂ∫îÁî®Áü•ËØÜÊù•Ëß£ÈáäÂèäËß£ÂÜ≥Êñ∞ÈóÆÈ¢òÔºàÂü∫‰∫éÊúÄËøëÂèëÂ±ïÂå∫Ôºâ„ÄÇ',
                color: '#722ed1',
                icon: 'üöÄ',
                keywords: ['Â∫îÁî®', 'ËøÅÁßª', 'ÊãìÂ±ï', 'Âª∂‰º∏', 'ÁªÉ‰π†', 'ÂÆûË∑µ', 'Ëß£ÂÜ≥ÈóÆÈ¢ò', 'Êñ∞ÊÉÖÂ¢É', 'ÂàõÊñ∞Â∫îÁî®']
            },
            {
                key: 'evaluate',
                name: 'ËØÑ‰º∞ÔºàEvaluateÔºâ',
                nameEn: 'Evaluate',
                description: 'Â§öÂÖÉËØÑ‰ª∑ÁúüÂÆûÂèçÈ¶àÂ≠¶‰π†„ÄÇÂΩ¢ÊàêÊÄßËØÑ‰º∞Ë¥ØÁ©øÊï¥‰∏™5EËøáÁ®ãÔºåÊÄªÁªìÊÄßËØÑ‰º∞ÂØπÁªìÊûúËøõË°åËØÑ‰ª∑„ÄÇ',
                color: '#fa8c16',
                icon: 'üìä',
                keywords: ['ËØÑ‰ª∑', 'ËØÑ‰º∞', 'ÂèçÈ¶à', 'Ê£ÄÊµã', '‰Ωú‰∏ö', 'ËÄÉÊ†∏', 'Ëá™ËØÑ', '‰∫íËØÑ', 'ÊÄªÁªì', 'ÂèçÊÄù']
            }
        ];

        // Â≠òÂÇ®5EÊ®°ÂûãÂàÜÊûêÁªìÊûú
        window.fiveEAnalysis = null;

        // ÂàùÂßãÂåñ‰∏ìÂÆ∂Âç°Áâá
        function initializeAgentCards() {
            const stage1Agents = document.getElementById('stage1Agents');
            if (!stage1Agents) return;

            stage1Agents.innerHTML = '';

            agents.forEach(agent => {
                const agentCard = document.createElement('div');
                agentCard.className = 'agent-card';
                agentCard.id = `agent-${agent.key}`;
                agentCard.innerHTML = `
                    <div class="agent-header">
                        <div class="agent-avatar" style="background: ${agent.color}">
                            ${agent.avatar}
                        </div>
                        <div class="agent-info">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-specialty">${agent.specialty}</div>
                        </div>
                        <span class="agent-status waiting">Á≠âÂæÖ‰∏≠</span>
                    </div>
                    <div class="agent-analysis" id="analysis-${agent.key}">
                        <!-- ÂàÜÊûêÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                `;
                stage1Agents.appendChild(agentCard);
            });
        }

        // Âçï‰∏™‰∏ìÂÆ∂ÂàÜÊûêÔºàÊµÅÂºèËæìÂá∫Ôºâ
        async function analyzeByAgent(agent, retryAttempt = 0) {
            const agentCard = document.getElementById(`agent-${agent.key}`);
            const statusElement = agentCard.querySelector('.agent-status');
            const analysisElement = document.getElementById(`analysis-${agent.key}`);

            // Êõ¥Êñ∞Áä∂ÊÄÅ‰∏∫ÂàÜÊûê‰∏≠
            agentCard.classList.add('analyzing');
            agentCard.classList.add('active-generation');
            const statusText = retryAttempt > 0 ? `ÂàÜÊûê‰∏≠ (ÈáçËØï${retryAttempt})` : 'ÂàÜÊûê‰∏≠';
            statusElement.textContent = statusText;
            statusElement.className = 'agent-status analyzing';

            // ‰ΩøÁî®Êñ∞ÁöÑÊªöÂä®ÁÆ°ÁêÜÂô®Ëá™Âä®ÊªöÂä®Âà∞Ê≠£Âú®ÂàÜÊûêÁöÑ‰∏ìÂÆ∂Âç°Áâá
            setTimeout(() => {
                ScrollManager.scrollTo(agentCard, { offset: window.innerHeight / 2.5 });
            }, 100);

            try {
                // Ê®°ÊãüÊµÅÂºèËæìÂá∫ËøáÁ®ã
                await simulateStreamingAnalysis(agent, analysisElement, statusElement);
                
                // ÂàÜÊûêÂÆåÊàêÂêéÁßªÈô§È´ò‰∫Æ
                setTimeout(() => {
                    agentCard.classList.remove('active-generation');
                }, 2000);
            } catch (error) {
                console.error(`${agent.name} ÂàÜÊûêÂá∫Áé∞ÈóÆÈ¢ò (Â∞ùËØï ${retryAttempt + 1}):`, error);
                
                // ÊòæÁ§∫ÈáçËØïÁä∂ÊÄÅ
                statusElement.textContent = `ÈáçËØï‰∏≠...`;
                statusElement.className = 'agent-status analyzing';
                
                // Êõ¥Êñ∞ÊòæÁ§∫ÔºåÂëäÁü•Áî®Êà∑Ê≠£Âú®ÈáçËØï
                const isTimeout = error.message && error.message.includes('Ë∂ÖÊó∂');
                const waitSeconds = isTimeout ? 2 : 3;
                analysisElement.innerHTML = `
                    <div class="analysis-item">
                        <div class="analysis-label" style="color: #faad14;">‚ö†Ô∏è ÂàÜÊûêÂ§±Ë¥•ÔºåÊ≠£Âú®ÈáçËØï...</div>
                        <div class="analysis-content" style="color: rgba(255,255,255,0.6);">
                            <strong>ÈîôËØØ‰ø°ÊÅØÔºö</strong>${error.message || 'ÁΩëÁªúÊàñAPIË∞ÉÁî®Â§±Ë¥•'}
                            <br><br>
                            <strong>ÈáçËØïËøõÂ∫¶Ôºö</strong>Á¨¨ ${retryAttempt + 1} Ê¨°ÈáçËØï
                            <br>
                            <strong>‰∏ãÊ¨°Â∞ùËØïÔºö</strong>${waitSeconds}ÁßíÂêé ${isTimeout ? '(APIË∂ÖÊó∂ÔºåÂ∑≤Âª∂ÈïøÁ≠âÂæÖÊó∂Èó¥)' : ''}
                            <br><br>
                            <small style="color: rgba(255,255,255,0.4);">
                            üí° ÊèêÁ§∫Ôºö${agent.name} ${isTimeout ? 'ÂìçÂ∫îËæÉÊÖ¢ÔºåÁ≥ªÁªüÂ∑≤Ëá™Âä®Âª∂ÈïøË∂ÖÊó∂Êó∂Èó¥Âπ∂‰ºòÂåñÂÜÖÂÆπÈïøÂ∫¶' : 'Ê≠£Âú®ÈáçÊñ∞Â∞ùËØïËøûÊé•'}
                            <br>
                            Â¶ÇÊûúÊåÅÁª≠Â§±Ë¥•ÔºåÂèØËÉΩÊòØ‰ª•‰∏ãÂéüÂõ†Ôºö
                            <br>‚Ä¢ APIÂØÜÈí•ÈÖçÁΩÆÈîôËØØÊàñÂ∑≤ËøáÊúü
                            <br>‚Ä¢ ÁΩëÁªúËøûÊé•‰∏çÁ®≥ÂÆö
                            <br>‚Ä¢ APIÊúçÂä°ÂΩìÂâçÁπÅÂøô
                            <br>‚Ä¢ APIÈÖçÈ¢ù‰∏çË∂≥ÊàñÈôêÊµÅ
                            <br><br>
                            ÂèØ‰ª•ÊâìÂºÄÊµèËßàÂô®ÊéßÂà∂Âè∞(F12)Êü•ÁúãËØ¶ÁªÜÊó•Âøó
                            </small>
                        </div>
                    </div>
                `;
                
                // Ê†πÊçÆÈîôËØØÁ±ªÂûãÁ≠âÂæÖ‰∏çÂêåÊó∂Èó¥
                await delay(waitSeconds * 1000);
                
                // ÈÄíÂΩíÈáçËØïÔºå‰∏çÈôêÂà∂Ê¨°Êï∞
                return await analyzeByAgent(agent, retryAttempt + 1);
            }
        }

        // Ê®°ÊãüÊµÅÂºèÂàÜÊûêËæìÂá∫
        async function simulateStreamingAnalysis(agent, analysisElement, statusElement) {
            // È¶ñÂÖàÊòæÁ§∫ÂàÜÊûêÊ°ÜÊû∂
            analysisElement.innerHTML = `
                <div class="analysis-item">
                    <div class="analysis-label">ÂÖ≥ÈîÆÂèëÁé∞:</div>
                    <div class="analysis-content streaming" id="findings-${agent.key}">Ê≠£Âú®ÂàÜÊûê‰∏≠...</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">‰∏ªË¶ÅÂª∫ËÆÆ:</div>
                    <div class="analysis-content streaming" id="recommendations-${agent.key}">Ê≠£Âú®ÁîüÊàêÂª∫ËÆÆ...</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">‰∏ì‰∏öËØÑÂàÜ:</div>
                    <div class="analysis-content streaming" id="score-${agent.key}">Ê≠£Âú®ËØÑ‰º∞‰∏≠...</div>
                </div>
            `;

            // Ê®°ÊãüÊÄùËÄÉËøáÁ®ã
            await delay(1000 + Math.random() * 2000);

            // Ë∞ÉÁî®ÁúüÂÆûÊàñÊ®°ÊãüÂàÜÊûê
            const analysis = await generateExpertAnalysis(agent, parsedFileContent);
            if (!analysis) {
                console.error(`${agent.name} ÂàÜÊûêÁªìÊûú‰∏∫Á©∫`);
                throw new Error('ÂàÜÊûêÁªìÊûú‰∏∫Á©∫');
            }

            analysisResults[agent.key] = analysis;

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÖçÈ¢ùÈîôËØØÁªìÊûú
            const isQuotaError = analysis.keyFindings && analysis.keyFindings.includes('ÈÖçÈ¢ù');
            
            // ÊµÅÂºèÊòæÁ§∫ÂÖ≥ÈîÆÂèëÁé∞
            if (analysis.keyFindings) {
                await typeText(`findings-${agent.key}`, analysis.keyFindings, isQuotaError ? 30 : 50);
            }

            // ÊµÅÂºèÊòæÁ§∫‰∏ªË¶ÅÂª∫ËÆÆ
            await delay(500);
            if (analysis.mainRecommendation) {
                await typeText(`recommendations-${agent.key}`, analysis.mainRecommendation, isQuotaError ? 30 : 50);
            }

            // ÊµÅÂºèÊòæÁ§∫‰∏ì‰∏öËØÑÂàÜ
            await delay(300);
            if (analysis.score !== undefined) {
                await typeText(`score-${agent.key}`, `${analysis.score}/10`, 100);
            }

            // Êõ¥Êñ∞Áä∂ÊÄÅ
            if (isQuotaError) {
                statusElement.textContent = '‚ö†Ô∏è ÈÖçÈ¢ùÈôêÂà∂';
                statusElement.className = 'agent-status';
                statusElement.style.background = 'rgba(250, 173, 20, 0.2)';
                statusElement.style.color = '#faad14';
                
                // ‰∏∫Âç°ÁâáÊ∑ªÂä†ÈÖçÈ¢ùÈîôËØØÊ†∑Âºè
                agentCard.style.border = '2px solid rgba(250, 173, 20, 0.3)';
                agentCard.style.background = 'rgba(250, 173, 20, 0.05)';
            } else {
                statusElement.textContent = 'Â∑≤ÂÆåÊàê';
                statusElement.className = 'agent-status completed';
            }

            // ÁßªÈô§ÊµÅÂºèÁ±ªÂêç
            const streamingElements = analysisElement.querySelectorAll('.streaming');
            streamingElements.forEach(el => el.classList.remove('streaming'));

            // Êõ¥Êñ∞ËøõÂ∫¶
            const completedCount = Object.keys(analysisResults).length;
            const progress = Math.min(90, 10 + (completedCount / agents.length) * 80);
            updateProgress('stage1Progress', 'stage1ProgressText', progress, `Â∑≤ÂÆåÊàê ${completedCount}/${agents.length} ‰Ωç‰∏ìÂÆ∂ÂàÜÊûê`);

            // Â¶ÇÊûúÊâÄÊúâ‰∏ìÂÆ∂ÈÉΩÂÆåÊàê‰∫ÜÔºåÂºÄÂßãÁ¨¨‰∫åÈò∂ÊÆµ
            if (completedCount === agents.length) {
                setTimeout(() => {
                    startStage2Discussion();
                }, 1000);
            }
        }

        // ÂÖ®Â±ÄÊªöÂä®ÁÆ°ÁêÜÂô®
        const ScrollManager = {
            isScrolling: false,
            lastScrollTime: 0,
            scrollThrottle: 100, // ËäÇÊµÅÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
            
            // Êô∫ËÉΩÊªöÂä®Âà∞ÂÖÉÁ¥†
            scrollTo(element, options = {}) {
                if (!element) return;
                
                const now = Date.now();
                if (this.isScrolling && (now - this.lastScrollTime) < this.scrollThrottle) {
                    return; // ËäÇÊµÅÔºåÈÅøÂÖçÈ¢ëÁπÅÊªöÂä®
                }
                
                this.isScrolling = true;
                this.lastScrollTime = now;
                
                // ÊâæÂà∞ÊúÄËøëÁöÑÂç°ÁâáÂÆπÂô®
                const card = element.closest('.card, .agent-card, .moderator-card, .discussion-round, .discussion-item, .stage-container');
                const targetElement = card || element;
                
                // Ê∑ªÂä†ÁîüÊàê‰∏≠ÁöÑÈ´ò‰∫ÆÊïàÊûú
                if (targetElement.classList.contains('card') || targetElement.classList.contains('stage-container')) {
                    targetElement.classList.add('active-generation');
                }
                
                // ËÆ°ÁÆóÊªöÂä®‰ΩçÁΩÆ
                const elementRect = targetElement.getBoundingClientRect();
                const absoluteElementTop = elementRect.top + window.pageYOffset;
                
                // Ê†πÊçÆÈÄâÈ°πË∞ÉÊï¥ÊªöÂä®‰ΩçÁΩÆ
                const offset = options.offset || (window.innerHeight / 3);
                const targetPosition = absoluteElementTop - offset;
                
                // Âπ≥ÊªëÊªöÂä®
                window.scrollTo({
                    top: Math.max(0, targetPosition),
                    behavior: options.behavior || 'smooth'
                });
                
                // ÊªöÂä®ÁªìÊùüÂêéÁßªÈô§È´ò‰∫ÆÔºà‰ΩÜ‰øùÊåÅ‰∏ÄÊÆµÊó∂Èó¥ËÆ©Áî®Êà∑ÁúãÂà∞Ôºâ
                setTimeout(() => {
                    this.isScrolling = false;
                }, this.scrollThrottle);
            },
            
            // ÁßªÈô§ÊâÄÊúâÁîüÊàêÈ´ò‰∫Æ
            clearActiveGeneration() {
                document.querySelectorAll('.active-generation').forEach(el => {
                    el.classList.remove('active-generation');
                });
            },
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºàÁî®‰∫éËÆ®ËÆ∫Âå∫ÂüüÔºâ
            scrollToBottom(container) {
                if (!container) return;
                container.scrollTop = container.scrollHeight;
            }
        };

        // ÊµÅÂºèËæìÂá∫ÊñáÊú¨ÊïàÊûúÔºàÂ∏¶Êô∫ËÉΩËá™Âä®ÊªöÂä®Ôºâ
        async function typeText(elementId, text, speed = 50) {
            const element = document.getElementById(elementId);
            if (!element) return;

            // Ê£ÄÊü•ÊñáÊú¨‰∏≠ÊòØÂê¶ÂåÖÂê´HTMLÊ†áÁ≠æÔºàÁâπÂà´ÊòØ5EÊ†áÊ≥®Ôºâ
            const hasHTML = /<span[^>]*>|<div[^>]*>/.test(text);
            
            if (hasHTML) {
                // Â¶ÇÊûúÂåÖÂê´HTMLÊ†áÁ≠æÔºåÁõ¥Êé•ËÆæÁΩÆinnerHTMLÔºà‰∏çÂÅöÊâìÂ≠óÊú∫ÊïàÊûúÔºåÈÅøÂÖçÁ†¥ÂùèHTMLÁªìÊûÑÔºâ
                element.innerHTML = text.replace(/\n/g, '<br>');
                ScrollManager.scrollTo(element);
                return;
            }

            // ÊôÆÈÄöÊñáÊú¨‰ΩøÁî®ÊâìÂ≠óÊú∫ÊïàÊûú
            element.textContent = '';
            const chars = text.split('');
            let lastScrollIndex = 0;

            for (let i = 0; i < chars.length; i++) {
                element.textContent += chars[i];
                
                // Êô∫ËÉΩÊªöÂä®ÔºöÊØèÊ∑ªÂä†20‰∏™Â≠óÁ¨¶ÊàñÂà∞ËææÊú´Â∞æÊó∂Ëá™Âä®ÊªöÂä®
                if (i - lastScrollIndex >= 20 || i === chars.length - 1) {
                    ScrollManager.scrollTo(element);
                    lastScrollIndex = i;
                }
                
                await delay(speed);
            }
            
            // ÊñáÊú¨ÁîüÊàêÂÆåÊàêÂêéÔºåÂª∂ËøüÁßªÈô§È´ò‰∫ÆÊïàÊûú
            setTimeout(() => {
                const card = element.closest('.card, .stage-container');
                if (card) {
                    card.classList.remove('active-generation');
                }
            }, 2000);
        }

        // Ëá™Âä®ÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        function scrollToElement(element, options) {
            ScrollManager.scrollTo(element, options);
        }

        // Âª∂ËøüÂáΩÊï∞
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ÁîüÊàê‰∏ìÂÆ∂ÂàÜÊûêÁªìÊûúÔºàÁúüÂÆûAIÁîüÊàêÔºåÂ∏¶ÈáçËØïÊú∫Âà∂Ôºâ
        async function generateExpertAnalysis(agent, content, retryCount = 0) {
            // Ê†πÊçÆ‰∏çÂêåAPIËÆæÁΩÆ‰∏çÂêåÁöÑË∂ÖÊó∂Êó∂Èó¥ÔºàÊüê‰∫õAPIËæÉÊÖ¢Ôºâ
            const TIMEOUT = agent.key === 'deepseek' || agent.key === 'doubao' ? 60000 : 45000; // DeepSeekÂíåË±ÜÂåÖ60ÁßíÔºåÂÖ∂‰ªñ45Áßí

            // È™åËØÅËæìÂÖ•ÂèÇÊï∞
            if (!content || content.trim().length === 0) {
                console.error(`${agent.name} ÂàÜÊûêÔºöÂÜÖÂÆπ‰∏∫Á©∫`);
                throw new Error('ÊïôÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ïËøõË°åÂàÜÊûê');
            }

            // ‰ΩøÁî®ÂàùÊ≠•ÊïôÊ°à‰Ωú‰∏∫ÂàÜÊûêÂü∫Á°ÄÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const teachingPlan = window.initialTeachingPlan || content;

            // ===== Ë∞ÉËØï‰ø°ÊÅØ =====
            console.log(`\nü§ñ AIÂàÜÊûêÂºÄÂßã - ${agent.name} (Â∞ùËØï ${retryCount + 1})`);
            console.log(`üì• ÂéüÂßãÂÜÖÂÆπÈïøÂ∫¶: ${teachingPlan.length} Â≠óÁ¨¶`);
            console.log(`‚è±Ô∏è Ë∂ÖÊó∂ËÆæÁΩÆ: ${TIMEOUT/1000}Áßí`);
            console.log(`‰ΩøÁî®ÂÜÖÂÆπ: ${window.initialTeachingPlan ? 'ÂàùÊ≠•ÊïôÊ°à' : 'ÂéüÂßãËß£ÊûêÂÜÖÂÆπ'}`);

            try {
                // ÊûÑÂª∫‰∏ì‰∏öÂåñÁöÑprompt
                const promptTemplates = {
                    'qwen': {
                        specialty: 'ÊïôÊ°à‰ºòÂåñ',
                        focus: 'ÊïôÂ≠¶ÊµÅÁ®ã„ÄÅÁõÆÊ†áËÆæËÆ°„ÄÅÊïôÂ≠¶ÊñπÊ≥ïÁöÑ‰ºòÂåñ',
                        maxLength: 2500
                    },
                    'doubao': {
                        specialty: 'ÂàõÊñ∞ÊïôÂ≠¶',
                        focus: 'ÂàõÊñ∞ÊïôÂ≠¶ÊñπÊ≥ï„ÄÅÈ°πÁõÆÂºèÂ≠¶‰π†„ÄÅÁé∞‰ª£ÊïôÂ≠¶ÊäÄÊúØÁöÑÂ∫îÁî®',
                        maxLength: 2000 // Ë±ÜÂåÖËæÉÊÖ¢ÔºåÂáèÂ∞ëÂÜÖÂÆπ
                    },
                    'kimi': {
                        specialty: 'Â≠¶ÁîüÂèÇ‰∏é',
                        focus: 'Â≠¶ÁîüÂèÇ‰∏éÂ∫¶„ÄÅ‰∫íÂä®ËÆæËÆ°„ÄÅÂ≠¶‰π†‰ΩìÈ™åÁöÑÊèêÂçá',
                        maxLength: 2500
                    },
                    'chatglm': {
                        specialty: 'ËÆ§Áü•ÂèëÂ±ï',
                        focus: 'Â≠¶ÁîüËÆ§Áü•ËßÑÂæã„ÄÅÊÄùÁª¥ËÆ≠ÁªÉ„ÄÅÁü•ËØÜÂª∫ÊûÑÁöÑÁßëÂ≠¶ÊÄß',
                        maxLength: 2500
                    },
                    'deepseek': {
                        specialty: 'Ê∑±Â∫¶Â≠¶‰π†',
                        focus: 'Ê¶ÇÂøµÁêÜËß£„ÄÅÁü•ËØÜËøÅÁßª„ÄÅÊ∑±Â±ÇÊ¨°Â≠¶‰π†ËÉΩÂäõÁöÑÂüπÂÖª',
                        maxLength: 1800 // DeepSeekËæÉÊÖ¢ÔºåËøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂÜÖÂÆπ
                    }
                };

                const template = promptTemplates[agent.key] || { specialty: 'ÊïôÂ≠¶', focus: 'ÊïôÂ≠¶Ë¥®Èáè', maxLength: 2500 };
                
                // Ê†πÊçÆ‰∏çÂêåAIÈôêÂà∂ÂÜÖÂÆπÈïøÂ∫¶
                const contentToAnalyze = teachingPlan.substring(0, template.maxLength);
                console.log(`üì§ ÂÆûÈôÖÂèëÈÄÅÈïøÂ∫¶: ${contentToAnalyze.length} Â≠óÁ¨¶`);
                
                const prompt = `‰Ω†ÊòØ‰∏Ä‰Ωç${agent.specialty}ÔºåËØ∑Âø´ÈÄüÂàÜÊûê‰ª•‰∏ãÊïôÊ°àÔºå‰ªé${template.focus}ËßíÂ∫¶Êèê‰æõËØÑ‰ª∑„ÄÇ

ÊïôÊ°àÂÜÖÂÆπÔºö
${contentToAnalyze}${teachingPlan.length > template.maxLength ? '...[ÂÜÖÂÆπÂ∑≤Êà™Âèñ]' : ''}

ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËæìÂá∫ÔºàÁÆÄÊ¥ÅÊòéÁ°ÆÔºâÔºö

ÂÖ≥ÈîÆÂèëÁé∞Ôºö[‰ªé${template.specialty}ËßíÂ∫¶ÂèëÁé∞ÁöÑÈóÆÈ¢òÊàñ‰∫ÆÁÇπÔºå50-80Â≠ó]

‰∏ªË¶ÅÂª∫ËÆÆÔºö[ÂÖ∑‰ΩìÂèØÊìç‰ΩúÁöÑÊîπËøõÂª∫ËÆÆÔºå60-100Â≠ó]

‰∏ì‰∏öËØÑÂàÜÔºö[1-10ÂàÜÂèäÁêÜÁî±]

Ê≥®ÊÑèÔºöÂü∫‰∫éÂÆûÈôÖÂÜÖÂÆπÂàÜÊûêÔºåÁÆÄÊ¥Å‰∏ì‰∏ö„ÄÇ`;

                console.log(`üì§ Ë∞ÉÁî®${agent.name} API...`);
                
                // Ê†πÊçÆ‰∏ìÂÆ∂Á±ªÂûãË∞ÉÁî®ÂØπÂ∫îAPIÔºåÊ∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂
                const apiCallPromise = (async () => {
                    let apiResponse = '';
                    if (agent.key === 'qwen') {
                        apiResponse = await callQwenAPI(prompt);
                    } else if (agent.key === 'doubao') {
                        apiResponse = await callDoubaoAPI(prompt);
                    } else if (agent.key === 'kimi') {
                        apiResponse = await callKimiAPI(prompt);
                    } else if (agent.key === 'chatglm') {
                        apiResponse = await callChatGLMAPI(prompt);
                    } else if (agent.key === 'deepseek') {
                        apiResponse = await callDeepSeekAPI(prompt);
                    } else {
                        throw new Error(`‰∏çÊîØÊåÅÁöÑ‰∏ìÂÆ∂Á±ªÂûã: ${agent.key}`);
                    }
                    return apiResponse;
                })();

                // ËÆæÁΩÆË∂ÖÊó∂
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('APIË∞ÉÁî®Ë∂ÖÊó∂')), TIMEOUT);
                });

                const apiResponse = await Promise.race([apiCallPromise, timeoutPromise]);

                // È™åËØÅÂìçÂ∫îÂÜÖÂÆπ
                if (!apiResponse || apiResponse.trim().length < 50) {
                    console.error(`‚ùå APIÂìçÂ∫îÂÜÖÂÆπËøáÁü≠ÔºåÂÆûÈôÖÂìçÂ∫î:`, apiResponse);
                    throw new Error(`APIÂìçÂ∫îÂÜÖÂÆπËøáÁü≠Êàñ‰∏∫Á©∫ (ÈïøÂ∫¶: ${apiResponse?.length || 0})`);
                }

                console.log(`‚úÖ ${agent.name} APIÂìçÂ∫îÊàêÂäüÔºåÈïøÂ∫¶: ${apiResponse.length}`);
                console.log(`üìÑ APIÂìçÂ∫îÈ¢ÑËßà: ${apiResponse.substring(0, 200)}...`);
                
                // Ëß£ÊûêÂìçÂ∫î
                const analysis = parseAnalysisResponse(apiResponse, agent);
                
                console.log(`üîç Ëß£ÊûêÁªìÊûú:`, {
                    keyFindings: analysis.keyFindings?.substring(0, 50) + '...',
                    mainRecommendation: analysis.mainRecommendation?.substring(0, 50) + '...',
                    score: analysis.score
                });
                
                // ÊîæÂÆΩÈ™åËØÅÊù°‰ª∂ÔºåÂè™Ë¶ÅÊúâÂÜÖÂÆπÂ∞±Ë°å
                if (!analysis.keyFindings || analysis.keyFindings.length < 10) {
                    console.error(`‚ùå ÂÖ≥ÈîÆÂèëÁé∞ËøáÁü≠: "${analysis.keyFindings}"`);
                    console.error(`ÂÆåÊï¥APIÂìçÂ∫î:`, apiResponse);
                    throw new Error(`ÂÖ≥ÈîÆÂèëÁé∞Ëß£ÊûêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠ (ÈïøÂ∫¶: ${analysis.keyFindings?.length || 0})`);
                }
                if (!analysis.mainRecommendation || analysis.mainRecommendation.length < 10) {
                    console.error(`‚ùå ‰∏ªË¶ÅÂª∫ËÆÆËøáÁü≠: "${analysis.mainRecommendation}"`);
                    console.error(`ÂÆåÊï¥APIÂìçÂ∫î:`, apiResponse);
                    throw new Error(`‰∏ªË¶ÅÂª∫ËÆÆËß£ÊûêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠ (ÈïøÂ∫¶: ${analysis.mainRecommendation?.length || 0})`);
                }
                if (!analysis.score || analysis.score < 1 || analysis.score > 10) {
                    console.warn(`‚ö†Ô∏è ËØÑÂàÜÊó†ÊïàÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº: ${analysis.score}`);
                    analysis.score = 7.5; // ‰ΩøÁî®ÈªòËÆ§ÂàÜÊï∞ËÄå‰∏çÊòØÂ§±Ë¥•
                }

                console.log(`‚úÖ ${agent.name} ÂàÜÊûêÂÆåÊàê`);
                console.log(`   ÂÖ≥ÈîÆÂèëÁé∞: ${analysis.keyFindings.substring(0, 50)}...`);
                console.log(`   ‰∏ªË¶ÅÂª∫ËÆÆ: ${analysis.mainRecommendation.substring(0, 50)}...`);
                console.log(`   ‰∏ì‰∏öËØÑÂàÜ: ${analysis.score}/10`);
                
                return analysis;

            } catch (error) {
                console.error(`‚ùå ${agent.name} ÂàÜÊûêÂ§±Ë¥• (Â∞ùËØï ${retryCount + 1}):`, error.message);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÖçÈ¢ùÈôêÂà∂ÈîôËØØ
                const isQuotaError = error.message.includes('429') || 
                                   error.message.includes('ÈÖçÈ¢ù') || 
                                   error.message.includes('ÈôêÂà∂');
                
                if (isQuotaError) {
                    console.warn(`‚ö†Ô∏è ${agent.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºå‰ΩøÁî®ÂÖúÂ∫ïÊñπÊ°à`);
                    // Ê†áËÆ∞ËØ•APIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω
                    markAPIQuotaExhausted(agent.key);
                    return {
                        keyFindings: `${agent.name}ÁöÑAPIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºà429ÈîôËØØÔºâÔºåÊöÇÊó∂Êó†Ê≥ïÊèê‰æõÂàÜÊûê„ÄÇÂª∫ËÆÆÔºö1) Ê£ÄÊü•APIÈÖçÈ¢ùÁä∂ÊÄÅÔºõ2) Á≠âÂæÖÈÖçÈ¢ùÈáçÁΩÆÔºõ3) ÊàñÊõ¥Êç¢APIÂØÜÈí•„ÄÇ`,
                        mainRecommendation: `Áî±‰∫éAPIÈÖçÈ¢ùÈôêÂà∂Ôºå${agent.name}ÊöÇÊó∂Êó†Ê≥ïÂèÇ‰∏éÂàÜÊûê„ÄÇÂÖ∂‰ªñ‰∏ìÂÆ∂ÁöÑÂàÜÊûêÁªìÊûú‰ªçÁÑ∂ÊúâÊïàÔºåÂèØ‰ª•ÁªßÁª≠‰ΩøÁî®„ÄÇ`,
                        score: 7.0
                    };
                }
                
                // Â¶ÇÊûúÈáçËØïÊ¨°Êï∞ËøáÂ§öÔºå‰ΩøÁî®ÂÖúÂ∫ïÊñπÊ°à
                if (retryCount >= 5) {
                    console.warn(`‚ö†Ô∏è ${agent.name} Â∑≤ÈáçËØï${retryCount}Ê¨°Ôºå‰ΩøÁî®ÂÖúÂ∫ïÊñπÊ°à`);
                    return {
                        keyFindings: `${agent.name}ÁªèËøáÂ§öÊ¨°Â∞ùËØïÂêé‰ªçÊó†Ê≥ïÁîüÊàêÂÆåÊï¥ÂàÜÊûê„ÄÇËøôÂèØËÉΩÊòØÁî±‰∫éAPIÂìçÂ∫îË∂ÖÊó∂„ÄÅÁΩëÁªúÈóÆÈ¢òÊàñÊúçÂä°ÁπÅÂøôÂØºËá¥ÁöÑ„ÄÇ`,
                        mainRecommendation: `Âª∫ËÆÆÊ£ÄÊü•Ôºö1) APIÂØÜÈí•ÊòØÂê¶Ê≠£Á°ÆÈÖçÁΩÆÔºõ2) ÁΩëÁªúËøûÊé•ÊòØÂê¶Á®≥ÂÆöÔºõ3) APIÈÖçÈ¢ùÊòØÂê¶ÂÖÖË∂≥Ôºõ4) ÂΩìÂâçÊúçÂä°ÊòØÂê¶ÁπÅÂøô„ÄÇ`,
                        score: 7.0
                    };
                }
                
                // Ê†πÊçÆÈîôËØØÁ±ªÂûãÂÜ≥ÂÆöÁ≠âÂæÖÊó∂Èó¥
                const isTimeout = error.message && error.message.includes('Ë∂ÖÊó∂');
                const waitTime = isTimeout ? 2000 : 3000; // Ë∂ÖÊó∂ÈîôËØØÁ≠â2ÁßíÔºåÂÖ∂‰ªñÁ≠â3Áßí
                
                console.log(`${agent.name} Â∞ÜÂú®${waitTime/1000}ÁßíÂêéËøõË°åÁ¨¨${retryCount + 2}Ê¨°Â∞ùËØï... ${isTimeout ? '(Ë∂ÖÊó∂ÈáçËØï)' : ''}`);
                await delay(waitTime);
                return await generateExpertAnalysis(agent, content, retryCount + 1);
            }
        }

        // Ëß£ÊûêÂàÜÊûêÂìçÂ∫îÔºàÊîπËøõÁâàÔºåÊîØÊåÅÂ§öÁßçÊ†ºÂºèÔºâ
        function parseAnalysisResponse(apiResponse, agent) {
            // ÂàùÂßãÂåñÈªòËÆ§ÂÄº
            let keyFindings = '';
            let mainRecommendation = '';
            let score = 7.5;

            try {
                const lines = apiResponse.split('\n');
                let inKeyFindings = false;
                let inRecommendation = false;
                let keyFindingsLines = [];
                let recommendationLines = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Ê£ÄÊµãÂÖ≥ÈîÆÂèëÁé∞ÂºÄÂßã
                    if (line.match(/ÂÖ≥ÈîÆÂèëÁé∞[Ôºö:]/i)) {
                        inKeyFindings = true;
                        inRecommendation = false;
                        // ÊèêÂèñÂΩìÂâçË°åÁöÑÂÜÖÂÆπÔºàÂ¶ÇÊûúÊúâÔºâ
                        const content = line.replace(/.*?ÂÖ≥ÈîÆÂèëÁé∞[Ôºö:]\s*/i, '').trim();
                        if (content && content.length > 5) {
                            keyFindingsLines.push(content);
                        }
                        continue;
                    }
                    
                    // Ê£ÄÊµã‰∏ªË¶ÅÂª∫ËÆÆÂºÄÂßã
                    if (line.match(/‰∏ªË¶ÅÂª∫ËÆÆ[Ôºö:]/i)) {
                        inKeyFindings = false;
                        inRecommendation = true;
                        // ÊèêÂèñÂΩìÂâçË°åÁöÑÂÜÖÂÆπÔºàÂ¶ÇÊûúÊúâÔºâ
                        const content = line.replace(/.*?‰∏ªË¶ÅÂª∫ËÆÆ[Ôºö:]\s*/i, '').trim();
                        if (content && content.length > 5) {
                            recommendationLines.push(content);
                        }
                        continue;
                    }
                    
                    // Ê£ÄÊµã‰∏ì‰∏öËØÑÂàÜ
                    if (line.match(/‰∏ì‰∏öËØÑÂàÜ[Ôºö:]/i)) {
                        inKeyFindings = false;
                        inRecommendation = false;
                        const scoreMatch = line.match(/(\d+(?:\.\d+)?)/);
                        if (scoreMatch) {
                            score = parseFloat(scoreMatch[1]);
                            score = Math.max(1, Math.min(10, score)); // Á°Æ‰øùÂú®1-10ËåÉÂõ¥ÂÜÖ
                        }
                        continue;
                    }
                    
                    // Êî∂ÈõÜÂÖ≥ÈîÆÂèëÁé∞ÁöÑÂÜÖÂÆπ
                    if (inKeyFindings && line.length > 5 && !line.match(/^(‰∏ªË¶ÅÂª∫ËÆÆ|‰∏ì‰∏öËØÑÂàÜ)[Ôºö:]/i)) {
                        keyFindingsLines.push(line);
                    }
                    
                    // Êî∂ÈõÜ‰∏ªË¶ÅÂª∫ËÆÆÁöÑÂÜÖÂÆπ
                    if (inRecommendation && line.length > 5 && !line.match(/^(‰∏ì‰∏öËØÑÂàÜ)[Ôºö:]/i)) {
                        recommendationLines.push(line);
                    }
                }

                // ÁªÑÂêàÊî∂ÈõÜÁöÑÂÜÖÂÆπ
                keyFindings = keyFindingsLines.join(' ').trim();
                mainRecommendation = recommendationLines.join(' ').trim();

                // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§öÁßçÊ®°ÂºèÊèêÂèñ
                if (!keyFindings || keyFindings.length < 10) {
                    // Â∞ùËØïÂ§öÁßçÂåπÈÖçÊ®°Âºè
                    const patterns = [
                        /ÂÖ≥ÈîÆÂèëÁé∞[Ôºö:]\s*([^ÂÖ≥‰∏ª‰∏ì\n]+(?:\n[^ÂÖ≥‰∏ª‰∏ì][^\n]+)*)/i,
                        /ÂèëÁé∞[Ôºö:]\s*([^ÂÖ≥‰∏ª‰∏ì\n]+(?:\n[^ÂÖ≥‰∏ª‰∏ì][^\n]+)*)/i,
                        /ÈóÆÈ¢ò[Ôºö:]\s*([^ÂÖ≥‰∏ª‰∏ì\n]+(?:\n[^ÂÖ≥‰∏ª‰∏ì][^\n]+)*)/i,
                    ];
                    for (const pattern of patterns) {
                        const match = apiResponse.match(pattern);
                        if (match && match[1].trim().length > 10) {
                            keyFindings = match[1].trim();
                            break;
                        }
                    }
                }

                if (!mainRecommendation || mainRecommendation.length < 10) {
                    // Â∞ùËØïÂ§öÁßçÂåπÈÖçÊ®°Âºè
                    const patterns = [
                        /‰∏ªË¶ÅÂª∫ËÆÆ[Ôºö:]\s*([^ÂÖ≥‰∏ª‰∏ì\n]+(?:\n[^‰∏ìËØÑÂàÜ][^\n]+)*)/i,
                        /Âª∫ËÆÆ[Ôºö:]\s*([^ÂÖ≥‰∏ª‰∏ì\n]+(?:\n[^‰∏ìËØÑÂàÜ][^\n]+)*)/i,
                        /ÊîπËøõ[Ôºö:]\s*([^ÂÖ≥‰∏ª‰∏ì\n]+(?:\n[^‰∏ìËØÑÂàÜ][^\n]+)*)/i,
                    ];
                    for (const pattern of patterns) {
                        const match = apiResponse.match(pattern);
                        if (match && match[1].trim().length > 10) {
                            mainRecommendation = match[1].trim();
                            break;
                        }
                    }
                }
                
                // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÔºåÂ∞ùËØïÁõ¥Êé•‰ΩøÁî®ÂìçÂ∫îÂÜÖÂÆπ
                if (!keyFindings || keyFindings.length < 10) {
                    console.warn(`‚ö†Ô∏è Êó†Ê≥ïËß£ÊûêÂÖ≥ÈîÆÂèëÁé∞Ôºå‰ΩøÁî®ÈÉ®ÂàÜÂìçÂ∫îÂÜÖÂÆπ`);
                    // ÂèñÂìçÂ∫îÁöÑÂâç‰∏ÄÈÉ®ÂàÜ‰Ωú‰∏∫ÂÖ≥ÈîÆÂèëÁé∞
                    const firstPart = apiResponse.substring(0, 200).trim();
                    if (firstPart.length > 20) {
                        keyFindings = firstPart + '...';
                    }
                }
                
                if (!mainRecommendation || mainRecommendation.length < 10) {
                    console.warn(`‚ö†Ô∏è Êó†Ê≥ïËß£Êûê‰∏ªË¶ÅÂª∫ËÆÆÔºå‰ΩøÁî®ÈÉ®ÂàÜÂìçÂ∫îÂÜÖÂÆπ`);
                    // ÂèñÂìçÂ∫îÁöÑ‰∏≠Èó¥ÈÉ®ÂàÜ‰Ωú‰∏∫Âª∫ËÆÆ
                    const midPart = apiResponse.substring(200, 400).trim();
                    if (midPart.length > 20) {
                        mainRecommendation = midPart + '...';
                    }
                }

                // ÊúÄÁªàÈ™åËØÅ
                if (!keyFindings || keyFindings.length < 10) {
                    keyFindings = `‰ªé${agent.specialty}ËßíÂ∫¶ÂàÜÊûêÔºåËØ•ÊïôÊ°àÊúâ‰∏ÄÂÆöÁöÑ‰ºòÁÇπÔºå‰ΩÜ‰ªçÊúâÊîπËøõÁ©∫Èó¥„ÄÇ`;
                }
                
                if (!mainRecommendation || mainRecommendation.length < 10) {
                    mainRecommendation = `Âª∫ËÆÆ‰ªé${agent.specialty}ÁöÑËßíÂ∫¶Ëøõ‰∏ÄÊ≠•‰ºòÂåñÊïôÊ°àËÆæËÆ°ÔºåÊèêÂçáÊïôÂ≠¶ÊïàÊûú„ÄÇ`;
                }

                // Ê∏ÖÁêÜÂ§ö‰ΩôÁ©∫Ê†º
                keyFindings = keyFindings.replace(/\s+/g, ' ').trim();
                mainRecommendation = mainRecommendation.replace(/\s+/g, ' ').trim();

            } catch (error) {
                console.error('Ëß£ÊûêÂìçÂ∫îÊó∂Âá∫Èîô:', error);
                keyFindings = `${agent.name}Ê≠£Âú®ÂàÜÊûê‰∏≠...`;
                mainRecommendation = 'Ê≠£Âú®ÁîüÊàê‰∏ì‰∏öÂª∫ËÆÆ...';
            }

            return {
                keyFindings,
                mainRecommendation,
                score
            };
        }

        // ÊòæÁ§∫ÂíåÁßªÂä®ÊºîÁ§∫ÊùêÊñôÂàóË°®Âà∞Á¨¨‰∫åÈò∂ÊÆµ‰πãÂêé
        async function showGeneratedMaterialsSection() {
            const materialsListDiv = document.getElementById('generatedMaterialsList');
            const stage2Container = document.getElementById('stage2Container');
            const container = document.querySelector('.container');
            
            // ===== ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÊâÄÊúâÂøÖË¶ÅÂÖÉÁ¥†Â≠òÂú® =====
            if (!container) {
                console.error('‚ùå containerÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊòæÁ§∫ÊùêÊñôÂàóË°®');
                return;
            }
            
            if (!materialsListDiv) {
                console.error('‚ùå materialsListDivÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }
            
            if (materialsListDiv && stage2Container && container) {
                // ÁßªÂä®ÊùêÊñôÂàóË°®Âà∞Á¨¨‰∫åÈò∂ÊÆµ‰πãÂêéÔºàÂÆâÂÖ®ÊèíÂÖ•Ôºâ
                const apiTestSection = document.getElementById('apiTestSection');
                
                try {
                    // Âº∫ÂåñÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
                    if (!container || !(container instanceof HTMLElement) || !document.body.contains(container)) {
                        console.error('‚ùå containerÊó†ÊïàÊàñ‰∏çÂú®DOM‰∏≠');
                        return;
                    }
                    
                    // È™åËØÅÊâÄÊúâÂøÖË¶ÅÂÖÉÁ¥†ÈÉΩÂ≠òÂú®
                    if (!container.contains(materialsListDiv)) {
                        console.error('‚ùå materialsListDiv‰∏çÂú®container‰∏≠');
                        return;
                    }
                    
                    if (stage2Container && stage2Container.nextSibling && container.contains(stage2Container)) {
                        container.insertBefore(materialsListDiv, stage2Container.nextSibling);
                    } else if (apiTestSection && container.contains(apiTestSection)) {
                        container.insertBefore(materialsListDiv, apiTestSection);
                    } else {
                        container.appendChild(materialsListDiv);
                    }
                } catch (error) {
                    console.error('‚ùå ÊèíÂÖ•materialsListDivÂ§±Ë¥•Ôºå‰ΩøÁî®appendChild:', error);
                    try {
                        if (container && container.appendChild) {
                            container.appendChild(materialsListDiv);
                        }
                    } catch (appendError) {
                        console.error('‚ùå appendChild‰πüÂ§±Ë¥•‰∫Ü:', appendError);
                        return;
                    }
                }
                
                // ÊòæÁ§∫ÊùêÊñôÂàóË°®
                materialsListDiv.classList.remove('hidden');
                
                // ÊªöÂä®Âà∞ÊùêÊñôÂàóË°®
                setTimeout(() => {
                    ScrollManager.scrollTo(materialsListDiv, { offset: 80 });
                }, 100);
            }
        }

        // Á¨¨‰∫åÈò∂ÊÆµÔºö‰∫§ÂèâËÆ®ËÆ∫
        async function startStage2Discussion(previousAcceptedOpinions = null) {
            // ===== È¢ÑÂÖàÈ™åËØÅDOMÁéØÂ¢ÉÔºåÈÅøÂÖçÂºÇÊ≠•Êìç‰ΩúÂêéÂÖÉÁ¥†Ê∂àÂ§± =====
            const container = document.querySelector('.container');
            
            // ===== ÂÖ≥ÈîÆÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÂ≠òÂú® =====
            if (!container) {
                console.error('‚ùå Ëá¥ÂëΩÈîôËØØÔºö.containerÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÂàõÂª∫Á¨¨‰∫åÈò∂ÊÆµ');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÆπÂô®‰∏¢Â§±ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            if (!(container instanceof HTMLElement) || !document.body.contains(container)) {
                console.error('‚ùå container‰∏çÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†Êàñ‰∏çÂú®ÊñáÊ°£‰∏≠');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÆπÂô®Êó†ÊïàÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            // ===== ÂàùÂßãÂåñÂÖ®Â±ÄËßÇÁÇπÊî∂ÈõÜÂàóË°®ÔºàÂº∫Âà∂‰ΩøÁî®Â∑≤ÊúâÊï∞ÊçÆÔºåÁªù‰∏çÊ∏ÖÁ©∫Ôºâ=====
            // È¶ñÂÖàÂ∞ùËØï‰ªélocalStorageÊÅ¢Â§çÔºàÊúÄ‰ºòÂÖàÔºâ
            if (typeof _allAcceptedOpinions === 'undefined' || _allAcceptedOpinions.length === 0) {
                try {
                    const backupData = localStorage.getItem('allAcceptedOpinions_backup');
                    if (backupData) {
                        const parsed = JSON.parse(backupData);
                        if (parsed.opinions && parsed.opinions.length > 0) {
                            _allAcceptedOpinions = parsed.opinions;
                            console.log(`%cüîÑ ‰ªélocalStorageÊÅ¢Â§ç‰∫Ü ${_allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`, 'color: #52c41a; font-weight: bold;');
                            console.log(`   ÊÅ¢Â§çÊó∂Èó¥Ôºö${parsed.timestamp}`);
                        } else {
                            // Âè™ÊúâÂú®Â§á‰ªΩ‰πüÊòØÁ©∫ÁöÑÊÉÖÂÜµ‰∏ãÔºåÊâçÂàùÂßãÂåñ‰∏∫Á©∫Êï∞ÁªÑ
                            if (!_allAcceptedOpinions) {
                                _allAcceptedOpinions = [];
                                console.log('üîß ÂàùÂßãÂåñ _allAcceptedOpinions ‰∏∫Á©∫Êï∞ÁªÑÔºàÈ¶ñÊ¨°ËøêË°åÔºâ');
                            }
                        }
                    } else {
                        if (!_allAcceptedOpinions) {
                            _allAcceptedOpinions = [];
                            console.log('üîß ÂàùÂßãÂåñ _allAcceptedOpinions ‰∏∫Á©∫Êï∞ÁªÑÔºàÊó†Â§á‰ªΩÔºâ');
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è localStorageÊÅ¢Â§çÂ§±Ë¥•:', e.message);
                    if (!_allAcceptedOpinions) {
                        _allAcceptedOpinions = [];
                    }
                }
            } else {
                const currentOpinions = getAllAcceptedOpinions();
                console.log(`%c‚úÖ ËßÇÁÇπÊï∞ÁªÑÂ∑≤Â≠òÂú®ÔºåÂΩìÂâçÂåÖÂê´ ${currentOpinions.length} ‰∏™ËßÇÁÇπ`, 'color: #52c41a; font-weight: bold;');
                console.log('üìã Áé∞ÊúâËßÇÁÇπÂàóË°®:', currentOpinions.map((op, i) => 
                    `${i+1}. [${op.section}] ${op.expert.name}: ${op.content.substring(0, 40)}...`
                ).join('\n   '));
            }
            
            // ===== ÂÆûÊó∂ÊòæÁ§∫Â∑≤‰øùÂ≠òËßÇÁÇπÊï∞ÔºàÈ°µÈù¢ÂèØËßÜÂåñÔºâ=====
            updateSavedOpinionsCounter();
            
            const stage1Container = document.getElementById('stage1Container');
            const stage2Div = document.createElement('div');
            stage2Div.className = 'card';
            stage2Div.id = 'stage2Container';
            stage2Div.innerHTML = `
                <h3><i class="fas fa-comments"></i> Á¨¨‰∫åÈò∂ÊÆµÔºö‰∏ìÂÆ∂Èó¥‰∫§ÂèâËÆ®ËÆ∫Ôºà‰∏ªÊåÅ‰∫∫ÂºïÂØºÔºâ</h3>
                
                <!-- Êñá‰ª∂Â§πÁªÑÁªáÊåáÂçóÂç°Áâá -->
                <div style="background: rgba(250, 140, 22, 0.1); border: 2px solid rgba(250, 140, 22, 0.3); border-radius: 12px; padding: 20px; margin: 15px 0;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <i class="fas fa-folder-tree" style="color: #fa8c16; font-size: 1.5rem;"></i>
                        <div>
                            <div style="color: #fa8c16; font-weight: 600; font-size: 1.1rem;">üìÅ Êú¨Ê¨°ËÆ®ËÆ∫ÁöÑÊñá‰ª∂‰øùÂ≠ò‰ΩçÁΩÆ</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">ÊâÄÊúâÊñá‰ª∂Â∞ÜËá™Âä®‰∏ãËΩΩÂà∞ÊÇ®ÁöÑÊµèËßàÂô®‰∏ãËΩΩÊñá‰ª∂Â§π</div>
                        </div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; color: #52c41a; font-size: 0.9rem; margin-bottom: 15px;">
                        <div>üìÇ Êé®ËçêË∑ØÂæÑÔºö<strong style="color: #1890ff;">ËÆ®ËÆ∫ÁªìÊûú/${window.currentFolderName || 'Âä†ËΩΩ‰∏≠...'}</strong></div>
                    </div>
                    <div style="color: rgba(255,255,255,0.85); font-size: 0.9rem; line-height: 1.8;">
                        üí° <strong>Âª∫ËÆÆÊìç‰ΩúÔºö</strong><br>
                        ‚Ä¢ Âú®Ê°åÈù¢ÂàõÂª∫"<strong>ËÆ®ËÆ∫ÁªìÊûú</strong>"Êñá‰ª∂Â§π<br>
                        ‚Ä¢ Â∞ÜÊâÄÊúâ‰∏ãËΩΩÁöÑÊñá‰ª∂ÁßªÂä®Âà∞Áªü‰∏ÄÊñá‰ª∂Â§π‰∏≠<br>
                        ‚Ä¢ ÁÇπÂáª <button onclick="showFileOrganizationGuide()" style="background: rgba(24,144,255,0.3); color: #1890ff; border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin: 0 5px;"><i class="fas fa-folder-tree"></i> Êü•ÁúãËØ¶ÁªÜÊåáÂçó</button> ‰∫ÜËß£ÂÆåÊï¥ÁªìÊûÑ
                    </div>
                </div>
                
                <!-- ÊäïÁ•®ËßÑÂàôËØ¥Êòé -->
                <div style="background: rgba(24, 144, 255, 0.1); border: 2px solid rgba(24, 144, 255, 0.3); border-radius: 12px; padding: 20px; margin: 15px 0;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <i class="fas fa-gavel" style="color: #1890ff; font-size: 1.5rem;"></i>
                        <div>
                            <div style="color: #1890ff; font-weight: 600; font-size: 1.1rem;">üìä ÊäïÁ•®ÂíåÈááÁ∫≥ËßÑÂàô</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">‰∏ìÂÆ∂ËßÇÁÇπÈúÄËææÂà∞‰∏ÄÂÆöÂêåÊÑèÁéáÊâç‰ºöË¢´ÈááÁ∫≥</div>
                        </div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.8;">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #52c41a;">‚úÖ ÈááÁ∫≥Ê†áÂáÜÔºö</strong>
                            ÊäïÁ•®ÂêåÊÑèÁéá ‚â• <strong style="color: #52c41a; font-size: 1.2rem;">40%</strong>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #1890ff;">üìù ËÆ°ÁÆóÊñπÂºèÔºö</strong>
                            ÂêåÊÑèÁéá = ËµûÊàêÁ•®Êï∞ √∑ (ËµûÊàêÁ•®Êï∞ + ÂèçÂØπÁ•®Êï∞)
                        </div>
                        <div style="padding: 10px; background: rgba(250,140,22,0.15); border-radius: 6px; border-left: 3px solid #fa8c16;">
                            <strong style="color: #fa8c16;">üí° ÊèêÁ§∫Ôºö</strong>
                            Â¶ÇÊûúÊâÄÊúâËßÇÁÇπÈÉΩÊú™ËææÂà∞40%ÔºåËØ¥ÊòéÂàùÂßãÊïôÊ°àÂèØËÉΩÂ∑≤ËæÉÂÆåÂñÑÔºåÊàñ‰∏ìÂÆ∂ÊÑèËßÅÂàÜÊ≠ßËæÉÂ§ß„ÄÇ
                            Á≥ªÁªü‰ºö‰øùÁïôÂàùÂßãÊïôÊ°àÂÜÖÂÆπÔºåÊÇ®‰πüÂèØ‰ª•ÂèÇËÄÉ‰∏ìÂÆ∂ÁöÑÁã¨Á´ãÂàÜÊûêÂíåËÆ®ËÆ∫ËÆ∞ÂΩïËøõË°åÊâãÂä®Ë∞ÉÊï¥„ÄÇ
                        </div>
                    </div>
                </div>
                
                <!-- ËßÇÁÇπ‰øùÂ≠òÁä∂ÊÄÅÈù¢Êùø -->
                <div id="opinionsSaveStatus" style="background: rgba(19, 194, 194, 0.1); border: 2px solid rgba(19, 194, 194, 0.3); border-radius: 12px; padding: 15px; margin: 15px 0;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-database" style="color: #13c2c2; font-size: 1.3rem;"></i>
                            <div>
                                <div style="color: #13c2c2; font-weight: 600; font-size: 1rem;">ÂÆûÊó∂ËßÇÁÇπ‰øùÂ≠òÁõëÊéß</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">ÊâÄÊúâËÆ®ËÆ∫ËßÇÁÇπÔºàÂê´Êú™ÈááÁ∫≥ÔºâÈÉΩ‰ºö‰øùÂ≠òÂà∞ËÆ∞ÂΩï</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; color: #52c41a; font-weight: bold;" id="savedOpinionsCount">0</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Â∑≤‰øùÂ≠òËßÇÁÇπ</div>
                            </div>
                            <button onclick="checkOpinionsData()" style="background: rgba(24,144,255,0.3); color: #1890ff; border: 1px solid rgba(24,144,255,0.4); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(24,144,255,0.5)'" onmouseout="this.style.background='rgba(24,144,255,0.3)'">
                                <i class="fas fa-search"></i> Ê£ÄÊü•Êï∞ÊçÆ
                            </button>
                            <button onclick="viewSavedOpinions()" style="background: rgba(114,46,209,0.3); color: #722ed1; border: 1px solid rgba(114,46,209,0.4); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(114,46,209,0.5)'" onmouseout="this.style.background='rgba(114,46,209,0.3)'">
                                <i class="fas fa-eye"></i> Êü•ÁúãËßÇÁÇπ
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="stage2Progress"></div>
                    </div>
                    <div class="progress-text" id="stage2ProgressText">‰∏ªÊåÅ‰∫∫ÂáÜÂ§á‰∏≠...</div>
                </div>
                <!-- ‰∏ªÊåÅ‰∫∫‰ªãÁªç -->
                <div class="moderator-card" id="moderatorIntro">
                    <div class="agent-header">
                        <div class="agent-avatar" style="background: ${moderator.color}">
                            ${moderator.avatar}
                        </div>
                        <div class="agent-info">
                            <div class="agent-name">${moderator.name}</div>
                            <div class="agent-specialty">${moderator.specialty}</div>
                        </div>
                    </div>
                    <div class="moderator-content" id="moderatorIntroContent"></div>
                </div>
                <!-- ËÆ®ËÆ∫Âå∫ÂüüÂÆπÂô® -->
                <div id="discussionArea">
                    <!-- ËÆ®ËÆ∫ËΩÆÊ¨°ÂÆπÂô® -->
                    <div id="discussionRounds"></div>
                </div>
            `;
            // ÊèíÂÖ•Âà∞Á¨¨‰∏ÄÈò∂ÊÆµ‰πãÂêéÔºàÂÆâÂÖ®ÊèíÂÖ•Ôºâ
            const apiTestSection = document.getElementById('apiTestSection');
            
            try {
                // Âº∫ÂåñÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†Âπ∂Âú®ÊñáÊ°£‰∏≠
                if (!container || !(container instanceof HTMLElement) || !document.body.contains(container)) {
                    throw new Error('container‰∏çÂ≠òÂú®„ÄÅ‰∏çÊòØÊúâÊïàÂÖÉÁ¥†ÊàñÂ∑≤‰ªéDOM‰∏≠ÁßªÈô§');
                }
                
                // È™åËØÅstage2DivÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
                if (!(stage2Div instanceof HTMLElement)) {
                    throw new Error('stage2Div‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                }
                
                // ÂÆâÂÖ®ÊèíÂÖ•ÔºöÊ£ÄÊü•ÊâÄÊúâÂèÇËÄÉÂÖÉÁ¥†ÊòØÂê¶Âú®container‰∏≠
                if (stage1Container && stage1Container.nextSibling && container.contains(stage1Container)) {
                    // È¢ùÂ§ñÊ£ÄÊü•nextSiblingÊòØÂê¶‰πüÂú®container‰∏≠
                    if (container.contains(stage1Container.nextSibling)) {
                        container.insertBefore(stage2Div, stage1Container.nextSibling);
                    } else {
                        container.appendChild(stage2Div);
                    }
                } else if (apiTestSection && container.contains(apiTestSection)) {
                    container.insertBefore(stage2Div, apiTestSection);
                } else {
                    // ÈôçÁ∫ßÊñπÊ°àÔºöÁõ¥Êé•appendChild
                    container.appendChild(stage2Div);
                }
            } catch (error) {
                console.error('‚ùå ÊèíÂÖ•stage2DivÂ§±Ë¥•Ôºå‰ΩøÁî®appendChild:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', {
                    message: error.message,
                    containerExists: !!container,
                    containerIsElement: container instanceof HTMLElement,
                    stage2DivExists: !!stage2Div,
                    stage2DivIsElement: stage2Div instanceof HTMLElement
                });
                try {
                    if (container && container.appendChild && stage2Div) {
                        container.appendChild(stage2Div);
                    } else {
                        console.error('‚ùå containerÊàñstage2Div‰∏çÂèØÁî®ÔºåÊó†Ê≥ïÊèíÂÖ•');
                        showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÊó†Ê≥ïÂàõÂª∫Á¨¨‰∫åÈò∂ÊÆµËÆ®ËÆ∫Âå∫Âüü', 'error');
                        return;
                    }
                } catch (appendError) {
                    console.error('‚ùå appendChild‰πüÂ§±Ë¥•‰∫Ü:', appendError);
                    showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÊó†Ê≥ïÂàõÂª∫Á¨¨‰∫åÈò∂ÊÆµËÆ®ËÆ∫Âå∫Âüü', 'error');
                    return;
                }
            }

            // Ëá™Âä®ÊªöÂä®Âà∞Á¨¨‰∫åÈò∂ÊÆµ
            setTimeout(() => {
                ScrollManager.scrollTo(stage2Div, { offset: 80 });
            }, 100);

            // Á≠âÂæÖDOMÂÆåÂÖ®Ê∏≤ÊüìÂêéÂÜçÁªßÁª≠ÔºàÂ¢ûÂä†Á≠âÂæÖÊó∂Èó¥Ôºâ
            await delay(500);
            
            // Âº∫Âà∂È™åËØÅdiscussionAreaÊòØÂê¶Â≠òÂú®
            let discussionAreaCheck = document.getElementById('discussionArea');
            let checkRetry = 0;
            while (!discussionAreaCheck && checkRetry < 5) {
                console.warn(`‚ö†Ô∏è discussionAreaÂ∞öÊú™Ê∏≤ÊüìÔºåÁ≠âÂæÖ‰∏≠... (Â∞ùËØï ${checkRetry + 1}/5)`);
                await delay(300);
                discussionAreaCheck = document.getElementById('discussionArea');
                checkRetry++;
            }
            
            if (!discussionAreaCheck) {
                console.error('‚ùå Ëá¥ÂëΩÈîôËØØÔºödiscussionAreaÊó†Ê≥ïÊ∏≤ÊüìÔºåÁªàÊ≠¢Á¨¨‰∫åÈò∂ÊÆµ');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöËÆ®ËÆ∫Âå∫ÂüüÊó†Ê≥ïÂä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                return;
            }
            
            console.log('‚úÖ discussionAreaÊ∏≤ÊüìÁ°ÆËÆ§ÂÆåÊàê');

            updateProgress('stage2Progress', 'stage2ProgressText', 5, '‰∏ªÊåÅ‰∫∫ÂºÄÂßã‰ªãÁªçËÆ®ËÆ∫ÊµÅÁ®ã...');

            // ‰∏ªÊåÅ‰∫∫ÂºÄÂú∫
            await moderatorIntroduction(previousAcceptedOpinions);

            updateProgress('stage2Progress', 'stage2ProgressText', 10, '‰∏ªÊåÅ‰∫∫Ê≠£Âú®Âü∫‰∫é5EÊ®°ÂûãÂàÜÊûêÂàùÂßãÊïôÊ°à...');

            // ÂÜçÊ¨°Á°Æ‰øùDOMÂ∑≤Ê∏≤ÊüìÔºåÁÑ∂ÂêéËøõË°å5EÊ®°ÂûãÂàÜÊûê
            await delay(300);
            
            // 5EÊ®°ÂûãÂàÜÊûê
            await analyze5EModel();

            updateProgress('stage2Progress', 'stage2ProgressText', 15, '‰∏ªÊåÅ‰∫∫Ê≠£Âú®ÂºïÂØº‰∏ìÂÆ∂ËÆ®ËÆ∫...');

            const discussionArea = document.getElementById('discussionArea');

            // ÁîüÊàêËÆ®ËÆ∫‰∏ªÈ¢òÔºàËûçÂêà5EÊ®°ÂûãÔºâ
            const discussionTopics = await generateDiscussionTopics(previousAcceptedOpinions);

            let topicIndex = 0;
            
            // ÂàùÂßãÂåñÊñá‰ª∂Â§πÂêçÁß∞ÔºàÈ¶ñÊ¨°ÂàõÂª∫Ôºâ- ‰ΩøÁî®Áî®Êà∑ÊåáÂÆöÁöÑË∑ØÂæÑÊ†ºÂºè
            if (!window.currentFolderName) {
                const courseTitle = extractCourseTitle();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 10);
                const sessionFolderName = `${courseTitle}_${timestamp}`;
                window.currentFolderName = sessionFolderName;
                window.currentSessionFolderName = sessionFolderName;
                window.discussionRoundCounter = 0; // ËÆ®ËÆ∫ËΩÆÊ¨°ËÆ°Êï∞Âô®
                
                console.log(`\n%cüìÅ ÂàõÂª∫ËÆ®ËÆ∫‰ºöËØù`, 'color: #52c41a; font-weight: bold;');
                console.log(`   ‰øùÂ≠òË∑ØÂæÑÔºöE:\\edu material\\disscussion_result\\${sessionFolderName}\\`);
                console.log(`   ËØæÁ®ãÊ†áÈ¢òÔºö${courseTitle}`);
                console.log(`   ÂºÄÂßãÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}\n`);
            }
            
            // ÂàùÂßãÂåñËÆ®ËÆ∫ËΩÆÊ¨°ËÆ°Êï∞Âô®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (typeof window.discussionRoundCounter === 'undefined') {
                window.discussionRoundCounter = 0;
            }

            async function conductDiscussionRound() {
                if (topicIndex >= discussionTopics.length) {
                    // ÊâÄÊúâËÆ®ËÆ∫‰∏ªÈ¢òÂÆåÊàêÔºå‰∏ªÊåÅ‰∫∫ËøõË°åÊÄªÁªì
                    await moderatorSummary();
                    updateProgress('stage2Progress', 'stage2ProgressText', 90, 'ÊâÄÊúâËÆ®ËÆ∫ÂÆåÊàêÔºÅÂáÜÂ§áÁîüÊàê‰ºòÂåñÊïôÊ°à...');
                    
                    // ÊòæÁ§∫ËÆ®ËÆ∫ÂÆåÊàêÊèêÁ§∫ÂíåËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂèØ‰∏ãËΩΩÔºâ
                    await showDiscussionCompleteSummary();
                    
                    // ÊòæÁ§∫"ÁîüÊàê‰ºòÂåñÊïôÊ°à"ÊåâÈíÆÔºà‰∏çËá™Âä®ÁîüÊàêÔºåÁ≠âÂæÖÁî®Êà∑Á°ÆËÆ§Ôºâ
                    await showGenerateOptimizedPlanButton();
                    
                    return;
                }

                const topic = discussionTopics[topicIndex];
                window.discussionRoundCounter++; // ËΩÆÊ¨°ÈÄíÂ¢û

                // ‰∏ªÊåÅ‰∫∫ÂºïÂØºÂèëË®ÄÔºåËøîÂõûËΩÆÊ¨°ID
                const roundId = await moderatorGuide(topic, previousAcceptedOpinions);
                
                // Ê£ÄÊü•roundIdÊòØÂê¶ÊúâÊïà
                if (!roundId) {
                    console.error('‚ùå ‰∏ªÊåÅ‰∫∫ÂºïÂØºÂ§±Ë¥•ÔºåË∑≥ËøáÊú¨ËΩÆËÆ®ËÆ∫');
                    topicIndex++;
                    setTimeout(conductDiscussionRound, 500);
                    return;
                }

                // ‰∏ìÂÆ∂ËΩÆÊµÅÂèëË®ÄÔºå‰ΩøÁî®ÂΩìÂâçËΩÆÊ¨°ÁöÑËÆ®ËÆ∫Âå∫Âüü
                await expertDiscussions(topic, previousAcceptedOpinions, roundId, window.discussionRoundCounter);

                topicIndex++;
                const progress = 15 + (topicIndex / discussionTopics.length) * 70;
                updateProgress('stage2Progress', 'stage2ProgressText', progress, `ËÆ®ËÆ∫ËøõÂ∫¶Ôºö${topicIndex}/${discussionTopics.length} ‰∏™‰∏ªÈ¢ò`);

                setTimeout(conductDiscussionRound, 500);
            }

            conductDiscussionRound();
        }

        // ‰∏ªÊåÅ‰∫∫ÂºÄÂú∫‰ªãÁªç
        async function moderatorIntroduction(previousAcceptedOpinions = null) {
            const moderatorContent = document.getElementById('moderatorIntroContent');

            // Ëé∑ÂèñÂàùÂßãÊïôÊ°à
            const initialPlan = window.initialTeachingPlan || parsedFileContent;
            
            // ‰øÆÊîπÂêéÔºöÂÖàÈùôÊÄÅ‰ªãÁªç5EÊ®°ÂûãÊ°ÜÊû∂
            moderatorContent.innerHTML = `
                <div class="moderator-speech">
                    <div class="speech-label">üé§ ÂºÄÂú∫‰ªãÁªç</div>
                    <div class="speech-content" id="introContent"></div>
                </div>
                
                <!-- 5EÊ®°ÂûãÊ°ÜÊû∂‰ªãÁªçÔºàÈùôÊÄÅ‰º†ÂèÇÔºâ -->
                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(24,144,255,0.15), rgba(114,46,209,0.15)); border-radius: 12px; border: 2px solid rgba(24,144,255,0.3);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <span style="font-size: 2rem;">üìö</span>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 600; color: #1890ff;">5EÊïôÂ≠¶Ê®°ÂûãÊ°ÜÊû∂</div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Êú¨Ê¨°ÊïôÁ†îËÆ®ËÆ∫Â∞ÜÂü∫‰∫é5EÊ®°ÂûãËøõË°åÊïôÊ°à‰ºòÂåñ</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 15px;">
                        ${fiveEModel.map((stage, index) => `
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 4px solid ${stage.color};">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5rem;">${stage.icon}</span>
                                    <span style="font-weight: 600; color: ${stage.color};">${index + 1}. ${stage.name}</span>
                                </div>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); line-height: 1.5;">
                                    ${stage.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: rgba(250,140,22,0.2); border-radius: 8px; border: 1px solid rgba(250,140,22,0.4);">
                        <strong style="color: #fa8c16;">üí° ËÆ®ËÆ∫Á≠ñÁï•Ôºö</strong>
                        <span style="color: rgba(255,255,255,0.9);">‰∏ªÊåÅ‰∫∫Â∞ÜÂÖàÂàÜÊûêÊïôÊ°àÂêÑÈÉ®ÂàÜÂú®5EÊ®°Âûã‰∏≠ÁöÑÂÆö‰ΩçÔºåÁÑ∂ÂêéÂºïÂØº‰∏ìÂÆ∂ÈíàÂØπÊØè‰∏™Èò∂ÊÆµÊèêÂá∫ÂÖ∑‰ΩìÊîπËøõÂª∫ËÆÆ</span>
                    </div>
                </div>
            `;
            
            let introPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÁé∞Âú®Êúâ5‰ΩçÊïôËÇ≤‰∏ìÂÆ∂Â∑≤ÁªèÂÆåÊàê‰∫ÜÂØπ‰∏Ä‰ªΩÊïôÊ°àÁöÑÁã¨Á´ãÂàÜÊûê„ÄÇ

‰∏ìÂÆ∂‰ª¨ÁöÑÂàÜÊûêÁªìÊûúÂ¶Ç‰∏ãÔºö
${agents.map(agent => `${agent.name}Ôºà${agent.specialty}ÔºâÔºöËØÑÂàÜ ${analysisResults[agent.key]?.score || 7.5}/10`).join('\n')}

Êú¨Ê¨°ÊïôÁ†îËÆ®ËÆ∫‰ºöÂ∞ÜÂü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÔºàÂºïÂÖ•Engage‚ÜíÊé¢Á©∂Explore‚ÜíËß£ÈáäExplain‚ÜíÂ∫îÁî®Extend‚ÜíËØÑ‰º∞EvaluateÔºâËøõË°åÔºö

ËÆ®ËÆ∫ÊµÅÁ®ãÔºö
1. È¶ñÂÖàÔºåÊàë‰ºöÂü∫‰∫é5EÊ®°ÂûãÂàÜÊûêÂàùÂßãÊïôÊ°àÔºåËØÜÂà´ÂêÑÈÉ®ÂàÜÂ±û‰∫éÂì™‰∏™ÊïôÂ≠¶Èò∂ÊÆµ
2. ÁÑ∂ÂêéÔºåÊàë‰ª¨Â∞ÜÊåâÁÖß5EÊ®°ÂûãÁöÑÈ°∫Â∫èÔºåÈÄê‰∏ÄËÆ®ËÆ∫ÊïôÊ°àÁöÑÂêÑ‰∏™ÁéØËäÇ
3. ÊØè‰∏™ÁéØËäÇÔºåÊïôÁ†îËÄÅÂ∏à‰ª¨‰ºöÁªìÂêà5EÁêÜÂøµÊèêÂá∫ÂÖ∑‰ΩìÊîπËøõÂª∫ËÆÆ
4. ÂÖ∂‰ªñËÄÅÂ∏àÂØπÂª∫ËÆÆËøõË°åÊäïÁ•®ÔºåËææÂà∞40%ÂêåÊÑèÁéáÁöÑÂª∫ËÆÆÂ∞ÜË¢´ÈááÁ∫≥
5. ÊúÄÂêéÔºåÊàë‰ºöËûçÂêàÂàùÂßãÊïôÊ°àÂíåÈááÁ∫≥ÁöÑÂª∫ËÆÆÔºåÁîüÊàê‰∏Ä‰ªΩÂü∫‰∫é5EÊ®°Âûã‰ºòÂåñÁöÑÊñ∞ÊïôÊ°à

ËØ∑‰Ω†‰Ωú‰∏∫‰∏ªÊåÅ‰∫∫ÔºåÁî®ÁÆÄÊ¥Å‰∏ì‰∏öÁöÑËØ≠Ë®Ä‰ªãÁªçÊú¨Ê¨°Âü∫‰∫é5EÊ®°ÂûãÁöÑÊïôÁ†îËÆ®ËÆ∫„ÄÇÂ≠óÊï∞ÊéßÂà∂Âú®150Â≠ó‰ª•ÂÜÖ„ÄÇ`;

            // Â¶ÇÊûúÊúâ‰πãÂâçÈááÁ∫≥ÁöÑËßÇÁÇπÔºåËØ¥ÊòéËøôÊòØÈáçÊñ∞ËÆ®ËÆ∫
            if (previousAcceptedOpinions && previousAcceptedOpinions.length > 0) {
                introPrompt += `

ËøôÊòØÈáçÊñ∞ËÆ®ËÆ∫ÁéØËäÇÔºå‰πãÂâçÂ∑≤Êúâ${previousAcceptedOpinions.length}‰∏™‰ºòÁßÄËßÇÁÇπË¢´ÈááÁ∫≥„ÄÇÊàë‰ª¨Â∞ÜÂú®‰øùÁïôËøô‰∫õ‰ºòÁßÄËßÇÁÇπÁöÑÂü∫Á°Ä‰∏äÔºåÁªßÁª≠Âü∫‰∫é5EÊ®°ÂûãÊ∑±ÂÖ•ËÆ®ËÆ∫„ÄÇ`;
            }

            const introduction = await callModeratorAPI(introPrompt);

            await typeText('introContent', introduction || 'ÂêÑ‰ΩçÊïôÁ†îËÄÅÂ∏àÂ•ΩÔºÅÊÑüË∞¢Â§ßÂÆ∂ÂÆåÊàêÁã¨Á´ãÂàÜÊûê„ÄÇÊú¨Ê¨°ÊïôÁ†îËÆ®ËÆ∫Â∞ÜÂü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÔºàÂºïÂÖ•‚ÜíÊé¢Á©∂‚ÜíËß£Èáä‚ÜíÂ∫îÁî®‚ÜíËØÑ‰º∞ÔºâËøõË°å„ÄÇÊàëÂ∞ÜÂÖàÂàÜÊûêÂàùÂßãÊïôÊ°àÂú®5EÊ®°Âûã‰∏≠ÁöÑÂÆö‰ΩçÔºåÁÑ∂ÂêéÂºïÂØºÂ§ßÂÆ∂ÊåâÁÖß5EÁöÑÈÄíËøõÈ°∫Â∫èÔºåÈÄê‰∏ÄËÆ®ËÆ∫Âπ∂ÊèêÂá∫ÊîπËøõÂª∫ËÆÆ„ÄÇÊúÄÂêéÔºåÊàë‰ºöÂ∞ÜÂàùÂßãÊïôÊ°àÂíåÂ§ßÂÆ∂ÁöÑÂª∫ËÆÆËûçÂêàÔºåÁîüÊàê‰∏Ä‰ªΩ‰ºòÂåñÂêéÁöÑÊñ∞ÊïôÊ°à„ÄÇËÆ©Êàë‰ª¨ÂºÄÂßãÂêßÔºÅ', 30);

            await delay(1000);
        }

        // 5EÊ®°ÂûãÔºö‰∏ªÊåÅ‰∫∫ÂàÜÊûêÂàùÂßãÊïôÊ°àÂπ∂Êò†Â∞ÑÂà∞5EÈò∂ÊÆµ
        async function analyze5EModel() {
            console.log('üéØ ‰∏ªÊåÅ‰∫∫ÂºÄÂßãÂàÜÊûêÂàùÂßãÊïôÊ°àÔºåÊò†Â∞ÑÂà∞5EÊïôÂ≠¶Ê®°Âûã...');
            
            const initialPlan = window.initialTeachingPlan || parsedFileContent;
            
            // ÂàõÂª∫5EÊ®°ÂûãÂ±ïÁ§∫ÂÆπÂô®
            let discussionArea = document.getElementById('discussionArea');
            
            // Â¶ÇÊûúÁ¨¨‰∏ÄÊ¨°Ëé∑ÂèñÂ§±Ë¥•ÔºåÁ≠âÂæÖ‰∏Ä‰∏ãÂÜçÂ∞ùËØïÔºàÊúÄÂ§öÂ∞ùËØï3Ê¨°Ôºâ
            let retryCount = 0;
            while (!discussionArea && retryCount < 3) {
                console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussionAreaÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                await delay(500);
                discussionArea = document.getElementById('discussionArea');
                retryCount++;
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ¶ÇÊûúËÆ®ËÆ∫Âå∫Âüü‰ªç‰∏çÂ≠òÂú®ÔºåË∑≥Ëøá5EÂàÜÊûê
            if (!discussionArea) {
                console.error('‚ùå ÁªèËøá3Ê¨°Â∞ùËØï‰ªçÊó†Ê≥ïÊâæÂà∞ËÆ®ËÆ∫Âå∫ÂüüÂÖÉÁ¥†(discussionArea)ÔºåË∑≥Ëøá5EÊ®°ÂûãÂàÜÊûê');
                // ËÆæÁΩÆÈªòËÆ§ÁöÑ5EÂàÜÊûêÁªìÊûú
                window.fiveEAnalysis = {
                    engage: 'ÂàùÂßãÊïôÊ°àÂåÖÂê´ÂØºÂÖ•ÁéØËäÇÔºåÂª∫ËÆÆÂ¢ûÂº∫ÊÉÖÂ¢ÉËÆæÁΩÆÂíåÈóÆÈ¢òÂºïÂØºÔºåÊøÄÂèëÂ≠¶ÁîüÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇ',
                    explore: 'ÊïôÊ°àËÆæËÆ°‰∫ÜÊé¢Á©∂Ê¥ªÂä®ÔºåÂª∫ËÆÆÂä†Âº∫Â≠¶ÁîüËá™‰∏ªÊé¢Á¥¢ÂíåÂ∞èÁªÑÂêà‰ΩúÁöÑÁéØËäÇËÆæËÆ°„ÄÇ',
                    explain: 'ÂåÖÂê´Áü•ËØÜËÆ≤Ëß£ÈÉ®ÂàÜÔºåÂª∫ËÆÆÂ¢ûÂä†Â≠¶ÁîüÂ±ïÁ§∫‰∫§ÊµÅÁéØËäÇÔºå‰øÉËøõÊ¶ÇÂøµÁêÜËß£„ÄÇ',
                    extend: 'ÊúâÂ∫îÁî®ÁªÉ‰π†ËÆæËÆ°ÔºåÂª∫ËÆÆËÆæÁΩÆÊõ¥Â§öÊñ∞ÊÉÖÂ¢É‰∏ãÁöÑÈóÆÈ¢òËß£ÂÜ≥‰ªªÂä°„ÄÇ',
                    evaluate: 'ÂåÖÂê´ËØÑ‰ª∑ÁéØËäÇÔºåÂª∫ËÆÆÂÆåÂñÑÂ§öÂÖÉËØÑ‰ª∑ÊñπÂºèÂíåÂΩ¢ÊàêÊÄßËØÑ‰º∞ËÆæËÆ°„ÄÇ'
                };
                return;
            }
            
            // ÂÜçÊ¨°Á°ÆËÆ§discussionAreaÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
            if (!(discussionArea instanceof HTMLElement)) {
                console.error('‚ùå discussionArea‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                window.fiveEAnalysis = {
                    engage: 'ÂàùÂßãÊïôÊ°àÂåÖÂê´ÂØºÂÖ•ÁéØËäÇÔºåÂª∫ËÆÆÂ¢ûÂº∫ÊÉÖÂ¢ÉËÆæÁΩÆÂíåÈóÆÈ¢òÂºïÂØºÔºåÊøÄÂèëÂ≠¶ÁîüÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇ',
                    explore: 'ÊïôÊ°àËÆæËÆ°‰∫ÜÊé¢Á©∂Ê¥ªÂä®ÔºåÂª∫ËÆÆÂä†Âº∫Â≠¶ÁîüËá™‰∏ªÊé¢Á¥¢ÂíåÂ∞èÁªÑÂêà‰ΩúÁöÑÁéØËäÇËÆæËÆ°„ÄÇ',
                    explain: 'ÂåÖÂê´Áü•ËØÜËÆ≤Ëß£ÈÉ®ÂàÜÔºåÂª∫ËÆÆÂ¢ûÂä†Â≠¶ÁîüÂ±ïÁ§∫‰∫§ÊµÅÁéØËäÇÔºå‰øÉËøõÊ¶ÇÂøµÁêÜËß£„ÄÇ',
                    extend: 'ÊúâÂ∫îÁî®ÁªÉ‰π†ËÆæËÆ°ÔºåÂª∫ËÆÆËÆæÁΩÆÊõ¥Â§öÊñ∞ÊÉÖÂ¢É‰∏ãÁöÑÈóÆÈ¢òËß£ÂÜ≥‰ªªÂä°„ÄÇ',
                    evaluate: 'ÂåÖÂê´ËØÑ‰ª∑ÁéØËäÇÔºåÂª∫ËÆÆÂÆåÂñÑÂ§öÂÖÉËØÑ‰ª∑ÊñπÂºèÂíåÂΩ¢ÊàêÊÄßËØÑ‰º∞ËÆæËÆ°„ÄÇ'
                };
                return;
            }
            
            const fiveEContainer = document.createElement('div');
            fiveEContainer.className = 'five-e-container';
            fiveEContainer.id = 'fiveEContainer';
            fiveEContainer.innerHTML = `
                <div class="five-e-header">
                    <span style="font-size: 2rem;">üìö</span>
                    <h3>5EÊïôÂ≠¶Ê®°ÂûãÂàÜÊûê</h3>
                </div>
                <div style="color: rgba(255,255,255,0.8); margin-bottom: 20px; line-height: 1.6;">
                    ‰∏ªÊåÅ‰∫∫Ê≠£Âú®Âü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÔºàÂºïÂÖ•‚ÜíÊé¢Á©∂‚ÜíËß£Èáä‚ÜíÂ∫îÁî®‚ÜíËØÑ‰º∞ÔºâÂàÜÊûêÂàùÂßãÊïôÊ°àÔºå‰ª•‰æøÂêéÁª≠ËÆ®ËÆ∫ËÉΩÂ§üÊõ¥ÊúâÈíàÂØπÊÄßÂú∞‰ºòÂåñÂêÑ‰∏™ÊïôÂ≠¶Èò∂ÊÆµ...
                </div>
                <div class="five-e-stages" id="fiveEStages">
                    ${fiveEModel.map(stage => `
                        <div class="five-e-stage" id="stage-${stage.key}" style="color: ${stage.color}">
                            <div class="five-e-stage-header">
                                <div class="five-e-stage-icon">${stage.icon}</div>
                                <div class="five-e-stage-name">${stage.name}</div>
                            </div>
                            <div class="five-e-stage-desc">${stage.description}</div>
                            <div class="five-e-stage-content" id="content-${stage.key}">
                                <i class="fas fa-spinner fa-spin"></i> ÂàÜÊûê‰∏≠...
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Âä†Âº∫ÁöÑÂÆâÂÖ®ÊèíÂÖ•ÈÄªËæë
            try {
                // ÊúÄÂêé‰∏ÄÊ¨°Á°ÆËÆ§discussionArea‰ªçÁÑ∂Â≠òÂú®‰∏îÊúâÊïà
                const currentDiscussionArea = document.getElementById('discussionArea');
                if (!currentDiscussionArea) {
                    throw new Error('discussionAreaÂú®ÊèíÂÖ•ÂâçÊ∂àÂ§±‰∫Ü');
                }
                
                // Âº∫ÂåñÈ™åËØÅÔºöÁ°Æ‰øùdiscussionAreaÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†Âπ∂Âú®ÊñáÊ°£‰∏≠
                if (!(currentDiscussionArea instanceof HTMLElement)) {
                    throw new Error('discussionArea‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                }
                
                if (!document.body.contains(currentDiscussionArea)) {
                    throw new Error('discussionArea‰∏çÂú®ÊñáÊ°£Ê†ë‰∏≠');
                }
                
                // È™åËØÅfiveEContainer‰πüÊòØÊúâÊïàÁöÑÂÖÉÁ¥†
                if (!fiveEContainer || !(fiveEContainer instanceof HTMLElement)) {
                    throw new Error('fiveEContainer‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                }
                
                // ‰ΩøÁî®appendChildËÄå‰∏çÊòØinsertBeforeÔºåÊõ¥ÂÆâÂÖ®
                currentDiscussionArea.appendChild(fiveEContainer);
                console.log('‚úÖ 5EÂÆπÂô®Â∑≤ÊàêÂäüÊèíÂÖ•discussionArea');
                
            } catch (error) {
                console.error('‚ùå ÊèíÂÖ•5EÂÆπÂô®Â§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', error.message, error.stack);
                
                // ËÆæÁΩÆÈªòËÆ§ÁöÑ5EÂàÜÊûêÁªìÊûúÂπ∂Ë∑≥ËøáÊòæÁ§∫
                window.fiveEAnalysis = {
                    engage: 'ÂàùÂßãÊïôÊ°àÂåÖÂê´ÂØºÂÖ•ÁéØËäÇÔºåÂª∫ËÆÆÂ¢ûÂº∫ÊÉÖÂ¢ÉËÆæÁΩÆÂíåÈóÆÈ¢òÂºïÂØºÔºåÊøÄÂèëÂ≠¶ÁîüÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇ',
                    explore: 'ÊïôÊ°àËÆæËÆ°‰∫ÜÊé¢Á©∂Ê¥ªÂä®ÔºåÂª∫ËÆÆÂä†Âº∫Â≠¶ÁîüËá™‰∏ªÊé¢Á¥¢ÂíåÂ∞èÁªÑÂêà‰ΩúÁöÑÁéØËäÇËÆæËÆ°„ÄÇ',
                    explain: 'ÂåÖÂê´Áü•ËØÜËÆ≤Ëß£ÈÉ®ÂàÜÔºåÂª∫ËÆÆÂ¢ûÂä†Â≠¶ÁîüÂ±ïÁ§∫‰∫§ÊµÅÁéØËäÇÔºå‰øÉËøõÊ¶ÇÂøµÁêÜËß£„ÄÇ',
                    extend: 'ÊúâÂ∫îÁî®ÁªÉ‰π†ËÆæËÆ°ÔºåÂª∫ËÆÆËÆæÁΩÆÊõ¥Â§öÊñ∞ÊÉÖÂ¢É‰∏ãÁöÑÈóÆÈ¢òËß£ÂÜ≥‰ªªÂä°„ÄÇ',
                    evaluate: 'ÂåÖÂê´ËØÑ‰ª∑ÁéØËäÇÔºåÂª∫ËÆÆÂÆåÂñÑÂ§öÂÖÉËØÑ‰ª∑ÊñπÂºèÂíåÂΩ¢ÊàêÊÄßËØÑ‰º∞ËÆæËÆ°„ÄÇ'
                };
                return;
            }
            
            // ÊªöÂä®Âà∞5EÊ®°ÂûãÂÆπÂô®
            setTimeout(() => {
                ScrollManager.scrollTo(fiveEContainer, { offset: 80 });
            }, 100);
            
            // Ë∞ÉÁî®AIÂàÜÊûêÂàùÂßãÊïôÊ°àÔºåÊò†Â∞ÑÂà∞5EÂêÑÈò∂ÊÆµÔºàÊõ¥ËØ¶ÁªÜÁöÑÂàÜÊûêÔºâ
            const analysisPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåËØ∑Âü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÊ∑±Â∫¶ÂàÜÊûê‰ª•‰∏ãÂàùÂßãÊïôÊ°à„ÄÇ

ÂàùÂßãÊïôÊ°àÂÜÖÂÆπÔºö
${initialPlan}

5EÊïôÂ≠¶Ê®°ÂûãËØ¶ÁªÜËØ¥ÊòéÔºö
1. ÂºïÂÖ•ÔºàEngageÔºâÔºöÂê∏ÂºïÂ≠¶ÁîüÁöÑÊ≥®ÊÑèÂäõÂπ∂ÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇÊïôÂ∏àÂèØÊèêÂá∫ÈóÆÈ¢òÔºàÊÉÖÂ¢ÉÔºâÊàñÂà©Áî®ËÆ§Áü•ÂÜ≤Á™Å„ÄÇ
   - Ê†∏ÂøÉË¶ÅÁ¥†ÔºöÊÉÖÂ¢ÉÂàõËÆæ„ÄÅÈóÆÈ¢òÂºïÂØº„ÄÅÊøÄÂèëÂÖ¥Ë∂£„ÄÅËÆ§Áü•ÂÜ≤Á™Å
   
2. Êé¢Á©∂ÔºàExploreÔºâÔºöÂ≠¶ÁîüÂü∫‰∫éÂ∑≤ÊúâÁü•ËØÜËøõË°åÊé¢Á©∂ÔºåÂª∫ÊûÑÊñ∞ÁöÑÊÑè‰πâÔºå‰π†ÂæóÊñ∞ÊäÄËÉΩ„ÄÇÊïôÂ∏à‰∏∫‰øÉËøõËÄÖÂíåÊøÄÊ¥ªËÄÖÔºåÊûÑÂª∫Â≠¶‰π†ÂÖ±Âêå‰Ωì„ÄÇ
   - Ê†∏ÂøÉË¶ÅÁ¥†ÔºöËá™‰∏ªÊé¢Á©∂„ÄÅÂ∞èÁªÑÂêà‰Ωú„ÄÅÂä®ÊâãÂÆûË∑µ„ÄÅÈóÆÈ¢òËß£ÂÜ≥„ÄÅÂ≠¶‰π†ÂÖ±Âêå‰Ωì
   
3. Ëß£ÈáäÔºàExplainÔºâÔºöÂ≠¶ÁîüËß£ÈáäÔºàËæìÂá∫ÔºâÊé¢Á¥¢ÁöÑÊî∂Ëé∑‰ª•‰øÉËøõÊàñÊ£ÄÈ™åÁêÜËß£ÂÖ≥ÈîÆÁöÑÁü•ËØÜÂíåÊ¶ÇÂøµÔºàÁªÑÂÜÖ‰∫§ÊµÅÊàñÂ∞èÁªÑÊ±áÊä•ÔºåÊïôÂ∏àÂºïÂØºÊàñËÆ≤ÊéàÔºâ„ÄÇ
   - Ê†∏ÂøÉË¶ÅÁ¥†ÔºöÂ≠¶ÁîüÂ±ïÁ§∫„ÄÅÊ¶ÇÂøµÂª∫ÊûÑ„ÄÅ‰∫§ÊµÅËÆ®ËÆ∫„ÄÅÊïôÂ∏àÂºïÂØºËÆ≤Êéà„ÄÅÁü•ËØÜÊï¥Âêà
   
4. Â∫îÁî®/ËøÅÁßªÔºàExtendÔºâÔºöÂ≠¶ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÂ∫îÁî®Áü•ËØÜÊù•Ëß£ÈáäÂèäËß£ÂÜ≥Êñ∞ÈóÆÈ¢òÔºàÂü∫‰∫éÊúÄËøëÂèëÂ±ïÂå∫Ôºâ„ÄÇ
   - Ê†∏ÂøÉË¶ÅÁ¥†ÔºöÊñ∞ÊÉÖÂ¢ÉÂ∫îÁî®„ÄÅÁü•ËØÜËøÅÁßª„ÄÅÈóÆÈ¢òËß£ÂÜ≥„ÄÅËÉΩÂäõÊãìÂ±ï
   
5. ËØÑ‰º∞ÔºàEvaluateÔºâÔºöÂ§öÂÖÉËØÑ‰ª∑ÁúüÂÆûÂèçÈ¶àÂ≠¶‰π†„ÄÇÂΩ¢ÊàêÊÄßËØÑ‰º∞Ë¥ØÁ©øÊï¥‰∏™5EËøáÁ®ãÔºåÊÄªÁªìÊÄßËØÑ‰º∞ÂØπÁªìÊûúËøõË°åËØÑ‰ª∑„ÄÇ
   - Ê†∏ÂøÉË¶ÅÁ¥†ÔºöÂ§öÂÖÉËØÑ‰ª∑„ÄÅÂΩ¢ÊàêÊÄßËØÑ‰º∞„ÄÅÊÄªÁªìÊÄßËØÑ‰º∞„ÄÅÂèçÈ¶àÊú∫Âà∂

ÂàÜÊûêË¶ÅÊ±ÇÔºö
1. ËØÜÂà´ÂàùÂßãÊïôÊ°à‰∏≠Âì™‰∫õÂÜÖÂÆπÂØπÂ∫î5EÁöÑÂêÑ‰∏™Èò∂ÊÆµ
2. ËØÑ‰º∞ËØ•Èò∂ÊÆµÁöÑËÆæËÆ°ÊòØÂê¶Á¨¶Âêà5EÁêÜÂøµ
3. ÊåáÂá∫ÂÖ∑‰ΩìÁöÑ‰ºòÁÇπÂíå‰∏çË∂≥
4. ÊèêÂá∫ÊòéÁ°ÆÁöÑ‰ºòÂåñÊñπÂêëÔºàÈúÄÂÖ∑‰Ωì„ÄÅÂèØÊìç‰ΩúÔºâ

ËØ∑‰ª•JSONÊ†ºÂºèËøîÂõûÔºåÊØè‰∏™Èò∂ÊÆµÂåÖÂê´120-180Â≠óÁöÑËØ¶ÁªÜÂàÜÊûêÔºö
{
    "engage": "„ÄêÁé∞Áä∂„ÄëÊïôÊ°à‰∏≠XXÁéØËäÇÂ±û‰∫éÂºïÂÖ•Èò∂ÊÆµÔºåÈááÁî®‰∫ÜXXÊñπÂºè„ÄÇ„ÄêËØÑ‰ª∑„Äë‰ºòÁÇπÊòØXXÔºå‰ΩÜXXÊñπÈù¢ÊúâÂæÖÂä†Âº∫„ÄÇ„Äê‰ºòÂåñÊñπÂêë„ÄëÂª∫ËÆÆÂú®XXÊñπÈù¢Â¢ûÂä†XXÔºåÈÄöËøáXXÊñπÂºèÊøÄÂèëÂ≠¶ÁîüXXÂÖ¥Ë∂£„ÄÇ",
    "explore": "„ÄêÁé∞Áä∂„ÄëÊïôÊ°à‰∏≠XXÁéØËäÇÂ±û‰∫éÊé¢Á©∂Èò∂ÊÆµ...„ÄêËØÑ‰ª∑„Äë...„Äê‰ºòÂåñÊñπÂêë„Äë...",
    "explain": "„ÄêÁé∞Áä∂„ÄëÊïôÊ°à‰∏≠XXÁéØËäÇÂ±û‰∫éËß£ÈáäÈò∂ÊÆµ...„ÄêËØÑ‰ª∑„Äë...„Äê‰ºòÂåñÊñπÂêë„Äë...",
    "extend": "„ÄêÁé∞Áä∂„ÄëÊïôÊ°à‰∏≠XXÁéØËäÇÂ±û‰∫éÂ∫îÁî®ËøÅÁßªÈò∂ÊÆµ...„ÄêËØÑ‰ª∑„Äë...„Äê‰ºòÂåñÊñπÂêë„Äë...",
    "evaluate": "„ÄêÁé∞Áä∂„ÄëÊïôÊ°à‰∏≠XXÁéØËäÇÂ±û‰∫éËØÑ‰º∞Èò∂ÊÆµ...„ÄêËØÑ‰ª∑„Äë...„Äê‰ºòÂåñÊñπÂêë„Äë..."
}

Âè™ËøîÂõûJSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇÁ°Æ‰øùÂàÜÊûêÂÖ∑‰Ωì„ÄÅÊ∑±ÂÖ•„ÄÅÊúâÊåáÂØº‰ª∑ÂÄº„ÄÇ`;

            try {
                const response = await callModeratorAPI(analysisPrompt);
                const analysis = JSON.parse(response);
                
                // Â≠òÂÇ®5EÂàÜÊûêÁªìÊûú
                window.fiveEAnalysis = analysis;
                
                // ÈÄê‰∏™Â±ïÁ§∫5EÈò∂ÊÆµÁöÑÂàÜÊûêÁªìÊûú
                for (const stage of fiveEModel) {
                    const contentElement = document.getElementById(`content-${stage.key}`);
                    const stageDiv = document.getElementById(`stage-${stage.key}`);
                    
                    // È´ò‰∫ÆÂΩìÂâçÈò∂ÊÆµ
                    stageDiv.classList.add('active');
                    
                    // ÊµÅÂºèÂ±ïÁ§∫ÂàÜÊûêÂÜÖÂÆπ
                    await typeText(`content-${stage.key}`, analysis[stage.key] || 'ÔºàËØ•Èò∂ÊÆµÊöÇÊó†ÊòéÁ°ÆÂÜÖÂÆπÔºâ', 25);
                    
                    // ÂèñÊ∂àÈ´ò‰∫Æ
                    setTimeout(() => {
                        stageDiv.classList.remove('active');
                    }, 500);
                    
                    await delay(800);
                }
                
                console.log('‚úÖ 5EÊ®°ÂûãÂàÜÊûêÂÆåÊàê', window.fiveEAnalysis);
                
            } catch (error) {
                console.error('‚ùå 5EÊ®°ÂûãÂàÜÊûêÂ§±Ë¥•:', error);
                
                // ‰ΩøÁî®ÈªòËÆ§ÂàÜÊûêÁªìÊûú
                window.fiveEAnalysis = {
                    engage: 'ÂàùÂßãÊïôÊ°àÂåÖÂê´ÂØºÂÖ•ÁéØËäÇÔºåÂª∫ËÆÆÂ¢ûÂº∫ÊÉÖÂ¢ÉËÆæÁΩÆÂíåÈóÆÈ¢òÂºïÂØºÔºåÊøÄÂèëÂ≠¶ÁîüÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇ',
                    explore: 'ÊïôÊ°àËÆæËÆ°‰∫ÜÊé¢Á©∂Ê¥ªÂä®ÔºåÂª∫ËÆÆÂä†Âº∫Â≠¶ÁîüËá™‰∏ªÊé¢Á¥¢ÂíåÂ∞èÁªÑÂêà‰ΩúÁöÑÁéØËäÇËÆæËÆ°„ÄÇ',
                    explain: 'ÂåÖÂê´Áü•ËØÜËÆ≤Ëß£ÈÉ®ÂàÜÔºåÂª∫ËÆÆÂ¢ûÂä†Â≠¶ÁîüÂ±ïÁ§∫‰∫§ÊµÅÁéØËäÇÔºå‰øÉËøõÊ¶ÇÂøµÁêÜËß£„ÄÇ',
                    extend: 'ÊúâÂ∫îÁî®ÁªÉ‰π†ËÆæËÆ°ÔºåÂª∫ËÆÆËÆæÁΩÆÊõ¥Â§öÊñ∞ÊÉÖÂ¢É‰∏ãÁöÑÈóÆÈ¢òËß£ÂÜ≥‰ªªÂä°„ÄÇ',
                    evaluate: 'ÂåÖÂê´ËØÑ‰ª∑ÁéØËäÇÔºåÂª∫ËÆÆÂÆåÂñÑÂ§öÂÖÉËØÑ‰ª∑ÊñπÂºèÂíåÂΩ¢ÊàêÊÄßËØÑ‰º∞ËÆæËÆ°„ÄÇ'
                };
                
                // Â±ïÁ§∫ÈªòËÆ§ÂàÜÊûêÁªìÊûú
                for (const stage of fiveEModel) {
                    const contentElement = document.getElementById(`content-${stage.key}`);
                    contentElement.innerHTML = window.fiveEAnalysis[stage.key];
                }
            }
            
            await delay(1000);
        }

        // ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ÊèêÂèñÊåáÂÆöÁ´†ËäÇÁöÑÂÜÖÂÆπ
        function extractSectionContent(teachingPlan, sectionName) {
            if (!teachingPlan || !sectionName) return 'ÔºàÂÜÖÂÆπÂæÖÊèêÂèñÔºâ';
            
            // Â∞ùËØïÂ§öÁßçÂåπÈÖçÊ®°Âºè
            const patterns = [
                new RegExp(`„Äê${sectionName}„Äë([\\s\\S]*?)(?=„Äê|$)`, 'i'),
                new RegExp(`„Äê.*${sectionName}.*„Äë([\\s\\S]*?)(?=„Äê|$)`, 'i'),
                new RegExp(`${sectionName}[Ôºö:][\\s]*([\\s\\S]*?)(?=\\n\\n|„Äê|$)`, 'i')
            ];
            
            for (const pattern of patterns) {
                const match = teachingPlan.match(pattern);
                if (match && match[1] && match[1].trim().length > 10) {
                    // ÈôêÂà∂ÊèêÂèñÈïøÂ∫¶ÔºåÈÅøÂÖçËøáÈïø
                    const content = match[1].trim();
                    return content.length > 500 ? content.substring(0, 500) + '...' : content;
                }
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÔºåËøîÂõûÁÆÄË¶ÅËØ¥Êòé
            return `ÂàùÂßãÊïôÊ°à‰∏≠ÁöÑ${sectionName}ÈÉ®ÂàÜÔºàËØ¶ËßÅÂÆåÊï¥ÊïôÊ°àÔºâ`;
        }

        // ÁîüÊàêËÆ®ËÆ∫‰∏ªÈ¢òÔºàÂü∫‰∫éÂàùÂßãÊïôÊ°àÁöÑÁªìÊûÑ + 5EÊ®°ÂûãÊò†Â∞ÑÔºâ
        async function generateDiscussionTopics(previousAcceptedOpinions = null) {
            // Áõ¥Êé•‰ªéÂàùÂßãÊïôÊ°à‰∏≠ÊèêÂèñËÆ®ËÆ∫‰∏ªÈ¢òÔºåËÆ©ÊïôÁ†îËÄÅÂ∏à‰ª¨ÈÄê‰∏ÄËÆ®ËÆ∫
            const initialPlan = window.initialTeachingPlan || parsedFileContent;
            
            console.log('üìã Âü∫‰∫éÂàùÂßãÊïôÊ°àÂíå5EÊ®°ÂûãÁîüÊàêËÆ®ËÆ∫‰∏ªÈ¢ò...');
            
            // ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ËØÜÂà´‰∏ªË¶ÅÁ´†ËäÇÔºåÂπ∂Êò†Â∞ÑÂà∞5EÊ®°Âûã
            const topics = [];
            
            // ËæÖÂä©ÂáΩÊï∞ÔºöÂåπÈÖçÊïôÊ°àÁ´†ËäÇÂà∞5EÈò∂ÊÆµ
            function matchTo5EStage(sectionName, keywords) {
                for (const stage of fiveEModel) {
                    const hasKeyword = stage.keywords.some(kw => 
                        sectionName.includes(kw) || keywords.some(k => k.includes(kw))
                    );
                    if (hasKeyword) return stage;
                }
                return null;
            }
            
            // ËØÜÂà´„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë
            if (initialPlan.includes('„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë') || initialPlan.includes('ÊïôÂ≠¶ÁõÆÊ†á')) {
                const stage5E = matchTo5EStage('ÊïôÂ≠¶ÁõÆÊ†á', ['ÁõÆÊ†á']) || fiveEModel[0]; // ÈªòËÆ§ÂΩí‰∏∫Engage
                topics.push({
                    title: 'ÊïôÂ≠¶ÁõÆÊ†áÁöÑËÆæËÆ°',
                    description: 'ËÆ®ËÆ∫ÊïôÂ≠¶ÁõÆÊ†áÊòØÂê¶ÊòéÁ°Æ„ÄÅÂÖ∑‰Ωì„ÄÅÂèØÊµãÈáèÔºåÊòØÂê¶Á¨¶ÂêàÂ≠¶ÁîüËÆ§Áü•Ê∞¥Âπ≥',
                    section: 'ÊïôÂ≠¶ÁõÆÊ†á',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // ËØÜÂà´„ÄêÊïôÂ≠¶ÈáçÁÇπ„ÄëÂíå„ÄêÊïôÂ≠¶ÈöæÁÇπ„Äë
            if (initialPlan.includes('„ÄêÊïôÂ≠¶ÈáçÁÇπ„Äë') || initialPlan.includes('ÊïôÂ≠¶ÈáçÁÇπ') || 
                initialPlan.includes('„ÄêÊïôÂ≠¶ÈöæÁÇπ„Äë') || initialPlan.includes('ÊïôÂ≠¶ÈöæÁÇπ')) {
                const stage5E = fiveEModel.find(s => s.key === 'explain') || fiveEModel[2]; // Êò†Â∞ÑÂà∞Explain
                topics.push({
                    title: 'ÊïôÂ≠¶ÈáçÁÇπ‰∏éÈöæÁÇπ',
                    description: 'ÂàÜÊûêÈáçÁÇπÈöæÁÇπÁöÑÊääÊè°ÊòØÂê¶ÂáÜÁ°ÆÔºåÁ™ÅÁ†¥Á≠ñÁï•ÊòØÂê¶ÊúâÊïà',
                    section: 'ÊïôÂ≠¶ÈáçÁÇπÈöæÁÇπ',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // ËØÜÂà´„ÄêÂØºÂÖ•„Äë„ÄêÂºïÂÖ•„ÄëÁéØËäÇ
            if (initialPlan.includes('„ÄêÂØºÂÖ•„Äë') || initialPlan.includes('„ÄêÂºïÂÖ•„Äë') || 
                initialPlan.includes('ÂØºÂÖ•ÁéØËäÇ') || initialPlan.includes('ËØæÂ†ÇÂºïÂÖ•')) {
                const stage5E = fiveEModel.find(s => s.key === 'engage');
                topics.push({
                    title: 'ÂØºÂÖ•ÁéØËäÇÁöÑËÆæËÆ°',
                    description: 'ËÆ®ËÆ∫Â¶Ç‰ΩïÊõ¥Â•ΩÂú∞Âê∏ÂºïÂ≠¶ÁîüÊ≥®ÊÑèÂäõ„ÄÅÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£',
                    section: 'ÂØºÂÖ•ÁéØËäÇ',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // ËØÜÂà´„ÄêÊïôÂ≠¶ÊµÅÁ®ã„ÄëÊàñ„ÄêÊïôÂ≠¶ËøáÁ®ã„Äë- Êò†Â∞ÑÂà∞Explore
            if (initialPlan.includes('„ÄêÊïôÂ≠¶ÊµÅÁ®ã„Äë') || initialPlan.includes('„ÄêÊïôÂ≠¶ËøáÁ®ã„Äë') || 
                initialPlan.includes('ÊïôÂ≠¶ÊµÅÁ®ã') || initialPlan.includes('ÊïôÂ≠¶ËøáÁ®ã')) {
                const stage5E = matchTo5EStage('ÊïôÂ≠¶ÊµÅÁ®ã', ['Êé¢Á©∂', 'Ê¥ªÂä®', 'ÂÆûÈ™å']) || fiveEModel.find(s => s.key === 'explore');
                topics.push({
                    title: 'ÊïôÂ≠¶ÊµÅÁ®ãÁöÑËÆæËÆ°',
                    description: 'ËÆ®ËÆ∫ÂêÑÁéØËäÇÊó∂Èó¥ÂàÜÈÖç„ÄÅË°îÊé•ËøáÊ∏°„ÄÅÊ¥ªÂä®ÂÆâÊéíÁöÑÂêàÁêÜÊÄß',
                    section: 'ÊïôÂ≠¶ÊµÅÁ®ã',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // ËØÜÂà´„ÄêÂàõÊñ∞ÊïôÂ≠¶Ê¥ªÂä®„ÄëÊàñÊïôÂ≠¶Ê¥ªÂä®Áõ∏ÂÖ≥ÂÜÖÂÆπ - Êò†Â∞ÑÂà∞ExploreÊàñExtend
            if (initialPlan.includes('„ÄêÂàõÊñ∞ÊïôÂ≠¶Ê¥ªÂä®„Äë') || initialPlan.includes('ÊïôÂ≠¶Ê¥ªÂä®') || 
                initialPlan.includes('Ê¥ªÂä®ËÆæËÆ°')) {
                const stage5E = matchTo5EStage('ÊïôÂ≠¶Ê¥ªÂä®', ['Êé¢Á©∂', 'ÂÆûË∑µ', 'Â∫îÁî®']) || fiveEModel.find(s => s.key === 'explore');
                topics.push({
                    title: 'ÊïôÂ≠¶Ê¥ªÂä®ÁöÑÂàõÊñ∞ÊÄß',
                    description: 'Êé¢ËÆ®ÊïôÂ≠¶Ê¥ªÂä®ÊòØÂê¶ÊúâÂàõÊÑè„ÄÅÊòØÂê¶ËÉΩÊøÄÂèëÂ≠¶ÁîüÂÖ¥Ë∂£ÂíåÊÄùÁª¥',
                    section: 'ÊïôÂ≠¶Ê¥ªÂä®',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // ËØÜÂà´„ÄêÂ∫îÁî®„Äë„ÄêÊãìÂ±ï„Äë„ÄêËøÅÁßª„ÄëÁéØËäÇ
            if (initialPlan.includes('„ÄêÂ∫îÁî®„Äë') || initialPlan.includes('„ÄêÊãìÂ±ï„Äë') || 
                initialPlan.includes('„ÄêËøÅÁßª„Äë') || initialPlan.includes('ÁªÉ‰π†') || 
                initialPlan.includes('ËØæÂêéÂª∂‰º∏')) {
                const stage5E = fiveEModel.find(s => s.key === 'extend');
                topics.push({
                    title: 'Â∫îÁî®‰∏éËøÅÁßªÁöÑËÆæËÆ°',
                    description: 'ËÆ®ËÆ∫Â¶Ç‰ΩïËÆæËÆ°Êñ∞ÊÉÖÂ¢É‰∏ãÁöÑÂ∫îÁî®‰ªªÂä°Ôºå‰øÉËøõÁü•ËØÜËøÅÁßª',
                    section: 'Â∫îÁî®ËøÅÁßª',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // ËØÜÂà´„ÄêËØÑ‰ª∑ÊñπÂºè„Äë- Êò†Â∞ÑÂà∞Evaluate
            if (initialPlan.includes('„ÄêËØÑ‰ª∑ÊñπÂºè„Äë') || initialPlan.includes('ËØÑ‰ª∑') || 
                initialPlan.includes('ÊïôÂ≠¶ËØÑ‰ª∑')) {
                const stage5E = fiveEModel.find(s => s.key === 'evaluate');
                topics.push({
                    title: 'ËØÑ‰ª∑ÊñπÂºèÁöÑÁßëÂ≠¶ÊÄß',
                    description: 'Á†îËÆ®ËØÑ‰ª∑ÊñπÂºèÊòØÂê¶ÂÖ®Èù¢„ÄÅÁßëÂ≠¶„ÄÅËÉΩÂáÜÁ°ÆÂèçÊò†Â≠¶‰π†ÊïàÊûú',
                    section: 'ËØÑ‰ª∑ÊñπÂºè',
                    fiveEStage: stage5E.key,
                    fiveEStageName: stage5E.name,
                    fiveEStageColor: stage5E.color,
                    fiveEStageIcon: stage5E.icon,
                    fiveEDescription: stage5E.description
                });
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâËØÜÂà´Âà∞‰ªª‰Ωï‰∏ªÈ¢òÔºå‰ΩøÁî®Âü∫‰∫é5EÊ®°ÂûãÁöÑÈªòËÆ§‰∏ªÈ¢ò
            if (topics.length === 0) {
                console.warn('‚ö†Ô∏è Êú™ËÉΩ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ËØÜÂà´‰∏ªÈ¢òÔºå‰ΩøÁî®Âü∫‰∫é5EÊ®°ÂûãÁöÑÈªòËÆ§‰∏ªÈ¢ò');
                return fiveEModel.map((stage, index) => {
                    const topicTitles = {
                        'engage': 'ÂØºÂÖ•‰∏éÂºïÂÖ•',
                        'explore': 'Êé¢Á©∂Ê¥ªÂä®ËÆæËÆ°',
                        'explain': 'Áü•ËØÜËÆ≤Ëß£‰∏éÊÄªÁªì',
                        'extend': 'Â∫îÁî®‰∏éÊãìÂ±ï',
                        'evaluate': 'ËØÑ‰ª∑‰∏éÂèçÈ¶à'
                    };
                    return {
                        title: topicTitles[stage.key],
                        description: stage.description,
                        section: topicTitles[stage.key],
                        fiveEStage: stage.key,
                        fiveEStageName: stage.name,
                        fiveEStageColor: stage.color,
                        fiveEStageIcon: stage.icon,
                        fiveEDescription: stage.description
                    };
                });
            }
            
            console.log(`‚úÖ ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ËØÜÂà´Âà∞ ${topics.length} ‰∏™ËÆ®ËÆ∫‰∏ªÈ¢òÔºåÂ∑≤Êò†Â∞ÑÂà∞5EÊ®°Âûã:`, 
                topics.map(t => `${t.title}(${t.fiveEStageName})`).join(', '));
            
            // Êåâ5EÊ®°ÂûãÈ°∫Â∫èÊéíÂ∫èËÆ®ËÆ∫‰∏ªÈ¢ò
            const stageOrder = ['engage', 'explore', 'explain', 'extend', 'evaluate'];
            topics.sort((a, b) => {
                return stageOrder.indexOf(a.fiveEStage) - stageOrder.indexOf(b.fiveEStage);
            });
            
            return topics;
        }

        // ‰∏ªÊåÅ‰∫∫ÂºïÂØºÂèëË®ÄÔºàËûçÂêà5EÊ®°ÂûãÂàÜÊûêÔºâ
        async function moderatorGuide(topic, previousAcceptedOpinions = null) {
            let discussionRounds = document.getElementById('discussionRounds');
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñdiscussionRounds
            let retryCount = 0;
            while (!discussionRounds && retryCount < 3) {
                console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussionRoundsÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                await delay(500);
                discussionRounds = document.getElementById('discussionRounds');
                retryCount++;
            }
            
            // ÊúÄÁªàÊ£ÄÊü•ÔºöÁ°Æ‰øùdiscussionRoundsÂ≠òÂú®‰∏îÊúâÊïà
            if (!discussionRounds || !(discussionRounds instanceof HTMLElement)) {
                console.error('‚ùå discussionRoundsÂÖÉÁ¥†‰∏çÂ≠òÂú®ÊàñÊó†ÊïàÔºåÊó†Ê≥ïÂàõÂª∫ËÆ®ËÆ∫ËΩÆÊ¨°');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöËÆ®ËÆ∫Âå∫Âüü‰∏¢Â§±ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return null;
            }
            
            // È™åËØÅdiscussionRoundsÂú®DOMÊ†ë‰∏≠
            if (!document.body.contains(discussionRounds)) {
                console.error('‚ùå discussionRounds‰∏çÂú®DOMÊ†ë‰∏≠');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöËÆ®ËÆ∫Âå∫ÂüüÂ∑≤ÁßªÈô§ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return null;
            }

            // ÂàõÂª∫Êñ∞ÁöÑËÆ®ËÆ∫ËΩÆÊ¨°ÔºàÂ∏¶5EÊ†áÁ≠æÔºâ
            const roundDiv = document.createElement('div');
            roundDiv.className = 'discussion-round';
            roundDiv.id = `round-${Date.now()}`;
            roundDiv.innerHTML = `
                <div class="moderator-card">
                    <div class="agent-header">
                        <div class="agent-avatar" style="background: ${moderator.color}">
                            ${moderator.avatar}
                        </div>
                        <div class="agent-info">
                            <div class="agent-name">${moderator.name}</div>
                            <div class="agent-specialty">ÊèêÂá∫ËÆ®ËÆ∫‰∏ªÈ¢ò</div>
                        </div>
                    </div>
                    ${topic.fiveEStage ? `
                    <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, ${topic.fiveEStageColor}25, ${topic.fiveEStageColor}08); border: 2px solid ${topic.fiveEStageColor}; border-radius: 12px; box-shadow: 0 4px 12px ${topic.fiveEStageColor}20;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <span style="font-size: 2rem; animation: pulse 2s infinite;">${topic.fiveEStageIcon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: ${topic.fiveEStageColor}; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">
                                    üéØ 5EÊïôÂ≠¶Ê®°Âûã
                                </div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: ${topic.fiveEStageColor}; text-shadow: 0 2px 4px ${topic.fiveEStageColor}30;">
                                    ${topic.fiveEStageName}
                                </div>
                            </div>
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.7; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <strong style="color: ${topic.fiveEStageColor};">Ê†∏ÂøÉË¶ÅÊ±ÇÔºö</strong>${topic.fiveEDescription}
                        </div>
                    </div>` : ''}
                    <div class="moderator-speech">
                        <div class="speech-label">üé§ ‰∏ªÊåÅ‰∫∫ÊèêÈóÆ</div>
                        <div class="topic-label">${topic.title}</div>
                        <div class="speech-content" id="guide-${roundDiv.id}"></div>
                    </div>
                </div>
                <div class="discussion-area" id="discussion-${roundDiv.id}">
                    <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px; font-size: 0.9rem;">
                        <i class="fas fa-users"></i> ÊïôÁ†îËÄÅÂ∏à‰ª¨Ê≠£Âú®ÊÄùËÄÉÂíåËÆ®ËÆ∫...
                    </div>
                </div>
            `;
            
            // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
            if (!safeAppendChild(discussionRounds, roundDiv, 'discussionRounds')) {
                console.error('‚ùå Êó†Ê≥ïÊ∑ªÂä†ËÆ®ËÆ∫ËΩÆÊ¨°Âà∞DOMÔºåÁªàÊ≠¢Êú¨ËΩÆËÆ®ËÆ∫');
                return null;
            }
            
            // ÊªöÂä®Âà∞Êñ∞ÂàõÂª∫ÁöÑËÆ®ËÆ∫ËΩÆÊ¨°
            setTimeout(() => {
                if (roundDiv && document.body.contains(roundDiv)) {
                    ScrollManager.scrollTo(roundDiv, { offset: 80 });
                }
            }, 100);

            // ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ÊèêÂèñËØ•Á´†ËäÇÁöÑÂÜÖÂÆπ
            const initialPlan = window.initialTeachingPlan || parsedFileContent;
            const sectionContent = extractSectionContent(initialPlan, topic.section);
            
            // Ëé∑Âèñ5EÊ®°ÂûãÂØπËØ•Èò∂ÊÆµÁöÑÂàÜÊûêÁªìÊûú
            const fiveEAnalysisForStage = window.fiveEAnalysis ? window.fiveEAnalysis[topic.fiveEStage] : null;
            
            let guidePrompt = `‰Ωú‰∏∫ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÁé∞Âú®Ë¶ÅÂºïÂØº‰∏ìÂÆ∂‰ª¨ËÆ®ËÆ∫ÂàùÂßãÊïôÊ°àÁöÑ"${topic.section}"ÈÉ®ÂàÜ„ÄÇ`;
            
            // Â¶ÇÊûúÊúâ5EÊ®°ÂûãÂàÜÊûêÔºåÂä†ÂÖ•Âà∞ÂºïÂØº‰∏≠
            if (topic.fiveEStage && fiveEAnalysisForStage) {
                guidePrompt += `

„Äê5EÊïôÂ≠¶Ê®°Âûã - ${topic.fiveEStageName}„Äë
${topic.fiveEDescription}

„Äê5EÊ®°ÂûãÂàÜÊûêË¶ÅÁÇπ„Äë
${fiveEAnalysisForStage}`;
            }
            
            guidePrompt += `

„ÄêÂàùÂßãÊïôÊ°à‰∏≠ÁöÑ${topic.section}ÂÜÖÂÆπ„Äë
${sectionContent}

„ÄêÊú¨ËΩÆËÆ®ËÆ∫‰∏ªÈ¢ò„Äë${topic.title}
${topic.description}

„ÄêÂºïÂØºË¶ÅÊ±Ç„Äë
ËØ∑ÁªìÂêà5EÊïôÂ≠¶Ê®°ÂûãÁöÑÁêÜÂøµÔºåÁî®ÁÆÄÊ¥Å‰∏ì‰∏öÁöÑËØ≠Ë®ÄÔºà120-150Â≠óÔºâÔºö
1. ÊòéÁ°ÆÊåáÂá∫ËøôÈÉ®ÂàÜÂú®5EÊ®°Âûã"${topic.fiveEStageName}"Èò∂ÊÆµÁöÑÂÖ≥ÈîÆË¶ÅÊ±ÇÊòØ‰ªÄ‰πà
2. ÁÆÄË¶ÅËØÑ‰ª∑ÂàùÂßãÊïôÊ°àËøôÈÉ®ÂàÜÁöÑÁé∞Áä∂ÔºàÂÅöÂæóÂ•ΩÁöÑÂú∞ÊñπÂíå‰∏çË∂≥‰πãÂ§ÑÔºâ
3. Âü∫‰∫é‰∏ªÊåÅ‰∫∫ÁöÑ5EÂàÜÊûêÔºåÊèêÂá∫2-3‰∏™ÈúÄË¶ÅÊïôÁ†îËÄÅÂ∏à‰ª¨ÈáçÁÇπËÆ®ËÆ∫ÁöÑÂÖ∑‰ΩìÈóÆÈ¢ò
4. ÂºïÂØºÂ§ßÂÆ∂ÁªìÂêà5EÊ†∏ÂøÉË¶ÅÁ¥†ÔºàÂ¶ÇÔºö${topic.fiveEDescription.slice(0, 30)}...ÔºâÊèêÂá∫ÂèØÊìç‰ΩúÁöÑÊîπËøõÊñπÊ°à

Ë¶ÅÊúâÊïôÁ†îÁªÑÈïøÁöÑ‰∏ì‰∏öÊÄßÂíåÂºïÂØºÂäõÔºåËÆ©ËÄÅÂ∏à‰ª¨ËÅöÁÑ¶Âú®5EÊ®°ÂûãÁöÑÊ†∏ÂøÉË¶ÅÊ±Ç‰∏ä„ÄÇ`;

            // Â¶ÇÊûúÊúâ‰πãÂâçÈááÁ∫≥ÁöÑËßÇÁÇπÔºåÂä†ÂÖ•Âà∞ÂºïÂØº‰∏≠
            if (previousAcceptedOpinions && previousAcceptedOpinions.length > 0) {
                guidePrompt += `

ËøôÊòØÈáçÊñ∞ËÆ®ËÆ∫ÁéØËäÇÔºå‰πãÂâçÂ∑≤Êúâ${previousAcceptedOpinions.length}‰∏™‰ºòÁßÄËßÇÁÇπË¢´ÈááÁ∫≥„ÄÇËØ∑Âü∫‰∫éËøô‰∫õËßÇÁÇπÂíå5EÊ®°ÂûãÔºåÁªßÁª≠Ê∑±ÂÖ•ËÆ®ËÆ∫Â¶Ç‰ΩïËøõ‰∏ÄÊ≠•‰ºòÂåñÊïôÊ°à„ÄÇ`;
            }

            const guide = await callModeratorAPI(guidePrompt);

            await typeText(`guide-${roundDiv.id}`, guide || `ÂêÑ‰ΩçËÄÅÂ∏àÔºåÊé•‰∏ãÊù•Êàë‰ª¨ËÆ®ËÆ∫ÂàùÂßãÊïôÊ°àÁöÑ"${topic.section}"ÈÉ®ÂàÜ„ÄÇËøôÂ±û‰∫é5EÊ®°ÂûãÁöÑ${topic.fiveEStageName}Èò∂ÊÆµÔºåÊ†∏ÂøÉË¶ÅÊ±ÇÊòØ${topic.fiveEDescription}„ÄÇÊ†πÊçÆÊàëÁöÑ5EÂàÜÊûêÔºåËøôÈÉ®ÂàÜ${fiveEAnalysisForStage ? 'ÈúÄË¶ÅÈáçÁÇπÂÖ≥Ê≥®‰ºòÂåñÊñπÂêë' : 'Êúâ‰ºòÂåñÁ©∫Èó¥'}„ÄÇËØ∑Â§ßÂÆ∂ÁªìÂêà5EÊïôÂ≠¶ÁêÜÂøµÔºåÈíàÂØπËøôÈÉ®ÂàÜÂÜÖÂÆπÊèêÂá∫ÂÖ∑‰Ωì„ÄÅÂèØËêΩÂú∞ÁöÑÊîπËøõÂª∫ËÆÆ„ÄÇ`, 30);

            await delay(800);
            
            // ËøîÂõûËΩÆÊ¨°ID‰æõÂêéÁª≠‰ΩøÁî®
            return roundDiv.id;
        }

        // ‰∏ìÂÆ∂ËÆ®ËÆ∫ÂíåÊäïÁ•®
        async function expertDiscussions(topic, previousAcceptedOpinions, roundId, roundNumber) {
            let discussionArea = document.getElementById(`discussion-${roundId}`);
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñËÆ®ËÆ∫Âå∫Âüü
            let retryCount = 0;
            while (!discussionArea && retryCount < 3) {
                console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussion-${roundId}ÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                await delay(500);
                discussionArea = document.getElementById(`discussion-${roundId}`);
                retryCount++;
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùËÆ®ËÆ∫Âå∫ÂüüÂ≠òÂú®‰∏îÊúâÊïà
            if (!discussionArea || !(discussionArea instanceof HTMLElement)) {
                console.error(`‚ùå Êó†Ê≥ïÊâæÂà∞ËÆ®ËÆ∫Âå∫Âüü discussion-${roundId} ÊàñÂÖÉÁ¥†Êó†Êïà`);
                showMessage('‚ùå ËÆ®ËÆ∫Âå∫Âüü‰∏¢Â§±ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            // È™åËØÅdiscussionAreaÂú®DOMÊ†ë‰∏≠
            if (!document.body.contains(discussionArea)) {
                console.error(`‚ùå discussionArea discussion-${roundId} ‰∏çÂú®DOMÊ†ë‰∏≠`);
                showMessage('‚ùå ËÆ®ËÆ∫Âå∫ÂüüÂ∑≤ÁßªÈô§ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            // Ê∏ÖÁ©∫"Ê≠£Âú®ÊÄùËÄÉ"ÊèêÁ§∫
            discussionArea.innerHTML = '';

            // Êî∂ÈõÜÊâÄÊúâ‰∏ìÂÆ∂ËßÇÁÇπ
            const expertOpinions = [];

            // ÈöèÊú∫ÈÄâÊã©3-4‰Ωç‰∏ìÂÆ∂ÂèëË®Ä
            const speakingExperts = agents
                .sort(() => Math.random() - 0.5)
                .slice(0, 3 + Math.floor(Math.random() * 2));

            // Á¨¨‰∏ÄÈò∂ÊÆµÔºö‰∏ìÂÆ∂ÊèêÂá∫ËßÇÁÇπ
            for (let i = 0; i < speakingExperts.length; i++) {
                const expert = speakingExperts[i];
                const expertResult = analysisResults[expert.key];
                
                // Ê£ÄÊü•APIÈÖçÈ¢ùÁä∂ÊÄÅ
                if (!isAPIAvailable(expert.key)) {
                    console.warn(`‚ö†Ô∏è ${expert.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºåË∑≥ËøáËÆ®ËÆ∫`);
                    // ÊòæÁ§∫ÈÖçÈ¢ùÈôêÂà∂ÊèêÁ§∫
                    const quotaNotice = document.createElement('div');
                    quotaNotice.className = 'discussion-item';
                    quotaNotice.style.cssText = `
                        background: rgba(250, 173, 20, 0.1);
                        border: 2px solid rgba(250, 173, 20, 0.3);
                        opacity: 1;
                        transform: translateY(0);
                    `;
                    quotaNotice.innerHTML = `
                        <div class="discussion-header">
                            <div class="discussion-avatar" style="background: ${expert.color}; opacity: 0.5;">
                                ${expert.avatar}
                            </div>
                            <div class="discussion-info">
                                <div class="discussion-expert">${expert.name}</div>
                                <div class="discussion-specialty">${expert.specialty}</div>
                            </div>
                            <span class="discussion-tag" style="background: rgba(250, 173, 20, 0.2); color: #faad14;">‚ö†Ô∏è ÈÖçÈ¢ùÈôêÂà∂</span>
                        </div>
                        <div class="discussion-content" style="color: rgba(255, 255, 255, 0.7);">
                            Áî±‰∫éAPIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºå${expert.name}ÊöÇÊó∂Êó†Ê≥ïÂèÇ‰∏éÊú¨ËΩÆËÆ®ËÆ∫„ÄÇ
                        </div>
                    `;
                    discussionArea.appendChild(quotaNotice);
                    await delay(500);
                    continue; // Ë∑≥ËøáËØ•‰∏ìÂÆ∂
                }

                // ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ÊèêÂèñËØ•Á´†ËäÇÂÜÖÂÆπ
                const initialPlan = window.initialTeachingPlan || parsedFileContent;
                const sectionContent = extractSectionContent(initialPlan, topic.section);
                
                // Ëé∑Âèñ5EÊ®°ÂûãÂØπËØ•Èò∂ÊÆµÁöÑÂàÜÊûêÁªìÊûú
                const fiveEAnalysisForStage = window.fiveEAnalysis ? window.fiveEAnalysis[topic.fiveEStage] : null;
                
                const discussionPrompt = `‰Ω†ÊòØ${expert.name}Ôºå‰∏ì‰∏öÊòØ${expert.specialty}„ÄÇ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
„ÄêÂΩìÂâçËÆ®ËÆ∫ÊâÄÂ±û5EÊïôÂ≠¶Ê®°ÂûãÈò∂ÊÆµ„Äë
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Èò∂ÊÆµÂêçÁß∞Ôºö${topic.fiveEStageName}
${topic.fiveEStageIcon} Èò∂ÊÆµÁâπÂæÅÔºö${topic.fiveEDescription}

${fiveEAnalysisForStage ? `
„Äê‰∏ªÊåÅ‰∫∫Âü∫‰∫é5EÊ®°ÂûãÁöÑÊ∑±Â∫¶ÂàÜÊûê„Äë
${fiveEAnalysisForStage}

üîç ËØ∑ÈáçÁÇπÂÖ≥Ê≥®‰∏ªÊåÅ‰∫∫ÂàÜÊûê‰∏≠ÊèêÂà∞ÁöÑ"‰ºòÂåñÊñπÂêë"ÔºåËøôÊòØÊú¨Ê¨°ËÆ®ËÆ∫ÁöÑÊ†∏ÂøÉÊåáÂØº„ÄÇ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
` : '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'}
„ÄêÊïôÁ†îËÆ®ËÆ∫Âú∫ÊôØ„Äë
Âú®ÊïôÁ†îËÆ®ËÆ∫‰∏≠Ôºå‰∏ªÊåÅ‰∫∫ÁªÑÁªáÂ§ßÂÆ∂ËÆ®ËÆ∫ÂàùÂßãÊïôÊ°àÁöÑ"${topic.section}"ÈÉ®ÂàÜ„ÄÇ

„ÄêÂàùÂßãÊïôÊ°à‰∏≠ÁöÑ${topic.section}ÂÜÖÂÆπ„Äë
${sectionContent}

„ÄêËÆ®ËÆ∫‰∏ªÈ¢ò„Äë${topic.title}
${topic.description}

„Äê‰Ω†‰πãÂâçÁöÑÊï¥‰ΩìÂàÜÊûê„Äë
ÂÖ≥ÈîÆÂèëÁé∞Ôºö${expertResult?.keyFindings || 'ÂæÖÂàÜÊûê'}
‰∏ªË¶ÅÂª∫ËÆÆÔºö${expertResult?.mainRecommendation || 'ÂæÖÊèê‰æõ'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
„ÄêËÆ®ËÆ∫Ë¶ÅÊ±Ç„Äë
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. ‚úÖ Ê∑±Â∫¶ÁªìÂêà5EÊ®°Âûã‰∏≠"${topic.fiveEStageName}"Èò∂ÊÆµÁöÑÊ†∏ÂøÉË¶ÅÁ¥†ÂíåÊïôÂ≠¶ÁêÜÂøµ
2. ‚úÖ ÂèÇËÄÉ‰∏ªÊåÅ‰∫∫ÁöÑ5EÂàÜÊûêÔºåÁâπÂà´ÊòØÂÖ∂‰∏≠ÊåáÂá∫ÁöÑ‰ºòÂåñÊñπÂêë
3. ‚úÖ ÈíàÂØπÂàùÂßãÊïôÊ°àËøôÈÉ®ÂàÜÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÔºåÊåáÂá∫ÊòéÁ°ÆÁöÑÈóÆÈ¢òÊàñÂèØÊîπËøõÁÇπ
4. ‚úÖ ÊèêÂá∫ÂèØÁõ¥Êé•ËêΩÂú∞ÁöÑÊîπËøõÊñπÊ°àÔºå‰ΩìÁé∞5EÊïôÂ≠¶ÁêÜÂøµÔºà‰∏çË¶ÅÁ©∫Ê≥õÁöÑÁêÜËÆ∫Ôºâ
5. ‚ö†Ô∏è  ‰Ω†ÁöÑËßÇÁÇπÈúÄË¶ÅË¢´ÂÖ∂‰ªñÊïôÁ†îËÄÅÂ∏àÊäïÁ•®ÔºåËææÂà∞40%ÂêåÊÑèÁéáÊâç‰ºöË¢´ÈááÁ∫≥

„ÄêËæìÂá∫Ê†ºÂºè„ÄëÔºà60-120Â≠óÔºâ
ËØ∑ÊèêÂá∫‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑ„ÄÅÂèØÊìç‰ΩúÁöÑÊîπËøõÂª∫ËÆÆÔºåÂøÖÈ°ªÂåÖÂê´Ôºö
üìå ÈíàÂØπÁöÑÂÖ∑‰ΩìÈóÆÈ¢òÔºàÊïôÊ°à‰∏≠Âì™Èáå‰∏çÁ¨¶Âêà5EÊ®°ÂûãË¶ÅÊ±ÇÔºüÔºâ
üîß ÊîπËøõÊé™ÊñΩÔºàÊÄé‰πàÊîπÔºüÊîπÊàê‰ªÄ‰πàÔºüÁî®‰ªÄ‰πà5EÊïôÂ≠¶Á≠ñÁï•ÔºüÔºâ
‚ú® È¢ÑÊúüÊïàÊûúÔºàÊîπËøõÂêéÂ¶Ç‰ΩïÊõ¥Â•ΩÂú∞‰ΩìÁé∞5EÁêÜÂøµÔºüÂØπÂ≠¶ÁîüÊúâ‰ªÄ‰πàÂ∏ÆÂä©ÔºüÔºâ

‰∏çË¶ÅÊ≥õÊ≥õËÄåË∞àÔºåË¶ÅÁªôÂá∫ÂèØ‰ª•Áõ¥Êé•ÂÜôÂÖ•Êñ∞ÊïôÊ°àÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÊàñÊïôÂ≠¶ËÆæËÆ°ÊñπÊ°à„ÄÇ`;

                let discussionContent = '';

                // Ê†πÊçÆ‰∏ìÂÆ∂Ë∞ÉÁî®Áõ∏Â∫îAPIÔºåÊ∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂ÂíåÈÖçÈ¢ùÊ£ÄÊµã
                try {
                    const apiCallPromise = (async () => {
                        if (expert.key === 'qwen') {
                            return await callQwenAPI(discussionPrompt);
                        } else if (expert.key === 'doubao') {
                            return await callDoubaoAPI(discussionPrompt);
                        } else if (expert.key === 'kimi') {
                            return await callKimiAPI(discussionPrompt);
                        } else if (expert.key === 'chatglm') {
                            return await callChatGLMAPI(discussionPrompt);
                        } else if (expert.key === 'deepseek') {
                            return await callDeepSeekAPI(discussionPrompt);
                        }
                    })();

                    // ËÆæÁΩÆ30ÁßíË∂ÖÊó∂
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('APIË∞ÉÁî®Ë∂ÖÊó∂')), 30000);
                    });

                    discussionContent = await Promise.race([apiCallPromise, timeoutPromise]);
                } catch (error) {
                    console.warn(`${expert.name} APIË∞ÉÁî®Â§±Ë¥•ÊàñË∂ÖÊó∂:`, error);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÖçÈ¢ùÈôêÂà∂ÈîôËØØ
                    const isQuotaError = error.message.includes('429') || 
                                       error.message.includes('ÈÖçÈ¢ù') || 
                                       error.message.includes('ÈôêÂà∂');
                    
                    if (isQuotaError) {
                        console.warn(`‚ö†Ô∏è ${expert.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºåË∑≥ËøáËØ•‰∏ìÂÆ∂`);
                        // Ê†áËÆ∞ËØ•APIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω
                        markAPIQuotaExhausted(expert.key);
                        discussionContent = `Ôºà${expert.name}Âõ†APIÈÖçÈ¢ùÈôêÂà∂ÊöÇÊó∂Êó†Ê≥ïÂèÇ‰∏éËÆ®ËÆ∫Ôºâ`;
                    } else {
                        discussionContent = null;
                    }
                }

                if (!discussionContent) {
                    discussionContent = `‰ªé${expert.specialty}ÁöÑËßíÂ∫¶ÁúãÔºåÂàùÂßãÊïôÊ°àÁöÑ${topic.section}ÈÉ®ÂàÜ${expertResult?.mainRecommendation || 'ÂèØ‰ª•Ëøõ‰∏ÄÊ≠•‰ºòÂåñ'}„ÄÇ`;
                }

                // ËØÑ‰º∞Âª∫ËÆÆË¥®Èáè
                const suggestionQuality = await evaluateSuggestionQuality(discussionContent, expert, topic);

                const discussionItem = document.createElement('div');
                discussionItem.className = 'discussion-item opinion-item';
                discussionItem.style.opacity = '0';
                discussionItem.style.transform = 'translateY(20px)';

                const contentId = `discussion-${Date.now()}-${i}`;
                discussionItem.innerHTML = `
                    <div class="discussion-header">
                        <div class="discussion-avatar" style="background: ${expert.color}">
                            ${expert.avatar}
                        </div>
                        <div class="discussion-info">
                            <div class="discussion-expert">${expert.name}</div>
                            <div class="discussion-specialty">${expert.specialty}</div>
                        </div>
                        ${topic.fiveEStage ? `
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="discussion-tag" style="background: linear-gradient(135deg, ${topic.fiveEStageColor}35, ${topic.fiveEStageColor}15); color: ${topic.fiveEStageColor}; border: 2px solid ${topic.fiveEStageColor}; font-weight: 600; padding: 6px 14px; box-shadow: 0 2px 8px ${topic.fiveEStageColor}30;">
                                ${topic.fiveEStageIcon} 5E-${topic.fiveEStageName}
                            </span>
                            <span class="discussion-tag" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">${topic.title}</span>
                        </div>
                        ` : `<span class="discussion-tag">${topic.title}</span>`}
                    </div>
                    <div class="discussion-content" id="${contentId}"></div>
                    <div class="vote-section" id="vote-${expert.key}" style="display: none;">
                        <div class="vote-buttons">
                            <button class="vote-btn agree" onclick="voteOnOpinion('${expert.key}', 'agree')">üëç ÂêåÊÑè</button>
                            <button class="vote-btn disagree" onclick="voteOnOpinion('${expert.key}', 'disagree')">üëé ÂèçÂØπ</button>
                        </div>
                        <div class="vote-results" id="vote-results-${expert.key}">
                            <span class="vote-count agree-count">ÂêåÊÑè: 0</span>
                            <span class="vote-count disagree-count">ÂèçÂØπ: 0</span>
                        </div>
                    </div>
                `;

                discussionArea.appendChild(discussionItem);

                setTimeout(() => {
                    discussionItem.style.opacity = '1';
                    discussionItem.style.transform = 'translateY(0)';
                    // ÊªöÂä®Âà∞Êñ∞Ê∑ªÂä†ÁöÑËÆ®ËÆ∫È°π
                    ScrollManager.scrollTo(discussionItem);
                }, 50);

                await delay(300);
                await typeText(contentId, discussionContent, 40);
                await delay(500);

                // Â≠òÂÇ®‰∏ìÂÆ∂ËßÇÁÇπ
                expertOpinions.push({
                    expert: expert,
                    content: discussionContent,
                    quality: suggestionQuality,
                    id: expert.key
                });

                // Â¶ÇÊûúÂª∫ËÆÆË¥®Èáè‰∏çÂ•ΩÔºå‰∏ªÊåÅ‰∫∫ËøõË°åÂπ≤È¢ÑÂπ∂Ë¶ÅÊ±Ç‰∏ìÂÆ∂ÈáçÊñ∞ÂèëË®Ä
                if (!suggestionQuality.isGood) {
                    await moderatorIntervention(expert, suggestionQuality.reason, topic, roundId);
                    
                    // ‰∏ìÂÆ∂ÈáçÊñ∞ÊÄùËÄÉÂπ∂ÁªôÂá∫ÊîπËøõÁöÑÂª∫ËÆÆ
                    const improvedDiscussion = await expertImproveOpinion(expert, discussionContent, suggestionQuality.improvement, topic);
                    
                    if (improvedDiscussion) {
                        // Êõ¥Êñ∞‰∏ìÂÆ∂ËßÇÁÇπÂÜÖÂÆπ
                        expertOpinions[expertOpinions.length - 1].content = improvedDiscussion;
                        expertOpinions[expertOpinions.length - 1].isImproved = true;
                        
                        // ÊòæÁ§∫ÊîπËøõÂêéÁöÑËßÇÁÇπ
                        const improvedContentId = `improved-content-${Date.now()}`;
                        const improvedDiv = document.createElement('div');
                        improvedDiv.className = 'discussion-item expert-improved';
                        improvedDiv.innerHTML = `
                            <div class="discussion-header">
                                <div class="discussion-avatar" style="background: ${expert.color}">
                                    ${expert.avatar}
                                </div>
                                <div class="discussion-info">
                                    <div class="discussion-expert">${expert.name}</div>
                                    <div class="discussion-specialty">${expert.specialty}</div>
                                </div>
                                <div class="improved-badge">
                                    <i class="fas fa-check-double"></i> ÊîπËøõÂêéÁöÑËßÇÁÇπ
                                </div>
                            </div>
                            <div class="discussion-content" id="${improvedContentId}"></div>
                        `;
                        discussionArea.appendChild(improvedDiv);
                        
                        setTimeout(() => {
                            improvedDiv.style.opacity = '1';
                            improvedDiv.style.transform = 'translateY(0)';
                            // ÊªöÂä®Âà∞ÊîπËøõÂêéÁöÑËßÇÁÇπ
                            ScrollManager.scrollTo(improvedDiv);
                        }, 50);
                        
                        await delay(300);
                        await typeText(improvedContentId, improvedDiscussion, 40);
                        await delay(500);
                    }
                }

                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                discussionArea.scrollTop = discussionArea.scrollHeight;
            }

            // Á¨¨‰∫åÈò∂ÊÆµÔºö‰∏ìÂÆ∂ÊäïÁ•®
            await expertVoting(expertOpinions, topic, roundId);

            // Á¨¨‰∏âÈò∂ÊÆµÔºöÁ≠õÈÄâËßÇÁÇπÂπ∂ÁîüÊàêÊúÄÁªàÁªìÊûú
            await finalizeDiscussionResults(expertOpinions, topic, roundId, roundNumber);
        }

        // ‰∏ìÂÆ∂ÊäïÁ•®
        async function expertVoting(opinions, topic, roundId) {
            const discussionArea = document.getElementById(`discussion-${roundId}`);
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùËÆ®ËÆ∫Âå∫ÂüüÂ≠òÂú®
            if (!discussionArea) {
                console.error(`‚ùå Êó†Ê≥ïÊâæÂà∞ËÆ®ËÆ∫Âå∫Âüü discussion-${roundId}ÔºåË∑≥ËøáÊäïÁ•®ÁéØËäÇ`);
                return;
            }

            // ÊòæÁ§∫ÊäïÁ•®Èò∂ÊÆµÊ†áÈ¢ò
            const votingHeader = document.createElement('div');
            votingHeader.className = 'discussion-voting-header';
            votingHeader.innerHTML = `
                <div class="voting-title">
                    <i class="fas fa-vote-yea"></i>
                    <span>ÊäïÁ•®Èò∂ÊÆµÔºöËØ∑ÂêÑ‰ΩçÊïôÁ†îËÄÅÂ∏àÂØπ‰∏äËø∞ËßÇÁÇπËøõË°åÊäïÁ•®</span>
                </div>
                <div class="voting-instruction">
                    Á•®Êï∞Ë∂ÖËøáÂçäÊï∞ÔºàË∂ÖËøá${Math.ceil(agents.length / 2)}Á•®ÔºâÁöÑËßÇÁÇπÂ∞ÜË¢´ÈááÁ∫≥
                </div>
            `;
            discussionArea.appendChild(votingHeader);
            
            // ÊªöÂä®Âà∞ÊäïÁ•®Âå∫Âüü
            setTimeout(() => {
                ScrollManager.scrollTo(votingHeader);
            }, 100);

            // ‰∏∫ÊØè‰∏™ËßÇÁÇπÊî∂ÈõÜÊäïÁ•®
            for (let opinionIndex = 0; opinionIndex < opinions.length; opinionIndex++) {
                const opinion = opinions[opinionIndex];
                
                // ÂàõÂª∫ËØ•ËßÇÁÇπÁöÑÊäïÁ•®Âç°Áâá
                const voteCardId = `vote-card-${Date.now()}-${opinionIndex}`;
                const voteCard = document.createElement('div');
                voteCard.className = 'vote-card';
                voteCard.id = voteCardId;
                voteCard.innerHTML = `
                    <div class="vote-card-header">
                        <div class="vote-opinion-author">
                            <span style="background: ${opinion.expert.color}; padding: 4px 12px; border-radius: 12px; color: white; font-size: 0.85rem;">
                                ${opinion.expert.name}
                            </span>
                            ÁöÑËßÇÁÇπ
                        </div>
                    </div>
                    <div class="vote-opinion-content">${opinion.content}</div>
                    <div class="vote-section">
                        <div class="vote-summary" id="vote-summary-${voteCardId}">
                            <span class="vote-count agree-count">‚úÖ ËµûÊàê: <strong>0</strong></span>
                            <span class="vote-count disagree-count">‚ùå ÂèçÂØπ: <strong>0</strong></span>
                        </div>
                        <div class="vote-reasons" id="vote-reasons-${voteCardId}">
                            <!-- ÊäïÁ•®ÁêÜÁî±Â∞ÜÂä®ÊÄÅÊ∑ªÂä† -->
                        </div>
                        <button class="toggle-reasons-btn" onclick="toggleVoteReasons('${voteCardId}')" style="display: none;">
                            <i class="fas fa-eye"></i> Êü•ÁúãÊäïÁ•®ÁêÜÁî±
                        </button>
                    </div>
                `;
                discussionArea.appendChild(voteCard);
                
                await delay(500);

                // ÂàùÂßãÂåñÊäïÁ•®Êï∞ÊçÆ
                opinion.votes = {
                    agree: 0,
                    disagree: 0,
                    voters: []
                };

                // ËÆ©ÂÖ∂‰ªñ‰∏ìÂÆ∂ÊäïÁ•®Ôºà‰∏çÂåÖÊã¨ÊèêÂá∫ËßÇÁÇπÁöÑ‰∏ìÂÆ∂Ëá™Â∑±Ôºâ
                const votingExperts = agents.filter(agent => agent.key !== opinion.expert.key);
                
                for (const voter of votingExperts) {
                    try {
                        // Ë∞ÉÁî®APIËÆ©‰∏ìÂÆ∂ÁªôÂá∫ÊäïÁ•®ÂíåÁêÜÁî±
                        const voteResult = await getExpertVote(voter, opinion, topic);
                        
                        // Êõ¥Êñ∞ÊäïÁ•®ÁªüËÆ°
                        if (voteResult.vote === 'agree') {
                            opinion.votes.agree++;
                        } else {
                            opinion.votes.disagree++;
                        }
                        
                        // ‰øùÂ≠òÊäïÁ•®ËÄÖ‰ø°ÊÅØ
                        opinion.votes.voters.push({
                            expert: voter,
                            vote: voteResult.vote,
                            reason: voteResult.reason,
                            isValid: true
                        });
                        
                        // Êõ¥Êñ∞ÊäïÁ•®ÊòæÁ§∫
                        updateVoteDisplay(voteCardId, opinion.votes);
                        
                        await delay(300);
                    } catch (error) {
                        // ÊäïÁ•®Â§±Ë¥•ÔºåËÆ∞ÂΩï‰ΩÜ‰∏ç‰ΩøÁî®ÈöèÊú∫ÊäïÁ•®
                        console.error(`${voter.name}ÊäïÁ•®Â§±Ë¥•:`, error.message);
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÖçÈ¢ùÈîôËØØ
                        const isQuotaError = error.message.includes('429') || 
                                           error.message.includes('ÈÖçÈ¢ù');
                        
                        const failureReason = isQuotaError 
                            ? `APIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºåËØ•‰∏ìÂÆ∂ÊöÇÊó∂Êó†Ê≥ïÊäïÁ•®` 
                            : `ÊäïÁ•®Â§±Ë¥•Ôºö${error.message}`;
                        
                        // ‰øùÂ≠òÂ§±Ë¥•‰ø°ÊÅØÔºå‰ΩÜ‰∏çËÆ°ÂÖ•ÊäïÁ•®ÁªüËÆ°
                        opinion.votes.voters.push({
                            expert: voter,
                            vote: 'failed',
                            reason: failureReason,
                            isValid: false
                        });
                        
                        // Âú®ÁïåÈù¢‰∏äÊòæÁ§∫ÊäïÁ•®Â§±Ë¥•
                        const reasonsDiv = document.getElementById(`vote-reasons-${voteCardId}`);
                        if (reasonsDiv) {
                            const failedVoteDiv = document.createElement('div');
                            failedVoteDiv.className = 'vote-reason-item failed';
                            failedVoteDiv.innerHTML = `
                                <div class="voter-info">
                                    <span class="voter-avatar" style="background: ${voter.color}">${voter.avatar}</span>
                                    <span class="voter-name">${voter.name}</span>
                                    ${isQuotaError ? '<span class="vote-badge" style="background: linear-gradient(135deg, #faad14, #ffc53d); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: auto;">‚ö†Ô∏è ÈÖçÈ¢ùÈôêÂà∂</span>' : '<span class="vote-badge failed-badge">‚ùå ÊäïÁ•®Â§±Ë¥•</span>'}
                                </div>
                                <div class="vote-reason-text" style="color: ${isQuotaError ? '#faad14' : '#ff4d4f'};">${failureReason}</div>
                            `;
                            reasonsDiv.appendChild(failedVoteDiv);
                        }
                        
                        await delay(300);
                    }
                }
                
                // ÊòæÁ§∫"Êü•ÁúãÊäïÁ•®ÁêÜÁî±"ÊåâÈíÆ
                const toggleBtn = voteCard.querySelector('.toggle-reasons-btn');
                if (toggleBtn) {
                    toggleBtn.style.display = 'inline-block';
                }
                
                // ===== üíæ Êñ∞Â¢ûÔºöÁ´ãÂç≥‰øùÂ≠òÊØè‰∏™Â∑≤ÊäïÁ•®ÁöÑËßÇÁÇπÔºàÂÆûÊó∂‰øùÂ≠òÔºåÈò≤Ê≠¢Êï∞ÊçÆ‰∏¢Â§±Ôºâ=====
                console.log(`\nüíæ Á´ãÂç≥‰øùÂ≠òËßÇÁÇπ #${opinionIndex + 1}ÔºàÂÆûÊó∂‰øùÂ≠òÊú∫Âà∂Ôºâ:`);
                console.log(`   ‰∏ìÂÆ∂: ${opinion.expert.name}`);
                console.log(`   ÂÜÖÂÆπ: ${opinion.content.substring(0, 60)}...`);
                console.log(`   ÊäïÁ•®: ‚úÖ${opinion.votes.agree} ‚ùå${opinion.votes.disagree}`);
                
                // ‰øùÂ≠òÂà∞‰∏¥Êó∂Êï∞ÁªÑÔºàÂΩìÂâç‰∏ªÈ¢òÁöÑËßÇÁÇπÔºâ
                if (!window.currentTopicOpinions) {
                    window.currentTopicOpinions = [];
                }
                window.currentTopicOpinions.push({
                    expert: opinion.expert,
                    content: opinion.content,
                    votes: opinion.votes,
                    topic: topic,
                    savedAt: new Date().toISOString()
                });
                
                console.log(`   ‚úÖ Â∑≤‰øùÂ≠òÂà∞‰∏¥Êó∂Êï∞ÁªÑÔºåÂΩìÂâç‰∏ªÈ¢òÂÖ±${window.currentTopicOpinions.length}‰∏™ËßÇÁÇπ`);
                
                await delay(500);
            }

            await delay(1000);
        }
        
        // Ëé∑Âèñ‰∏ìÂÆ∂ÁöÑÊäïÁ•®ÂíåÁêÜÁî±ÔºàÂ∏¶ÈáçËØïÊú∫Âà∂ÂíåÈÖçÈ¢ùÈôêÂà∂Ê£ÄÊµãÔºâ
        async function getExpertVote(voter, opinion, topic, retryCount = 0) {
            // Ê£ÄÊü•APIÈÖçÈ¢ùÁä∂ÊÄÅ
            if (!isAPIAvailable(voter.key) && retryCount === 0) {
                console.warn(`‚ö†Ô∏è ${voter.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºåÁõ¥Êé•Ë∑≥Ëøá`);
                throw new Error(`${voter.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω (429ÈîôËØØ)`);
            }
            
            const MAX_RETRIES = 3; // ÊúÄÂ§öÈáçËØï3Ê¨°
            // Ê†πÊçÆ‰∏çÂêåAIËÆæÁΩÆ‰∏çÂêåÁöÑË∂ÖÊó∂Êó∂Èó¥ÔºàÊäïÁ•®‰ªªÂä°ËæÉÁÆÄÂçïÔºå‰ΩÜÊüê‰∫õAI‰ªçÁÑ∂ËæÉÊÖ¢Ôºâ
            const TIMEOUT = voter.key === 'deepseek' || voter.key === 'doubao' ? 50000 : 40000; // DeepSeekÂíåË±ÜÂåÖ50ÁßíÔºåÂÖ∂‰ªñ40Áßí
            
            console.log(`üìä ${voter.name}ÊäïÁ•®ÂºÄÂßã (Â∞ùËØï ${retryCount + 1}/${MAX_RETRIES + 1})ÔºåË∂ÖÊó∂ËÆæÁΩÆ: ${TIMEOUT/1000}Áßí`);
            
            try {
                // ÁÆÄÂåñÊäïÁ•®ÊèêÁ§∫ÔºåÂáèÂ∞ëÂ§ÑÁêÜÊó∂Èó¥
                const votePrompt = `‰Ω†ÊòØ${voter.name}Ôºà${voter.specialty}Ôºâ„ÄÇ

„ÄêÂΩìÂâçËÆ®ËÆ∫ÊâÄÂ±û5EÊïôÂ≠¶Ê®°ÂûãÈò∂ÊÆµ„Äë
üéØ ${topic.fiveEStageName || 'ÁªºÂêàÂàÜÊûê'}
üìñ Èò∂ÊÆµËØ¥ÊòéÔºö${topic.fiveEDescription || 'ÁªºÂêàÊïôÂ≠¶ËÆæËÆ°'}

Âú®ÊïôÁ†îËÆ®ËÆ∫"${topic.title}"‰∏≠Ôºå${opinion.expert.name}ÊèêÂá∫Ôºö

"${opinion.content}"

ËØ∑Âø´ÈÄüËØÑ‰ª∑Ëøô‰∏™ËßÇÁÇπÔºö

ËØÑ‰ª∑Ê†áÂáÜÔºà5ÈÄâ3Âç≥ÂèØÔºåÈúÄËÄÉËôë5EÊïôÂ≠¶Ê®°ÂûãË¶ÅÊ±ÇÔºâÔºö
1. ÂÖ∑‰ΩìÊÄßÔºöÊòØÂê¶ÊúâÊòéÁ°ÆÁöÑÊìç‰ΩúÊ≠•È™§Ôºü
2. ÂèØÊìç‰ΩúÊÄßÔºöËÉΩÂê¶Âú®ÂÆûÈôÖÊïôÂ≠¶‰∏≠Â∫îÁî®Ôºü
3. ÂÆûÁî®‰ª∑ÂÄºÔºöËÉΩÂê¶Ëß£ÂÜ≥ÂÆûÈôÖÈóÆÈ¢òÔºü
4. ÁßëÂ≠¶ÊÄßÔºöÊòØÂê¶Á¨¶ÂêàÊïôËÇ≤ËßÑÂæãÂíå5EÊïôÂ≠¶Ê®°ÂûãÁêÜÂøµÔºü
5. ÂàõÊñ∞ÊÄßÔºöÊòØÂê¶ÊúâÊñ∞ÊÑèÔºü

Ë¶ÅÊ±ÇÔºö
- Âü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÁöÑËßÜËßíÂÆ¢ËßÇËØÑ‰ª∑
- Â¶ÇÊúâÈóÆÈ¢òËØ∑ÊäïÂèçÂØπÁ•®
- ÁÆÄË¶ÅËØ¥ÊòéÁêÜÁî±Ôºà50-80Â≠óÔºâ

JSONÊ†ºÂºèÂõûÂ§çÔºö
{
  "vote": "agree Êàñ disagree",
  "reason": "ËØÑ‰ª∑ÁêÜÁî±"
}`;

                // Ê†πÊçÆ‰∏ìÂÆ∂Ë∞ÉÁî®Áõ∏Â∫îAPIÔºåÊ∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂
                const apiCallPromise = (async () => {
                    let response = '';
                    if (voter.key === 'qwen') {
                        response = await callQwenAPI(votePrompt);
                    } else if (voter.key === 'doubao') {
                        response = await callDoubaoAPI(votePrompt);
                    } else if (voter.key === 'kimi') {
                        response = await callKimiAPI(votePrompt);
                    } else if (voter.key === 'chatglm') {
                        response = await callChatGLMAPI(votePrompt);
                    } else if (voter.key === 'deepseek') {
                        response = await callDeepSeekAPI(votePrompt);
                    }
                    return response;
                })();

                // ËÆæÁΩÆË∂ÖÊó∂
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('APIË∞ÉÁî®Ë∂ÖÊó∂')), TIMEOUT);
                });

                const response = await Promise.race([apiCallPromise, timeoutPromise]);
                
                console.log(`‚úÖ ${voter.name} APIÂìçÂ∫îÊàêÂäüÔºåÈïøÂ∫¶: ${response?.length || 0}`);
                console.log(`üìÑ ÂìçÂ∫îÈ¢ÑËßà: ${response?.substring(0, 150)}...`);
                
                // Â∞ùËØïËß£ÊûêJSON
                try {
                    // ÊèêÂèñJSONÈÉ®ÂàÜ
                    const jsonMatch = response.match(/\{[\s\S]*?\}/);
                    if (jsonMatch) {
                        const result = JSON.parse(jsonMatch[0]);
                        
                        // È™åËØÅËøîÂõûÁöÑvoteÂ≠óÊÆµÊòØÂê¶ÊúâÊïà
                        const vote = result.vote?.toLowerCase();
                        if (vote !== 'agree' && vote !== 'disagree') {
                            throw new Error(`ÊäïÁ•®ÁªìÊûúÊ†ºÂºèÊó†Êïà: ${vote}`);
                        }
                        
                        // È™åËØÅÁêÜÁî±ÊòØÂê¶Â≠òÂú®‰∏îÊúâÊÑè‰πâ
                        if (!result.reason || result.reason.length < 10) {
                            throw new Error(`ÊäïÁ•®ÁêÜÁî±‰∏çÂÆåÊï¥ÔºåÈïøÂ∫¶: ${result.reason?.length || 0}`);
                        }
                        
                        console.log(`‚úÖ ${voter.name}ÊäïÁ•®Ëß£ÊûêÊàêÂäü: ${vote}, ÁêÜÁî±ÈïøÂ∫¶: ${result.reason.length}`);
                        return {
                            vote: vote === 'agree' ? 'agree' : 'disagree',
                            reason: result.reason
                        };
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è Ëß£Êûê${voter.name}ÁöÑÊäïÁ•®JSONÂ§±Ë¥•:`, e.message);
                    console.log('ÂéüÂßãÂìçÂ∫î:', response);
                }
                
                // Â¶ÇÊûúJSONËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªéÊñáÊú¨‰∏≠ÊèêÂèñÊäïÁ•®ÊÑèÂõæ
                const text = response.toLowerCase();
                let vote = null;
                let reason = '';
                
                // Ê£ÄÊü•ÊòéÁ°ÆÁöÑÊäïÁ•®ÂÖ≥ÈîÆËØç
                if (text.includes('disagree') || text.includes('ÂèçÂØπ')) {
                    vote = 'disagree';
                    reason = response.substring(0, 150);
                } else if (text.includes('agree') || text.includes('ËµûÊàê') || text.includes('ÂêåÊÑè')) {
                    vote = 'agree';
                    reason = response.substring(0, 150);
                }
                
                // Â¶ÇÊûúÊàêÂäüÊèêÂèñÂà∞ÊäïÁ•®‰∏îÁêÜÁî±ÂÖÖÂàÜÔºåËøîÂõûÁªìÊûú
                if (vote && reason.length >= 10) {
                    console.log(`${voter.name}ÊäïÁ•®ÊèêÂèñÊàêÂäü: ${vote}`);
                    return { vote, reason };
                }
                
                // Â¶ÇÊûúÊó†Ê≥ïÊèêÂèñÊúâÊïàÊäïÁ•®ÔºåÊäõÂá∫ÈîôËØØËß¶ÂèëÈáçËØï
                throw new Error('Êó†Ê≥ï‰ªéÂìçÂ∫î‰∏≠ÊèêÂèñÊúâÊïàÁöÑÊäïÁ•®ÁªìÊûú');
                
            } catch (error) {
                console.error(`‚ùå ${voter.name}ÊäïÁ•®Â§±Ë¥• (Â∞ùËØï ${retryCount + 1}/${MAX_RETRIES + 1}):`, error.message);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ429ÈÖçÈ¢ùÈôêÂà∂ÈîôËØØ
                const isQuotaError = error.message.includes('429') || 
                                   error.message.includes('ÈÖçÈ¢ù') || 
                                   error.message.includes('ÈôêÂà∂') ||
                                   error.message.includes('Limit');
                
                if (isQuotaError) {
                    console.warn(`‚ö†Ô∏è ${voter.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞ΩÔºåÂÅúÊ≠¢ÈáçËØï`);
                    // Ê†áËÆ∞ËØ•APIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω
                    markAPIQuotaExhausted(voter.key);
                    // Áõ¥Êé•ÊäõÂá∫ÈîôËØØÔºå‰∏çÂÜçÈáçËØï
                    throw new Error(`${voter.name} APIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω (429ÈîôËØØ)`);
                }
                
                // Â¶ÇÊûúËøòÊúâÈáçËØïÊú∫‰ºöÔºåÈÄíÂΩíË∞ÉÁî®ÈáçËØï
                if (retryCount < MAX_RETRIES) {
                    const isTimeout = error.message && error.message.includes('Ë∂ÖÊó∂');
                    const waitTime = isTimeout ? 1500 : 2000; // Ë∂ÖÊó∂Á≠â1.5ÁßíÔºåÂÖ∂‰ªñÁ≠â2Áßí
                    console.log(`üîÑ ${voter.name}Â∞ÜÂú®${waitTime/1000}ÁßíÂêéÈáçÊñ∞ÊäïÁ•®... ${isTimeout ? '(Ë∂ÖÊó∂ÈáçËØïÔºåÂ∑≤Âª∂ÈïøAPIË∂ÖÊó∂Êó∂Èó¥)' : ''}`);
                    await delay(waitTime);
                    return await getExpertVote(voter, opinion, topic, retryCount + 1);
                }
                
                // ÈáçËØïÊ¨°Êï∞Áî®Â∞ΩÔºåËøîÂõûÈîôËØØÁä∂ÊÄÅ
                console.error(`‚ö†Ô∏è ${voter.name}Âú®${MAX_RETRIES + 1}Ê¨°Â∞ùËØïÂêé‰ªçÊó†Ê≥ïÂÆåÊàêÊäïÁ•®ÔºåÂ∞ÜÊ†áËÆ∞‰∏∫Â§±Ë¥•`);
                throw new Error(`${voter.name}Âú®${MAX_RETRIES + 1}Ê¨°Â∞ùËØïÂêé‰ªçÊó†Ê≥ïÂÆåÊàêÊäïÁ•®: ${error.message}`);
            }
        }
        
        // Êõ¥Êñ∞ÊäïÁ•®ÊòæÁ§∫
        function updateVoteDisplay(voteCardId, votes) {
            // ÁªüËÆ°ÊúâÊïàÊäïÁ•®ÂíåÂ§±Ë¥•ÊäïÁ•®
            const validVoters = votes.voters.filter(v => v.isValid !== false);
            const failedVoters = votes.voters.filter(v => v.isValid === false);
            
            const summaryDiv = document.getElementById(`vote-summary-${voteCardId}`);
            if (summaryDiv) {
                let summaryHTML = `
                    <span class="vote-count agree-count">‚úÖ ËµûÊàê: <strong>${votes.agree}</strong></span>
                    <span class="vote-count disagree-count">‚ùå ÂèçÂØπ: <strong>${votes.disagree}</strong></span>
                `;
                
                // Â¶ÇÊûúÊúâÂ§±Ë¥•ÁöÑÊäïÁ•®ÔºåÊòæÁ§∫ÊèêÁ§∫
                if (failedVoters.length > 0) {
                    summaryHTML += `<span class="vote-count failed-count" style="color: #ff4d4f;">‚ö†Ô∏è Â§±Ë¥•: <strong>${failedVoters.length}</strong></span>`;
                }
                
                summaryDiv.innerHTML = summaryHTML;
            }
            
            const reasonsDiv = document.getElementById(`vote-reasons-${voteCardId}`);
            if (reasonsDiv) {
                reasonsDiv.innerHTML = votes.voters.map(voter => {
                    // Â§ÑÁêÜÂ§±Ë¥•ÁöÑÊäïÁ•®
                    if (voter.vote === 'failed' || voter.isValid === false) {
                        return `
                            <div class="vote-reason-item failed">
                                <div class="voter-info">
                                    <span class="voter-avatar" style="background: ${voter.expert.color}">${voter.expert.avatar}</span>
                                    <span class="voter-name">${voter.expert.name}</span>
                                    <span class="vote-badge failed-badge">‚ùå ÊäïÁ•®Â§±Ë¥•</span>
                                </div>
                                <div class="vote-reason-text" style="color: #ff4d4f;">${voter.reason}</div>
                            </div>
                        `;
                    }
                    
                    // Â§ÑÁêÜÊ≠£Â∏∏ÁöÑÊäïÁ•®
                    return `
                        <div class="vote-reason-item ${voter.vote}">
                            <div class="voter-info">
                                <span class="voter-avatar" style="background: ${voter.expert.color}">${voter.expert.avatar}</span>
                                <span class="voter-name">${voter.expert.name}</span>
                                <span class="vote-badge ${voter.vote}">${voter.vote === 'agree' ? '‚úÖ ËµûÊàê' : '‚ùå ÂèçÂØπ'}</span>
                            </div>
                            <div class="vote-reason-text">${voter.reason}</div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // ÂàáÊç¢ÊäïÁ•®ÁêÜÁî±ÊòæÁ§∫/ÈöêËóè
        function toggleVoteReasons(voteCardId) {
            const reasonsDiv = document.getElementById(`vote-reasons-${voteCardId}`);
            const btn = document.querySelector(`#${voteCardId} .toggle-reasons-btn`);
            
            if (reasonsDiv && btn) {
                if (reasonsDiv.style.display === 'none' || !reasonsDiv.style.display) {
                    reasonsDiv.style.display = 'block';
                    btn.innerHTML = '<i class="fas fa-eye-slash"></i> ÈöêËóèÊäïÁ•®ÁêÜÁî±';
                } else {
                    reasonsDiv.style.display = 'none';
                    btn.innerHTML = '<i class="fas fa-eye"></i> Êü•ÁúãÊäïÁ•®ÁêÜÁî±';
                }
            }
        }

        // ÊèêÂèñËØæÁ®ãÊ†áÈ¢ò
        function extractCourseTitle() {
            // Â∞ùËØï‰ªéÂ§ö‰∏™Êù•Ê∫êÊèêÂèñËØæÁ®ãÊ†áÈ¢ò
            const lessonTitle = document.getElementById('lessonTitle')?.value?.trim();
            if (lessonTitle) return lessonTitle;
            
            const courseName = document.getElementById('courseName')?.value?.trim();
            if (courseName) return courseName;
            
            if (window.initialTeachingPlan) {
                const match = window.initialTeachingPlan.match(/„ÄêËØæÁ®ãÂêçÁß∞„Äë\s*\n?\s*(.+)/);
                if (match && match[1]) return match[1].trim();
            }
            
            if (parsedFileContent) {
                const match = parsedFileContent.match(/ËØæÁ®ãÂêçÁß∞[Ôºö:]\s*(.+)/);
                if (match && match[1]) return match[1].trim();
            }
            
            return 'Êú™ÂëΩÂêçËØæÁ®ã';
        }
        
        // ÊòæÁ§∫Êñá‰ª∂Â§πÁªÑÁªáÊåáÂçó
        function showFolderOrganizationGuide(folderName) {
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            console.log('%cüìÅ Êñá‰ª∂Â§πÁªÑÁªáÊåáÂçó', 'color: #fa8c16; font-size: 16px; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            console.log(`\nÊé®ËçêÁöÑÊñá‰ª∂Â§πÁªìÊûÑÔºö`);
            console.log(`\nËÆ®ËÆ∫ÁªìÊûú/`);
            console.log(`  ‚îî‚îÄ ${folderName}/`);
            console.log(`      ‚îú‚îÄ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json`);
            console.log(`      ‚îú‚îÄ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt`);
            console.log(`      ‚îú‚îÄ Á¨¨1ËΩÆ_ÊïôÂ≠¶ÁõÆÊ†á_ËßÇÁÇπ.txt`);
            console.log(`      ‚îú‚îÄ Á¨¨2ËΩÆ_ÊïôÂ≠¶ÊµÅÁ®ã_ËßÇÁÇπ.txt`);
            console.log(`      ‚îî‚îÄ ...Êõ¥Â§öËΩÆÊ¨°`);
            console.log(`\nüí° Âª∫ËÆÆÔºöÂ∞ÜÊâÄÊúâ‰∏ãËΩΩÁöÑÊñá‰ª∂ÊåâÁÖß‰∏äËø∞ÁªìÊûÑÁªÑÁªáÂà∞Âêå‰∏Ä‰∏™Êñá‰ª∂Â§π‰∏≠`);
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
        }
        
        // ‰øùÂ≠òÂçïËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÊØèËΩÆËÆ®ËÆ∫ÁªìÊùüÊó∂Ë∞ÉÁî®Ôºâ
        async function saveRoundDiscussionToFile(acceptedOpinions, topic, roundNumber) {
            if (!acceptedOpinions || acceptedOpinions.length === 0) {
                console.log(`Á¨¨${roundNumber}ËΩÆËÆ®ËÆ∫Êó†ÈááÁ∫≥ËßÇÁÇπÔºåË∑≥Ëøá‰øùÂ≠ò`);
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const courseTitle = extractCourseTitle();
            const sessionFolderName = `${courseTitle}_${timestamp}`;
            const roundFilename = `Á¨¨${roundNumber}ËΩÆ_${topic.section}_ËßÇÁÇπ.txt`;
            
            // ‰øùÂ≠òËØ•ËΩÆÊ¨°ÁöÑËßÇÁÇπ
            let roundContent = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            roundContent += `Á¨¨${roundNumber}ËΩÆËÆ®ËÆ∫Ôºö„Äê${topic.section}„Äë\n`;
            roundContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            roundContent += `üìÖ Êó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}\n`;
            roundContent += `üìö ‰∏ªÈ¢òÔºö${topic.title}\n`;
            roundContent += `üìù ÊèèËø∞Ôºö${topic.description}\n`;
            roundContent += `‚úÖ ÈááÁ∫≥Ôºö${acceptedOpinions.length} ‰∏™ËßÇÁÇπ\n\n`;
            
            acceptedOpinions.forEach((opinion, index) => {
                const totalVotes = opinion.votes.agree + opinion.votes.disagree;
                const passRate = ((opinion.votes.agree / totalVotes) * 100).toFixed(1);
                
                roundContent += `‚îå‚îÄ ËßÇÁÇπ ${index + 1} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                roundContent += `‚îÇ\n`;
                roundContent += `‚îÇ üë§ ‰∏ìÂÆ∂Ôºö${opinion.expert.name}Ôºà${opinion.expert.specialty}Ôºâ\n`;
                roundContent += `‚îÇ\n`;
                roundContent += `‚îÇ üí° ËßÇÁÇπÂÜÖÂÆπÔºö\n`;
                roundContent += `‚îÇ ${opinion.content.split('\n').join('\n‚îÇ ')}\n`;
                roundContent += `‚îÇ\n`;
                roundContent += `‚îÇ üìä ÊäïÁ•®ÁªìÊûúÔºö\n`;
                roundContent += `‚îÇ    ‚úÖ ËµûÊàêÔºö${opinion.votes.agree} Á•®\n`;
                roundContent += `‚îÇ    ‚ùå ÂèçÂØπÔºö${opinion.votes.disagree} Á•®\n`;
                roundContent += `‚îÇ    üìà ÈÄöËøáÁéáÔºö${passRate}%\n`;
                roundContent += `‚îÇ\n`;
                roundContent += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
            });
            
            // ‰ΩøÁî® File System Access API Êàñ‰º†Áªü‰∏ãËΩΩ
            if (selectedFolderHandle) {
                try {
                    let sessionFolder;
                    try {
                        sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                    } catch (e) {
                        sessionFolder = selectedFolderHandle;
                    }
                    await saveFileToFolder(sessionFolder, roundFilename, roundContent);
                    console.log(`‚úÖ Á¨¨${roundNumber}ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÂ∑≤Áõ¥Êé•‰øùÂ≠òÂà∞Êñá‰ª∂Â§π`);
                } catch (e) {
                    console.error('‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${roundFilename}`, roundContent, 'text/plain;charset=utf-8');
                }
            } else {
                downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${roundFilename}`, roundContent, 'text/plain;charset=utf-8');
            }
            
            console.log(`‚úÖ Á¨¨${roundNumber}ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºöËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${roundFilename}`);
        }
        
        // ÁîüÊàêREADMEÊñá‰ª∂ÔºàËØ¥ÊòéÊñá‰ª∂Â§πÁªìÊûÑÂíå‰ΩøÁî®ÊñπÊ≥ïÔºâ
        function generateReadmeFile() {
            const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            const courseTitle = extractCourseTitle();
            const roundCount = window.discussionRoundCounter || 0;
            const opinionCount = window.allAcceptedOpinions?.length || 0;
            
            let readmeContent = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    EduSymphony ÊïôÁ†îËÆ®ËÆ∫ÁªìÊûúËØ¥Êòé
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}
üìö ËØæÁ®ãÂêçÁß∞Ôºö${courseTitle}
üéØ Á≥ªÁªüÁâàÊú¨ÔºöEduSymphony v1.0
üë• ÂºÄÂèëÂõ¢ÈòüÔºöÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        Êñá‰ª∂Â§πÁªìÊûÑËØ¥Êòé
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Êú¨Êñá‰ª∂Â§πÂåÖÂê´‰∏ÄÊ¨°ÂÆåÊï¥ÁöÑAIÊïôÁ†îËÆ®ËÆ∫‰ºöËØùÁöÑÊâÄÊúâËÆ∞ÂΩïÔºö

üìÅ ${folderName}/
  ‚îú‚îÄ üìÑ README.txt (Êú¨Êñá‰ª∂)
  ‚îÇ
  ‚îú‚îÄ üìÑ ÂàùÊ≠•ÊïôÊ°à.txt
  ‚îÇ   ‚îî‚îÄ ËØ¥ÊòéÔºöÁ¨¨‰∏ÄÈò∂ÊÆµÁîüÊàêÁöÑÂàùÂßãÊïôÊ°àÔºå‰Ωú‰∏∫ËÆ®ËÆ∫ÁöÑÂü∫Á°Ä
  ‚îÇ
  ‚îú‚îÄ üìÑ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json
  ‚îÇ   ‚îî‚îÄ ËØ¥ÊòéÔºöÊâÄÊúâ${opinionCount}‰∏™ÈááÁ∫≥ËßÇÁÇπÁöÑÁªìÊûÑÂåñÊï∞ÊçÆÔºàÂê´ÊäïÁ•®ËØ¶ÊÉÖÔºâ
  ‚îÇ
  ‚îú‚îÄ üìÑ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt
  ‚îÇ   ‚îî‚îÄ ËØ¥ÊòéÔºöÊâÄÊúâËßÇÁÇπÁöÑ‰∫∫Á±ªÂèØËØªÊñáÊú¨Ê†ºÂºèÔºàÂê´ÁªüËÆ°ÂàÜÊûêÔºâ
  ‚îÇ
  ‚îú‚îÄ üìÑ Á¨¨1ËΩÆ_[‰∏ªÈ¢ò]_ËßÇÁÇπ.txt
  ‚îú‚îÄ üìÑ Á¨¨2ËΩÆ_[‰∏ªÈ¢ò]_ËßÇÁÇπ.txt
  ‚îú‚îÄ üìÑ ...
  ‚îú‚îÄ üìÑ Á¨¨${roundCount}ËΩÆ_[‰∏ªÈ¢ò]_ËßÇÁÇπ.txt
  ‚îÇ   ‚îî‚îÄ ËØ¥ÊòéÔºöÊØèËΩÆËÆ®ËÆ∫ÁöÑÁã¨Á´ãËßÇÁÇπËÆ∞ÂΩïÔºàÂÖ±${roundCount}ËΩÆÔºâ
  ‚îÇ
  ‚îú‚îÄ üìÑ ‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt
  ‚îÇ   ‚îî‚îÄ ËØ¥ÊòéÔºöËûçÂêà‰∫Ü${opinionCount}‰∏™‰∏ìÂÆ∂Âª∫ËÆÆÁöÑÊúÄÁªàÊïôÊ°àÔºàÊó†Ê†áÊ≥®ÔºåÂèØÁõ¥Êé•‰ΩøÁî®Ôºâ
  ‚îÇ
  ‚îú‚îÄ üìÑ ‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt
  ‚îÇ   ‚îî‚îÄ ËØ¥ÊòéÔºöÂ∏¶„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÂØπÊØîÊ†áÊ≥®ÁöÑÊïôÊ°àÔºàÂèØÊü•ÁúãÊØèÂ§ÑÊîπËøõÔºâ
  ‚îÇ
  ‚îî‚îÄ üìÑ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt
      ‚îî‚îÄ ËØ¥ÊòéÔºöÂÆåÊï¥ÁöÑËÆ®ËÆ∫ËøáÁ®ãËÆ∞ÂΩïÔºàÂê´‰∏ªÊåÅ‰∫∫ÂèëË®Ä„ÄÅÊäïÁ•®ÁêÜÁî±Á≠âÔºâ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        Êñá‰ª∂‰ΩøÁî®ÊåáÂçó
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÄêÂø´ÈÄüÂºÄÂßã„Äë
‚úì Êü•Áúã"‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt"‚Üí Áõ¥Êé•Ëé∑ÂèñÊúÄÁªà‰ºòÂåñÂêéÁöÑÊïôÊ°à
‚úì Êü•Áúã"‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt"‚Üí ‰∫ÜËß£ÊØèÂ§Ñ‰ºòÂåñÁöÑÊù•Ê∫êÂíåÂØπÊØî
‚úì Êü•Áúã"ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt"‚Üí ‰∫ÜËß£ÂÆåÊï¥ÁöÑËÆ®ËÆ∫ËøáÁ®ã

„ÄêÊ∑±ÂÖ•‰∫ÜËß£„Äë
‚úì "ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json"‚Üí Á®ãÂ∫èÂåñÂ§ÑÁêÜÊï∞ÊçÆ
‚úì "ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt"‚Üí Êü•ÁúãÊâÄÊúâËßÇÁÇπÁöÑËØ¶ÁªÜÊäïÁ•®ÊÉÖÂÜµ
‚úì "Á¨¨NËΩÆ_XXX_ËßÇÁÇπ.txt"‚Üí Êü•ÁúãÊØèËΩÆËÆ®ËÆ∫ÁöÑÁã¨Á´ãËÆ∞ÂΩï

„ÄêÂØπÊØîÂàÜÊûê„Äë
1. ÊâìÂºÄ"ÂàùÊ≠•ÊïôÊ°à.txt"ÔºàÂéüÂßãÁâàÊú¨Ôºâ
2. ÊâìÂºÄ"‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt"Ôºà‰ºòÂåñÁâàÊú¨Ôºâ
3. ÊâìÂºÄ"‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt"ÔºàÂØπÊØîÁâàÊú¨Ôºâ
4. ÂØπÊØî‰∏âËÄÖÔºå‰∫ÜËß£‰ºòÂåñÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÂíåÊïàÊûú

„ÄêAIËûçÂêàËøΩË∏™„Äë
‚Ä¢ Ê†áÊ≥®ÁâàÊïôÊ°à‰∏≠ÊØè‰∏™‚ú®Á¨¶Âè∑‰ª£Ë°®‰∏Ä‰∏™‰∏ìÂÆ∂Âª∫ËÆÆÁöÑËûçÂêàÁÇπ
‚Ä¢ ÂèØÈÄöËøá‰∏ìÂÆ∂ÂßìÂêçËøΩÊ∫ØÂà∞"ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï"‰∏≠ÁöÑÂéüÂßãËßÇÁÇπ
‚Ä¢ ÂèØÊü•ÁúãËØ•ËßÇÁÇπÁöÑÊäïÁ•®ÊÉÖÂÜµÂíåÈÄöËøáÁéá

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        Êï∞ÊçÆÁªüËÆ°
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä ËÆ®ËÆ∫ËΩÆÊ¨°Ôºö${roundCount} ËΩÆ
üí° ÈááÁ∫≥ËßÇÁÇπÔºö${opinionCount} ‰∏™
üë• ÂèÇ‰∏é‰∏ìÂÆ∂Ôºö5‰ΩçAIÊïôÁ†î‰∏ìÂÆ∂
üé§ ‰∏ªÊåÅ‰∫∫ÔºöÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºàQwenÈ©±Âä®Ôºâ
üìà ËÆ®ËÆ∫‰∏ªÈ¢òÔºö${[...new Set(window.allAcceptedOpinions?.map(op => op.section) || [])].join('„ÄÅ')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        ÊäÄÊúØËØ¥Êòé
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ü§ñ ‰ΩøÁî®ÁöÑAIÊ®°ÂûãÔºö
   ‚Ä¢ ÊïôÊ°àÁîüÊàêÔºöQwen-PlusÔºàÈòøÈáåÈÄö‰πâÂçÉÈóÆÔºâ
   ‚Ä¢ ‰∏ìÂÆ∂1ÔºöQwen-PlusÔºàÊïôÊ°à‰ºòÂåñ‰∏ìÂÆ∂Ôºâ
   ‚Ä¢ ‰∏ìÂÆ∂2ÔºöDoubaoÔºàÂàõÊñ∞ÊïôÂ≠¶‰∏ìÂÆ∂Ôºâ
   ‚Ä¢ ‰∏ìÂÆ∂3ÔºöKimiÔºàÂ≠¶ÁîüÂèÇ‰∏é‰∏ìÂÆ∂Ôºâ
   ‚Ä¢ ‰∏ìÂÆ∂4ÔºöGLM-4.5ÔºàËÆ§Áü•ÂèëÂ±ï‰∏ìÂÆ∂Ôºâ
   ‚Ä¢ ‰∏ìÂÆ∂5ÔºöDeepSeekÔºàÊ∑±Â∫¶Â≠¶‰π†‰∏ìÂÆ∂Ôºâ

üíæ Êï∞ÊçÆÊ†ºÂºèÔºö
   ‚Ä¢ JSONÔºöÁªìÊûÑÂåñÊï∞ÊçÆÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑÂÖÉÊï∞ÊçÆÂíåÁªüËÆ°‰ø°ÊÅØ
   ‚Ä¢ TXTÔºöÁ∫ØÊñáÊú¨Ê†ºÂºèÔºå‰æø‰∫éÊü•ÁúãÂíåÁºñËæë
   ‚Ä¢ ÁºñÁ†ÅÔºöUTF-8ÔºàÊîØÊåÅ‰∏≠ÊñáÔºâ

üîÑ Â∑•‰ΩúÊµÅÁ®ãÔºö
   1. ‰∏ä‰º†/ËæìÂÖ•ÊïôÊ°à ‚Üí AIËß£Êûê
   2. ÁîüÊàêÂàùÊ≠•ÊïôÊ°à ‚Üí 5‰Ωç‰∏ìÂÆ∂Áã¨Á´ãÂàÜÊûê
   3. ‰∏ªÊåÅ‰∫∫ÂºïÂØº ‚Üí ‰∏ìÂÆ∂ÈÄêËΩÆËÆ®ËÆ∫ÂíåÊäïÁ•®
   4. Á≠õÈÄâËßÇÁÇπ ‚Üí ËûçÂêàÁîüÊàê‰ºòÂåñÊïôÊ°à
   5. Ëá™Âä®‰øùÂ≠ò ‚Üí ÊâÄÊúâÊñá‰ª∂ÊåâÁªìÊûÑÁªÑÁªá

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        ÁâàÊùÉ‰ø°ÊÅØ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

¬© 2024 EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü
ÂºÄÂèëÔºöÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü
ÊäÄÊúØÔºöMulti-Agent AIÂçè‰Ωú + Êô∫ËÉΩÊñá‰ª∂ÁÆ°ÁêÜ
ÁõÆÊ†áÔºöÊèêÂçáÊïôÊ°àË¥®ÈáèÔºå‰øÉËøõÊïôËÇ≤ÂàõÊñ∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

            const blob = new Blob([readmeContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${folderName}/README.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`‚úÖ READMEÊñá‰ª∂Â∑≤ÁîüÊàêÔºö${folderName}/README.txt`);
        }
        
        // ÁîüÊàêREADMEÂÜÖÂÆπÔºà‰∏ç‰∏ãËΩΩÔºåÂè™ËøîÂõûÂÜÖÂÆπÔºâ
        function generateReadmeContent() {
            const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            const courseTitle = extractCourseTitle();
            const roundCount = window.discussionRoundCounter || 0;
            const opinionCount = window.allAcceptedOpinions?.length || 0;
            
            return `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    EduSymphony ÊïôÁ†îËÆ®ËÆ∫ÁªìÊûúËØ¥Êòé
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}
üìö ËØæÁ®ãÂêçÁß∞Ôºö${courseTitle}
üéØ Á≥ªÁªüÁâàÊú¨ÔºöEduSymphony v1.0
üë• ÂºÄÂèëÂõ¢ÈòüÔºöÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        Êé®ËçêÊñá‰ª∂Â§πÁªìÊûÑ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ËØ∑Â∞ÜÊâÄÊúâ‰∏ãËΩΩÁöÑÊñá‰ª∂Êï¥ÁêÜÂà∞‰ª•‰∏ãÁªìÊûÑÔºö

üìÅ ËÆ®ËÆ∫ÁªìÊûú/
  ‚îî‚îÄ üìÅ ${folderName}/
      ‚îú‚îÄ üìÑ README.txt (Êú¨Êñá‰ª∂)
      ‚îú‚îÄ üìÑ ÂàùÊ≠•ÊïôÊ°à.txt
      ‚îú‚îÄ üìÑ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json
      ‚îú‚îÄ üìÑ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt
${roundCount > 0 ? Array.from({length: roundCount}, (_, i) => `      ‚îú‚îÄ üìÑ Á¨¨${i+1}ËΩÆ_[‰∏ªÈ¢ò]_ËßÇÁÇπ.txt`).join('\n') : ''}
      ‚îú‚îÄ üìÑ ‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt
      ‚îú‚îÄ üìÑ ‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt
      ‚îî‚îÄ üìÑ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        Êï∞ÊçÆÁªüËÆ°
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä ËÆ®ËÆ∫ËΩÆÊ¨°Ôºö${roundCount} ËΩÆ
üí° ÈááÁ∫≥ËßÇÁÇπÔºö${opinionCount} ‰∏™
üë• ÂèÇ‰∏é‰∏ìÂÆ∂Ôºö5‰ΩçAIÊïôÁ†î‰∏ìÂÆ∂
üìà ËÆ®ËÆ∫‰∏ªÈ¢òÔºö${[...new Set(window.allAcceptedOpinions?.map(op => op.section) || [])].join('„ÄÅ')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        Âø´ÈÄü‰ΩøÁî®ÊåáÂçó
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ Áõ¥Êé•‰ΩøÁî®ÔºöÊâìÂºÄ"‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt"
üìù ‰∫ÜËß£ÊîπËøõÔºöÊâìÂºÄ"‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt"
üìä Êü•ÁúãËøáÁ®ãÔºöÊâìÂºÄ"ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt"

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
        }
        
        // ÊúÄÁªàÁ°ÆÂÆöËÆ®ËÆ∫ÁªìÊûú
        async function finalizeDiscussionResults(opinions, topic, roundId, roundNumber) {
            let discussionArea = document.getElementById(`discussion-${roundId}`);
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñËÆ®ËÆ∫Âå∫Âüü
            if (!discussionArea) {
                let retryCount = 0;
                while (!discussionArea && retryCount < 3) {
                    console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussion-${roundId}ÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                    await delay(300);
                    discussionArea = document.getElementById(`discussion-${roundId}`);
                    retryCount++;
                }
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùËÆ®ËÆ∫Âå∫ÂüüÂ≠òÂú®
            if (!discussionArea) {
                console.error(`‚ùå Êó†Ê≥ïÊâæÂà∞ËÆ®ËÆ∫Âå∫Âüü discussion-${roundId}Ôºå‰ΩÜ‰ªç‰ºö‰øùÂ≠òËßÇÁÇπÊï∞ÊçÆ`);
                // Âç≥‰ΩøÊòæÁ§∫Â§±Ë¥•Ôºå‰πüË¶ÅÁªßÁª≠ÊâßË°åÊï∞ÊçÆ‰øùÂ≠òÈÄªËæë
            } else if (!document.body.contains(discussionArea)) {
                console.error(`‚ùå discussionArea discussion-${roundId} ‰∏çÂú®DOMÊ†ë‰∏≠Ôºå‰ΩÜ‰ªç‰ºö‰øùÂ≠òËßÇÁÇπÊï∞ÊçÆ`);
                discussionArea = null; // Ê†áËÆ∞‰∏∫Êó†Êïà
            }

            // ===== üíæ ÂàùÂßãÂåñÂÖ®Â±ÄËÆ®ËÆ∫ËÆ∞ÂΩïÊï∞ÁªÑ =====
            if (!window.allRoundRecords) {
                window.allRoundRecords = [];
                console.log('üîß ÂàùÂßãÂåñ window.allRoundRecords ËÆ®ËÆ∫ËΩÆÊ¨°ËÆ∞ÂΩïÊï∞ÁªÑ');
            }

            // ===== üíæ ÂÖ≥ÈîÆÊîπËøõÔºöÂÖà‰øùÂ≠òÊâÄÊúâËßÇÁÇπÂà∞Â§á‰ªΩÔºå‰∏çÁÆ°ÊòØÂê¶Ë¢´ÈááÁ∫≥ =====
            console.log(`\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'color: #13c2c2; font-weight: bold;');
            console.log(`%cüíæ ‰øùÂ≠òÁ¨¨${roundNumber}ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂê´ÊâÄÊúâËßÇÁÇπÔºâ`, 'color: #13c2c2; font-size: 14px; font-weight: bold;');
            console.log(`%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'color: #13c2c2; font-weight: bold;');
            
            // ‰∏∫ÊâÄÊúâËßÇÁÇπÊ∑ªÂä†ÂÆåÊï¥‰ø°ÊÅØÔºàÂú®Á≠õÈÄâ‰πãÂâç‰øùÂ≠òÔºâ
            const allOpinionsWithInfo = opinions.map((opinion, index) => ({
                expert: {
                    key: opinion.expert.key,
                    name: opinion.expert.name,
                    specialty: opinion.expert.specialty,
                    color: opinion.expert.color,
                    avatar: opinion.expert.avatar
                },
                content: opinion.content,
                section: topic.section,
                topicTitle: topic.title,
                topicDescription: topic.description,
                votes: {
                    agree: opinion.votes.agree,
                    disagree: opinion.votes.disagree,
                    voters: opinion.votes.voters || []
                },
                timestamp: new Date().toISOString(),
                globalIndex: (_allAcceptedOpinions?.length || 0) + index + 1,
                isAccepted: false // ÂæÖÁ°ÆÂÆö
            }));
            
            // ===== üíæ ‰øùÂ≠òÊú¨ËΩÆÂÆåÊï¥ËÆ∞ÂΩïÔºàÂåÖÊã¨ÊâÄÊúâËßÇÁÇπÂíåÊäïÁ•®ËØ¶ÊÉÖÔºâ=====
            // ÂêåÊó∂‰øùÂ≠òËØ•ËΩÆÊ¨°ÂØπÂ∫îÁöÑÂàùÂßãÊïôÊ°àÁ´†ËäÇÂÜÖÂÆπ
            const initialPlan = window.initialTeachingPlan || parsedFileContent;
            const sectionContent = extractSectionContent(initialPlan, topic.section);
            
            const roundRecord = {
                roundNumber: roundNumber,
                topic: {
                    title: topic.title,
                    section: topic.section,
                    description: topic.description
                },
                initialSectionContent: sectionContent, // ‰øùÂ≠òËØ•Á´†ËäÇÁöÑÂàùÂßãÂÜÖÂÆπ
                opinions: allOpinionsWithInfo, // ÂåÖÂê´ÊâÄÊúâËßÇÁÇπÔºàÈááÁ∫≥+Êú™ÈááÁ∫≥Ôºâ
                timestamp: new Date().toISOString(),
                timestampReadable: new Date().toLocaleString('zh-CN')
            };
            
            window.allRoundRecords.push(roundRecord);
            console.log(`üìÅ Á¨¨${roundNumber}ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÂà∞ window.allRoundRecords`);
            console.log(`   ‰∏ªÈ¢òÔºö${topic.title}`);
            console.log(`   ËßÇÁÇπÊï∞Ôºö${allOpinionsWithInfo.length}`);
            console.log(`   ÂàùÂßãÁ´†ËäÇÂÜÖÂÆπÈïøÂ∫¶Ôºö${sectionContent.length}`);
            
            // Â§á‰ªΩÂà∞localStorage
            try {
                localStorage.setItem('allRoundRecords', JSON.stringify(window.allRoundRecords));
                console.log(`üíæ Â∑≤Â§á‰ªΩÊâÄÊúâ${window.allRoundRecords.length}ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÂà∞localStorage`);
            } catch (e) {
                console.error('localStorageÂ§á‰ªΩÂ§±Ë¥•:', e);
            }
            
            // Á≠õÈÄâÂá∫Á•®Êï∞Ë∂ÖËøáÈòàÂÄºÁöÑËßÇÁÇπÔºàÈôç‰ΩéÈòàÂÄº‰ªé50%Âà∞40%Ôºâ
            console.log(`\nüìä ÂºÄÂßãÁ≠õÈÄâËßÇÁÇπÔºåÂÖ± ${opinions.length} ‰∏™ËßÇÁÇπÈúÄË¶ÅÊäïÁ•®`);
            console.log(`üéØ ÈááÁ∫≥ÈòàÂÄºÔºö40%ÔºàÂ∑≤‰ªé50%Èôç‰ΩéÔºâ`);
            
            const acceptedOpinions = opinions.filter((opinion, index) => {
                const totalVotes = opinion.votes.agree + opinion.votes.disagree;
                const failedVotes = (opinion.votes.voters || []).filter(v => v.isValid === false || v.vote === 'failed').length;
                const agreeRate = totalVotes > 0 ? opinion.votes.agree / totalVotes : 0;
                const isAccepted = agreeRate >= 0.4; // Èôç‰ΩéÂà∞40%ÈòàÂÄº
                
                // Ê†áËÆ∞ËØ•ËßÇÁÇπÊòØÂê¶Ë¢´ÈááÁ∫≥
                allOpinionsWithInfo[index].isAccepted = isAccepted;
                
                console.log(`üìã ËßÇÁÇπÊäïÁ•®ÁªüËÆ°Ôºö`, {
                    expert: opinion.expert.name,
                    content: opinion.content.substring(0, 50) + '...',
                    agree: opinion.votes.agree,
                    disagree: opinion.votes.disagree,
                    totalValid: totalVotes,
                    failed: failedVotes,
                    agreeRate: (agreeRate * 100).toFixed(1) + '%',
                    threshold: '40%',
                    isAccepted: isAccepted ? '‚úÖ ÈááÁ∫≥' : '‚ùå Ê∑òÊ±∞'
                });
                
                return isAccepted;
            });
            
            console.log(`‚úÖ Á≠õÈÄâÂÆåÊàêÔºöÈááÁ∫≥ ${acceptedOpinions.length} ‰∏™ËßÇÁÇπÔºåÊ∑òÊ±∞ ${opinions.length - acceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
            
            // ===== üíæ ÂÖ≥ÈîÆÊîπËøõÔºöÊó†ËÆ∫ÊòØÂê¶ÊúâÈááÁ∫≥ÁöÑËßÇÁÇπÔºåÈÉΩ‰øùÂ≠òÊâÄÊúâËÆ®ËÆ∫ËÆ∞ÂΩï =====
            if (allOpinionsWithInfo.length > 0) {
                console.log(`\n%cüíæ ‰øùÂ≠òÊâÄÊúâ${allOpinionsWithInfo.length}‰∏™ËÆ®ËÆ∫ËßÇÁÇπÂà∞Â§á‰ªΩÔºàÂê´Êú™ÈááÁ∫≥Ôºâ`, 'color: #1890ff; font-weight: bold;');
                
                // ‰øùÂ≠òÂà∞‰∏¥Êó∂Â§á‰ªΩ
                if (!window.allDiscussedOpinions) {
                    window.allDiscussedOpinions = [];
                }
                window.allDiscussedOpinions.push(...allOpinionsWithInfo);
                
                // Â§á‰ªΩÂà∞localStorageÔºàÊâÄÊúâËßÇÁÇπÔºåÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑÔºâ
                try {
                    const backupData = {
                        allDiscussed: window.allDiscussedOpinions,
                        accepted: acceptedOpinions,
                        timestamp: new Date().toISOString(),
                        totalDiscussed: window.allDiscussedOpinions.length,
                        totalAccepted: acceptedOpinions.length
                    };
                    localStorage.setItem('allDiscussedOpinions_backup', JSON.stringify(backupData));
                    console.log(`üíæ Â∑≤Â§á‰ªΩ ${window.allDiscussedOpinions.length} ‰∏™ËÆ®ËÆ∫ËßÇÁÇπÂà∞localStorage`);
                } catch (e) {
                    console.error('localStorageÂ§á‰ªΩÂ§±Ë¥•:', e);
                }
            }
            
            if (acceptedOpinions.length === 0 && opinions.length > 0) {
                console.warn('\n%c‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Ë≠¶ÂëäÔºöÊú¨ËΩÆÊâÄÊúâËßÇÁÇπÈÉΩÊú™ËææÂà∞40%ÂêåÊÑèÁéáÈòàÂÄº', 'color: #ff4d4f; font-size: 14px; font-weight: bold;');
                console.warn('%cÂèØËÉΩÂéüÂõ†:', 'color: #faad14; font-weight: bold;');
                console.warn('  - ÊäïÁ•®Â§±Ë¥•ÂØºËá¥ÊúâÊïàÊäïÁ•®Êï∞‰∏çË∂≥');
                console.warn('  - ËßÇÁÇπË¥®Èáè‰∏çÈ´òÔºåÊú™ËÉΩËé∑ÂæóË∂≥Â§üÊîØÊåÅ');
                console.warn('  - ‰∏ìÂÆ∂ÊÑèËßÅÂàÜÊ≠ßËæÉÂ§ß');
                console.warn('\n%cüí° Á≥ªÁªüÂ∞ÜÁªßÁª≠‰øùÁïôÊâÄÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑËßÇÁÇπÔºâ', 'color: #1890ff; font-weight: bold;');
            }

            // ‰øùÂ≠òÈááÁ∫≥ÁöÑËßÇÁÇπÂà∞ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÈáçÊñ∞ËÆ®ËÆ∫Êó∂‰øùÁïô
            window.acceptedOpinions = acceptedOpinions;
            
            // ===== üíæ Êñ∞Â¢ûÔºö‰øùÂ≠òÊú¨ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÂà∞ÂçïÁã¨Êñá‰ª∂ =====
            if (roundNumber && acceptedOpinions.length > 0) {
                await saveRoundDiscussionToFile(acceptedOpinions, topic, roundNumber);
            }

            // ÊòæÁ§∫Á≠õÈÄâÁªìÊûúÔºàÂå∫ÂàÜÊúâÈááÁ∫≥ÂíåÊó†ÈááÁ∫≥ÁöÑÊÉÖÂÜµÔºâ
            const resultsHeader = document.createElement('div');
            resultsHeader.className = 'discussion-results-header';
            
            if (acceptedOpinions.length === 0) {
                // Êó†ÈááÁ∫≥ËßÇÁÇπÁöÑË≠¶ÂëäÊ†∑Âºè
                resultsHeader.style.cssText = `
                    background: rgba(250, 173, 20, 0.15);
                    border: 2px solid rgba(250, 173, 20, 0.4);
                    border-radius: 12px;
                    padding: 25px;
                    margin: 20px 0;
                    text-align: center;
                `;
                resultsHeader.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: #faad14; font-size: 1.3rem; font-weight: 600; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>‚ö†Ô∏è Êú¨ËΩÆËÆ®ËÆ∫Êó†ËßÇÁÇπË¢´ÈááÁ∫≥</span>
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 1rem; line-height: 1.8; margin-bottom: 15px;">
                        ÈíàÂØπ„Äê${topic.section}„ÄëÔºö${opinions.length} ‰∏™ËßÇÁÇπÂùáÊú™ËææÂà∞40%ÂêåÊÑèÁéáÈòàÂÄº
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <div style="color: rgba(255,255,255,0.85); font-size: 0.9rem; line-height: 1.8; text-align: left;">
                            <strong style="color: #1890ff;">üìå ÂèØËÉΩÂéüÂõ†Ôºö</strong><br>
                            ‚Ä¢ ‰∏ìÂÆ∂ËßÇÁÇπËøá‰∫éÁêÜËÆ∫ÂåñÔºåÊú™ËÉΩËé∑ÂæóË∂≥Â§üÊîØÊåÅ<br>
                            ‚Ä¢ ÈÉ®ÂàÜAIÊäïÁ•®Â§±Ë¥•ÔºåÂØºËá¥ÊúâÊïàÊäïÁ•®Êï∞‰∏çË∂≥<br>
                            ‚Ä¢ ‰∏ìÂÆ∂ÊÑèËßÅÂàÜÊ≠ßËæÉÂ§ßÔºåÊú™ËÉΩËææÊàêÂÖ±ËØÜ<br><br>
                            <strong style="color: #52c41a;">‚úÖ Á≥ªÁªüÂ∑≤Â§ÑÁêÜÔºö</strong><br>
                            ‚Ä¢ ÊâÄÊúâËÆ®ËÆ∫ËßÇÁÇπÂ∑≤‰øùÂ≠òÂà∞Â§á‰ªΩËÆ∞ÂΩïÔºàÂê´ÊäïÁ•®ËØ¶ÊÉÖÔºâ<br>
                            ‚Ä¢ Â∞ÜÁªßÁª≠‰∏ã‰∏Ä‰∏ªÈ¢òÁöÑËÆ®ËÆ∫<br>
                            ‚Ä¢ ÊúÄÁªàÊïôÊ°àÂ∞ÜÂü∫‰∫éÂàùÂßãÊïôÊ°àÂíåÂÖ∂‰ªñ‰∏ªÈ¢òÁöÑÈááÁ∫≥Âª∫ËÆÆÁîüÊàê
                        </div>
                    </div>
                `;
            } else {
                // ÊúâÈááÁ∫≥ËßÇÁÇπÁöÑÊ≠£Â∏∏Ê†∑Âºè
                resultsHeader.style.cssText = `
                    background: rgba(82, 196, 26, 0.1);
                    border: 1px solid rgba(82, 196, 26, 0.3);
                    border-radius: 12px;
                    padding: 20px;
                    margin: 20px 0;
                    text-align: center;
                `;
                resultsHeader.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: #52c41a; font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i>
                        <span>Êú¨ËΩÆËÆ®ËÆ∫ÁªìÊûú</span>
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 1rem;">
                        ÈíàÂØπ„Äê${topic.section}„ÄëÔºöÈááÁ∫≥ ${acceptedOpinions.length} ‰∏™Âª∫ËÆÆÔºåÊ∑òÊ±∞ ${opinions.length - acceptedOpinions.length} ‰∏™Âª∫ËÆÆ
                    </div>
                `;
            }
            
            // Âè™Âú®discussionAreaÂ≠òÂú®Êó∂ÊâçÊòæÁ§∫ÁªìÊûú
            if (discussionArea) {
                discussionArea.appendChild(resultsHeader);

                // ÊòæÁ§∫ÈááÁ∫≥ÁöÑËßÇÁÇπ
                if (acceptedOpinions.length > 0) {
                    for (const opinion of acceptedOpinions) {
                        const acceptedDiv = document.createElement('div');
                        acceptedDiv.className = 'accepted-opinion';
                        acceptedDiv.innerHTML = `
                            <div class="accepted-header">
                                <div class="accepted-avatar" style="background: ${opinion.expert.color}">
                                    ${opinion.expert.avatar}
                                </div>
                                <div class="accepted-info">
                                    <div class="accepted-expert">${opinion.expert.name}</div>
                                    <div class="accepted-specialty">${opinion.expert.specialty}</div>
                                </div>
                                <span class="accepted-badge">‚úÖ ÈááÁ∫≥</span>
                            </div>
                            <div class="accepted-content">${opinion.content}</div>
                        `;
                        discussionArea.appendChild(acceptedDiv);
                    }
                } else {
                    const noOpinionDiv = document.createElement('div');
                    noOpinionDiv.style.cssText = `
                        color: rgba(255,255,255,0.7);
                        text-align: center;
                        padding: 20px;
                        background: rgba(0,0,0,0.2);
                        border-radius: 8px;
                        margin: 15px 0;
                    `;
                    noOpinionDiv.innerHTML = `
                        <i class="fas fa-info-circle"></i> Êú¨ËΩÆËÆ®ËÆ∫ÊöÇÊó†Âª∫ËÆÆË¢´ÈááÁ∫≥ÔºåÂ∞ÜÁªßÁª≠‰ΩøÁî®ÂàùÂßãÊïôÊ°àÁöÑÂéüÊúâÂÜÖÂÆπ
                    `;
                    discussionArea.appendChild(noOpinionDiv);
                }
            }

            // Â∞ÜÈááÁ∫≥ÁöÑËßÇÁÇπÁ¥ØÁßØÂà∞ÂÖ®Â±ÄÂàóË°®ÔºàÁî®‰∫éÊúÄÂêéËûçÂêàÔºâ
            await generateFinalResults(acceptedOpinions, topic);
            
            // ===== ÊòæÁ§∫ËßÇÁÇπ‰øùÂ≠òÁ°ÆËÆ§ÔºàÂèØËßÜÂåñÂèçÈ¶àÔºâ=====
            if (acceptedOpinions.length > 0 && discussionArea) {
                const saveConfirmDiv = document.createElement('div');
                saveConfirmDiv.style.cssText = `
                    background: linear-gradient(135deg, rgba(82, 196, 26, 0.2), rgba(82, 196, 26, 0.1));
                    border: 2px solid rgba(82, 196, 26, 0.4);
                    border-radius: 12px;
                    padding: 20px;
                    margin: 20px 0;
                    animation: slideInSave 0.5s ease;
                `;
                const folderPath = window.currentFolderName ? `ËÆ®ËÆ∫ÁªìÊûú/${window.currentFolderName}` : '‰∏ãËΩΩÊñá‰ª∂Â§π';
                saveConfirmDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <i class="fas fa-save" style="color: #52c41a; font-size: 1.5rem;"></i>
                        <strong style="color: #52c41a; font-size: 1.1rem;">‚úÖ Êú¨ËΩÆËßÇÁÇπÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Êñá‰ª∂</strong>
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.8;">
                        üìå ÈíàÂØπ„Äê${topic.section}„ÄëÔºöÂ∑≤‰øùÂ≠ò ${acceptedOpinions.length} ‰∏™ÈááÁ∫≥ÁöÑËßÇÁÇπ<br>
                        üíæ Á¥ØËÆ°Â∑≤‰øùÂ≠òÔºö${window.allAcceptedOpinions?.length || 0} ‰∏™ËßÇÁÇπÔºàÊù•Ëá™ÊâÄÊúâËÆ®ËÆ∫‰∏ªÈ¢òÔºâ<br>
                        üìÅ Êú¨ËΩÆÊñá‰ª∂Ôºö<code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; color: #52c41a;">${folderPath}/Á¨¨${roundNumber}ËΩÆ_${topic.section}_ËßÇÁÇπ.txt</code><br>
                        üìÇ ÂÆåÊï¥ËÆ∞ÂΩïÔºö<code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; color: #1890ff;">${folderPath}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json + .txt</code><br>
                        üîÑ Ëøô‰∫õËßÇÁÇπÂ∞ÜÂú®ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂Ëá™Âä®‰º†ÈÄíÁªôAI
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: rgba(24,144,255,0.1); border: 1px solid rgba(24,144,255,0.3); border-radius: 8px;">
                        <div style="color: #1890ff; font-weight: 600; margin-bottom: 8px;">
                            <i class="fas fa-info-circle"></i> ‰øùÂ≠òËØ¶ÊÉÖÔºàÊéßÂà∂Âè∞ÂèØËßÅÔºâ:
                        </div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; line-height: 1.6; font-family: monospace;">
                            ‚úì window.allAcceptedOpinions: ${window.allAcceptedOpinions?.length || 0} Êù°<br>
                            ‚úì window.opinionsRecordJSON: ${window.opinionsRecordJSON ? 'Â∑≤ÁîüÊàê' : 'Êú™ÁîüÊàê'}<br>
                            ‚úì window.opinionsRecordTXT: ${window.opinionsRecordTXT ? 'Â∑≤ÁîüÊàê' : 'Êú™ÁîüÊàê'}<br>
                            ‚úì localStorageÂ§á‰ªΩ: Â∑≤ÂêåÊ≠•
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="downloadCurrentOpinionsRecord()" style="background: linear-gradient(135deg, #1890ff, #40a9ff); font-size: 0.9rem;">
                            <i class="fas fa-download"></i> ÈáçÊñ∞‰∏ãËΩΩËÆ∞ÂΩïÊñá‰ª∂
                        </button>
                        <button class="btn" onclick="viewSavedOpinions()" style="background: linear-gradient(135deg, #722ed1, #9254de); font-size: 0.9rem;">
                            <i class="fas fa-database"></i> Êü•ÁúãÊâÄÊúâËßÇÁÇπ
                        </button>
                        <button class="btn" onclick="showFileOrganizationGuide()" style="background: linear-gradient(135deg, #fa8c16, #faad14); font-size: 0.9rem;">
                            <i class="fas fa-folder-tree"></i> Êñá‰ª∂Â§πÊåáÂçó
                        </button>
                    </div>
                    <details style="margin-top: 12px; cursor: pointer;">
                        <summary style="color: #1890ff; font-weight: 600; padding: 8px; background: rgba(24,144,255,0.1); border-radius: 6px; list-style: none;">
                            <i class="fas fa-eye"></i> ÁÇπÂáªÊü•ÁúãÊú¨ËΩÆ‰øùÂ≠òÁöÑËßÇÁÇπËØ¶ÊÉÖ
                        </summary>
                        <div style="margin-top: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            ${acceptedOpinions.map((op, i) => `
                                <div style="margin: 8px 0; padding: 10px; background: rgba(255,255,255,0.05); border-left: 3px solid ${op.expert.color}; border-radius: 4px;">
                                    <strong style="color: ${op.expert.color};">${i+1}. ${op.expert.name}</strong>Ôºà${op.expert.specialty}Ôºâ<br>
                                    <span style="color: rgba(255,255,255,0.85); font-size: 0.9rem; margin-top: 5px; display: block;">
                                        ${op.content}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
                discussionArea.appendChild(saveConfirmDiv);
                
                await delay(500);
            }
        }

        // ÊòæÁ§∫ÁîüÊàêÊïôÂ≠¶ÊùêÊñôÊåâÈíÆ
        function showGenerateCourseMaterialButton(discussionArea) {
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùËÆ®ËÆ∫Âå∫ÂüüÂ≠òÂú®
            if (!discussionArea) {
                console.error('‚ùå discussionArea‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊòæÁ§∫ÁîüÊàêÊïôÂ≠¶ÊùêÊñôÊåâÈíÆ');
                return;
            }
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'course-material-button-section';
            buttonContainer.id = 'courseMaterialButtonSection';
            buttonContainer.style.cssText = `
                background: linear-gradient(135deg, rgba(19, 194, 194, 0.2), rgba(19, 194, 194, 0.1));
                border: 2px solid rgba(19, 194, 194, 0.4);
                border-radius: 16px;
                padding: 40px;
                margin: 30px 0;
                text-align: center;
                animation: fadeInUp 0.8s ease;
            `;
            
            buttonContainer.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #13c2c2; font-size: 1.8rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàê</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; line-height: 1.8; max-width: 800px; margin: 0 auto;">
                        üìö Âü∫‰∫é‰∏ìÂÆ∂ËÆ®ËÆ∫ÁöÑÁªìÊûúÂíå‰ºòÂåñÂêéÁöÑÊïôÊ°à<br>
                        üé® ÁîüÊàêÁ≤æÁæéÁöÑ‰∫§‰∫íÂºèHTMLËØæÁ®ãÊºîÁ§∫È°µÈù¢<br>
                        üî¨ ÂåÖÂê´Áü•ËØÜÁÇπËØ¶Ëß£„ÄÅÂä®ÁîªÊºîÁ§∫„ÄÅ‰∫íÂä®ÁªÉ‰π†Á≠âÂäüËÉΩ
                    </p>
                </div>
                <button id="generateMaterialBtn" class="material-btn" onclick="triggerCourseMaterialGeneration()" 
                    style="background: linear-gradient(135deg, #13c2c2, #36cfc9); 
                           color: white; 
                           border: none; 
                           padding: 18px 48px; 
                           border-radius: 12px; 
                           font-size: 1.2rem; 
                           font-weight: 600; 
                           cursor: pointer; 
                           transition: all 0.3s ease;
                           box-shadow: 0 8px 24px rgba(19, 194, 194, 0.4);
                           display: inline-flex;
                           align-items: center;
                           gap: 12px;">
                    <i class="fas fa-magic"></i>
                    <span>ÂºÄÂßãÁîüÊàêÊïôÂ≠¶ÊùêÊñô</span>
                </button>
                <div style="margin-top: 20px; color: rgba(255,255,255,0.7); font-size: 0.95rem;">
                    üí° ÊèêÁ§∫ÔºöÁîüÊàêËøáÁ®ãÂèØËÉΩÈúÄË¶Å1-2ÂàÜÈíüÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ
                </div>
            `;
            
            discussionArea.appendChild(buttonContainer);
            
            // ÊªöÂä®Âà∞ÊåâÈíÆÂå∫Âüü
            setTimeout(() => {
                ScrollManager.scrollTo(buttonContainer, { offset: 80 });
            }, 300);
        }
        
        // Ëß¶ÂèëËØæÁ®ãÊùêÊñôÁîüÊàê
        window.triggerCourseMaterialGeneration = async function() {
            const btn = document.getElementById('generateMaterialBtn');
            const buttonSection = document.getElementById('courseMaterialButtonSection');
            
            if (!btn || !buttonSection) return;
            
            // Á¶ÅÁî®ÊåâÈíÆ
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Ê≠£Âú®ÁîüÊàê‰∏≠...</span>';
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';
            
            try {
                // Ëé∑ÂèñËÆ®ËÆ∫Âå∫ÂüüÂÆπÂô®
                const discussionArea = document.getElementById('discussionRounds');
                
                // Ë∞ÉÁî®ÁîüÊàêÂáΩÊï∞
                await generateCourseMaterial(discussionArea);
                
                // ÁîüÊàêÂÆåÊàêÂêéÈöêËóèÊåâÈíÆÂå∫Âüü
                buttonSection.style.transition = 'all 0.5s ease';
                buttonSection.style.opacity = '0';
                buttonSection.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    buttonSection.style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error('ÊïôÂ≠¶ÊùêÊñôÁîüÊàêÂ§±Ë¥•:', error);
                
                // ÊÅ¢Â§çÊåâÈíÆ
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i> <span>ÈáçÊñ∞ÁîüÊàê</span>';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                
                showMessage('ÊïôÂ≠¶ÊùêÊñôÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        };

        // ÁîüÊàêÊúÄÁªàÁªìÊûúÔºà‰∏ªÊåÅ‰∫∫‰∏çÂú®ËøôÈáåÁîüÊàêÔºåËÄåÊòØÂú®ÊâÄÊúâËÆ®ËÆ∫ÁªìÊùüÂêéÁªü‰∏ÄÁîüÊàêÔºâ
        async function generateFinalResults(acceptedOpinions, topic) {
            // ===== ÂÖ≥ÈîÆÔºöÂ∞ÜÈááÁ∫≥ÁöÑËßÇÁÇπÁ¥ØÁßØ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºàÊ∞∏‰πÖ‰øùÂ≠òÔºâ=====
            // Áªù‰∏çÈáçÊñ∞ÂàùÂßãÂåñÔºåÂè™ËøΩÂä†
            if (!window.allAcceptedOpinions) {
                // Â∞ùËØï‰ªélocalStorageÊÅ¢Â§ç
                try {
                    const backup = localStorage.getItem('allAcceptedOpinions_backup');
                    if (backup) {
                        const parsed = JSON.parse(backup);
                        if (parsed.opinions && parsed.opinions.length > 0) {
                            // Áõ¥Êé•ËµãÂÄºÁªôÂÜÖÈÉ®ÂèòÈáèÔºåÁªïËøásetter
                            _allAcceptedOpinions = parsed.opinions;
                            console.log(`%cüîÑ ‰ªélocalStorageÊÅ¢Â§ç ${_allAcceptedOpinions.length} Êù°Êï∞ÊçÆ`, 'color: #52c41a; font-weight: bold;');
                        } else {
                            _allAcceptedOpinions = [];
                            console.log('üîß È¶ñÊ¨°ÂàõÂª∫ _allAcceptedOpinions ÂÖ®Â±ÄËßÇÁÇπÂàóË°®');
                        }
                    } else {
                        _allAcceptedOpinions = [];
                        console.log('üîß È¶ñÊ¨°ÂàõÂª∫ _allAcceptedOpinions ÂÖ®Â±ÄËßÇÁÇπÂàóË°®');
                    }
                } catch (e) {
                    _allAcceptedOpinions = [];
                    console.log('üîß È¶ñÊ¨°ÂàõÂª∫ _allAcceptedOpinions ÂÖ®Â±ÄËßÇÁÇπÂàóË°®');
                }
            }
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log(`üìù Êî∂ÈõÜËßÇÁÇπÂà∞Ê∞∏‰πÖÂàóË°®`);
            console.log(`   ÂΩìÂâç‰∏ªÈ¢òÔºö„Äê${topic.section}„Äë- ${topic.title}`);
            console.log(`   Êú¨ËΩÆÈááÁ∫≥Ôºö${acceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
            console.log(`   ÂàóË°®ÂΩìÂâçÔºö${_allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            // ===== üíæ ÂÖ≥ÈîÆÊîπËøõÔºöÂç≥‰ΩøÊ≤°ÊúâÈááÁ∫≥ÁöÑËßÇÁÇπÔºå‰πüË¶ÅÊèêÁ§∫Áî®Êà∑Âπ∂‰øùÂ≠òËÆ®ËÆ∫ËÆ∞ÂΩï =====
            if (acceptedOpinions.length === 0) {
                console.warn('\n%c‚ö†Ô∏è Êú¨ËΩÆËÆ®ËÆ∫Ê≤°ÊúâËßÇÁÇπË¢´ÈááÁ∫≥ÔºàÊú™ËææÂà∞40%ÈòàÂÄºÔºâ', 'color: #faad14; font-weight: bold;');
                console.log('%cüí° ‰ΩÜÊâÄÊúâËÆ®ËÆ∫ËßÇÁÇπÂ∑≤‰øùÂ≠òÂà∞ window.allDiscussedOpinions', 'color: #1890ff;');
                console.log(`%c   ÂÖ± ${window.allDiscussedOpinions?.length || 0} ‰∏™ËßÇÁÇπÔºàÂåÖÂê´Êú¨ËΩÆÂíå‰πãÂâçÁöÑÔºâ`, 'color: #1890ff;');
                
                // Âç≥‰ΩøÊ≤°ÊúâÈááÁ∫≥Ôºå‰πüË¶ÅÊõ¥Êñ∞ËÆ°Êï∞Âô®ÔºàÊòæÁ§∫ËÆ®ËÆ∫ËøáÁöÑËßÇÁÇπÊï∞Ôºâ
                setTimeout(() => {
                    updateSavedOpinionsCounter();
                }, 200);
                
                return; // ÊèêÂâçËøîÂõûÔºåË∑≥ËøáÂêéÁª≠‰øùÂ≠òÈÄªËæë
            }
            
            // ‰∏∫ÊØè‰∏™ËßÇÁÇπÊ∑ªÂä†ÂÆåÊï¥‰ø°ÊÅØÔºàÁ´†ËäÇ„ÄÅ‰∏ªÈ¢ò„ÄÅÊäïÁ•®ËØ¶ÊÉÖÔºâ
            acceptedOpinions.forEach((opinion, index) => {
                console.log(`\nüîç Ê≠£Âú®Â§ÑÁêÜËßÇÁÇπ ${index + 1}/${acceptedOpinions.length}:`);
                console.log(`   ‰∏ìÂÆ∂: ${opinion.expert?.name || 'Êú™Áü•'}`);
                console.log(`   ÂÜÖÂÆπ: ${opinion.content?.substring(0, 50) || 'Á©∫'}...`);
                console.log(`   ÊäïÁ•®: ${JSON.stringify(opinion.votes)}`);
                
                const opinionWithFullInfo = {
                    // ‰∏ìÂÆ∂‰ø°ÊÅØ
                    expert: {
                        key: opinion.expert.key,
                        name: opinion.expert.name,
                        specialty: opinion.expert.specialty,
                        color: opinion.expert.color,
                        avatar: opinion.expert.avatar
                    },
                    // ËßÇÁÇπÂÜÖÂÆπ
                    content: opinion.content,
                    // Á´†ËäÇ‰ø°ÊÅØ
                    section: topic.section,
                    topicTitle: topic.title,
                    // ÊäïÁ•®‰ø°ÊÅØÔºà‰øùÁïôÁî®‰∫éËøΩÊ∫ØÔºâ
                    votes: {
                        agree: opinion.votes.agree,
                        disagree: opinion.votes.disagree,
                        voters: opinion.votes.voters || []
                    },
                    // Êó∂Èó¥Êà≥
                    timestamp: new Date().toISOString(),
                    // Â∫èÂè∑ÔºàÂú®ÂÖ®Â±ÄÂàóË°®‰∏≠ÁöÑ‰ΩçÁΩÆÔºâ
                    globalIndex: _allAcceptedOpinions.length + 1
                };
                
                // ‚≠ê ÂÖ≥ÈîÆÔºöÁõ¥Êé•pushÂà∞ÂÜÖÈÉ®Êï∞ÁªÑÔºåÁªïËøásetter
                _allAcceptedOpinions.push(opinionWithFullInfo);
                
                console.log(`   ‚úÖ Â∑≤ÊàêÂäüÊ∑ªÂä†Âà∞ÂÖ®Â±ÄÂàóË°® #${opinionWithFullInfo.globalIndex}`);
                console.log(`   üìä ÂΩìÂâçÂÖ®Â±ÄÂàóË°®ÂåÖÂê´: ${_allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
                console.log(`   üíæ ËßÇÁÇπËØ¶ÊÉÖ: [${topic.section}] ${opinion.expert.name}Ôºà${opinion.expert.specialty}Ôºâ`);
                console.log(`      ËßÇÁÇπÂÜÖÂÆπÔºö${opinion.content.substring(0, 80)}${opinion.content.length > 80 ? '...' : ''}`);
                console.log(`      ÊäïÁ•®ÁªüËÆ°ÔºöÂêåÊÑè${opinion.votes.agree} ÂèçÂØπ${opinion.votes.disagree} ÈÄöËøáÁéá${((opinion.votes.agree / (opinion.votes.agree + opinion.votes.disagree)) * 100).toFixed(1)}%`);
            });
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log(`‚úÖ Êú¨ËΩÆ‰øùÂ≠òÂÆåÊàêÔºö${acceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
            console.log(`üìä ÂÖ®Â±ÄÂàóË°®Êõ¥Êñ∞ÔºöÁé∞ÂÖ± ${_allAcceptedOpinions.length} ‰∏™Â∑≤ÈááÁ∫≥ËßÇÁÇπ`);
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            // ===== Á´ãÂç≥Â§á‰ªΩÂà∞localStorageÔºàÂú®‰øùÂ≠òÊñá‰ª∂‰πãÂâçÔºâ=====
            try {
                const backupData = {
                    opinions: _allAcceptedOpinions,
                    timestamp: new Date().toISOString(),
                    totalCount: _allAcceptedOpinions.length
                };
                localStorage.setItem('allAcceptedOpinions_backup', JSON.stringify(backupData));
                console.log('%cüíæ Â∑≤Á´ãÂç≥Â§á‰ªΩÂà∞localStorage', 'color: #52c41a; font-weight: bold;');
                console.log(`   Â§á‰ªΩÂÜÖÂÆπÔºö${_allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`);
                console.log(`   Â§á‰ªΩÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}`);
                console.log(`   Â≠òÂÇ®Â§ßÂ∞èÔºö${(JSON.stringify(backupData).length / 1024).toFixed(2)} KB`);
            } catch (e) {
                console.error('%c‚ö†Ô∏è localStorageÂ§á‰ªΩÂ§±Ë¥•:', 'color: #ff4d4f; font-weight: bold;', e.message);
                console.warn('   ‰ΩÜÂÜÖÂ≠ò‰∏≠ÁöÑ _allAcceptedOpinions ‰ªçÁÑ∂ÊúâÊïà');
            }
            
            // ===== Á´ãÂç≥Êõ¥Êñ∞ËÆ°Êï∞Âô®ÔºàÂú®‰øùÂ≠òÊñá‰ª∂‰πãÂâçÔºâ=====
            setTimeout(() => {
                updateSavedOpinionsCounter();
            }, 200);
            
            // ===== üíæ Êñ∞Â¢ûÔºöËá™Âä®‰øùÂ≠òËßÇÁÇπËÆ∞ÂΩïÂà∞Êñá‰ª∂ =====
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #13c2c2; font-weight: bold;');
            console.log('%cüíæ Ëß¶ÂèëËá™Âä®‰øùÂ≠òÂà∞Êú¨Âú∞Êñá‰ª∂...', 'color: #13c2c2; font-size: 14px; font-weight: bold;');
            console.log(`%c   ÂáÜÂ§á‰øùÂ≠ò ${window.allAcceptedOpinions.length} ‰∏™ËßÇÁÇπ`, 'color: #13c2c2;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #13c2c2; font-weight: bold;');
            
            await saveOpinionsToLocalFiles();
            
            // ===== È™åËØÅ‰øùÂ≠òÊàêÂäü =====
            console.log('\n%cüîç ‰øùÂ≠òÈ™åËØÅ:', 'color: #1890ff; font-weight: bold;');
            console.log(`   ‚úì window.allAcceptedOpinions: ${window.allAcceptedOpinions.length} Êù°`);
            console.log(`   ‚úì window.opinionsRecordJSON: ${window.opinionsRecordJSON ? '‚úÖ' : '‚ùå'}`);
            console.log(`   ‚úì window.opinionsRecordTXT: ${window.opinionsRecordTXT ? `‚úÖ (${(window.opinionsRecordTXT.length/1024).toFixed(2)}KB)` : '‚ùå'}`);
            console.log(`   ‚úì localStorageÂ§á‰ªΩ: ${localStorage.getItem('allAcceptedOpinions_backup') ? '‚úÖ' : '‚ùå'}`);
            
            if (!window.opinionsRecordTXT || !window.opinionsRecordJSON) {
                console.error('%c‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Ë≠¶ÂëäÔºöËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ÁîüÊàêÂ§±Ë¥•ÔºÅ', 'color: #ff4d4f; font-size: 14px; font-weight: bold;');
                console.error('ËøôÂèØËÉΩÂØºËá¥ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂Êó†Ê≥ïÊ≠£Á°ÆËûçÂêàËßÇÁÇπÔºÅ');
            }
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #13c2c2; font-weight: bold;');
            
            // Â¶ÇÊûúÊ≤°ÊúâÊî∂ÈõÜÂà∞‰ªª‰ΩïËßÇÁÇπÔºåËÆ∞ÂΩïË≠¶Âëä
            if (acceptedOpinions.length === 0) {
                console.warn(`‚ö†Ô∏è Á´†ËäÇ„Äê${topic.section}„ÄëÁöÑËÆ®ËÆ∫Êú™ÈááÁ∫≥‰ªª‰ΩïËßÇÁÇπ`);
            }
            
            // Âú®È°µÈù¢‰∏ä‰πüÊòæÁ§∫Á¥ØÁßØËøõÂ∫¶ÔºàÂèØÈÄâÔºåÁî®‰∫éË∞ÉËØïÔºâ
            console.log('\nüìã ÂΩìÂâçÂÖ®Â±ÄËßÇÁÇπÂàóË°®ÔºàÊåâÁ´†ËäÇÔºâÔºö');
            const bySection = {};
            window.allAcceptedOpinions.forEach(op => {
                const sec = op.section || 'ÂÖ∂‰ªñ';
                if (!bySection[sec]) bySection[sec] = [];
                bySection[sec].push(op);
            });
            Object.entries(bySection).forEach(([sec, ops]) => {
                console.log(`   „Äê${sec}„Äë: ${ops.length} ‰∏™ËßÇÁÇπ`);
                ops.forEach((op, i) => {
                    console.log(`      ${i+1}. ${op.expert.name}: ${op.content.substring(0, 50)}...`);
                });
            });
            console.log('');
        }
        
        // ===== üíæ File System Access APIÔºöÁõ¥Êé•‰øùÂ≠òÂà∞ÊåáÂÆöÊñá‰ª∂Â§πÔºàChrome/EdgeÊîØÊåÅÔºâ=====
        let selectedFolderHandle = null;
        
        // ËØ∑Ê±ÇÁî®Êà∑ÈÄâÊã©‰øùÂ≠òÊñá‰ª∂Â§π
        async function requestFolderAccess() {
            try {
                // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅ File System Access API
                if ('showDirectoryPicker' in window) {
                    selectedFolderHandle = await window.showDirectoryPicker({
                        mode: 'readwrite',
                        startIn: 'desktop'
                    });
                    console.log('‚úÖ Áî®Êà∑Â∑≤ÊéàÊùÉÊñá‰ª∂Â§πËÆøÈóÆÊùÉÈôê:', selectedFolderHandle.name);
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅ File System Access API');
                    return false;
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Êñá‰ª∂Â§πËÆøÈóÆÊùÉÈôêËØ∑Ê±ÇÂ§±Ë¥•:', e);
                }
                return false;
            }
        }
        
        // ‰øùÂ≠òÊñá‰ª∂Âà∞ÊåáÂÆöÊñá‰ª∂Â§π
        async function saveFileToFolder(folderHandle, filename, content) {
            try {
                const fileHandle = await folderHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                console.log(`‚úÖ Êñá‰ª∂Â∑≤‰øùÂ≠ò: ${filename}`);
                return true;
            } catch (e) {
                console.error(`‚ùå ‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•: ${filename}`, e);
                return false;
            }
        }
        
        // ‰º†Áªü‰∏ãËΩΩÊñπÂºèÔºàÊµèËßàÂô®‰∏ãËΩΩÊñá‰ª∂Â§πÔºâ
        function downloadFileTraditional(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ===== üíæ Êñ∞Â¢ûÂäüËÉΩÔºöËá™Âä®‰øùÂ≠òËßÇÁÇπËÆ∞ÂΩïÂà∞Êú¨Âú∞Êñá‰ª∂ÔºàÂ¢ûÂº∫ÔºöÊîØÊåÅÁõ¥Êé•‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºâ=====
        async function saveOpinionsToLocalFiles() {
            // ‰ºòÂÖà‰ΩøÁî®ÂÜÖÈÉ®Êï∞ÁªÑ
            const opinions = typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions : 
                            (window.allAcceptedOpinions || []);
            
            if (!opinions || opinions.length === 0) {
                console.log('üìù ÊöÇÊó†ËßÇÁÇπÈúÄË¶Å‰øùÂ≠ò');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const courseTitle = extractCourseTitle();
            const sessionFolderName = `${courseTitle}_${timestamp.substring(0, 10)}`;
            
            // Â∞ùËØï‰ΩøÁî® File System Access API Áõ¥Êé•‰øùÂ≠ò
            const useFileSystemAPI = 'showDirectoryPicker' in window;
            
            if (useFileSystemAPI && !selectedFolderHandle) {
                // ËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Ë¶Å‰ΩøÁî®Êñá‰ª∂Â§πÁõ¥Êé•‰øùÂ≠ò
                const useFolder = confirm(
                    'üéâ Ê£ÄÊµãÂà∞ÊÇ®ÁöÑÊµèËßàÂô®ÊîØÊåÅÈ´òÁ∫ßÊñá‰ª∂‰øùÂ≠òÂäüËÉΩÔºÅ\n\n' +
                    '‚úÖ Êñ∞ÂäüËÉΩÔºöÂèØ‰ª•Áõ¥Êé•‰øùÂ≠òÂà∞ÊåáÂÆöÊñá‰ª∂Â§πÔºåÊó†ÈúÄÊâãÂä®Êï¥ÁêÜ\n\n' +
                    'Âª∫ËÆÆË∑ØÂæÑÔºöE:\\edu material\\disscussion_result\\' + sessionFolderName + '\\\n\n' +
                    'ÊòØÂê¶Áé∞Âú®ÈÄâÊã©‰øùÂ≠òÊñá‰ª∂Â§πÔºü\n' +
                    'ÔºàÈÄâÊã©"ÂèñÊ∂à"Â∞Ü‰ΩøÁî®‰º†Áªü‰∏ãËΩΩÊñπÂºèÔºâ'
                );
                
                if (useFolder) {
                    const hasAccess = await requestFolderAccess();
                    if (!hasAccess) {
                        console.log('Áî®Êà∑ÂèñÊ∂àÊñá‰ª∂Â§πÈÄâÊã©Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩÊñπÂºè');
                    }
                }
            }
            
            // ÊòæÁ§∫Êñá‰ª∂Â§πÁªÑÁªáÊåáÂçó
            if (!selectedFolderHandle) {
                showFolderOrganizationGuide(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}`);
            }
            
            // ===== 1. ÁîüÊàêËßÇÁÇπËÆ∞ÂΩïÊï∞ÊçÆ =====
            const jsonData = {
                metadata: {
                    version: '1.0',
                    generatedAt: new Date().toISOString(),
                    generatedAtReadable: new Date().toLocaleString('zh-CN'),
                    courseTitle: courseTitle,
                    totalOpinions: opinions.length,
                    sections: [...new Set(opinions.map(op => op.section))],
                    experts: [...new Set(opinions.map(op => op.expert.name))],
                    recommendedFolder: `E:\\edu material\\disscussion_result\\${sessionFolderName}`,
                    systemInfo: {
                        name: 'EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü',
                        developers: 'ÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü'
                    }
                },
                opinions: opinions.map(op => ({
                    globalIndex: op.globalIndex,
                    expert: {
                        name: op.expert.name,
                        key: op.expert.key,
                        specialty: op.expert.specialty
                    },
                    content: op.content,
                    section: op.section,
                    topicTitle: op.topicTitle,
                    votes: {
                        agree: op.votes.agree,
                        disagree: op.votes.disagree,
                        total: op.votes.agree + op.votes.disagree,
                        passRate: ((op.votes.agree / (op.votes.agree + op.votes.disagree)) * 100).toFixed(1) + '%',
                        voters: op.votes.voters?.map(v => ({
                            expertName: v.expert.name,
                            vote: v.vote,
                            reason: v.reason,
                            isValid: v.isValid !== false
                        }))
                    },
                    timestamp: op.timestamp
                })),
                statistics: {
                    totalOpinions: opinions.length,
                    bySection: Object.fromEntries(
                        [...new Set(opinions.map(op => op.section))].map(section => [
                            section,
                            opinions.filter(op => op.section === section).length
                        ])
                    ),
                    byExpert: Object.fromEntries(
                        [...new Set(opinions.map(op => op.expert.name))].map(expertName => [
                            expertName,
                            opinions.filter(op => op.expert.name === expertName).length
                        ])
                    )
                }
            };
            
            // Â¶ÇÊûúÁî®Êà∑Â∑≤ÈÄâÊã©Êñá‰ª∂Â§πÔºåÁõ¥Êé•‰øùÂ≠òÂà∞Êñá‰ª∂Â§π
            if (selectedFolderHandle) {
                try {
                    // ÂàõÂª∫ÊàñËé∑Âèñ‰ºöËØùÂ≠êÊñá‰ª∂Â§π
                    let sessionFolder;
                    try {
                        sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                    } catch (e) {
                        console.warn('ÂàõÂª∫Â≠êÊñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰øùÂ≠òÂà∞‰∏ªÊñá‰ª∂Â§π:', e);
                        sessionFolder = selectedFolderHandle;
                    }
                    
                    // ‰øùÂ≠òJSONÊñá‰ª∂
                    await saveFileToFolder(sessionFolder, 'ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json', JSON.stringify(jsonData, null, 2));
                    console.log('‚úÖ JSONÊñá‰ª∂Â∑≤Áõ¥Êé•‰øùÂ≠òÂà∞Êñá‰ª∂Â§π');
                } catch (e) {
                    console.error('‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                    selectedFolderHandle = null; // ÈáçÁΩÆÔºå‰∏ãÊ¨°ÈáçÊñ∞ËØ∑Ê±Ç
                    // ÈôçÁ∫ßÂà∞‰º†Áªü‰∏ãËΩΩ
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json`, JSON.stringify(jsonData, null, 2), 'application/json');
                }
            } else {
                // ‰º†Áªü‰∏ãËΩΩÊñπÂºè
                downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json`, JSON.stringify(jsonData, null, 2), 'application/json');
            }
            
            console.log('‚úÖ JSONÊ†ºÂºèËßÇÁÇπËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò');
            console.log('üìä JSONÊñá‰ª∂ÂÜÖÂÆπÈ¢ÑËßàÔºàÂâç500Â≠óÁ¨¶Ôºâ:');
            console.log(JSON.stringify(jsonData, null, 2).substring(0, 500) + '...');
            console.log(`üì¶ JSONÊñá‰ª∂Â§ßÂ∞è: ${(JSON.stringify(jsonData).length / 1024).toFixed(2)} KB`);
            
            // ===== 2. ‰øùÂ≠ò‰∏∫TXTÊ†ºÂºèÔºà‰∫∫Á±ªÂèØËØªÔºåÊñπ‰æø‰º†ÁªôAIÔºâ=====
            let txtContent = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txtContent += `                ÊïôÁ†î‰∏ìÂÆ∂ËßÇÁÇπÂÆåÊï¥ËÆ∞ÂΩï\n`;
            txtContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            txtContent += `üìÖ ËÆ∞ÂΩïÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}\n`;
            txtContent += `üéØ Á≥ªÁªüÔºöEduSymphony Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü\n`;
            txtContent += `üë• ÂèÇ‰∏é‰∏ìÂÆ∂Ôºö${agents.map(a => a.name).join('„ÄÅ')}\n`;
            txtContent += `üìä ËßÇÁÇπÊÄªÊï∞Ôºö${opinions.length} ‰∏™\n`;
            txtContent += `üìö Ê∂âÂèäÁ´†ËäÇÔºö${[...new Set(opinions.map(op => op.section))].join('„ÄÅ')}\n\n`;
            
            // ÊåâÁ´†ËäÇÊï¥ÁêÜËßÇÁÇπ
            const bySection = {};
            opinions.forEach(op => {
                const sec = op.section || 'ÂÖ∂‰ªñ';
                if (!bySection[sec]) bySection[sec] = [];
                bySection[sec].push(op);
            });
            
            Object.entries(bySection).forEach(([section, opinions]) => {
                txtContent += `\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
                txtContent += `‚ïë  „Äê${section}„Äë- ${opinions.length} ‰∏™‰∏ìÂÆ∂ËßÇÁÇπ\n`;
                txtContent += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n`;
                
                opinions.forEach((op, idx) => {
                    const totalVotes = op.votes.agree + op.votes.disagree;
                    const passRate = ((op.votes.agree / totalVotes) * 100).toFixed(1);
                    
                    txtContent += `‚îå‚îÄ ËßÇÁÇπ #${op.globalIndex || idx+1} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                    txtContent += `‚îÇ\n`;
                    txtContent += `‚îÇ üë§ ‰∏ìÂÆ∂Ôºö${op.expert.name}Ôºà${op.expert.specialty}Ôºâ\n`;
                    txtContent += `‚îÇ üìå ËÆ®ËÆ∫‰∏ªÈ¢òÔºö${op.topicTitle}\n`;
                    txtContent += `‚îÇ ‚è∞ ËÆ∞ÂΩïÊó∂Èó¥Ôºö${new Date(op.timestamp).toLocaleString('zh-CN')}\n`;
                    txtContent += `‚îÇ\n`;
                    txtContent += `‚îÇ üí° ‰∏ìÂÆ∂ËßÇÁÇπÂÜÖÂÆπÔºö\n`;
                    txtContent += `‚îÇ ${op.content.split('\n').join('\n‚îÇ ')}\n`;
                    txtContent += `‚îÇ\n`;
                    txtContent += `‚îÇ üìä ÊäïÁ•®ËØ¶ÊÉÖÔºö\n`;
                    txtContent += `‚îÇ    ‚úÖ ËµûÊàêÁ•®Ôºö${op.votes.agree} Á•®\n`;
                    txtContent += `‚îÇ    ‚ùå ÂèçÂØπÁ•®Ôºö${op.votes.disagree} Á•®\n`;
                    txtContent += `‚îÇ    üìà ÈÄöËøáÁéáÔºö${passRate}%ÔºàË∂ÖËøá50%ÔºåÂ∑≤ÈááÁ∫≥Ôºâ\n`;
                    txtContent += `‚îÇ\n`;
                    
                    // ËØ¶ÁªÜÊäïÁ•®ÁêÜÁî±
                    if (op.votes.voters && op.votes.voters.length > 0) {
                        txtContent += `‚îÇ üó≥Ô∏è  ÊäïÁ•®ÊòéÁªÜÔºàÂÖ±${op.votes.voters.length}‰Ωç‰∏ìÂÆ∂ÊäïÁ•®ÔºâÔºö\n`;
                        txtContent += `‚îÇ\n`;
                        op.votes.voters.forEach((voter, vIdx) => {
                            if (voter.isValid === false || voter.vote === 'failed') {
                                txtContent += `‚îÇ    ${vIdx+1}. ${voter.expert.name}Ôºö‚ö†Ô∏è ÊäïÁ•®Â§±Ë¥•\n`;
                                txtContent += `‚îÇ       ÂéüÂõ†Ôºö${voter.reason}\n`;
                            } else {
                                const voteEmoji = voter.vote === 'agree' ? '‚úÖ' : '‚ùå';
                                const voteText = voter.vote === 'agree' ? 'ËµûÊàê' : 'ÂèçÂØπ';
                                txtContent += `‚îÇ    ${vIdx+1}. ${voter.expert.name}Ôºö${voteEmoji} ${voteText}\n`;
                                txtContent += `‚îÇ       ÁêÜÁî±Ôºö${voter.reason.split('\n').join('\n‚îÇ            ')}\n`;
                            }
                            if (vIdx < op.votes.voters.length - 1) {
                                txtContent += `‚îÇ\n`;
                            }
                        });
                    }
                    
                    txtContent += `‚îÇ\n`;
                    txtContent += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                });
            });
            
            txtContent += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txtContent += `                        ÁªüËÆ°Ê±áÊÄª\n`;
            txtContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            // ‰∏ìÂÆ∂Ë¥°ÁåÆÁªüËÆ°
            const expertStats = {};
            opinions.forEach(op => {
                const name = op.expert.name;
                if (!expertStats[name]) {
                    expertStats[name] = {
                        count: 0,
                        specialty: op.expert.specialty,
                        sections: new Set()
                    };
                }
                expertStats[name].count++;
                expertStats[name].sections.add(op.section);
            });
            
            txtContent += `üë• ‰∏ìÂÆ∂Ë¥°ÁåÆÊéíË°åÔºö\n\n`;
            Object.entries(expertStats)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([name, stats], rank) => {
                    txtContent += `   ${rank+1}. ${name}Ôºà${stats.specialty}Ôºâ\n`;
                    txtContent += `      ‚Ä¢ ÈááÁ∫≥ËßÇÁÇπÊï∞Ôºö${stats.count} ‰∏™\n`;
                    txtContent += `      ‚Ä¢ Ê∂âÂèäÁ´†ËäÇÔºö${[...stats.sections].join('„ÄÅ')}\n\n`;
                });
            
            txtContent += `\nüìö Á´†ËäÇË¥°ÁåÆÂàÜÂ∏ÉÔºö\n\n`;
            Object.entries(bySection).forEach(([section, sectionOps]) => {
                txtContent += `   „Äê${section}„ÄëÔºö${sectionOps.length} ‰∏™ËßÇÁÇπ\n`;
                const expertList = [...new Set(sectionOps.map(op => op.expert.name))];
                txtContent += `      ÂèÇ‰∏é‰∏ìÂÆ∂Ôºö${expertList.join('„ÄÅ')}\n\n`;
            });
            
            txtContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txtContent += `Êú¨ËÆ∞ÂΩïÊñá‰ª∂Â∞ÜÂú®ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂Ëá™Âä®‰º†ÈÄíÁªôAI\n`;
            txtContent += `AIÂ∞ÜÂü∫‰∫éËøô‰∫õ‰∏ìÂÆ∂ËßÇÁÇπÂíåÊäïÁ•®ÁªìÊûúÔºåËûçÂêàÁîüÊàêÈ´òË¥®ÈáèÊïôÊ°à\n`;
            txtContent += `‰øùÂ≠òË∑ØÂæÑÔºöE:\\edu material\\disscussion_result\\${sessionFolderName}\\\n`;
            txtContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            // ‰øùÂ≠òTXTÊñá‰ª∂
            if (selectedFolderHandle) {
                try {
                    let sessionFolder;
                    try {
                        sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                    } catch (e) {
                        sessionFolder = selectedFolderHandle;
                    }
                    await saveFileToFolder(sessionFolder, 'ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt', txtContent);
                    console.log('‚úÖ TXTÊñá‰ª∂Â∑≤Áõ¥Êé•‰øùÂ≠òÂà∞Êñá‰ª∂Â§π');
                } catch (e) {
                    console.error('‰øùÂ≠òTXTÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                    downloadFileTraditional(`${sessionFolderName}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt`, txtContent, 'text/plain;charset=utf-8');
                }
            } else {
                downloadFileTraditional(`${sessionFolderName}/ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.txt`, txtContent, 'text/plain;charset=utf-8');
            }
            
            console.log('‚úÖ TXTÊ†ºÂºèËßÇÁÇπËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò');
            console.log('üìä TXTÊñá‰ª∂ÂÜÖÂÆπÈ¢ÑËßàÔºàÂâç500Â≠óÁ¨¶Ôºâ:');
            console.log(txtContent.substring(0, 500) + '...');
            console.log(`üì¶ TXTÊñá‰ª∂Â§ßÂ∞è: ${(txtContent.length / 1024).toFixed(2)} KB`);
            
            // ===== ‰øùÂ≠òËÆ∞ÂΩïÂà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂‰ΩøÁî® =====
            window.opinionsRecordJSON = jsonData;
            window.opinionsRecordTXT = txtContent;
            window.currentFolderName = sessionFolderName;
            window.currentSessionFolderName = sessionFolderName;
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üíæ ËßÇÁÇπËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºåÂèØÁî®‰∫éÁîüÊàê‰ºòÂåñÊïôÊ°à');
            console.log(`   ‚Ä¢ ‰øùÂ≠òË∑ØÂæÑ: E:\\edu material\\disscussion_result\\${sessionFolderName}\\`);
            console.log(`   ‚Ä¢ window.opinionsRecordJSON: ${typeof window.opinionsRecordJSON} (${(JSON.stringify(window.opinionsRecordJSON).length / 1024).toFixed(2)} KB)`);
            console.log(`   ‚Ä¢ window.opinionsRecordTXT: ${typeof window.opinionsRecordTXT} (${(window.opinionsRecordTXT.length / 1024).toFixed(2)} KB)`);
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            // ===== Êõ¥Êñ∞È°µÈù¢ÂÆûÊó∂ËÆ°Êï∞Âô® =====
            setTimeout(() => {
                updateSavedOpinionsCounter();
            }, 300);
            
            // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
            showMessage(`‚úÖ ËßÇÁÇπËÆ∞ÂΩïÂ∑≤Ëá™Âä®‰øùÂ≠òÂà∞Ôºö${sessionFolderName}/`, 'success');
        }

        // ÊúÄÁªàÁªìÊûúÊäïÁ•®
        async function finalResultVoting(topic) {
            const discussionArea = document.getElementById('discussionArea');

            // ÊòæÁ§∫ÊúÄÁªàÊäïÁ•®Èò∂ÊÆµ
            const finalVoteHeader = document.createElement('div');
            finalVoteHeader.className = 'final-vote-header';
            finalVoteHeader.innerHTML = `
                <div class="final-vote-title">
                    <i class="fas fa-balance-scale"></i>
                    <span>ÊúÄÁªàÊäïÁ•®Èò∂ÊÆµ</span>
                </div>
                <div class="final-vote-instruction">
                    ËØ∑ÂêÑ‰Ωç‰∏ìÂÆ∂ÂØπÊúÄÁªàÁîüÊàêÁöÑÊïôÊ°àÂíåËØÑ‰ª∑ÈáèË°®ËøõË°åÊäïÁ•®„ÄÇ<br>
                    Âè™ËÉΩÈÄâÊã©ÂêåÊÑèÊàñÂèçÂØπÔºå‰∏çËÉΩÂºÉÊùÉ„ÄÇÈúÄË¶ÅË∂ÖËøá80%ÁöÑÂêåÊÑèÁéáÊâçËÉΩÈÄöËøáÔºåÂê¶ÂàôÂ∞ÜÈáçÊñ∞ÁªÑÁªáËÆ®ËÆ∫„ÄÇ
                </div>
                <div class="final-vote-buttons">
                    <button class="final-vote-btn approve" onclick="finalVote('approve')">‚úÖ ÈÄöËøá</button>
                    <button class="final-vote-btn reject" onclick="finalVote('reject')">‚ùå Âê¶ÂÜ≥</button>
                </div>
                <div class="final-vote-results" id="final-vote-results">
                    <span class="final-vote-count approve-count">ÂêåÊÑè: 0</span>
                    <span class="final-vote-count reject-count">Âê¶ÂÜ≥: 0</span>
                    <span class="final-vote-progress">ËøõÂ∫¶: 0/${agents.length}</span>
                </div>
            `;
            discussionArea.appendChild(finalVoteHeader);

            // ÂàùÂßãÂåñÊúÄÁªàÊäïÁ•®Êï∞ÊçÆ
            window.finalVotes = {
                approve: 0,
                reject: 0,
                total: 0
            };

            // Ê®°Êãü‰∏ìÂÆ∂ÊäïÁ•®ËøáÁ®ã
            await simulateFinalVoting();
        }

        // ÊäïÁ•®Â§ÑÁêÜÂáΩÊï∞ÔºàÈúÄË¶ÅÂú®ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
        window.voteOnOpinion = function(expertId, voteType) {
            console.log(`‰∏ìÂÆ∂ÊäïÁ•®Ôºö${expertId} - ${voteType}`);

            // ËøôÈáåÂ∫îËØ•Êî∂ÈõÜÁúüÂÆûÁöÑÁî®Êà∑ÊäïÁ•®Ôºå‰ΩÜ‰∏∫‰∫ÜÊºîÁ§∫ÔºåÊàë‰ª¨Ê®°ÊãüÊäïÁ•®ËøáÁ®ã
            // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•Ë∞ÉÁî®ÂêéÁ´ØAPIÊî∂ÈõÜÊäïÁ•®
        };

        // ÊúÄÁªàÊäïÁ•®Â§ÑÁêÜÂáΩÊï∞
        window.finalVote = function(voteType) {
            if (!window.finalVotes) {
                window.finalVotes = { approve: 0, reject: 0, total: 0 };
            }

            window.finalVotes.total++;
            if (voteType === 'approve') {
                window.finalVotes.approve++;
            } else {
                window.finalVotes.reject++;
            }

            const approveRate = window.finalVotes.approve / window.finalVotes.total;

            // Êõ¥Êñ∞ÊäïÁ•®ÊòæÁ§∫
            const voteResults = document.getElementById('final-vote-results');
            if (voteResults) {
                voteResults.innerHTML = `
                    <span class="final-vote-count approve-count">ÂêåÊÑè: ${window.finalVotes.approve}</span>
                    <span class="final-vote-count reject-count">Âê¶ÂÜ≥: ${window.finalVotes.reject}</span>
                    <span class="final-vote-progress">ËøõÂ∫¶: ${window.finalVotes.total}/${agents.length}</span>
                `;
            }

            console.log(`ÊúÄÁªàÊäïÁ•®ÔºöÂêåÊÑèÁéá ${Math.round(approveRate * 100)}%`);

            // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞80%ÂêåÊÑèÁéá
            if (approveRate >= 0.8) {
                // ÈÄöËøá
                setTimeout(() => {
                    showFinalApproval();
                }, 1000);
            } else if (window.finalVotes.total >= agents.length) {
                // ÊäïÁ•®ÂÆåÊàê‰ΩÜÊú™ÈÄöËøáÔºåÈáçÊñ∞ËÆ®ËÆ∫
                setTimeout(() => {
                    showReDiscussion();
                }, 1000);
            }
        };

        // ÊòæÁ§∫ÊúÄÁªàÈÄöËøá
        async function showFinalApproval() {
            const discussionArea = document.getElementById('discussionArea');
            const approvalDiv = document.createElement('div');
            approvalDiv.className = 'final-approval';
            approvalDiv.innerHTML = `
                <div class="approval-header">
                    <i class="fas fa-trophy"></i>
                    <span>üéâ ÊïôÁ†îËÆ®ËÆ∫ÂúÜÊª°ÁªìÊùüÔºÅ</span>
                </div>
                <div class="approval-message">
                    ÊúÄÁªàÊïôÊ°àÂíåËØÑ‰ª∑ÈáèË°®Â∑≤Ëé∑ÂæóÂÖ®‰Ωì‰∏ìÂÆ∂ÁöÑËÆ§ÂèØÔºÅ<br>
                    ÂêåÊÑèÁéáÔºö${Math.round((window.finalVotes.approve / window.finalVotes.total) * 100)}%
                </div>
                <div class="approval-actions">
                    <button class="approval-btn" onclick="downloadFinalResults('txt')">üì• ‰∏ãËΩΩTXT</button>
                    <button class="approval-btn" onclick="downloadFinalResults('pdf')" style="background: linear-gradient(135deg, #eb2f96, #f759ab);">üìÑ ÂØºÂá∫PDF</button>
                    <button class="approval-btn" onclick="startNewDiscussion()">üîÑ ÂºÄÂßãÊñ∞ËÆ®ËÆ∫</button>
                </div>
            `;
            discussionArea.appendChild(approvalDiv);

            // ÁîüÊàêËØæÁ®ãÊºîÁ§∫ÊùêÊñô
            await generateCourseMaterial(discussionArea);
        }

        // ÊòæÁ§∫ÈáçÊñ∞ËÆ®ËÆ∫
        function showReDiscussion() {
            const discussionArea = document.getElementById('discussionArea');
            const reDiscussionDiv = document.createElement('div');
            reDiscussionDiv.className = 're-discussion';
            reDiscussionDiv.innerHTML = `
                <div class="re-discussion-header">
                    <i class="fas fa-redo"></i>
                    <span>ÈúÄË¶ÅÈáçÊñ∞ËÆ®ËÆ∫</span>
                </div>
                <div class="re-discussion-message">
                    ÊúÄÁªàÁªìÊûúÊú™Ëé∑ÂæóË∂≥Â§üÊîØÊåÅÔºàÂêåÊÑèÁéáÔºö${Math.round((window.finalVotes.approve / window.finalVotes.total) * 100)}%Ôºâ„ÄÇ<br>
                    Â∞Ü‰øùÁïô‰πãÂâçÈááÁ∫≥ÁöÑ${window.acceptedOpinions ? window.acceptedOpinions.length : 0}‰∏™‰ºòÁßÄËßÇÁÇπÔºåÁªßÁª≠ËÆ®ËÆ∫‰ª•ËææÊàêÂÖ±ËØÜ„ÄÇ
                </div>
                <div class="retained-opinions">
                    <h4>‰øùÁïôÁöÑ‰ºòÁßÄËßÇÁÇπÔºö</h4>
                    ${window.acceptedOpinions ? window.acceptedOpinions.map(opinion =>
                        `<div class="retained-opinion">
                            <strong>${opinion.expert.name}</strong>Ôºö${opinion.content}
                        </div>`
                    ).join('') : ''}
                </div>
                <div class="re-discussion-actions">
                    <button class="re-discussion-btn" onclick="restartDiscussion()">üîÑ ÈáçÊñ∞ËÆ®ËÆ∫</button>
                </div>
            `;
            discussionArea.appendChild(reDiscussionDiv);
        }

        // Ê®°ÊãüÊúÄÁªàÊäïÁ•®ËøáÁ®ã
        async function simulateFinalVoting() {
            console.log('ÂºÄÂßãÊ®°ÊãüÊúÄÁªàÊäïÁ•®...');

            // Ê®°Êãü‰∏ìÂÆ∂ÊäïÁ•®ÔºàÈöèÊú∫ÊäïÁ•®ÔºåÂè™ËÉΩÂêåÊÑèÊàñÂèçÂØπÔºâ
            for (let i = 0; i < agents.length; i++) {
                await delay(1000 + Math.random() * 2000);

                const voteType = Math.random() > 0.3 ? 'approve' : 'reject'; // 70%ÂêåÊÑèÁéá
                window.finalVote(voteType);
            }
        }

        // Ê£ÄÊü•html2pdfÊòØÂê¶ÂèØÁî®
        function checkPDFLibrary() {
            if (typeof html2pdf === 'undefined') {
                alert('PDFÂØºÂá∫Â∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢ò„ÄÇ\n\nËØ∑Â∞ùËØïÔºö\n1. Âà∑Êñ∞È°µÈù¢ÈáçÊñ∞Âä†ËΩΩ\n2. Ê£ÄÊü•ÁΩëÁªúËøûÊé•\n3. ÊàñËÄÖ‰ΩøÁî®"‰∏ãËΩΩTXT"ÊåâÈíÆ');
                return false;
            }
            return true;
        }

        // ‰∏ãËΩΩÊúÄÁªàÁªìÊûú
        async function downloadFinalResults(format = 'txt') {
            if (!window.finalTeachingPlan) {
                alert('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÂÜÖÂÆπ');
                return;
            }
            
            if (format === 'txt') {
                // ‰∏ãËΩΩTXTÊ†ºÂºè
                const blob = new Blob([window.finalTeachingPlan], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '‰ºòÂåñÊïôÊ°àÂíåËØÑ‰ª∑ÈáèË°®.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                // ÂØºÂá∫PDFÊ†ºÂºè
                if (!checkPDFLibrary()) {
                    return;
                }
                
                try {
                    // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂HTMLÂÆπÂô®
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 210mm; padding: 20mm; background: white; font-family: "Microsoft YaHei", sans-serif;';
                    
                    // Â∞ÜÊñáÊú¨ÂÜÖÂÆπËΩ¨Êç¢‰∏∫HTMLÊ†ºÂºè
                    const htmlContent = window.finalTeachingPlan
                        .replace(/\n/g, '<br>')
                        .replace(/„Äê([^„Äë]+)„Äë/g, '<h2 style="color: #667eea; margin-top: 20px; margin-bottom: 10px; font-size: 20px;">„Äê$1„Äë</h2>')
                        .replace(/(\d+\.|‚Ä¢|-)\s/g, '<div style="margin: 8px 0;">$1 ')
                        .replace(/<br><br>/g, '</div><div style="margin-bottom: 15px;">');
                    
                    tempDiv.innerHTML = `
                        <div style="text-align: center; margin-bottom: 40px;">
                            <h1 style="color: #667eea; font-size: 28px; margin-bottom: 10px;">‰ºòÂåñÊïôÊ°àÂíåËØÑ‰ª∑ÈáèË°®</h1>
                            <p style="color: #888; font-size: 14px;">ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}</p>
                        </div>
                        <div style="line-height: 1.8; font-size: 14px; color: #333;">
                            ${htmlContent}
                        </div>
                        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 12px;">
                            <p>Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü Ëá™Âä®ÁîüÊàê</p>
                        </div>
                    `;
                    
                    document.body.appendChild(tempDiv);
                    
                    // ÈÖçÁΩÆPDFÈÄâÈ°π
                    const opt = {
                        margin: [10, 10, 10, 10],
                        filename: '‰ºòÂåñÊïôÊ°àÂíåËØÑ‰ª∑ÈáèË°®.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            letterRendering: true
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait'
                        }
                    };
                    
                    // ÁîüÊàêÂπ∂‰∏ãËΩΩPDF
                    await html2pdf().set(opt).from(tempDiv).save();
                    
                    // Ê∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                    document.body.removeChild(tempDiv);
                    showMessage('PDFÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
                    
                } catch (error) {
                    console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                    alert('PDFÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
                }
            }
        }

        // ÈáçÊñ∞ÂºÄÂßãËÆ®ËÆ∫
        function restartDiscussion() {
            // ÈáçÁΩÆÊúÄÁªàÊäïÁ•®Áä∂ÊÄÅÔºå‰ΩÜ‰øùÁïôÈááÁ∫≥ÁöÑËßÇÁÇπ
            window.finalVotes = { approve: 0, reject: 0, total: 0 };
            // ‰øùÁïôwindow.finalTeachingPlanÂíåwindow.acceptedOpinions

            // Ê∏ÖÈô§ËÆ®ËÆ∫Âå∫Âüü
            const discussionArea = document.getElementById('discussionArea');
            discussionArea.innerHTML = '';

            // ÈáçÊñ∞ÂºÄÂßãËÆ®ËÆ∫Ôºå‰øùÁïô‰πãÂâçÈááÁ∫≥ÁöÑËßÇÁÇπ
            startStage2Discussion(window.acceptedOpinions);
        }

        // ËØÑ‰º∞Âª∫ËÆÆË¥®Èáè
        async function evaluateSuggestionQuality(suggestion, expert, topic) {
            try {
                const evaluationPrompt = `ËØ∑ËØÑ‰º∞‰ª•‰∏ã‰∏ìÂÆ∂Âª∫ËÆÆÁöÑË¥®ÈáèÔºö

‰∏ìÂÆ∂Ôºö${expert.name}Ôºà${expert.specialty}Ôºâ
ËÆ®ËÆ∫‰∏ªÈ¢òÔºö${topic.title} - ${topic.description}
Âª∫ËÆÆÂÜÖÂÆπÔºö${suggestion}

ËØ∑Âà§Êñ≠Ëøô‰∏™Âª∫ËÆÆÊòØÂê¶Ôºö
1. Ë∂≥Â§üÂÖ∑‰ΩìÂíåÂèØÊìç‰ΩúÔºà‰∏çÊòØÁ©∫Ê≥õÁöÑÁêÜËÆ∫Ôºâ
2. ÁªìÂêà‰∫ÜÂÆûÈôÖÊïôÂ≠¶Âú∫ÊôØ
3. Êèê‰æõ‰∫ÜÊòéÁ°ÆÁöÑÊîπËøõÊé™ÊñΩ

Â¶ÇÊûúÂª∫ËÆÆË¥®Èáè‰∏çÂ•ΩÔºåËØ∑ËØ¥ÊòéÂéüÂõ†Âπ∂ÁªôÂá∫ÊîπËøõÊñπÂêë„ÄÇ

ËØ∑‰ª•JSONÊ†ºÂºèËøîÂõûÔºö
{
    "isGood": true/false,
    "reason": "ÂÖ∑‰ΩìÂéüÂõ†",
    "improvement": "ÊîπËøõÂª∫ËÆÆ"
}

Âè™ËøîÂõûJSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ`;

                const evaluation = await callModeratorAPI(evaluationPrompt);

                try {
                    const result = JSON.parse(evaluation);
                    return {
                        isGood: result.isGood || false,
                        reason: result.reason || 'Âª∫ËÆÆ‰∏çÂ§üÂÖ∑‰Ωì',
                        improvement: result.improvement || 'ËØ∑Êèê‰æõÊõ¥ÂÖ∑‰ΩìÁöÑÊîπËøõÊé™ÊñΩ'
                    };
                } catch (parseError) {
                    console.warn('Âª∫ËÆÆË¥®ÈáèËØÑ‰º∞Ëß£ÊûêÂ§±Ë¥•:', parseError);
                    return {
                        isGood: false,
                        reason: 'Âª∫ËÆÆËøá‰∫éÁêÜËÆ∫ÂåñÔºåÁº∫‰πèÂÖ∑‰ΩìÊìç‰ΩúÊÄß',
                        improvement: 'ËØ∑ÁªìÂêàÂÆûÈôÖÊïôÂ≠¶Âú∫ÊôØÔºåÊèê‰æõÂèØÊìç‰ΩúÁöÑÊîπËøõÂª∫ËÆÆ'
                    };
                }
            } catch (error) {
                console.error('Âª∫ËÆÆË¥®ÈáèËØÑ‰º∞Â§±Ë¥•:', error);
                return {
                    isGood: false,
                    reason: 'Êó†Ê≥ïËØÑ‰º∞Âª∫ËÆÆË¥®Èáè',
                    improvement: 'ËØ∑Êèê‰æõÊõ¥ÂÖ∑Êìç‰ΩúÊÄßÁöÑÂª∫ËÆÆ'
                };
            }
        }

        // ‰∏ªÊåÅ‰∫∫Âπ≤È¢Ñ‰∏ìÂÆ∂
        async function moderatorIntervention(expert, reason, topic, roundId) {
            // Âú®ÂΩìÂâçËÆ®ËÆ∫Âå∫ÂüüÊ∑ªÂä†‰∏ªÊåÅ‰∫∫Âπ≤È¢Ñ
            const discussionArea = document.getElementById(`discussion-${roundId}`);
            
            if (!discussionArea) {
                console.warn('ËÆ®ËÆ∫Âå∫Âüü‰∏çÂ≠òÂú®ÔºåË∑≥Ëøá‰∏ªÊåÅ‰∫∫Âπ≤È¢Ñ');
                return;
            }

            const interventionPrompt = `‰Ωú‰∏∫ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÊàëÂèëÁé∞${expert.name}‰∏ìÂÆ∂ÁöÑÂª∫ËÆÆÂ≠òÂú®‰ª•‰∏ãÈóÆÈ¢òÔºö${reason}

ËØ∑‰Ω†‰ª•‰∏ì‰∏ö„ÄÅÂπΩÈªò‰ΩÜ‰∏•ÂéâÁöÑÊñπÂºè"pua"Ëøô‰Ωç‰∏ìÂÆ∂ÔºåËÆ©‰ªñÊòéÁôΩÔºö
1. Âª∫ËÆÆ‰∏çËÉΩÂè™ÊòØÁêÜËÆ∫ÔºåË¶ÅÁªìÂêàÂÆûÈôÖÊïôÂ≠¶Âú∫ÊôØ
2. Ë¶ÅÊèêÂá∫ÂÖ∑‰ΩìÁöÑ„ÄÅÂèØÊìç‰ΩúÁöÑÊîπËøõÊé™ÊñΩ
3. ‰∏çËÉΩÂè™ÊòØÊ≥õÊ≥õËÄåË∞àÔºåË¶ÅÁªôÂá∫ÊòéÁ°ÆÁöÑË°åÂä®ÊñπÊ°à

ËØ∑Áî®50-100Â≠óÂõûÂ∫îÔºåËØ≠Ê∞îË¶ÅÂÉèÂØºÂ∏à‰∏ÄÊ†∑‰∏•Ê†º‰ΩÜÂÖ≥ÂàáÔºåÂèØ‰ª•ÈÄÇÂΩìÂπΩÈªò‰ΩÜË¶ÅÊúâ‰∏ÄÂÆöÁöÑÂéãËø´ÊÑü„ÄÇ`;

            const intervention = await callModeratorAPI(interventionPrompt);

            const interventionId = `intervention-${Date.now()}`;
            const interventionDiv = document.createElement('div');
            interventionDiv.className = 'discussion-item moderator-intervention';
            interventionDiv.style.background = 'linear-gradient(135deg, rgba(250, 140, 22, 0.15), rgba(250, 140, 22, 0.05))';
            interventionDiv.style.border = '2px solid rgba(250, 140, 22, 0.3)';
            interventionDiv.innerHTML = `
                <div class="discussion-header">
                    <div class="discussion-avatar" style="background: ${moderator.color}">
                        ${moderator.avatar}
                    </div>
                    <div class="discussion-info">
                        <div class="discussion-expert">${moderator.name}</div>
                        <div class="discussion-specialty">‰∏ªÊåÅ‰∫∫Âπ≤È¢Ñ</div>
                    </div>
                    <div class="intervention-target">‚ö†Ô∏è ÈíàÂØπ ${expert.name}</div>
                </div>
                <div class="discussion-content" id="${interventionId}"></div>
            `;
            
            discussionArea.appendChild(interventionDiv);
            
            setTimeout(() => {
                interventionDiv.style.opacity = '1';
                interventionDiv.style.transform = 'translateY(0)';
                ScrollManager.scrollTo(interventionDiv);
            }, 50);

            await delay(300);
            await typeText(interventionId, intervention || `ÂìéÂëÄÔºå${expert.name}‰∏ìÂÆ∂Ôºå‰Ω†Ëøô‰∏™Âª∫ËÆÆÂê¨Ëµ∑Êù•ÂæàÈ´òÁ´ØÔºå‰ΩÜÂÆûÈôÖ‰∏äËøò‰∏çÂ§üÊé•Âú∞Ê∞îÂïäÔºÅ‰Ωú‰∏∫${expert.specialty}Ôºå‰Ω†Â∫îËØ•ÁªìÂêàÂÆûÈôÖÊïôÂ≠¶Âú∫ÊôØÔºåÁªôÂá∫Êõ¥ÂÖ∑‰Ωì„ÄÅÂèØÊìç‰ΩúÁöÑÊîπËøõÊé™ÊñΩÔºåËÄå‰∏çÊòØÂè™ËÆ≤ÁêÜËÆ∫„ÄÇÊù•ÔºåÈáçÊñ∞ÊÉ≥ÊÉ≥ÔºåÁªôÂ§ßÂÆ∂‰∏Ä‰∏™ÂÆûÂÆûÂú®Âú®ÁöÑÂª∫ËÆÆÂêßÔºÅ`, 30);

            await delay(1500);
        }

        // ‰∏ìÂÆ∂Âú®‰∏ªÊåÅ‰∫∫Âπ≤È¢ÑÂêéÊîπËøõËßÇÁÇπ
        async function expertImproveOpinion(expert, originalOpinion, improvementSuggestion, topic) {
            try {
                // ‰ªéÂàùÂßãÊïôÊ°à‰∏≠ÊèêÂèñËØ•Á´†ËäÇÂÜÖÂÆπ
                const initialPlan = window.initialTeachingPlan || parsedFileContent;
                const sectionContent = extractSectionContent(initialPlan, topic.section);
                
                const improvePrompt = `‰Ω†ÊòØ${expert.name}Ôºå‰∏ì‰∏öÊòØ${expert.specialty}„ÄÇ

Êàë‰ª¨Ê≠£Âú®ËÆ®ËÆ∫ÂàùÂßãÊïôÊ°àÁöÑ"${topic.section}"ÈÉ®ÂàÜÔºö
${sectionContent}

‰Ω†ÂàöÊâçÊèêÂá∫ÁöÑËßÇÁÇπÔºö
${originalOpinion}

‰ΩÜ‰∏ªÊåÅ‰∫∫ÊåáÂá∫Ëøô‰∏™Âª∫ËÆÆ‰∏çÂ§üÂÖ∑‰ΩìÂíåÂèØÊìç‰ΩúÔºåË¶ÅÊ±Ç‰Ω†ÊîπËøõ„ÄÇ‰∏ªÊåÅ‰∫∫ÁöÑÊîπËøõÂª∫ËÆÆÔºö${improvementSuggestion}

Áé∞Âú®ËØ∑‰Ω†Ôºö
1. ÊâøËÆ§‰πãÂâçÁöÑÂª∫ËÆÆÁ°ÆÂÆû‰∏çÂ§üÂÖ∑‰ΩìÔºàÁî®Ë∞¶ËôöÁöÑÂè£ÂêªÔºâ
2. ÈíàÂØπÂàùÂßãÊïôÊ°àÁöÑËøôÈÉ®ÂàÜÂÜÖÂÆπÔºåÁªôÂá∫Êõ¥ÂÖ∑‰ΩìÁöÑÊîπËøõÂª∫ËÆÆ
3. ÂøÖÈ°ªÊòéÁ°ÆÊåáÂá∫ÔºöË¶ÅÊîπÂàùÂßãÊïôÊ°àÁöÑÂì™‰∏ÄÂè•/Âì™‰∏™ÁÇπÔºåÊîπÊàê‰ªÄ‰πàÂÖ∑‰ΩìÂÜÖÂÆπ
4. ÂøÖÈ°ªÂåÖÂê´ÂÖ∑‰ΩìÁöÑÊïôÂ≠¶Âú∫ÊôØÂíåÂèØÊâßË°åÁöÑÊ≠•È™§
5. Â≠óÊï∞ÊéßÂà∂Âú®120-180Â≠ó

ËØ∑Áõ¥Êé•ÁªôÂá∫ÊîπËøõÂêéÁöÑËßÇÁÇπÔºå‰∏çË¶ÅÂä†ÂÖ∂‰ªñËØ¥Êòé„ÄÇ`;

                const config = getExpertAPIConfig(expert);
                const response = await fetch(config.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [{
                            role: 'user',
                            content: improvePrompt
                        }],
                        temperature: 0.8,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content?.trim() || null;
                return content ? convertToTraditionalChinese(content) : null;
            } catch (error) {
                console.error(`${expert.name}ÊîπËøõËßÇÁÇπÂ§±Ë¥•:`, error);
                return `Ôºà${expert.name}ÔºâÊÑüË∞¢‰∏ªÊåÅ‰∫∫ÁöÑÊèêÈÜíÔºÅÊàëÈáçÊñ∞ÊÄùËÄÉ‰∫Ü‰∏Ä‰∏ãÔºåÂª∫ËÆÆÂú®ÂÆûÈôÖÊïôÂ≠¶‰∏≠Â¢ûÂä†ÂÖ∑‰ΩìÁöÑÊìç‰ΩúÁéØËäÇÔºåËÆ©Â≠¶ÁîüÈÄöËøáÂä®ÊâãÂÆûË∑µÊù•ÁêÜËß£Ê¶ÇÂøµÔºåÂπ∂ÈÖçÂêàÊòéÁ°ÆÁöÑËØÑ‰ª∑Ê†áÂáÜÊù•Ê£ÄÈ™åÂ≠¶‰π†ÊïàÊûú„ÄÇ`;
            }
        }

        // ‰∏ªÊåÅ‰∫∫ÊÄªÁªìÂèëË®ÄÔºà‰∏çÁ´ãÂç≥ÁîüÊàêÊïôÊ°àÔºâ
        async function moderatorSummary() {
            let discussionRounds = document.getElementById('discussionRounds');
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñdiscussionRounds
            let retryCount = 0;
            while (!discussionRounds && retryCount < 3) {
                console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussionRoundsÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                await delay(500);
                discussionRounds = document.getElementById('discussionRounds');
                retryCount++;
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùdiscussionRoundsÂ≠òÂú®‰∏îÊúâÊïà
            if (!discussionRounds || !(discussionRounds instanceof HTMLElement)) {
                console.error('‚ùå discussionRounds‰∏çÂ≠òÂú®ÊàñÊó†ÊïàÔºåÊó†Ê≥ïÊòæÁ§∫‰∏ªÊåÅ‰∫∫ÊÄªÁªì');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöËÆ®ËÆ∫Âå∫Âüü‰∏¢Â§±', 'error');
                return;
            }
            
            // È™åËØÅdiscussionRoundsÂú®DOMÊ†ë‰∏≠
            if (!document.body.contains(discussionRounds)) {
                console.error('‚ùå discussionRounds‰∏çÂú®DOMÊ†ë‰∏≠');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöËÆ®ËÆ∫Âå∫ÂüüÂ∑≤ÁßªÈô§', 'error');
                return;
            }
            
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            // ===== üíæ ÂÖ≥ÈîÆÊ£ÄÊü•ÁÇπÔºöÊÄªÁªìÂâçÈ™åËØÅÊï∞ÊçÆÂÆåÊï¥ÊÄß =====
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            console.log('%cüé§ ‰∏ªÊåÅ‰∫∫ÊÄªÁªìÂâç - Êï∞ÊçÆÂÆåÊï¥ÊÄßÊ£ÄÊü•', 'color: #fa8c16; font-size: 14px; font-weight: bold;');
            console.log(`%c   ÂÜÖÈÉ®Êï∞ÁªÑ: ${typeof _allAcceptedOpinions !== 'undefined' ? _allAcceptedOpinions.length : 0} Êù°`, 'color: #fa8c16;');
            console.log(`%c   ÂΩìÂâç‰ΩøÁî®: ${opinions.length} Êù°ÔºàÂ∑≤ÈááÁ∫≥Ôºâ`, 'color: #fa8c16;');
            console.log(`%c   ÊâÄÊúâËÆ®ËÆ∫: ${allDiscussed.length} Êù°ÔºàÂåÖÂê´Êú™ÈááÁ∫≥Ôºâ`, 'color: #fa8c16;');
            console.log(`%c   ËÆ∞ÂΩïÊñá‰ª∂TXT: ${window.opinionsRecordTXT ? '‚úÖ' : '‚ùå'}`, 'color: #fa8c16;');
            console.log(`%c   ËÆ∞ÂΩïÊñá‰ª∂JSON: ${window.opinionsRecordJSON ? '‚úÖ' : '‚ùå'}`, 'color: #fa8c16;');
            console.log(`%c   localStorageÂ§á‰ªΩ: ${localStorage.getItem('allAcceptedOpinions_backup') ? '‚úÖ' : '‚ùå'}`, 'color: #fa8c16;');
            console.log(`%c   ËÆ®ËÆ∫Â§á‰ªΩ: ${localStorage.getItem('allDiscussedOpinions_backup') ? '‚úÖ' : '‚ùå'}`, 'color: #fa8c16;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
            
            // Â¶ÇÊûúÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπ‰ΩÜÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÔºåÂ∞ùËØï‰ªéËÆ®ËÆ∫Â§á‰ªΩ‰∏≠ÊÅ¢Â§ç
            if (opinions.length === 0 && allDiscussed.length > 0) {
                console.warn('%c‚ö†Ô∏è Ê≤°ÊúâÈááÁ∫≥ÁöÑËßÇÁÇπÔºå‰ΩÜÊúâËÆ®ËÆ∫ËÆ∞ÂΩï', 'color: #faad14; font-weight: bold;');
                console.log(`%c   ÂÖ± ${allDiscussed.length} ‰∏™ËßÇÁÇπÂèÇ‰∏é‰∫ÜËÆ®ËÆ∫`, 'color: #1890ff;');
                console.log('%c   Ê£ÄÊü•ÊòØÂê¶ÊúâËßÇÁÇπÊé•ËøëÈòàÂÄºÔºà38%-40%Ôºâ...', 'color: #1890ff;');
                
                // Ê£ÄÊü•Êé•ËøëÈòàÂÄºÁöÑËßÇÁÇπ
                const nearThreshold = allDiscussed.filter(op => {
                    const totalVotes = op.votes.agree + op.votes.disagree;
                    const agreeRate = totalVotes > 0 ? op.votes.agree / totalVotes : 0;
                    return agreeRate >= 0.35 && agreeRate < 0.4;
                });
                
                if (nearThreshold.length > 0) {
                    console.log(`%c‚ú® ÂèëÁé∞ ${nearThreshold.length} ‰∏™Êé•ËøëÈòàÂÄºÁöÑËßÇÁÇπÔºà35%-40%Ôºâ`, 'color: #52c41a; font-weight: bold;');
                    nearThreshold.forEach(op => {
                        const rate = ((op.votes.agree / (op.votes.agree + op.votes.disagree)) * 100).toFixed(1);
                        console.log(`   ‚Ä¢ ${op.expert.name}Ôºà${rate}%Ôºâ: ${op.content.substring(0, 50)}...`);
                    });
                }
            }
            
            // Â¶ÇÊûúÊï∞ÊçÆÂºÇÂ∏∏ÔºåÂ∞ùËØïÊÅ¢Â§çÂ∑≤ÈááÁ∫≥ËßÇÁÇπ
            if (opinions.length === 0 && localStorage.getItem('allAcceptedOpinions_backup')) {
                console.warn('%c‚ö†Ô∏è Ê£ÄÊµãÂà∞ÈááÁ∫≥ËßÇÁÇπÊï∞ÊçÆ‰∏¢Â§±ÔºåÂ∞ùËØï‰ªélocalStorageÊÅ¢Â§ç...', 'color: #faad14; font-weight: bold;');
                try {
                    const backup = JSON.parse(localStorage.getItem('allAcceptedOpinions_backup'));
                    _allAcceptedOpinions = backup.opinions || [];
                    console.log(`%c‚úÖ Â∑≤ÊÅ¢Â§ç ${_allAcceptedOpinions.length} ‰∏™ÈááÁ∫≥ËßÇÁÇπ`, 'color: #52c41a; font-weight: bold;');
                    
                    // ÈáçÊñ∞ÁîüÊàêËÆ∞ÂΩïÊñá‰ª∂
                    if (_allAcceptedOpinions.length > 0) {
                        await saveOpinionsToLocalFiles();
                    }
                } catch (e) {
                    console.error('ÊÅ¢Â§çÂ§±Ë¥•:', e);
                }
            }

            // ÂÖàÂÅöÊÄªÁªìÂèëË®ÄÔºàÊ†πÊçÆÈááÁ∫≥ÊÉÖÂÜµË∞ÉÊï¥ÂÜÖÂÆπÔºâ
            const acceptedCount = getAllAcceptedOpinions().length;
            const discussedCount = allDiscussed.length;
            
            let summaryPrompt;
            if (acceptedCount === 0 && discussedCount > 0) {
                // Ê≤°ÊúâÈááÁ∫≥ËßÇÁÇπÁöÑÊÉÖÂÜµ
                summaryPrompt = `‰Ωú‰∏∫ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÊâÄÊúâÊïôÁ†îËÄÅÂ∏àÂ∑≤ÁªèÂÆåÊàê‰∫ÜÂØπÂàùÂßãÊïôÊ°àÂêÑÈÉ®ÂàÜÁöÑÊ∑±ÂÖ•ËÆ®ËÆ∫„ÄÇ

Êú¨Ê¨°ËÆ®ËÆ∫ÂÖ±Êúâ ${discussedCount} ‰∏™ËßÇÁÇπË¢´ÊèêÂá∫ÂíåÊäïÁ•®Ôºå‰ΩÜÈÅóÊÜæÁöÑÊòØÔºåÊâÄÊúâËßÇÁÇπÈÉΩÊú™ËÉΩËé∑Âæó40%‰ª•‰∏äÁöÑÂêåÊÑèÁéáÔºåÂõ†Ê≠§Êú¨Ê¨°Ê≤°ÊúâËßÇÁÇπË¢´ÈááÁ∫≥„ÄÇ

ËøôÂèØËÉΩËØ¥ÊòéÔºö
1. ÂàùÂßãÊïôÊ°àÊú¨Ë∫´Â∑≤ÁªèÊØîËæÉÂÆåÂñÑ
2. ‰∏ìÂÆ∂‰ª¨ÂØπÊîπËøõÊñπÂêëÂ≠òÂú®ÂàÜÊ≠ß
3. ÈÉ®ÂàÜËßÇÁÇπËøòÈúÄË¶ÅËøõ‰∏ÄÊ≠•ÁªÜÂåñ

ËØ∑‰Ω†‰Ωú‰∏∫‰∏ªÊåÅ‰∫∫Ôºå‰ª•‰∏ì‰∏ö‰ΩÜÊ∏©ÂíåÁöÑÊÄÅÂ∫¶ËøõË°åÊÄªÁªìÔºåÈºìÂä±ÁªßÁª≠Âä™Âäõ„ÄÇÂ≠óÊï∞ÊéßÂà∂Âú®150Â≠ó‰ª•ÂÜÖ„ÄÇ`;
            } else if (acceptedCount > 0) {
                // ÊúâÈááÁ∫≥ËßÇÁÇπÁöÑÊÉÖÂÜµ
                summaryPrompt = `‰Ωú‰∏∫ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÊâÄÊúâÊïôÁ†îËÄÅÂ∏àÂ∑≤ÁªèÂÆåÊàê‰∫ÜÂØπÂàùÂßãÊïôÊ°àÂêÑÈÉ®ÂàÜÁöÑÊ∑±ÂÖ•ËÆ®ËÆ∫„ÄÇ

ÂÖ±ÈááÁ∫≥‰∫Ü ${acceptedCount} ‰∏™ÊîπËøõÂª∫ËÆÆÔºà‰ªé ${discussedCount} ‰∏™ËÆ®ËÆ∫ËßÇÁÇπ‰∏≠Á≠õÈÄâÔºâÔºåÊ∂µÁõñ‰∫ÜÊïôÂ≠¶ÁõÆÊ†á„ÄÅÊïôÂ≠¶ÊµÅÁ®ã„ÄÅÊïôÂ≠¶Ê¥ªÂä®„ÄÅËØÑ‰ª∑ÊñπÂºèÁ≠âÂ§ö‰∏™ÊñπÈù¢„ÄÇ

ËØ∑‰Ω†ËøõË°åÊÄªÁªìÊÄßÂèëË®ÄÔºåÊ¶ÇÊã¨Êú¨Ê¨°ÊïôÁ†îËÆ®ËÆ∫ÁöÑÊ†∏ÂøÉÊàêÊûúÂíå‰∫ÆÁÇπ„ÄÇÂ≠óÊï∞ÊéßÂà∂Âú®120Â≠ó‰ª•ÂÜÖ„ÄÇ`;
            } else {
                // Ê≤°ÊúâËÆ®ËÆ∫ËßÇÁÇπÁöÑÊÉÖÂÜµÔºàÂºÇÂ∏∏Ôºâ
                summaryPrompt = `‰Ωú‰∏∫ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÊú¨Ê¨°ÊïôÁ†îËÆ®ËÆ∫Êú™ËÉΩÊî∂ÈõÜÂà∞ÊúâÊïàÁöÑ‰∏ìÂÆ∂ËßÇÁÇπ„ÄÇËøôÂèØËÉΩÊòØÊäÄÊúØÈóÆÈ¢òÂØºËá¥ÁöÑ„ÄÇ

ËØ∑‰Ω†‰ª•‰∏ì‰∏öÁöÑÊÄÅÂ∫¶ËØ¥ÊòéÊÉÖÂÜµÔºåÂπ∂Âª∫ËÆÆ‰øùÁïôÂàùÂßãÊïôÊ°àÂÜÖÂÆπ„ÄÇÂ≠óÊï∞ÊéßÂà∂Âú®80Â≠ó‰ª•ÂÜÖ„ÄÇ`;
            }

            const summary = await callModeratorAPI(summaryPrompt);

            const summaryId = `summary-${Date.now()}`;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'moderator-card';
            summaryDiv.style.marginTop = '30px';
            
            // Ê†πÊçÆÈááÁ∫≥ÊÉÖÂÜµË∞ÉÊï¥Âç°ÁâáÊ†∑Âºè
            if (acceptedCount === 0) {
                summaryDiv.style.background = 'linear-gradient(135deg, rgba(250, 140, 22, 0.15), rgba(250, 140, 22, 0.05))';
                summaryDiv.style.border = '2px solid rgba(250, 140, 22, 0.3)';
            }
            
            summaryDiv.innerHTML = `
                <div class="agent-header">
                    <div class="agent-avatar" style="background: ${moderator.color}">
                        ${moderator.avatar}
                    </div>
                    <div class="agent-info">
                        <div class="agent-name">${moderator.name}</div>
                        <div class="agent-specialty">ÊÄªÁªìÂèëË®Ä</div>
                    </div>
                    ${acceptedCount === 0 ? `
                        <span style="background: rgba(250, 173, 20, 0.3); color: #faad14; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem;">
                            ‚ö†Ô∏è Êó†ÈááÁ∫≥ËßÇÁÇπ
                        </span>
                    ` : `
                        <span style="background: rgba(82, 196, 26, 0.3); color: #52c41a; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem;">
                            ‚úÖ ${acceptedCount}‰∏™ËßÇÁÇπ
                        </span>
                    `}
                </div>
                <div class="moderator-speech summary">
                    <div class="speech-label">üé§ ‰∏ªÊåÅ‰∫∫ÊÄªÁªì</div>
                    <div class="speech-content" id="${summaryId}"></div>
                </div>
            `;
            // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
            if (discussionRounds && safeAppendChild(discussionRounds, summaryDiv, 'discussionRounds')) {
                console.log('‚úÖ ‰∏ªÊåÅ‰∫∫ÊÄªÁªìÂ∑≤Ê∑ªÂä†Âà∞DOM');
                
                // ÊªöÂä®Âà∞ÊÄªÁªì
                setTimeout(() => {
                    if (summaryDiv && document.body.contains(summaryDiv)) {
                        ScrollManager.scrollTo(summaryDiv, { offset: 80 });
                    }
                }, 100);
            } else {
                console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ∑ªÂä†‰∏ªÊåÅ‰∫∫ÊÄªÁªìÂà∞DOMÔºà‰ΩÜÊï∞ÊçÆÂ∑≤‰øùÂ≠òÔºâ');
            }

            const defaultSummary = acceptedCount === 0 
                ? `ÊÑüË∞¢ÂêÑ‰ΩçÊïôÁ†îËÄÅÂ∏àÁöÑÁßØÊûÅÂèÇ‰∏éÔºÅËôΩÁÑ∂Êú¨Ê¨°ËÆ®ËÆ∫‰∏≠${discussedCount}‰∏™ËßÇÁÇπÈÉΩÊú™ËææÂà∞40%ÈááÁ∫≥Ê†áÂáÜÔºå‰ΩÜËÆ®ËÆ∫ËøáÁ®ãÊú¨Ë∫´ÂæàÊúâ‰ª∑ÂÄº„ÄÇÊâÄÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÂ∑≤ÂÆåÊï¥‰øùÂ≠ò„ÄÇÊàë‰ª¨Â∞Ü‰øùÁïôÂàùÂßãÊïôÊ°àÁöÑÂÜÖÂÆπÔºåÊÇ®‰πüÂèØ‰ª•ÂèÇËÄÉ‰∏ìÂÆ∂ÁöÑÁã¨Á´ãÂàÜÊûêÂíåËÆ®ËÆ∫ËÆ∞ÂΩïËøõË°åÊâãÂä®Ë∞ÉÊï¥„ÄÇ`
                : `ÊÑüË∞¢ÂêÑ‰ΩçÊïôÁ†îËÄÅÂ∏àÁöÑÁ≤æÂΩ©ÂèëË®ÄÔºÅÈÄöËøáÊ∑±ÂÖ•ËÆ®ËÆ∫ÔºåÊàë‰ª¨‰ªé${discussedCount}‰∏™ËßÇÁÇπ‰∏≠ÈááÁ∫≥‰∫Ü${acceptedCount}‰∏™ÂÆùË¥µÁöÑÊîπËøõÂª∫ËÆÆ„ÄÇÊâÄÊúâËÆ®ËÆ∫ÂÜÖÂÆπÂ∑≤ÂÆåÊï¥ËÆ∞ÂΩïÔºåÊÇ®ÂèØ‰ª•ÈöèÊó∂Êü•ÁúãÂíå‰∏ãËΩΩ„ÄÇ`;
            
            await typeText(summaryId, summary || defaultSummary, 30);

            await delay(1000);
            
            // ===== ÁîüÊàêREADMEÊñá‰ª∂ =====
            generateReadmeFile();
            
            // ===== ÊòæÁ§∫ÊâÄÊúâÂ∑≤‰øùÂ≠òËßÇÁÇπÁöÑÊ±áÊÄªÈù¢Êùø =====
            const savedOpinionsSummaryDiv = document.createElement('div');
            savedOpinionsSummaryDiv.className = 'card';
            savedOpinionsSummaryDiv.style.cssText = `
                background: linear-gradient(135deg, rgba(82, 196, 26, 0.15), rgba(82, 196, 26, 0.05));
                border: 2px solid rgba(82, 196, 26, 0.4);
                border-radius: 12px;
                padding: 25px;
                margin: 25px 0;
            `;
            
            // ÊåâÁ´†ËäÇÁªÑÁªáËßÇÁÇπ
            const opinionsBySection = {};
            let totalSaved = 0;
            if (opinions && opinions.length > 0) {
                opinions.forEach(opinion => {
                    const section = opinion.section || 'ÂÖ∂‰ªñ';
                    if (!opinionsBySection[section]) {
                        opinionsBySection[section] = [];
                    }
                    opinionsBySection[section].push(opinion);
                    totalSaved++;
                });
            }
            
            savedOpinionsSummaryDiv.innerHTML = `
                <h3 style="color: #52c41a; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <i class="fas fa-database"></i> 
                    Â∑≤‰øùÂ≠òÁöÑÊâÄÊúâ‰∏ìÂÆ∂ËßÇÁÇπÊ±áÊÄª
                    <span style="background: rgba(82, 196, 26, 0.3); color: #52c41a; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; margin-left: auto;">
                        ÂÖ± ${totalSaved} ‰∏™ËßÇÁÇπ
                    </span>
                </h3>
                
                <div style="background: rgba(24, 144, 255, 0.1); border: 1px solid rgba(24, 144, 255, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <strong style="color: #1890ff;"><i class="fas fa-info-circle"></i> ÈáçË¶ÅËØ¥Êòé</strong><br>
                    <div style="color: rgba(255,255,255,0.85); font-size: 0.9rem; line-height: 1.8; margin-top: 8px;">
                        ‚úì ‰ª•‰∏ãÊâÄÊúâËßÇÁÇπÈÉΩÂ∑≤ÈÄöËøáÊäïÁ•®ÔºàË∂ÖËøá50%ÂêåÊÑèÁéáÔºâ<br>
                        ‚úì Ëøô‰∫õËßÇÁÇπÂ∞ÜÂú®ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ËûçÂêàÂà∞ÂØπÂ∫îÁ´†ËäÇ<br>
                        ‚úì Ê†áÊ≥®ÁâàÊïôÊ°à‰ºöÊ∏ÖÊ•öÊ†áÊòéÊØèÂ§Ñ‰ºòÂåñÊù•Ëá™Âì™‰Ωç‰∏ìÂÆ∂
                    </div>
                </div>
                
                ${Object.keys(opinionsBySection).length > 0 ? 
                    Object.entries(opinionsBySection).map(([section, opinions]) => `
                        <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 20px; margin: 15px 0; border-left: 4px solid #52c41a;">
                            <h4 style="color: #52c41a; margin-bottom: 15px; font-size: 1.1rem;">
                                <i class="fas fa-folder-open"></i> „Äê${section}„Äë- ${opinions.length} ‰∏™ËßÇÁÇπ
                            </h4>
                            ${opinions.map((op, i) => `
                                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 3px solid ${op.expert.color};">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="background: ${op.expert.color}; color: white; padding: 4px 10px; border-radius: 50%; font-size: 0.85rem; font-weight: bold;">${op.expert.avatar}</span>
                                        <strong style="color: white; font-size: 1rem;">${op.expert.name}</strong>
                                        <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Ôºà${op.expert.specialty}Ôºâ</span>
                                        <span style="background: rgba(82, 196, 26, 0.3); color: #52c41a; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: auto;">
                                            ‚úÖ Â∑≤‰øùÂ≠ò #${op.globalIndex || i+1}
                                        </span>
                                    </div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 1.6; padding-left: 5px;">
                                        ${op.content}
                                    </div>
                                    ${op.votes ? `
                                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                            üìä ÊäïÁ•®Ôºö‚úÖ ËµûÊàê ${op.votes.agree} | ‚ùå ÂèçÂØπ ${op.votes.disagree} | ÈÄöËøáÁéá ${((op.votes.agree / (op.votes.agree + op.votes.disagree)) * 100).toFixed(1)}%
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `).join('') 
                    : 
                    '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.6);">ÊöÇÊó†Â∑≤‰øùÂ≠òÁöÑËßÇÁÇπ</div>'
                }
                
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(114, 46, 209, 0.1); border: 1px solid rgba(114, 46, 209, 0.3); border-radius: 8px;">
                    <i class="fas fa-arrow-down" style="color: #722ed1; font-size: 1.2rem;"></i>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; margin-top: 10px;">
                        Êé•‰∏ãÊù•Â∞Ü‰ΩøÁî®Ëøô <strong style="color: #52c41a;">${totalSaved}</strong> ‰∏™ËßÇÁÇπËûçÂêàÂà∞ÂàùÂßãÊïôÊ°à‰∏≠ÔºåÁîüÊàê‰ºòÂåñÁâàÊïôÊ°à
                    </div>
                </div>
            `;
            // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
            if (discussionRounds && safeAppendChild(discussionRounds, savedOpinionsSummaryDiv, 'discussionRounds')) {
                console.log('‚úÖ ËßÇÁÇπÊ±áÊÄªÈù¢ÊùøÂ∑≤Ê∑ªÂä†Âà∞DOM');
            } else {
                console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ∑ªÂä†ËßÇÁÇπÊ±áÊÄªÈù¢ÊùøÂà∞DOM');
            }
            
            await delay(800);
        }
        
        // ÊòæÁ§∫ËÆ®ËÆ∫ÂÆåÊàêÊ±áÊÄªÔºàÂåÖÂê´ÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩïÔºâ
        async function showDiscussionCompleteSummary() {
            let discussionRounds = document.getElementById('discussionRounds');
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñdiscussionRounds
            let retryCount = 0;
            while (!discussionRounds && retryCount < 3) {
                console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussionRoundsÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                await delay(500);
                discussionRounds = document.getElementById('discussionRounds');
                retryCount++;
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùdiscussionRoundsÂ≠òÂú®‰∏îÊúâÊïà
            if (!discussionRounds || !(discussionRounds instanceof HTMLElement) || !document.body.contains(discussionRounds)) {
                console.error('‚ùå discussionRounds‰∏çÂ≠òÂú®„ÄÅÊó†ÊïàÊàñ‰∏çÂú®DOMÊ†ë‰∏≠ÔºåÊó†Ê≥ïÊòæÁ§∫ËÆ®ËÆ∫ÂÆåÊàêÊ±áÊÄª');
                return;
            }
            
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            // ÊåâÁ´†ËäÇÊï¥ÁêÜÈááÁ∫≥ÁöÑËßÇÁÇπ
            const opinionsBySection = {};
            if (opinions && opinions.length > 0) {
                opinions.forEach(opinion => {
                    const section = opinion.section || 'ÂÖ∂‰ªñ';
                    if (!opinionsBySection[section]) {
                        opinionsBySection[section] = [];
                    }
                    opinionsBySection[section].push(opinion);
                });
            }
            
            // ÊåâÁ´†ËäÇÊï¥ÁêÜÊâÄÊúâËÆ®ËÆ∫ÁöÑËßÇÁÇπÔºàÂåÖÂê´Êú™ÈááÁ∫≥ÁöÑÔºâ
            const allDiscussedBySection = {};
            if (allDiscussed && allDiscussed.length > 0) {
                allDiscussed.forEach(opinion => {
                    const section = opinion.section || 'ÂÖ∂‰ªñ';
                    if (!allDiscussedBySection[section]) {
                        allDiscussedBySection[section] = [];
                    }
                    allDiscussedBySection[section].push(opinion);
                });
            }
            
            const summaryCard = document.createElement('div');
            summaryCard.className = 'card';
            summaryCard.id = 'discussionCompleteSummary';
            
            // Ê†πÊçÆÊòØÂê¶ÊúâÈááÁ∫≥ËßÇÁÇπË∞ÉÊï¥Ê†∑Âºè
            if (opinions.length === 0) {
                summaryCard.style.cssText = `
                    background: linear-gradient(135deg, rgba(250, 140, 22, 0.2), rgba(250, 140, 22, 0.1));
                    border: 2px solid rgba(250, 140, 22, 0.4);
                    border-radius: 12px;
                    padding: 30px;
                    margin: 30px 0;
                `;
            } else {
                summaryCard.style.cssText = `
                    background: linear-gradient(135deg, rgba(82, 196, 26, 0.2), rgba(82, 196, 26, 0.1));
                    border: 2px solid rgba(82, 196, 26, 0.4);
                    border-radius: 12px;
                    padding: 30px;
                    margin: 30px 0;
                `;
            }
            
            summaryCard.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="color: ${opinions.length === 0 ? '#faad14' : '#52c41a'}; font-size: 1.6rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <i class="fas fa-${opinions.length === 0 ? 'exclamation-triangle' : 'check-circle'}"></i>
                        <span>${opinions.length === 0 ? '‚ö†Ô∏è ÊïôÁ†îËÆ®ËÆ∫Â∑≤ÂÆåÊàêÔºàÊó†ËßÇÁÇπË¢´ÈááÁ∫≥Ôºâ' : '‚úÖ ÊïôÁ†îËÆ®ËÆ∫Â∑≤ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ'}</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.9); font-size: 1.05rem; line-height: 1.8;">
                        Â∑≤ÂÆåÊàê <strong style="color: #1890ff;">${Object.keys(allDiscussedBySection).length || Object.keys(opinionsBySection).length}</strong> ‰∏™‰∏ªÈ¢òÁöÑÊ∑±ÂÖ•ËÆ®ËÆ∫<br>
                        ${opinions.length === 0 ? `
                            ËÆ®ËÆ∫‰∫Ü <strong style="color: #faad14;">${allDiscussed.length}</strong> ‰∏™‰∏ìÂÆ∂ËßÇÁÇπÔºå‰ΩÜÂùáÊú™ËææÂà∞40%ÈááÁ∫≥ÈòàÂÄº<br>
                            ÊâÄÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÂ∑≤ÂÆåÊï¥‰øùÂ≠òÔºàÂê´ÊäïÁ•®ËØ¶ÊÉÖÔºâ
                        ` : `
                            ÈááÁ∫≥‰∫Ü <strong style="color: #52c41a;">${opinions.length}</strong> ‰∏™‰∏ìÂÆ∂Âª∫ËÆÆÔºà‰ªé${allDiscussed.length}‰∏™‰∏≠Á≠õÈÄâÔºâ<br>
                            ÊâÄÊúâËÆ®ËÆ∫ËøáÁ®ãÂíåÊäïÁ•®ËØ¶ÊÉÖÂ∑≤ÂÆåÊï¥‰øùÂ≠ò
                        `}
                    </p>
                    ${opinions.length === 0 ? `
                        <div style="background: rgba(24, 144, 255, 0.1); border: 1px solid rgba(24, 144, 255, 0.3); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <strong style="color: #1890ff;">üìå ËØ¥Êòé</strong><br>
                            <div style="color: rgba(255,255,255,0.85); font-size: 0.95rem; line-height: 1.8; margin-top: 8px; text-align: left;">
                                ‚Ä¢ ÊâÄÊúâ${allDiscussed.length}‰∏™ËÆ®ËÆ∫ËßÇÁÇπÁöÑÊäïÁ•®ÂêåÊÑèÁéáÂùáÊú™ËææÂà∞40%ÈòàÂÄº<br>
                                ‚Ä¢ ËøôËØ¥ÊòéÂàùÂßãÊïôÊ°àÂèØËÉΩÂ∑≤ËæÉ‰∏∫ÂÆåÂñÑÔºåÊàñ‰∏ìÂÆ∂ÊÑèËßÅÂàÜÊ≠ßËæÉÂ§ß<br>
                                ‚Ä¢ ‰ºòÂåñÊïôÊ°àÂ∞ÜÂü∫‰∫éÂàùÂßãÊïôÊ°àÁîüÊàêÔºà‰øùÁïôÂéüÊúâÂÜÖÂÆπÔºâ<br>
                                ‚Ä¢ ÊÇ®ÂèØ‰ª•Êü•Áúã‰∏ìÂÆ∂ÁöÑÁã¨Á´ãÂàÜÊûêÁªìÊûúÂíåËÆ®ËÆ∫ËÆ∞ÂΩïËøõË°åÂèÇËÄÉ
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- ËÆ®ËÆ∫ËÆ∞ÂΩïÈ¢ÑËßàÂç°Áâá -->
                <!-- ËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ËØ¥Êòé -->
                <div style="background: rgba(19, 194, 194, 0.1); border: 2px solid rgba(19, 194, 194, 0.3); border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #13c2c2; display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-database"></i> 
                        ‰∏ìÂÆ∂ËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ÔºàÂ∑≤Ëá™Âä®‰øùÂ≠òÔºâ
                    </h4>
                    <div style="color: rgba(255,255,255,0.85); font-size: 0.95rem; line-height: 1.8; margin-bottom: 15px;">
                        üíæ <strong>Â∑≤Ëá™Âä®‰∏ãËΩΩÂà∞Êú¨Âú∞Ôºö</strong><br>
                        ‚Ä¢ <strong>JSONÊ†ºÂºè</strong>ÔºöÁªìÊûÑÂåñÊï∞ÊçÆÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑËßÇÁÇπ„ÄÅÊäïÁ•®„ÄÅÈÄöËøáÁéá‰ø°ÊÅØ<br>
                        ‚Ä¢ <strong>TXTÊ†ºÂºè</strong>Ôºö‰∫∫Á±ªÂèØËØªÊñáÊú¨ÔºåÊñπ‰æøÊü•ÁúãÂíå‰º†ÈÄíÁªôAI<br>
                        ü§ñ <strong>AIËûçÂêà‰ΩøÁî®Ôºö</strong>Âú®ÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ÔºåËøô‰∫õËÆ∞ÂΩï‰ºöËá™Âä®‰º†ÈÄíÁªôAI‰Ωú‰∏∫ÂèÇËÄÉ‰æùÊçÆ
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="downloadAllDiscussionFiles()" style="background: linear-gradient(135deg, #eb2f96, #f759ab);">
                            <i class="fas fa-download"></i> ‰∏ÄÈîÆ‰∏ãËΩΩÂÖ®ÈÉ®Êñá‰ª∂
                        </button>
                        <button class="btn" onclick="downloadCurrentOpinionsRecord()" style="background: linear-gradient(135deg, #13c2c2, #36cfc9);">
                            <i class="fas fa-file-download"></i> ÈáçÊñ∞‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩï
                        </button>
                        <button class="btn" onclick="viewSavedOpinions()" style="background: linear-gradient(135deg, #722ed1, #9254de);">
                            <i class="fas fa-database"></i> Êü•ÁúãÊâÄÊúâËßÇÁÇπ
                        </button>
                        <button class="btn" onclick="showFileOrganizationGuide()" style="background: linear-gradient(135deg, #fa8c16, #faad14);">
                            <i class="fas fa-folder-tree"></i> Êñá‰ª∂Â§πÊåáÂçó
                        </button>
                    </div>
                </div>
                
                <!-- ËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂåÖÂê´ËÆ®ËÆ∫ËøáÁ®ãÔºâ-->
                <div style="background: rgba(235, 47, 150, 0.1); border: 2px solid rgba(235, 47, 150, 0.3); border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #eb2f96; display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-comments"></i> 
                        ÊïôÁ†îÁªÑËÆ®ËÆ∫ËøáÁ®ãËÆ∞ÂΩï
                    </h4>
                    <div style="color: rgba(255,255,255,0.85); font-size: 0.95rem; line-height: 1.8; margin-bottom: 15px;">
                        üìã ÂÆåÊï¥ËÆ®ËÆ∫ËøáÁ®ãÔºåÂåÖÂê´Ôºö‰∏ªÊåÅ‰∫∫ÂèëË®Ä„ÄÅ‰∏ìÂÆ∂ËÆ®ËÆ∫„ÄÅÊäïÁ•®ÁêÜÁî±„ÄÅË¥°ÁåÆÂàÜÊûêÁ≠â
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="toggleDiscussionRecordView()" id="toggleDiscussionRecordBtn" style="background: linear-gradient(135deg, #eb2f96, #f759ab);">
                            <i class="fas fa-eye"></i> Â±ïÂºÄÊü•ÁúãËÆ®ËÆ∫ËØ¶ÊÉÖ
                        </button>
                        <button class="btn" onclick="downloadDiscussionRecord()" style="background: linear-gradient(135deg, #722ed1, #9254de);">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩTXT
                        </button>
                        <button class="btn" onclick="downloadDiscussionRecordDocx()" style="background: linear-gradient(135deg, #52c41a, #73d13d);">
                            <i class="fas fa-file-word"></i> ‰∏ãËΩΩDOCX
                        </button>
                        <button class="btn" onclick="downloadDiscussionRecordMd()" style="background: linear-gradient(135deg, #fa8c16, #faad14);">
                            <i class="fas fa-file-code"></i> ‰∏ãËΩΩMD
                        </button>
                    </div>
                    <div id="discussionRecordContent" style="display: none; margin-top: 20px; background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 10px; max-height: 500px; overflow-y: auto;">
                        <!-- ËÆ®ËÆ∫ËÆ∞ÂΩïËØ¶ÊÉÖÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                </div>
            `;
            
            // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
            if (discussionRounds && safeAppendChild(discussionRounds, summaryCard, 'discussionRounds')) {
                console.log('‚úÖ ËÆ®ËÆ∫ÂÆåÊàêÊ±áÊÄªÂç°ÁâáÂ∑≤Ê∑ªÂä†Âà∞DOM');
                
                // ÁîüÊàêËÆ®ËÆ∫ËÆ∞ÂΩïHTML
                generateDiscussionRecordHTML(opinionsBySection);
                
                // ÊªöÂä®Âà∞Ê±áÊÄªÂç°Áâá
                setTimeout(() => {
                    if (summaryCard && document.body.contains(summaryCard)) {
                        ScrollManager.scrollTo(summaryCard, { offset: 80 });
                    }
                }, 100);
            } else {
                console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ∑ªÂä†ËÆ®ËÆ∫ÂÆåÊàêÊ±áÊÄªÂà∞DOM');
            }
            
            await delay(800);
        }
        
        // ÊòæÁ§∫"ÁîüÊàê‰ºòÂåñÊïôÊ°à"ÊåâÈíÆ
        async function showGenerateOptimizedPlanButton() {
            let discussionRounds = document.getElementById('discussionRounds');
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñdiscussionRounds
            let retryCount = 0;
            while (!discussionRounds && retryCount < 3) {
                console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussionRoundsÔºåÁ≠âÂæÖDOMÊ∏≤Êüì...`);
                await delay(500);
                discussionRounds = document.getElementById('discussionRounds');
                retryCount++;
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùdiscussionRoundsÂ≠òÂú®‰∏îÊúâÊïà
            if (!discussionRounds || !(discussionRounds instanceof HTMLElement) || !document.body.contains(discussionRounds)) {
                console.error('‚ùå discussionRounds‰∏çÂ≠òÂú®„ÄÅÊó†ÊïàÊàñ‰∏çÂú®DOMÊ†ë‰∏≠ÔºåÊó†Ê≥ïÊòæÁ§∫ÁîüÊàê‰ºòÂåñÊïôÊ°àÊåâÈíÆ');
                return;
            }
            
            const acceptedCount = getAllAcceptedOpinions().length;
            const allDiscussed = window.allDiscussedOpinions || [];
            
            const buttonCard = document.createElement('div');
            buttonCard.className = 'card';
            buttonCard.id = 'generateOptimizedPlanCard';
            
            // Ê†πÊçÆÊòØÂê¶ÊúâÈááÁ∫≥ËßÇÁÇπË∞ÉÊï¥Ê†∑Âºè
            if (acceptedCount === 0) {
                buttonCard.style.cssText = `
                    background: linear-gradient(135deg, rgba(250, 140, 22, 0.2), rgba(250, 140, 22, 0.1));
                    border: 2px solid rgba(250, 140, 22, 0.4);
                    border-radius: 16px;
                    padding: 40px;
                    margin: 30px 0;
                    text-align: center;
                    animation: fadeInUp 0.8s ease;
                `;
            } else {
                buttonCard.style.cssText = `
                    background: linear-gradient(135deg, rgba(114, 46, 209, 0.2), rgba(114, 46, 209, 0.1));
                    border: 2px solid rgba(114, 46, 209, 0.4);
                    border-radius: 16px;
                    padding: 40px;
                    margin: 30px 0;
                    text-align: center;
                    animation: fadeInUp 0.8s ease;
                `;
            }
            
            buttonCard.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: ${acceptedCount === 0 ? '#faad14' : '#722ed1'}; font-size: 1.8rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <i class="fas fa-${acceptedCount === 0 ? 'exclamation-circle' : 'magic'}"></i>
                        <span>${acceptedCount === 0 ? 'ÂáÜÂ§áÁîüÊàêÊïôÊ°àÔºàÂü∫‰∫éÂàùÂßãÁâàÊú¨Ôºâ' : 'ÂáÜÂ§áÁîüÊàê‰ºòÂåñÊïôÊ°à'}</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; line-height: 1.8; max-width: 800px; margin: 0 auto;">
                        ${acceptedCount === 0 ? `
                            ‚ö†Ô∏è Êú¨Ê¨°ËÆ®ËÆ∫ÁöÑ <strong style="color: #faad14;">${allDiscussed.length}</strong> ‰∏™ËßÇÁÇπÂùáÊú™ËææÂà∞40%ÈááÁ∫≥ÈòàÂÄº<br>
                            üìö Á≥ªÁªüÂ∞ÜÂü∫‰∫éÂàùÂßãÊïôÊ°àÁîüÊàêÊúÄÁªàÁâàÊú¨Ôºà‰øùÁïôÂéüÊúâÂÜÖÂÆπÔºâ<br>
                            üí° ÊÇ®ÂèØ‰ª•ÂèÇËÄÉ‰∏ìÂÆ∂ÁöÑÁã¨Á´ãÂàÜÊûêÂíåËÆ®ËÆ∫ËÆ∞ÂΩïËøõË°åÊâãÂä®‰ºòÂåñ
                        ` : `
                            üìö Á≥ªÁªüÂ∞ÜËûçÂêàÂàùÂßãÊïôÊ°àÂíå <strong style="color: #52c41a;">${acceptedCount}</strong> ‰∏™‰∏ìÂÆ∂Âª∫ËÆÆ<br>
                            üìù ÁîüÊàê‰∏§‰∏™ÁâàÊú¨ÔºöÁ∫ØÂáÄÁâàÔºàÁõ¥Êé•‰ΩøÁî®Ôºâ+ ÂØπÊØîÊ†áÊ≥®ÁâàÔºàÊü•Áúã‰ºòÂåñÁÇπÔºâ<br>
                            ‚ú® Ê†áÊ≥®ÁâàÂ∞ÜÊ∏ÖÊô∞Â±ïÁ§∫ÊØèÂ§Ñ‰ºòÂåñÁöÑÂâçÂêéÂØπÊØî
                        `}
                    </p>
                </div>
                <button id="startGenerateOptimizedPlanBtn" class="material-btn" onclick="startGenerateOptimizedPlan()" 
                    style="background: linear-gradient(135deg, #722ed1, #9254de); 
                           color: white; 
                           border: none; 
                           padding: 18px 48px; 
                           border-radius: 12px; 
                           font-size: 1.2rem; 
                           font-weight: 600; 
                           cursor: pointer; 
                           transition: all 0.3s ease;
                           box-shadow: 0 8px 24px rgba(114, 46, 209, 0.4);
                           display: inline-flex;
                           align-items: center;
                           gap: 12px;
                           animation: pulse 2s infinite;">
                    <i class="fas fa-rocket"></i>
                    <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>
                </button>
                <div style="margin-top: 20px; color: rgba(255,255,255,0.7); font-size: 0.95rem;">
                    üí° ÊèêÁ§∫ÔºöÁîüÊàêËøáÁ®ãÈúÄË¶Å1-2ÂàÜÈíüÔºåÂ∞ÜËûçÂêàÊâÄÊúâËÆ®ËÆ∫ÁªìÊûú
                </div>
            `;
            
            // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
            if (discussionRounds && safeAppendChild(discussionRounds, buttonCard, 'discussionRounds')) {
                console.log('‚úÖ ÁîüÊàê‰ºòÂåñÊïôÊ°àÊåâÈíÆÂ∑≤Ê∑ªÂä†Âà∞DOM');
                
                // ÊªöÂä®Âà∞ÊåâÈíÆ
                setTimeout(() => {
                    if (buttonCard && document.body.contains(buttonCard)) {
                        ScrollManager.scrollTo(buttonCard, { offset: 80 });
                    }
                }, 300);
            } else {
                console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ∑ªÂä†ÁîüÊàê‰ºòÂåñÊïôÊ°àÊåâÈíÆÂà∞DOM');
            }
        }
        
        // ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°àÔºàÁî®Êà∑ÁÇπÂáªÊåâÈíÆÂêéË∞ÉÁî®Ôºâ
        window.startGenerateOptimizedPlan = async function() {
            const btn = document.getElementById('startGenerateOptimizedPlanBtn');
            const buttonCard = document.getElementById('generateOptimizedPlanCard');
            const discussionRounds = document.getElementById('discussionRounds');
            
            if (!btn || !buttonCard || !discussionRounds) return;
            
            // ===== üíæ Êñ∞ÊñπÊ°àÔºö‰ºòÂÖà‰ªéËÆ®ËÆ∫ËΩÆÊ¨°ËÆ∞ÂΩïÊûÑÂª∫Êï∞ÊçÆ =====
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            console.log('%cüö® ÁîüÊàê‰ºòÂåñÊïôÊ°à - Êï∞ÊçÆÊ∫êÊ£ÄÊü•', 'color: #fa8c16; font-size: 16px; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #fa8c16; font-weight: bold;');
            
            console.log('\nüìä Ê£ÄÊü•ËÆ®ËÆ∫ËΩÆÊ¨°ËÆ∞ÂΩï:');
            console.log(`   window.allRoundRecords: ${window.allRoundRecords ? `‚úÖ ${window.allRoundRecords.length} ËΩÆ` : '‚ùå ‰∏çÂ≠òÂú®'}`);
            
            // ===== üîë ÂÖ≥ÈîÆÔºöÊ£ÄÊü•Âπ∂ÊÅ¢Â§çËÆ®ËÆ∫ËÆ∞ÂΩï =====
            if (!window.allRoundRecords || window.allRoundRecords.length === 0) {
                console.warn('\n%c‚ö†Ô∏è ËÆ®ËÆ∫ËÆ∞ÂΩï‰∏¢Â§±ÔºÅÂ∞ùËØï‰ªélocalStorageÊÅ¢Â§ç...', 'color: #faad14; font-weight: bold;');
                
                try {
                    const roundsBackup = localStorage.getItem('allRoundRecords');
                    if (roundsBackup) {
                        window.allRoundRecords = JSON.parse(roundsBackup);
                        console.log(`%c‚úÖ ‰ªélocalStorageÊÅ¢Â§ç‰∫Ü ${window.allRoundRecords.length} ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩï`, 'color: #52c41a; font-weight: bold;');
                    } else {
                        console.error('%c‚ùå Êó†Ê≥ïÊÅ¢Â§çËÆ®ËÆ∫ËÆ∞ÂΩïÔºÅ', 'color: #ff4d4f; font-weight: bold;');
                        showMessage('‚ùå ËÆ®ËÆ∫ËÆ∞ÂΩï‰∏¢Â§±ÔºÅÊó†Ê≥ïÁîüÊàê‰ºòÂåñÊïôÊ°à„ÄÇ\n\nÂª∫ËÆÆÔºö\n1. Ê£ÄÊü•ÊéßÂà∂Âè∞‰∏≠ÁöÑ window.allRoundRecords\n2. ÊàñÈáçÊñ∞ËøêË°åÊïôÁ†îËÆ®ËÆ∫', 'error');
                        
                        // ÊÅ¢Â§çÊåâÈíÆ
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-rocket"></i> <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>';
                        btn.style.cursor = 'pointer';
                        btn.style.opacity = '1';
                        btn.style.animation = 'pulse 2s infinite';
                        
                        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
                        return; // ÁªàÊ≠¢ÁîüÊàê
                    }
                } catch (e) {
                    console.error('%c‚ùå Êï∞ÊçÆÊÅ¢Â§çÂ§±Ë¥•:', 'color: #ff4d4f; font-weight: bold;', e);
                    showMessage('‚ùå Êï∞ÊçÆÊÅ¢Â§çÂ§±Ë¥•Ôºö' + e.message, 'error');
                    
                    // ÊÅ¢Â§çÊåâÈíÆ
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-rocket"></i> <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>';
                    btn.style.cursor = 'pointer';
                    btn.style.opacity = '1';
                    btn.style.animation = 'pulse 2s infinite';
                    
                    console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
                    return;
                }
            }
            
            // ===== üíæ Á°Æ‰øùÊúâÂàùÂßãÊïôÊ°à =====
            if (!window.initialTeachingPlan || window.initialTeachingPlan.trim().length < 50) {
                console.error('%c‚ùå ÂàùÂßãÊïôÊ°à‰∏¢Â§±ÔºÅ', 'color: #ff4d4f; font-weight: bold;');
                showMessage('‚ùå ÂàùÂßãÊïôÊ°àÊï∞ÊçÆ‰∏¢Â§±ÔºÅÊó†Ê≥ïÁîüÊàê‰ºòÂåñÊïôÊ°à„ÄÇ', 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆ
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket"></i> <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                btn.style.animation = 'pulse 2s infinite';
                return;
            }
            
            // ===== üíæ Êñ∞ÊñπÊ°àÔºö‰ºòÂÖà‰ªéËÆ®ËÆ∫ËΩÆÊ¨°ËÆ∞ÂΩïÊÅ¢Â§çÔºàÊó†ËÆ∫ÊòØÂê¶ÊúâÈááÁ∫≥ËßÇÁÇπÔºâ=====
            console.log('\nüìä È™åËØÅËÆ®ËÆ∫ËΩÆÊ¨°ËÆ∞ÂΩï...');
            console.log(`   window.allRoundRecords: ${window.allRoundRecords ? `‚úÖ ${window.allRoundRecords.length} ËΩÆ` : '‚ùå ‰∏çÂ≠òÂú®'}`);
            
            // Â¶ÇÊûúËÆ®ËÆ∫ËÆ∞ÂΩï‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ªélocalStorageÊÅ¢Â§ç
            if (!window.allRoundRecords || window.allRoundRecords.length === 0) {
                console.warn('\n%c‚ö†Ô∏è ËÆ®ËÆ∫ËÆ∞ÂΩï‰∏¢Â§±ÔºÅÂ∞ùËØï‰ªélocalStorageÊÅ¢Â§ç...', 'color: #faad14; font-weight: bold;');
                
                try {
                    const roundsBackup = localStorage.getItem('allRoundRecords');
                    if (roundsBackup) {
                        window.allRoundRecords = JSON.parse(roundsBackup);
                        console.log(`%c‚úÖ ‰ªélocalStorageÊÅ¢Â§ç‰∫Ü ${window.allRoundRecords.length} ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩï`, 'color: #52c41a; font-weight: bold;');
                    } else {
                        console.error('%c‚ùå localStorage‰∏≠‰πüÊ≤°ÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÂ§á‰ªΩ', 'color: #ff4d4f; font-weight: bold;');
                        showMessage('‚ùå ËÆ®ËÆ∫ËÆ∞ÂΩï‰∏¢Â§±ÔºÅÊó†Ê≥ïÁîüÊàê‰ºòÂåñÊïôÊ°à„ÄÇËØ∑ÈáçÊñ∞ËøêË°åÂàÜÊûê„ÄÇ', 'error');
                        
                        // ÊÅ¢Â§çÊåâÈíÆ
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-rocket"></i> <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>';
                        btn.style.cursor = 'pointer';
                        btn.style.opacity = '1';
                        btn.style.animation = 'pulse 2s infinite';
                        
                        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
                        return; // ÁªàÊ≠¢ÁîüÊàê
                    }
                } catch (e) {
                    console.error('%c‚ùå Êï∞ÊçÆÊÅ¢Â§çÂ§±Ë¥•:', 'color: #ff4d4f; font-weight: bold;', e);
                    showMessage('‚ùå Êï∞ÊçÆÊÅ¢Â§çÂ§±Ë¥•Ôºö' + e.message, 'error');
                    
                    // ÊÅ¢Â§çÊåâÈíÆ
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-rocket"></i> <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>';
                    btn.style.cursor = 'pointer';
                    btn.style.opacity = '1';
                    btn.style.animation = 'pulse 2s infinite';
                    
                    console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
                    return;
                }
            }
            
            // ===== üíæ Á°Æ‰øùÊúâÂàùÂßãÊïôÊ°à =====
            if (!window.initialTeachingPlan || window.initialTeachingPlan.trim().length < 50) {
                console.error('%c‚ùå ÂàùÂßãÊïôÊ°à‰∏¢Â§±ÔºÅ', 'color: #ff4d4f; font-weight: bold;');
                showMessage('‚ùå ÂàùÂßãÊïôÊ°àÊï∞ÊçÆ‰∏¢Â§±ÔºÅÊó†Ê≥ïÁîüÊàê‰ºòÂåñÊïôÊ°à„ÄÇ', 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆ
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket"></i> <span>ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°à</span>';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                btn.style.animation = 'pulse 2s infinite';
                return;
            }
            
            console.log('\n%c‚úÖ Êï∞ÊçÆÊ£ÄÊü•ÈÄöËøáÔºÅÂáÜÂ§áÁîüÊàê‰ºòÂåñÊïôÊ°à', 'color: #52c41a; font-weight: bold;');
            console.log(`   ‚Ä¢ ËÆ®ËÆ∫ËΩÆÊ¨°: ${window.allRoundRecords.length} ËΩÆ`);
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: #fa8c16; font-weight: bold;');
            
            // ===== Á¶ÅÁî®ÊåâÈíÆÔºåÂáÜÂ§áÂºÄÂßãÁîüÊàê =====
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Ê≠£Âú®ÁîüÊàê‰∏≠ÔºåËØ∑Á®çÂÄô...</span>';
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';
            btn.style.animation = 'none';
            
            try {
                // Êõ¥Êñ∞ËøõÂ∫¶
                updateProgress('stage2Progress', 'stage2ProgressText', 95, 'Ê≠£Âú®ÁîüÊàêËûçÂêàÊïôÊ°à...');
                
                // ===== Ë∞ÉÁî®ÁîüÊàêËûçÂêàÊïôÊ°àÂáΩÊï∞ =====
                await generateFusedTeachingPlan(discussionRounds);
                
                // ÁîüÊàêÂÆåÊàêÂêéÈöêËóèÊåâÈíÆÂç°Áâá
                buttonCard.style.transition = 'all 0.5s ease';
                buttonCard.style.opacity = '0';
                buttonCard.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    buttonCard.style.display = 'none';
                }, 500);
                
                // Êõ¥Êñ∞ËøõÂ∫¶‰∏∫100%
                updateProgress('stage2Progress', 'stage2ProgressText', 100, '‚úÖ Á¨¨‰∫åÈò∂ÊÆµÂÆåÊàêÔºÅ‰ºòÂåñÊïôÊ°àÂ∑≤ÁîüÊàê');
                
                // ÊòæÁ§∫ÁîüÊàêÊïôÂ≠¶ÊùêÊñôÊåâÈíÆ
                setTimeout(() => {
                    showGenerateCourseMaterialButton(discussionRounds);
                }, 1000);
                
                // Â¶ÇÊûúÊúâÂàùÊ≠•ÁîüÊàêÁöÑÊùêÊñôÔºå‰πüÊòæÁ§∫ÊùêÊñôÂàóË°®
                if (window.generatedMaterials && window.generatedMaterials.length > 0) {
                    setTimeout(async () => {
                        await showGeneratedMaterialsSection();
                    }, 1500);
                }
                
            } catch (error) {
                console.error('‰ºòÂåñÊïôÊ°àÁîüÊàêÂ§±Ë¥•:', error);
                
                // ÊÅ¢Â§çÊåâÈíÆ
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i> <span>ÈáçÊñ∞ÁîüÊàê</span>';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                
                showMessage('‚ùå ‰ºòÂåñÊïôÊ°àÁîüÊàêÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        };
        
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂÆâÂÖ®Êõ¥Êñ∞ÁîüÊàêËøõÂ∫¶UI
        function updateGenerationUI(generationDiv, updates) {
            if (!generationDiv || !generationDiv.parentNode) {
                console.warn('‚ö†Ô∏è generationDiv‰∏çÂèØÁî®ÔºåË∑≥ËøáUIÊõ¥Êñ∞');
                return false;
            }
            
            try {
                if (updates.status) {
                    const statusElement = generationDiv.querySelector('.agent-status');
                    if (statusElement) {
                        statusElement.textContent = updates.status.text;
                        statusElement.className = updates.status.className;
                        if (updates.status.style) {
                            Object.assign(statusElement.style, updates.status.style);
                        }
                    }
                }
                
                if (updates.content) {
                    const contentElement = generationDiv.querySelector('.speech-content');
                    if (contentElement) {
                        contentElement.innerHTML = updates.content;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞UIÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂÆâÂÖ®Âú∞Ê∑ªÂä†Â≠êÂÖÉÁ¥†Âà∞ÂÆπÂô®
        function safeAppendChild(container, child, containerName = 'container') {
            if (!container) {
                console.warn(`‚ö†Ô∏è ${containerName}‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊ∑ªÂä†Â≠êÂÖÉÁ¥†`);
                return false;
            }
            
            if (!child) {
                console.warn(`‚ö†Ô∏è Â≠êÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊ∑ªÂä†Âà∞${containerName}`);
                return false;
            }
            
            // È™åËØÅcontainerÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
            if (!(container instanceof HTMLElement)) {
                console.error(`‚ùå ${containerName}‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†`);
                return false;
            }
            
            // È™åËØÅchildÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
            if (!(child instanceof HTMLElement)) {
                console.error(`‚ùå Â≠êÂÖÉÁ¥†‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†`);
                return false;
            }
            
            // È™åËØÅcontainerÂú®DOMÊ†ë‰∏≠
            if (!document.body.contains(container)) {
                console.error(`‚ùå ${containerName}‰∏çÂú®DOMÊ†ë‰∏≠`);
                return false;
            }
            
            try {
                container.appendChild(child);
                return true;
            } catch (error) {
                console.error(`‚ùå Ê∑ªÂä†Â≠êÂÖÉÁ¥†Âà∞${containerName}Â§±Ë¥•:`, error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', {
                    containerName: containerName,
                    containerId: container.id,
                    childId: child.id,
                    containerInDOM: document.body.contains(container),
                    errorMessage: error.message
                });
                return false;
            }
        }
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂÆâÂÖ®ÁöÑÂÖÉÁ¥†ÊèíÂÖ•ÔºàÊîØÊåÅÂ§ö‰∏™ÊèíÂÖ•‰ΩçÁΩÆÂ∞ùËØïÔºâ
        function safeInsertElement(container, element, positions) {
            if (!container || !element) {
                console.error('‚ùå safeInsertElement: containerÊàñelement‰∏∫null', { container: !!container, element: !!element });
                return false;
            }
            
            // È™åËØÅcontainerÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†‰∏îÂú®ÊñáÊ°£‰∏≠
            if (!(container instanceof HTMLElement)) {
                console.error('‚ùå safeInsertElement: container‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                return false;
            }
            
            if (!document.body.contains(container)) {
                console.error('‚ùå safeInsertElement: container‰∏çÂú®DOMÊ†ë‰∏≠');
                return false;
            }
            
            // È™åËØÅelementÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
            if (!(element instanceof HTMLElement)) {
                console.error('‚ùå safeInsertElement: element‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                return false;
            }
            
            // Â∞ùËØïÊØè‰∏™ÊåáÂÆöÁöÑ‰ΩçÁΩÆ
            for (const pos of positions) {
                if (!pos || !pos.ref) continue;
                
                // È™åËØÅrefÊòØÂê¶‰∏∫ÊúâÊïàÁöÑDOMÂÖÉÁ¥†‰∏îÂú®container‰∏≠
                if (!(pos.ref instanceof HTMLElement)) {
                    console.warn(`‚ö†Ô∏è ‰ΩçÁΩÆÂèÇËÄÉÂÖÉÁ¥†Êó†Êïà: ${pos.ref}`);
                    continue;
                }
                
                if (!container.contains(pos.ref)) {
                    console.warn(`‚ö†Ô∏è ÂèÇËÄÉÂÖÉÁ¥†‰∏çÂú®container‰∏≠: ${pos.ref.id || 'element'}`);
                    continue;
                }
                
                try {
                    // Âº∫ÂåñÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
                    if (!container || !(container instanceof HTMLElement) || !document.body.contains(container)) {
                        console.warn('‚ö†Ô∏è containerÊó†ÊïàÊàñ‰∏çÂú®DOM‰∏≠ÔºåË∑≥ËøáÊ≠§ÊèíÂÖ•‰ΩçÁΩÆ');
                        continue;
                    }
                    
                    if (pos.position === 'after') {
                        if (pos.ref.nextSibling) {
                            // È™åËØÅnextSibling‰πüÂú®container‰∏≠
                            if (container.contains(pos.ref.nextSibling)) {
                                container.insertBefore(element, pos.ref.nextSibling);
                                console.log(`‚úÖ ÂÖÉÁ¥†Â∑≤ÊèíÂÖ•Âà∞ ${pos.ref.id || 'element'} ‰πãÂêé`);
                                return true;
                            } else {
                                // nextSibling‰∏çÂú®container‰∏≠Ôºå‰ΩøÁî®appendChild
                                container.appendChild(element);
                                console.log(`‚úÖ nextSibling‰∏çÂú®container‰∏≠Ôºå‰ΩøÁî®appendChild`);
                                return true;
                            }
                        } else {
                            // Ê≤°ÊúânextSiblingÔºå‰ΩøÁî®appendChild
                            container.appendChild(element);
                            console.log(`‚úÖ Ê≤°ÊúânextSiblingÔºå‰ΩøÁî®appendChild`);
                            return true;
                        }
                    } else if (pos.position === 'before') {
                        if (pos.ref && container.contains(pos.ref)) {
                            container.insertBefore(element, pos.ref);
                            console.log(`‚úÖ ÂÖÉÁ¥†Â∑≤ÊèíÂÖ•Âà∞ ${pos.ref.id || 'element'} ‰πãÂâç`);
                            return true;
                        } else {
                            console.warn('‚ö†Ô∏è ÂèÇËÄÉÂÖÉÁ¥†Êó†ÊïàÔºå‰ΩøÁî®appendChild');
                            container.appendChild(element);
                            return true;
                        }
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è ÊèíÂÖ•‰ΩçÁΩÆÂ∞ùËØïÂ§±Ë¥•:`, error.message);
                    console.warn('ÈîôËØØËØ¶ÊÉÖ:', {
                        position: pos.position,
                        refId: pos.ref?.id,
                        refInContainer: container.contains(pos.ref),
                        nextSiblingExists: !!pos.ref?.nextSibling
                    });
                    continue;
                }
            }
            
            // ÊâÄÊúâ‰ΩçÁΩÆÈÉΩÂ§±Ë¥•Ôºå‰ΩøÁî®appendChild‰Ωú‰∏∫ÈôçÁ∫ßÊñπÊ°à
            try {
                if (container && container.appendChild && element) {
                    container.appendChild(element);
                    console.log('‚úÖ ‰ΩøÁî®appendChildÈôçÁ∫ßÊñπÊ°àÊàêÂäü');
                    return true;
                } else {
                    console.error('‚ùå containerÊàñelement‰∏çÂèØÁî®');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå appendChildÈôçÁ∫ßÊñπÊ°à‰πüÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // ÁîüÊàêËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°àÔºà‰ΩøÁî® window.allRoundRecords ‰∏≠ÁöÑÊï∞ÊçÆÔºâ
        async function generateFusedTeachingPlan(discussionRounds) {
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #722ed1; font-weight: bold;');
            console.log('%cüéØ ÂºÄÂßãÁîüÊàêËûçÂêàÊïôÊ°à', 'color: #722ed1; font-size: 16px; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #722ed1; font-weight: bold;');
            
            // Â¢ûÂº∫ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ§öÊ¨°Â∞ùËØïËé∑ÂèñdiscussionRounds
            if (!discussionRounds) {
                let retryCount = 0;
                while (!discussionRounds && retryCount < 3) {
                    console.warn(`‚ö†Ô∏è Á¨¨${retryCount + 1}Ê¨°Êú™ÊâæÂà∞discussionRoundsÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑Âèñ...`);
                    await delay(500);
                    discussionRounds = document.getElementById('discussionRounds');
                    retryCount++;
                }
            }
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùdiscussionRoundsÂ≠òÂú®
            if (!discussionRounds || !(discussionRounds instanceof HTMLElement) || !document.body.contains(discussionRounds)) {
                console.error('‚ùå discussionRounds‰∏çÂ≠òÂú®„ÄÅÊó†ÊïàÊàñ‰∏çÂú®DOMÊ†ë‰∏≠ÔºåÊó†Ê≥ïÊòæÁ§∫ÁîüÊàêËøõÂ∫¶');
                console.error('‚ö†Ô∏è Â∞ÜÁªßÁª≠ÁîüÊàêÊïôÊ°àÊï∞ÊçÆÔºå‰ΩÜ‰∏çÊòæÁ§∫ËøõÂ∫¶UI');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöËÆ®ËÆ∫Âå∫Âüü‰∏¢Â§±Ôºå‰ΩÜÂ∞ÜÂ∞ùËØïÁªßÁª≠ÁîüÊàêÊïôÊ°à', 'error');
                // Âç≥‰ΩøÊòæÁ§∫Â§±Ë¥•Ôºå‰πüÁªßÁª≠ÁîüÊàêÊïôÊ°àÊï∞ÊçÆ
            }
            
            // Ëé∑ÂèñÊï∞ÊçÆÔºà‰ªé startGenerateOptimizedPlan ‰º†ÈÄíËøáÊù•ÁöÑÂÖ®Â±ÄÂèòÈáèÔºâ
            const initialPlan = window.initialTeachingPlan || parsedFileContent;
            const opinionsRecordForAI = window.opinionsRecordForAI;
            const totalOpinions = window.totalOpinionsCount || 0;
            const acceptedCount = window.acceptedOpinionsCount || 0;
            const savedOpinions = window.savedOpinionsForFusion || [];
            
            console.log('\nüìä Êï∞ÊçÆÊ∫êÁ°ÆËÆ§:');
            console.log(`   ÂàùÂßãÊïôÊ°à: ${initialPlan ? initialPlan.length : 0} Â≠óÁ¨¶`);
            console.log(`   ËÆ®ËÆ∫ËÆ∞ÂΩï: ${opinionsRecordForAI ? opinionsRecordForAI.length : 0} Â≠óÁ¨¶`);
            console.log(`   ÈááÁ∫≥ËßÇÁÇπ: ${savedOpinions.length} ‰∏™`);
            console.log(`   ÊÄªËßÇÁÇπÊï∞: ${totalOpinions} ‰∏™`);
            
            // ÊòæÁ§∫ÁîüÊàêËøõÂ∫¶
            let generationDiv = null;
            if (discussionRounds && discussionRounds instanceof HTMLElement && document.body.contains(discussionRounds)) {
                try {
                    generationDiv = document.createElement('div');
                    generationDiv.className = 'moderator-card';
                    generationDiv.style.marginTop = '30px';
                    generationDiv.style.background = 'linear-gradient(135deg, rgba(82, 196, 26, 0.15), rgba(82, 196, 26, 0.05))';
                    generationDiv.style.border = '2px solid rgba(82, 196, 26, 0.3)';
                    generationDiv.innerHTML = `
                        <div class="agent-header">
                            <div class="agent-avatar" style="background: ${moderator.color}">
                                ${moderator.avatar}
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">${moderator.name}</div>
                                <div class="agent-specialty">ËûçÂêàÁîüÊàêÊñ∞ÊïôÊ°à</div>
                            </div>
                            <span class="agent-status analyzing">ÁîüÊàê‰∏≠</span>
                        </div>
                        <div class="moderator-speech summary">
                            <div class="speech-label">üìù Ê≠£Âú®ÁîüÊàêËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°à</div>
                            <div class="speech-content">
                                <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®Êï¥ÂêàÂàùÂßãÊïôÊ°àÂíå ${acceptedCount} ‰∏™‰∏ìÂÆ∂ÊîπËøõÂª∫ËÆÆ...
                            </div>
                        </div>
                    `;
                    
                    discussionRounds.appendChild(generationDiv);
                    
                    // ÊªöÂä®Âà∞ÁîüÊàêÂå∫Âüü
                    setTimeout(() => {
                        if (generationDiv && document.body.contains(generationDiv)) {
                            ScrollManager.scrollTo(generationDiv, { offset: 80 });
                        }
                    }, 100);
                } catch (error) {
                    console.error('‚ùå ÂàõÂª∫ÊàñÊèíÂÖ•generationDivÂ§±Ë¥•:', error);
                    generationDiv = null;
                }
            } else {
                console.warn('‚ö†Ô∏è discussionRoundsÊó†ÊïàÔºåË∑≥ËøáÁîüÊàêËøõÂ∫¶UIÊòæÁ§∫');
            }
            
            try {
                // Â¶ÇÊûúÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπÔºåÁîüÊàêÂèÇËÄÉÁâàÊú¨
                if (acceptedCount === 0) {
                    console.warn('‚ö†Ô∏è Ê≤°ÊúâÈááÁ∫≥ÁöÑ‰∏ìÂÆ∂ËßÇÁÇπÔºàÂùáÊú™Ëææ40%ÈòàÂÄºÔºâÔºå‰ΩÜ‰ºöÂèÇËÄÉÊâÄÊúâËÆ®ËÆ∫ÁîüÊàê‰ºòÂåñÁâà');
                    
                    updateGenerationUI(generationDiv, {
                        content: `
                            <div style="color: #faad14; margin-bottom: 15px;">
                                <i class="fas fa-info-circle"></i> <strong>Ê≥®ÊÑèÔºöÊú¨Ê¨°ÊïôÁ†îÊó†ËßÇÁÇπË¢´ÈááÁ∫≥ÔºàÂùáÊú™Ëææ40%ÈòàÂÄºÔºâ</strong>
                            </div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.8;">
                                <p>AIÂ∞ÜÂü∫‰∫éÂàùÂßãÊïôÊ°àÂíåËÆ®ËÆ∫ÂÜÖÂÆπÔºà‰Ωú‰∏∫ÂèÇËÄÉÔºâÁîüÊàê‰ºòÂåñÁâà</p>
                            </div>
                        `
                    });
                    
                    // Ëé∑ÂèñÂú∞Âå∫‰ø°ÊÅØ
                    const region = document.getElementById('region')?.value || 'Â§ßÈôÜ';
                    const isMacau = region === 'Êæ≥Èó®';
                    
                    let noAcceptedPrompt = '';
                    if (isMacau) {
                        // Êæ≥Èó®Âú∞Âå∫‰ºòÂåñÊïôÊ°àprompt
                        noAcceptedPrompt = `‰Ω†ÊòØÊïôÁ†îÁµÑ‰∏ªÊåÅ‰∫∫ÔºåÁèæÂú®ÈúÄË¶ÅÂü∫ÊñºÂàùÂßãÊïôÊ°àÂíåÊïôÁ†îË®éË´ñÂÖßÂÆπÔºåÁîüÊàê‰∏Ä‰ªΩÂÑ™ÂåñÂæåÁöÑÊïôÊ°à„ÄÇ

„Äê5EÊïôÂ≠∏Ê®°ÂûãÊ°ÜÊû∂„ÄëÔºö
1. ÂºïÂÖ•ÔºàEngageÔºâüéØÔºöÂê∏ÂºïÂ≠∏ÁîüÊ≥®ÊÑèÂäõ‰∏¶ÊøÄÁôºÊé¢Á©∂ËààË∂£
2. Êé¢Á©∂ÔºàExploreÔºâüîçÔºöÂ≠∏ÁîüÂü∫ÊñºÂ∑≤ÊúâÁü•Ë≠òÈÄ≤Ë°åÊé¢Á©∂
3. Ëß£ÈáãÔºàExplainÔºâüí°ÔºöÂ≠∏ÁîüËß£ÈáãÊé¢Á¥¢Êî∂Á©´Ôºå‰øÉÈÄ≤Ê¶ÇÂøµÁêÜËß£
4. ÊáâÁî®/ÈÅ∑ÁßªÔºàExtendÔºâüöÄÔºöÂ≠∏ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÊáâÁî®Áü•Ë≠ò
5. Ë©ï‰º∞ÔºàEvaluateÔºâüìäÔºöÂ§öÂÖÉË©ïÂÉπÁúüÂØ¶ÂèçÈ•ãÂ≠∏Áøí

„ÄêÂàùÂßãÊïôÊ°à„ÄëÔºö
${initialPlan}

„ÄêÊïôÁ†îÂ∞àÂÆ∂Ë®éË´ñË®òÈåÑ„ÄëÔºà${window.allRoundRecords.length}Ëº™Ë®éË´ñÔºåÂÖ±${totalOpinions}ÂÄãËßÄÈªûÔºâÔºö

Ë™™ÊòéÔºöÊâÄÊúâËßÄÈªûÁöÑÊäïÁ•®ÂêåÊÑèÁéáÂùáÊú™ÈÅîÂà∞40%Êé°Á¥çÈñæÂÄºÔºå‰ΩÜÈÄô‰∫õË®éË´ñÂÖßÂÆπ‰ªçÊúâÂèÉËÄÉÂÉπÂÄº„ÄÇ

${opinionsRecordForAI}

„ÄêÂÑ™ÂåñË¶ÅÊ±Ç„ÄëÔºö
1. **‰øùÁïôÂàùÂßãÊïôÊ°àÁöÑÂÆåÊï¥ÁµêÊßãÂíå‰∏ªË¶ÅÂÖßÂÆπ**ÔºåÊ†ºÂºèÂíåÁâàÈù¢ÂøÖÈ†àËàáÊæ≥ÈñÄÂú∞ÂçÄÊ®ôÊ∫ñÊïôÊ°àPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥
2. **ÂøÖÈ†àÂåÖÂê´‰ª•‰∏ãÊâÄÊúâÂÖßÂÆπÁµêÊßã**Ôºö
   - Ë™≤È°åÂêçÁ®±
   - Áè≠Á¥ö
   - ‰∫∫Êï∏
   - ÊïôÊùê‰æÜÊ∫ê
   - Ë®≠Ë®àËÄÖ
   - ÊôÇÈñì
   - Â≠∏ÁîüËÉåÊôØÂàÜÊûê
   - ÊîøÁ≠ñË¶èÂÆöÁöÑ‰∏ä‰ΩçÁõÆÊ®ôÔºàÁõ∏ÈóúÁöÑÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÔºâ
   - Êú¨Ë™≤ÁõÆÊ®ô
   - ÊïôÂ≠∏ÁõÆÊ®ô
   - ÂÖ∑È´îÁõÆÊ®ô
   - ÊïôÂ≠∏Á†îÁ©∂ÔºàÂåÖÂê´ÔºöË®≠Ë®àÁêÜÂøµËàáÁõÆÊ®ô„ÄÅÂ≠∏ÁîüÁöÑÂàÜÊûê„ÄÅË™≤Á®ãÊû∂Êßã„ÄÅÁØÄÊ¨°ÂàÜÈÖç„ÄÅÊïôÂ≠∏ÊñπÊ≥ïËàáË©ïÈáè„ÄÅÂèÉËÄÉË≥áÊ∫êÔºâ
   - ÊïôÂ≠∏ÊµÅÁ®ãÔºàÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´ÔºöÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàóÔºâ
   - Ë©ïÂÉπÊñπÂºè
3. **ÂèÉËÄÉ‰ΩÜ‰∏çÂº∑Âà∂ËûçÂêà**Â∞àÂÆ∂ÁöÑË®éË´ñËßÄÈªû
4. Â¶ÇÊûúÊüê‰∫õËßÄÈªûÁ¢∫ÂØ¶ÊúâÂÉπÂÄºÔºåÂèØ‰ª•ÈÅ©Â∫¶ÂèÉËÄÉ‰∏¶ÂÑ™Âåñ
5. ÈáçÈªûÊòØÔºö**‰øùÊåÅÂàùÂßãÊïôÊ°àÁöÑÂÑ™ÈªûÔºåÈÅ©Â∫¶ÊîπÈÄ≤Ë°®Ëø∞ÂíåÁ¥∞ÁØÄ**
6. ‰∏çË¶ÅÂ§ßÂπÖÊîπÂãïÔºåÂè™ÂÅöÁ¥∞ÁØÄÂÑ™Âåñ
7. **Âú®ÂêÑÊïôÂ≠∏Áí∞ÁØÄÊ®ôË®ª„Äê5E-ÈöéÊÆµÂêç„Äë**ÔºåÂ¶ÇÔºö„Äê5E-ÂºïÂÖ•„Äë„ÄÅ„Äê5E-Êé¢Á©∂„Äë„ÄÅ„Äê5E-Ëß£Èáã„Äë„ÄÅ„Äê5E-ÊáâÁî®„Äë„ÄÅ„Äê5E-Ë©ï‰º∞„Äë
8. ËûçÂêàÂæåÁöÑÊïôÊ°àÈï∑Â∫¶Â¢ûÂä†10-20%Âç≥ÂèØ
9. ‰ΩøÁî®ÁπÅÈ´î‰∏≠Êñá
10. ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´ÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàó

ÁèæÂú®ÈñãÂßãÁîüÊàêÂÑ™ÂåñÊïôÊ°àÔºàÂøÖÈ†àÂåÖÂê´5EÊ®ôË®ªÂíåÊâÄÊúâÂøÖÈúÄÂÖßÂÆπÁµêÊßãÔºå‰∏çË¶ÅÂÖ∂‰ªñÈ°çÂ§ñË™™ÊòéÔºâÔºö`;
                    } else {
                        // ÂÖ∂‰ªñÂú∞Âå∫‰ºòÂåñÊïôÊ°àprompt
                        noAcceptedPrompt = `‰Ω†ÊòØÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÁé∞Âú®ÈúÄË¶ÅÂü∫‰∫éÂàùÂßãÊïôÊ°àÂíåÊïôÁ†îËÆ®ËÆ∫ÂÜÖÂÆπÔºåÁîüÊàê‰∏Ä‰ªΩ‰ºòÂåñÂêéÁöÑÊïôÊ°à„ÄÇ

„Äê5EÊïôÂ≠¶Ê®°ÂûãÊ°ÜÊû∂„ÄëÔºö
1. ÂºïÂÖ•ÔºàEngageÔºâüéØÔºöÂê∏ÂºïÂ≠¶ÁîüÊ≥®ÊÑèÂäõÂπ∂ÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£
2. Êé¢Á©∂ÔºàExploreÔºâüîçÔºöÂ≠¶ÁîüÂü∫‰∫éÂ∑≤ÊúâÁü•ËØÜËøõË°åÊé¢Á©∂
3. Ëß£ÈáäÔºàExplainÔºâüí°ÔºöÂ≠¶ÁîüËß£ÈáäÊé¢Á¥¢Êî∂Ëé∑Ôºå‰øÉËøõÊ¶ÇÂøµÁêÜËß£
4. Â∫îÁî®/ËøÅÁßªÔºàExtendÔºâüöÄÔºöÂ≠¶ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÂ∫îÁî®Áü•ËØÜ
5. ËØÑ‰º∞ÔºàEvaluateÔºâüìäÔºöÂ§öÂÖÉËØÑ‰ª∑ÁúüÂÆûÂèçÈ¶àÂ≠¶‰π†

„ÄêÂàùÂßãÊïôÊ°à„ÄëÔºö
${initialPlan}

„ÄêÊïôÁ†î‰∏ìÂÆ∂ËÆ®ËÆ∫ËÆ∞ÂΩï„ÄëÔºà${window.allRoundRecords.length}ËΩÆËÆ®ËÆ∫ÔºåÂÖ±${totalOpinions}‰∏™ËßÇÁÇπÔºâÔºö

ËØ¥ÊòéÔºöÊâÄÊúâËßÇÁÇπÁöÑÊäïÁ•®ÂêåÊÑèÁéáÂùáÊú™ËææÂà∞40%ÈááÁ∫≥ÈòàÂÄºÔºå‰ΩÜËøô‰∫õËÆ®ËÆ∫ÂÜÖÂÆπ‰ªçÊúâÂèÇËÄÉ‰ª∑ÂÄº„ÄÇ

${opinionsRecordForAI}

„Äê‰ºòÂåñË¶ÅÊ±Ç„ÄëÔºö
1. **‰øùÁïôÂàùÂßãÊïôÊ°àÁöÑÂÆåÊï¥ÁªìÊûÑÂíå‰∏ªË¶ÅÂÜÖÂÆπ**
2. **ÂèÇËÄÉ‰ΩÜ‰∏çÂº∫Âà∂ËûçÂêà**‰∏ìÂÆ∂ÁöÑËÆ®ËÆ∫ËßÇÁÇπ
3. Â¶ÇÊûúÊüê‰∫õËßÇÁÇπÁ°ÆÂÆûÊúâ‰ª∑ÂÄºÔºåÂèØ‰ª•ÈÄÇÂ∫¶ÂèÇËÄÉÂπ∂‰ºòÂåñ
4. ÈáçÁÇπÊòØÔºö**‰øùÊåÅÂàùÂßãÊïôÊ°àÁöÑ‰ºòÁÇπÔºåÈÄÇÂ∫¶ÊîπËøõË°®Ëø∞ÂíåÁªÜËäÇ**
5. ‰∏çË¶ÅÂ§ßÂπÖÊîπÂä®ÔºåÂè™ÂÅöÁªÜËäÇ‰ºòÂåñ
6. **Âú®ÂêÑÊïôÂ≠¶ÁéØËäÇÊ†áÊ≥®„Äê5E-Èò∂ÊÆµÂêç„Äë**ÔºåÂ¶ÇÔºö„Äê5E-ÂºïÂÖ•„Äë„ÄÅ„Äê5E-Êé¢Á©∂„Äë„ÄÅ„Äê5E-Ëß£Èáä„Äë„ÄÅ„Äê5E-Â∫îÁî®„Äë„ÄÅ„Äê5E-ËØÑ‰º∞„Äë
7. ËûçÂêàÂêéÁöÑÊïôÊ°àÈïøÂ∫¶Â¢ûÂä†10-20%Âç≥ÂèØ

Áé∞Âú®ÂºÄÂßãÁîüÊàê‰ºòÂåñÊïôÊ°àÔºàÂøÖÈ°ªÂåÖÂê´5EÊ†áÊ≥®Ôºå‰∏çË¶ÅÂÖ∂‰ªñÈ¢ùÂ§ñËØ¥ÊòéÔºâÔºö`;
                    }

                    const referenceOnlyPlan = await callModeratorAPI(noAcceptedPrompt);
                    
                    if (referenceOnlyPlan && referenceOnlyPlan.trim().length > 100) {
                        window.finalTeachingPlan = referenceOnlyPlan;
                        window.finalTeachingPlanClean = referenceOnlyPlan;
                        window.finalTeachingPlanAnnotated = referenceOnlyPlan + `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n„ÄêËØ¥Êòé„Äë\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nÊú¨ÊïôÊ°àÂü∫‰∫éÂàùÂßãÊïôÊ°àÂíå${totalOpinions}‰∏™‰∏ìÂÆ∂ËÆ®ËÆ∫ËßÇÁÇπÁîüÊàê„ÄÇ\n\nüìä ËÆ®ËÆ∫ÁªüËÆ°Ôºö\n- ËÆ®ËÆ∫ËΩÆÊ¨°Ôºö${window.allRoundRecords.length} ËΩÆ\n- ËßÇÁÇπÊÄªÊï∞Ôºö${totalOpinions} ‰∏™\n- ÈááÁ∫≥ËßÇÁÇπÔºö0 ‰∏™ÔºàÂùáÊú™Ëææ40%ÈòàÂÄºÔºâ\n\nüí° ‰ºòÂåñËØ¥ÊòéÔºö\nËôΩÁÑ∂Ê≤°ÊúâËßÇÁÇπË¢´Ê≠£ÂºèÈááÁ∫≥Ôºå‰ΩÜAIÂ∑≤ÂèÇËÄÉÊâÄÊúâËÆ®ËÆ∫ÂÜÖÂÆπÂØπÂàùÂßãÊïôÊ°àËøõË°å‰∫ÜÁªÜËäÇ‰ºòÂåñ„ÄÇ\nÊÇ®ÂèØ‰ª•‰∏ãËΩΩËÆ®ËÆ∫ËÆ∞ÂΩïÔºåÊü•ÁúãÊâÄÊúâ‰∏ìÂÆ∂ËßÇÁÇπÂíåÊäïÁ•®ËØ¶ÊÉÖÔºå‰Ωú‰∏∫Ëøõ‰∏ÄÊ≠•ÊâãÂä®Ë∞ÉÊï¥ÁöÑÂèÇËÄÉ„ÄÇ`;
                    } else {
                        // ÂÆåÂÖ®‰ΩøÁî®ÂàùÂßãÊïôÊ°à
                        window.finalTeachingPlan = initialPlan;
                        window.finalTeachingPlanClean = initialPlan;
                        window.finalTeachingPlanAnnotated = initialPlan + `\n\n„ÄêËØ¥Êòé„Äë\nÊú¨ÊïôÊ°àÊú™ÈááÁ∫≥‰∏ìÂÆ∂Âª∫ËÆÆÔºå‰øùÊåÅÂéüÂßãÂÜÖÂÆπ„ÄÇ\n\nÂéüÂõ†ÔºöÊú¨Ê¨°ÊïôÁ†îËÆ®ËÆ∫‰∏≠ÔºåÊâÄÊúâ${totalOpinions}‰∏™‰∏ìÂÆ∂ËßÇÁÇπÁöÑÊäïÁ•®ÂêåÊÑèÁéáÂùáÊú™ËææÂà∞40%ÈááÁ∫≥ÈòàÂÄº„ÄÇ`;
                    }
                    
                    updateGenerationUI(generationDiv, {
                        status: {
                            text: 'ÂÆåÊàê',
                            className: 'agent-status completed'
                        },
                        content: `
                            <div style="color: #52c41a; margin-bottom: 15px;">
                                <i class="fas fa-check-circle"></i> Â∑≤Âü∫‰∫éÂàùÂßãÊïôÊ°àÂíå${totalOpinions}‰∏™ËÆ®ËÆ∫ËßÇÁÇπÁîüÊàê‰ºòÂåñÁâà
                            </div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.8;">
                                üìù ËôΩÊó†Ê≠£ÂºèÈááÁ∫≥ÁöÑÂª∫ËÆÆÔºå‰ΩÜAIÂ∑≤ÂèÇËÄÉÊâÄÊúâËÆ®ËÆ∫ËøõË°åÁªÜËäÇ‰ºòÂåñ<br>
                                üìä ÊÇ®ÂèØ‰ª•Êü•ÁúãËÆ®ËÆ∫ËÆ∞ÂΩï‰∫ÜËß£ÊâÄÊúâ‰∏ìÂÆ∂ËßÇÁÇπ
                            </div>
                        `
                    });
                    
                    // ÊòæÁ§∫‰ºòÂåñÂêéÁöÑÊïôÊ°àÔºàÁ∫ØÂáÄÁâàÔºâ
                    const cleanPlanDiv = document.createElement('div');
                    cleanPlanDiv.className = 'card';
                    cleanPlanDiv.id = 'fusedTeachingPlanClean';
                    cleanPlanDiv.style.background = 'linear-gradient(135deg, rgba(250, 140, 22, 0.15), rgba(250, 140, 22, 0.05))';
                    cleanPlanDiv.style.border = '2px solid rgba(250, 140, 22, 0.3)';
                    cleanPlanDiv.innerHTML = `
                        <h3 style="color: #fa8c16; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-alt"></i> 
                            ‰ºòÂåñÊïôÊ°àÔºàÂèÇËÄÉ${totalOpinions}‰∏™ËÆ®ËÆ∫ËßÇÁÇπÔºâ
                        </h3>
                        <div style="background: rgba(24, 144, 255, 0.1); border: 1px solid rgba(24, 144, 255, 0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong style="color: #1890ff;">üìä ËÆ®ËÆ∫ÊÉÖÂÜµ</strong><br>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.8;">
                                ‚Ä¢ ËÆ®ËÆ∫ËΩÆÊ¨°Ôºö${window.allRoundRecords.length} ËΩÆ<br>
                                ‚Ä¢ ËßÇÁÇπÊÄªÊï∞Ôºö${totalOpinions} ‰∏™<br>
                                ‚Ä¢ ÈááÁ∫≥ËßÇÁÇπÔºö0 ‰∏™ÔºàÂùáÊú™Ëææ40%ÈòàÂÄºÔºâ<br>
                                ‚Ä¢ ‰ºòÂåñÊñπÂºèÔºöAIÂ∑≤ÂèÇËÄÉÊâÄÊúâËÆ®ËÆ∫ÂÜÖÂÆπËøõË°åÁªÜËäÇ‰ºòÂåñ
                            </span>
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 25px; border-radius: 10px; margin-top: 20px;">
                            <div class="analysis-content" id="fusedPlanContentClean" style="max-height: 600px; overflow-y: auto; color: rgba(255, 255, 255, 0.95); line-height: 2; font-size: 0.95rem;"></div>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="downloadFusedPlan('clean', 'txt')" style="background: linear-gradient(135deg, #1890ff, #40a9ff); margin-right: 10px;">
                                <i class="fas fa-download"></i> TXT
                            </button>
                            <button class="btn" onclick="downloadFusedPlan('clean', 'docx')" style="background: linear-gradient(135deg, #52c41a, #73d13d); margin-right: 10px;">
                                <i class="fas fa-file-word"></i> DOCX
                            </button>
                            <button class="btn" onclick="downloadFusedPlanPDF('clean')" style="background: linear-gradient(135deg, #722ed1, #9254de); margin-right: 10px;">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="btn" onclick="downloadFusedPlan('clean', 'md')" style="background: linear-gradient(135deg, #fa8c16, #faad14);">
                                <i class="fas fa-file-code"></i> MD
                            </button>
                        </div>
                    `;
                    
                    // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
                    if (discussionRounds && discussionRounds.appendChild) {
                        try {
                            discussionRounds.appendChild(cleanPlanDiv);
                        } catch (error) {
                            console.error('‚ùå appendChild cleanPlanDivÂ§±Ë¥•:', error);
                        }
                    }
                    
                    setTimeout(() => {
                        ScrollManager.scrollTo(cleanPlanDiv, { offset: 80 });
                    }, 100);
                    
                    await delay(500);
                    await typeText('fusedPlanContentClean', formatTeachingPlan(initialPlan), 30);
                    
                    showMessage('‚ö†Ô∏è Êú™ÈááÁ∫≥‰∏ìÂÆ∂Âª∫ËÆÆÔºåÂ∑≤‰øùÁïôÂàùÂßãÊïôÊ°àÂÜÖÂÆπ', 'warning');
                    return;
                }
                
                // ===== ÊúâÈááÁ∫≥ËßÇÁÇπÁöÑÊÉÖÂÜµÔºöÁîüÊàêËûçÂêàÊïôÊ°à =====
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log(`üìä ÂáÜÂ§áËûçÂêà‰∏ìÂÆ∂Âª∫ËÆÆÂà∞ÊïôÊ°à‰∏≠`);
                console.log(`   ÈááÁ∫≥Âª∫ËÆÆÊï∞Ôºö${savedOpinions.length} ‰∏™`);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                // Ëé∑ÂèñÂú∞Âå∫‰ø°ÊÅØ
                const regionForOptimized = document.getElementById('region')?.value || 'Â§ßÈôÜ';
                const isMacauOptimized = regionForOptimized === 'Êæ≥Èó®';
                
                // ===== ÁîüÊàêÁ∫ØÂáÄÁâàÊïôÊ°àÁöÑPromptÔºàÂ¢ûÂä†5EÊ®°ÂûãÊ†áÊ≥®Ôºâ =====
                let cleanVersionPrompt = '';
                
                if (isMacauOptimized) {
                    // Êæ≥Èó®Âú∞Âå∫‰ºòÂåñÊïôÊ°àprompt
                    cleanVersionPrompt = `‰Ω†ÊòØÊïôÁ†îÁµÑ‰∏ªÊåÅ‰∫∫ÔºåÁèæÂú®ÈúÄË¶ÅÂ∞áÂàùÂßãÊïôÊ°àÂíåÊïôÁ†îËÄÅÂ∏´ÂÄëÂü∫Êñº5EÊïôÂ≠∏Ê®°ÂûãÁöÑÊîπÈÄ≤Âª∫Ë≠∞ËûçÂêàÔºåÁîüÊàê‰∏Ä‰ªΩÂÑ™ÂåñÂæåÁöÑÊñ∞ÊïôÊ°à„ÄÇ

‚ö†Ô∏è **Êæ≥ÈñÄÂú∞ÂçÄÊïôÊ°àË®≠Ë®àÁâπÊÆäË¶ÅÊ±Ç**ÔºàÂøÖÈ†àÂö¥Ê†ºÈÅµÂÆàÔºâÔºö
1. ÊïôÂ≠∏ÁõÆÊ®ôÂøÖÈ†àÂäÉÂàÜÁÇ∫Ôºö„ÄêË™çÁü•ÁõÆÊ®ô„Äë„ÄÅ„ÄêÊÉÖÊÑèÁõÆÊ®ô„Äë„ÄÅ„ÄêÊäÄËÉΩÁõÆÊ®ô„Äë‰∏âÂÄãÁ∂≠Â∫¶
2. ÊïôÂ≠∏ÁõÆÊ®ôÂøÖÈ†àÊòéÁ¢∫Â∞çÊáâÂà∞„ÄêÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„Äë
3. ÂøÖÈ†àË©≥Á¥∞ÂàÜÊûê„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÔºàÂåÖÊã¨Ë™çÁü•ËÉΩÂäõ„ÄÅÂ≠∏ÁøíËÉΩÂäõ„ÄÅÂü∫Á§éÊ∞¥Âπ≥Ôºâ
4. ÂøÖÈ†àÊòéÁ¢∫Ê®ôË®ª„ÄêÊïôÂ≠∏ÂÖßÂÆπÁöÑÈáçÈªû„ÄëÂíå„ÄêÊïôÂ≠∏ÂÖßÂÆπÁöÑÈõ£Èªû„Äë
5. ÂøÖÈ†àÊää„ÄêÊïôÂ≠∏ÂÖßÂÆπÁöÑÈõ£Èªû„ÄÅÈáçÈªû„ÄëËàá„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÈÄ≤Ë°åÂ∞çÊáâÂàÜÊûê
6. ÂøÖÈ†àÊ®ôË®ª5EÊïôÂ≠∏Ê®°ÂûãÈöéÊÆµ

„Äê5EÊïôÂ≠∏Ê®°ÂûãÊ°ÜÊû∂„ÄëÔºàÊú¨Ê¨°ÊïôÁ†îÁöÑÊ†∏ÂøÉ‰æùÊìöÔºâÔºö
1. ÂºïÂÖ•ÔºàEngageÔºâüéØÔºöÂê∏ÂºïÂ≠∏ÁîüÊ≥®ÊÑèÂäõ‰∏¶ÊøÄÁôºÊé¢Á©∂ËààË∂£
2. Êé¢Á©∂ÔºàExploreÔºâüîçÔºöÂ≠∏ÁîüÂü∫ÊñºÂ∑≤ÊúâÁü•Ë≠òÈÄ≤Ë°åÊé¢Á©∂ÔºåÂª∫ÊßãÊñ∞ÊÑèÁæ©
3. Ëß£ÈáãÔºàExplainÔºâüí°ÔºöÂ≠∏ÁîüËß£ÈáãÊé¢Á¥¢Êî∂Á©´Ôºå‰øÉÈÄ≤Ê¶ÇÂøµÁêÜËß£
4. ÊáâÁî®/ÈÅ∑ÁßªÔºàExtendÔºâüöÄÔºöÂ≠∏ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÊáâÁî®Áü•Ë≠òËß£Ê±∫Êñ∞ÂïèÈ°å
5. Ë©ï‰º∞ÔºàEvaluateÔºâüìäÔºöÂ§öÂÖÉË©ïÂÉπÁúüÂØ¶ÂèçÈ•ãÂ≠∏ÁøíÊïàÊûú

„ÄêÂàùÂßãÊïôÊ°à„ÄëÔºàÂøÖÈ†àÂÆåÊï¥‰øùÁïôÁµêÊßã‰∏¶ÈÅµÂæ™Êæ≥ÈñÄÊïôÊ°àË¶ÅÊ±ÇÔºâÔºö
${initialPlan}

„ÄêÊïôÁ†îÂ∞àÂÆ∂ÂÆåÊï¥Ë®éË´ñË®òÈåÑ„ÄëÔºà${window.allRoundRecords.length}Ëº™Ë®éË´ñÔºåÂÖ±${totalOpinions}ÂÄãËßÄÈªûÔºåÂÖ∂‰∏≠${acceptedCount}ÂÄãË¢´Êé°Á¥çÔºâÔºö

Ë™™ÊòéÔºö
- ‚úÖÊ®ôË®òÁöÑËßÄÈªûÔºöÊäïÁ•®ÂêåÊÑèÁéá‚â•40%Ôºå**ÂøÖÈ†àËûçÂÖ•**ÊïôÊ°àÂ∞çÊáâÁ´†ÁØÄ
- ‚ùåÊ®ôË®òÁöÑËßÄÈªûÔºöÊäïÁ•®Êú™ÈÄöÈÅéÔºåÂÉÖ‰æõÂèÉËÄÉÔºå**‰∏çÂº∑Âà∂ËûçÂÖ•**
- ÊØèËº™Ë®éË´ñÈÉΩÂü∫Êñº5EÊ®°ÂûãÈÄ≤Ë°åÔºåÂåÖÂê´Ë©≤Á´†ÁØÄÁöÑÂàùÂßãÂÖßÂÆπÂíåÂ∞àÂÆ∂Âª∫Ë≠∞

${opinionsRecordForAI}

„ÄêËûçÂêàË¶ÅÊ±Ç - ‚ö†Ô∏èÂøÖÈ†à100%Âö¥Ê†ºÂü∑Ë°å„ÄëÔºö

üéØ **Ê†∏ÂøÉÂéüÂâá**Ôºö
- **Âè™ËûçÂêà‚úÖÊ®ôË®òÁöÑÂª∫Ë≠∞**ÔºàÊäïÁ•®ÈÄöÈÅéÁöÑ${acceptedCount}ÂÄãÔºâ
- **‚ùåÊ®ôË®òÁöÑËßÄÈªû**ÂèØ‰ª•ÂèÉËÄÉ‰ΩÜ‰∏çÂº∑Âà∂ËûçÂÖ•
- **ÂøÖÈ†àÂü∫ÊñºÂàùÂßãÊïôÊ°à**ÈÄ≤Ë°åÂÑ™ÂåñÔºå‰øùÁïôÂéüÊúâÁµêÊßã
- **Ê®ôË®ª5EÊ®°Âûã**ÔºöÂú®ÊïôÊ°àÂêÑÁí∞ÁØÄÊ®ôË®ªÊâÄÂ±¨ÁöÑ5EÈöéÊÆµ
- **Ê†ºÂºèÂíåÁâàÈù¢ÂøÖÈ†àËàáÊæ≥ÈñÄÂú∞ÂçÄÊ®ôÊ∫ñÊïôÊ°àPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥**
- **ÂøÖÈ†àÈÅµÂÆàÊæ≥ÈñÄÂú∞ÂçÄÊïôÊ°àË®≠Ë®àÁâπÊÆäË¶ÅÊ±Ç**

1. **‰øùÁïôÁµêÊßã‰∏¶Ê®ôË®ª5EÔºàÈÅµÂæ™Êæ≥ÈñÄË¶ÅÊ±ÇÔºâ**Ôºö
   ‚úì ÂÆåÊï¥‰øùÁïôÂàùÂßãÊïôÊ°àÁöÑÁµêÊßãÂíåÊ†ºÂºèÔºåÊ†ºÂºèÂíåÁâàÈù¢ÂøÖÈ†àËàáÊæ≥ÈñÄÂú∞ÂçÄÊ®ôÊ∫ñÊïôÊ°àPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥
   ‚úì **ÂøÖÈ†àÂåÖÂê´‰ª•‰∏ãÊâÄÊúâÂÖßÂÆπÁµêÊßã**ÔºàÊæ≥ÈñÄÂú∞ÂçÄÊ®ôÊ∫ñÔºâÔºö
     - Ë™≤È°åÂêçÁ®±
     - Áè≠Á¥ö
     - ‰∫∫Êï∏
     - ÊïôÊùê‰æÜÊ∫ê
     - Ë®≠Ë®àËÄÖ
     - ÊôÇÈñì
     - Â≠∏ÁîüËÉåÊôØÂàÜÊûê
     - ÊîøÁ≠ñË¶èÂÆöÁöÑ‰∏ä‰ΩçÁõÆÊ®ôÔºàÁõ∏ÈóúÁöÑÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÔºâ
     - Êú¨Ë™≤ÁõÆÊ®ô
     - ‚ö†Ô∏è **ÊïôÂ≠∏ÁõÆÊ®ô**ÔºàÂøÖÈ†àÊåâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ‰∏âÁ∂≠ÂäÉÂàÜÔºåÊØèÂÄãÁõÆÊ®ôÂ∞çÊáâÊïôÈùíÂ±ÄÂü∫ÂäõÔºâ
     - ÂÖ∑È´îÁõÆÊ®ô
     - ‚ö†Ô∏è **Â≠∏ÁîüËÉΩÂäõÂàÜÊûê**ÔºàÂøÖÈ†àÂåÖÂê´ÔºöË™çÁü•ËÉΩÂäõÊ∞¥Âπ≥„ÄÅÂ≠∏ÁøíÂü∫Á§éËàáËÉΩÂäõ„ÄÅÂ≠∏ÁøíÂõ∞Èõ£ËàáÊåëÊà∞Ôºâ
     - ‚ö†Ô∏è **ÊïôÂ≠∏ÂÖßÂÆπÂàÜÊûê**ÔºàÂøÖÈ†àÂåÖÂê´ÔºöÊïôÂ≠∏ÂÖßÂÆπÈáçÈªû+Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâ„ÄÅÊïôÂ≠∏ÂÖßÂÆπÈõ£Èªû+Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâ+Á™ÅÁ†¥Á≠ñÁï•Ôºâ
     - ÊïôÂ≠∏Á†îÁ©∂ÔºàÂåÖÂê´ÔºöË®≠Ë®àÁêÜÂøµËàáÁõÆÊ®ô„ÄÅÂ≠∏ÁîüÁöÑÂàÜÊûê„ÄÅË™≤Á®ãÊû∂Êßã„ÄÅÁØÄÊ¨°ÂàÜÈÖç„ÄÅÊïôÂ≠∏ÊñπÊ≥ïËàáË©ïÈáè„ÄÅÂèÉËÄÉË≥áÊ∫êÔºâ
     - ÊïôÂ≠∏ÊµÅÁ®ãÔºàÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´ÔºöÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàóÔºâ
     - Ë©ïÂÉπÊñπÂºèÔºàÂøÖÈ†àÈ´îÁèæË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ‰∏âÂÄãÁ∂≠Â∫¶ÁöÑË©ïÂÉπÔºâ
   ‚úì Âú®ÊØèÂÄãÊïôÂ≠∏Áí∞ÁØÄÂæåÈù¢Áî®„Äê5E-ÈöéÊÆµÂêç„ÄëÊ®ôË®ªÂÖ∂ÊâÄÂ±¨ÁöÑ5EÊïôÂ≠∏Ê®°ÂûãÈöéÊÆµ
   ‚úì Ê®ôË®ªÊ†ºÂºèÔºö„Äê5E-ÂºïÂÖ•„Äë„ÄÅ„Äê5E-Êé¢Á©∂„Äë„ÄÅ„Äê5E-Ëß£Èáã„Äë„ÄÅ„Äê5E-ÊáâÁî®„Äë„ÄÅ„Äê5E-Ë©ï‰º∞„Äë
   ‚úì Á´†ÁØÄÈ†ÜÂ∫è‰∏çËÆäÔºåÂè™ÂÑ™ÂåñÂÖßÂÆπ

2. **ÂÆåÊï¥ËûçÂêà‚úÖÊ®ôË®òÁöÑÂª∫Ë≠∞**ÔºàÈóúÈçµÔºÅÔºâÔºö
   ‚úì ÊØèÂÄã‚úÖÊ®ôË®òÁöÑÂª∫Ë≠∞ÂøÖÈ†à**ÈÄêÊ¢ù„ÄÅÂÆåÊï¥Âú∞ËûçÂÖ•**Âà∞Â∞çÊáâÁ´†ÁØÄ
   ‚úì Â∞áÂª∫Ë≠∞ÁöÑÂÖ∑È´îÂÖßÂÆπ**Ê∑±Â∫¶ÊîπÂØ´ËûçÂÖ•**ÊïôÊ°àÊ≠£Êñá
   ‚úì ‰∏çËÉΩÂè™ËøΩÂä†ÔºåË¶ÅËá™ÁÑ∂ËûçÂÖ•
   ‚úì ËûçÂêàÂæåÁöÑÂÖßÂÆπÊØîÂéüÊïôÊ°àÊõ¥Ë©≥Á¥∞ÔºàÂ¢ûÈï∑30-50%Ôºâ

3. **ËôïÁêÜ‚ùåÊ®ôË®òÁöÑËßÄÈªû**Ôºö
   ‚úì ÈÄô‰∫õËßÄÈªûÊäïÁ•®Êú™ÈÄöÈÅéÔºåÂÉÖ‰ΩúÁÇ∫ÂèÉËÄÉ
   ‚úì Â¶ÇÊûú‰Ω†Ë™çÁÇ∫ÊüêÂÄãÊú™ÈÄöÈÅéÁöÑËßÄÈªûÁ¢∫ÂØ¶ÊúâÂÉπÂÄºÔºåÂèØ‰ª•ÈÅ©Â∫¶ÂèÉËÄÉ
   ‚úì ‰ΩÜÂÑ™ÂÖàÁ¥öÈÅ†‰ΩéÊñº‚úÖÊ®ôË®òÁöÑÂª∫Ë≠∞

4. **Ë≥™ÈáèÊèêÂçáÔºàÁ¨¶Âêà5EÁêÜÂøµÔºâ**Ôºö
   ‚úì ÊîπÈÄ≤ÂæåÁöÑÂÖßÂÆπÊõ¥ÁßëÂ≠∏„ÄÅÊõ¥Á¨¶Âêà5EÊïôÂ≠∏Ê®°ÂûãÁöÑË¶ÅÊ±Ç
   ‚úì Êõ¥ÂÖ∑È´î„ÄÅÊõ¥ÂèØÊìç‰Ωú
   ‚úì Ë™ûË®ÄÊµÅÊö¢Ëá™ÁÑ∂Ôºå‰∏çÁîüÁ°¨
   ‚úì È´îÁèæ5EÊ®°ÂûãÁöÑÈÅûÈÄ≤Èóú‰øÇÔºàÂºïÂÖ•‚ÜíÊé¢Á©∂‚ÜíËß£Èáã‚ÜíÊáâÁî®‚ÜíË©ï‰º∞Ôºâ

5. **Á¥îÊ∑®Ëº∏Âá∫**ÔºöÈÄôÊòØÁ¥îÊ∑®ÁâàÔºå**‰∏çË¶ÅÊ∑ªÂä†‰ªª‰Ωï‚ú®Ê®ôË®ª**Ôºå‰ΩÜ**ÂøÖÈ†àÊ∑ªÂä†„Äê5E-ÈöéÊÆµÂêç„ÄëÊ®ôË®ª**ÔºåÊ®ôÊòéÂêÑÁí∞ÁØÄÊâÄÂ±¨ÁöÑ5EÈöéÊÆµ
6. **‰ΩøÁî®ÁπÅÈ´î‰∏≠Êñá**
7. **ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢Âºè**ÔºåÂåÖÂê´ÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàó

„ÄêË©≥Á¥∞ËûçÂêàÁ§∫‰æãÔºàÂê´5EÊ®ôË®ª+Êæ≥ÈñÄÊïôÊ°àË¶ÅÊ±ÇÔºâ„ÄëÔºö
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÂéüÊïôÊ°àÁâáÊÆµÔºö
„ÄêÊïôÂ≠∏ÁõÆÊ®ô„Äë
1. Áü•Ë≠òËàáÊäÄËÉΩÔºöÂ≠∏ÁîüËÉΩÂ§†ÁêÜËß£ËÅ≤Èü≥ÁöÑÁî¢Áîü
2. ÈÅéÁ®ãËàáÊñπÊ≥ïÔºöÂüπÈ§äÁßëÂ≠∏Êé¢Á©∂ËÉΩÂäõ

„ÄêÂ≠∏ÁîüËÉΩÂäõÂàÜÊûê„Äë
Â≠∏ÁîüÂ∑≤Á∂ìÂ≠∏ÁøíÈÅéÂü∫Êú¨ÁöÑÁâ©ÁêÜÁèæË±°„ÄÇ

„ÄêÊïôÂ≠∏ÂÖßÂÆπÈáçÈªû„Äë
‚≠ê ÈáçÈªû1ÔºöÁêÜËß£ËÅ≤Èü≥ÁöÑÁî¢ÁîüÂéüÁêÜ

„ÄêÂ∞éÂÖ•Áí∞ÁØÄ„Äë
Êí≠ÊîæËÅ≤Èü≥Ë¶ñÈ†ªÔºåÂºïËµ∑Â≠∏ÁîüËààË∂£„ÄÇ

ÊïôÁ†îÂª∫Ë≠∞1ÔºàÊô∫Ë≠úÊ∏ÖË®ÄÔºâ‚úÖÔºöÂª∫Ë≠∞Âú®ÊïôÂ≠∏ÁõÆÊ®ô‰∏≠Â¢ûÂä†Âõ†ÊûúÈóú‰øÇÂíåÁßëÂ≠∏Ë°®ÈÅîËÉΩÂäõÁöÑÂüπÈ§äÔºå‰∏¶Â∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Âäõ
ÊïôÁ†îÂª∫Ë≠∞2ÔºàKimiÔºâ‚úÖÔºöÂª∫Ë≠∞Â¢ûÂä†Â≠∏ÁîüËÉΩÂäõÂàÜÊûêÁöÑÊ∑±Â∫¶ÔºåÊòéÁ¢∫Ë™çÁü•ËÉΩÂäõÊ∞¥Âπ≥
ÊïôÁ†îÂª∫Ë≠∞3ÔºàË±ÜÂåÖÔºâ‚úÖÔºöÂª∫Ë≠∞Â∞áÊïôÂ≠∏ÁõÆÊ®ôÊåâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩÂäÉÂàÜ
ÊïôÁ†îÂª∫Ë≠∞4ÔºàDeepSeekÔºâ‚úÖÔºöÂª∫Ë≠∞ÈáçÈªûËàáÂ≠∏ÁîüËÉΩÂäõÈÄ≤Ë°åÂ∞çÊáâÂàÜÊûê
ÊïôÁ†îÂª∫Ë≠∞5ÔºàÈÄöÁæ©ÂçÉÂïèÔºâ‚úÖÔºöÂª∫Ë≠∞Â∞éÂÖ•Áí∞ÁØÄÂ¢ûÂä†ÂïèÈ°åÊÉÖÂ¢ÉÂíåË™çÁü•Ë°ùÁ™Å

‚úÖ Ê≠£Á¢∫ËûçÂêàÂæåÔºàÁ¨¶ÂêàÊæ≥ÈñÄÊïôÊ°àË¶ÅÊ±Ç+Âê´5EÊ®ôË®ªÔºâÔºö

„ÄêÊïôÂ≠∏ÁõÆÊ®ô„ÄëÔºà‚ö†Ô∏è ÊåâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩÂäÉÂàÜÔºåÂ∞çÊáâÊïôÈùíÂ±ÄÂü∫ÂäõÔºâ

‰∏Ä„ÄÅË™çÁü•ÁõÆÊ®ôÔºàCognitive GoalsÔºâ
1.1 Â≠∏ÁîüËÉΩÂ§†ÈÄöÈÅéÂØ¶È©óËßÄÂØüÔºåÊ∫ñÁ¢∫ÊèèËø∞Áâ©È´îÊåØÂãïËàáËÅ≤Èü≥Áî¢ÁîüÁöÑÂõ†ÊûúÈóú‰øÇÔºå‰∏¶ËÉΩÁî®ÁßëÂ≠∏Ë™ûË®ÄÊ∏ÖÊô∞Ë°®ÈÅîËá™Â∑±ÁöÑÁôºÁèæ
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö„ÄäÂ∞èÂ≠∏ÊïôËÇ≤ÈöéÊÆµÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄãÁßëÂ≠∏È†òÂüü-ËßÄÂØüËàáÂØ¶È©óËÉΩÂäõ

‰∫å„ÄÅÊÉÖÊÑèÁõÆÊ®ôÔºàAffective GoalsÔºâ
2.1 ÂüπÈ§äÂ≠∏ÁîüÂ∞çÁßëÂ≠∏Êé¢Á©∂ÁöÑËààË∂£ÂíåÂ•ΩÂ•áÂøÉÔºåÊøÄÁôº‰∏ªÂãïÊé¢Á¥¢Ëá™ÁÑ∂ÁèæË±°ÁöÑÁÜ±ÊÉÖ
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö„ÄäÂ∞èÂ≠∏ÊïôËÇ≤ÈöéÊÆµÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄãÁßëÂ≠∏È†òÂüü-ÁßëÂ≠∏ÊÖãÂ∫¶ËàáÂÉπÂÄºËßÄ

‰∏â„ÄÅÊäÄËÉΩÁõÆÊ®ôÔºàPsychomotor GoalsÔºâ
3.1 ÂüπÈ§äÁßëÂ≠∏Êé¢Á©∂ËÉΩÂäõÂíåÂ∞èÁµÑÂêà‰ΩúËÉΩÂäõÔºåËÆìÂ≠∏ÁîüÂú®ÂúòÈöäÂçî‰Ωú‰∏≠ÂÖ±ÂêåÂÆåÊàêÂØ¶È©óË®≠Ë®àÂíåÁµêÊûúÂàÜÊûê
   ‚Üí Â∞çÊáâÂü∫ÂäõÔºö„ÄäÂ∞èÂ≠∏ÊïôËÇ≤ÈöéÊÆµÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄãÁßëÂ≠∏È†òÂüü-ÁßëÂ≠∏Êé¢Á©∂ÊñπÊ≥ï

„ÄêÂ≠∏ÁîüËÉΩÂäõÂàÜÊûê„ÄëÔºà‚ö†Ô∏è Ë©≥Á¥∞ÂàÜÊûêÔºâ

‰∏Ä„ÄÅË™çÁü•ËÉΩÂäõÊ∞¥Âπ≥
Â≠∏ÁîüÂ∑≤Á∂ìÂÖ∑ÂÇôÂü∫Êú¨ÁöÑËßÄÂØüËÉΩÂäõÂíåÊèèËø∞ËÉΩÂäõÔºåËÉΩÂ§†Â∞çÁ∞°ÂñÆÁöÑÁâ©ÁêÜÁèæË±°ÈÄ≤Ë°åÂàùÊ≠•Ëß£Èáã„ÄÇ‰ΩÜÂú®Âª∫Á´ãÂõ†ÊûúÈóú‰øÇÂíå‰ΩøÁî®ÁßëÂ≠∏Ë™ûË®ÄË°®ÈÅîÊñπÈù¢ÈÇÑÈúÄË¶ÅÈÄ≤‰∏ÄÊ≠•ÂüπÈ§ä„ÄÇ

‰∫å„ÄÅÂ≠∏ÁøíÂü∫Á§éËàáËÉΩÂäõ
Â≠∏ÁîüÂ∑≤Á∂ìÂ≠∏ÁøíÈÅéÂü∫Êú¨ÁöÑÁâ©ÁêÜÁèæË±°ÔºàÂ¶ÇÂÖâÁöÑÂÇ≥Êí≠„ÄÅÁÜ±ÁöÑÂÇ≥ÈÅûÁ≠âÔºâÔºåÂ∞çÁßëÂ≠∏ÂØ¶È©óÊúâ‰∏ÄÂÆöÁöÑËààË∂£„ÄÇÂÖ∑ÂÇôÂ∞èÁµÑÂêà‰ΩúÁöÑÂü∫Êú¨ËÉΩÂäõÔºå‰ΩÜÂçî‰ΩúÊ∑±Â∫¶ÊúâÂæÖÊèêÂçá„ÄÇ

‰∏â„ÄÅÂ≠∏ÁøíÂõ∞Èõ£ËàáÊåëÊà∞
Â≠∏ÁîüÂèØËÉΩÂú®ÊäΩË±°ÊÄùÁ∂≠ÊñπÈù¢Â≠òÂú®Âõ∞Èõ£ÔºåÈõ£‰ª•Ê∫ñÁ¢∫ÁêÜËß£"ÊåØÂãï"ÈÄôÂÄãÊäΩË±°Ê¶ÇÂøµËàá"ËÅ≤Èü≥"ÈÄôÂÄãÂÖ∑È´îÁèæË±°‰πãÈñìÁöÑÈóú‰øÇ„ÄÇ

„ÄêÊïôÂ≠∏ÂÖßÂÆπÂàÜÊûê„ÄëÔºà‚ö†Ô∏è ÈáçÈªûÈõ£ÈªûËàáÂ≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºâ

‰∏Ä„ÄÅÊïôÂ≠∏ÂÖßÂÆπÈáçÈªû
‚≠ê ÈáçÈªû1ÔºöÁêÜËß£ËÅ≤Èü≥Áî¢ÁîüÁöÑÂéüÁêÜÔºàÁâ©È´îÊåØÂãïÁî¢ÁîüËÅ≤Èü≥Ôºâ
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºöÂ≠∏ÁîüÂ∑≤ÂÖ∑ÂÇôÂü∫Êú¨ËßÄÂØüËÉΩÂäõÔºå‰ΩÜÁº∫‰πèÂõ†ÊûúÈóú‰øÇÂàÜÊûêËÉΩÂäõ„ÄÇÈúÄË¶ÅÈÄöÈÅéÂ§öÂÄãÂØ¶È©óÊ°à‰æãÔºåÂºïÂ∞éÂ≠∏ÁîüÂæûÁèæË±°Âà∞Êú¨Ë≥™ÁöÑË™çÁü•È£õË∫ç„ÄÇÊïôÂ≠∏‰∏≠Â∞áÂÆâÊéí3-4ÂÄã‰∏çÂêåÁöÑÂØ¶È©óÔºàÈü≥Âèâ„ÄÅÈºìÈù¢„ÄÅÁê¥Âº¶ÔºâÔºåËÆìÂ≠∏ÁîüÂú®Â§öÊ¨°ËßÄÂØü‰∏≠Á∏ΩÁµêË¶èÂæã„ÄÇ

‰∫å„ÄÅÊïôÂ≠∏ÂÖßÂÆπÈõ£Èªû
üî∏ Èõ£Èªû1ÔºöÁêÜËß£"ÊåØÂãï"ÈÄôÂÄãÊäΩË±°Ê¶ÇÂøµËàáËÅ≤Èü≥Áî¢ÁîüÁöÑÂõ†ÊûúÈóú‰øÇ
   ‚Üí Â≠∏ÁîüËÉΩÂäõÂ∞çÊáâÔºöÂ∞èÂ≠∏Áîü‰ª•ÂÖ∑È´îÂΩ¢Ë±°ÊÄùÁ∂≠ÁÇ∫‰∏ªÔºåÂ∞çÊäΩË±°ÁöÑ"ÊåØÂãï"Ê¶ÇÂøµÁêÜËß£Âõ∞Èõ£„ÄÇÈúÄË¶ÅÂ∞áÊäΩË±°Ê¶ÇÂøµÂÖ∑È´îÂåñ„ÄÅÂèØË¶ñÂåñ„ÄÇ
   ‚Üí Á™ÅÁ†¥Á≠ñÁï•Ôºö‰ΩøÁî®Â§öÁ®ÆÂèØË¶ñÂåñÊâãÊÆµÔºàÂ¶ÇÂú®ÈºìÈù¢‰∏äÊîæÁΩÆÁ¥ôÂ±ëËßÄÂØüÊåØÂãï„ÄÅÁî®ÊâãËß∏Êë∏Èü≥ÂèâÊÑüÂèóÊåØÂãïÔºâÔºåÂæûËß∏Ë¶∫„ÄÅË¶ñË¶∫Â§öÊÑüÂÆòÈ´îÈ©ó"ÊåØÂãï"ÔºåÈôç‰ΩéÁêÜËß£Èõ£Â∫¶„ÄÇ

„ÄêÂ∞éÂÖ•Áí∞ÁØÄ„Äë„Äê5E-ÂºïÂÖ•„Äë
ÊïôÂ∏´Êí≠ÊîæÂÖ©ÊÆµÂ∞çÊØîË¶ñÈ†ªÔºö‰∏ÄÊÆµÊòØÂÆâÈùúÁí∞Â¢ÉÔºå‰∏ÄÊÆµÊòØÊúâËÅ≤Áí∞Â¢É„ÄÇÊèêÂïèÔºö"ÁÇ∫‰ªÄÈ∫ºÊúâÁöÑÊôÇÂÄôÊúâËÅ≤Èü≥ÔºåÊúâÁöÑÊôÇÂÄôÊ≤íÊúâËÅ≤Èü≥ÔºüËÅ≤Èü≥ÊòØÊÄéÈ∫ºÁî¢ÁîüÁöÑÔºü"ÈÄöÈÅéÂ∞çÊØîÂºïÁôºÂ≠∏ÁîüÁöÑË™çÁü•Ë°ùÁ™ÅÔºåÊøÄÁôºÊé¢Á©∂ËààË∂£„ÄÇÈÄôÂÄãË®≠Ë®àÈáùÂ∞çÂ≠∏ÁîüÁöÑÂÖ∑È´îÂΩ¢Ë±°ÊÄùÁ∂≠ÁâπÈªûÔºåÁî®Â∞çÊØîÁöÑÊñπÂºèËÆìÊäΩË±°ÂïèÈ°åÂÖ∑È´îÂåñ„ÄÇ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÄêÈ©óË≠âÊ∏ÖÂñÆ - ‰Ω†ÂøÖÈ†àÊ™¢Êü•„ÄëÔºà‚ö†Ô∏è Êæ≥ÈñÄÂú∞ÂçÄÊïôÊ°àÁâπÊÆäË¶ÅÊ±ÇÔºâÔºö
‚òë ÊâÄÊúâ${acceptedCount}Ê¢ù‚úÖÂª∫Ë≠∞ÈÉΩÂ∑≤ËûçÂÖ•Ôºü
‚òë ÊØèÂÄãÁ´†ÁØÄÈÉΩÊúâÊòéÈ°ØÊîπÈÄ≤Ôºü
‚òë ËûçÂêàÂæåÁöÑÊïôÊ°àÊòéÈ°ØÊØîÂàùÂßãÊïôÊ°àÊõ¥ÂÑ™ÁßÄÔºü
‚òë Ë™ûË®ÄËá™ÁÑ∂ÊµÅÊö¢ÔºåÊ≤íÊúâÁîüÁ°¨ÊãºÊé•ÊÑüÔºü
‚òë Ê≤íÊúâÊ∑ªÂä†‰ªª‰Ωï‚ú®Ê®ôË®òÔºü
‚òë ÂêÑÊïôÂ≠∏Áí∞ÁØÄÈÉΩÂ∑≤Ê®ôË®ª„Äê5E-ÈöéÊÆµÂêç„ÄëÔºü
‚òë 5EÊ®ôË®ªÊ∫ñÁ¢∫ÂèçÊò†‰∫ÜË©≤Áí∞ÁØÄÁöÑÊïôÂ≠∏ÁâπÂæµÔºü
‚òë ÊòØÂê¶ÂåÖÂê´ÊâÄÊúâÂøÖÈúÄÁöÑÂÖßÂÆπÁµêÊßãÔºü
‚òë ÊïôÂ≠∏ÊµÅÁ®ãÊòØÂê¶‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´ÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàóÔºü

‚ö†Ô∏è **Êæ≥ÈñÄÂú∞ÂçÄÊïôÊ°àÁâπÊÆäË¶ÅÊ±ÇÊ™¢Êü•**ÔºàÂøÖÈ†àÂÖ®ÈÉ®Á¨¶ÂêàÔºâÔºö
‚òë ÊïôÂ≠∏ÁõÆÊ®ôÊòØÂê¶Êåâ„ÄêË™çÁü•ÁõÆÊ®ô„Äë„ÄÅ„ÄêÊÉÖÊÑèÁõÆÊ®ô„Äë„ÄÅ„ÄêÊäÄËÉΩÁõÆÊ®ô„Äë‰∏âÂÄãÁ∂≠Â∫¶ÂäÉÂàÜÔºü
‚òë ÊØèÂÄãÊïôÂ≠∏ÁõÆÊ®ôÊòØÂê¶ÊòéÁ¢∫Â∞çÊáâÂà∞„ÄêÊæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄëÔºü
‚òë ÊòØÂê¶ÂåÖÂê´„ÄêÂ≠∏ÁîüËÉΩÂäõÂàÜÊûê„ÄëÁ´†ÁØÄÔºàË™çÁü•ËÉΩÂäõÊ∞¥Âπ≥„ÄÅÂ≠∏ÁøíÂü∫Á§éËàáËÉΩÂäõ„ÄÅÂ≠∏ÁøíÂõ∞Èõ£ËàáÊåëÊà∞ÔºâÔºü
‚òë ÊòØÂê¶ÂåÖÂê´„ÄêÊïôÂ≠∏ÂÖßÂÆπÂàÜÊûê„ÄëÁ´†ÁØÄÔºåÊòéÁ¢∫Ê®ôË®ªÈáçÈªûÂíåÈõ£ÈªûÔºü
‚òë ÊØèÂÄãÈáçÈªûÊòØÂê¶Ëàá„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÈÄ≤Ë°åÂ∞çÊáâÂàÜÊûêÔºü
‚òë ÊØèÂÄãÈõ£ÈªûÊòØÂê¶Ëàá„ÄêÂ≠∏ÁîüËÉΩÂäõ„ÄëÈÄ≤Ë°åÂ∞çÊáâÂàÜÊûêÔºå‰∏¶Êèê‰æõÁ™ÅÁ†¥Á≠ñÁï•Ôºü
‚òë ÊïôÂ≠∏ÊµÅÁ®ãÊòØÂê¶È´îÁèæÂ¶Ç‰ΩïÂü∫ÊñºÂ≠∏ÁîüËÉΩÂäõÁ™ÅÁ†¥ÈáçÈªûÈõ£ÈªûÔºü
‚òë Ë©ïÂÉπÊñπÂºèÊòØÂê¶Â∞çÊáâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩ‰∏âÂÄãÁ∂≠Â∫¶Ôºü

‚ö†Ô∏è**ÁâπÂà•Ë≠¶Âëä**Ôºö
- Â¶ÇÊûúÈÅ∫Êºè‰ªª‰Ωï‰∏ÄÊ¢ùÂª∫Ë≠∞ÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ
- Â¶ÇÊûúÂè™ÊòØÁ∞°ÂñÆËøΩÂä†ËÄå‰∏çÊòØÊ∑±Â∫¶ËûçÂêàÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ
- Â¶ÇÊûúËûçÂêàÂæåÁöÑÊïôÊ°àÊ≤íÊúâÊòéÈ°ØÊèêÂçáÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ
- Â¶ÇÊûúÁº∫Â∞ë‰ªª‰ΩïÂøÖÈúÄÁöÑÂÖßÂÆπÁµêÊßãÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ
- Â¶ÇÊûúÊïôÂ≠∏ÊµÅÁ®ã‰∏çÊòØË°®Ê†ºÂΩ¢ÂºèÊàñÁº∫Â∞ë‰ªª‰Ωï‰∏ÄÂàóÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ
- **Â¶ÇÊûúÊïôÂ≠∏ÁõÆÊ®ôÊ≤íÊúâÊåâË™çÁü•/ÊÉÖÊÑè/ÊäÄËÉΩÂäÉÂàÜÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ**
- **Â¶ÇÊûúÊïôÂ≠∏ÁõÆÊ®ôÊ≤íÊúâÂ∞çÊáâÂà∞Êæ≥ÈñÄÊïôÈùíÂ±ÄÂü∫ÂäõÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ**
- **Â¶ÇÊûúÊ≤íÊúâÂ≠∏ÁîüËÉΩÂäõÂàÜÊûêÁ´†ÁØÄÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ**
- **Â¶ÇÊûúÈáçÈªûÈõ£ÈªûÊ≤íÊúâËàáÂ≠∏ÁîüËÉΩÂäõÂ∞çÊáâÂàÜÊûêÔºåËûçÂêàÂ∞±ÊòØÂ§±ÊïóÁöÑ**

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ ÁèæÂú®ÈñãÂßãÁîüÊàêÔºåË¶ÅÊ±ÇÔºö
1. ÈÄêÊ¢ùËôïÁêÜÊØèÂÄã‚úÖÂª∫Ë≠∞ÔºåÁ¢∫‰øùÊ∑±Â∫¶ËûçÂÖ•Â∞çÊáâÁ´†ÁØÄ
2. ËûçÂêàÂæåÁöÑÊïôÊ°àÊòéÈ°ØÂÑ™ÊñºÂàùÂßãÊïôÊ°à
3. Áõ¥Êé•Ëº∏Âá∫ÂÆåÊï¥ÊïôÊ°àÔºå‰∏çË¶Å‰ªª‰ΩïÈ°çÂ§ñË™™Êòé
4. Â¶ÇÊûúÁÑ°Ê≥ïÂÆåÊï¥ËûçÂêàÊâÄÊúâÂª∫Ë≠∞ÔºåË´ãÂú®Áõ∏ÊáâÁ´†ÁØÄË£úÂÖÖ‰∏ÄÂÄãÊñ∞ÊÆµËêΩ‰æÜÈ´îÁèæË©≤Âª∫Ë≠∞
5. ÂøÖÈ†àÂåÖÂê´ÊâÄÊúâÂøÖÈúÄÁöÑÂÖßÂÆπÁµêÊßã
6. ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢Âºè
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ÈñãÂßãËº∏Âá∫ÂÑ™ÂåñÊïôÊ°àÔºö`;
                } else {
                    // ÂÖ∂‰ªñÂú∞Âå∫‰ºòÂåñÊïôÊ°àprompt
                    cleanVersionPrompt = `‰Ω†ÊòØÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÁé∞Âú®ÈúÄË¶ÅÂ∞ÜÂàùÂßãÊïôÊ°àÂíåÊïôÁ†îËÄÅÂ∏à‰ª¨Âü∫‰∫é5EÊïôÂ≠¶Ê®°ÂûãÁöÑÊîπËøõÂª∫ËÆÆËûçÂêàÔºåÁîüÊàê‰∏Ä‰ªΩ‰ºòÂåñÂêéÁöÑÊñ∞ÊïôÊ°à„ÄÇ

„Äê5EÊïôÂ≠¶Ê®°ÂûãÊ°ÜÊû∂„ÄëÔºàÊú¨Ê¨°ÊïôÁ†îÁöÑÊ†∏ÂøÉ‰æùÊçÆÔºâÔºö
1. ÂºïÂÖ•ÔºàEngageÔºâüéØÔºöÂê∏ÂºïÂ≠¶ÁîüÊ≥®ÊÑèÂäõÂπ∂ÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£
2. Êé¢Á©∂ÔºàExploreÔºâüîçÔºöÂ≠¶ÁîüÂü∫‰∫éÂ∑≤ÊúâÁü•ËØÜËøõË°åÊé¢Á©∂ÔºåÂª∫ÊûÑÊñ∞ÊÑè‰πâ
3. Ëß£ÈáäÔºàExplainÔºâüí°ÔºöÂ≠¶ÁîüËß£ÈáäÊé¢Á¥¢Êî∂Ëé∑Ôºå‰øÉËøõÊ¶ÇÂøµÁêÜËß£
4. Â∫îÁî®/ËøÅÁßªÔºàExtendÔºâüöÄÔºöÂ≠¶ÁîüÂú®Êñ∞ÊÉÖÂ¢É‰∏ãÂ∫îÁî®Áü•ËØÜËß£ÂÜ≥Êñ∞ÈóÆÈ¢ò
5. ËØÑ‰º∞ÔºàEvaluateÔºâüìäÔºöÂ§öÂÖÉËØÑ‰ª∑ÁúüÂÆûÂèçÈ¶àÂ≠¶‰π†ÊïàÊûú

„ÄêÂàùÂßãÊïôÊ°à„ÄëÔºàÂøÖÈ°ªÂÆåÊï¥‰øùÁïôÁªìÊûÑÔºâÔºö
${initialPlan}

„ÄêÊïôÁ†î‰∏ìÂÆ∂ÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩï„ÄëÔºà${window.allRoundRecords.length}ËΩÆËÆ®ËÆ∫ÔºåÂÖ±${totalOpinions}‰∏™ËßÇÁÇπÔºåÂÖ∂‰∏≠${acceptedCount}‰∏™Ë¢´ÈááÁ∫≥ÔºâÔºö

ËØ¥ÊòéÔºö
- ‚úÖÊ†áËÆ∞ÁöÑËßÇÁÇπÔºöÊäïÁ•®ÂêåÊÑèÁéá‚â•40%Ôºå**ÂøÖÈ°ªËûçÂÖ•**ÊïôÊ°àÂØπÂ∫îÁ´†ËäÇ
- ‚ùåÊ†áËÆ∞ÁöÑËßÇÁÇπÔºöÊäïÁ•®Êú™ÈÄöËøáÔºå‰ªÖ‰æõÂèÇËÄÉÔºå**‰∏çÂº∫Âà∂ËûçÂÖ•**
- ÊØèËΩÆËÆ®ËÆ∫ÈÉΩÂü∫‰∫é5EÊ®°ÂûãËøõË°åÔºåÂåÖÂê´ËØ•Á´†ËäÇÁöÑÂàùÂßãÂÜÖÂÆπÂíå‰∏ìÂÆ∂Âª∫ËÆÆ

${opinionsRecordForAI}

„ÄêËûçÂêàË¶ÅÊ±Ç - ‚ö†Ô∏èÂøÖÈ°ª100%‰∏•Ê†ºÊâßË°å„ÄëÔºö

üéØ **Ê†∏ÂøÉÂéüÂàô**Ôºö
- **Âè™ËûçÂêà‚úÖÊ†áËÆ∞ÁöÑÂª∫ËÆÆ**ÔºàÊäïÁ•®ÈÄöËøáÁöÑ${acceptedCount}‰∏™Ôºâ
- **‚ùåÊ†áËÆ∞ÁöÑËßÇÁÇπ**ÂèØ‰ª•ÂèÇËÄÉ‰ΩÜ‰∏çÂº∫Âà∂ËûçÂÖ•
- **ÂøÖÈ°ªÂü∫‰∫éÂàùÂßãÊïôÊ°à**ËøõË°å‰ºòÂåñÔºå‰øùÁïôÂéüÊúâÁªìÊûÑ
- **Ê†áÊ≥®5EÊ®°Âûã**ÔºöÂú®ÊïôÊ°àÂêÑÁéØËäÇÊ†áÊ≥®ÊâÄÂ±ûÁöÑ5EÈò∂ÊÆµ

1. **‰øùÁïôÁªìÊûÑÂπ∂Ê†áÊ≥®5E**Ôºö
   ‚úì ÂÆåÊï¥‰øùÁïôÂàùÂßãÊïôÊ°àÁöÑÁªìÊûÑÂíåÊ†ºÂºèÔºà„ÄêËØæÁ®ãÂêçÁß∞„Äë„ÄÅ„ÄêÊïôÂ≠¶ÁõÆÊ†á„ÄëÁ≠âÔºâ
   ‚úì Âú®ÊØè‰∏™ÊïôÂ≠¶ÁéØËäÇÂêéÈù¢Áî®„Äê5E-Èò∂ÊÆµÂêç„ÄëÊ†áÊ≥®ÂÖ∂ÊâÄÂ±ûÁöÑ5EÊïôÂ≠¶Ê®°ÂûãÈò∂ÊÆµ
   ‚úì Ê†áÊ≥®Ê†ºÂºèÔºö„Äê5E-ÂºïÂÖ•„Äë„ÄÅ„Äê5E-Êé¢Á©∂„Äë„ÄÅ„Äê5E-Ëß£Èáä„Äë„ÄÅ„Äê5E-Â∫îÁî®„Äë„ÄÅ„Äê5E-ËØÑ‰º∞„Äë
   ‚úì Á´†ËäÇÈ°∫Â∫è‰∏çÂèòÔºåÂè™‰ºòÂåñÂÜÖÂÆπ

2. **ÂÆåÊï¥ËûçÂêà‚úÖÊ†áËÆ∞ÁöÑÂª∫ËÆÆ**ÔºàÂÖ≥ÈîÆÔºÅÔºâÔºö
   ‚úì ÊØè‰∏™‚úÖÊ†áËÆ∞ÁöÑÂª∫ËÆÆÂøÖÈ°ª**ÈÄêÊù°„ÄÅÂÆåÊï¥Âú∞ËûçÂÖ•**Âà∞ÂØπÂ∫îÁ´†ËäÇ
   ‚úì Â∞ÜÂª∫ËÆÆÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ**Ê∑±Â∫¶ÊîπÂÜôËûçÂÖ•**ÊïôÊ°àÊ≠£Êñá
   ‚úì ‰∏çËÉΩÂè™ËøΩÂä†ÔºåË¶ÅËá™ÁÑ∂ËûçÂÖ•
   ‚úì ËûçÂêàÂêéÁöÑÂÜÖÂÆπÊØîÂéüÊïôÊ°àÊõ¥ËØ¶ÁªÜÔºàÂ¢ûÈïø30-50%Ôºâ

3. **Â§ÑÁêÜ‚ùåÊ†áËÆ∞ÁöÑËßÇÁÇπ**Ôºö
   ‚úì Ëøô‰∫õËßÇÁÇπÊäïÁ•®Êú™ÈÄöËøáÔºå‰ªÖ‰Ωú‰∏∫ÂèÇËÄÉ
   ‚úì Â¶ÇÊûú‰Ω†ËÆ§‰∏∫Êüê‰∏™Êú™ÈÄöËøáÁöÑËßÇÁÇπÁ°ÆÂÆûÊúâ‰ª∑ÂÄºÔºåÂèØ‰ª•ÈÄÇÂ∫¶ÂèÇËÄÉ
   ‚úì ‰ΩÜ‰ºòÂÖàÁ∫ßËøú‰Ωé‰∫é‚úÖÊ†áËÆ∞ÁöÑÂª∫ËÆÆ

4. **Ë¥®ÈáèÊèêÂçáÔºàÁ¨¶Âêà5EÁêÜÂøµÔºâ**Ôºö
   ‚úì ÊîπËøõÂêéÁöÑÂÜÖÂÆπÊõ¥ÁßëÂ≠¶„ÄÅÊõ¥Á¨¶Âêà5EÊïôÂ≠¶Ê®°ÂûãÁöÑË¶ÅÊ±Ç
   ‚úì Êõ¥ÂÖ∑‰Ωì„ÄÅÊõ¥ÂèØÊìç‰Ωú
   ‚úì ËØ≠Ë®ÄÊµÅÁïÖËá™ÁÑ∂Ôºå‰∏çÁîüÁ°¨
   ‚úì ‰ΩìÁé∞5EÊ®°ÂûãÁöÑÈÄíËøõÂÖ≥Á≥ªÔºàÂºïÂÖ•‚ÜíÊé¢Á©∂‚ÜíËß£Èáä‚ÜíÂ∫îÁî®‚ÜíËØÑ‰º∞Ôºâ

5. **Á∫ØÂáÄËæìÂá∫**ÔºöËøôÊòØÁ∫ØÂáÄÁâàÔºå**‰∏çË¶ÅÊ∑ªÂä†‰ªª‰Ωï‚ú®Ê†áÊ≥®**Ôºå‰ΩÜ**ÂøÖÈ°ªÊ∑ªÂä†„Äê5E-Èò∂ÊÆµÂêç„ÄëÊ†áÊ≥®**ÔºåÊ†áÊòéÂêÑÁéØËäÇÊâÄÂ±ûÁöÑ5EÈò∂ÊÆµ

„ÄêËØ¶ÁªÜËûçÂêàÁ§∫‰æãÔºàÂê´5EÊ†áÊ≥®Ôºâ„ÄëÔºö
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÂéüÊïôÊ°àÁâáÊÆµÔºö
„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë
1. Â≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîü
2. ÂüπÂÖªÁßëÂ≠¶Êé¢Á©∂ËÉΩÂäõ

„ÄêÂØºÂÖ•ÁéØËäÇ„Äë
Êí≠ÊîæÂ£∞Èü≥ËßÜÈ¢ëÔºåÂºïËµ∑Â≠¶ÁîüÂÖ¥Ë∂£„ÄÇ

ÊïôÁ†îÂª∫ËÆÆ1ÔºàÊô∫Ë∞±Ê∏ÖË®ÄÔºâ‚úÖÔºöÂª∫ËÆÆÂú®ÊïôÂ≠¶ÁõÆÊ†á‰∏≠Â¢ûÂä†Âõ†ÊûúÂÖ≥Á≥ªÂíåÁßëÂ≠¶Ë°®ËææËÉΩÂäõÁöÑÂüπÂÖª
ÊïôÁ†îÂª∫ËÆÆ2ÔºàKimiÔºâ‚úÖÔºöÂª∫ËÆÆÂ¢ûÂä†Â∞èÁªÑÂêà‰ΩúÁéØËäÇ
ÊïôÁ†îÂª∫ËÆÆ3ÔºàË±ÜÂåÖÔºâ‚úÖÔºöÂª∫ËÆÆÂØºÂÖ•ÁéØËäÇÂ¢ûÂä†ÈóÆÈ¢òÊÉÖÂ¢ÉÂíåËÆ§Áü•ÂÜ≤Á™Å

‚úÖ Ê≠£Á°ÆËûçÂêàÂêéÔºàÂê´5EÊ†áÊ≥®ÔºâÔºö
„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë
1. Â≠¶ÁîüËÉΩÂ§üÈÄöËøáÂÆûÈ™åËßÇÂØüÔºåÂáÜÁ°ÆÊèèËø∞Áâ©‰ΩìÊåØÂä®‰∏éÂ£∞Èü≥‰∫ßÁîüÁöÑÂõ†ÊûúÂÖ≥Á≥ªÔºåÂπ∂ËÉΩÁî®ÁßëÂ≠¶ËØ≠Ë®ÄÊ∏ÖÊô∞Ë°®ËææËá™Â∑±ÁöÑÂèëÁé∞
2. ÂüπÂÖªÁßëÂ≠¶Êé¢Á©∂ËÉΩÂäõÂíåÂ∞èÁªÑÂêà‰ΩúËÉΩÂäõÔºåËÆ©Â≠¶ÁîüÂú®Âõ¢ÈòüÂçè‰Ωú‰∏≠ÂÖ±ÂêåÂÆåÊàêÂÆûÈ™åËÆæËÆ°ÂíåÁªìÊûúÂàÜÊûê

„ÄêÂØºÂÖ•ÁéØËäÇ„Äë„Äê5E-ÂºïÂÖ•„Äë
ÊïôÂ∏àÊí≠Êîæ‰∏§ÊÆµÂØπÊØîËßÜÈ¢ëÔºö‰∏ÄÊÆµÊòØÂÆâÈùôÁéØÂ¢ÉÔºå‰∏ÄÊÆµÊòØÊúâÂ£∞ÁéØÂ¢É„ÄÇÊèêÈóÆÔºö"‰∏∫‰ªÄ‰πàÊúâÁöÑÊó∂ÂÄôÊúâÂ£∞Èü≥ÔºåÊúâÁöÑÊó∂ÂÄôÊ≤°ÊúâÂ£∞Èü≥ÔºüÂ£∞Èü≥ÊòØÊÄé‰πà‰∫ßÁîüÁöÑÔºü"ÈÄöËøáÂØπÊØîÂºïÂèëÂ≠¶ÁîüÁöÑËÆ§Áü•ÂÜ≤Á™ÅÔºåÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£„ÄÇ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÄêÈ™åËØÅÊ∏ÖÂçï - ‰Ω†ÂøÖÈ°ªÊ£ÄÊü•„ÄëÔºö
‚òë ÊâÄÊúâ${acceptedCount}Êù°‚úÖÂª∫ËÆÆÈÉΩÂ∑≤ËûçÂÖ•Ôºü
‚òë ÊØè‰∏™Á´†ËäÇÈÉΩÊúâÊòéÊòæÊîπËøõÔºü
‚òë ËûçÂêàÂêéÁöÑÊïôÊ°àÊòéÊòæÊØîÂàùÂßãÊïôÊ°àÊõ¥‰ºòÁßÄÔºü
‚òë ËØ≠Ë®ÄËá™ÁÑ∂ÊµÅÁïÖÔºåÊ≤°ÊúâÁîüÁ°¨ÊãºÊé•ÊÑüÔºü
‚òë Ê≤°ÊúâÊ∑ªÂä†‰ªª‰Ωï‚ú®Ê†áËÆ∞Ôºü
‚òë ÂêÑÊïôÂ≠¶ÁéØËäÇÈÉΩÂ∑≤Ê†áÊ≥®„Äê5E-Èò∂ÊÆµÂêç„ÄëÔºü
‚òë 5EÊ†áÊ≥®ÂáÜÁ°ÆÂèçÊò†‰∫ÜËØ•ÁéØËäÇÁöÑÊïôÂ≠¶ÁâπÂæÅÔºü

‚ö†Ô∏è**ÁâπÂà´Ë≠¶Âëä**Ôºö
- Â¶ÇÊûúÈÅóÊºè‰ªª‰Ωï‰∏ÄÊù°Âª∫ËÆÆÔºåËûçÂêàÂ∞±ÊòØÂ§±Ë¥•ÁöÑ
- Â¶ÇÊûúÂè™ÊòØÁÆÄÂçïËøΩÂä†ËÄå‰∏çÊòØÊ∑±Â∫¶ËûçÂêàÔºåËûçÂêàÂ∞±ÊòØÂ§±Ë¥•ÁöÑ
- Â¶ÇÊûúËûçÂêàÂêéÁöÑÊïôÊ°àÊ≤°ÊúâÊòéÊòæÊèêÂçáÔºåËûçÂêàÂ∞±ÊòØÂ§±Ë¥•ÁöÑ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Áé∞Âú®ÂºÄÂßãÁîüÊàêÔºåË¶ÅÊ±ÇÔºö
1. ÈÄêÊù°Â§ÑÁêÜÊØè‰∏™‚úÖÂª∫ËÆÆÔºåÁ°Æ‰øùÊ∑±Â∫¶ËûçÂÖ•ÂØπÂ∫îÁ´†ËäÇ
2. ËûçÂêàÂêéÁöÑÊïôÊ°àÊòéÊòæ‰ºò‰∫éÂàùÂßãÊïôÊ°à
3. Áõ¥Êé•ËæìÂá∫ÂÆåÊï¥ÊïôÊ°àÔºå‰∏çË¶Å‰ªª‰ΩïÈ¢ùÂ§ñËØ¥Êòé
4. Â¶ÇÊûúÊó†Ê≥ïÂÆåÊï¥ËûçÂêàÊâÄÊúâÂª∫ËÆÆÔºåËØ∑Âú®Áõ∏Â∫îÁ´†ËäÇË°•ÂÖÖ‰∏Ä‰∏™Êñ∞ÊÆµËêΩÊù•‰ΩìÁé∞ËØ•Âª∫ËÆÆ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ÂºÄÂßãËæìÂá∫‰ºòÂåñÊïôÊ°àÔºö`;
                }

                console.log('üì§ Ë∞ÉÁî®ÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫(Qwen)ÁîüÊàêÁ∫ØÂáÄÁâàÊïôÊ°à...');
                console.log(`%c‚ö†Ô∏è ÂÖ≥ÈîÆÊèêÁ§∫ÔºöAIÂøÖÈ°ªËûçÂêàÊâÄÊúâ ${acceptedCount} Êù°ÈááÁ∫≥Âª∫ËÆÆÔºÅ`, 'color: #ff4d4f; font-weight: bold; font-size: 14px;');
                
                updateGenerationUI(generationDiv, {
                    content: `
                        <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÁîüÊàêÁ∫ØÂáÄÁâà‰ºòÂåñÊïôÊ°àÔºà1/2Ôºâ...<br>
                        <span style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            Âü∫‰∫éÂàùÂßãÊïôÊ°à + ${window.allRoundRecords.length}ËΩÆËÆ®ËÆ∫ËÆ∞ÂΩïÔºàËûçÂêà${acceptedCount}‰∏™ÈááÁ∫≥Âª∫ËÆÆÔºâ
                        </span>
                    `
                });
                
                let cleanPlan = await callModeratorAPI(cleanVersionPrompt);
                
                if (!cleanPlan || cleanPlan.trim().length < 100) {
                    throw new Error('Á∫ØÂáÄÁâàÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
                }
                
                // ===== üîç ËûçÂêàÂÆåÊï¥ÊÄßÂº∫Âà∂È™åËØÅÔºàÁ¨¨‰∏ÄÊ¨°Ê£ÄÊü•Ôºâ=====
                console.log('\n%cüîç ËûçÂêàÂÆåÊï¥ÊÄßÈ™åËØÅÔºàÁ¨¨‰∏ÄÊ¨°Ôºâ', 'color: #1890ff; font-weight: bold;');
                
                // ‰ªéallRoundRecordsÊèêÂèñÊâÄÊúâÈááÁ∫≥ÁöÑËßÇÁÇπ
                const acceptedOpinionsForValidation1 = [];
                window.allRoundRecords.forEach(round => {
                    round.opinions.forEach(op => {
                        const totalVotes = op.votes.agree + op.votes.disagree;
                        const passRate = totalVotes > 0 ? (op.votes.agree / totalVotes) : 0;
                        if (passRate >= 0.4) {
                            acceptedOpinionsForValidation1.push(op);
                        }
                    });
                });
                
                console.log(`   È™åËØÅÂØπË±°Ôºö${acceptedOpinionsForValidation1.length}‰∏™ÈááÁ∫≥ËßÇÁÇπ`);
                
                let missingOpinions = [];
                acceptedOpinionsForValidation1.forEach((opinion, idx) => {
                    const expertName = opinion.expert.name;
                    const opinionKeywords = opinion.content
                        .replace(/Âª∫ËÆÆ|Â∫îËØ•|ÂèØ‰ª•|ÈúÄË¶Å|Â¢ûÂä†|‰ºòÂåñ|ÊîπËøõ|ÊèêÂçá|Âä†Âº∫|Â∫îÂΩì|ÂøÖÈ°ª/g, '')
                        .match(/[\u4e00-\u9fa5]{3,}/g) || [];
                    
                    // Ê£ÄÊü•ÂÖ≥ÈîÆËØçÊòØÂê¶Âú®ÊïôÊ°à‰∏≠
                    const foundKeywords = opinionKeywords.filter(kw => cleanPlan.includes(kw));
                    const foundRate = opinionKeywords.length > 0 ? (foundKeywords.length / opinionKeywords.length) : 0;
                    
                    if (foundRate < 0.3) {
                        missingOpinions.push({
                            index: idx + 1,
                            expert: expertName,
                            section: opinion.section,
                            content: opinion.content,
                            foundRate: (foundRate * 100).toFixed(1) + '%'
                        });
                        console.log(`   ‚ö†Ô∏è ËßÇÁÇπ${idx+1}ÂèØËÉΩÊú™ËûçÂêà: ${expertName}ÔºàÂåπÈÖçÁéá${(foundRate * 100).toFixed(1)}%Ôºâ`);
                    } else {
                        console.log(`   ‚úÖ ËßÇÁÇπ${idx+1}Â∑≤ËûçÂêà: ${expertName}ÔºàÂåπÈÖçÁéá${(foundRate * 100).toFixed(1)}%Ôºâ`);
                    }
                });
                
                // Â¶ÇÊûúÊúâËßÇÁÇπÊú™ËûçÂêàÔºåÂº∫Âà∂ÈáçÊñ∞ÁîüÊàêÔºàÊúÄÂ§öÂ∞ùËØï2Ê¨°Ôºâ
                if (missingOpinions.length > 0 && missingOpinions.length <= acceptedCount * 0.5) {
                    console.warn(`\n%c‚ö†Ô∏è Ê£ÄÊµãÂà∞ ${missingOpinions.length} ‰∏™ËßÇÁÇπÂèØËÉΩÊú™ËûçÂêàÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê...`, 'color: #faad14; font-weight: bold; font-size: 14px;');
                    showMessage(`‚ö†Ô∏è Ê£ÄÊµãÂà∞ÈÉ®ÂàÜËßÇÁÇπÊú™ËûçÂêàÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê...`, 'warning');
                    
                    // Â¢ûÂº∫promptÔºåÊòéÁ°ÆÂàóÂá∫Êú™ËûçÂêàÁöÑËßÇÁÇπ
                    const retryPrompt = cleanVersionPrompt + `\n\n‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ÁâπÂà´Âº∫Ë∞ÉÔºö‰∏äÊ¨°ÁîüÊàêÊó∂‰ª•‰∏ãËßÇÁÇπÂèØËÉΩÊú™ËûçÂêàÔºåËØ∑Âä°ÂøÖÂú®ËøôÊ¨°ÁîüÊàê‰∏≠ËûçÂÖ•Ôºö\n${missingOpinions.map(op => `\n${op.index}. [${op.section}] ${op.expert}ÁöÑÂª∫ËÆÆÔºö\n   ${op.content}\n   ‚Üí ËØ∑Á°Æ‰øùËøôÊù°Âª∫ËÆÆÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÊ∑±Â∫¶ËûçÂÖ•Âà∞„Äê${op.section}„ÄëÁ´†ËäÇ‰∏≠ÔºÅ`).join('\n')}\n\nËØ∑ÈáçÊñ∞ÁîüÊàêÔºåÁ°Æ‰øù‰ª•‰∏äËßÇÁÇπ100%ËûçÂÖ•ÔºÅ`;
                    
                    console.log('üîÑ ÈáçÊñ∞Ë∞ÉÁî®AIÔºåÂº∫Ë∞ÉÊú™ËûçÂêàÁöÑËßÇÁÇπ...');
                    const retryCleanPlan = await callModeratorAPI(retryPrompt);
                    
                    if (retryCleanPlan && retryCleanPlan.trim().length >= cleanPlan.trim().length * 0.9) {
                        cleanPlan = retryCleanPlan;
                        console.log('‚úÖ ÈáçÊñ∞ÁîüÊàêÊàêÂäüÔºå‰ΩøÁî®Êñ∞ÁâàÊú¨');
                    } else {
                        console.warn('‚ö†Ô∏è ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•ÊàñË¥®Èáè‰∏ç‰Ω≥Ôºå‰ΩøÁî®Á¨¨‰∏ÄÊ¨°ÁîüÊàêÁöÑÁâàÊú¨');
                    }
                }
                
                // È™åËØÅÂÜÖÂÆπÂÆåÊï¥ÊÄß
                const cleanPlanLength = cleanPlan.trim().length;
                const initialPlanLength = initialPlan.trim().length;
                console.log('üìä Á∫ØÂáÄÁâàÊïôÊ°àÈïøÂ∫¶ÂØπÊØîÔºö', {
                    cleanPlan: cleanPlanLength,
                    initialPlan: initialPlanLength,
                    Â¢ûÈïøÁéá: ((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(1) + '%'
                });
                
                // Êõ¥‰∏•Ê†ºÁöÑËûçÂêàÈ™åËØÅ
                if (cleanPlanLength < initialPlanLength * 0.8) {
                    console.warn('‚ö†Ô∏è Á∫ØÂáÄÁâàÊïôÊ°àÂÜÖÂÆπÊòéÊòæÁü≠‰∫éÂàùÂßãÊïôÊ°àÔºåÂèØËÉΩËûçÂêà‰∏çÂÆåÊï¥');
                    console.warn('   Â∞ÜÈáçÊñ∞ÁîüÊàê‰ª•Á°Æ‰øùËûçÂêàË¥®Èáè...');
                    
                    // Â¶ÇÊûúÈïøÂ∫¶‰∏çÂ§üÔºåË≠¶Âëä‰ΩÜÁªßÁª≠
                    showMessage('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊïôÊ°àÂèØËÉΩËûçÂêà‰∏çÂÆåÊï¥ÔºåÊ≠£Âú®È™åËØÅ...', 'warning');
                }
                
                // È™åËØÅÊòØÂê¶ÁúüÁöÑËûçÂêà‰∫ÜÈááÁ∫≥ÁöÑÂª∫ËÆÆÔºàÊ£ÄÊü•ÂÖ≥ÈîÆËØçÔºâ
                let fusionQualityScore = 0;
                acceptedOpinionsForValidation1.forEach(opinion => {
                    // ÊèêÂèñÂª∫ËÆÆ‰∏≠ÁöÑÂÖ≥ÈîÆËØçÔºàÂéªÈô§Â∏∏ËßÅËØçÔºâ
                    const keywords = opinion.content
                        .replace(/Âª∫ËÆÆ|Â∫îËØ•|ÂèØ‰ª•|ÈúÄË¶Å|Â¢ûÂä†|‰ºòÂåñ|ÊîπËøõ|ÊèêÂçá|Âä†Âº∫/g, '')
                        .match(/[\u4e00-\u9fa5]{2,}/g) || [];
                    
                    // Ê£ÄÊü•ÊïôÊ°à‰∏≠ÊòØÂê¶ÂåÖÂê´Âª∫ËÆÆÁöÑÂÖ≥ÈîÆÂÜÖÂÆπ
                    const keywordsFound = keywords.filter(keyword => cleanPlan.includes(keyword));
                    if (keywordsFound.length > 0) {
                        fusionQualityScore++;
                    }
                });
                
                const fusionRate = acceptedCount > 0 ? (fusionQualityScore / acceptedCount * 100).toFixed(1) : '100';
                console.log('üìä ËûçÂêàË¥®ÈáèÊ£ÄÊµã:', {
                    'ÈááÁ∫≥Âª∫ËÆÆÊï∞': acceptedCount,
                    'Ê£ÄÊµãÂà∞ËûçÂêà': fusionQualityScore,
                    'ËûçÂêàÁéá': fusionRate + '%'
                });
                
                // ===== üî• Âº∫ÂåñÔºöËûçÂêàÁéá‰∏ç‰Ω≥Êó∂Âº∫Âà∂ÈáçÊñ∞ÁîüÊàê =====
                if (acceptedCount > 0 && fusionQualityScore < acceptedCount * 0.6) {
                    console.warn('\n%cüö® ËûçÂêàÁéá‰Ωé‰∫é60%ÔºåÂ∞ÜÂº∫Âà∂ÈáçÊñ∞ÁîüÊàêÔºÅ', 'color: #ff4d4f; font-weight: bold; font-size: 14px;');
                    showMessage('‚ö†Ô∏è ËûçÂêàË¥®Èáè‰∏ç‰Ω≥ÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê‰ª•Á°Æ‰øùÊâÄÊúâÂª∫ËÆÆËûçÂÖ•...', 'warning');
                    
                    // ÊâæÂá∫Êú™ËûçÂêàÁöÑËßÇÁÇπ
                    const notFusedOpinions = [];
                    acceptedOpinionsForValidation.forEach((opinion, idx) => {
                        const keywords = opinion.content
                            .replace(/Âª∫ËÆÆ|Â∫îËØ•|ÂèØ‰ª•|ÈúÄË¶Å|Â¢ûÂä†|‰ºòÂåñ|ÊîπËøõ|ÊèêÂçá|Âä†Âº∫/g, '')
                            .match(/[\u4e00-\u9fa5]{2,}/g) || [];
                        const keywordsFound = keywords.filter(keyword => cleanPlan.includes(keyword));
                        if (keywordsFound.length === 0) {
                            notFusedOpinions.push({
                                index: idx + 1,
                                expert: opinion.expert.name,
                                section: opinion.section,
                                content: opinion.content
                            });
                        }
                    });
                    
                    console.log(`   Êú™ËûçÂêàÁöÑËßÇÁÇπÂàóË°®Ôºà${notFusedOpinions.length}‰∏™Ôºâ:`);
                    notFusedOpinions.forEach(op => {
                        console.log(`      ${op.index}. [${op.section}] ${op.expert}: ${op.content.substring(0, 50)}...`);
                    });
                    
                    // Âº∫Âà∂ÈáçÊñ∞ÁîüÊàêÔºåÁâπÂà´Âº∫Ë∞ÉÊú™ËûçÂêàÁöÑËßÇÁÇπ
                    const forceRetryPrompt = `‰Ω†ÊòØÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÁé∞Âú®ÈúÄË¶ÅÂ∞ÜÂàùÂßãÊïôÊ°àÂíåÊïôÁ†îËÄÅÂ∏à‰ª¨ÁöÑÊîπËøõÂª∫ËÆÆËûçÂêàÔºåÁîüÊàê‰∏Ä‰ªΩ‰ºòÂåñÂêéÁöÑÊñ∞ÊïôÊ°à„ÄÇ

„ÄêÂàùÂßãÊïôÊ°à„ÄëÔºö
${initialPlan}

„ÄêÊïôÁ†î‰∏ìÂÆ∂ÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩï„ÄëÔºà${window.allRoundRecords.length}ËΩÆËÆ®ËÆ∫ÔºâÔºö
${opinionsRecordForAI}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ÁâπÂà´Ë≠¶ÂëäÔºö‰∏ä‰∏ÄÊ¨°ÁîüÊàêÊó∂ÈÉ®ÂàÜ‚úÖÊ†áËÆ∞ÁöÑËßÇÁÇπÊú™ËûçÂêàÔºåËøôÊ¨°ÂøÖÈ°ª100%ËûçÂêàÔºÅ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${notFusedOpinions.length > 0 ? `\nÈáçÁÇπÂÖ≥Ê≥®‰ª•‰∏ã${notFusedOpinions.length}‰∏™ËßÇÁÇπÔºà‰∏äÊ¨°Êú™Ê£ÄÊµãÂà∞ËûçÂêàÔºâÔºö\n${notFusedOpinions.map(op => `\n‚úã ËßÇÁÇπ${op.index}„ÄêÂøÖÈ°ªËûçÂêà„ÄëÔºö\n   ‰∏ìÂÆ∂Ôºö${op.expert}\n   Á´†ËäÇÔºö„Äê${op.section}„Äë\n   Âª∫ËÆÆÔºö${op.content}\n   ‚Üí Ë¶ÅÊ±ÇÔºöÂøÖÈ°ªÂú®„Äê${op.section}„ÄëÁ´†ËäÇ‰∏≠‰ΩìÁé∞Ê≠§Âª∫ËÆÆÁöÑÂÖ∑‰ΩìÊîπËøõÂÜÖÂÆπÔºÅ‰∏çËÉΩÈÅóÊºèÔºÅ`).join('\n\n')}\n\n` : ''}

„ÄêËûçÂêàËßÑÂàô - ‰∏•Ê†ºÊâßË°å„ÄëÔºö

1. **ÈÄêÊù°ËûçÂêà‚úÖÊ†áËÆ∞ÁöÑÂª∫ËÆÆ**Ôºö
   - Âè™ËûçÂêàÊäïÁ•®ÈÄöËøáÁöÑ${acceptedCount}‰∏™Âª∫ËÆÆ
   - ÊØèÊù°Âª∫ËÆÆÈÉΩË¶ÅÊâæÂà∞ÂØπÂ∫îÁ´†ËäÇ
   - Â∞ÜÂª∫ËÆÆÂÖ∑‰ΩìÂÜÖÂÆπÊ∑±Â∫¶ÊîπÂÜôÂà∞ÊïôÊ°àÊ≠£Êñá
   - ‰∏çËÉΩÂè™ËøΩÂä†ÔºåË¶ÅËá™ÁÑ∂ËûçÂÖ•

2. **ÂÖ∑‰ΩìÂåñËûçÂêàÁ§∫‰æã**Ôºö
   - ÂéüÊïôÊ°àÔºö"Â≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîü"
   - Âª∫ËÆÆÔºö"Â¢ûÂä†Âõ†ÊûúÂÖ≥Á≥ªÂíåÁßëÂ≠¶Ë°®Ëææ"
   - ‚úÖ Ê≠£Á°ÆÔºö"Â≠¶ÁîüËÉΩÂ§üÈÄöËøáÂÆûÈ™åËßÇÂØüÔºåÂáÜÁ°ÆÊèèËø∞Áâ©‰ΩìÊåØÂä®‰∏éÂ£∞Èü≥‰∫ßÁîüÁöÑÂõ†ÊûúÂÖ≥Á≥ªÔºåÂπ∂ËÉΩÁî®ÁßëÂ≠¶ËØ≠Ë®ÄÊ∏ÖÊô∞Ë°®Ëææ"
   - ‚ùå ÈîôËØØÔºö"Â≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîü„ÄÇÂª∫ËÆÆÂ¢ûÂä†Âõ†ÊûúÂÖ≥Á≥ªÂíåÁßëÂ≠¶Ë°®Ëææ„ÄÇ"

3. **Ë¥®ÈáèË¶ÅÊ±Ç**Ôºö
   - ËûçÂêàÂêéÁöÑÊïôÊ°àÈïøÂ∫¶Â∫îÊØîÂéüÊïôÊ°àÂ¢ûÂä†30-50%
   - ÊØè‰∏™Êúâ‚úÖÂª∫ËÆÆÁöÑÁ´†ËäÇÈÉΩË¶ÅÊòéÊòæÊîπËøõ
   - ${acceptedCount}Êù°‚úÖÂª∫ËÆÆÁöÑÊ†∏ÂøÉÂÜÖÂÆπÈÉΩË¶Å‰ΩìÁé∞

4. **È™åËØÅÊ∏ÖÂçï**ÔºàÁîüÊàêÂâçÂøÖÈ°ªËá™Êü•ÔºâÔºö
   ‚òë ${acceptedCount}Êù°‚úÖÂª∫ËÆÆÊòØÂê¶ÈÉΩÂ∑≤ÈÄêÊù°ËûçÂÖ•Ôºü
   ‚òë ÊØèÊù°Âª∫ËÆÆÊòØÂê¶ÈÉΩÊâæÂà∞ÂØπÂ∫îÁ´†ËäÇÂπ∂Ê∑±Â∫¶ËûçÂÖ•Ôºü
   ‚òë ËûçÂêàÂêéÁöÑÂÜÖÂÆπÊòØÂê¶ÊØîÂéüÊïôÊ°àÊõ¥ËØ¶ÁªÜÔºü
   ‚òë ÊòØÂê¶Ëá™ÁÑ∂ËûçÂÖ•Ê≠£ÊñáËÄåÈùûÁÆÄÂçïËøΩÂä†Ôºü
   ‚òë ËØ≠Ë®ÄÊòØÂê¶ÊµÅÁïÖÔºåÊó†ÁîüÁ°¨ÊãºÊé•Ôºü

Áé∞Âú®ÂºÄÂßãÁîüÊàêÔºåÁõ¥Êé•ËæìÂá∫ÂÆåÊï¥ÁöÑ‰ºòÂåñÊïôÊ°àÔºà‰∏çË¶Å‰ªª‰ΩïÈ¢ùÂ§ñËØ¥ÊòéÔºâ„ÄÇ`;
                    
                    console.log('üîÑ Âº∫Âà∂ÈáçÊñ∞ÁîüÊàêÔºàÁ¨¨2Ê¨°ÔºâÔºåÁâπÂà´Âº∫Ë∞ÉÊú™ËûçÂêàÁöÑËßÇÁÇπ...');
                    updateGenerationUI(generationDiv, {
                        content: `
                            <i class="fas fa-spinner fa-spin"></i> Ê£ÄÊµãÂà∞ËûçÂêà‰∏çÂÆåÊï¥ÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàêÔºàÂº∫ÂåñËûçÂêàÔºâ...<br>
                            <span style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">ÁâπÂà´ÂÖ≥Ê≥® ${notFusedOpinions.length} ‰∏™Êú™ËûçÂêàËßÇÁÇπ</span>
                        `
                    });
                    
                    const forceRetryPlan = await callModeratorAPI(forceRetryPrompt);
                    
                    if (forceRetryPlan && forceRetryPlan.trim().length >= cleanPlan.trim().length * 0.9) {
                        console.log('‚úÖ Âº∫Âà∂ÈáçÊñ∞ÁîüÊàêÊàêÂäüÔºå‰ΩøÁî®Êñ∞ÁâàÊú¨');
                        cleanPlan = forceRetryPlan;
                        
                        // ÈáçÊñ∞È™åËØÅËûçÂêàÁéá
                        let newFusionScore = 0;
                        acceptedOpinionsForValidation.forEach(opinion => {
                            const keywords = opinion.content
                                .replace(/Âª∫ËÆÆ|Â∫îËØ•|ÂèØ‰ª•|ÈúÄË¶Å|Â¢ûÂä†|‰ºòÂåñ|ÊîπËøõ|ÊèêÂçá|Âä†Âº∫/g, '')
                                .match(/[\u4e00-\u9fa5]{2,}/g) || [];
                            const keywordsFound = keywords.filter(keyword => cleanPlan.includes(keyword));
                            if (keywordsFound.length > 0) {
                                newFusionScore++;
                            }
                        });
                        
                        const newFusionRate = acceptedCount > 0 ? (newFusionScore / acceptedCount * 100).toFixed(1) : '100';
                        console.log(`   Êñ∞ËûçÂêàÁéá: ${newFusionRate}%ÔºàÂéü${fusionRate}%Ôºâ`);
                        fusionQualityScore = newFusionScore;
                    } else {
                        console.warn('‚ö†Ô∏è Âº∫Âà∂ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•Ôºå‰ΩøÁî®Á¨¨‰∏ÄÊ¨°ÁîüÊàêÁöÑÁâàÊú¨');
                    }
                } else if (fusionQualityScore < savedOpinions.length * 0.5) {
                    console.warn('‚ö†Ô∏è ËûçÂêàÁéá‰Ωé‰∫é50%ÔºåÊ†áËÆ∞‰∏∫Ë¥®ÈáèË≠¶Âëä');
                    showMessage('‚ö†Ô∏è ËûçÂêàË¥®ÈáèÂèØËÉΩ‰∏çÂ§üÁêÜÊÉ≥ÔºåÂª∫ËÆÆÊü•ÁúãÊ†áÊ≥®ÁâàÊïôÊ°àÊ†∏ÂØπ', 'warning');
                } else {
                    console.log('‚úÖ ËûçÂêàË¥®ÈáèÊ£ÄÊµãÈÄöËøáÔºàËûçÂêàÁéá' + fusionRate + '%Ôºâ');
                }
                
                // ‰øùÂ≠òÁ∫ØÂáÄÁâàÊïôÊ°à
                window.finalTeachingPlanClean = cleanPlan;
                console.log('‚úÖ Á∫ØÂáÄÁâàÊïôÊ°àÁîüÊàêÊàêÂäüÔºåÂÜÖÂÆπÈïøÂ∫¶:', cleanPlanLength);
                
                // ===== Á¨¨‰∫åÊ≠•ÔºöÁîüÊàêÊ†áÊ≥®Áâà‰ºòÂåñÊïôÊ°à =====
                updateGenerationUI(generationDiv, {
                    content: `
                        <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÁîüÊàêÊ†áÊ≥®ÁâàÊïôÊ°àÔºà2/2Ôºâ...
                    `
                });
                
                // ===== üìù ÁîüÊàêÊ†áÊ≥®ÁâàÂâçÔºåÂàõÂª∫ËØ¶ÁªÜÁöÑËßÇÁÇπÊò†Â∞Ñ =====
                console.log('\n%cüìù ÂáÜÂ§áÁîüÊàêÊ†áÊ≥®ÁâàÊïôÊ°à...', 'color: #1890ff; font-weight: bold;');
                console.log(`   Â∞Ü‰∏∫ ${acceptedCount} ‰∏™ÈááÁ∫≥ËßÇÁÇπÊ∑ªÂä†ÂØπÊØîÊ†áÊ≥®`);
                
                // ‰ΩøÁî® savedOpinions ‰Ωú‰∏∫ÈááÁ∫≥ËßÇÁÇπÂàóË°®ÔºàÂ∑≤Âú®ÂâçÈù¢‰ªé allRoundRecords ÊèêÂèñÔºâ
                const acceptedOpinionsForValidation = savedOpinions;
                
                // ‰∏∫ÊØè‰∏™ÈááÁ∫≥ÁöÑËßÇÁÇπÂàõÂª∫ÁºñÂè∑ÔºåÊñπ‰æøËøΩË∏™
                const opinionsList = acceptedOpinionsForValidation.map((op, idx) => ({
                    ÁºñÂè∑: idx + 1,
                    ‰∏ìÂÆ∂: op.expert.name,
                    ‰∏ì‰∏ö: op.expert.specialty,
                    Á´†ËäÇ: op.section,
                    Âª∫ËÆÆ: op.content,
                    ÊäïÁ•®: `‚úÖ${op.votes.agree} ‚ùå${op.votes.disagree} (${((op.votes.agree/(op.votes.agree+op.votes.disagree))*100).toFixed(1)}%)`
                }));
                
                console.log('\nüìã Ê†áÊ≥®ÁâàÈúÄË¶ÅÂ§ÑÁêÜÁöÑËßÇÁÇπÊ∏ÖÂçï:');
                opinionsList.forEach(op => {
                    console.log(`   ${op.ÁºñÂè∑}. [${op.Á´†ËäÇ}] ${op.‰∏ìÂÆ∂}Ôºö${op.Âª∫ËÆÆ.substring(0, 40)}...`);
                });
                
                const annotatedVersionPrompt = `‰Ω†ÊòØÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÁé∞Âú®ÈúÄË¶ÅÂ∞ÜÂàùÂßãÊïôÊ°àÂíåÊïôÁ†îËÄÅÂ∏à‰ª¨ÁöÑÊîπËøõÂª∫ËÆÆËûçÂêàÔºåÁîüÊàê‰∏Ä‰ªΩ**Â∏¶ÂØπÊØîÊ†áÊ≥®**ÁöÑ‰ºòÂåñÊïôÊ°à„ÄÇ

„ÄêÂàùÂßãÊïôÊ°à„ÄëÔºö
${initialPlan}

„ÄêÊïôÁ†î‰∏ìÂÆ∂ÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩï„ÄëÔºà${window.allRoundRecords.length}ËΩÆËÆ®ËÆ∫Ôºå${totalOpinions}‰∏™ËßÇÁÇπÔºå${acceptedCount}‰∏™ÈááÁ∫≥ÔºâÔºö

ËØ¥ÊòéÔºöÂè™ÈúÄË¶Å‰∏∫‚úÖÊ†áËÆ∞ÔºàÊäïÁ•®ÈÄöËøáÔºâÁöÑ${acceptedCount}‰∏™Âª∫ËÆÆÊ∑ªÂä†ÂØπÊØîÊ†áÊ≥®„ÄÇ

${opinionsRecordForAI}

„ÄêÈúÄË¶ÅÊ†áÊ≥®ÁöÑÈááÁ∫≥Âª∫ËÆÆ„ÄëÔºàÂÖ±${acceptedCount}Êù°ÔºâÔºö

${opinionsList.map(op => `
‚îÅ‚îÅ‚îÅ ËßÇÁÇπ ${op.ÁºñÂè∑} ‚îÅ‚îÅ‚îÅ
‰∏ìÂÆ∂Ôºö${op.‰∏ìÂÆ∂}Ôºà${op.‰∏ì‰∏ö}Ôºâ
Á´†ËäÇÔºö„Äê${op.Á´†ËäÇ}„Äë
ÊäïÁ•®Ôºö${op.ÊäïÁ•®}
Âª∫ËÆÆÂÜÖÂÆπÔºö${op.Âª∫ËÆÆ}
‚ö†Ô∏è Ê†áÊ≥®Ë¶ÅÊ±ÇÔºöÂú®„Äê${op.Á´†ËäÇ}„ÄëÁ´†ËäÇ‰∏≠ÔºåÂøÖÈ°ªÁî®„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÊ†ºÂºèÊ†áÊ≥®Ê≠§Âª∫ËÆÆÁöÑËûçÂêàÔºÅ
`).join('\n')}

„ÄêËûçÂêàÂíåÂØπÊØîÊ†áÊ≥®Ë¶ÅÊ±Ç - ‚ö†Ô∏èÂøÖÈ°ª100%‰∏•Ê†ºÊâßË°å„ÄëÔºö

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî• Ê†∏ÂøÉË¶ÅÊ±ÇÔºöÊØè‰∏™‚úÖÈááÁ∫≥ÁöÑËßÇÁÇπÂøÖÈ°ªÊúâÊòéÁ°ÆÁöÑ„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÂØπÊØîÊ†áÊ≥®ÔºÅ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Á¨¨‰∏ÄÊ≠•ÔºöÊ∑±Â∫¶ËûçÂêàÊîπËøõÂÜÖÂÆπ**
1. ‰øùÁïôÂàùÂßãÊïôÊ°àÁöÑÂÆåÊï¥ÁªìÊûÑÂíåÊ†ºÂºè
2. Â∞ÜÊØèÊù°Âª∫ËÆÆÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ**Ê∑±Â∫¶ÊîπÂÜôËûçÂÖ•**Âà∞ÊïôÊ°àÊ≠£Êñá‰∏≠
3. ËûçÂêàË¶ÅËá™ÁÑ∂ÊµÅÁïÖÔºå‰∏çËÉΩÁîüÁ°¨ÊãºÊé•
4. ËûçÂêàÂêéÁöÑÊïôÊ°àË¶ÅÊòéÊòæ‰ºò‰∫éÂàùÂßãÊïôÊ°àÔºàÂÜÖÂÆπÊõ¥‰∏∞ÂØå30-50%Ôºâ

**Á¨¨‰∫åÊ≠•ÔºöÊ∏ÖÊô∞ÁöÑÂØπÊØîÊ†áÊ≥®Ôºà‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ÊúÄÈáçË¶ÅÔºÅÔºâ**

üéØ **Âº∫Âà∂Ë¶ÅÊ±Ç**ÔºöÊâÄÊúâ${acceptedCount}‰∏™‚úÖÈááÁ∫≥ËßÇÁÇπÈÉΩÂøÖÈ°ªÊúâÂØπÊØîÊ†áÊ≥®ÔºÅ
‚ö†Ô∏è **Ê£ÄÊü•Ê†áÂáÜ**ÔºöÁîüÊàêÂÆåÊàêÂêéÔºåÂ∫îËØ•Êúâ${acceptedCount}‰∏™‚ú®Ê†áËÆ∞ÔºàÊØè‰∏™ËßÇÁÇπ‰∏Ä‰∏™Ôºâ

üîç **Ê†áÊ≥®ÊñπÂºè**ÔºöÊØèÂ§Ñ‰ºòÂåñÈÉΩË¶ÅÁî®**ÂØπÊØîÊ†áÊ≥®**ÔºåËÆ©ËØªËÄÖÊ∏ÖÊ•öÁúãÂà∞"ÂéüÊù•ÊòØ‰ªÄ‰πà"„ÄÅ"Áé∞Âú®ÊîπÊàê‰ªÄ‰πà"„ÄÅ"ÊòØË∞ÅÂª∫ËÆÆÁöÑ"

**Ê†áÂáÜÊ†áÊ≥®Ê†ºÂºè**ÔºàÂøÖÈ°ª‰ΩøÁî®Ëøô‰∏™Ê†ºÂºèÔºâÔºö
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
„ÄêÂéüÊñá„ÄëÔºö[ÂàùÂßãÊïôÊ°àÁöÑÂéüÂÜÖÂÆπ]
„Äê‰ºòÂåñ„ÄëÔºö[ÊîπËøõÂêéÁöÑÂÜÖÂÆπ]Ôºà‚ú® ${‰∏ìÂÆ∂Âêç}Âª∫ËÆÆÔºâ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**ÂÆåÊï¥Ê†áÊ≥®Á§∫‰æã**Ôºö
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÂàùÂßãÊïôÊ°àÂÜÖÂÆπÔºö
„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë
1. Â≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîü
2. ÂüπÂÖªÁßëÂ≠¶Êé¢Á©∂ËÉΩÂäõ

Âª∫ËÆÆ1ÔºöÊô∫Ë∞±Ê∏ÖË®ÄÂª∫ËÆÆÂ¢ûÂä†Âõ†ÊûúÂÖ≥Á≥ªÂíåÁßëÂ≠¶Ë°®ËææËÉΩÂäõÂüπÂÖª
Âª∫ËÆÆ2ÔºöKimiÂª∫ËÆÆÂ¢ûÂä†Â∞èÁªÑÂêà‰ΩúÁéØËäÇ
Âª∫ËÆÆ3ÔºöË±ÜÂåÖÂª∫ËÆÆÂ¢ûÂä†ÂàõÊñ∞ÂÆûÈ™åËÆæËÆ°

‚úÖ **Ê≠£Á°ÆÁöÑÂØπÊØîÊ†áÊ≥®Áâà**Ôºö

„ÄêÊïôÂ≠¶ÁõÆÊ†á„Äë

1. „ÄêÂéüÊñá„ÄëÔºöÂ≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîü
   „Äê‰ºòÂåñ„ÄëÔºöÂ≠¶ÁîüËÉΩÂ§üÈÄöËøáÂÆûÈ™åËßÇÂØüÔºåÂáÜÁ°ÆÊèèËø∞Áâ©‰ΩìÊåØÂä®‰∏éÂ£∞Èü≥‰∫ßÁîüÁöÑÂõ†ÊûúÂÖ≥Á≥ªÔºåÂπ∂ËÉΩÁî®ÁßëÂ≠¶ËØ≠Ë®ÄÊ∏ÖÊô∞Ë°®ËææËá™Â∑±ÁöÑÂèëÁé∞Ôºà‚ú® Êô∫Ë∞±Ê∏ÖË®ÄÂª∫ËÆÆ‰ºòÂåñÔºâ

2. „ÄêÂéüÊñá„ÄëÔºöÂüπÂÖªÁßëÂ≠¶Êé¢Á©∂ËÉΩÂäõ
   „Äê‰ºòÂåñ„ÄëÔºöÂüπÂÖªÁßëÂ≠¶Êé¢Á©∂ËÉΩÂäõÂíåÂ∞èÁªÑÂêà‰ΩúËÉΩÂäõÔºåËÆ©Â≠¶ÁîüÂú®Âõ¢ÈòüÂçè‰Ωú‰∏≠ÂÖ±ÂêåÂÆåÊàêÂÆûÈ™åËÆæËÆ°ÂíåÁªìÊûúÂàÜÊûêÔºà‚ú® KimiÂª∫ËÆÆ‰ºòÂåñÔºâ

3. „ÄêÊñ∞Â¢û„ÄëÔºöÈºìÂä±Â≠¶ÁîüËÆæËÆ°ÂàõÊñ∞ÂÆûÈ™åÊñπÊ°àÔºåÂüπÂÖªÂàõÊñ∞ÊÄùÁª¥ÂíåÂÆûË∑µÂä®ÊâãËÉΩÂäõÔºà‚ú® Ë±ÜÂåÖÂª∫ËÆÆÊñ∞Â¢ûÔºâ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**ÂØπÊØîÊ†áÊ≥®ÁöÑ‰∏âÁßçÁ±ªÂûã**Ôºö
1. **ÂÜÖÂÆπ‰ºòÂåñ**ÔºöÁî®„ÄêÂéüÊñá„ÄëÂíå„Äê‰ºòÂåñ„ÄëÂØπÊØî
   ‰æãÔºö„ÄêÂéüÊñá„ÄëÔºöÁÆÄÂçïÊèèËø∞
        „Äê‰ºòÂåñ„ÄëÔºöËØ¶ÁªÜÂÖ∑‰ΩìÁöÑÊèèËø∞Ôºà‚ú® ‰∏ìÂÆ∂ÂêçÔºâ

2. **ÂÜÖÂÆπÊñ∞Â¢û**ÔºöÁî®„ÄêÊñ∞Â¢û„ÄëÊ†áËÆ∞
   ‰æãÔºö„ÄêÊñ∞Â¢û„ÄëÔºöÂÖ®Êñ∞ÁöÑÊïôÂ≠¶ÁéØËäÇÂÜÖÂÆπÔºà‚ú® ‰∏ìÂÆ∂ÂêçÂª∫ËÆÆÊñ∞Â¢ûÔºâ

3. **ÁªìÊûÑË∞ÉÊï¥**ÔºöÁî®„ÄêË∞ÉÊï¥„ÄëÊ†áËÆ∞
   ‰æãÔºö„ÄêË∞ÉÊï¥„ÄëÔºöÂ∞ÜXXÁéØËäÇ‰ªé5ÂàÜÈíüË∞ÉÊï¥‰∏∫8ÂàÜÈíüÔºà‚ú® ‰∏ìÂÆ∂ÂêçÂª∫ËÆÆÔºâ

**Ê†áÊ≥®ËßÑËåÉ**Ôºö
‚úì ÊØèÂ§ÑÊîπËøõÂøÖÈ°ªÊòéÁ°ÆÊ†áÂá∫"Êîπ‰∫Ü‰ªÄ‰πà"
‚úì ‰ΩøÁî®„ÄêÂéüÊñá„Äë„Äê‰ºòÂåñ„Äë„ÄêÊñ∞Â¢û„Äë„ÄêË∞ÉÊï¥„ÄëÁ≠âÂÖ≥ÈîÆËØç
‚úì ÊØè‰∏™Ê†áÊ≥®ÈÉΩË¶ÅÂÜôÊòé‰∏ìÂÆ∂ÂßìÂêç
‚úì Ê†áÊ≥®Ë¶ÅÈÜíÁõÆÔºå‰ΩøÁî®‚ú®Á¨¶Âè∑
‚úì ÊâÄÊúâ${acceptedCount}Êù°‚úÖÂª∫ËÆÆÈÉΩÂøÖÈ°ªÊúâÊ∏ÖÊô∞ÁöÑÂØπÊØîÊ†áÊ≥®

**È™åËØÅÊ∏ÖÂçï**Ôºö
‚òë ÊòØÂê¶ÊâÄÊúâ${acceptedCount}Êù°Âª∫ËÆÆÈÉΩÂ∑≤ËûçÂÖ•Ôºü
‚òë ÊòØÂê¶ÊØèÊù°Âª∫ËÆÆÈÉΩÊúâ„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÁöÑÂØπÊØîÊ†áÊ≥®Ôºü
‚òë ÊòØÂê¶ÊØè‰∏™‚ú®Ê†áÊ≥®ÈÉΩÊòéÁ°ÆÂÜôÂá∫‰∏ìÂÆ∂ÂßìÂêçÔºü
‚òë Ê†áÊ≥®ÊòØÂê¶Ê∏ÖÊô∞ÈÜíÁõÆÔºåÂÆπÊòìËØÜÂà´Ôºü
‚òë ËûçÂêàÂêéÁöÑÂÜÖÂÆπÊòØÂê¶ÊòéÊòæ‰ºò‰∫éÂàùÂßãÊïôÊ°àÔºü

‚ö†Ô∏è**ÁâπÂà´Âº∫Ë∞É**Ôºö
- ÂøÖÈ°ªÁî®„ÄêÂéüÊñá„Äë„Äê‰ºòÂåñ„ÄëÁ≠âÊ†áÁ≠æÊòéÁ°ÆÂØπÊØî
- ‰∏çËÉΩÂè™Âú®ÊîπËøõÂ§ÑÁÆÄÂçïÊ†áÊ≥®‚ú®ÔºåÂøÖÈ°ªËØ¥Êòé"Êîπ‰∫Ü‰ªÄ‰πà"
- ËÆ©ËØªËÄÖËÉΩÊ∏ÖÊ•öÁúãÂà∞ÊØèÂ§Ñ‰ºòÂåñÁöÑÂâçÂêéÂØπÊØî

„Äêüî• Ê†áÊ≥®ÁâàÁîüÊàêËá™Êü•Ê∏ÖÂçï„ÄëÔºö

${opinionsList.map((op, idx) => `
‚òê ËßÇÁÇπ${idx+1}Ôºö${op.‰∏ìÂÆ∂}Ôºà${op.Á´†ËäÇ}Ôºâ
   Âª∫ËÆÆÔºö"${op.Âª∫ËÆÆ}"
   
   ‚úì ÊàëÂú®„Äê${op.Á´†ËäÇ}„ÄëÁ´†ËäÇ‰∏≠ÊâæÂà∞‰∫ÜÂØπÂ∫îÁöÑÂéüÊñá‰∫ÜÂêóÔºü
   ‚úì ÊàëÁî®„ÄêÂéüÊñá„ÄëÊ†áÁ≠æÊ†áÂá∫‰∫ÜÂéüÊù•ÁöÑÂÜÖÂÆπÂêóÔºü
   ‚úì ÊàëÁî®„Äê‰ºòÂåñ„ÄëÊ†áÁ≠æÊ†áÂá∫‰∫ÜÊîπËøõÂêéÁöÑÂÜÖÂÆπÂêóÔºü
   ‚úì ÊàëÊ†áÊ≥®‰∫ÜÔºà‚ú® ${op.‰∏ìÂÆ∂}Âª∫ËÆÆÔºâÂêóÔºü
   ‚úì ÂØπÊØîÊòØÂê¶Ê∏ÖÊô∞ÔºåËØªËÄÖËÉΩÁúãÊáÇÂâçÂêéÂ∑ÆÂºÇÂêóÔºü
`).join('\n')}

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‰ª•‰∏ä${acceptedCount}È°πÂøÖÈ°ªÂÖ®ÈÉ®ÂÅöÂà∞ÔºåÁº∫‰∏Ä‰∏çÂèØÔºÅ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Ê†áÊ≥®ÁâàÂÖ≥ÈîÆË¶ÅÊ±ÇÔºö
1. ÊØè‰∏™‚úÖËßÇÁÇπÂøÖÈ°ªÊúâ„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÂØπÊØî
2. ÊØè‰∏™‚ú®Ê†áËÆ∞ÂøÖÈ°ªÂÜôÊòé‰∏ìÂÆ∂ÂßìÂêç
3. ÂØπÊØîË¶ÅÊ∏ÖÊô∞ÔºåÂéüÊñáÂíå‰ºòÂåñË¶ÅÂàÜÂà´Ê†áÂá∫
4. Â¶ÇÊûúÊüê‰∏™Âª∫ËÆÆÊòØÊñ∞Â¢ûÂÜÖÂÆπÔºåÁî®„ÄêÊñ∞Â¢û„ÄëÊ†áÁ≠æ
5. ÊÄªÂÖ±Â∫îËØ•Êúâ${acceptedCount}‰∏™‚ú®Ê†áËÆ∞ÔºàÊØè‰∏™‚úÖËßÇÁÇπ‰∏Ä‰∏™Ôºâ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ÂºÄÂßãËæìÂá∫Â∏¶ÂÆåÊï¥ÂØπÊØîÊ†áÊ≥®ÁöÑ‰ºòÂåñÊïôÊ°àÔºö`;

                console.log('üì§ Ë∞ÉÁî®‰∏ªÊåÅ‰∫∫APIÁîüÊàêÊ†áÊ≥®ÁâàÊïôÊ°à...');
                const annotatedPlan = await callModeratorAPI(annotatedVersionPrompt);
                
                if (!annotatedPlan || annotatedPlan.trim().length < 100) {
                    throw new Error('Ê†áÊ≥®ÁâàÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
                }
                
                // ===== üîç È™åËØÅÊ†áÊ≥®Êï∞ÈáèÂíåÊØè‰∏™ËßÇÁÇπÊòØÂê¶Ë¢´Ê†áÊ≥® =====
                const sparkleCount = (annotatedPlan.match(/‚ú®/g) || []).length;
                const originalTextCount = (annotatedPlan.match(/„ÄêÂéüÊñá„Äë/g) || []).length;
                const optimizedTextCount = (annotatedPlan.match(/„Äê‰ºòÂåñ„Äë/g) || []).length;
                const newAddedCount = (annotatedPlan.match(/„ÄêÊñ∞Â¢û„Äë/g) || []).length;
                const expectedCount = savedOpinions.length;
                
                console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #1890ff; font-weight: bold;');
                console.log('%cüìä Ê†áÊ≥®ÁâàÊïôÊ°àÈ™åËØÅÊä•Âëä', 'color: #1890ff; font-size: 14px; font-weight: bold;');
                console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #1890ff; font-weight: bold;');
                console.log(`   ÂÜÖÂÆπÈïøÂ∫¶: ${annotatedPlan.trim().length} Â≠óÁ¨¶`);
                console.log(`   ‚ú® Ê†áËÆ∞Êï∞: ${sparkleCount} ‰∏™ÔºàÈ¢ÑÊúü ${expectedCount} ‰∏™Ôºâ`);
                console.log(`   „ÄêÂéüÊñá„ÄëÊ†áÁ≠æ: ${originalTextCount} ‰∏™`);
                console.log(`   „Äê‰ºòÂåñ„ÄëÊ†áÁ≠æ: ${optimizedTextCount} ‰∏™`);
                console.log(`   „ÄêÊñ∞Â¢û„ÄëÊ†áÁ≠æ: ${newAddedCount} ‰∏™`);
                console.log(`   ÂØπÊØîÊ†áÊ≥®: ${originalTextCount + newAddedCount} ‰∏™ÔºàÈ¢ÑÊúü‚â•${expectedCount}‰∏™Ôºâ`);
                console.log(`   Ê†áÊ≥®ÂÆåÊï¥ÊÄß: ${sparkleCount >= expectedCount ? '‚úÖ ÂÆåÊï¥' : '‚ö†Ô∏è ‰∏çÂÆåÊï¥'}`);
                
                // Ê£ÄÊü•ÊØè‰∏™‰∏ìÂÆ∂ÁöÑËßÇÁÇπÊòØÂê¶Ë¢´Ê†áÊ≥®
                console.log('\nüìã ÈÄê‰∏™È™åËØÅÊØè‰Ωç‰∏ìÂÆ∂ÁöÑËßÇÁÇπÊ†áÊ≥®ÊÉÖÂÜµÔºö');
                const annotationCheckResults = [];
                savedOpinions.forEach((opinion, index) => {
                    const expertName = opinion.expert.name;
                    
                    // Â§öÁßçÊñπÂºèÊ£ÄÊü•Ê†áÊ≥®
                    const hasSparkle = annotatedPlan.includes(`‚ú® ${expertName}`) || 
                                      annotatedPlan.includes(`‚ú®${expertName}`) ||
                                      annotatedPlan.includes(expertName + 'Âª∫ËÆÆ');
                    
                    const hasComparison = annotatedPlan.includes(`„ÄêÂéüÊñá„Äë`) || 
                                         annotatedPlan.includes(`„Äê‰ºòÂåñ„Äë`) || 
                                         annotatedPlan.includes(`„ÄêÊñ∞Â¢û„Äë`);
                    
                    const isAnnotated = hasSparkle || hasComparison;
                    
                    const status = isAnnotated ? '‚úÖ' : '‚ùå';
                    console.log(`   ${status} ËßÇÁÇπ${index+1}: ${expertName}Ôºà${opinion.section}Ôºâ`);
                    console.log(`      ÂÜÖÂÆπÔºö${opinion.content.substring(0, 50)}...`);
                    console.log(`      ‚ú®Ê†áËÆ∞Ôºö${hasSparkle ? '‚úÖ Êúâ' : '‚ùå Êó†'}`);
                    console.log(`      ÂØπÊØîÊ†áÁ≠æÔºö${hasComparison ? '‚úÖ Êúâ' : '‚ùå Êó†'}`);
                    console.log(`      ÁªºÂêàÁä∂ÊÄÅÔºö${isAnnotated ? '‚úÖ Â∑≤Ê†áÊ≥®' : '‚ö†Ô∏è Êú™ÊâæÂà∞ÊòéÁ°ÆÊ†áÊ≥®'}`);
                    
                    annotationCheckResults.push({
                        expert: expertName,
                        section: opinion.section,
                        content: opinion.content,
                        isAnnotated: isAnnotated,
                        hasSparkle: hasSparkle,
                        hasComparison: hasComparison
                    });
                });
                
                const annotatedCount = annotationCheckResults.filter(r => r.isAnnotated).length;
                const missingCount = annotationCheckResults.filter(r => !r.isAnnotated).length;
                const missingAnnotations = annotationCheckResults.filter(r => !r.isAnnotated);
                
                console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log(`üìä Ê†áÊ≥®È™åËØÅÁªìÊûúÔºö${annotatedCount}/${expectedCount} ‰∏™ËßÇÁÇπÂ∑≤Ê†áÊ≥®`);
                if (missingCount > 0) {
                    console.warn(`\n%c‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ£ÄÊµãÂà∞ ${missingCount} ‰∏™ËßÇÁÇπÂèØËÉΩÊú™Ë¢´ÊòéÁ°ÆÊ†áÊ≥®ÔºÅ`, 'color: #ff4d4f; font-weight: bold;');
                    console.warn('%c   Êú™Ê†áÊ≥®ÁöÑËßÇÁÇπÂàóË°®:', 'color: #faad14;');
                    missingAnnotations.forEach((item, i) => {
                        console.warn(`      ${i+1}. ${item.expert}Ôºà${item.section}Ôºâ: ${item.content.substring(0, 40)}...`);
                    });
                    console.warn('\n   üí° Âª∫ËÆÆÔºöÊü•ÁúãÊ†áÊ≥®ÁâàÊïôÊ°àÔºåÊêúÁ¥¢‰∏ìÂÆ∂ÂßìÂêçÁ°ÆËÆ§ÊòØÂê¶Ê†áÊ≥®');
                    console.warn('   üìå ÊàñËÄÖÁÇπÂáª"ÈáçÊñ∞ÁîüÊàê"ÊåâÈíÆÔºåË¶ÅÊ±ÇAIÈáçÊñ∞Ê†áÊ≥®');
                    
                    // Â¶ÇÊûúÊ†áÊ≥®Áº∫Â§±ËæÉÂ§öÔºåËá™Âä®Ê∑ªÂä†Ë°•ÂÖÖÊ†áÊ≥®
                    if (missingCount > expectedCount * 0.3) {
                        console.warn(`\n%cüî• Ê†áÊ≥®Áº∫Â§±Ë∂ÖËøá30%ÔºåËá™Âä®Ê∑ªÂä†Ë°•ÂÖÖÊ†áÊ≥®ËØ¥Êòé...`, 'color: #ff4d4f; font-weight: bold;');
                        
                        letË°•ÂÖÖÊ†áÊ≥® = '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                        Ë°•ÂÖÖÊ†áÊ≥® += 'üìå ‰ª•‰∏ãËßÇÁÇπÂú®AIËûçÂêàÊó∂ÂèØËÉΩÊú™ÊòéÁ°ÆÊ†áÊ≥®ÔºåÁâπÊ≠§Ë°•ÂÖÖËØ¥ÊòéÔºö\n';
                        Ë°•ÂÖÖÊ†áÊ≥® += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
                        
                        missingAnnotations.forEach((item, i) => {
                            Ë°•ÂÖÖÊ†áÊ≥® += `${i+1}. „Äê${item.section}„ÄëÁ´†ËäÇÁöÑÊîπËøõ\n`;
                            Ë°•ÂÖÖÊ†áÊ≥® += `   ‰∏ìÂÆ∂Ôºö${item.expert}\n`;
                            Ë°•ÂÖÖÊ†áÊ≥® += `   Âª∫ËÆÆÔºö${item.content}\n`;
                            Ë°•ÂÖÖÊ†áÊ≥® += `   ‚ú® Ê≠§Âª∫ËÆÆÂ∑≤ËûçÂÖ•‰∏äËø∞„Äê${item.section}„ÄëÁ´†ËäÇÔºåËØ∑Êü•ÁúãËØ•Á´†ËäÇÂÜÖÂÆπ\n\n`;
                        });
                        
                        Ë°•ÂÖÖÊ†áÊ≥® += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                        Ë°•ÂÖÖÊ†áÊ≥® += 'üí° ËØ¥ÊòéÔºö‰ª•‰∏äËßÇÁÇπÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÂ∑≤ËûçÂÖ•ÂØπÂ∫îÁ´†ËäÇÔºå‰ΩÜAIÊú™ÊòéÁ°ÆÊ†áÊ≥®ÂØπÊØî„ÄÇ\n';
                        Ë°•ÂÖÖÊ†áÊ≥® += 'Âª∫ËÆÆÔºöÂØπÁÖßÁ∫ØÂáÄÁâàÊïôÊ°àÂíåÂàùÂßãÊïôÊ°àÔºåÊü•ÁúãÂÖ∑‰ΩìÊîπËøõÂÜÖÂÆπ„ÄÇ\n';
                        Ë°•ÂÖÖÊ†áÊ≥® += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
                        
                        annotatedPlan += Ë°•ÂÖÖÊ†áÊ≥®;
                        console.log('‚úÖ Â∑≤Ëá™Âä®Ê∑ªÂä†Ë°•ÂÖÖÊ†áÊ≥®ËØ¥Êòé');
                    }
                } else {
                    console.log('%c‚úÖ ÊâÄÊúâËßÇÁÇπÈÉΩÂ∑≤ÊâæÂà∞ÂØπÂ∫îÊ†áÊ≥®ÔºÅ', 'color: #52c41a; font-weight: bold;');
                }
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
                
                // ‰øùÂ≠òÊ†áÊ≥®ÁâàÊïôÊ°à
                window.finalTeachingPlanAnnotated = annotatedPlan;
                // ‰∏ªÊïôÊ°à‰ΩøÁî®Á∫ØÂáÄÁâà
                window.finalTeachingPlan = cleanPlan;
                console.log('‚úÖ Ê†áÊ≥®ÁâàÊïôÊ°àÁîüÊàêÊàêÂäüÔºåÂÜÖÂÆπÈïøÂ∫¶:', annotatedPlan.trim().length);
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                const verificationHTML = sparkleCount >= expectedCount 
                    ? `‚úÖ Ê†áÊ≥®ÂÆåÊï¥Ôºà${sparkleCount}/${expectedCount}Ôºâ` 
                    : `‚ö†Ô∏è Ê†áÊ≥®‰∏çÂÆåÊï¥Ôºà${sparkleCount}/${expectedCount}Ôºâ`;
                
                updateGenerationUI(generationDiv, {
                    status: {
                        text: 'Â∑≤ÂÆåÊàê',
                        className: 'agent-status completed'
                    },
                    content: `
                    <div style="color: #52c41a; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i> ‰∏§‰ªΩÊñ∞ÊïôÊ°àÂ∑≤ÁîüÊàêÔºÅËûçÂêà‰∫ÜÂàùÂßãÊïôÊ°àÂíå ${savedOpinions.length} ‰∏™‰∏ìÂÆ∂ÊîπËøõÂª∫ËÆÆ
                    </div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.8;">
                        üìÑ <strong>Á∫ØÂáÄÁâà</strong>ÔºöÂÆåÊï¥ÁöÑ‰ºòÂåñÊïôÊ°àÔºà${cleanPlanLength}Â≠óÁ¨¶ÔºåÂ¢ûÈïøÁéáÔºö${((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(1)}%Ôºâ<br>
                        üìù <strong>Ê†áÊ≥®Áâà</strong>ÔºöÊ†áÊòéÊØèÂ§Ñ‰ºòÂåñÊù•Ëá™Âì™‰ΩçÊïôÁ†îËÄÅÂ∏àÔºà${annotatedPlan.trim().length}Â≠óÁ¨¶Ôºâ<br>
                        üîç <strong>ËûçÂêàË¥®Èáè</strong>ÔºöÊ£ÄÊµãÂà∞ËûçÂêà ${fusionQualityScore}/${savedOpinions.length} Êù°Âª∫ËÆÆÔºà${fusionRate}%Ôºâ<br>
                        üíæ <strong>‰ΩøÁî®ËÆ∞ÂΩï</strong>ÔºöÂ∑≤‰ΩøÁî®Êú¨Âú∞‰øùÂ≠òÁöÑËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ÔºàÂåÖÂê´ÊäïÁ•®ËØ¶ÊÉÖÔºâ<br>
                        ${sparkleCount >= expectedCount ? 
                            `<span style="color: #52c41a;">‚ú® Ê†áÊ≥®È™åËØÅÔºö${verificationHTML}</span>` : 
                            `<span style="color: #faad14;">‚ö†Ô∏è Ê†áÊ≥®È™åËØÅÔºö${verificationHTML} - ÂèØËÉΩÊúâÂª∫ËÆÆÊú™Ê†áÊ≥®</span>`
                        }
                    </div>
                    ${(sparkleCount < expectedCount || fusionQualityScore < savedOpinions.length * 0.7) ? `
                        <div style="background: rgba(250, 173, 20, 0.1); border: 1px solid rgba(250, 173, 20, 0.3); border-radius: 8px; padding: 12px; margin-top: 15px;">
                            <strong style="color: #faad14;">‚ö†Ô∏è ËûçÂêàË¥®ÈáèÊèêÁ§∫Ôºö</strong><br>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">
                                ÈÉ®ÂàÜ‰∏ìÂÆ∂Âª∫ËÆÆÂèØËÉΩÊú™ÂÆåÂÖ®ËûçÂêàÊàñÊ†áÊ≥®„ÄÇÂª∫ËÆÆÔºö<br>
                                ‚Ä¢ Êü•ÁúãÊ†áÊ≥®ÁâàÊïôÊ°àÔºåÊ†∏ÂØπ‚ú®Ê†áËÆ∞Êï∞Èáè<br>
                                ‚Ä¢ ‰∏ãËΩΩËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂ÔºåÂØπÁÖß‰∏ìÂÆ∂Âª∫ËÆÆ<br>
                                ‚Ä¢ ÂøÖË¶ÅÊó∂ÂèØÈáçÊñ∞ÂºÄÂßãÂàÜÊûê
                            </span>
                        </div>
                    ` : ''}
                `
                });
                
                // ===== üéØ ËûçÂêàË¥®ÈáèÊúÄÁªàÈ™åËØÅÔºàÁîüÊàêÂÆåÊàêÂêéÔºâ=====
                console.log('\n%cüéØ ËûçÂêàË¥®ÈáèÊúÄÁªàÈ™åËØÅ', 'color: #eb2f96; font-weight: bold; font-size: 14px;');
                let finalFusionScore = 0;
                const detailedCheck = [];
                
                savedOpinions.forEach((opinion, idx) => {
                    const expertName = opinion.expert.name;
                    const opinionKeywords = opinion.content
                        .replace(/Âª∫ËÆÆ|Â∫îËØ•|ÂèØ‰ª•|ÈúÄË¶Å|Â¢ûÂä†|‰ºòÂåñ|ÊîπËøõ|ÊèêÂçá|Âä†Âº∫|Â∫îÂΩì|ÂøÖÈ°ª/g, '')
                        .match(/[\u4e00-\u9fa5]{3,}/g) || [];
                    
                    const foundKeywords = opinionKeywords.filter(kw => cleanPlan.includes(kw));
                    const matchRate = opinionKeywords.length > 0 ? (foundKeywords.length / opinionKeywords.length) : 0;
                    
                    const isFused = matchRate >= 0.25; // 25%‰ª•‰∏äÂÖ≥ÈîÆËØçÂåπÈÖçÂç≥ËÆ§‰∏∫Â∑≤ËûçÂêà
                    if (isFused) finalFusionScore++;
                    
                    detailedCheck.push({
                        ÁºñÂè∑: idx + 1,
                        ‰∏ìÂÆ∂: expertName,
                        Á´†ËäÇ: opinion.section,
                        ÂÜÖÂÆπ: opinion.content.substring(0, 40) + '...',
                        ÂåπÈÖçÁéá: (matchRate * 100).toFixed(1) + '%',
                        Áä∂ÊÄÅ: isFused ? '‚úÖ Â∑≤ËûçÂêà' : '‚ùå ÂèØËÉΩÊú™ËûçÂêà'
                    });
                    
                    console.log(`   ${isFused ? '‚úÖ' : '‚ùå'} ËßÇÁÇπ${idx+1}: ${expertName}ÔºàÂåπÈÖçÁéá${(matchRate*100).toFixed(1)}%Ôºâ`);
                });
                
                const finalFusionRate = (finalFusionScore / savedOpinions.length * 100).toFixed(1);
                console.log(`\nüìä ÊúÄÁªàËûçÂêàÁéá: ${finalFusionRate}% (${finalFusionScore}/${savedOpinions.length})`);
                
                if (finalFusionScore < savedOpinions.length) {
                    console.warn(`\n%c‚ö†Ô∏è Ë≠¶ÂëäÔºöÂèØËÉΩÊúâ ${savedOpinions.length - finalFusionScore} ‰∏™ËßÇÁÇπÊú™ÂÖÖÂàÜËûçÂêà`, 'color: #faad14; font-weight: bold;');
                }
                
                // ‰øùÂ≠òËûçÂêàË¥®ÈáèÊï∞ÊçÆ‰æõÂêéÁª≠ÊòæÁ§∫
                window.fusionQualityReport = {
                    totalOpinions: savedOpinions.length,
                    fusedCount: finalFusionScore,
                    fusionRate: finalFusionRate,
                    detailedCheck: detailedCheck,
                    cleanPlanLength: cleanPlanLength,
                    initialPlanLength: initialPlanLength,
                    growthRate: ((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(1)
                };
                
                // ===== ÊòæÁ§∫Á∫ØÂáÄÁâàÊïôÊ°à =====
                const cleanPlanDiv = document.createElement('div');
                cleanPlanDiv.className = 'card';
                cleanPlanDiv.id = 'fusedTeachingPlanClean';
                cleanPlanDiv.style.background = 'linear-gradient(135deg, rgba(82, 196, 26, 0.15), rgba(82, 196, 26, 0.05))';
                cleanPlanDiv.style.border = '2px solid rgba(82, 196, 26, 0.3)';
                cleanPlanDiv.innerHTML = `
                    <h3 style="color: #52c41a; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-file-alt"></i> 
                        ‰ºòÂåñÊïôÊ°àÔºàÁ∫ØÂáÄÁâàÔºâ
                        <span style="font-size: 0.85rem; color: rgba(255,255,255,0.7); font-weight: normal;">
                            (ËûçÂêà‰∫Ü ${savedOpinions.length} ‰∏™‰∏ìÂÆ∂Âª∫ËÆÆ)
                        </span>
                    </h3>
                    <div style="background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); border-radius: 8px; padding: 20px; margin: 15px 0;">
                        <strong style="color: #52c41a; font-size: 1.1rem; display: block; margin-bottom: 12px;">
                            <i class="fas fa-check-circle"></i> ËûçÂêàË¥®ÈáèÊä•Âëä
                        </strong>
                        <div style="color: rgba(255,255,255,0.85); font-size: 0.95rem; line-height: 2;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #52c41a;">üìä ËûçÂêàÁªüËÆ°Ôºö</strong>
                            </div>
                            <div style="padding-left: 20px; margin-bottom: 15px;">
                                ‚úì ÈááÁ∫≥Âª∫ËÆÆÊï∞Ôºö<strong style="color: #1890ff;">${savedOpinions.length}</strong> ‰∏™<br>
                                ‚úì Ê£ÄÊµãÂà∞ËûçÂêàÔºö<strong style="color: #52c41a;">${finalFusionScore}</strong> ‰∏™<br>
                                ‚úì ËûçÂêàÁéáÔºö<strong style="color: ${finalFusionRate >= 80 ? '#52c41a' : finalFusionRate >= 60 ? '#faad14' : '#ff4d4f'};">${finalFusionRate}%</strong><br>
                                ‚úì ÂÜÖÂÆπÂ¢ûÈïøÔºö<strong style="color: #eb2f96;">${window.fusionQualityReport.growthRate}%</strong><br>
                                ‚úì Ë¥®ÈáèËØÑÁ∫ßÔºö<strong style="color: ${finalFusionRate >= 80 ? '#52c41a' : finalFusionRate >= 60 ? '#faad14' : '#ff4d4f'};">
                                    ${finalFusionRate >= 80 ? '‰ºòÁßÄ' : finalFusionRate >= 60 ? 'ËâØÂ•Ω' : 'ÈúÄÊîπËøõ'}
                                </strong>
                            </div>
                            ${finalFusionRate < 80 ? `
                                <div style="background: rgba(250,173,20,0.2); border: 1px solid rgba(250,173,20,0.3); border-radius: 8px; padding: 12px; margin-top: 12px;">
                                    <strong style="color: #faad14;">‚ö†Ô∏è ËûçÂêàË¥®ÈáèÊèêÁ§∫Ôºö</strong><br>
                                    <span style="color: rgba(255,255,255,0.85); font-size: 0.9rem;">
                                        ${finalFusionScore < savedOpinions.length ? `Ê£ÄÊµãÂà∞${savedOpinions.length - finalFusionScore}‰∏™ËßÇÁÇπÂèØËÉΩÊú™ÂÖÖÂàÜËûçÂêà„ÄÇ` : ''}
                                        Âª∫ËÆÆÊü•ÁúãÊ†áÊ≥®ÁâàÊïôÊ°àÊ†∏ÂØπÔºåÊàñÁÇπÂáª‰∏ãÊñπ"ÈáçÊñ∞ÁîüÊàê"ÊåâÈíÆ„ÄÇ
                                    </span>
                                </div>
                            ` : `
                                <div style="background: rgba(82,196,26,0.2); border: 1px solid rgba(82,196,26,0.3); border-radius: 8px; padding: 12px; margin-top: 12px;">
                                    <strong style="color: #52c41a;">‚úÖ ËûçÂêàË¥®Èáè‰ºòÁßÄÔºÅ</strong><br>
                                    <span style="color: rgba(255,255,255,0.85); font-size: 0.9rem;">
                                        ÊâÄÊúâ‰∏ìÂÆ∂Âª∫ËÆÆÂùáÂ∑≤ÊàêÂäüËûçÂÖ•ÊïôÊ°àÔºåÂèØ‰ª•ÊîæÂøÉ‰ΩøÁî®„ÄÇ
                                    </span>
                                </div>
                            `}
                            <div style="margin-top: 15px; padding-left: 20px;">
                                ‚úì ‰ΩøÁî®Êú¨Âú∞‰øùÂ≠òÁöÑ<strong style="color: #13c2c2;">ËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂</strong>ÔºàÂê´ÊäïÁ•®ËØ¶ÊÉÖÔºâ‰º†ÈÄíÁªôAI<br>
                                ‚úì ÊØè‰∏™Á´†ËäÇÈÉΩÊ†πÊçÆ‰∏ìÂÆ∂Âª∫ËÆÆËøõË°å‰∫ÜÂÆûË¥®ÊÄßÊîπËøõ<br>
                                ‚úì Âü∫‰∫é<strong style="color: #722ed1;">5EÊïôÂ≠¶Ê®°Âûã</strong>‰ºòÂåñÔºåÂåÖÂê´„Äê5E-Èò∂ÊÆµÂêç„ÄëÊ†áÊ≥®<br>
                                ‚úì ÂÜÖÂÆπÊõ¥‰∏∞ÂØå„ÄÅÊõ¥ÁßëÂ≠¶„ÄÅÊõ¥ÂÖ∑ÂèØÊìç‰ΩúÊÄß
                            </div>
                            <div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, rgba(114,46,209,0.15), rgba(138,43,226,0.05)); border-left: 4px solid #722ed1; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 1.3rem;">üìö</span>
                                    <strong style="color: #722ed1;">5EÊïôÂ≠¶Ê®°ÂûãÊ†áÊ≥®ËØ¥Êòé</strong>
                                </div>
                                <div style="color: rgba(255,255,255,0.85); font-size: 0.85rem; line-height: 1.6;">
                                    ÊïôÊ°à‰∏≠ÂêÑÊïôÂ≠¶ÁéØËäÇÂ∑≤Ê†áÊ≥®ÊâÄÂ±ûÁöÑ5EÈò∂ÊÆµÔºö<br>
                                    <span style="color: #ff4d4f;">üéØ„Äê5E-ÂºïÂÖ•„Äë</span> 
                                    <span style="color: #1890ff;">üîç„Äê5E-Êé¢Á©∂„Äë</span> 
                                    <span style="color: #52c41a;">üí°„Äê5E-Ëß£Èáä„Äë</span> 
                                    <span style="color: #722ed1;">üöÄ„Äê5E-Â∫îÁî®„Äë</span> 
                                    <span style="color: #fa8c16;">üìä„Äê5E-ËØÑ‰º∞„Äë</span>
                                </div>
                            </div>
                            <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                    <div>
                                        <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">ÂàùÂßãÊïôÊ°àÈïøÂ∫¶</span><br>
                                        <strong style="color: white; font-size: 1.1rem;">${initialPlanLength}</strong> Â≠ó
                                    </div>
                                    <div>
                                        <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">‰ºòÂåñÂêéÈïøÂ∫¶</span><br>
                                        <strong style="color: #52c41a; font-size: 1.1rem;">${cleanPlanLength}</strong> Â≠ó
                                    </div>
                                    <div>
                                        <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">ÂÜÖÂÆπÂ¢ûÈïø</span><br>
                                        <strong style="color: #1890ff; font-size: 1.1rem;">${((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(1)}%</strong>
                                    </div>
                                    <div>
                                        <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">ËûçÂêàË¥®Èáè</span><br>
                                        <strong style="color: #eb2f96; font-size: 1.1rem;">${fusionRate}%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 25px; border-radius: 10px; margin-top: 20px;">
                        <div class="analysis-content" id="fusedPlanContentClean" style="max-height: 600px; overflow-y: auto; color: rgba(255, 255, 255, 0.95); line-height: 2; font-size: 0.95rem;"></div>
                    </div>
                        <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="downloadFusedPlan('clean', 'txt')" style="background: linear-gradient(135deg, #1890ff, #40a9ff); margin-right: 10px;">
                            <i class="fas fa-download"></i> TXT
                        </button>
                        <button class="btn" onclick="downloadFusedPlan('clean', 'docx')" style="background: linear-gradient(135deg, #52c41a, #73d13d); margin-right: 10px;">
                            <i class="fas fa-file-word"></i> DOCX
                        </button>
                        <button class="btn" onclick="downloadFusedPlanPDF('clean')" style="background: linear-gradient(135deg, #722ed1, #9254de); margin-right: 10px;" title="Áõ¥Êé•ÂØºÂá∫PDFÔºàÊé®ËçêÔºöÂÖà‰∏ãËΩΩDOCXÁî®WordËΩ¨Êç¢Ôºâ">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn" onclick="downloadFusedPlan('clean', 'md')" style="background: linear-gradient(135deg, #fa8c16, #faad14); margin-right: 10px;">
                            <i class="fas fa-file-code"></i> MD
                        </button>
                        <button class="btn" onclick="generateHTMLFormatPlan()" style="background: linear-gradient(135deg, #eb2f96, #f759ab); margin-right: 10px;" id="generateHTMLBtn">
                            <i class="fas fa-code"></i> ÁîüÊàêHTMLÊ†ºÂºè
                        </button>
                        <button class="btn" onclick="exportLocalStylePDF('optimized')" style="background: linear-gradient(135deg, #13c2c2, #36cfc9); margin-right: 10px;" id="exportLocalStyleBtn" data-i18n="ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf">
                            <i class="fas fa-file-pdf"></i> <span>ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf</span>
                        </button>
                        ${finalFusionRate < 80 ? `
                            <button class="btn" onclick="regenerateFusedPlan()" style="background: linear-gradient(135deg, #ff4d4f, #ff7875);" title="ËûçÂêàË¥®Èáè‰∏çÁêÜÊÉ≥ÔºåÁÇπÂáªÈáçÊñ∞ÁîüÊàê">
                                <i class="fas fa-redo"></i> ÈáçÊñ∞ÁîüÊàêÔºàÂº∫ÂåñËûçÂêàÔºâ
                            </button>
                        ` : ''}
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: rgba(114, 46, 209, 0.1); border: 1px solid rgba(114, 46, 209, 0.3); border-radius: 6px; text-align: left;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.8rem; line-height: 1.6;">
                            <i class="fas fa-lightbulb" style="color: #faad14;"></i> <strong>PDFÊúÄ‰Ω≥ÂÆûË∑µÔºö</strong>
                            DOCX ‚Üí Word/WPSÊâìÂºÄ ‚Üí Âè¶Â≠ò‰∏∫PDFÔºàÂèÇËÄÉÊ†áÂáÜÊñáÊ°£ËΩ¨Êç¢ÊµÅÁ®ãÔºâ
                        </div>
                    </div>
                `;
                // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
                if (discussionRounds && safeAppendChild(discussionRounds, cleanPlanDiv, 'discussionRounds')) {
                    console.log('‚úÖ Á∫ØÂáÄÁâàÊïôÊ°àÂ∑≤Ê∑ªÂä†Âà∞DOM');
                    
                    // ÊªöÂä®Âà∞Á∫ØÂáÄÁâàÊïôÊ°à
                    setTimeout(() => {
                        if (cleanPlanDiv && document.body.contains(cleanPlanDiv)) {
                            ScrollManager.scrollTo(cleanPlanDiv, { offset: 80 });
                        }
                    }, 100);
                } else {
                    console.error('‚ùå Êó†Ê≥ïÊ∑ªÂä†Á∫ØÂáÄÁâàÊïôÊ°àÂà∞DOM');
                }
                
                // ÊµÅÂºèÊòæÁ§∫Á∫ØÂáÄÁâàÊïôÊ°àÂÜÖÂÆπ
                await delay(500);
                await typeText('fusedPlanContentClean', formatTeachingPlan(cleanPlan), 30);
                
                // ÊòæÁ§∫ÂØºÂá∫PDFÊèêÁ§∫
                const supportsAutoSave = 'showDirectoryPicker' in window;
                const hasSavedDirectory = window.savedDirectoryHandle != null;
                
                if (supportsAutoSave) {
                    const messageContent = hasSavedDirectory ?
                        `<div style="text-align: left; line-height: 2;">
                            <strong style="font-size: 18px; color: #52c41a;">üéâ ‰ºòÂåñÊïôÊ°àÂ∑≤ÁîüÊàêÂÆåÊØïÔºÅ</strong><br><br>
                            üöÄ ÁÇπÂáª‰∏ãÊñπÁöÑ<strong style="color: #13c2c2;">"ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf"</strong>ÊåâÈíÆÔºö<br><br>
                            <strong style="color: #1890ff;">‚ú® ÂÖ®Ëá™Âä®‰øùÂ≠òÊµÅÁ®ãÔºö</strong><br>
                            ‚úÖ Á≥ªÁªüÂ∞Ü<strong style="color: #52c41a;">Ëá™Âä®‰øùÂ≠òPDFÂà∞‰πãÂâçÈÄâÊã©ÁöÑÊñá‰ª∂Â§π</strong>ÔºàÊó†ÈúÄ‰ªª‰ΩïÊâãÂä®Êìç‰ΩúÔºâ<br>
                            ‚úÖ Êñá‰ª∂ÂêçËá™Âä®ÁîüÊàêÔºàÂåÖÂê´Êó∂Èó¥Êà≥ÔºåÈÅøÂÖçË¶ÜÁõñÔºâ<br><br>
                            üí° ÊØèÊ¨°‰ºòÂåñÂêéÈÉΩÂèØ<strong style="color: #eb2f96;">‰∏ÄÈîÆËá™Âä®ÂØºÂá∫</strong>Ôºå‰øùÂ≠òÊâÄÊúâÁâàÊú¨ÔºÅ<br>
                            üí° Êñá‰ª∂ÂêçËá™Âä®ÂåÖÂê´Êó∂Èó¥Êà≥Ôºå‰∏ç‰ºöË¶ÜÁõñ‰πãÂâçÁöÑÁâàÊú¨„ÄÇ
                        </div>` :
                        `<div style="text-align: left; line-height: 2;">
                            <strong style="font-size: 18px; color: #52c41a;">üéâ ‰ºòÂåñÊïôÊ°àÂ∑≤ÁîüÊàêÂÆåÊØïÔºÅ</strong><br><br>
                            üöÄ ÁÇπÂáª‰∏ãÊñπÁöÑ<strong style="color: #13c2c2;">"ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf"</strong>ÊåâÈíÆÔºö<br><br>
                            <strong style="color: #1890ff;">‚ú® ÂÖ®Ëá™Âä®‰øùÂ≠òÊµÅÁ®ãÔºö</strong><br>
                            1Ô∏è‚É£ ÈÄâÊã©ÂèÇËÄÉPDFÊñá‰ª∂ÔºàÁî®‰∫éÊ†ºÂºèÂèÇËÄÉÔºâ<br>
                            2Ô∏è‚É£ ÈÄâÊã©‰øùÂ≠òÊñá‰ª∂Â§πÔºà<strong style="color: #faad14;">‰ªÖÈ¶ñÊ¨°ÈúÄË¶Å</strong>Ôºâ<br>
                            3Ô∏è‚É£ Á≥ªÁªüËá™Âä®ÁîüÊàêÂπ∂‰øùÂ≠òPDF<br><br>
                            üí° ÊØèÊ¨°‰ºòÂåñÂêéÈÉΩÂèØ<strong style="color: #eb2f96;">‰∏ÄÈîÆËá™Âä®ÂØºÂá∫</strong>Ôºå‰øùÂ≠òÊâÄÊúâÁâàÊú¨ÔºÅ<br>
                            üí° Êñá‰ª∂ÂêçËá™Âä®ÂåÖÂê´Êó∂Èó¥Êà≥Ôºå‰∏ç‰ºöË¶ÜÁõñ‰πãÂâçÁöÑÁâàÊú¨„ÄÇ
                        </div>`;
                    showMessage(messageContent, 'success', 12000);
                } else {
                    showMessage(`
                        <div style="text-align: left; line-height: 2;">
                            <strong style="font-size: 16px; color: #52c41a;">üéâ ‰ºòÂåñÊïôÊ°àÂ∑≤ÁîüÊàêÔºÅ</strong><br><br>
                            üí° ÁÇπÂáª‰∏ãÊñπÁöÑ<strong style="color: #13c2c2;">"ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf"</strong>ÊåâÈíÆ„ÄÇ<br>
                            üí° Á≥ªÁªüÂ∞ÜËá™Âä®ÂºπÂá∫ÊâìÂç∞ÂØπËØùÊ°ÜÔºåËØ∑ÈÄâÊã©<strong style="color: #faad14;">"Âè¶Â≠ò‰∏∫PDF"</strong>‰øùÂ≠ò„ÄÇ<br>
                            üí° ÊØèÊ¨°‰ºòÂåñÂêéÈÉΩÂèØÈáçÂ§çÊ≠§Êìç‰ΩúÔºå‰øùÂ≠ò‰∏çÂêåÁâàÊú¨ÁöÑÊïôÊ°à„ÄÇ
                        </div>
                    `, 'success', 10000);
                }
                
                // ===== ÊòæÁ§∫Ê†áÊ≥®ÁâàÊïôÊ°à =====
                const annotatedPlanDiv = document.createElement('div');
                annotatedPlanDiv.className = 'card';
                annotatedPlanDiv.id = 'fusedTeachingPlanAnnotated';
                annotatedPlanDiv.style.background = 'linear-gradient(135deg, rgba(24, 144, 255, 0.15), rgba(24, 144, 255, 0.05))';
                annotatedPlanDiv.style.border = '2px solid rgba(24, 144, 255, 0.3)';
                annotatedPlanDiv.innerHTML = `
                    <h3 style="color: #1890ff; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-tags"></i> 
                        ‰ºòÂåñÊïôÊ°àÔºàÂØπÊØîÊ†áÊ≥®ÁâàÔºâ
                        <span style="font-size: 0.85rem; color: rgba(255,255,255,0.7); font-weight: normal;">
                            (Ê∏ÖÊô∞ÂØπÊØîÂàùÂßãÊïôÊ°à‰∏é‰ºòÂåñÂÜÖÂÆπ)
                        </span>
                    </h3>
                    <div style="background: rgba(24, 144, 255, 0.1); border: 1px solid rgba(24, 144, 255, 0.3); border-radius: 8px; padding: 20px; margin: 15px 0;">
                        <strong style="color: #1890ff; font-size: 1.1rem; display: block; margin-bottom: 12px;">
                            <i class="fas fa-info-circle"></i> ÂØπÊØîÊ†áÊ≥®ËØ¥Êòé
                        </strong>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 2;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #52c41a;">üìã Ê†áÊ≥®Ê†ºÂºèÔºö</strong>
                            </div>
                            <div style="padding-left: 20px; margin-bottom: 15px;">
                                ‚Ä¢ <strong>„ÄêÂéüÊñá„Äë</strong>ÔºöÂàùÂßãÊïôÊ°àÁöÑÂéüÊúâÂÜÖÂÆπ<br>
                                ‚Ä¢ <strong>„Äê‰ºòÂåñ„Äë</strong>ÔºöÊîπËøõÂêéÁöÑÊñ∞ÂÜÖÂÆπ <span style="color: #1890ff;">Ôºà‚ú® ‰∏ìÂÆ∂ÂêçÂª∫ËÆÆÔºâ</span><br>
                                ‚Ä¢ <strong>„ÄêÊñ∞Â¢û„Äë</strong>ÔºöÂÖ®Êñ∞Ê∑ªÂä†ÁöÑÂÜÖÂÆπ <span style="color: #1890ff;">Ôºà‚ú® ‰∏ìÂÆ∂ÂêçÂª∫ËÆÆÊñ∞Â¢ûÔºâ</span><br>
                                ‚Ä¢ <strong>„ÄêË∞ÉÊï¥„Äë</strong>ÔºöÁªìÊûÑÊàñÊó∂Èó¥Ë∞ÉÊï¥ <span style="color: #1890ff;">Ôºà‚ú® ‰∏ìÂÆ∂ÂêçÂª∫ËÆÆÔºâ</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #eb2f96;">üìä ÁªüËÆ°‰ø°ÊÅØÔºö</strong>
                            </div>
                            <div style="padding-left: 20px;">
                                ‚Ä¢ ‰ºòÂåñÊ†áÊ≥®Êï∞ÈáèÔºö<strong style="color: #1890ff;">${sparkleCount}</strong> Â§ÑÔºàÈ¢ÑÊúü ${expectedCount} Â§ÑÔºâ<br>
                                ‚Ä¢ Ê†áÊ≥®Áä∂ÊÄÅÔºö${sparkleCount >= expectedCount ? 
                                    '<strong style="color: #52c41a;">‚úÖ ÊâÄÊúâÂª∫ËÆÆÂùáÂ∑≤Ê†áÊ≥®</strong>' : 
                                    `<strong style="color: #faad14;">‚ö†Ô∏è Áº∫Â∞ë ${expectedCount - sparkleCount} ‰∏™Ê†áÊ≥®</strong>`
                                }<br>
                                ‚Ä¢ ËûçÂÖ•Âª∫ËÆÆÔºö${window.allAcceptedOpinions?.length || 0} ‰∏™‰∏ìÂÆ∂Âª∫ËÆÆÂ∑≤Ê∑±Â∫¶ËûçÂêà
                            </div>
                        </div>
                    </div>
                    ${sparkleCount < expectedCount ? `
                        <div style="background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); border-radius: 8px; padding: 12px; margin: 15px 0;">
                            <strong style="color: #ff4d4f;">‚ö†Ô∏è Ê†áÊ≥®È™åËØÅË≠¶Âëä</strong><br>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.85rem; line-height: 1.6;">
                                Ê£ÄÊµãÂà∞Ê†áÊ≥®Êï∞ÈáèÔºà${sparkleCount}‰∏™ÔºâÂ∞ë‰∫éÈááÁ∫≥ÁöÑÂª∫ËÆÆÊï∞ÈáèÔºà${expectedCount}‰∏™Ôºâ„ÄÇ<br>
                                ËøôÊÑèÂë≥ÁùÄÂèØËÉΩÊúâ <strong>${expectedCount - sparkleCount}</strong> Êù°‰∏ìÂÆ∂Âª∫ËÆÆÊú™Ë¢´ÊòéÁ°ÆÊ†áÊ≥®„ÄÇ<br><br>
                                <strong>Âª∫ËÆÆÊìç‰ΩúÔºö</strong><br>
                                1. ‰∏ãËΩΩ"ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï"Êü•ÁúãÊâÄÊúâÈááÁ∫≥ÁöÑÂª∫ËÆÆ<br>
                                2. ÂØπÁÖßÊ†áÊ≥®ÁâàÊïôÊ°àÔºåÊ£ÄÊü•ÊØèÊù°Âª∫ËÆÆÊòØÂê¶ÈÉΩÊúâ‚ú®Ê†áËÆ∞<br>
                                3. Â¶ÇÊ†áÊ≥®Á°ÆÂÆû‰∏çÂÆåÊï¥ÔºåÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê
                            </span>
                        </div>
                    ` : ''}
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 25px; border-radius: 10px; margin-top: 20px;">
                        <div class="analysis-content" id="fusedPlanContentAnnotated" style="max-height: 600px; overflow-y: auto; color: rgba(255, 255, 255, 0.95); line-height: 2; font-size: 0.95rem;"></div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="downloadFusedPlan('annotated', 'txt')" style="background: linear-gradient(135deg, #1890ff, #40a9ff); margin-right: 10px;">
                            <i class="fas fa-download"></i> TXT
                        </button>
                        <button class="btn" onclick="downloadFusedPlan('annotated', 'docx')" style="background: linear-gradient(135deg, #52c41a, #73d13d); margin-right: 10px;">
                            <i class="fas fa-file-word"></i> DOCX
                        </button>
                        <button class="btn" onclick="downloadFusedPlanPDF('annotated')" style="background: linear-gradient(135deg, #722ed1, #9254de); margin-right: 10px;" title="Áõ¥Êé•ÂØºÂá∫PDFÔºàÊé®ËçêÔºöÂÖà‰∏ãËΩΩDOCXÁî®WordËΩ¨Êç¢Ôºâ">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn" onclick="downloadFusedPlan('annotated', 'md')" style="background: linear-gradient(135deg, #fa8c16, #faad14); margin-right: 10px;">
                            <i class="fas fa-file-code"></i> MD
                        </button>
                        <button class="btn" onclick="exportLocalStylePDF('optimized')" style="background: linear-gradient(135deg, #13c2c2, #36cfc9); margin-right: 10px;" id="exportLocalStyleBtn2" data-i18n="ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf">
                            <i class="fas fa-file-pdf"></i> <span>ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf</span>
                        </button>
                        <button class="btn" onclick="downloadDiscussionRecord()" style="background: linear-gradient(135deg, #eb2f96, #f759ab);">
                            <i class="fas fa-comments"></i> ‰∏ãËΩΩËÆ®ËÆ∫ËÆ∞ÂΩï
                        </button>
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: rgba(24, 144, 255, 0.1); border: 1px solid rgba(24, 144, 255, 0.3); border-radius: 6px; text-align: left;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.8rem; line-height: 1.6;">
                            <i class="fas fa-lightbulb" style="color: #faad14;"></i> <strong>PDFÊúÄ‰Ω≥ÂÆûË∑µÔºö</strong>
                            ÂÖà‰∏ãËΩΩDOCX ‚Üí Áî®Word/WPSÊâìÂºÄ ‚Üí ÈÄâÊã©"Âè¶Â≠ò‰∏∫PDF"Ôºà‰øùËØÅÂØπÊØîÊ†áÊ≥®ÁöÑÈ¢úËâ≤ÂíåÊ†ºÂºèÂÆåÊï¥Ôºâ
                        </div>
                    </div>
                `;
                // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
                if (discussionRounds && safeAppendChild(discussionRounds, annotatedPlanDiv, 'discussionRounds')) {
                    console.log('‚úÖ Ê†áÊ≥®ÁâàÊïôÊ°àÂ∑≤Ê∑ªÂä†Âà∞DOM');
                    
                    // ÊªöÂä®Âà∞Ê†áÊ≥®ÁâàÊïôÊ°à
                    setTimeout(() => {
                        if (annotatedPlanDiv && document.body.contains(annotatedPlanDiv)) {
                            ScrollManager.scrollTo(annotatedPlanDiv, { offset: 80 });
                        }
                    }, 100);
                } else {
                    console.error('‚ùå Êó†Ê≥ïÊ∑ªÂä†Ê†áÊ≥®ÁâàÊïôÊ°àÂà∞DOM');
                }
                
                // ÊµÅÂºèÊòæÁ§∫Ê†áÊ≥®ÁâàÊïôÊ°àÂÜÖÂÆπ
                await delay(500);
                await typeText('fusedPlanContentAnnotated', formatTeachingPlan(annotatedPlan), 30);
                
                // ===== ÂÖàÊ∑ªÂä†Ê†áÊ≥®Á§∫‰æãËØ¥ÊòéÂç°Áâá =====
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'card';
                exampleDiv.style.cssText = `
                    background: linear-gradient(135deg, rgba(114, 46, 209, 0.15), rgba(114, 46, 209, 0.05));
                    border: 2px solid rgba(114, 46, 209, 0.3);
                    border-radius: 12px;
                    padding: 25px;
                `;
                exampleDiv.innerHTML = `
                    <h3 style="color: #722ed1; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <i class="fas fa-lightbulb"></i> 
                        ÂØπÊØîÊ†áÊ≥®Ê†ºÂºèÁ§∫‰æã
                    </h3>
                    <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 20px; margin: 15px 0;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem; line-height: 2;">
                            <div style="margin-bottom: 20px;">
                                <strong style="color: #fa8c16; font-size: 1.05rem;">üìå Ê†áÊ≥®ÁâàÊïôÊ°àÁöÑÈòÖËØªÊñπÂºèÔºö</strong>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #1890ff; padding: 15px; margin: 15px 0; border-radius: 8px;">
                                <div style="margin-bottom: 10px; color: #1890ff; font-weight: 600;">
                                    <i class="fas fa-edit"></i> Á±ªÂûã‰∏ÄÔºöÂÜÖÂÆπ‰ºòÂåñ
                                </div>
                                <div style="padding-left: 15px; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; line-height: 1.8;">
                                    <div style="color: #ff4d4f;">„ÄêÂéüÊñá„ÄëÔºöÂ≠¶ÁîüËÉΩÂ§üÁêÜËß£Â£∞Èü≥ÁöÑ‰∫ßÁîü</div>
                                    <div style="color: #52c41a; margin-top: 8px;">„Äê‰ºòÂåñ„ÄëÔºöÂ≠¶ÁîüËÉΩÂ§üÈÄöËøáÂÆûÈ™åËßÇÂØüÔºåÂáÜÁ°ÆÊèèËø∞Áâ©‰ΩìÊåØÂä®‰∏éÂ£∞Èü≥‰∫ßÁîüÁöÑÂõ†ÊûúÂÖ≥Á≥ªÔºåÂπ∂ËÉΩÁî®ÁßëÂ≠¶ËØ≠Ë®ÄÊ∏ÖÊô∞Ë°®ËææËá™Â∑±ÁöÑÂèëÁé∞</div>
                                    <div style="color: #1890ff; margin-top: 8px; font-style: italic;">Ôºà‚ú® Êô∫Ë∞±Ê∏ÖË®ÄÂª∫ËÆÆ‰ºòÂåñÔºâ</div>
                                </div>
                                <div style="margin-top: 10px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                    üëâ ÂèØ‰ª•Ê∏ÖÊ•öÁúãÂà∞ÔºöÂéüÊù•ÂÜô‰ªÄ‰πà ‚Üí Áé∞Âú®ÊîπÊàê‰ªÄ‰πà ‚Üí Ë∞ÅÂª∫ËÆÆÁöÑ
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #52c41a; padding: 15px; margin: 15px 0; border-radius: 8px;">
                                <div style="margin-bottom: 10px; color: #52c41a; font-weight: 600;">
                                    <i class="fas fa-plus-circle"></i> Á±ªÂûã‰∫åÔºöÊñ∞Â¢ûÂÜÖÂÆπ
                                </div>
                                <div style="padding-left: 15px; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; line-height: 1.8;">
                                    <div style="color: #52c41a;">„ÄêÊñ∞Â¢û„ÄëÔºöÂ¢ûÂä†Â∞èÁªÑÂÆûÈ™åËÆ®ËÆ∫ÁéØËäÇÔºà10ÂàÜÈíüÔºâÔºåËÆ©Â≠¶Áîü‰∫§ÊµÅÂÆûÈ™åÂèëÁé∞ÔºåÂüπÂÖªÂêà‰ΩúÂ≠¶‰π†ËÉΩÂäõ</div>
                                    <div style="color: #1890ff; margin-top: 8px; font-style: italic;">Ôºà‚ú® KimiÂª∫ËÆÆÊñ∞Â¢ûÔºâ</div>
                                </div>
                                <div style="margin-top: 10px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                    üëâ ÂàùÂßãÊïôÊ°àÊ≤°ÊúâÁöÑÂÜÖÂÆπÔºåÊ†πÊçÆ‰∏ìÂÆ∂Âª∫ËÆÆÊñ∞Â¢ûÂä†ÁöÑ
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #fa8c16; padding: 15px; margin: 15px 0; border-radius: 8px;">
                                <div style="margin-bottom: 10px; color: #fa8c16; font-weight: 600;">
                                    <i class="fas fa-exchange-alt"></i> Á±ªÂûã‰∏âÔºöÁªìÊûÑË∞ÉÊï¥
                                </div>
                                <div style="padding-left: 15px; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; line-height: 1.8;">
                                    <div style="color: #fa8c16;">„ÄêË∞ÉÊï¥„ÄëÔºöÂØºÂÖ•ÁéØËäÇÊó∂Èó¥‰ªé5ÂàÜÈíüË∞ÉÊï¥‰∏∫8ÂàÜÈíüÔºåÂ¢ûÂä†Â≠¶ÁîüÈ¢ÑÊµãÂíåËÆ®ËÆ∫Êó∂Èó¥</div>
                                    <div style="color: #1890ff; margin-top: 8px; font-style: italic;">Ôºà‚ú® Ë±ÜÂåÖÂª∫ËÆÆË∞ÉÊï¥Ôºâ</div>
                                </div>
                                <div style="margin-top: 10px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                                    üëâ ÂØπÊó∂Èó¥ÂàÜÈÖç„ÄÅÊïôÂ≠¶È°∫Â∫èÁ≠âÁªìÊûÑÊÄßË∞ÉÊï¥
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); border-radius: 8px;">
                                <strong style="color: #52c41a;">
                                    <i class="fas fa-check-circle"></i> ‰ΩøÁî®Âª∫ËÆÆÔºö
                                </strong>
                                <div style="margin-top: 10px; padding-left: 20px;">
                                    ‚úì ÈÄöËøá„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÂØπÊØîÔºå‰∫ÜËß£ÊØèÂ§ÑÊîπËøõÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ<br>
                                    ‚úì Êü•Áúã‚ú®Ê†áÊ≥®ÔºåÁü•ÈÅìÊòØÂì™‰Ωç‰∏ìÂÆ∂ÁöÑ‰∏ì‰∏öÂª∫ËÆÆ<br>
                                    ‚úì ÁªìÂêàËÆ®ËÆ∫ËÆ∞ÂΩïÔºåÊ∑±ÂÖ•ÁêÜËß£ÊîπËøõÁöÑÂéüÂõ†ÂíåÊäïÁ•®ÊÉÖÂÜµ<br>
                                    ‚úì Â¶ÇÈúÄË¶ÅÁõ¥Êé•‰ΩøÁî®ÔºåÊé®Ëçê‰∏ãËΩΩÁ∫ØÂáÄÁâàÔºàÊó†Ê†áÊ≥®Ôºâ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
                if (discussionRounds && safeAppendChild(discussionRounds, exampleDiv, 'discussionRounds')) {
                    console.log('‚úÖ Ê†áÊ≥®Á§∫‰æãÂ∑≤Ê∑ªÂä†Âà∞DOM');
                } else {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ∑ªÂä†Ê†áÊ≥®Á§∫‰æãÂà∞DOM');
                }
                
                // ===== ÊòæÁ§∫‰∏ìÂÆ∂Ë¥°ÁåÆÊ±áÊÄªË°® =====
                const contributionDiv = document.createElement('div');
                contributionDiv.className = 'card';
                contributionDiv.style.background = 'linear-gradient(135deg, rgba(250, 140, 22, 0.15), rgba(250, 140, 22, 0.05))';
                contributionDiv.style.border = '2px solid rgba(250, 140, 22, 0.3)';
                
                // ÁªüËÆ°ÊØè‰Ωç‰∏ìÂÆ∂ÁöÑË¥°ÁåÆÊï∞Èáè
                const expertContributions = {};
                if (savedOpinions && savedOpinions.length > 0) {
                    savedOpinions.forEach(opinion => {
                        const expertKey = opinion.expert.key;
                        if (!expertContributions[expertKey]) {
                            expertContributions[expertKey] = {
                                name: opinion.expert.name,
                                color: opinion.expert.color,
                                avatar: opinion.expert.avatar,
                                specialty: opinion.expert.specialty,
                                count: 0
                            };
                        }
                        expertContributions[expertKey].count++;
                    });
                }
                
                contributionDiv.innerHTML = `
                    <h3 style="color: #fa8c16; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-trophy"></i> 
                        ‰∏ìÂÆ∂Ë¥°ÁåÆÊ±áÊÄªË°®
                    </h3>
                    
                    <!-- ‰∏ìÂÆ∂Ë¥°ÁåÆÁªüËÆ°Âç°Áâá -->
                    <div class="contribution-stats">
                        ${Object.values(expertContributions).map(expert => `
                            <div class="stat-card" style="border-left: 4px solid ${expert.color};">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;">
                                    <span style="background: ${expert.color}; color: white; padding: 6px 10px; border-radius: 50%; font-size: 1rem; font-weight: bold;">${expert.avatar}</span>
                                    <strong style="font-size: 1rem;">${expert.name}</strong>
                                </div>
                                <div class="stat-number" style="color: ${expert.color};">${expert.count}</div>
                                <div class="stat-label">Êù°Âª∫ËÆÆË¢´ÈááÁ∫≥</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 5px;">${expert.specialty}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 10px;">
                            <div style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 15px;">
                                <strong>üìã ËØ¶ÁªÜÂª∫ËÆÆÂàóË°®ÔºàÂÖ± ${savedOpinions.length} Êù°Ôºâ</strong>
                            </div>
                            <table class="contribution-table">
                                <thead>
                                    <tr>
                                        <th>ÊïôÁ†îAI‰∏ìÂÆ∂</th>
                                        <th>‰∏ì‰∏öÈ¢ÜÂüü</th>
                                        <th>ÈíàÂØπÁ´†ËäÇ</th>
                                        <th>ÊîπËøõÂª∫ËÆÆ</th>
                                    </tr>
                                </thead>
                                <tbody id="contributionTableBody">
                                    ${savedOpinions.map((opinion, index) => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <span style="background: ${opinion.expert.color}; color: white; padding: 4px 8px; border-radius: 50%; font-size: 0.8rem; font-weight: bold;">${opinion.expert.avatar}</span>
                                                    <strong>${opinion.expert.name}</strong>
                                                </div>
                                            </td>
                                            <td style="color: rgba(255,255,255,0.7);">
                                                ${opinion.expert.specialty}
                                            </td>
                                            <td>
                                                <span style="background: rgba(24,144,255,0.2); color: #1890ff; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                                                    ${opinion.section}
                                                </span>
                                            </td>
                                            <td style="color: rgba(255,255,255,0.8);">
                                                ${opinion.content}
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="4" style="padding: 20px; text-align: center; color: rgba(255,255,255,0.6);">ÊöÇÊó†ÈááÁ∫≥ÁöÑËßÇÁÇπ</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                // ÂÆâÂÖ®Ê∑ªÂä†Âà∞DOM
                if (discussionRounds && safeAppendChild(discussionRounds, contributionDiv, 'discussionRounds')) {
                    console.log('‚úÖ ‰∏ìÂÆ∂Ë¥°ÁåÆË°®Â∑≤Ê∑ªÂä†Âà∞DOM');
                    
                    // ÊªöÂä®Âà∞Ë¥°ÁåÆË°®
                    setTimeout(() => {
                        if (contributionDiv && document.body.contains(contributionDiv)) {
                            ScrollManager.scrollTo(contributionDiv, { offset: 80 });
                        }
                    }, 100);
                } else {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ∑ªÂä†‰∏ìÂÆ∂Ë¥°ÁåÆË°®Âà∞DOM');
                }
                
                // ===== ÁîüÊàêËûçÂêàË¥®ÈáèÈ™åËØÅÊä•ÂëäÂç°ÁâáÔºàÂåÖÂê´ÊØè‰∏™ËßÇÁÇπÁöÑÊ†áÊ≥®Ê£ÄÊü•Ôºâ=====
                const qualityReportDiv = document.createElement('div');
                qualityReportDiv.className = 'card';
                qualityReportDiv.style.cssText = `
                    background: linear-gradient(135deg, rgba(19, 194, 194, 0.15), rgba(19, 194, 194, 0.05));
                    border: 2px solid rgba(19, 194, 194, 0.3);
                    border-radius: 12px;
                    padding: 25px;
                `;
                
                const allFusionGood = annotatedCount >= expectedCount * 0.9 && sparkleCount >= expectedCount && fusionQualityScore >= savedOpinions.length * 0.7;
                const reportColor = allFusionGood ? '#52c41a' : '#faad14';
                const reportIcon = allFusionGood ? 'check-circle' : 'exclamation-triangle';
                const reportTitle = allFusionGood ? '‚úÖ ËûçÂêàË¥®ÈáèÈ™åËØÅÈÄöËøá' : '‚ö†Ô∏è ËûçÂêàË¥®ÈáèÈúÄË¶ÅÂÖ≥Ê≥®';
                
                qualityReportDiv.innerHTML = `
                    <h3 style="color: ${reportColor}; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${reportIcon}"></i> 
                        ËûçÂêàË¥®ÈáèÈ™åËØÅÊä•Âëä
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #1890ff; font-weight: bold;">${savedOpinions.length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">‰∏ìÂÆ∂Âª∫ËÆÆÈááÁ∫≥</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #52c41a; font-weight: bold;">${fusionQualityScore}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">Ê£ÄÊµãÂà∞ËûçÂêà</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #eb2f96; font-weight: bold;">${sparkleCount}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">Ê†áÊ≥®Êï∞Èáè</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #fa8c16; font-weight: bold;">${((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(0)}%</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">ÂÜÖÂÆπÂ¢ûÈïø</div>
                        </div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: rgba(255,255,255,0.9);">üìä È™åËØÅÁªìÊûúÔºö</strong>
                        </div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.95rem; line-height: 2;">
                            ${fusionQualityScore >= savedOpinions.length * 0.7 ? 
                                `<div style="color: #52c41a;">‚úÖ ÂÜÖÂÆπËûçÂêàÔºöÊ£ÄÊµãÂà∞ ${fusionQualityScore}/${savedOpinions.length} Êù°Âª∫ËÆÆÂ∑≤ËûçÂÖ•Ôºà${fusionRate}%Ôºâ</div>` : 
                                `<div style="color: #faad14;">‚ö†Ô∏è ÂÜÖÂÆπËûçÂêàÔºö‰ªÖÊ£ÄÊµãÂà∞ ${fusionQualityScore}/${savedOpinions.length} Êù°Âª∫ËÆÆÔºà${fusionRate}%ÔºâÔºåÂèØËÉΩËûçÂêà‰∏çÂÆåÊï¥</div>`
                            }
                            ${annotatedCount >= expectedCount * 0.9 ? 
                                `<div style="color: #52c41a;">‚úÖ ËßÇÁÇπÊ†áÊ≥®Ôºö${annotatedCount}/${expectedCount} ‰∏™‰∏ìÂÆ∂ËßÇÁÇπÂ∑≤Ê†áÊ≥®</div>` : 
                                `<div style="color: #faad14;">‚ö†Ô∏è ËßÇÁÇπÊ†áÊ≥®Ôºö${annotatedCount}/${expectedCount} ‰∏™Ôºå${missingCount} ‰∏™ËßÇÁÇπÂèØËÉΩÊú™Ê†áÊ≥®</div>`
                            }
                            ${sparkleCount >= expectedCount ? 
                                `<div style="color: #52c41a;">‚úÖ Ê†áÊ≥®Á¨¶Âè∑Ôºö${sparkleCount}/${expectedCount} ‰∏™‚ú®Á¨¶Âè∑</div>` : 
                                `<div style="color: #faad14;">‚ö†Ô∏è Ê†áÊ≥®Á¨¶Âè∑Ôºö${sparkleCount}/${expectedCount} ‰∏™‚ú®Á¨¶Âè∑ÔºåÁº∫Â∞ë ${expectedCount - sparkleCount} ‰∏™</div>`
                            }
                            ${cleanPlanLength >= initialPlanLength * 1.1 ? 
                                `<div style="color: #52c41a;">‚úÖ ÂÜÖÂÆπ‰∏∞ÂØåÔºöÊØîÂàùÂßãÊïôÊ°àÂ¢ûÂä† ${((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(1)}%</div>` : 
                                `<div style="color: #faad14;">‚ö†Ô∏è ÂÜÖÂÆπÂ¢ûÈïø‰∏çÊòéÊòæÔºö‰ªÖÂ¢ûÂä† ${((cleanPlanLength - initialPlanLength) / initialPlanLength * 100).toFixed(1)}%</div>`
                            }
                        </div>
                    </div>
                    
                    <!-- ËØ¶ÁªÜÁöÑËßÇÁÇπÊ†áÊ≥®Ê£ÄÊü•Ë°® -->
                    <details style="margin-top: 15px; cursor: pointer;">
                        <summary style="color: #1890ff; font-weight: 600; padding: 12px; background: rgba(24,144,255,0.1); border-radius: 8px; border: 1px solid rgba(24,144,255,0.3); list-style: none; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-list-check"></i>
                            <span>Êü•ÁúãÊØè‰∏™ËßÇÁÇπÁöÑÊ†áÊ≥®Ê£ÄÊü•ËØ¶ÊÉÖÔºà${annotatedCount}/${expectedCount} Â∑≤Ê†áÊ≥®Ôºâ</span>
                        </summary>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; max-height: 400px; overflow-y: auto;">
                            ${annotationCheckResults.map((result, i) => {
                                const opinion = savedOpinions[i];
                                return `
                                    <div style="background: rgba(255,255,255,0.05); border-left: 3px solid ${result.isAnnotated ? '#52c41a' : '#ff4d4f'}; padding: 12px; margin: 10px 0; border-radius: 6px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            <span style="font-size: 1.2rem;">${result.isAnnotated ? '‚úÖ' : '‚ùå'}</span>
                                            <strong style="color: ${result.isAnnotated ? '#52c41a' : '#ff4d4f'};">${result.expert}</strong>
                                            <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Ôºà${result.section}Ôºâ</span>
                                            <span style="background: ${result.isAnnotated ? 'rgba(82,196,26,0.2)' : 'rgba(255,77,79,0.2)'}; color: ${result.isAnnotated ? '#52c41a' : '#ff4d4f'}; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: auto;">
                                                ${result.isAnnotated ? 'Â∑≤Ê†áÊ≥®' : 'Êú™Ê†áÊ≥®'}
                                            </span>
                                        </div>
                                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; padding-left: 5px;">
                                            ${opinion.content}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </details>
                    ${!allFusionGood ? `
                        <div style="background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong style="color: #ff4d4f;">‚ö†Ô∏è ÊîπËøõÂª∫ËÆÆ</strong><br>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.6;">
                                Ê£ÄÊµãÂà∞ËûçÂêàË¥®ÈáèÂèØËÉΩ‰∏çÂ§üÁêÜÊÉ≥ÔºåÂª∫ËÆÆÔºö<br>
                                1. ‰∏ãËΩΩ"ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï"Êü•ÁúãÊâÄÊúâ‰∏ìÂÆ∂Âª∫ËÆÆ<br>
                                2. ÂØπÁÖßÁ∫ØÂáÄÁâàÂíåÊ†áÊ≥®ÁâàÊïôÊ°àÔºåÊ£ÄÊü•Âª∫ËÆÆÊòØÂê¶ËûçÂÖ•<br>
                                3. Â¶ÇËûçÂêàÁ°ÆÂÆû‰∏çÂÆåÊï¥ÔºåÂèØ‰ª•Ôºö<br>
                                   ‚Ä¢ ÈáçÊñ∞Êèê‰∫§ÊïôÊ°àËøõË°åÊñ∞‰∏ÄËΩÆÂàÜÊûê<br>
                                   ‚Ä¢ ÊâãÂä®Ê†πÊçÆËÆ®ËÆ∫ËÆ∞ÂΩïË∞ÉÊï¥ÊïôÊ°à<br>
                                   ‚Ä¢ ËÅîÁ≥ªÂºÄÂèëÂõ¢ÈòüÂèçÈ¶àÈóÆÈ¢ò
                            </span>
                        </div>
                    ` : `
                        <div style="background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong style="color: #52c41a;">‚úÖ ËûçÂêàË¥®Èáè‰ºòÁßÄ</strong><br>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.9rem; line-height: 1.6;">
                                ÊâÄÊúâ‰∏ìÂÆ∂Âª∫ËÆÆÂùáÂ∑≤ÊàêÂäüËûçÂÖ•‰ºòÂåñÊïôÊ°àÔºåÊ†áÊ≥®ÂÆåÊï¥ÔºåÂÜÖÂÆπÂÖÖÂÆû„ÄÇ<br>
                                ÊÇ®ÂèØ‰ª•ÊîæÂøÉ‰ΩøÁî®Á∫ØÂáÄÁâàÊïôÊ°àÔºåÊàñÂèÇËÄÉÊ†áÊ≥®Áâà‰∫ÜËß£ÊØèÂ§Ñ‰ºòÂåñÁöÑÊù•Ê∫ê„ÄÇ
                            </span>
                        </div>
                    `}
                `;
                discussionRounds.appendChild(qualityReportDiv);
                
                console.log('‚úÖ ‰∏§‰ªΩËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°àÂíåÈ™åËØÅÊä•ÂëäÂ∑≤ÊòæÁ§∫');
                showMessage('‚úÖ ‰∏§‰ªΩÊñ∞ÊïôÊ°àÂ∑≤ÁîüÊàêÔºÅÁ∫ØÂáÄÁâàÂíåÊ†áÊ≥®ÁâàÂèØÂàÜÂà´‰∏ãËΩΩ', 'success');
                
            } catch (error) {
                console.error('ÁîüÊàêËûçÂêàÊïôÊ°àÂ§±Ë¥•:', error);
                
                updateGenerationUI(generationDiv, {
                    status: {
                        text: 'Â§±Ë¥•',
                        className: 'agent-status',
                        style: {
                            background: 'rgba(255, 77, 79, 0.2)',
                            color: '#ff4d4f'
                        }
                    },
                    content: `
                        <div style="color: #ff4d4f;">
                            <i class="fas fa-exclamation-circle"></i> Êñ∞ÊïôÊ°àÁîüÊàêÂ§±Ë¥•Ôºö${error.message}
                        </div>
                    `
                });
                
                showMessage('Êñ∞ÊïôÊ°àÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞Êó•Âøó', 'error');
            }
        }
        
        // ===== üîÑ ÈáçÊñ∞ÁîüÊàêËûçÂêàÊïôÊ°àÔºàÂº∫ÂåñËûçÂêàË¥®ÈáèÔºâ=====
        window.regenerateFusedPlan = async function() {
            if (!confirm('üîÑ Â∞ÜÈáçÊñ∞ÁîüÊàê‰ºòÂåñÊïôÊ°àÔºåÁâπÂà´Âº∫ÂåñËßÇÁÇπËûçÂêàË¥®Èáè„ÄÇ\n\nËøôÂ∞ÜÔºö\n‚Ä¢ ‰ΩøÁî®Êõ¥Âº∫ÁöÑpromptË¶ÅÊ±ÇAIÊ∑±Â∫¶ËûçÂêà\n‚Ä¢ ÁâπÂà´ÂÖ≥Ê≥®‰πãÂâçÂèØËÉΩÊú™ËûçÂêàÁöÑËßÇÁÇπ\n‚Ä¢ ÁîüÊàêÊó∂Èó¥Á∫¶1-2ÂàÜÈíü\n\nÁ°ÆÂÆöÈáçÊñ∞ÁîüÊàêÂêóÔºü')) {
                return;
            }
            
            console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #eb2f96; font-weight: bold;');
            console.log('%cüîÑ ÂºÄÂßãÈáçÊñ∞ÁîüÊàê‰ºòÂåñÊïôÊ°àÔºàÂº∫ÂåñËûçÂêàÔºâ', 'color: #eb2f96; font-size: 16px; font-weight: bold;');
            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #eb2f96; font-weight: bold;');
            
            showMessage('üîÑ Ê≠£Âú®ÈáçÊñ∞ÁîüÊàê‰ºòÂåñÊïôÊ°àÔºàÂº∫ÂåñËûçÂêàË¥®ÈáèÔºâ...', 'info');
            
            try {
                // ÊâæÂà∞ËÆ®ËÆ∫Âå∫Âüü
                const discussionRounds = document.getElementById('discussionRounds');
                if (!discussionRounds) {
                    throw new Error('Êó†Ê≥ïÊâæÂà∞ËÆ®ËÆ∫Âå∫Âüü');
                }
                
                // ÁßªÈô§ÊóßÁöÑÊïôÊ°àÊòæÁ§∫
                const oldCleanDiv = document.getElementById('fusedTeachingPlanClean');
                const oldAnnotatedDiv = document.getElementById('fusedTeachingPlanAnnotated');
                const oldContributionDiv = oldAnnotatedDiv?.nextElementSibling;
                const oldQualityDiv = oldContributionDiv?.nextElementSibling;
                
                if (oldCleanDiv) oldCleanDiv.remove();
                if (oldAnnotatedDiv) oldAnnotatedDiv.remove();
                if (oldContributionDiv?.className === 'card') oldContributionDiv.remove();
                if (oldQualityDiv?.className === 'card') oldQualityDiv.remove();
                
                // ÈáçÊñ∞Ë∞ÉÁî®ÁîüÊàêÂáΩÊï∞
                await generateFusedTeachingPlan(discussionRounds);
                
                console.log('%c‚úÖ ÈáçÊñ∞ÁîüÊàêÂÆåÊàêÔºÅ', 'color: #52c41a; font-weight: bold; font-size: 16px;');
                showMessage('‚úÖ ÊïôÊ°àÂ∑≤ÈáçÊñ∞ÁîüÊàêÔºåËØ∑Êü•ÁúãËûçÂêàË¥®ÈáèÊä•Âëä', 'success');
                
            } catch (error) {
                console.error('‚ùå ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•:', error);
                showMessage('‚ùå ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        };
        
        // ‰∏ãËΩΩËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°àÔºàÊîØÊåÅÁ∫ØÂáÄÁâàÂíåÊ†áÊ≥®ÁâàÔºåÂ§öÊ†ºÂºèÔºâ
        window.downloadFusedPlan = async function(version = 'clean', format = 'txt') {
            let content, baseFilename, title;
            
            if (version === 'clean') {
                if (!window.finalTeachingPlanClean) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÁ∫ØÂáÄÁâàÊïôÊ°à', 'error');
                    return;
                }
                content = window.finalTeachingPlanClean;
                baseFilename = '‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà';
                title = '‰ºòÂåñÊïôÊ°àÔºàÁ∫ØÂáÄÁâàÔºâ';
            } else if (version === 'annotated') {
                if (!window.finalTeachingPlanAnnotated) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊ†áÊ≥®ÁâàÊïôÊ°à', 'error');
                    return;
                }
                content = window.finalTeachingPlanAnnotated;
                baseFilename = '‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà';
                title = '‰ºòÂåñÊïôÊ°àÔºàÊ†áÊ≥®ÁâàÔºâ';
            } else {
                // ÂÖºÂÆπÊóß‰ª£Á†Å
                if (!window.finalTeachingPlan) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊñ∞ÊïôÊ°à', 'error');
                    return;
                }
                content = window.finalTeachingPlan;
                baseFilename = 'ËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°à';
                title = 'ËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°à';
            }
            
            // È™åËØÅÂÜÖÂÆπ‰∏ç‰∏∫Á©∫
            const trimmedContent = content.trim();
            if (trimmedContent.length < 50) {
                showMessage('‚ùå ÊïôÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÊàñËøáÁü≠ÔºåÊó†Ê≥ï‰∏ãËΩΩ', 'error');
                console.error('ÊïôÊ°àÂÜÖÂÆπÈïøÂ∫¶:', trimmedContent.length, 'ÁâàÊú¨:', version, 'Ê†ºÂºè:', format);
                console.error('ÂÜÖÂÆπÈ¢ÑËßà:', trimmedContent.substring(0, 200));
                return;
            }
            
            console.log(`üì• ÂáÜÂ§á‰∏ãËΩΩ ${version} ÁâàÊú¨ÊïôÊ°àÔºåÊ†ºÂºèÔºö${format}ÔºåÂÜÖÂÆπÈïøÂ∫¶: ${trimmedContent.length} Â≠óÁ¨¶`);
            
            const sessionFolderName = window.currentSessionFolderName || `${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            const filename = `${baseFilename}.${format}`;
            
            if (format === 'txt') {
                // TXTÊ†ºÂºè
                if (selectedFolderHandle) {
                    try {
                        let sessionFolder;
                        try {
                            sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                        } catch (e) {
                            sessionFolder = selectedFolderHandle;
                        }
                        await saveFileToFolder(sessionFolder, filename, content);
                        showMessage(`‚úÖ ${baseFilename}.txt Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºÅ`, 'success');
                    } catch (e) {
                        console.error('‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                        downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, content, 'text/plain;charset=utf-8');
                        showMessage(`‚úÖ ${baseFilename}.txt ‰∏ãËΩΩÊàêÂäüÔºÅ`, 'success');
                    }
                } else {
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, content, 'text/plain;charset=utf-8');
                    showMessage(`‚úÖ ${baseFilename}.txt ‰∏ãËΩΩÊàêÂäüÔºÅ`, 'success');
                }
            } else if (format === 'docx') {
                // DOCXÊ†ºÂºè
                const docxContent = convertToDocxHTML(content, title);
                if (selectedFolderHandle) {
                    try {
                        let sessionFolder;
                        try {
                            sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                        } catch (e) {
                            sessionFolder = selectedFolderHandle;
                        }
                        await saveFileToFolder(sessionFolder, filename, docxContent);
                        showMessage(`‚úÖ ${baseFilename}.docx Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºÅËØ∑Áî®WordÊâìÂºÄ`, 'success');
                    } catch (e) {
                        console.error('‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                        downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, docxContent, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                        showMessage(`‚úÖ ${baseFilename}.docx ‰∏ãËΩΩÊàêÂäüÔºÅËØ∑Áî®WordÊâìÂºÄ`, 'success');
                    }
                } else {
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, docxContent, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                    showMessage(`‚úÖ ${baseFilename}.docx ‰∏ãËΩΩÊàêÂäüÔºÅËØ∑Áî®WordÊâìÂºÄ`, 'success');
                }
            } else if (format === 'md') {
                // MarkdownÊ†ºÂºè
                const mdContent = convertToMarkdown(content, title);
                if (selectedFolderHandle) {
                    try {
                        let sessionFolder;
                        try {
                            sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                        } catch (e) {
                            sessionFolder = selectedFolderHandle;
                        }
                        await saveFileToFolder(sessionFolder, filename, mdContent);
                        showMessage(`‚úÖ ${baseFilename}.md Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºÅ`, 'success');
                    } catch (e) {
                        console.error('‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†Áªü‰∏ãËΩΩ:', e);
                        downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, mdContent, 'text/markdown;charset=utf-8');
                        showMessage(`‚úÖ ${baseFilename}.md ‰∏ãËΩΩÊàêÂäüÔºÅ`, 'success');
                    }
                } else {
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, mdContent, 'text/markdown;charset=utf-8');
                    showMessage(`‚úÖ ${baseFilename}.md ‰∏ãËΩΩÊàêÂäüÔºÅ`, 'success');
                }
            }
        };
        
        // ‰∏ãËΩΩÂàùÂßãÊïôÊ°à
        window.downloadInitialPlan = async function(format = 'txt') {
            if (!window.initialTeachingPlan) {
                showMessage('‚ùå ÂàùÂßãÊïôÊ°àÊú™ÁîüÊàêÔºåÊó†Ê≥ï‰∏ãËΩΩ', 'error');
                return;
            }
            
            // È™åËØÅÂÜÖÂÆπ‰∏ç‰∏∫Á©∫
            const content = window.initialTeachingPlan.trim();
            if (content.length < 50) {
                showMessage('‚ùå ÂàùÂßãÊïôÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÊàñËøáÁü≠ÔºåÊó†Ê≥ï‰∏ãËΩΩ', 'error');
                console.error('ÂàùÂßãÊïôÊ°àÂÜÖÂÆπÈïøÂ∫¶:', content.length);
                return;
            }
            
            console.log(`üì• ÂºÄÂßã‰∏ãËΩΩÂàùÂßãÊïôÊ°àÔºåÊ†ºÂºèÔºö${format}ÔºåÂÜÖÂÆπÈïøÂ∫¶Ôºö${content.length} Â≠óÁ¨¶`);
            
            const sessionFolderName = window.currentSessionFolderName || `${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            const filename = `ÂàùÊ≠•ÊïôÊ°à.${format}`;
            
            if (format === 'txt') {
                // ‰∏ãËΩΩTXTÊ†ºÂºè
                if (selectedFolderHandle) {
                    try {
                        let sessionFolder;
                        try {
                            sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                        } catch (e) {
                            sessionFolder = selectedFolderHandle;
                        }
                        await saveFileToFolder(sessionFolder, filename, content);
                        showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(TXT)Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºÅ', 'success');
                    } catch (e) {
                        downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, content, 'text/plain;charset=utf-8');
                        showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(TXT)‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
                    }
                } else {
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/${filename}`, content, 'text/plain;charset=utf-8');
                    showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(TXT)‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
                }
                
            } else if (format === 'docx') {
                // ‰∏ãËΩΩDOCXÊ†ºÂºè
                const docxContent = convertToDocxHTML(content, 'ÂàùÊ≠•ÊïôÊ°à');
                if (selectedFolderHandle) {
                    try {
                        let sessionFolder;
                        try {
                            sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                        } catch (e) {
                            sessionFolder = selectedFolderHandle;
                        }
                        await saveFileToFolder(sessionFolder, `ÂàùÊ≠•ÊïôÊ°à.docx`, docxContent);
                        showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(DOCX)Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºÅËØ∑Áî®WordÊâìÂºÄ', 'success');
                    } catch (e) {
                        downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/ÂàùÊ≠•ÊïôÊ°à.docx`, docxContent, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                        showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(DOCX)‰∏ãËΩΩÊàêÂäüÔºÅËØ∑Áî®WordÊâìÂºÄ', 'success');
                    }
                } else {
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/ÂàùÊ≠•ÊïôÊ°à.docx`, docxContent, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                    showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(DOCX)‰∏ãËΩΩÊàêÂäüÔºÅËØ∑Áî®WordÊâìÂºÄ', 'success');
                }
                
            } else if (format === 'md') {
                // ‰∏ãËΩΩMarkdownÊ†ºÂºè
                const mdContent = convertToMarkdown(content, 'ÂàùÊ≠•ÊïôÊ°à');
                if (selectedFolderHandle) {
                    try {
                        let sessionFolder;
                        try {
                            sessionFolder = await selectedFolderHandle.getDirectoryHandle(sessionFolderName, { create: true });
                        } catch (e) {
                            sessionFolder = selectedFolderHandle;
                        }
                        await saveFileToFolder(sessionFolder, `ÂàùÊ≠•ÊïôÊ°à.md`, mdContent);
                        showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(Markdown)Â∑≤‰øùÂ≠òÂà∞Êñá‰ª∂Â§πÔºÅ', 'success');
                    } catch (e) {
                        downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/ÂàùÊ≠•ÊïôÊ°à.md`, mdContent, 'text/markdown;charset=utf-8');
                        showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(Markdown)‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
                    }
                } else {
                    downloadFileTraditional(`ËÆ®ËÆ∫ÁªìÊûú/${sessionFolderName}/ÂàùÊ≠•ÊïôÊ°à.md`, mdContent, 'text/markdown;charset=utf-8');
                    showMessage('‚úÖ ÂàùÊ≠•ÊïôÊ°à(Markdown)‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
                }
                
            } else if (format === 'pdf') {
                // ÂØºÂá∫PDFÊ†ºÂºè - Êñ∞ÊñπÊ°àÔºöMarkdown ‚Üí PDFËΩ¨Êç¢ÊµÅÁ®ã
                // ÂÖàÁîüÊàêMarkdownÔºåÁÑ∂Âêé‰ªéMarkdownËΩ¨Êç¢‰∏∫PDFÔºåÂπ∂È™åËØÅÂÜôÂÖ•
                
                if (!content || content.trim().length < 50) {
                    showMessage('‚ùå ÊïôÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÊàñËøáÁü≠ÔºåÊó†Ê≥ïÂØºÂá∫', 'error');
                    return;
                }
                
                if (!checkPDFLibrary()) {
                    showMessage('‚ö†Ô∏è PDFÂ∫ìÊú™Âä†ËΩΩÔºåÂª∫ËÆÆ‰∏ãËΩΩMarkdownÂêéÊâãÂä®ËΩ¨Êç¢', 'info');
                    downloadInitialPlan('md');
                    return;
                }
                
                try {
                    showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨1Ê≠•ÔºöÁîüÊàêMarkdownÊñáÊ°£Ôºâ...', 'info');
                    
                    // ===== Á¨¨‰∏ÄÊ≠•ÔºöÁîüÊàêMarkdownÊ†ºÂºèÊñáÊ°£ =====
                    const markdownContent = convertToMarkdown(content, 'ÂàùÊ≠•ÊïôÊ°à');
                    console.log('‚úÖ Ê≠•È™§1ÂÆåÊàê - MarkdownÁîüÊàêÔºåÈïøÂ∫¶:', markdownContent.length);
                    
                    // È™åËØÅMarkdownÂÜÖÂÆπ
                    if (!markdownContent || markdownContent.length < 100) {
                        throw new Error('MarkdownÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
                    }
                    
                    showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨2Ê≠•ÔºöÂ∞ÜMarkdownÊ∏≤Êüì‰∏∫HTMLÔºâ...', 'info');
                    
                    // ===== Á¨¨‰∫åÊ≠•ÔºöÂ∞ÜMarkdownËΩ¨Êç¢‰∏∫Ê†ºÂºèÂåñÁöÑHTMLÁî®‰∫éPDF =====
                    const pdfHTML = convertMarkdownToHTML(markdownContent, 'ÂàùÊ≠•ÊïôÊ°à');
                    console.log('‚úÖ Ê≠•È™§2ÂÆåÊàê - MarkdownÂ∑≤ËΩ¨‰∏∫HTMLÔºåÈïøÂ∫¶:', pdfHTML.length);
                    
                    // È™åËØÅHTMLÂÜÖÂÆπ
                    if (!pdfHTML || pdfHTML.length < 500) {
                        throw new Error('MarkdownËΩ¨HTMLÂ§±Ë¥•');
                    }
                    
                    showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨3Ê≠•ÔºöÂä†ËΩΩHTMLÊñáÊ°£Ôºâ...', 'info');
                    
                    // ===== Á¨¨‰∏âÊ≠•ÔºöÂ∞ÜHTMLÂä†ËΩΩÂà∞iframe‰∏≠ËøõË°åÊ∏≤Êüì =====
                    const iframe = document.createElement('iframe');
                    iframe.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 210mm; height: 297mm; border: none; background: white;';
                    document.body.appendChild(iframe);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(pdfHTML);
                    iframeDoc.close();
                    
                    // Á≠âÂæÖÊñáÊ°£ÂÆåÂÖ®Ê∏≤Êüì
                    await new Promise(resolve => setTimeout(resolve, 600));
                    console.log('‚úÖ Ê≠•È™§3ÂÆåÊàê - HTMLÊñáÊ°£Â∑≤Âä†ËΩΩÂπ∂Ê∏≤Êüì');
                    
                    // È™åËØÅÊ∏≤ÊüìÂêéÁöÑÂÜÖÂÆπ
                    const iframeBody = iframeDoc.body;
                    const renderedTextContent = iframeBody.textContent || iframeBody.innerText || '';
                    
                    console.log('üìä HTMLÊñáÊ°£Ê∏≤ÊüìÈ™åËØÅ:', {
                        'bodyÂ≠òÂú®': !!iframeBody,
                        'bodyÂÖÉÁ¥†Êï∞': iframeBody.children.length,
                        'ÊñáÊú¨ÂÜÖÂÆπÈïøÂ∫¶': renderedTextContent.length,
                        'ÂÜÖÂÆπÈ¢ÑËßàÔºàÂâç300Â≠óÔºâ': renderedTextContent.substring(0, 300)
                    });
                    
                    if (renderedTextContent.trim().length < 50) {
                        document.body.removeChild(iframe);
                        throw new Error('HTMLÊñáÊ°£Ê∏≤ÊüìÂêéÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ïÁîüÊàêPDF');
                    }
                    
                    showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨4Ê≠•ÔºöËΩ¨Êç¢‰∏∫PDFÊñá‰ª∂Ôºâ...', 'info');
                    
                    // ===== Á¨¨ÂõõÊ≠•Ôºö‰ªéÊ∏≤ÊüìÁöÑHTMLËΩ¨Êç¢‰∏∫PDF =====
                    const opt = {
                        margin: [15, 15, 15, 15],
                        filename: `${folderName.split('/').pop()}_ÂàùÊ≠•ÊïôÊ°à.pdf`,
                        image: { 
                            type: 'jpeg', 
                            quality: 0.95
                        },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            letterRendering: true,
                            logging: true,
                            windowWidth: iframeBody.scrollWidth,
                            windowHeight: iframeBody.scrollHeight,
                            backgroundColor: '#ffffff'
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        },
                        pagebreak: { 
                            mode: ['avoid-all', 'css', 'legacy']
                        }
                    };
                    
                    console.log('üìÑ ÂºÄÂßã‰ªéHTMLËΩ¨Êç¢‰∏∫PDFÔºåÈÖçÁΩÆ:', opt);
                    
                    // ËΩ¨Êç¢‰∏∫PDF
                    const pdfResult = await html2pdf().set(opt).from(iframeBody).outputPdf('blob');
                    
                    console.log('üìä PDFÁîüÊàêÁªìÊûúÈ™åËØÅ:', {
                        'PDFÂØπË±°Á±ªÂûã': typeof pdfResult,
                        'PDFÂ§ßÂ∞è': pdfResult ? pdfResult.size : 0,
                        'PDFÊòØÂê¶‰∏∫Blob': pdfResult instanceof Blob
                    });
                    
                    // ===== Á¨¨‰∫îÊ≠•ÔºöÈ™åËØÅPDFÊòØÂê¶Ê≠£Á°ÆÂÜôÂÖ•ÂÜÖÂÆπ =====
                    if (!pdfResult || !(pdfResult instanceof Blob)) {
                        throw new Error('PDFÁîüÊàêÂ§±Ë¥•ÔºåËøîÂõûÂØπË±°Êó†Êïà');
                    }
                    
                    if (pdfResult.size < 1000) {
                        throw new Error(`PDFÊñá‰ª∂ËøáÂ∞è(${pdfResult.size}Â≠óËäÇ)ÔºåÂèØËÉΩÂÜÖÂÆπÊú™ÂÜôÂÖ•`);
                    }
                    
                    console.log('‚úÖ Ê≠•È™§5ÂÆåÊàê - PDFÂÜÖÂÆπÈ™åËØÅÈÄöËøáÔºåÂ§ßÂ∞è:', (pdfResult.size / 1024).toFixed(2), 'KB');
                    
                    showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨5Ê≠•Ôºö‰øùÂ≠òPDFÊñá‰ª∂Ôºâ...', 'info');
                    
                    // ===== Á¨¨ÂÖ≠Ê≠•Ôºö‰∏ãËΩΩPDFÊñá‰ª∂ =====
                    const url = URL.createObjectURL(pdfResult);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ÂàùÊ≠•ÊïôÊ°à.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // Áü≠ÊöÇÂª∂ËøüÂêéÊ∏ÖÁêÜURL
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    // Ê∏ÖÁêÜiframe
                    document.body.removeChild(iframe);
                    
                    console.log('‚úÖ PDFÂØºÂá∫ÊàêÂäüÔºàÂÆåÊï¥ÊµÅÁ®ãÔºöÂéüÂßãÂÜÖÂÆπ ‚Üí Markdown ‚Üí HTML ‚Üí PDFÔºâ');
                    console.log('üìä ÊúÄÁªàPDFÊñá‰ª∂:', {
                        'Êñá‰ª∂Âêç': 'ÂàùÊ≠•ÊïôÊ°à.pdf',
                        'Êñá‰ª∂Â§ßÂ∞è': (pdfResult.size / 1024).toFixed(2) + ' KB',
                        'ÂéüÂßãÂÜÖÂÆπÈïøÂ∫¶': content.length,
                        'MarkdownÈïøÂ∫¶': markdownContent.length,
                        'HTMLÈïøÂ∫¶': pdfHTML.length,
                        'Ê∏≤ÊüìÊñáÊú¨ÈïøÂ∫¶': renderedTextContent.length
                    });
                    
                    showMessage(`‚úÖ ÂàùÊ≠•ÊïôÊ°àPDFÂØºÂá∫ÊàêÂäüÔºÅÂ§ßÂ∞èÔºö${(pdfResult.size / 1024).toFixed(2)} KB`, 'success');
                    
                } catch (error) {
                    console.error('‚ùå PDFÂØºÂá∫Â§±Ë¥•:', error);
                    console.error('ËØ¶ÁªÜÈîôËØØ:', {
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Ê∏ÖÁêÜÊÆãÁïôÂÖÉÁ¥†
                    document.querySelectorAll('iframe[style*="left: -9999px"], div[style*="left: -9999px"]').forEach(el => {
                        try { if (document.body.contains(el)) document.body.removeChild(el); } catch (e) {}
                    });
                    
                    // ÈôçÁ∫ßÊñπÊ°àÔºö‰∏ãËΩΩMarkdownÊàñDOCXÊâãÂä®ËΩ¨Êç¢
                    if (confirm('‚ùå ‰ªéMarkdownËΩ¨Êç¢PDFÂ§±Ë¥•\n\n' + error.message + '\n\nÊé®ËçêÊñπÊ°àÔºö\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n1Ô∏è‚É£ ‰∏ãËΩΩMarkdownÊàñDOCXÊñá‰ª∂\n2Ô∏è‚É£ Áî®Typora/WordÊâìÂºÄ\n3Ô∏è‚É£ ÂØºÂá∫‰∏∫PDFÊ†ºÂºè\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nÊòØÂê¶Áé∞Âú®‰∏ãËΩΩMarkdownÔºü')) {
                        downloadInitialPlan('md');
                        showMessage('üí° MarkdownÂ∑≤‰∏ãËΩΩÔºåÂèØÁî®TyporaÊàñÂÖ∂‰ªñÂ∑•ÂÖ∑ËΩ¨‰∏∫PDF', 'info');
                    } else {
                        showMessage('‚ùå PDFÂØºÂá∫Â∑≤ÂèñÊ∂à', 'error');
                    }
                }
            }
        };
        
        // Ê†ºÂºèËΩ¨Êç¢ÂáΩÊï∞ÔºöËΩ¨Êç¢‰∏∫DOCX HTMLÊ†ºÂºèÔºàÂ¢ûÂº∫ÁâàÔºåÊîØÊåÅÂØπÊØîÊ†áÊ≥®È´ò‰∫ÆÔºå‰ºòÂåñPDFËΩ¨Êç¢Ôºâ
        // ÁîüÊàêÂÆåÊï¥ÁöÑWordÂÖºÂÆπHTMLÊñáÊ°£ÔºåÂèØÁõ¥Êé•Áî®WordÊâìÂºÄÊàñËΩ¨Êç¢‰∏∫PDF
        function convertToDocxHTML(content, title) {
            // È™åËØÅËæìÂÖ•
            if (!content || content.trim().length === 0) {
                console.error('convertToDocxHTML: ÂÜÖÂÆπ‰∏∫Á©∫');
                return '';
            }
            
            console.log('üìù convertToDocxHTML ÂºÄÂßãÂ§ÑÁêÜÔºåÂÜÖÂÆπÈïøÂ∫¶:', content.length);
            
            // Á¨¨‰∏ÄÊ≠•ÔºöÊ†áÂáÜÂåñÂÜÖÂÆπÊ†ºÂºè
            let processedContent = content
                .trim()
                // Áªü‰∏ÄÊç¢Ë°åÁ¨¶
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n');
            
            // Á¨¨‰∫åÊ≠•ÔºöËΩ¨Êç¢‰∏∫HTMLÊÆµËêΩÁªìÊûÑ
            // ÂÖàÊåâÂèåÊç¢Ë°åÂàÜÊÆµ
            const paragraphs = processedContent.split(/\n\n+/);
            
            let htmlContent = paragraphs.map(para => {
                // Ë∑≥ËøáÁ©∫ÊÆµËêΩ
                if (!para.trim()) return '';
                
                // Â§ÑÁêÜÊÆµËêΩÂÜÖÁöÑÂçïÊç¢Ë°å‰∏∫<br>
                let paraHTML = para.replace(/\n/g, '<br>');
                
                // Ê£ÄÊµãÊòØÂê¶ÊòØÊ†áÈ¢ò
                if (paraHTML.includes('„Äê') && paraHTML.includes('„Äë')) {
                    // Á´†ËäÇÊ†áÈ¢ò
                    paraHTML = paraHTML.replace(/„Äê([^„Äë]+)„Äë/g, '<h2 style="color: #1890ff; margin-top: 30px; margin-bottom: 15px; border-bottom: 3px solid #1890ff; padding-bottom: 10px; font-size: 20px; font-weight: bold; page-break-after: avoid;">„Äê$1„Äë</h2>');
                    return paraHTML;
                } else if (paraHTML.match(/^‚îÅ{5,}$/)) {
                    // ÂàÜÈöîÁ∫ø
                    return '<hr style="border: none; border-top: 2px solid #d9d9d9; margin: 25px 0; page-break-after: avoid;">';
                } else if (paraHTML.startsWith('„ÄêÂéüÊñá„Äë')) {
                    // ÂØπÊØîÊ†áÊ≥® - ÂéüÊñá
                    return paraHTML.replace(/„ÄêÂéüÊñá„Äë[Ôºö:]\s*(.+)/g, '<div class="highlight-original" style="background: #fff0f0; border-left: 5px solid #ff4d4f; padding: 15px; margin: 15px 0; border-radius: 6px; page-break-inside: avoid;"><strong style="color: #ff4d4f; font-size: 16px;">„ÄêÂéüÊñá„ÄëÔºö</strong><span style="color: #333; font-size: 15px; line-height: 1.8;">$1</span></div>');
                } else if (paraHTML.startsWith('„Äê‰ºòÂåñ„Äë')) {
                    // ÂØπÊØîÊ†áÊ≥® - ‰ºòÂåñ
                    return paraHTML.replace(/„Äê‰ºòÂåñ„Äë[Ôºö:]\s*([^Ôºà]+)Ôºà‚ú®([^Ôºâ]+)Ôºâ/g, '<div class="highlight-optimized" style="background: #f0fff0; border-left: 5px solid #52c41a; padding: 15px; margin: 15px 0; border-radius: 6px; page-break-inside: avoid;"><strong style="color: #52c41a; font-size: 16px;">„Äê‰ºòÂåñ„ÄëÔºö</strong><span style="color: #333; font-size: 15px; line-height: 1.8;">$1</span><span style="color: #1890ff; font-style: italic; margin-left: 8px; background: #e6f7ff; padding: 4px 10px; border-radius: 4px;">Ôºà‚ú®$2Ôºâ</span></div>');
                } else if (paraHTML.startsWith('„ÄêÊñ∞Â¢û„Äë')) {
                    // ÂØπÊØîÊ†áÊ≥® - Êñ∞Â¢û
                    return paraHTML.replace(/„ÄêÊñ∞Â¢û„Äë[Ôºö:]\s*([^Ôºà]+)Ôºà‚ú®([^Ôºâ]+)Ôºâ/g, '<div class="highlight-new" style="background: #f0f8ff; border-left: 5px solid #1890ff; padding: 15px; margin: 15px 0; border-radius: 6px; page-break-inside: avoid;"><strong style="color: #1890ff; font-size: 16px;">„ÄêÊñ∞Â¢û„ÄëÔºö</strong><span style="color: #333; font-size: 15px; line-height: 1.8;">$1</span><span style="color: #1890ff; font-style: italic; margin-left: 8px; background: #e6f7ff; padding: 4px 10px; border-radius: 4px;">Ôºà‚ú®$2Ôºâ</span></div>');
                } else if (paraHTML.startsWith('„ÄêË∞ÉÊï¥„Äë')) {
                    // ÂØπÊØîÊ†áÊ≥® - Ë∞ÉÊï¥
                    return paraHTML.replace(/„ÄêË∞ÉÊï¥„Äë[Ôºö:]\s*([^Ôºà]+)Ôºà‚ú®([^Ôºâ]+)Ôºâ/g, '<div style="background: #fff7e6; border-left: 5px solid #fa8c16; padding: 15px; margin: 15px 0; border-radius: 6px; page-break-inside: avoid;"><strong style="color: #fa8c16; font-size: 16px;">„ÄêË∞ÉÊï¥„ÄëÔºö</strong><span style="color: #333; font-size: 15px; line-height: 1.8;">$1</span><span style="color: #1890ff; font-style: italic; margin-left: 8px; background: #fff4e6; padding: 4px 10px; border-radius: 4px;">Ôºà‚ú®$2Ôºâ</span></div>');
                } else {
                    // ÊôÆÈÄöÊÆµËêΩ
                    // È´ò‰∫Æ‚ú®Ê†áÊ≥®
                    paraHTML = paraHTML
                        .replace(/‚ú®/g, '<span style="color: #52c41a; font-weight: bold; font-size: 1.1em;">‚ú®</span>')
                        .replace(/Ôºà‚ú®[^Ôºâ]+Ôºâ/g, '<span class="expert-badge" style="color: #1890ff; font-size: 0.9em; font-style: italic; background: #e6f7ff; padding: 3px 10px; border-radius: 4px; margin: 0 5px; white-space: nowrap;">$&</span>');
                    
                    return '<p style="margin: 12px 0; line-height: 2; color: #333; font-size: 14px;">' + paraHTML + '</p>';
                }
            }).filter(p => p).join('\n');
            
            console.log('üìä HTMLÂÜÖÂÆπÂ§ÑÁêÜÂÆåÊàêÔºåÊÆµËêΩÊï∞:', paragraphs.length, 'ÊúâÊïàÂÜÖÂÆπÈïøÂ∫¶:', htmlContent.length);
            
            // Á¨¨‰∏âÊ≠•ÔºöÁîüÊàêÂÆåÊï¥ÁöÑWordÂÖºÂÆπHTMLÊñáÊ°£
            const fullHTML = `<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>${title}</title>
    <!--[if gte mso 9]>
    <xml>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>100</w:Zoom>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        * {
            box-sizing: border-box;
        }
        body { 
            font-family: "Microsoft YaHei", "SimSun", "ÂÆã‰Ωì", Arial, sans-serif; 
            line-height: 1.8; 
            padding: 30px; 
            color: #333;
            background: white;
            font-size: 14px;
            max-width: 210mm;
            margin: 0 auto;
        }
        h1 { 
            color: #1890ff; 
            text-align: center; 
            margin: 20px 0 30px 0; 
            font-size: 26px;
            font-weight: bold;
            border-bottom: 3px solid #1890ff;
            padding-bottom: 15px;
            page-break-after: avoid;
        }
        h2 { 
            color: #1890ff; 
            margin-top: 30px; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #1890ff; 
            padding-bottom: 10px; 
            font-size: 18px;
            font-weight: bold;
            page-break-after: avoid;
        }
        h3 {
            color: #52c41a;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: bold;
            page-break-after: avoid;
        }
        p { 
            margin: 12px 0; 
            line-height: 2;
            color: #333;
            font-size: 14px;
        }
        br {
            line-height: 1.8;
        }
        .meta { 
            text-align: center; 
            color: #666; 
            font-size: 13px; 
            margin-bottom: 40px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            page-break-after: avoid;
        }
        .highlight-original {
            background: #fff0f0;
            border-left: 5px solid #ff4d4f;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            page-break-inside: avoid;
        }
        .highlight-optimized {
            background: #f0fff0;
            border-left: 5px solid #52c41a;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            page-break-inside: avoid;
        }
        .highlight-new {
            background: #f0f8ff;
            border-left: 5px solid #1890ff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            page-break-inside: avoid;
        }
        .expert-badge {
            color: #1890ff;
            font-style: italic;
            background: #e6f7ff;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: nowrap;
        }
        hr {
            border: none;
            border-top: 2px solid #d9d9d9;
            margin: 25px 0;
            page-break-after: avoid;
        }
        .footer {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        /* PDF‰ºòÂåñÔºöÈÅøÂÖçÂú®Ëøô‰∫õÂÖÉÁ¥†ÂÜÖÂàÜÈ°µ */
        div[class*="highlight"] {
            page-break-inside: avoid;
        }
    </style>
</head>
<body>
    <h1>${title}</h1>
    <div class="meta">
        üìÖ ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}<br>
        ${title.includes('Ê†áÊ≥®') ? 'üìã ÂåÖÂê´ÂØπÊØîÊ†áÊ≥®ÔºåÊ∏ÖÊô∞Â±ïÁ§∫‰ºòÂåñÂâçÂêéÂØπÊØî' : '‚úÖ Â∑≤ËûçÂêàÊâÄÊúâ‰∏ìÂÆ∂Âª∫ËÆÆÁöÑ‰ºòÂåñÁâàÊú¨'}<br>
        ü§ñ Á≥ªÁªüÔºöEduSymphony Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü
    </div>
    <div class="content" style="font-size: 14px; line-height: 2; color: #333;">
        ${htmlContent}
    </div>
    <div class="footer">
        <hr>
        <p style="margin: 10px 0;">EduSymphony ÊïôÊ°àÊïôÁ†îÁ≥ªÁªü Ëá™Âä®ÁîüÊàê</p>
        <p style="margin: 5px 0;">ÂºÄÂèëÂõ¢ÈòüÔºöÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü</p>
    </div>
</body>
</html>`;
            
            console.log('‚úÖ convertToDocxHTML ÂÆåÊàêÔºåHTMLÈïøÂ∫¶:', fullHTML.length);
            return fullHTML;
        }
        
        // Ê†ºÂºèËΩ¨Êç¢ÂáΩÊï∞ÔºöËΩ¨Êç¢‰∏∫MarkdownÊ†ºÂºè
        function convertToMarkdown(content, title) {
            let mdContent = `# ${title}\n\n`;
            mdContent += `> ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}\n`;
            mdContent += `> Á≥ªÁªüÔºöEduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü\n\n`;
            mdContent += `---\n\n`;
            
            // ËΩ¨Êç¢ÂÜÖÂÆπ
            const lines = content.split('\n');
            for (let line of lines) {
                // Â§ÑÁêÜÊ†áÈ¢ò
                if (line.includes('„Äê') && line.includes('„Äë')) {
                    const title = line.match(/„Äê([^„Äë]+)„Äë/);
                    if (title) {
                        mdContent += `\n## ${title[1]}\n\n`;
                        continue;
                    }
                }
                // Â§ÑÁêÜÂàÜÈöîÁ∫ø
                if (line.match(/^‚îÅ+$/)) {
                    mdContent += `\n---\n\n`;
                    continue;
                }
                // Â§ÑÁêÜÂàóË°®È°π
                if (line.match(/^[‚Ä¢\-‚≠êüî∏üìöüë•]/)) {
                    mdContent += `${line}\n`;
                    continue;
                }
                // Â§ÑÁêÜÁºñÂè∑ÂàóË°®
                if (line.match(/^\d+\./)) {
                    mdContent += `${line}\n`;
                    continue;
                }
                // Â§ÑÁêÜÊôÆÈÄöË°å
                if (line.trim()) {
                    mdContent += `${line}\n`;
                }
            }
            
            mdContent += `\n---\n\n`;
            mdContent += `_Êú¨ÊñáÊ°£Áî± EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü Ëá™Âä®ÁîüÊàê_\n`;
            
            return mdContent;
        }
        
        // Â∞ÜMarkdownËΩ¨Êç¢‰∏∫ÈÄÇÂêàPDFÁöÑHTMLÊ†ºÂºè
        function convertMarkdownToHTML(markdownContent, title) {
            console.log('üìù convertMarkdownToHTML ÂºÄÂßãÂ§ÑÁêÜÔºåMarkdownÈïøÂ∫¶:', markdownContent.length);
            
            // È™åËØÅËæìÂÖ•
            if (!markdownContent || markdownContent.trim().length === 0) {
                console.error('convertMarkdownToHTML: MarkdownÂÜÖÂÆπ‰∏∫Á©∫');
                return '';
            }
            
            let htmlBody = '';
            const lines = markdownContent.split('\n');
            let inCodeBlock = false;
            let inList = false;
            let listItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Ë∑≥ËøáÁ©∫Ë°åÔºà‰ΩÜ‰øùÁïôÊÆµËêΩÈó¥Ë∑ùÔºâ
                if (!trimmedLine) {
                    if (inList) {
                        // ÁªìÊùüÂàóË°®
                        htmlBody += '<ul style="margin: 15px 0; padding-left: 30px;">\n' + 
                                   listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                                   '\n</ul>\n';
                        listItems = [];
                        inList = false;
                    }
                    htmlBody += '<br>\n';
                    continue;
                }
                
                // Â§ÑÁêÜ‰∏ÄÁ∫ßÊ†áÈ¢ò
                if (trimmedLine.startsWith('# ')) {
                    const titleText = trimmedLine.substring(2);
                    // ‰∏ÄÁ∫ßÊ†áÈ¢òÂ∑≤Âú®Â§ñÂ±Ç‰ΩøÁî®ÔºåË∑≥Ëøá
                    continue;
                }
                
                // Â§ÑÁêÜ‰∫åÁ∫ßÊ†áÈ¢òÔºàÁ´†ËäÇÔºâ
                if (trimmedLine.startsWith('## ')) {
                    if (inList) {
                        htmlBody += '<ul style="margin: 15px 0; padding-left: 30px;">\n' + 
                                   listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                                   '\n</ul>\n';
                        listItems = [];
                        inList = false;
                    }
                    const headingText = trimmedLine.substring(3);
                    htmlBody += `<h2 style="color: #1890ff; margin-top: 35px; margin-bottom: 15px; border-bottom: 3px solid #1890ff; padding-bottom: 10px; font-size: 22px; font-weight: bold; page-break-after: avoid;">${headingText}</h2>\n`;
                    continue;
                }
                
                // Â§ÑÁêÜ‰∏âÁ∫ßÊ†áÈ¢ò
                if (trimmedLine.startsWith('### ')) {
                    if (inList) {
                        htmlBody += '<ul style="margin: 15px 0; padding-left: 30px;">\n' + 
                                   listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                                   '\n</ul>\n';
                        listItems = [];
                        inList = false;
                    }
                    const headingText = trimmedLine.substring(4);
                    htmlBody += `<h3 style="color: #52c41a; margin-top: 25px; margin-bottom: 12px; font-size: 18px; font-weight: bold; page-break-after: avoid;">${headingText}</h3>\n`;
                    continue;
                }
                
                // Â§ÑÁêÜÂàÜÈöîÁ∫ø
                if (trimmedLine.match(/^-{3,}$/)) {
                    if (inList) {
                        htmlBody += '<ul style="margin: 15px 0; padding-left: 30px;">\n' + 
                                   listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                                   '\n</ul>\n';
                        listItems = [];
                        inList = false;
                    }
                    htmlBody += '<hr style="border: none; border-top: 2px solid #d9d9d9; margin: 25px 0; page-break-after: avoid;">\n';
                    continue;
                }
                
                // Â§ÑÁêÜÂºïÁî®Ôºà> ÂºÄÂ§¥Ôºâ
                if (trimmedLine.startsWith('> ')) {
                    if (inList) {
                        htmlBody += '<ul style="margin: 15px 0; padding-left: 30px;">\n' + 
                                   listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                                   '\n</ul>\n';
                        listItems = [];
                        inList = false;
                    }
                    const quoteText = trimmedLine.substring(2);
                    htmlBody += `<blockquote style="background: #f5f5f5; border-left: 4px solid #1890ff; padding: 12px 20px; margin: 15px 0; color: #666; font-style: italic; page-break-inside: avoid;">${quoteText}</blockquote>\n`;
                    continue;
                }
                
                // Â§ÑÁêÜÂàóË°®È°π
                if (trimmedLine.match(/^[-‚Ä¢‚≠êüî∏üìöüë•]\s/) || trimmedLine.match(/^\d+\.\s/)) {
                    const itemText = trimmedLine.replace(/^[-‚Ä¢‚≠êüî∏üìöüë•]\s*/, '').replace(/^\d+\.\s*/, '');
                    listItems.push(itemText);
                    inList = true;
                    continue;
                }
                
                // Â§ÑÁêÜÊôÆÈÄöÊÆµËêΩ
                if (inList) {
                    // ÁªìÊùü‰πãÂâçÁöÑÂàóË°®
                    htmlBody += '<ul style="margin: 15px 0; padding-left: 30px; line-height: 1.8;">\n' + 
                               listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                               '\n</ul>\n';
                    listItems = [];
                    inList = false;
                }
                
                // Â§ÑÁêÜÂº∫Ë∞ÉÂíåÁ≤ó‰Ωì
                let processedLine = trimmedLine
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace;">$1</code>');
                
                htmlBody += `<p style="margin: 12px 0; line-height: 2; color: #333; font-size: 14px;">${processedLine}</p>\n`;
            }
            
            // ÁªìÊùüÊú™Èó≠ÂêàÁöÑÂàóË°®
            if (inList && listItems.length > 0) {
                htmlBody += '<ul style="margin: 15px 0; padding-left: 30px;">\n' + 
                           listItems.map(item => `<li style="margin: 8px 0; line-height: 1.8;">${item}</li>`).join('\n') + 
                           '\n</ul>\n';
            }
            
            // ÁîüÊàêÂÆåÊï¥ÁöÑHTMLÊñáÊ°£
            const fullHTML = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>${title}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body { 
            font-family: "Microsoft YaHei", "SimSun", "ÂÆã‰Ωì", Arial, sans-serif; 
            line-height: 1.8; 
            padding: 40px; 
            color: #333;
            background: white;
            font-size: 14px;
            max-width: 210mm;
            margin: 0 auto;
        }
        h1 { 
            color: #1890ff; 
            text-align: center; 
            margin: 20px 0 30px 0; 
            font-size: 28px;
            font-weight: bold;
            border-bottom: 3px solid #1890ff;
            padding-bottom: 15px;
            page-break-after: avoid;
        }
        h2 { 
            color: #1890ff; 
            margin-top: 35px; 
            margin-bottom: 15px; 
            border-bottom: 3px solid #1890ff; 
            padding-bottom: 10px; 
            font-size: 22px;
            font-weight: bold;
            page-break-after: avoid;
        }
        h3 {
            color: #52c41a;
            margin-top: 25px;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: bold;
            page-break-after: avoid;
        }
        p { 
            margin: 12px 0; 
            line-height: 2;
            color: #333;
            font-size: 14px;
        }
        ul {
            margin: 15px 0;
            padding-left: 30px;
            line-height: 1.8;
        }
        li {
            margin: 8px 0;
            line-height: 1.8;
        }
        blockquote {
            background: #f5f5f5;
            border-left: 4px solid #1890ff;
            padding: 12px 20px;
            margin: 15px 0;
            color: #666;
            font-style: italic;
            page-break-inside: avoid;
        }
        hr {
            border: none;
            border-top: 2px solid #d9d9d9;
            margin: 25px 0;
            page-break-after: avoid;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            page-break-after: avoid;
        }
        .footer {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            page-break-before: avoid;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>${title}</h1>
        <p style="color: #666; font-size: 13px; margin-top: 15px;">
            üìÖ ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}<br>
            ü§ñ Á≥ªÁªüÔºöEduSymphony Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü
        </p>
    </div>
    
    <div class="content">
        ${htmlBody}
    </div>
    
    <div class="footer">
        <hr>
        <p style="margin: 10px 0;">EduSymphony ÊïôÊ°àÊïôÁ†îÁ≥ªÁªü Ëá™Âä®ÁîüÊàê</p>
        <p style="margin: 5px 0;">ÂºÄÂèëÂõ¢ÈòüÔºöÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü</p>
    </div>
</body>
</html>`;
            
            console.log('‚úÖ convertMarkdownToHTML ÂÆåÊàêÔºåHTMLÈïøÂ∫¶:', fullHTML.length);
            return fullHTML;
        }
        
        // Ê†ºÂºèËΩ¨Êç¢ÂáΩÊï∞ÔºöËΩ¨Êç¢‰∏∫MarkdownÊ†ºÂºè
        function convertToMarkdown(content, title) {
            let mdContent = `# ${title}\n\n`;
            mdContent += `> ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}\n`;
            mdContent += `> Á≥ªÁªüÔºöEduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü\n\n`;
            mdContent += `---\n\n`;
            
            // ËΩ¨Êç¢ÂÜÖÂÆπ
            const lines = content.split('\n');
            for (let line of lines) {
                // Â§ÑÁêÜÊ†áÈ¢ò
                if (line.includes('„Äê') && line.includes('„Äë')) {
                    const title = line.match(/„Äê([^„Äë]+)„Äë/);
                    if (title) {
                        mdContent += `\n## ${title[1]}\n\n`;
                        continue;
                    }
                }
                // Â§ÑÁêÜÂàÜÈöîÁ∫ø
                if (line.match(/^‚îÅ+$/)) {
                    mdContent += `\n---\n\n`;
                    continue;
                }
                // Â§ÑÁêÜÂàóË°®È°π
                if (line.match(/^[‚Ä¢\-‚≠êüî∏üìöüë•]/)) {
                    mdContent += `${line}\n`;
                    continue;
                }
                // Â§ÑÁêÜÁºñÂè∑ÂàóË°®
                if (line.match(/^\d+\./)) {
                    mdContent += `${line}\n`;
                    continue;
                }
                // Â§ÑÁêÜÊôÆÈÄöË°å
                if (line.trim()) {
                    mdContent += `${line}\n`;
                }
            }
            
            mdContent += `\n---\n\n`;
            mdContent += `_Êú¨ÊñáÊ°£Áî± EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü Ëá™Âä®ÁîüÊàê_\n`;
            
            return mdContent;
        }
        
        // ÁîüÊàêËÆ®ËÆ∫ËÆ∞ÂΩïHTMLÂÜÖÂÆπÔºàÂ¢ûÂº∫ÁâàÔºåÂåÖÂê´ÂÆåÊï¥ËÆ®ËÆ∫ËøáÁ®ãÔºåÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑËßÇÁÇπÔºâ
        function generateDiscussionRecordHTML(opinionsBySection) {
            const recordContent = document.getElementById('discussionRecordContent');
            if (!recordContent) return;
            
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            // Â¶ÇÊûúÊúâÊâÄÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÔºå‰ºòÂÖà‰ΩøÁî®ÂÆÉÊù•ÁîüÊàêHTML
            const allDiscussedBySection = {};
            if (allDiscussed.length > 0) {
                allDiscussed.forEach(opinion => {
                    const section = opinion.section || 'ÂÖ∂‰ªñ';
                    if (!allDiscussedBySection[section]) {
                        allDiscussedBySection[section] = [];
                    }
                    allDiscussedBySection[section].push(opinion);
                });
            }
            
            const sectionsToShow = Object.keys(allDiscussedBySection).length > 0 ? allDiscussedBySection : opinionsBySection;
            const totalDiscussed = allDiscussed.length || opinions.length;
            const totalAccepted = opinions.length;
            
            let htmlContent = '';
            
            // Ê∑ªÂä†ËÆ®ËÆ∫ÊÄªËßàÔºàÂå∫ÂàÜÈááÁ∫≥ÂíåÊú™ÈááÁ∫≥Ôºâ
            htmlContent += `
                <div style="background: linear-gradient(135deg, rgba(235, 47, 150, 0.2), rgba(235, 47, 150, 0.1)); border: 2px solid rgba(235, 47, 150, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="color: #eb2f96; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-bar"></i> ÊïôÁ†îËÆ®ËÆ∫ÊÄªËßà
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #1890ff; font-weight: bold;">${Object.keys(sectionsToShow).length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">ËÆ®ËÆ∫‰∏ªÈ¢òÊï∞</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #faad14; font-weight: bold;">${totalDiscussed}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">ËßÇÁÇπÊÄªÊï∞</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #52c41a; font-weight: bold;">${totalAccepted}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">Âª∫ËÆÆË¢´ÈááÁ∫≥</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; color: #fa8c16; font-weight: bold;">${agents.length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">ÂèÇ‰∏é‰∏ìÂÆ∂Êï∞</div>
                        </div>
                    </div>
                    ${totalAccepted === 0 && totalDiscussed > 0 ? `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(250,173,20,0.2); border: 1px solid rgba(250,173,20,0.4); border-radius: 8px;">
                            <strong style="color: #faad14;">‚ö†Ô∏è ÈááÁ∫≥ÊÉÖÂÜµÔºö</strong>
                            <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">
                                ${totalDiscussed}‰∏™ËßÇÁÇπÂùáÊú™ËææÂà∞40%ÂêåÊÑèÁéáÈòàÂÄºÔºåÊú™Ë¢´ÈááÁ∫≥
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // ÊåâÁ´†ËäÇÂ±ïÁ§∫ËØ¶ÁªÜËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑËßÇÁÇπÔºâ
            Object.entries(sectionsToShow).forEach(([section, opinions], sectionIndex) => {
                const acceptedInSection = opinions.filter(op => op.isAccepted).length;
                const rejectedInSection = opinions.length - acceptedInSection;
                
                htmlContent += `
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 25px; margin: 20px 0; border-left: 4px solid #eb2f96;">
                        <h4 style="color: #eb2f96; margin-bottom: 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-folder-open"></i> 
                            <span>ËÆ®ËÆ∫‰∏ªÈ¢ò ${sectionIndex + 1}Ôºö„Äê${section}„Äë</span>
                        </h4>
                        <div style="margin-bottom: 15px; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                            üí¨ ÂÖ±${opinions.length}‰∏™ËßÇÁÇπ | 
                            ‚úÖ ${acceptedInSection}‰∏™ÈááÁ∫≥ | 
                            ‚ùå ${rejectedInSection}‰∏™Êú™ÈááÁ∫≥
                        </div>
                        
                        ${opinions.map((opinion, index) => {
                            // ËÆ°ÁÆóÊäïÁ•®ÁªüËÆ°Ôºà‰ΩøÁî®40%ÈòàÂÄºÔºâ
                            const totalVotes = opinion.votes ? (opinion.votes.agree + opinion.votes.disagree) : 0;
                            const passRate = totalVotes > 0 ? ((opinion.votes.agree / totalVotes) * 100).toFixed(1) : 0;
                            const isAccepted = opinion.isAccepted !== undefined ? opinion.isAccepted : (passRate >= 40);
                            
                            return `
                            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 20px; margin: 15px 0; border: 2px solid ${isAccepted ? 'rgba(82, 196, 26, 0.3)' : 'rgba(255, 77, 79, 0.3)'};">
                                <!-- ‰∏ìÂÆ∂‰ø°ÊÅØ -->
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                    <span style="background: ${opinion.expert.color}; color: white; padding: 8px 14px; border-radius: 50%; font-size: 1rem; font-weight: bold;">${opinion.expert.avatar}</span>
                                    <div>
                                        <strong style="color: white; font-size: 1.1rem;">${opinion.expert.name}</strong>
                                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem; margin-top: 3px;">${opinion.expert.specialty}</div>
                                    </div>
                                    <span style="margin-left: auto; background: ${isAccepted ? 'rgba(82, 196, 26, 0.2)' : 'rgba(255, 77, 79, 0.2)'}; color: ${isAccepted ? '#52c41a' : '#ff4d4f'}; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                        ${isAccepted ? '‚úÖ Â∑≤ÈááÁ∫≥' : '‚ùå Êú™ÈÄöËøá'}
                                    </span>
                                </div>
                                
                                <!-- ‰∏ìÂÆ∂ËßÇÁÇπ -->
                                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                    <div style="color: #1890ff; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-comment-dots"></i> ‰∏ìÂÆ∂ËßÇÁÇπÔºö
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.95); line-height: 1.8; font-size: 1rem;">
                                        ${opinion.content}
                                    </div>
                                </div>
                                
                                <!-- ÊäïÁ•®ËØ¶ÊÉÖ -->
                                ${opinion.votes ? `
                                    <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                                            <span style="color: #52c41a; font-size: 1rem; font-weight: 600;">
                                                <i class="fas fa-thumbs-up"></i> ËµûÊàê: ${opinion.votes.agree} Á•®
                                            </span>
                                            <span style="color: #ff4d4f; font-size: 1rem; font-weight: 600;">
                                                <i class="fas fa-thumbs-down"></i> ÂèçÂØπ: ${opinion.votes.disagree} Á•®
                                            </span>
                                            <span style="color: rgba(255, 255, 255, 0.8); margin-left: auto; font-size: 0.95rem;">
                                                ÈÄöËøáÁéá: <strong style="font-size: 1.2rem; color: ${isAccepted ? '#52c41a' : '#ff4d4f'};">${passRate}%</strong>
                                            </span>
                                        </div>
                                        
                                        <!-- ÂêÑ‰∏ìÂÆ∂ÊäïÁ•®ÁêÜÁî± -->
                                        ${opinion.votes.voters && opinion.votes.voters.length > 0 ? `
                                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                                <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 12px; font-weight: 600;">
                                                    <i class="fas fa-users"></i> ÂêÑ‰∏ìÂÆ∂ÊäïÁ•®ÁêÜÁî±Ôºö
                                                </div>
                                                ${opinion.votes.voters.map(voter => {
                                                    if (voter.isValid === false || voter.vote === 'failed') {
                                                        return `
                                                            <div style="background: rgba(250, 173, 20, 0.1); border-left: 3px solid #faad14; padding: 12px; margin: 8px 0; border-radius: 6px;">
                                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                                                    <span style="background: ${voter.expert.color}; color: white; padding: 3px 8px; border-radius: 50%; font-size: 0.8rem; font-weight: bold; opacity: 0.6;">${voter.expert.avatar}</span>
                                                                    <strong style="color: rgba(255, 255, 255, 0.8);">${voter.expert.name}</strong>
                                                                    <span style="background: rgba(250, 173, 20, 0.3); color: #faad14; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: auto;">‚ö†Ô∏è ÊäïÁ•®Â§±Ë¥•</span>
                                                                </div>
                                                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; line-height: 1.5; padding-left: 30px;">
                                                                    ${voter.reason}
                                                                </div>
                                                            </div>
                                                        `;
                                                    }
                                                    
                                                    const voteColor = voter.vote === 'agree' ? '#52c41a' : '#ff4d4f';
                                                    const voteIcon = voter.vote === 'agree' ? 'thumbs-up' : 'thumbs-down';
                                                    const voteBadge = voter.vote === 'agree' ? '‚úÖ ËµûÊàê' : '‚ùå ÂèçÂØπ';
                                                    
                                                    return `
                                                        <div style="background: rgba(${voter.vote === 'agree' ? '82, 196, 26' : '255, 77, 79'}, 0.08); border-left: 3px solid ${voteColor}; padding: 12px; margin: 8px 0; border-radius: 6px;">
                                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                                                <span style="background: ${voter.expert.color}; color: white; padding: 3px 8px; border-radius: 50%; font-size: 0.8rem; font-weight: bold;">${voter.expert.avatar}</span>
                                                                <strong style="color: white;">${voter.expert.name}</strong>
                                                                <span style="background: rgba(${voter.vote === 'agree' ? '82, 196, 26' : '255, 77, 79'}, 0.3); color: ${voteColor}; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: auto;">
                                                                    <i class="fas fa-${voteIcon}"></i> ${voteBadge}
                                                                </span>
                                                            </div>
                                                            <div style="color: rgba(255, 255, 255, 0.85); font-size: 0.9rem; line-height: 1.6; padding-left: 30px;">
                                                                ${voter.reason}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                `;
            });
            
            recordContent.innerHTML = htmlContent;
        }
        
        // ÂàáÊç¢ËÆ®ËÆ∫ËÆ∞ÂΩïÊü•Áúã
        window.toggleDiscussionRecordView = function() {
            const recordContent = document.getElementById('discussionRecordContent');
            const toggleBtn = document.getElementById('toggleDiscussionRecordBtn');
            
            if (!recordContent || !toggleBtn) return;
            
            if (recordContent.style.display === 'none') {
                recordContent.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Êî∂Ëµ∑ËÆ®ËÆ∫ËØ¶ÊÉÖ';
            } else {
                recordContent.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Â±ïÂºÄÊü•ÁúãËÆ®ËÆ∫ËØ¶ÊÉÖ';
            }
        };
        
        // ‰∏ãËΩΩËÆ®ËÆ∫ËÆ∞ÂΩïÔºàTXTÊ†ºÂºèÔºâ- ÊîπËøõÔºöÂç≥‰ΩøÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπ‰πüÂèØ‰ª•‰∏ãËΩΩÊâÄÊúâËÆ®ËÆ∫
        window.downloadDiscussionRecord = function() {
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÈááÁ∫≥ÁöÑÊàñÊâÄÊúâËÆ®ËÆ∫ÁöÑÔºâ
            if ((!opinions || opinions.length === 0) && (!allDiscussed || allDiscussed.length === 0)) {
                showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂ∞öÊú™ÂºÄÂßãËÆ®ËÆ∫Ôºâ', 'error');
                return;
            }
            
            const recordContent = buildDiscussionRecordText();
            const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            
            const blob = new Blob([recordContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${folderName}/ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const totalDiscussed = allDiscussed.length || opinions.length;
            const totalAccepted = opinions.length;
            showMessage(`‚úÖ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï(TXT)‰∏ãËΩΩÊàêÂäüÔºÅÂåÖÂê´${totalDiscussed}‰∏™ËÆ®ËÆ∫ËßÇÁÇπÔºà${totalAccepted}‰∏™Ë¢´ÈááÁ∫≥Ôºâ`, 'success');
        };
        
        // ‰∏ãËΩΩËÆ®ËÆ∫ËÆ∞ÂΩïÔºàDOCXÊ†ºÂºèÔºâ- ÊîπËøõÔºöÂç≥‰ΩøÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπ‰πüÂèØ‰ª•‰∏ãËΩΩ
        window.downloadDiscussionRecordDocx = function() {
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            if ((!opinions || opinions.length === 0) && (!allDiscussed || allDiscussed.length === 0)) {
                showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂ∞öÊú™ÂºÄÂßãËÆ®ËÆ∫Ôºâ', 'error');
                return;
            }
            
            const recordContent = buildDiscussionRecordText();
            const docxContent = convertToDocxHTML(recordContent, 'ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï');
            const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            
            const blob = new Blob([docxContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${folderName}/ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const totalDiscussed = allDiscussed.length || opinions.length;
            showMessage(`‚úÖ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï(DOCX)‰∏ãËΩΩÊàêÂäüÔºÅÂåÖÂê´${totalDiscussed}‰∏™ËÆ®ËÆ∫ËßÇÁÇπ`, 'success');
        };
        
        // ‰∏ãËΩΩËÆ®ËÆ∫ËÆ∞ÂΩïÔºàMarkdownÊ†ºÂºèÔºâ- ÊîπËøõÔºöÂç≥‰ΩøÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπ‰πüÂèØ‰ª•‰∏ãËΩΩ
        window.downloadDiscussionRecordMd = function() {
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            if ((!opinions || opinions.length === 0) && (!allDiscussed || allDiscussed.length === 0)) {
                showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂ∞öÊú™ÂºÄÂßãËÆ®ËÆ∫Ôºâ', 'error');
                return;
            }
            
            const recordContent = buildDiscussionRecordText();
            const mdContent = convertToMarkdown(recordContent, 'ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï');
            const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
            
            const blob = new Blob([mdContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${folderName}/ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const totalDiscussed = allDiscussed.length || opinions.length;
            showMessage(`‚úÖ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï(MD)‰∏ãËΩΩÊàêÂäüÔºÅÂåÖÂê´${totalDiscussed}‰∏™ËÆ®ËÆ∫ËßÇÁÇπ`, 'success');
        };
        
        // ÊûÑÂª∫ËÆ®ËÆ∫ËÆ∞ÂΩïÊñáÊú¨ÂÜÖÂÆπÔºàÂ¢ûÂº∫ÁâàÔºåÂåÖÂê´ÂÆåÊï¥ËøáÁ®ãÔºåÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑËßÇÁÇπÔºâ
        function buildDiscussionRecordText() {
            const opinions = getAllAcceptedOpinions();
            const allDiscussed = window.allDiscussedOpinions || [];
            
            // ‰ºòÂÖà‰ΩøÁî®ÊâÄÊúâËÆ®ËÆ∫ËÆ∞ÂΩïÔºàÂåÖÂê´Êú™ÈááÁ∫≥ÁöÑÔºâ
            const opinionsToRecord = allDiscussed.length > 0 ? allDiscussed : opinions;
            
            let recordContent = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            recordContent += `                     ÊïôÁ†îÁªÑËÆ®ËÆ∫ÂÆåÊï¥ËÆ∞ÂΩï\n`;
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            recordContent += `üìÖ ÁîüÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}\n`;
            recordContent += `üéØ Á≥ªÁªüÂêçÁß∞ÔºöEduSymphony Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü\n`;
            recordContent += `üë• ÂèÇ‰∏é‰∏ìÂÆ∂Ôºö${agents.map(a => a.name).join('„ÄÅ')}\n`;
            recordContent += `üé§ ‰∏ªÊåÅ‰∫∫ÔºöÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºàQwenÈ©±Âä®Ôºâ\n`;
            recordContent += `üìä ÈááÁ∫≥ÈòàÂÄºÔºö40%ÔºàÊäïÁ•®ÂêåÊÑèÁéáÈúÄ‚â•40%Ôºâ\n\n`;
            
            // ÊåâÁ´†ËäÇÊï¥ÁêÜËÆ®ËÆ∫ÂÜÖÂÆπ
            const opinionsBySection = {};
            let totalOpinions = 0;
            let acceptedCount = 0;
            let rejectedCount = 0;
            
            // Êî∂ÈõÜÊâÄÊúâËÆ®ËÆ∫ÁöÑËßÇÁÇπÔºàÂåÖÊã¨Êú™ÈááÁ∫≥ÁöÑÔºâ
            opinionsToRecord.forEach(opinion => {
                const section = opinion.section || 'ÂÖ∂‰ªñ';
                if (!opinionsBySection[section]) {
                    opinionsBySection[section] = [];
                }
                opinionsBySection[section].push(opinion);
                totalOpinions++;
                
                // ÁªüËÆ°ÈááÁ∫≥ÊÉÖÂÜµÔºà‰ΩøÁî®40%ÈòàÂÄºÔºâ
                const totalVotes = opinion.votes ? (opinion.votes.agree + opinion.votes.disagree) : 0;
                const passRate = totalVotes > 0 ? (opinion.votes.agree / totalVotes) : 0;
                if (passRate >= 0.4) {
                    acceptedCount++;
                } else {
                    rejectedCount++;
                }
            });
            
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            recordContent += `                          ËÆ®ËÆ∫ÁªüËÆ°Ê¶ÇËßà\n`;
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            recordContent += `üìä ËÆ®ËÆ∫‰∏ªÈ¢òÊï∞Ôºö${Object.keys(opinionsBySection).length} ‰∏™\n`;
            recordContent += `üí¨ ÊÄªËßÇÁÇπÊï∞Ôºö${totalOpinions} ‰∏™\n`;
            recordContent += `‚úÖ ÈááÁ∫≥Âª∫ËÆÆÔºö${acceptedCount} ‰∏™ÔºàÂêåÊÑèÁéá‚â•40%ÔºåÂ∑≤ËûçÂÖ•‰ºòÂåñÊïôÊ°àÔºâ\n`;
            recordContent += `‚ùå Êú™ÈÄöËøáÔºö${rejectedCount} ‰∏™ÔºàÂêåÊÑèÁéá<40%ÔºåÊú™ÈááÁ∫≥Ôºâ\n`;
            recordContent += `üë• ÂèÇ‰∏éÊäïÁ•®Ôºö${agents.length} ‰ΩçAI‰∏ìÂÆ∂\n`;
            recordContent += `üéØ ÈááÁ∫≥ÈòàÂÄºÔºö40%ÔºàÊäïÁ•®ÂêåÊÑèÁéáÈúÄ‚â•40%Êâç‰ºöË¢´ÈááÁ∫≥Ôºâ\n\n`;
            
            // Â¶ÇÊûúÊ≤°ÊúâÈááÁ∫≥ËßÇÁÇπÔºåÁâπÂà´ËØ¥Êòé
            if (acceptedCount === 0 && totalOpinions > 0) {
                recordContent += `‚ö†Ô∏è ÁâπÂà´ËØ¥ÊòéÔºö\n`;
                recordContent += `   Êú¨Ê¨°ËÆ®ËÆ∫ÁöÑÊâÄÊúâ${totalOpinions}‰∏™ËßÇÁÇπÂùáÊú™ËææÂà∞40%ÈááÁ∫≥ÈòàÂÄº„ÄÇ\n`;
                recordContent += `   ËøôÂèØËÉΩËØ¥ÊòéÂàùÂßãÊïôÊ°àÂ∑≤ËæÉ‰∏∫ÂÆåÂñÑÔºåÊàñ‰∏ìÂÆ∂ÊÑèËßÅÂ≠òÂú®ËæÉÂ§ßÂàÜÊ≠ß„ÄÇ\n`;
                recordContent += `   ‰ºòÂåñÊïôÊ°àÂ∞ÜÂü∫‰∫éÂàùÂßãÊïôÊ°àÂÜÖÂÆπÁîüÊàê„ÄÇ\n\n`;
            }
            
            // ËæìÂá∫ËØ¶ÁªÜËÆ®ËÆ∫ËÆ∞ÂΩï
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            recordContent += `                          ËØ¶ÁªÜËÆ®ËÆ∫ËÆ∞ÂΩï\n`;
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            Object.entries(opinionsBySection).forEach(([section, opinions], sectionIndex) => {
                recordContent += `\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
                recordContent += `‚ïë  ËÆ®ËÆ∫‰∏ªÈ¢ò ${sectionIndex + 1}Ôºö„Äê${section}„Äë\n`;
                recordContent += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n`;
                
                opinions.forEach((opinion, index) => {
                    const totalVotes = opinion.votes ? (opinion.votes.agree + opinion.votes.disagree) : 0;
                    const passRate = totalVotes > 0 ? ((opinion.votes.agree / totalVotes) * 100).toFixed(1) : 0;
                    const isAccepted = passRate >= 40; // ‰ΩøÁî®40%ÈòàÂÄº
                    
                    recordContent += `‚îå‚îÄ ËßÇÁÇπ ${index + 1} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                    recordContent += `‚îÇ\n`;
                    recordContent += `‚îÇ üë§ ‰∏ìÂÆ∂Ôºö${opinion.expert.name}Ôºà${opinion.expert.specialty}Ôºâ\n`;
                    recordContent += `‚îÇ üìå Áä∂ÊÄÅÔºö${isAccepted ? '‚úÖ Â∑≤ÈááÁ∫≥' : '‚ùå Êú™ÈÄöËøá'}\n`;
                    recordContent += `‚îÇ\n`;
                    recordContent += `‚îÇ üí° ‰∏ìÂÆ∂ËßÇÁÇπÔºö\n`;
                    recordContent += `‚îÇ ${opinion.content.split('\n').join('\n‚îÇ ')}\n`;
                    recordContent += `‚îÇ\n`;
                    
                    if (opinion.votes) {
                        recordContent += `‚îÇ üìä ÊäïÁ•®ÁªüËÆ°Ôºö\n`;
                        recordContent += `‚îÇ    ‚úÖ ËµûÊàêÔºö${opinion.votes.agree} Á•®\n`;
                        recordContent += `‚îÇ    ‚ùå ÂèçÂØπÔºö${opinion.votes.disagree} Á•®\n`;
                        recordContent += `‚îÇ    üìà ÂêåÊÑèÁéáÔºö${passRate}% ${isAccepted ? 'Ôºà‚â•40%ÔºåÂ∑≤ÈááÁ∫≥Ôºâ' : 'Ôºà<40%ÔºåÊú™ÈááÁ∫≥Ôºâ'}\n`;
                        recordContent += `‚îÇ\n`;
                        
                        // Ê∑ªÂä†ËØ¶ÁªÜÁöÑÊäïÁ•®ÁêÜÁî±
                        if (opinion.votes.voters && opinion.votes.voters.length > 0) {
                            recordContent += `‚îÇ üó≥Ô∏è  ÂêÑ‰∏ìÂÆ∂ÊäïÁ•®ËØ¶ÊÉÖÔºö\n`;
                            recordContent += `‚îÇ\n`;
                            
                            opinion.votes.voters.forEach((voter, voterIndex) => {
                                if (voter.isValid === false || voter.vote === 'failed') {
                                    recordContent += `‚îÇ    ${voterIndex + 1}. ${voter.expert.name}Ôºö‚ö†Ô∏è ÊäïÁ•®Â§±Ë¥•\n`;
                                    recordContent += `‚îÇ       ÁêÜÁî±Ôºö${voter.reason}\n`;
                                } else {
                                    const voteEmoji = voter.vote === 'agree' ? '‚úÖ' : '‚ùå';
                                    const voteText = voter.vote === 'agree' ? 'ËµûÊàê' : 'ÂèçÂØπ';
                                    recordContent += `‚îÇ    ${voterIndex + 1}. ${voter.expert.name}Ôºö${voteEmoji} ${voteText}\n`;
                                    recordContent += `‚îÇ       ÁêÜÁî±Ôºö${voter.reason.split('\n').join('\n‚îÇ            ')}\n`;
                                }
                                if (voterIndex < opinion.votes.voters.length - 1) {
                                    recordContent += `‚îÇ\n`;
                                }
                            });
                        }
                    }
                    
                    recordContent += `‚îÇ\n`;
                    recordContent += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                });
            });
            
            recordContent += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            recordContent += `                          ËÆ®ËÆ∫ÊÄªÁªì\n`;
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            recordContent += `üìã ËÆ®ËÆ∫ÊàêÊûúÔºö\n`;
            recordContent += `   ‚Ä¢ ÂÖ±ËøõË°å ${Object.keys(opinionsBySection).length} ‰∏™‰∏ªÈ¢òÁöÑÊ∑±ÂÖ•ËÆ®ËÆ∫\n`;
            recordContent += `   ‚Ä¢ ÈááÁ∫≥‰∫Ü ${acceptedCount} ‰∏™‰∏ìÂÆ∂Âª∫ËÆÆ\n`;
            recordContent += `   ‚Ä¢ ${rejectedCount} ‰∏™ËßÇÁÇπÂõ†ÊäïÁ•®Êú™ÈÄöËøáËÄåÊú™ÈááÁ∫≥\n`;
            recordContent += `   ‚Ä¢ Ê∂âÂèäÁ´†ËäÇÔºö${Object.keys(opinionsBySection).join('„ÄÅ')}\n\n`;
            recordContent += `üìù Â∫îÁî®ÊÉÖÂÜµÔºö\n`;
            recordContent += `   ‚Ä¢ ÊâÄÊúâÈááÁ∫≥ÁöÑÂª∫ËÆÆÂ∑≤ËûçÂêàÂà∞‰ºòÂåñÊïôÊ°à‰∏≠\n`;
            recordContent += `   ‚Ä¢ Á∫ØÂáÄÁâàÊïôÊ°àÔºöÂÆåÊï¥ËûçÂêàÂêéÁöÑÊïôÊ°àÔºàÊó†Ê†áÊ≥®Ôºâ\n`;
            recordContent += `   ‚Ä¢ Ê†áÊ≥®ÁâàÊïôÊ°àÔºö‰ΩøÁî®„ÄêÂéüÊñá„Äë‚Üí„Äê‰ºòÂåñ„ÄëÊ†áÊ≥®ÊØèÂ§ÑÊîπËøõ\n`;
            recordContent += `   ‚Ä¢ ÊØè‰∏™‰ºòÂåñÁÇπÈÉΩÊòéÁ°ÆÊ†áÊ≥®‰∫ÜÊù•Ê∫ê‰∏ìÂÆ∂\n\n`;
            recordContent += `üë• ‰∏ìÂÆ∂Ë¥°ÁåÆÁªüËÆ°Ôºö\n`;
            
            // ÁªüËÆ°ÊØè‰Ωç‰∏ìÂÆ∂ÁöÑË¥°ÁåÆ
            const expertStats = {};
            opinions.forEach(opinion => {
                const expertName = opinion.expert.name;
                if (!expertStats[expertName]) {
                    expertStats[expertName] = {
                        count: 0,
                        specialty: opinion.expert.specialty
                    };
                }
                expertStats[expertName].count++;
            });
            
            Object.entries(expertStats).forEach(([name, stats]) => {
                recordContent += `   ‚Ä¢ ${name}Ôºà${stats.specialty}ÔºâÔºö${stats.count} ‰∏™Âª∫ËÆÆË¢´ÈááÁ∫≥\n`;
            });
            
            recordContent += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            recordContent += `üìå ËØ¥ÊòéÔºö\n`;
            recordContent += `Êú¨ËÆ∞ÂΩïÂÆåÊï¥‰øùÂ≠ò‰∫ÜÊïôÁ†îÁªÑËÆ®ËÆ∫ÁöÑÂÖ®ËøáÁ®ãÔºåÂåÖÊã¨Ôºö\n`;
            recordContent += `   1. ÂêÑ‰∏ìÂÆ∂ÈíàÂØπÂàùÂßãÊïôÊ°à‰∏çÂêåÁ´†ËäÇÊèêÂá∫ÁöÑÂÖ∑‰ΩìÂª∫ËÆÆ\n`;
            recordContent += `   2. ÂÖ∂‰ªñ‰∏ìÂÆ∂ÂØπÊØè‰∏™Âª∫ËÆÆÁöÑÊäïÁ•®ÂíåËØ¶ÁªÜÁêÜÁî±\n`;
            recordContent += `   3. ÊØè‰∏™Âª∫ËÆÆÁöÑÈÄöËøáÁéáÂíåÊúÄÁªàÈááÁ∫≥ÊÉÖÂÜµ\n`;
            recordContent += `   4. ÊâÄÊúâÈááÁ∫≥Âª∫ËÆÆÁöÑÂ∫îÁî®ËøΩË∏™ÔºàËßÅÊ†áÊ≥®ÁâàÊïôÊ°àÔºâ\n\n`;
            recordContent += `üí° Âª∫ËÆÆÔºö\n`;
            recordContent += `   ‚Ä¢ ÂèÇËÄÉÊ†áÊ≥®ÁâàÊïôÊ°àÔºåÊü•ÁúãÊØè‰∏™Âª∫ËÆÆÂ¶Ç‰ΩïËûçÂÖ•ÊúÄÁªàÊïôÊ°à\n`;
            recordContent += `   ‚Ä¢ ÂØπÁÖßÁ∫ØÂáÄÁâàÊïôÊ°àÔºåÁõ¥Êé•‰ΩøÁî®‰ºòÂåñÂêéÁöÑÂÆåÊï¥ÂÜÖÂÆπ\n`;
            recordContent += `   ‚Ä¢ Êü•Áúã‰∏ìÂÆ∂Ë¥°ÁåÆË°®Ôºå‰∫ÜËß£ÂêÑ‰∏ìÂÆ∂ÁöÑ‰∏ì‰∏öË¥°ÁåÆ\n\n`;
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            recordContent += `ÁîüÊàêÁ≥ªÁªüÔºöEduSymphony Â§öAgentÊïôÊ°àÊïôÁ†îÁ≥ªÁªü\n`;
            recordContent += `ÂºÄÂèëÂõ¢ÈòüÔºöÈªÑÊµ∑ÂçöÂ£´ ‚Ä¢ Èíü‰∏ΩÈúûÂçöÂ£´ ‚Ä¢ Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü\n`;
            recordContent += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            return recordContent;
        };
        
        // ‰∏ÄÈîÆ‰∏ãËΩΩÊâÄÊúâÊïôÂ≠¶ÊùêÊñô
        window.downloadAllTeachingMaterials = function() {
            if (!window.initialTeachingPlan && !window.finalTeachingPlanClean && !window.finalTeachingPlanAnnotated) {
                showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊïôÂ≠¶ÊùêÊñô', 'error');
                return;
            }
            
            let downloadCount = 0;
            const downloads = [];
            
            // ÂàùÂßãÊïôÊ°à
            if (window.initialTeachingPlan && window.initialTeachingPlan.trim().length >= 50) {
                downloads.push({ type: 'initial', format: 'txt' });
                downloadCount++;
            }
            
            // Á∫ØÂáÄÁâàÊïôÊ°à
            if (window.finalTeachingPlanClean && window.finalTeachingPlanClean.trim().length >= 50) {
                downloads.push({ type: 'clean', format: 'txt' });
                downloadCount++;
            }
            
            // Ê†áÊ≥®ÁâàÊïôÊ°à
            if (window.finalTeachingPlanAnnotated && window.finalTeachingPlanAnnotated.trim().length >= 50) {
                downloads.push({ type: 'annotated', format: 'txt' });
                downloadCount++;
            }
            
            // ËÆ®ËÆ∫ËÆ∞ÂΩï
            const opinions = getAllAcceptedOpinions();
            if (opinions && opinions.length > 0) {
                downloads.push({ type: 'discussion', format: 'txt' });
                downloadCount++;
            }
            
            if (downloadCount === 0) {
                showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊúâÊïàÂÜÖÂÆπ', 'error');
                return;
            }
            
            // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
            if (!confirm(`ÂáÜÂ§á‰∏ãËΩΩ ${downloadCount} ‰∏™Êñá‰ª∂Ôºö\n\n${downloads.map(d => {
                if (d.type === 'initial') return '‚Ä¢ ÂàùÊ≠•ÊïôÊ°à.txt';
                if (d.type === 'clean') return '‚Ä¢ ‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txt';
                if (d.type === 'annotated') return '‚Ä¢ ‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txt';
                if (d.type === 'discussion') return '‚Ä¢ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txt';
            }).join('\n')}\n\nÁ°ÆÂÆö‰∏ãËΩΩÂêóÔºü`)) {
                return;
            }
            
            showMessage(`üì• Ê≠£Âú®‰∏ãËΩΩ ${downloadCount} ‰∏™Êñá‰ª∂...`, 'info');
            
            // ‰æùÊ¨°‰∏ãËΩΩÂêÑ‰∏™Êñá‰ª∂Ôºà‰ΩøÁî®Âª∂ËøüÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢Ôºâ
            downloads.forEach((download, index) => {
                setTimeout(() => {
                    if (download.type === 'initial') {
                        downloadInitialPlan('txt');
                    } else if (download.type === 'clean') {
                        downloadFusedPlan('clean', 'txt');
                    } else if (download.type === 'annotated') {
                        downloadFusedPlan('annotated', 'txt');
                    } else if (download.type === 'discussion') {
                        downloadDiscussionRecord();
                    }
                }, index * 800); // ÊØè‰∏™Êñá‰ª∂Èó¥Èöî800ms
            });
            
            setTimeout(() => {
                showMessage(`‚úÖ ÊâÄÊúâÊñá‰ª∂‰∏ãËΩΩÂÆåÊàêÔºÅÂÖ± ${downloadCount} ‰∏™Êñá‰ª∂`, 'success');
            }, downloads.length * 800 + 1000);
        };
        
        // ‰∏ãËΩΩ‰∏§‰∏™ÁâàÊú¨ÁöÑÊïôÊ°à
        window.downloadBothVersions = function() {
            if (!window.finalTeachingPlanClean || !window.finalTeachingPlanAnnotated) {
                showMessage('ÊïôÊ°àÊú™ÂÆåÂÖ®ÁîüÊàê', 'error');
                return;
            }
            
            // È™åËØÅÂÜÖÂÆπ‰∏ç‰∏∫Á©∫
            if (window.finalTeachingPlanClean.trim().length < 50 || window.finalTeachingPlanAnnotated.trim().length < 50) {
                showMessage('‚ùå ÊïôÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÊàñËøáÁü≠ÔºåÊó†Ê≥ï‰∏ãËΩΩ', 'error');
                return;
            }
            
            // ‰∏ãËΩΩÁ∫ØÂáÄÁâà
            setTimeout(() => downloadFusedPlan('clean', 'txt'), 100);
            // ‰∏ãËΩΩÊ†áÊ≥®Áâà
            setTimeout(() => downloadFusedPlan('annotated', 'txt'), 600);
            
            showMessage('‚úÖ Ê≠£Âú®‰∏ãËΩΩ‰∏§‰∏™ÁâàÊú¨ÁöÑÊïôÊ°à...', 'success');
        };
        
        // ÂØºÂá∫Êñ∞ÊïôÊ°à‰∏∫PDFÔºàÊîØÊåÅÁ∫ØÂáÄÁâàÂíåÊ†áÊ≥®ÁâàÔºâ- Êñ∞ÊñπÊ°àÔºöMarkdown ‚Üí PDFÊµÅÁ®ã
        window.downloadFusedPlanPDF = async function(version = 'clean') {
            let content, filename, title;
            
            if (version === 'clean') {
                if (!window.finalTeachingPlanClean) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÁ∫ØÂáÄÁâàÊïôÊ°à', 'error');
                    return;
                }
                content = window.finalTeachingPlanClean;
                filename = '‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà';
                title = '‰ºòÂåñÊïôÊ°àÔºàÁ∫ØÂáÄÁâàÔºâ';
            } else if (version === 'annotated') {
                if (!window.finalTeachingPlanAnnotated) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊ†áÊ≥®ÁâàÊïôÊ°à', 'error');
                    return;
                }
                content = window.finalTeachingPlanAnnotated;
                filename = '‰ºòÂåñÊïôÊ°à_ÂØπÊØîÊ†áÊ≥®Áâà';
                title = '‰ºòÂåñÊïôÊ°àÔºàÂØπÊØîÊ†áÊ≥®ÁâàÔºâ';
            } else {
                // ÂÖºÂÆπÊóß‰ª£Á†Å
                if (!window.finalTeachingPlan) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊñ∞ÊïôÊ°à', 'error');
                    return;
                }
                content = window.finalTeachingPlan;
                filename = 'ËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°à';
                title = 'ËûçÂêàÂêéÁöÑÊñ∞ÊïôÊ°à';
            }
            
            // ‰∏•Ê†ºÈ™åËØÅÂÜÖÂÆπ‰∏ç‰∏∫Á©∫
            const trimmedContent = content.trim();
            if (!trimmedContent || trimmedContent.length < 50) {
                showMessage('‚ùå ÊïôÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÊàñËøáÁü≠ÔºåÊó†Ê≥ïÂØºÂá∫PDF', 'error');
                return;
            }
            
            console.log(`üìÑ ÂáÜÂ§áÂØºÂá∫PDF - ÁâàÊú¨Ôºö${version}ÔºåÂÜÖÂÆπÈïøÂ∫¶Ôºö${trimmedContent.length}Â≠óÁ¨¶`);
            
            if (!checkPDFLibrary()) {
                showMessage('‚ö†Ô∏è PDFÂ∫ìÊú™Âä†ËΩΩÔºåÂª∫ËÆÆ‰∏ãËΩΩMarkdownÂêéÊâãÂä®ËΩ¨Êç¢', 'info');
                downloadFusedPlan(version, 'md');
                return;
            }
            
            try {
                showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨1Ê≠•ÔºöÁîüÊàêMarkdownÊñáÊ°£Ôºâ...', 'info');
                
                // ===== Á¨¨‰∏ÄÊ≠•ÔºöÁîüÊàêMarkdownÊ†ºÂºèÊñáÊ°£ =====
                const markdownContent = convertToMarkdown(content, title);
                console.log('‚úÖ Ê≠•È™§1ÂÆåÊàê - MarkdownÁîüÊàêÔºåÈïøÂ∫¶:', markdownContent.length);
                
                if (!markdownContent || markdownContent.length < 100) {
                    throw new Error('MarkdownÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
                }
                
                showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨2Ê≠•ÔºöÂ∞ÜMarkdownÊ∏≤Êüì‰∏∫HTMLÔºâ...', 'info');
                
                // ===== Á¨¨‰∫åÊ≠•ÔºöÂ∞ÜMarkdownËΩ¨Êç¢‰∏∫Ê†ºÂºèÂåñÁöÑHTML =====
                const pdfHTML = convertMarkdownToHTML(markdownContent, title);
                console.log('‚úÖ Ê≠•È™§2ÂÆåÊàê - MarkdownÂ∑≤ËΩ¨‰∏∫HTMLÔºåÈïøÂ∫¶:', pdfHTML.length);
                
                if (!pdfHTML || pdfHTML.length < 500) {
                    throw new Error('MarkdownËΩ¨HTMLÂ§±Ë¥•');
                }
                
                showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨3Ê≠•ÔºöÂä†ËΩΩHTMLÊñáÊ°£Ôºâ...', 'info');
                
                // ===== Á¨¨‰∏âÊ≠•ÔºöÂ∞ÜHTMLÂä†ËΩΩÂà∞iframe‰∏≠ËøõË°åÊ∏≤Êüì =====
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 210mm; height: 297mm; border: none; background: white;';
                document.body.appendChild(iframe);
                
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(pdfHTML);
                iframeDoc.close();
                
                // Á≠âÂæÖÊñáÊ°£ÂÆåÂÖ®Ê∏≤Êüì
                await new Promise(resolve => setTimeout(resolve, 600));
                console.log('‚úÖ Ê≠•È™§3ÂÆåÊàê - HTMLÊñáÊ°£Â∑≤Âä†ËΩΩÂπ∂Ê∏≤Êüì');
                
                // È™åËØÅÊ∏≤ÊüìÂêéÁöÑÂÜÖÂÆπ
                const iframeBody = iframeDoc.body;
                const renderedTextContent = iframeBody.textContent || iframeBody.innerText || '';
                
                console.log('üìä HTMLÊñáÊ°£Ê∏≤ÊüìÈ™åËØÅ:', {
                    'bodyÂ≠òÂú®': !!iframeBody,
                    'bodyÂÖÉÁ¥†Êï∞': iframeBody.children.length,
                    'ÊñáÊú¨ÂÜÖÂÆπÈïøÂ∫¶': renderedTextContent.length,
                    'ÂÜÖÂÆπÈ¢ÑËßàÔºàÂâç300Â≠óÔºâ': renderedTextContent.substring(0, 300)
                });
                
                if (renderedTextContent.trim().length < 50) {
                    document.body.removeChild(iframe);
                    throw new Error('HTMLÊñáÊ°£Ê∏≤ÊüìÂêéÂÜÖÂÆπ‰∏∫Á©∫');
                }
                
                showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨4Ê≠•ÔºöËΩ¨Êç¢‰∏∫PDFÊñá‰ª∂Ôºâ...', 'info');
                
                // ===== Á¨¨ÂõõÊ≠•Ôºö‰ªéÊ∏≤ÊüìÁöÑHTMLËΩ¨Êç¢‰∏∫PDFÂπ∂ËæìÂá∫‰∏∫Blob =====
                const folderName = window.currentFolderName || `ËÆ®ËÆ∫ÁªìÊûú_${extractCourseTitle()}_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}`;
                const opt = {
                    margin: [15, 15, 15, 15],
                    filename: `${folderName.split('/').pop()}_${filename}.pdf`,
                    image: { 
                        type: 'jpeg', 
                        quality: 0.95
                    },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        logging: true,
                        windowWidth: iframeBody.scrollWidth,
                        windowHeight: iframeBody.scrollHeight,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true
                    },
                    pagebreak: { 
                        mode: ['avoid-all', 'css', 'legacy']
                    }
                };
                
                console.log('üìÑ ÂºÄÂßã‰ªéHTMLËΩ¨Êç¢‰∏∫PDFÔºåÈÖçÁΩÆ:', opt);
                
                // ËΩ¨Êç¢‰∏∫PDF Blob
                const pdfResult = await html2pdf().set(opt).from(iframeBody).outputPdf('blob');
                
                console.log('üìä PDFÁîüÊàêÁªìÊûúÈ™åËØÅ:', {
                    'PDFÂØπË±°Á±ªÂûã': typeof pdfResult,
                    'PDFÂ§ßÂ∞è': pdfResult ? pdfResult.size : 0,
                    'PDFÊòØÂê¶‰∏∫Blob': pdfResult instanceof Blob
                });
                
                // ===== Á¨¨‰∫îÊ≠•ÔºöÈ™åËØÅPDFÊòØÂê¶Ê≠£Á°ÆÂÜôÂÖ•ÂÜÖÂÆπ =====
                if (!pdfResult || !(pdfResult instanceof Blob)) {
                    throw new Error('PDFÁîüÊàêÂ§±Ë¥•ÔºåËøîÂõûÂØπË±°Êó†Êïà');
                }
                
                if (pdfResult.size < 1000) {
                    throw new Error(`PDFÊñá‰ª∂ËøáÂ∞è(${pdfResult.size}Â≠óËäÇ)ÔºåÂèØËÉΩÂÜÖÂÆπÊú™ÂÜôÂÖ•`);
                }
                
                console.log('‚úÖ Ê≠•È™§5ÂÆåÊàê - PDFÂÜÖÂÆπÈ™åËØÅÈÄöËøáÔºåÂ§ßÂ∞è:', (pdfResult.size / 1024).toFixed(2), 'KB');
                
                showMessage('üìÑ Ê≠£Âú®ÁîüÊàêPDFÔºàÁ¨¨5Ê≠•Ôºö‰øùÂ≠òPDFÊñá‰ª∂Ôºâ...', 'info');
                
                // ===== Á¨¨ÂÖ≠Ê≠•Ôºö‰∏ãËΩΩPDFÊñá‰ª∂ =====
                const url = URL.createObjectURL(pdfResult);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Áü≠ÊöÇÂª∂ËøüÂêéÊ∏ÖÁêÜURL
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                // Ê∏ÖÁêÜiframe
                document.body.removeChild(iframe);
                
                console.log(`‚úÖ PDFÂØºÂá∫ÊàêÂäüÔºàÂÆåÊï¥ÊµÅÁ®ãÔºöÂéüÂßãÂÜÖÂÆπ ‚Üí Markdown ‚Üí HTML ‚Üí PDFÔºâ`);
                console.log('üìä ÊúÄÁªàPDFÊñá‰ª∂:', {
                    'Êñá‰ª∂Âêç': filename + '.pdf',
                    'Êñá‰ª∂Â§ßÂ∞è': (pdfResult.size / 1024).toFixed(2) + ' KB',
                    'ÂéüÂßãÂÜÖÂÆπÈïøÂ∫¶': content.length,
                    'MarkdownÈïøÂ∫¶': markdownContent.length,
                    'HTMLÈïøÂ∫¶': pdfHTML.length,
                    'Ê∏≤ÊüìÊñáÊú¨ÈïøÂ∫¶': renderedTextContent.length
                });
                
                showMessage(`‚úÖ ${filename}.pdf ÂØºÂá∫ÊàêÂäüÔºÅÂ§ßÂ∞èÔºö${(pdfResult.size / 1024).toFixed(2)} KB`, 'success');
                
            } catch (error) {
                console.error('‚ùå PDFÂØºÂá∫Â§±Ë¥•:', error);
                
                // Ê∏ÖÁêÜÊÆãÁïôÂÖÉÁ¥†
                document.querySelectorAll('iframe[style*="left: -9999px"], div[style*="left: -9999px"]').forEach(el => {
                    try { if (document.body.contains(el)) document.body.removeChild(el); } catch (e) {}
                });
                
                // ÈôçÁ∫ßÊñπÊ°àÔºö‰∏ãËΩΩMarkdownÊàñDOCXÊâãÂä®ËΩ¨Êç¢
                if (confirm('‚ùå ‰ªéMarkdownËΩ¨Êç¢PDFÂ§±Ë¥•\n\n' + error.message + '\n\nÊé®ËçêÊñπÊ°àÔºö\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n1Ô∏è‚É£ ‰∏ãËΩΩMarkdownÊàñDOCXÊñá‰ª∂\n2Ô∏è‚É£ Áî®Typora/WordÊâìÂºÄ\n3Ô∏è‚É£ ÂØºÂá∫‰∏∫PDFÊ†ºÂºè\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nÊòØÂê¶Áé∞Âú®‰∏ãËΩΩMarkdownÔºü')) {
                    downloadFusedPlan(version, 'md');
                    showMessage('üí° MarkdownÂ∑≤‰∏ãËΩΩÔºåÂèØÁî®TyporaÊàñÂÖ∂‰ªñÂ∑•ÂÖ∑ËΩ¨‰∏∫PDF', 'info');
                } else {
                    showMessage('‚ùå PDFÂØºÂá∫Â∑≤ÂèñÊ∂à', 'error');
                }
            }
        };

        // Ë∞ÉÁî®‰∏ªÊåÅ‰∫∫APIÔºà‰ΩøÁî®QwenÔºâ
        async function callModeratorAPI(prompt) {
            try {
                const response = await fetch(API_CONFIG.qwen.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.qwen.apiKey}`
                    },
                    body: JSON.stringify({
                        model: moderator.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÊïôÁ†îÁªÑ‰∏ªÊåÅ‰∫∫ÔºåÊìÖÈïøÂºïÂØºËÆ®ËÆ∫„ÄÅÊääÊéßËäÇÂ•è„ÄÅÊÄªÁªìË¶ÅÁÇπ„ÄÇ‰Ω†ÁöÑÂèëË®ÄÁÆÄÊ¥Å„ÄÅ‰∏ì‰∏ö„ÄÅÊúâÊù°ÁêÜ„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                return convertToTraditionalChinese(content);
            } catch (error) {
                console.error('‰∏ªÊåÅ‰∫∫APIË∞ÉÁî®Â§±Ë¥•:', error);
                return null;
            }
        }

        // ÊóßÁâàÊú¨ÁöÑËÆ®ËÆ∫ÂáΩÊï∞Ôºà‰øùÁïô‰Ωú‰∏∫Â§áÁî®Ôºâ
        function addDiscussion_old() {
            const discussionArea = document.getElementById('discussionArea');
            const discussions = generateExpertDiscussions();
            let discussionIndex = 0;

            function addDiscussion() {
                if (discussionIndex >= discussions.length) {
                    setTimeout(() => {
                        startStage3Integration();
                    }, 1000);
                    return;
                }

                const discussion = discussions[discussionIndex];
                const discussionItem = document.createElement('div');
                discussionItem.className = 'discussion-item';
                discussionItem.style.opacity = '0';
                discussionItem.style.transform = 'translateY(20px)';

                discussionItem.innerHTML = `
                    <div class="discussion-header">
                        <div class="discussion-author">${discussion.expert}</div>
                        <div class="discussion-type" style="background: ${getDiscussionTypeConfig(discussion.type).color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">
                            ${getDiscussionTypeConfig(discussion.type).label}
                        </div>
                    </div>
                    <div class="discussion-content">${discussion.content}</div>
                    <div class="discussion-timestamp">${new Date().toLocaleTimeString()}</div>
                `;

                discussionArea.appendChild(discussionItem);

                // Âä®ÁîªÊïàÊûú
                setTimeout(() => {
                    discussionItem.style.transition = 'all 0.5s ease';
                    discussionItem.style.opacity = '1';
                    discussionItem.style.transform = 'translateY(0)';

                    // Ëá™Âä®ÊªöÂ±èÂà∞Â∫ïÈÉ®
                    discussionArea.scrollTo({
                        top: discussionArea.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);

                discussionIndex++;
                const progress = 10 + (discussionIndex / discussions.length) * 80;
                updateProgress('stage2Progress', 'stage2ProgressText',
                    progress, `${discussion.expert}ÂèëË°®ËßÇÁÇπ... (${discussionIndex}/${discussions.length})`);

                setTimeout(addDiscussion, 2000);
            }

            setTimeout(addDiscussion, 1000);
        }

        // Ëé∑ÂèñËÆ®ËÆ∫Á±ªÂûãÈÖçÁΩÆ
        function getDiscussionTypeConfig(type) {
            const typeConfigs = {
                'analysis_based': { label: 'Âü∫‰∫éËß£ÊûêÂàÜÊûê', color: '#52c41a' },
                'innovation_focused': { label: 'ÂàõÊñ∞ÊïôÂ≠¶ËßÜËßí', color: '#1890ff' },
                'participation_focused': { label: 'ÂèÇ‰∏éÂ∫¶ÂàÜÊûê', color: '#13c2c2' },
                'evaluation_focused': { label: 'ËØÑ‰ª∑‰ΩìÁ≥ªÂàÜÊûê', color: '#722ed1' },
                'global_perspective': { label: 'ÂõΩÈôÖÂåñËßÜÈáé', color: '#fa8c16' },
                'deep_learning': { label: 'Ê∑±Â∫¶Â≠¶‰π†Âª∫ËÆÆ', color: '#eb2f96' },
                'comprehensive_summary': { label: 'ÁªºÂêàÊÄªÁªì', color: '#52c41a' }
            };

            return typeConfigs[type] || { label: 'ËÆ®ËÆ∫', color: '#666' };
        }

        // ÁîüÊàê‰∏ìÂÆ∂ËÆ®ËÆ∫ÂÜÖÂÆπÔºàÂü∫‰∫éÂÆûÈôÖËß£ÊûêÂÜÖÂÆπÔºâ
        function generateExpertDiscussions() {
            if (!parsedFileContent) {
                return [];
            }

            // Âü∫‰∫éËß£ÊûêÂÜÖÂÆπÁîüÊàêÂä®ÊÄÅËÆ®ËÆ∫
            const discussions = [];

            // Ê†πÊçÆËß£ÊûêÂÜÖÂÆπ‰∏≠ÁöÑÂÖ≥ÈîÆ‰ø°ÊÅØÁîüÊàêËÆ®ËÆ∫
            const hasObjectives = parsedFileContent.includes('ÊïôÂ≠¶ÁõÆÊ†á') || parsedFileContent.includes('ÊïôÂ≠¶ÁõÆÊ†áÔºö');
            const hasActivities = parsedFileContent.includes('ÊïôÂ≠¶ËøáÁ®ã') || parsedFileContent.includes('ÊïôÂ≠¶Ê¥ªÂä®');
            const hasEvaluation = parsedFileContent.includes('ËØÑ‰ª∑') || parsedFileContent.includes('ËØÑ‰ª∑ÊñπÂºè');
            const hasOptimization = parsedFileContent.includes('‰ºòÂåñÂª∫ËÆÆ');

            // Âü∫‰∫éËß£ÊûêÂÜÖÂÆπÁîüÊàêÂÖ∑‰ΩìËÆ®ËÆ∫
            discussions.push({
                expert: 'ÈÄö‰πâÂçÉÈóÆ',
                content: `Âü∫‰∫éÊïôÊ°àËß£ÊûêÁªìÊûúÔºåÊàëÊ≥®ÊÑèÂà∞Ëøô‰∏™ÊïôÊ°à${hasObjectives ? 'Â∑≤ÁªèÊòéÁ°Æ‰∫ÜÊïôÂ≠¶ÁõÆÊ†á' : 'ÈúÄË¶ÅËøõ‰∏ÄÊ≠•ÊòéÁ°ÆÊïôÂ≠¶ÁõÆÊ†á'}„ÄÇ‰ªéÊï¥‰ΩìÊïôÂ≠¶ËÆæËÆ°Êù•ÁúãÔºå${hasActivities ? 'ÊïôÂ≠¶ÊµÅÁ®ãÂÆâÊéíÂêàÁêÜ' : 'ÊïôÂ≠¶Ê¥ªÂä®ÂèØ‰ª•Êõ¥Âä†‰∏∞ÂØå'}„ÄÇÊàëÂª∫ËÆÆ${hasEvaluation ? '‰ºòÂåñÁé∞ÊúâÁöÑËØÑ‰ª∑ÊñπÂºè' : 'Âª∫Á´ãÂ§öÂÖÉËØÑ‰ª∑‰ΩìÁ≥ª'}Ôºå‰ª•Êõ¥Â•ΩÂú∞ËØÑ‰º∞Â≠¶ÁîüÁöÑÁßëÂ≠¶Á¥†ÂÖªÂèëÂ±ï„ÄÇ`,
                type: 'analysis_based'
            });

            discussions.push({
                expert: 'Ë±ÜÂåÖ',
                content: `ÊàëÂêåÊÑèÈÄö‰πâÂçÉÈóÆÁöÑÂàÜÊûê„ÄÇ‰ªéÂàõÊñ∞ÊïôÂ≠¶ËßÜËßíÊù•ÁúãÔºåËøô‰∏™ÊïôÊ°à${hasActivities ? 'Âú®ÂÆûÈ™åËÆæËÆ°ÊñπÈù¢Êúâ‰∏ÄÂÆöÂàõÊñ∞ÊÄß' : 'ÂèØ‰ª•Â¢ûÂä†Êõ¥Â§öÂàõÊñ∞ÂÆûÈ™åÁéØËäÇ'}„ÄÇÊàëÂª∫ËÆÆ${hasObjectives ? 'Âú®ËææÊàêÊïôÂ≠¶ÁõÆÊ†áÁöÑËøáÁ®ã‰∏≠' : 'Âú®ÊòéÁ°ÆÁõÆÊ†áÂêé'}ËûçÂÖ•Êõ¥Â§ö‰∫íÂä®ÂÖÉÁ¥†ÔºåËÆ©Â≠¶ÁîüÂú®ÂÆûË∑µ‰∏≠Ëé∑ÂæóÊõ¥Ê∑±ÂàªÁöÑÁßëÂ≠¶‰ΩìÈ™å„ÄÇ`,
                type: 'innovation_focused'
            });

            discussions.push({
                expert: 'Kimi',
                content: `‰ªéÂ≠¶ÁîüÂèÇ‰∏éÂ∫¶ÂàÜÊûêÔºåËøô‰∏™ÊïôÊ°à${hasActivities ? 'ËÆæËÆ°‰∫ÜËæÉÂ•ΩÁöÑ‰∫íÂä®ÁéØËäÇ' : 'ÈúÄË¶ÅÂ¢ûÂä†Êõ¥Â§öÂèÇ‰∏éÊú∫‰ºö'}„ÄÇÊàëÂª∫ËÆÆÂ¢ûÂä†Â∞èÁªÑÂêà‰ΩúÂíåËÆ®ËÆ∫ÁéØËäÇÔºåËÆ©Â≠¶ÁîüÂú®‰∫§ÊµÅ‰∏≠Ê∑±ÂåñÂØπÁßëÂ≠¶Ê¶ÇÂøµÁöÑÁêÜËß£ÔºåÂêåÊó∂ÂüπÂÖª‰ªñ‰ª¨ÁöÑÂêà‰ΩúÁ≤æÁ•ûÂíåË°®ËææËÉΩÂäõ„ÄÇ`,
                type: 'participation_focused'
            });

            if (hasEvaluation || hasOptimization) {
                discussions.push({
                    expert: 'Êô∫Ë∞±Ê∏ÖË®Ä',
                    content: `${hasEvaluation ? '‰ªéÁé∞ÊúâÁöÑËØÑ‰ª∑ÊñπÂºèÊù•Áúã' : 'Ê†πÊçÆ‰ºòÂåñÂª∫ËÆÆ'}ÔºåËøô‰∏™ÊïôÊ°à${hasEvaluation ? 'Â∑≤ÁªèËÄÉËôë‰∫ÜËØÑ‰ª∑ËÆæËÆ°' : 'ÈúÄË¶ÅÂÆåÂñÑËØÑ‰ª∑‰ΩìÁ≥ª'}„ÄÇÊàëÂª∫ËÆÆÈááÁî®ÂèëÂ±ïÊÄßËØÑ‰ª∑ÊñπÂºèÔºåÂÖ≥Ê≥®Â≠¶ÁîüÁöÑËÆ§Áü•ÂèëÂ±ï„ÄÅÊäÄËÉΩÊéåÊè°ÂíåÁßëÂ≠¶ÊÄÅÂ∫¶‰∏â‰∏™Áª¥Â∫¶ÔºåÁ°Æ‰øùËØÑ‰ª∑ËÉΩÂ§ü‰øÉËøõÂ≠¶ÁîüÁöÑÂÖ®Èù¢ÂèëÂ±ï„ÄÇ`,
                    type: 'evaluation_focused'
                });
            }

            // Ê∑ªÂä†ÊÄªÁªìÊÄßËÆ®ËÆ∫
            discussions.push({
                expert: 'GPT',
                content: `ÁªºÂêàÂ§ßÂÆ∂ÂØπÊïôÊ°àËß£ÊûêÁªìÊûúÁöÑÂàÜÊûêÔºåÊàë‰ª¨Âª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®‰ª•‰∏ãÊñπÈù¢Ôºö${hasObjectives ? 'ÊïôÂ≠¶ÁõÆÊ†áÁöÑËææÊàêÂ∫¶' : 'ÊïôÂ≠¶ÁõÆÊ†áÁöÑÊòéÁ°ÆÊÄß'}„ÄÅ${hasActivities ? 'ÊïôÂ≠¶Ê¥ªÂä®ÁöÑÊúâÊïàÊÄß' : 'ÊïôÂ≠¶Ê¥ªÂä®ÁöÑ‰∏∞ÂØåÊÄß'}„ÄÅ${hasEvaluation ? 'ËØÑ‰ª∑ÊñπÂºèÁöÑÁßëÂ≠¶ÊÄß' : 'ËØÑ‰ª∑‰ΩìÁ≥ªÁöÑÂª∫Á´ã'}„ÄÇËøô‰∫õÊîπËøõÂ∞Ü‰ΩøÊïôÊ°àÊõ¥Âä†Á¨¶ÂêàÁé∞‰ª£ÁßëÂ≠¶ÊïôËÇ≤ÁöÑË¶ÅÊ±Ç„ÄÇ`,
                type: 'comprehensive_summary'
            });

            return discussions;
        }

        // Á¨¨‰∏âÈò∂ÊÆµÔºöÂçè‰ΩúÊï¥Âêà
        function startStage3Integration() {
            // ÂàõÂª∫Á¨¨‰∏âÈò∂ÊÆµÂÆπÂô®
            const container = document.querySelector('.container');
            
            // ===== ÂÖ≥ÈîÆÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÂ≠òÂú® =====
            if (!container) {
                console.error('‚ùå Ëá¥ÂëΩÈîôËØØÔºö.containerÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÂàõÂª∫Á¨¨‰∏âÈò∂ÊÆµ');
                showMessage('‚ùå Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÆπÂô®‰∏¢Â§±ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');
                return;
            }
            
            const stage3Div = document.createElement('div');
            stage3Div.className = 'card';
            stage3Div.id = 'stage3Container';
            stage3Div.innerHTML = `
                <h3><i class="fas fa-handshake"></i> Á¨¨‰∏âÈò∂ÊÆµÔºöÂçè‰ΩúÊï¥ÂêàÊñπÊ°à</h3>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="stage3Progress"></div>
                    </div>
                    <div class="progress-text" id="stage3ProgressText">Âçè‰ΩúÊï¥Âêà‰∏≠...</div>
                </div>
                <div class="final-results" id="finalResults">
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-title">
                                <i class="fas fa-bullseye"></i>
                                <span>‰ºòÂåñÊïôÂ≠¶ÁõÆÊ†á</span>
                            </div>
                            <div class="result-content">
                                <ul class="result-list" id="optimizedObjectives"></ul>
                            </div>
                        </div>
                        <div class="result-card">
                            <div class="result-title">
                                <i class="fas fa-cogs"></i>
                                <span>ÊîπËøõÊïôÂ≠¶ÊµÅÁ®ã</span>
                            </div>
                            <div class="result-content">
                                <ul class="result-list" id="improvedProcedures"></ul>
                            </div>
                        </div>
                        <div class="result-card">
                            <div class="result-title">
                                <i class="fas fa-lightbulb"></i>
                                <span>ÂàõÊñ∞ÊïôÂ≠¶Ê¥ªÂä®</span>
                            </div>
                            <div class="result-content">
                                <ul class="result-list" id="innovativeActivities"></ul>
                            </div>
                        </div>
                        <div class="result-card">
                            <div class="result-title">
                                <i class="fas fa-clipboard-check"></i>
                                <span>Â≠¶ÁîüËØÑ‰ª∑ÈáèË°®</span>
                            </div>
                            <div class="result-content">
                                <div id="evaluationDimensions"></div>
                            </div>
                        </div>
                    </div>
                    <div class="download-section">
                        <h4 style="color: white; margin-bottom: 15px;">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩÂàÜÊûêÁªìÊûú
                        </h4>
                        <div class="download-buttons">
                            <button class="btn" onclick="downloadOptimizedLesson()">
                                <i class="fas fa-file-word"></i> ‰∏ãËΩΩ‰ºòÂåñÊïôÊ°à
                            </button>
                            <button class="btn" onclick="exportLocalStylePDF('optimized')" style="background: linear-gradient(135deg, #13c2c2, #36cfc9); margin-right: 10px;" data-i18n="ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf">
                                <i class="fas fa-file-pdf"></i> <span>ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÁöÑpdf</span>
                            </button>
                            <button class="btn" onclick="downloadEvaluationForm()">
                                <i class="fas fa-file-alt"></i> ‰∏ãËΩΩËØÑ‰ª∑ÈáèË°®
                            </button>
                            <button class="btn" onclick="downloadFullReport()">
                                <i class="fas fa-file-pdf"></i> ‰∏ãËΩΩÂÆåÊï¥Êä•Âëä
                            </button>
                            <button class="btn" onclick="resetSystem()">
                                <i class="fas fa-redo"></i> ÂàÜÊûêÊñ∞ÊïôÊ°à
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ÊèíÂÖ•Âà∞ÁîüÊàêÊùêÊñôÂàóË°®‰πãÂêéÔºåAPIÊµãËØï‰πãÂâçÔºàÂÆâÂÖ®ÊèíÂÖ•Ôºâ
            const materialsListDiv = document.getElementById('generatedMaterialsList');
            const apiTestSection = document.getElementById('apiTestSection');
            
            try {
                // Âº∫ÂåñÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùcontainerÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†Âπ∂Âú®ÊñáÊ°£‰∏≠
                if (!container || !(container instanceof HTMLElement) || !document.body.contains(container)) {
                    throw new Error('container‰∏çÂ≠òÂú®„ÄÅ‰∏çÊòØÊúâÊïàÂÖÉÁ¥†ÊàñÂ∑≤‰ªéDOM‰∏≠ÁßªÈô§');
                }
                
                // È™åËØÅstage3DivÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
                if (!(stage3Div instanceof HTMLElement)) {
                    throw new Error('stage3Div‰∏çÊòØÊúâÊïàÁöÑHTMLÂÖÉÁ¥†');
                }
                
                // ÂÆâÂÖ®ÊèíÂÖ•ÔºöÊ£ÄÊü•ÊâÄÊúâÂèÇËÄÉÂÖÉÁ¥†ÊòØÂê¶Âú®container‰∏≠
                if (materialsListDiv && materialsListDiv.nextSibling && container.contains(materialsListDiv)) {
                    if (container.contains(materialsListDiv.nextSibling)) {
                        container.insertBefore(stage3Div, materialsListDiv.nextSibling);
                    } else {
                        container.appendChild(stage3Div);
                    }
                } else if (apiTestSection && container.contains(apiTestSection)) {
                    container.insertBefore(stage3Div, apiTestSection);
                } else {
                    container.appendChild(stage3Div);
                }
            } catch (error) {
                console.error('‚ùå ÊèíÂÖ•stage3DivÂ§±Ë¥•Ôºå‰ΩøÁî®appendChild:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', {
                    message: error.message,
                    containerExists: !!container,
                    stage3DivExists: !!stage3Div,
                    materialsListDivExists: !!materialsListDiv,
                    apiTestSectionExists: !!apiTestSection
                });
                try {
                    if (container && container.appendChild && stage3Div) {
                        container.appendChild(stage3Div);
                    } else {
                        console.error('‚ùå containerÊàñstage3Div‰∏çÂèØÁî®ÔºåÊó†Ê≥ïÊèíÂÖ•');
                        return;
                    }
                } catch (appendError) {
                    console.error('‚ùå appendChild‰πüÂ§±Ë¥•‰∫Ü:', appendError);
                    return;
                }
            }

            setTimeout(() => {
                ScrollManager.scrollTo(stage3Div, { offset: 80 });
            }, 100);

            setTimeout(() => {
                showFinalResults();
            }, 1500);
        }

        // ÊòæÁ§∫ÊúÄÁªàÁªìÊûú
        function showFinalResults() {
            updateProgress('stage3Progress', 'stage3ProgressText', 100, 'Âçè‰ΩúÊï¥ÂêàÂÆåÊàêÔºÅ');

            // ‰ΩøÁî®Âü∫‰∫é‰∏ìÂÆ∂ËßÇÁÇπÁîüÊàêÁöÑÊúÄÁªàÁªìÊûú
            const results = window.finalTeachingPlan ? JSON.parse(window.finalTeachingPlan) : {
                objectives: ['Â≠¶ÁîüËÉΩÂ§üÁêÜËß£ÁßëÂ≠¶Ê¶ÇÂøµ', 'Â≠¶ÁîüËÉΩÂ§üËøõË°åÂÆûÈ™åÊìç‰Ωú'],
                procedures: ['ÂØºÂÖ•ÁéØËäÇ', 'ÂÆûÈ™åÁéØËäÇ', 'ÊÄªÁªìÁéØËäÇ'],
                activities: ['ÂÆûÈ™åÊ¥ªÂä®', 'ËÆ®ËÆ∫Ê¥ªÂä®'],
                evaluationDimensions: {'ÁßëÂ≠¶Áü•ËØÜ': ['Ê¶ÇÂøµÁêÜËß£', 'ÂéüÁêÜÊéåÊè°']}
            };

            // Â°´ÂÖÖÁªìÊûúÂÜÖÂÆπ
            document.getElementById('optimizedObjectives').innerHTML =
                results.objectives.map(obj => `<li>${obj}</li>`).join('');

            document.getElementById('improvedProcedures').innerHTML =
                results.procedures.map(proc => `<li>${proc}</li>`).join('');

            document.getElementById('innovativeActivities').innerHTML =
                results.activities.map(act => `<li>${act}</li>`).join('');

            document.getElementById('evaluationDimensions').innerHTML =
                Object.entries(results.evaluationDimensions).map(([dim, indicators]) =>
                    `<div><strong>${dim}Ôºö</strong>${indicators.join('„ÄÅ')}</div>`).join('');

            analysisInProgress = false;
            showMessage('üéâ ‰∏âÈò∂ÊÆµÂçè‰ΩúÂàÜÊûêÂÆåÊàêÔºÅÊÇ®ÂèØ‰ª•‰∏ãËΩΩÂàÜÊûêÁªìÊûú„ÄÇ', 'success');
        }

        // ÊèêÂèñÊïôÊ°àÊ†áÈ¢ò
        function extractLessonTitle(content) {
            const lines = content.split('\n');
            for (let line of lines) {
                if (line.includes('ÊïôÊ°à') || line.includes('ËØæÁ®ã') || line.includes('‰∏ªÈ¢ò')) {
                    return line.replace(/.*[:Ôºö]/, '').trim() || 'ÁßëÂ≠¶ËØæÁ®ã';
                }
            }
            return 'ÁßëÂ≠¶ËØæÁ®ã';
        }

        // ÁîüÊàêÊúÄÁªàÁªìÊûú
        function generateFinalResults() {
            const lessonTitle = extractLessonTitle(fileContent);

            return {
                objectives: [
                    `Â≠¶ÁîüËÉΩÂ§üÈÄöËøáÂÆûÈ™åËßÇÂØüÔºåÂáÜÁ°ÆËß£Èáä${lessonTitle}ÁöÑÁßëÂ≠¶ÂéüÁêÜ`,
                    'Â≠¶ÁîüËÉΩÂ§üËÆæËÆ°Âπ∂ÂÆûÊñΩÁÆÄÂçïÁöÑÈ™åËØÅÂÆûÈ™åÔºåÂüπÂÖªÁßëÂ≠¶Êé¢Á©∂ËÉΩÂäõ',
                    'Â≠¶ÁîüËÉΩÂ§üËøêÁî®ÁßëÂ≠¶ËØ≠Ë®ÄÊèèËø∞ÂÆûÈ™åÁé∞Ë±°ÔºåÂèëÂ±ïÁßëÂ≠¶Ë°®ËææËÉΩÂäõ',
                    'Â≠¶ÁîüËÉΩÂ§ü‰∏éÂêå‰º¥Âêà‰Ωú‰∫§ÊµÅÔºåÂΩ¢ÊàêËâØÂ•ΩÁöÑÁßëÂ≠¶Â≠¶‰π†ÊÄÅÂ∫¶'
                ],
                procedures: [
                    'ÂØºÂÖ•ÁéØËäÇÔºöÂ¢ûÂä†Â≠¶ÁîüÈ¢ÑÊµãÁéØËäÇÔºåÊøÄÂèëÊé¢Á©∂ÂÖ¥Ë∂£Ôºà5ÂàÜÈíü‚Üí8ÂàÜÈíüÔºâ',
                    'Êé¢Á©∂ÁéØËäÇÔºöÂ¢ûÂä†Â∞èÁªÑÂêà‰ΩúÂÆûÈ™åÔºåÂ≠¶ÁîüËá™‰∏ªËÆæËÆ°È™åËØÅÊñπÊ°àÔºà30ÂàÜÈíü‚Üí25ÂàÜÈíüÔºâ',
                    'ËÆ®ËÆ∫ÁéØËäÇÔºöÊñ∞Â¢ûÊàêÊûúÂ±ïÁ§∫ÂíåÂêå‰º¥ËØÑ‰ª∑ÔºàÊñ∞Â¢û8ÂàÜÈíüÔºâ',
                    'ÊÄªÁªìÁéØËäÇÔºöÂ≠¶Áîü‰∏ªÂØºÊÄªÁªìÔºåÊïôÂ∏àÂºïÂØºÊ∑±ÂåñÔºà5ÂàÜÈíü‚Üí4ÂàÜÈíüÔºâ'
                ],
                activities: [
                    '‰∫∫‰ΩìÂèëÂ£∞ÂÆûÈ™åÔºöËÆ©Â≠¶ÁîüÊë∏ÂñâÂíôÊÑüÂèóÂ£∞Â∏¶ÊåØÂä®ÔºåÂ¢ûÂº∫ÊÑüÊÄßËÆ§ËØÜ',
                    'Â≠¶ÁîüËá™‰∏ªÂÆûÈ™åÔºöÂ∞èÁªÑËÆæËÆ°ÂàõÊñ∞ÂÆûÈ™åÈ™åËØÅÂ£∞Èü≥‰∫ßÁîüÂéüÁêÜ',
                    'Ê¶ÇÂøµÂª∫ÊûÑÊ¥ªÂä®ÔºöÂà∂‰ΩúÂ£∞Èü≥‰º†Êí≠Á§∫ÊÑèÂõæÔºåÂä†Ê∑±ÁêÜËß£',
                    'Â§öÂÖÉËØÑ‰ª∑Ê¥ªÂä®ÔºöÂ≠¶ÁîüËá™ËØÑ„ÄÅ‰∫íËØÑ„ÄÅÂ∏àËØÑÁõ∏ÁªìÂêà'
                ],
                evaluationDimensions: {
                    'ÁßëÂ≠¶Áü•ËØÜ': ['Âü∫Êú¨Ê¶ÇÂøµÁêÜËß£', 'ÂéüÁêÜÂ∫îÁî®ËÉΩÂäõ', 'Áü•ËØÜËøÅÁßªÊ∞¥Âπ≥'],
                    'ÁßëÂ≠¶Êé¢Á©∂': ['ËßÇÂØüËÉΩÂäõ', 'ÂÆûÈ™åËÆæËÆ°', 'Êï∞ÊçÆÂàÜÊûê'],
                    'ÁßëÂ≠¶ÊÄÅÂ∫¶': ['Â≠¶‰π†ÂÖ¥Ë∂£', 'Âêà‰ΩúÁ≤æÁ•û', 'ÁßëÂ≠¶Á≤æÁ•û'],
                    'ÁßëÂ≠¶ÊÄùÁª¥': ['ÈÄªËæëÊé®ÁêÜ', 'ÊâπÂà§ÊÄßÊÄùÁª¥', 'ÂàõÊñ∞ÊÑèËØÜ']
                }
            };
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgress(progressId, textId, progress, text) {
            const progressFill = document.getElementById(progressId);
            const progressText = document.getElementById(textId);

            if (progressFill && progressText) {
                progressFill.style.width = progress + '%';
                progressText.textContent = text;
            }
        }

        // Ë∞ÉÁî®ÊïôÊ°àËß£ÊûêAI API
        async function callParserAPI(prompt) {
            try {
                console.log('Ë∞ÉÁî®ÊïôÊ°àËß£ÊûêAI API...');
                const response = await fetch(API_CONFIG.parser.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.parser.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.parser.model,
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('ÊïôÊ°àËß£ÊûêAI APIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('ÊïôÊ°àËß£ÊûêAI APIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Ë∞ÉÁî®Qwen API
        async function callQwenAPI(prompt) {
            try {
                console.log('Ë∞ÉÁî®Qwen API...');
                const response = await fetch(API_CONFIG.qwen.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.qwen.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.qwen.model,
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('Qwen APIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('Qwen APIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Ë∞ÉÁî®QwenÂ§öÊ®°ÊÄÅAPIÁîüÊàêHTMLÊ†ºÂºèÊïôÊ°à
        async function callQwenMultimodalAPI(messages) {
            try {
                console.log('Ë∞ÉÁî®QwenÂ§öÊ®°ÊÄÅAPIÁîüÊàêHTMLÊ†ºÂºèÊïôÊ°à...');
                const response = await fetch(API_CONFIG.parser.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.parser.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.parser.model,
                        messages: messages
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('QwenÂ§öÊ®°ÊÄÅAPIË∞ÉÁî®ÊàêÂäü');
                    let content = data.choices[0].message.content;
                    // Â¶ÇÊûúÊòØËã±ÊñáÂú∞Âå∫Ôºå‰∏çÈúÄË¶ÅËΩ¨Êç¢ÁπÅ‰ΩìÂ≠ó
                    if (window.isEnglishRegion) {
                        return content;
                    }
                    return convertToTraditionalChinese(content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('QwenÂ§öÊ®°ÊÄÅAPIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫base64
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ÁîüÊàêHTMLÊ†ºÂºèÊïôÊ°à
        window.generateHTMLFormatPlan = async function() {
            try {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊïôÊ°àÂÜÖÂÆπ
                if (!window.finalTeachingPlanClean || window.finalTeachingPlanClean.trim().length < 50) {
                    showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑÊïôÊ°àÂÜÖÂÆπ', 'error');
                    return;
                }

                const generateBtn = document.getElementById('generateHTMLBtn');
                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÁîüÊàê...';
                }

                showMessage('ü§ñ Ê≠£Âú®ÁîüÊàêHTMLÊ†ºÂºèÊïôÊ°à...', 'info');

                // ËØªÂèñÂèÇËÄÉPDF
                const pdfPath = './ÊóãËΩâÂ∞çÁ®±ÂúñÂΩ¢ÊïôÊ°à.pdf';
                let pdfBase64 = null;
                
                try {
                    // Â∞ùËØïÈÄöËøáfetchËØªÂèñPDFÊñá‰ª∂
                    const response = await fetch(pdfPath);
                    if (response.ok) {
                        const blob = await response.blob();
                        pdfBase64 = await fileToBase64(new File([blob], 'reference.pdf', { type: 'application/pdf' }));
                        console.log('‚úÖ ÂèÇËÄÉPDFËØªÂèñÊàêÂäü');
                    } else {
                        console.warn('‚ö†Ô∏è Êó†Ê≥ïËØªÂèñÂèÇËÄÉPDFÔºåÂ∞Ü‰ªÖ‰ΩøÁî®ÊñáÊú¨ÂÜÖÂÆπ');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è ËØªÂèñÂèÇËÄÉPDFÂ§±Ë¥•:', error);
                    // Â∞ùËØïÂè¶‰∏Ä‰∏™ÂèØËÉΩÁöÑË∑ØÂæÑ
                    try {
                        const altPath = 'ÊóãËΩâÂ∞çÁ®±ÂúñÂΩ¢ÊïôÊ°à.pdf';
                        const altResponse = await fetch(altPath);
                        if (altResponse.ok) {
                            const blob = await altResponse.blob();
                            pdfBase64 = await fileToBase64(new File([blob], 'reference.pdf', { type: 'application/pdf' }));
                            console.log('‚úÖ ÂèÇËÄÉPDFËØªÂèñÊàêÂäüÔºà‰ΩøÁî®Â§áÁî®Ë∑ØÂæÑÔºâ');
                        }
                    } catch (altError) {
                        console.warn('‚ö†Ô∏è Â§áÁî®Ë∑ØÂæÑ‰πüÂ§±Ë¥•ÔºåÂ∞Ü‰ªÖ‰ΩøÁî®ÊñáÊú¨ÂÜÖÂÆπ');
                    }
                }

                // ÂáÜÂ§áprompt
                const region = document.getElementById('region').value;
                const isEnglish = region === 'Ëã±ÂõΩ' || region === 'È©¨Êù•Ë•ø‰∫ö';
                
                let prompt = '';
                if (isEnglish) {
                    prompt = `You are a professional lesson plan formatter. I will provide you with:
1. A lesson plan text content (as text)
2. A reference PDF file showing the format/layout I want (as PDF image)

Please analyze the reference PDF format carefully and create an HTML document that:
- Uses the EXACT same format, layout, and structure as the reference PDF
- Contains the content from the lesson plan text
- Is properly formatted with tables, sections, and styling matching the reference PDF
- Can be printed or saved as PDF with the same appearance

Important requirements:
- The HTML should match the reference PDF's visual structure exactly
- Use appropriate HTML tables, divs, and CSS styling
- Preserve all formatting, spacing, and layout from the reference PDF
- The content should come from the lesson plan text provided
- Output ONLY the HTML code, no explanations or markdown

Here is the lesson plan text content:
${window.finalTeachingPlanClean}`;
                } else {
                    prompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àÊ†ºÂºèÂåñ‰∏ìÂÆ∂„ÄÇÊàëÂ∞ÜÊèê‰æõÁªô‰Ω†Ôºö
1. ‰∏Ä‰ªΩÊïôÊ°àÊñáÊú¨ÂÜÖÂÆπÔºà‰Ωú‰∏∫ÊñáÊú¨Ôºâ
2. ‰∏Ä‰ªΩÂèÇËÄÉPDFÊñá‰ª∂ÔºåÂ±ïÁ§∫ÊàëÊÉ≥Ë¶ÅÁöÑÊ†ºÂºè/Â∏ÉÂ±ÄÔºà‰Ωú‰∏∫PDFÂõæÁâáÔºâ

ËØ∑‰ªîÁªÜÂàÜÊûêÂèÇËÄÉPDFÁöÑÊ†ºÂºèÔºåÂàõÂª∫‰∏Ä‰∏™HTMLÊñáÊ°£ÔºåË¶ÅÊ±ÇÔºö
- ‰ΩøÁî®‰∏éÂèÇËÄÉPDFÂÆåÂÖ®Áõ∏ÂêåÁöÑÊ†ºÂºè„ÄÅÂ∏ÉÂ±ÄÂíåÁªìÊûÑ
- ÂåÖÂê´ÊïôÊ°àÊñáÊú¨‰∏≠ÁöÑÂÜÖÂÆπ
- Ê≠£Á°ÆÊ†ºÂºèÂåñÔºåÂåÖÂê´Ë°®Ê†º„ÄÅÁ´†ËäÇÂíåÊ†∑ÂºèÔºå‰∏éÂèÇËÄÉPDFÂåπÈÖç
- ÂèØ‰ª•ÊâìÂç∞ÊàñÂè¶Â≠ò‰∏∫PDFÔºåÂ§ñËßÇÁõ∏Âêå

ÈáçË¶ÅË¶ÅÊ±ÇÔºö
- HTMLÂ∫îËØ•‰∏éÂèÇËÄÉPDFÁöÑËßÜËßâÁªìÊûÑÂÆåÂÖ®ÂåπÈÖç
- ‰ΩøÁî®ÈÄÇÂΩìÁöÑHTMLË°®Ê†º„ÄÅdivÂíåCSSÊ†∑Âºè
- ‰øùÁïôÂèÇËÄÉPDF‰∏≠ÁöÑÊâÄÊúâÊ†ºÂºè„ÄÅÈó¥Ë∑ùÂíåÂ∏ÉÂ±Ä
- ÂÜÖÂÆπÂ∫îÊù•Ëá™Êèê‰æõÁöÑÊïôÊ°àÊñáÊú¨
- Âè™ËæìÂá∫HTML‰ª£Á†ÅÔºå‰∏çË¶ÅËß£ÈáäÊàñmarkdown

‰ª•‰∏ãÊòØÊïôÊ°àÊñáÊú¨ÂÜÖÂÆπÔºö
${window.finalTeachingPlanClean}`;
                }

                // ÊûÑÂª∫messages
                const messages = [];
                if (pdfBase64) {
                    // Â¶ÇÊûúÊúâPDFÔºå‰ΩøÁî®Â§öÊ®°ÊÄÅAPI
                    messages.push({
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: prompt
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: `data:application/pdf;base64,${pdfBase64}`
                                }
                            }
                        ]
                    });
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâPDFÔºåÂè™‰ΩøÁî®ÊñáÊú¨
                    messages.push({
                        role: 'user',
                        content: prompt
                    });
                }

                // Ë∞ÉÁî®APIÁîüÊàêHTML
                const htmlContent = await callQwenMultimodalAPI(messages);

                if (!htmlContent || htmlContent.trim().length < 100) {
                    throw new Error('HTMLÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
                }

                // ÊèêÂèñHTML‰ª£Á†ÅÔºàÂéªÈô§ÂèØËÉΩÁöÑmarkdown‰ª£Á†ÅÂùóÊ†áËÆ∞Ôºâ
                let cleanHTML = htmlContent.trim();
                // ÁßªÈô§markdown‰ª£Á†ÅÂùóÊ†áËÆ∞
                cleanHTML = cleanHTML.replace(/^```html\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/i, '');
                
                // Á°Æ‰øùÊòØÂÆåÊï¥ÁöÑHTMLÊñáÊ°£
                if (!cleanHTML.includes('<!DOCTYPE') && !cleanHTML.includes('<html')) {
                    // Â¶ÇÊûúÊ≤°ÊúâDOCTYPEÊàñhtmlÊ†áÁ≠æÔºåÊ∑ªÂä†Âü∫Êú¨ÁªìÊûÑ
                    cleanHTML = `<!DOCTYPE html>
<html lang="${isEnglish ? 'en' : 'zh-CN'}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; font-weight: bold; }
    </style>
</head>
<body>
${cleanHTML}
</body>
</html>`;
                }

                // ‰øùÂ≠òHTMLÂÜÖÂÆπ
                window.generatedHTMLPlan = cleanHTML;

                // ÊòæÁ§∫HTMLÈ¢ÑËßà
                showHTMLPreview(cleanHTML);

                showMessage('‚úÖ HTMLÊ†ºÂºèÊïôÊ°àÁîüÊàêÊàêÂäüÔºÅ', 'success');

            } catch (error) {
                console.error('ÁîüÊàêHTMLÊ†ºÂºèÊïôÊ°àÂ§±Ë¥•:', error);
                showMessage('‚ùå ÁîüÊàêHTMLÊ†ºÂºèÊïôÊ°àÂ§±Ë¥•Ôºö' + error.message, 'error');
            } finally {
                const generateBtn = document.getElementById('generateHTMLBtn');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-code"></i> ÁîüÊàêHTMLÊ†ºÂºè';
                }
            }
        };

        // ÊòæÁ§∫HTMLÈ¢ÑËßà
        function showHTMLPreview(htmlContent) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®È¢ÑËßàÂå∫Âüü
            let previewDiv = document.getElementById('htmlPreviewContainer');
            if (!previewDiv) {
                // ÂàõÂª∫È¢ÑËßàÂÆπÂô®
                previewDiv = document.createElement('div');
                previewDiv.id = 'htmlPreviewContainer';
                previewDiv.className = 'card';
                previewDiv.style.background = 'linear-gradient(135deg, rgba(235, 47, 150, 0.15), rgba(235, 47, 150, 0.05))';
                previewDiv.style.border = '2px solid rgba(235, 47, 150, 0.3)';
                previewDiv.style.marginTop = '20px';
                
                // ÊèíÂÖ•Âà∞Á∫ØÂáÄÁâàÊïôÊ°àÂêéÈù¢
                const cleanPlanDiv = document.getElementById('fusedTeachingPlanClean');
                if (cleanPlanDiv && cleanPlanDiv.parentNode) {
                    cleanPlanDiv.parentNode.insertBefore(previewDiv, cleanPlanDiv.nextSibling);
                } else {
                    document.body.appendChild(previewDiv);
                }
            }

            previewDiv.innerHTML = `
                <h3 style="color: #eb2f96; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-code"></i> 
                    HTMLÊ†ºÂºèÊïôÊ°àÈ¢ÑËßà
                </h3>
                <div style="background: rgba(235, 47, 150, 0.1); border: 1px solid rgba(235, 47, 150, 0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.8;">
                        <strong style="color: #eb2f96;">üìã ‰ΩøÁî®ËØ¥ÊòéÔºö</strong><br>
                        ‚Ä¢ ÁÇπÂáª"ÊâìÂç∞/Âè¶Â≠ò‰∏∫PDF"ÊåâÈíÆÂèØ‰ª•Âú®ÊµèËßàÂô®‰∏≠ÊâìÂç∞ÊàñÂè¶Â≠ò‰∏∫PDF<br>
                        ‚Ä¢ ÁÇπÂáª"‰∏ãËΩΩHTMLÊñá‰ª∂"ÂèØ‰ª•‰∏ãËΩΩHTMLÊñá‰ª∂<br>
                        ‚Ä¢ HTMLÊñá‰ª∂ÂèØ‰ª•Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄÔºåÁÑ∂ÂêéÊâìÂç∞ÊàñÂè¶Â≠ò‰∏∫PDF
                    </div>
                </div>
                <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <iframe id="htmlPreviewFrame" style="width: 100%; height: 800px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: white;"></iframe>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="printHTMLPlan()" style="background: linear-gradient(135deg, #1890ff, #40a9ff); margin-right: 10px;">
                        <i class="fas fa-print"></i> ÊâìÂç∞/Âè¶Â≠ò‰∏∫PDF
                    </button>
                    <button class="btn" onclick="downloadHTMLPlan()" style="background: linear-gradient(135deg, #52c41a, #73d13d); margin-right: 10px;">
                        <i class="fas fa-download"></i> ‰∏ãËΩΩHTMLÊñá‰ª∂
                    </button>
                </div>
            `;

            // Â∞ÜHTMLÂÜÖÂÆπÂÜôÂÖ•iframe
            const iframe = document.getElementById('htmlPreviewFrame');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.document.open();
                iframe.contentWindow.document.write(htmlContent);
                iframe.contentWindow.document.close();
            }

            // ÊªöÂä®Âà∞È¢ÑËßàÂå∫Âüü
            setTimeout(() => {
                ScrollManager.scrollTo(previewDiv, { offset: 80 });
            }, 100);
        }

        // ÊâìÂç∞HTMLÊïôÊ°à
        window.printHTMLPlan = function() {
            if (!window.generatedHTMLPlan) {
                showMessage('‚ùå Ê≤°ÊúâÂèØÊâìÂç∞ÁöÑHTMLÂÜÖÂÆπ', 'error');
                return;
            }

            // ÂàõÂª∫Êñ∞Á™óÂè£ÊâìÂç∞
            const printWindow = window.open('', '_blank');
            printWindow.document.write(window.generatedHTMLPlan);
            printWindow.document.close();
            
            // Á≠âÂæÖÂÜÖÂÆπÂä†ËΩΩÂêéÊâìÂç∞
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // ‰∏ãËΩΩHTMLÊïôÊ°à
        window.downloadHTMLPlan = function() {
            if (!window.generatedHTMLPlan) {
                showMessage('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑHTMLÂÜÖÂÆπ', 'error');
                return;
            }

            const blob = new Blob([window.generatedHTMLPlan], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ÊïôÊ°à_HTMLÊ†ºÂºè.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('‚úÖ HTMLÊñá‰ª∂‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
        }

        // Ë∞ÉÁî®Ë±ÜÂåÖAPI
        async function callDoubaoAPI(prompt) {
            try {
                console.log('Ë∞ÉÁî®Ë±ÜÂåÖAPI...');
                const response = await fetch(API_CONFIG.doubao.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.doubao.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.doubao.model,
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    // 429ÈîôËØØÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
                    if (response.status === 429) {
                        const errorText = await response.text().catch(() => 'ÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω');
                        console.error('Ë±ÜÂåÖAPIÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω:', errorText);
                        throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: 429 ÈÖçÈ¢ùÂ∑≤Áî®Â∞Ω`);
                    }
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('Ë±ÜÂåÖAPIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('Ë±ÜÂåÖAPIË∞ÉÁî®ÈîôËØØ:', error);
                // Â∞ÜÈîôËØØÂêë‰∏ä‰º†ÈÄíÔºåËÄå‰∏çÊòØËøîÂõûnull
                throw error;
            }
        }

        // Ë∞ÉÁî®Kimi API
        async function callKimiAPI(prompt) {
            try {
                const response = await fetch(API_CONFIG.kimi.baseUrl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.kimi.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.kimi.model,
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('Kimi APIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('Kimi APIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Ë∞ÉÁî®Êô∫Ë∞±Ê∏ÖË®ÄAPI
        async function callChatGLMAPI(prompt) {
            try {
                const response = await fetch(API_CONFIG.chatglm.baseUrl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.chatglm.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.chatglm.model,
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('Êô∫Ë∞±Ê∏ÖË®ÄAPIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('Êô∫Ë∞±Ê∏ÖË®ÄAPIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // ÁîüÊàêÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÔºàÊïôÊ°àÁîüÊàêÂêéÁ´ãÂç≥Ë∞ÉÁî®Ôºâ
        async function generateInitialCourseMaterial(teachingPlan, lessonTitle) {
            console.log('ÂºÄÂßãÁîüÊàêÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñô...');
            
            try {
                // ‰ªéÊïôÊ°à‰∏≠ÊèêÂèñÁü•ËØÜÁÇπÔºà‰º†ÂÖ•ËØæÁ®ãÊ†áÈ¢ò‰ª•Á°Æ‰øùÁõ∏ÂÖ≥ÊÄßÔºâ
                let knowledgePoints = extractKnowledgePoints(teachingPlan, lessonTitle);
                
                if (knowledgePoints.length === 0) {
                    console.warn('Êó†Ê≥ïÊèêÂèñÁü•ËØÜÁÇπÔºåË∑≥ËøáÂàùÊ≠•ÊºîÁ§∫ÊùêÊñôÁîüÊàê');
                    return;
                }
                
                console.log(`ÊèêÂèñÂà∞ ${knowledgePoints.length} ‰∏™‰∏é"${lessonTitle}"Áõ∏ÂÖ≥ÁöÑÁü•ËØÜÁÇπ:`, knowledgePoints);
                
                // ÁîüÊàêËØæÁ®ãÊºîÁ§∫HTML
                const htmlPrompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑËØæÁ®ãÊùêÊñôÂà∂‰ΩúËÄÅÂ∏àÔºåËØ∑‰∏∫Â∞èÂ≠¶ÁßëÂ≠¶ËØæÁ®ã"${lessonTitle}"ÁîüÊàê‰∏Ä‰∏™‰∏∞ÂØå„ÄÅ‰∫§‰∫íÂºèÁöÑHTMLÊºîÁ§∫È°µÈù¢„ÄÇ

Ê†∏ÂøÉÁü•ËØÜÁÇπÔºö
${knowledgePoints.join('\n')}

Ë¶ÅÊ±ÇÔºö

**1. ÂÆåÊï¥HTMLÁªìÊûÑ**Ôºö
- ÂåÖÂê´<!DOCTYPE html>„ÄÅ<html>„ÄÅ<head>„ÄÅ<body>Á≠âÂÆåÊï¥Ê†áÁ≠æ
- ‰ΩøÁî®HTML5ËØ≠‰πâÂåñÊ†áÁ≠æ

**2. È°µÈù¢È°∂ÈÉ®Âõ∫ÂÆöÊéßÂà∂Ê†è**Ôºö
- ÂÖ®Â±èÊåâÈíÆÔºà‰ΩøÁî®JavaScript requestFullscreen APIÔºâ
- Áº©ÊîæÊåâÈíÆÔºàÊîæÂ§ß/Áº©Â∞è/ÈáçÁΩÆÔºâ
- ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÔºà‰∫ÆËâ≤/ÊöóËâ≤Ê®°ÂºèÔºâ
- ÂØºËà™ËèúÂçïÔºàÂø´ÈÄüË∑≥ËΩ¨Âà∞ÂêÑÁü•ËØÜÁÇπÔºâ

**3. ‰∏∞ÂØåÁöÑÂÜÖÂÆπÂ±ïÁ§∫**Ôºö
ÊØè‰∏™Áü•ËØÜÁÇπÂç°ÁâáÂåÖÂê´Ôºö
- üìñ Áü•ËØÜÁÇπÊ†áÈ¢òÂíåÂõæÊ†á
- üìù ËØ¶ÁªÜËØ¥ÊòéÔºà100-200Â≠óÔºâ
- üé® Áõ∏ÂÖ≥Á§∫ÊÑèÂõæÔºà‰ΩøÁî®CSSÁªòÂà∂Âá†‰ΩïÂõæÂΩ¢ÊàñSVGÂä®ÁîªÔºåÂ¶ÇÂÖâÁ∫ø„ÄÅÊ≥¢Á∫πÁ≠âÔºâ
- üé¨ Âä®ÁîªÊºîÁ§∫ÔºàCSS3Âä®ÁîªÊàñÁÆÄÂçïÁöÑcanvasÂä®ÁîªÔºâ
- üî¨ ‰∫íÂä®ÂÆûÈ™åÔºàÂèØÁÇπÂáªÁöÑÊåâÈíÆËß¶ÂèëÊºîÁ§∫Ôºâ
- üìö Áü•ËØÜÊãìÂ±ïÔºàÁõ∏ÂÖ≥ÁßëÂ≠¶Áü•ËØÜ„ÄÅÂéÜÂè≤ÊïÖ‰∫ã„ÄÅÁîüÊ¥ªÂ∫îÁî®Ôºâ
- ‚ùì ÊÄùËÄÉÈ¢òÔºà1-2‰∏™ÂêØÂèëÊÄßÈóÆÈ¢òÔºâ

**4. ËßÜËßâÂõæÁâáÂíåÂä®Áîª**Ôºö
- ‰ΩøÁî®CSSÁªòÂà∂Áõ∏ÂÖ≥ÂõæÂΩ¢ÔºàÂúÜÂΩ¢„ÄÅ‰∏âËßíÂΩ¢„ÄÅÂÖâÁ∫øÁ≠âÔºâ
- SVGÂä®ÁîªÂ±ïÁ§∫ÁßëÂ≠¶ÂéüÁêÜ
- CSS3ËøáÊ∏°ÂíåÂÖ≥ÈîÆÂ∏ßÂä®Áîª
- Ê®°ÊãüÂÆûÈ™åÊïàÊûúÔºàÂ¶ÇÂÖâÁöÑ‰º†Êí≠Ë∑ØÂæÑ„ÄÅÂ£∞Ê≥¢„ÄÅÊ∞¥Ê≥¢Á∫πÁ≠âÔºâ

**5. ËßÜÈ¢ëÂµåÂÖ•Âª∫ËÆÆ**Ôºö
- ‰∏∫ÊØè‰∏™Áü•ËØÜÁÇπÊ∑ªÂä†YouTube/BilibiliÂµåÂÖ•‰ª£Á†ÅÁ§∫‰æãÔºàiframeÔºâ
- Ê≥®ÈáäËØ¥ÊòéÔºöÂèØÊõøÊç¢‰∏∫ÂÆûÈôÖËßÜÈ¢ëÈìæÊé•

**6. ‰∫§‰∫íÂäüËÉΩ**Ôºö
- ÁÇπÂáªÂç°ÁâáÂ±ïÂºÄ/Êî∂Ëµ∑ËØ¶ÊÉÖ
- ÊãñÂä®ÊªëÂùóËßÇÂØüÂèòÂåñ
- ÁÇπÂáªÊåâÈíÆËß¶ÂèëÂä®Áîª
- ÈóÆÁ≠î‰∫íÂä®ÔºàÁÇπÂáªÊòæÁ§∫Á≠îÊ°àÔºâ
- ËøõÂ∫¶Ë∑üË∏™ÔºàÊòæÁ§∫Â∑≤Â≠¶‰π†ÁöÑÁü•ËØÜÁÇπÔºâ

**7. ÂìçÂ∫îÂºèËÆæËÆ°**Ôºö
- ÁßªÂä®Á´Ø„ÄÅÂπ≥Êùø„ÄÅÊ°åÈù¢Á´ØÈÄÇÈÖç
- ‰ΩøÁî®Â™í‰ΩìÊü•ËØ¢
- Ëß¶Êë∏ÂèãÂ•ΩÁöÑ‰∫§‰∫í

**8. ÁæéËßÇÊéíÁâà**Ôºö
- Áé∞‰ª£ÂåñÊ∏êÂèòËÉåÊôØ
- Âç°ÁâáÂºèÂ∏ÉÂ±ÄÔºåÂ∏¶Èò¥ÂΩ±ÂíåÂúÜËßí
- Ê∏ÖÊô∞ÁöÑÊéíÁâàÂ±ÇÊ¨°
- Font AwesomeÂõæÊ†á
- ÊµÅÁïÖÁöÑÊªöÂä®Âä®Áîª

**9. ÊäÄÊúØË¶ÅÊ±Ç**Ôºö
- ÊâÄÊúâCSSÂÜôÂú®<style>Ê†áÁ≠æÂÜÖ
- ÊâÄÊúâJavaScriptÂÜôÂú®<script>Ê†áÁ≠æÂÜÖ
- ‰∏ç‰æùËµñÂ§ñÈÉ®Êñá‰ª∂ÔºàCDNÈô§Â§ñÔºöFont Awesome„ÄÅÂèØÈÄâÁöÑËßÜÈ¢ëÔºâ
- ‰ª£Á†ÅÂÆåÊï¥ÂèØÁõ¥Êé•ËøêË°å
- Ê∑ªÂä†ÂøÖË¶ÅÁöÑÊ≥®Èáä

ËØ∑Áõ¥Êé•ËæìÂá∫ÂÆåÊï¥HTML‰ª£Á†ÅÔºå‰ªé<!DOCTYPE html>ÂºÄÂßãÔºåÂàõÂª∫‰∏Ä‰∏™Á≤æÁæé„ÄÅÂÆûÁî®„ÄÅÂØåÊúâÊïôËÇ≤ÊÑè‰πâÁöÑËØæÁ®ãÊºîÁ§∫È°µÈù¢„ÄÇ`;

                const initialHTML = await callCourseMaterialAPI(htmlPrompt);
                
                if (initialHTML) {
                    // ‰øùÂ≠òÂàùÊ≠•ÊºîÁ§∫ÊùêÊñô
                    window.initialCourseMaterialHTML = initialHTML;
                    console.log('ÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàêÊàêÂäü');
                    
                    // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊùêÊñôÂàóË°®
                    if (!window.generatedMaterials) {
                        window.generatedMaterials = [];
                    }
                    window.generatedMaterials.push({
                        type: 'initial',
                        title: `${lessonTitle} - ÂàùÊ≠•Áâà`,
                        html: initialHTML,
                        knowledgePoints: knowledgePoints.length,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });
                    
                    // Êõ¥Êñ∞ÊùêÊñôÂàóË°®ÊòæÁ§∫
                    updateMaterialsList();
                    
                    // Âú®È°µÈù¢‰∏äÊòæÁ§∫ÊèêÁ§∫Ôºà‰∏çÂπ≤Êâ∞ÂêéÁª≠ÊµÅÁ®ãÔºâ
                    const previewContainer = document.getElementById('parsedContentPreview');
                    if (previewContainer) {
                        const materialNotice = document.createElement('div');
                        materialNotice.id = 'initialMaterialNotice';
                        materialNotice.style.cssText = `
                            background: linear-gradient(135deg, rgba(19, 194, 194, 0.15), rgba(19, 194, 194, 0.05));
                            border: 2px solid rgba(19, 194, 194, 0.3);
                            border-radius: 12px;
                            padding: 15px;
                            margin-top: 15px;
                            animation: slideIn 0.5s ease;
                        `;
                        materialNotice.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-chalkboard-teacher" style="color: #13c2c2; font-size: 1.2rem;"></i>
                                <strong style="color: #13c2c2;">‚úÖ ÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÂ∑≤ÁîüÊàê</strong>
                            </div>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 10px 0;">
                                üìö Âü∫‰∫é <strong>${knowledgePoints.length}</strong> ‰∏™‰∏é"${lessonTitle}"Áõ∏ÂÖ≥ÁöÑÁü•ËØÜÁÇπÁîüÊàê<br>
                                üéØ ÊïôÁ†îÁªÑËÆ®ËÆ∫ÁªìÊùüÂêéÔºåÂ∞ÜÊ†πÊçÆ‰∏ìÂÆ∂Âª∫ËÆÆÁîüÊàê‰ºòÂåñÁâàÊú¨
                            </p>
                            <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" onclick="toggleInitialMaterialPreview()" id="toggleInitialPreviewBtn" style="background: #13c2c2;">
                                    <i class="fas fa-eye"></i> Â±ïÂºÄÈ¢ÑËßà
                                </button>
                                <button class="btn" onclick="openInitialMaterialInNewWindow()" style="background: #52c41a;">
                                    <i class="fas fa-external-link-alt"></i> Êñ∞Á™óÂè£ÊâìÂºÄ
                                </button>
                                <button class="btn" onclick="downloadInitialMaterial()" style="background: #722ed1;">
                                    <i class="fas fa-download"></i> ‰∏ãËΩΩHTML
                                </button>
                            </div>
                            <div id="initialMaterialPreviewContainer" style="display: none; margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                    <span style="color: #13c2c2; font-weight: 600;">üì± ÂàùÊ≠•ÊºîÁ§∫È¢ÑËßà</span>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button onclick="zoomInitialFrame('in')" class="frame-control-btn" title="ÊîæÂ§ß">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button onclick="zoomInitialFrame('out')" class="frame-control-btn" title="Áº©Â∞è">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <button onclick="zoomInitialFrame('reset')" class="frame-control-btn" title="ÈáçÁΩÆ">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        <button onclick="toggleFullscreenInitial()" class="frame-control-btn" title="ÂÖ®Â±è">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                        <button onclick="toggleInitialMaterialPreview()" style="background: rgba(255,77,79,0.2); color: #ff4d4f; border: 1px solid rgba(255,77,79,0.3); padding: 5px 12px; border-radius: 6px; cursor: pointer;">
                                            <i class="fas fa-times"></i> Êî∂Ëµ∑
                                        </button>
                                    </div>
                                </div>
                                <div id="initialFrameContainer" style="position: relative; overflow: auto; background: #1a1a1a; border-radius: 8px;">
                                    <iframe id="initialMaterialPreviewFrame" style="width: 100%; height: 500px; border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.3s ease;"></iframe>
                                </div>
                                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                                    <button onclick="navigateInitialFrame('prev')" class="frame-nav-btn">
                                        <i class="fas fa-chevron-left"></i> ‰∏ä‰∏ÄÈ°µ
                                    </button>
                                    <span id="initialPageIndicator" style="color: rgba(255,255,255,0.7); padding: 8px 16px;">Á¨¨ 1 È°µ</span>
                                    <button onclick="navigateInitialFrame('next')" class="frame-nav-btn">
                                        ‰∏ã‰∏ÄÈ°µ <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        previewContainer.appendChild(materialNotice);
                    }
                }
            } catch (error) {
                console.error('ÁîüÊàêÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÂ§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞ÊùêÊñôÂàóË°®ÊòæÁ§∫
        function updateMaterialsList() {
            const materialsListDiv = document.getElementById('generatedMaterialsList');
            const materialsContent = document.getElementById('materialsListContent');
            
            if (!window.generatedMaterials || window.generatedMaterials.length === 0) {
                materialsListDiv.classList.add('hidden');
                return;
            }
            
            materialsListDiv.classList.remove('hidden');
            
            // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞ÁîüÊàêÂàóË°®
            materialsContent.innerHTML = window.generatedMaterials.map((material, index) => `
                <div class="material-card" style="background: linear-gradient(135deg, rgba(${material.type === 'initial' ? '19, 194, 194' : '114, 46, 209'}, 0.1), rgba(${material.type === 'initial' ? '19, 194, 194' : '114, 46, 209'}, 0.05)); border: 2px solid rgba(${material.type === 'initial' ? '19, 194, 194' : '114, 46, 209'}, 0.3); border-radius: 12px; padding: 20px; transition: all 0.3s ease;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-${material.type === 'initial' ? 'file-alt' : 'star'}" style="color: ${material.type === 'initial' ? '#13c2c2' : '#722ed1'}; font-size: 1.5rem;"></i>
                        <div>
                            <h4 style="margin: 0; color: white; font-size: 1.1rem;">${material.title}</h4>
                            <p style="margin: 5px 0 0 0; color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                                <i class="fas fa-lightbulb"></i> ${material.knowledgePoints} ‰∏™Áü•ËØÜÁÇπ ‚Ä¢ 
                                <i class="fas fa-clock"></i> ${material.timestamp}
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="previewMaterialFromList(${index})" class="list-material-btn" style="background: linear-gradient(135deg, #1890ff, #36cfc9);">
                            <i class="fas fa-eye"></i> È¢ÑËßà
                        </button>
                        <button onclick="openMaterialFromList(${index})" class="list-material-btn" style="background: linear-gradient(135deg, #52c41a, #73d13d);">
                            <i class="fas fa-external-link-alt"></i> ÊâìÂºÄ
                        </button>
                        <button onclick="downloadMaterialFromList(${index})" class="list-material-btn" style="background: linear-gradient(135deg, #722ed1, #9254de);">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ‰ªéÂàóË°®È¢ÑËßàÊùêÊñô
        window.previewMaterialFromList = function(index) {
            if (!window.generatedMaterials || !window.generatedMaterials[index]) return;
            
            const material = window.generatedMaterials[index];
            const newWindow = window.open('', '_blank', 'width=1200,height=800');
            newWindow.document.write(material.html);
            newWindow.document.close();
        };

        // ‰ªéÂàóË°®ÊâìÂºÄÊùêÊñô
        window.openMaterialFromList = function(index) {
            if (!window.generatedMaterials || !window.generatedMaterials[index]) return;
            
            const material = window.generatedMaterials[index];
            const newWindow = window.open('', '_blank');
            newWindow.document.write(material.html);
            newWindow.document.close();
        };

        // ‰ªéÂàóË°®‰∏ãËΩΩÊùêÊñô
        window.downloadMaterialFromList = function(index) {
            if (!window.generatedMaterials || !window.generatedMaterials[index]) return;
            
            const material = window.generatedMaterials[index];
            const blob = new Blob([material.html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${material.title}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // generateSummaryPageÂáΩÊï∞Â∑≤ÁßªËá≥ÂêéÈù¢Áªü‰∏ÄÂÆö‰πâÔºåÈÅøÂÖçÈáçÂ§ç
        
        // ÂàáÊç¢ÂàùÊ≠•ÊùêÊñôÈ¢ÑËßàÊòæÁ§∫
        window.toggleInitialMaterialPreview = function() {
            const previewContainer = document.getElementById('initialMaterialPreviewContainer');
            const previewFrame = document.getElementById('initialMaterialPreviewFrame');
            const toggleBtn = document.getElementById('toggleInitialPreviewBtn');
            
            if (previewContainer.style.display === 'none') {
                // Â±ïÂºÄÈ¢ÑËßà
                previewContainer.style.display = 'block';
                if (window.initialCourseMaterialHTML && !previewFrame.src) {
                    const blob = new Blob([window.initialCourseMaterialHTML], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    previewFrame.src = url;
                }
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Êî∂Ëµ∑È¢ÑËßà';
            } else {
                // Êî∂Ëµ∑È¢ÑËßà
                previewContainer.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Â±ïÂºÄÈ¢ÑËßà';
            }
        };

        // È¢ÑËßàÂàùÊ≠•ÊºîÁ§∫ÊùêÊñôÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        window.previewInitialMaterial = function() {
            toggleInitialMaterialPreview();
        };

        // Âú®Êñ∞Á™óÂè£ÊâìÂºÄÂàùÊ≠•ÊºîÁ§∫ÊùêÊñô
        window.openInitialMaterialInNewWindow = function() {
            if (window.initialCourseMaterialHTML) {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(window.initialCourseMaterialHTML);
                newWindow.document.close();
            }
        };

        // ‰∏ãËΩΩÂàùÊ≠•ÊºîÁ§∫ÊùêÊñô
        window.downloadInitialMaterial = function() {
            if (window.initialCourseMaterialHTML) {
                const blob = new Blob([window.initialCourseMaterialHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ÂàùÊ≠•ËØæÁ®ãÊºîÁ§∫ÊùêÊñô.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        // toggleOptimizedMaterialPreviewÁ≠âÁõ∏ÂÖ≥ÂáΩÊï∞Â∑≤Âú®ÂêéÈù¢Áªü‰∏ÄÂÆö‰πâ

        // ÊïôÊùêÊ£ÄÊü•ÁªÑÈïø - ÂàáÂâ≤Áü•ËØÜÁÇπÂπ∂ÁîüÊàêÁøªÈ°µÁ≥ªÁªü
        async function materialInspectorChief(discussionArea) {
            if (!window.generatedMaterials || window.generatedMaterials.length === 0) {
                console.log('Ê≤°ÊúâÂèØÁî®ÁöÑÊïôÊùêÈúÄË¶ÅÊ£ÄÊü•');
                return;
            }

            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ•discussionAreaÔºåÂ∞ùËØïËé∑ÂèñdiscussionRoundsÊàñmaterialContent
            if (!discussionArea) {
                discussionArea = document.getElementById('discussionRounds') || 
                                 document.getElementById('materialContent') ||
                                 document.getElementById('courseMaterialSection');
            }
            
            if (!discussionArea) {
                console.error('Êó†Ê≥ïÊâæÂà∞ÂêàÈÄÇÁöÑÂÆπÂô®ÂÖÉÁ¥†Êù•ÊòæÁ§∫ÊïôÊùêÊ£ÄÊü•ÁªìÊûú');
                return;
            }
            
            // ÊòæÁ§∫ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂ∑•‰ΩúËøõÂ∫¶
            const inspectorDiv = document.createElement('div');
            inspectorDiv.className = 'course-material-section';
            inspectorDiv.id = 'inspectorSection';
            inspectorDiv.innerHTML = `
                <div class="material-header" style="background: linear-gradient(135deg, #722ed1, #eb2f96);">
                    <i class="fas fa-user-check"></i>
                    <span>ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÊ≠£Âú®Â∑•‰Ωú...</span>
                </div>
                <div class="material-progress">
                    <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®‰ΩøÁî®Qwen AIÂàÜÊûêÂíåÂàáÂâ≤ÊïôÊùê‰∏≠ÁöÑÁü•ËØÜÁÇπ...
                </div>
                <div class="material-content" id="inspectorContent"></div>
            `;
            discussionArea.appendChild(inspectorDiv);

            // Ëé∑ÂèñËøõÂ∫¶ÂÖÉÁ¥†ÔºàÂú® try ÂùóÂ§ñÂ£∞ÊòéÔºåÈÅøÂÖçÈáçÂ§çÔºâ
            const progressDiv = inspectorDiv.querySelector('.material-progress');
            
            try {
                // ‰ΩøÁî®Qwen AIÂàÜÊûêÊâÄÊúâÊïôÊùêÂπ∂ÂàáÂâ≤Áü•ËØÜÁÇπ
                const allKnowledgePoints = [];
                
                console.log(`üîç ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂºÄÂßãÂàÜÊûê ${window.generatedMaterials.length} ‰∏™ÊïôÊùê`);
                
                for (let i = 0; i < window.generatedMaterials.length; i++) {
                    const material = window.generatedMaterials[i];
                    
                    console.log(`üìö Ê≠£Âú®ÂàÜÊûêÊïôÊùê ${i + 1}/${window.generatedMaterials.length}: ${material.title}`);
                    progressDiv.innerHTML = `
                        <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÂàÜÊûêÊïôÊùê ${i + 1}/${window.generatedMaterials.length}: ${material.title}
                        <div style="margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; height: 8px;">
                            <div style="width: ${(i / window.generatedMaterials.length) * 100}%; height: 100%; background: linear-gradient(90deg, #722ed1, #eb2f96); border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                    `;
                    
                    // ÊèêÂèñHTMLÁöÑÊñáÊú¨ÂÜÖÂÆπÔºàÂéªÈô§Â§ßÈáèÊ†áÁ≠æÔºâ
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = material.html;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    const contentSummary = textContent.substring(0, 2000); // Âè™ÂèñÂâç2000Â≠óÁ¨¶
                    
                    console.log(`üìÑ ÊïôÊùêÊñáÊú¨ÈïøÂ∫¶: ${textContent.length} Â≠óÁ¨¶`);
                    
                    const analysisPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÔºåË¥üË¥£Á≤æÂáÜÂàáÂâ≤Âíå‰ºòÂåñÊïôÂ≠¶ÊùêÊñô„ÄÇËØ∑‰ªîÁªÜÂàÜÊûê‰ª•‰∏ãËØæÁ®ãÊïôÊùêÂÜÖÂÆπÔºåËØÜÂà´Âπ∂ÊèêÂèñÂÖ∂‰∏≠ÁöÑÊâÄÊúâÁã¨Á´ãÁü•ËØÜÁÇπ„ÄÇ

ÊïôÊùêÊ†áÈ¢òÔºö${material.title}

ÊïôÊùêÂÜÖÂÆπÊëòË¶ÅÔºö
${contentSummary}

„ÄêÂàáÂâ≤Âíå‰ºòÂåñË¶ÅÊ±Ç„ÄëÔºö
1. ËØÜÂà´ÊïôÊùê‰∏≠ÁöÑ3-8‰∏™Ê†∏ÂøÉÁü•ËØÜÁÇπÔºåÊØè‰∏™Áü•ËØÜÁÇπÂøÖÈ°ªÊòØ‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ„ÄÅÁã¨Á´ãÁöÑÂ≠¶‰π†ÂçïÂÖÉ
2. ÊØè‰∏™Áü•ËØÜÁÇπÂ∫îËØ•ÂåÖÂê´Ôºö
   - Ê∏ÖÊô∞ÁÆÄÊ¥ÅÁöÑÊ†áÈ¢òÔºà8-15Â≠óÔºâ
   - ÂÆåÊï¥ÁöÑÊ†∏ÂøÉÂÜÖÂÆπËØ¥ÊòéÔºà100-200Â≠óÔºåË¶ÅËØ¶ÁªÜ‰∏îÊòìÊáÇÔºâ
   - 3-5‰∏™ÂÖ≥ÈîÆË¶ÅÁÇπÔºàÊØè‰∏™Ë¶ÅÁÇπË¶ÅÂÖ∑‰ΩìÊòéÁ°ÆÔºâ
   - 1-2‰∏™ÁîüÂä®ÁöÑÂÆû‰æãÊàñÂ∫îÁî®Âú∫ÊôØ
   - 1-2‰∏™‰∫íÂä®ÁªÉ‰π†ÊàñÊÄùËÄÉÈ¢ò
3. Áü•ËØÜÁÇπ‰πãÈó¥Ë¶ÅÊúâÊ∏ÖÊô∞ÁöÑÈÄªËæëÈÄíËøõÂÖ≥Á≥ª
4. Á°Æ‰øùÂÜÖÂÆπÈÄÇÂêàÂ∞èÂ≠¶ÁîüÁêÜËß£Ê∞¥Âπ≥
5. ÊØè‰∏™Áü•ËØÜÁÇπË¶ÅÂÖ∑ÊúâÁã¨Á´ãÁöÑÊïôÂ≠¶‰ª∑ÂÄº

„ÄêÁâπÂà´Ê≥®ÊÑè„ÄëÔºö
- Ê†áÈ¢òË¶ÅÂê∏Âºï‰∫∫Ôºå‰ΩìÁé∞Áü•ËØÜÁÇπÁöÑÊ†∏ÂøÉ‰ª∑ÂÄº
- ÂÜÖÂÆπË¶ÅÈÄö‰øóÊòìÊáÇÔºåÈÅøÂÖç‰∏ì‰∏öÊúØËØ≠Â†ÜÁ†å
- Á§∫‰æãË¶ÅË¥¥ËøëÂ≠¶ÁîüÁîüÊ¥ªÁªèÈ™å
- ÁªÉ‰π†Ë¶ÅÊúâË∂£Âë≥ÊÄßÂíåÂêØÂèëÊÄß

ËØ∑‰∏•Ê†º‰ª•JSONÊï∞ÁªÑÊ†ºÂºèËøîÂõûÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÈ¢ùÂ§ñÁöÑÊñáÂ≠óËØ¥ÊòéÔºö
[
  {
    "title": "Áü•ËØÜÁÇπÊ†áÈ¢ò",
    "order": 1,
    "content": "Ê†∏ÂøÉÂÜÖÂÆπÁöÑËØ¶ÁªÜËØ¥ÊòéÔºåË¶ÅÂÆåÊï¥„ÄÅÂáÜÁ°Æ„ÄÅÊòìÊáÇÔºà100-200Â≠óÔºâ",
    "keyPoints": ["ÂÖ∑‰ΩìË¶ÅÁÇπ1", "ÂÖ∑‰ΩìË¶ÅÁÇπ2", "ÂÖ∑‰ΩìË¶ÅÁÇπ3"],
    "examples": "ÁîüÂä®ÁöÑÂÆû‰æãÊàñÂ∫îÁî®Âú∫ÊôØËØ¥Êòé",
    "exercises": "ÊúâË∂£ÁöÑ‰∫íÂä®ÁªÉ‰π†ÊàñÊÄùËÄÉÈ¢ò"
  }
]

Âè™ËøîÂõûJSONÊï∞ÁªÑÔºå‰∏çË¶Åmarkdown‰ª£Á†ÅÂùóÊ†áËÆ∞Ôºå‰∏çË¶ÅÂÖ∂‰ªñ‰ªª‰ΩïÊñáÂ≠ó„ÄÇ`;

                    // ‰ΩøÁî®Qwen APIËøõË°åÁü•ËØÜÁÇπÂàÜÊûê
                    console.log(`ü§ñ Ë∞ÉÁî®Qwen APIÂàÜÊûêÁü•ËØÜÁÇπ...`);
                    let analysisResult = '';
                    try {
                        analysisResult = await callQwenAPI(analysisPrompt);
                        console.log(`‚úÖ Qwen APIËøîÂõûÁªìÊûúÔºàÈïøÂ∫¶: ${analysisResult.length}Ôºâ`);
                        console.log(`üìù ËøîÂõûÂÜÖÂÆπÂâç200Â≠óÁ¨¶: ${analysisResult.substring(0, 200)}`);
                    } catch (apiError) {
                        console.error(`‚ùå Qwen APIË∞ÉÁî®Â§±Ë¥•:`, apiError);
                        throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${apiError.message}`);
                    }
                    
                    let knowledgePoints = [];
                    try {
                        // Ê∏ÖÁêÜÂèØËÉΩÁöÑmarkdown‰ª£Á†ÅÂùóÊ†áËÆ∞
                        let cleanResult = analysisResult.trim();
                        if (cleanResult.startsWith('```json')) {
                            cleanResult = cleanResult.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                        } else if (cleanResult.startsWith('```')) {
                            cleanResult = cleanResult.replace(/```\n?/g, '');
                        }
                        
                        console.log(`üîß Ê∏ÖÁêÜÂêéÁöÑJSON: ${cleanResult.substring(0, 200)}`);
                        knowledgePoints = JSON.parse(cleanResult);
                        console.log(`‚úÖ ÊàêÂäüËß£Êûê ${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπ`);
                    } catch (e) {
                        console.error(`‚ùå JSONËß£ÊûêÂ§±Ë¥•:`, e);
                        console.error(`ÂéüÂßãËøîÂõûÂÜÖÂÆπ:`, analysisResult.substring(0, 500));
                        console.warn(`‚ö†Ô∏è ‰ΩøÁî®Â§áÁî®Ëá™Âä®ÂàáÂâ≤ÊñπÊ°à`);
                        // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåÊåâÁ´†ËäÇËá™Âä®ÂàáÂâ≤
                        knowledgePoints = autoSplitKnowledgePoints(material.html, material.title);
                        console.log(`üìê Â§áÁî®ÊñπÊ°àÂàáÂâ≤Âá∫ ${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπ`);
                    }
                    
                    // ‰∏∫ÊØè‰∏™Áü•ËØÜÁÇπÁîüÊàêÁã¨Á´ãÁöÑHTML
                    console.log(`üé® ÂºÄÂßã‰∏∫ ${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπÁîüÊàêHTMLÈ°µÈù¢...`);
                    for (let j = 0; j < knowledgePoints.length; j++) {
                        const kp = knowledgePoints[j];
                        console.log(`  üìÑ ÁîüÊàêÁü•ËØÜÁÇπ ${j + 1}/${knowledgePoints.length}: ${kp.title}`);
                        
                        progressDiv.innerHTML = `
                            <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÁîüÊàêÁü•ËØÜÁÇπHTML ${j + 1}/${knowledgePoints.length}: ${kp.title}
                            <div style="margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; height: 8px;">
                                <div style="width: ${((i + (j + 1) / knowledgePoints.length) / window.generatedMaterials.length) * 100}%; height: 100%; background: linear-gradient(90deg, #722ed1, #eb2f96); border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                        `;
                        
                        try {
                            const kpHTML = await generateKnowledgePointHTML(kp, material.title);
                            if (kpHTML && kpHTML.length > 100) {
                                console.log(`  ‚úÖ Áü•ËØÜÁÇπHTMLÁîüÊàêÊàêÂäüÔºàÈïøÂ∫¶: ${kpHTML.length}Ôºâ`);
                                allKnowledgePoints.push({
                                    materialTitle: material.title,
                                    materialType: material.type,
                                    knowledgePoint: kp,
                                    html: kpHTML
                                });
                            } else {
                                console.warn(`  ‚ö†Ô∏è Áü•ËØÜÁÇπHTMLÁîüÊàêÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠Ôºå‰ΩøÁî®Â§áÁî®Ê®°Êùø`);
                                const basicHTML = generateBasicKnowledgePointHTML(kp, material.title);
                                allKnowledgePoints.push({
                                    materialTitle: material.title,
                                    materialType: material.type,
                                    knowledgePoint: kp,
                                    html: basicHTML
                                });
                            }
                        } catch (htmlError) {
                            console.error(`  ‚ùå Áü•ËØÜÁÇπHTMLÁîüÊàêÂºÇÂ∏∏:`, htmlError);
                            const basicHTML = generateBasicKnowledgePointHTML(kp, material.title);
                            allKnowledgePoints.push({
                                materialTitle: material.title,
                                materialType: material.type,
                                knowledgePoint: kp,
                                html: basicHTML
                            });
                        }
                    }
                }
                
                console.log(`üéâ ÊâÄÊúâÊïôÊùêÂàÜÊûêÂÆåÊàêÔºÅÂÖ±ÂàáÂâ≤Âá∫ ${allKnowledgePoints.length} ‰∏™Áü•ËØÜÁÇπ`);


                // ÁîüÊàêÂ∏¶ÁøªÈ°µÂäüËÉΩÁöÑÊ±áÊÄªHTML
                const summaryHTML = generateKnowledgePointSummaryHTML(allKnowledgePoints);
                
                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
                window.knowledgePointsCollection = allKnowledgePoints;
                window.knowledgePointsSummaryHTML = summaryHTML;

                // Êõ¥Êñ∞ÊòæÁ§∫
                const inspectorHeader = inspectorDiv.querySelector('.material-header span');
                inspectorHeader.textContent = '‚úÖ ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂÆåÊàêÁü•ËØÜÁÇπÂàáÂâ≤';
                
                const finalProgressDiv = inspectorDiv.querySelector('.material-progress');
                finalProgressDiv.innerHTML = `
                    <div style="color: #52c41a; margin: 15px 0;">
                        <i class="fas fa-check-circle"></i> Â∑≤ÊàêÂäüÂàáÂâ≤ ${allKnowledgePoints.length} ‰∏™Áã¨Á´ãÁü•ËØÜÁÇπ
                    </div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 10px;">
                        üí° ÊØè‰∏™Áü•ËØÜÁÇπÈÉΩÂ∑≤ËΩ¨Êç¢‰∏∫Áã¨Á´ãÁöÑÂèØÁøªÈ°µHTMLÈ°µÈù¢
                    </div>
                `;

                const inspectorContent = document.getElementById('inspectorContent');
                inspectorContent.innerHTML = `
                    <div class="material-actions">
                        <button class="material-btn" onclick="openKnowledgePointViewer()" style="background: linear-gradient(135deg, #722ed1, #eb2f96); font-size: 1.1rem; padding: 12px 24px; animation: pulse 2s infinite;">
                            <i class="fas fa-book-open"></i> üöÄ ÊâìÂºÄÁü•ËØÜÁÇπÊµèËßàÂô®
                        </button>
                        <button class="material-btn" onclick="downloadKnowledgePointSummary()">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩÁü•ËØÜÁÇπÊ±áÊÄªHTML
                        </button>
                        <button class="material-btn" onclick="generateSummaryPage()" style="background: linear-gradient(135deg, #fa8c16, #faad14);">
                            <i class="fas fa-file-invoice"></i> ÁîüÊàêÊâÄÊúâÊùêÊñôÊ±áÊÄª
                        </button>
                    </div>
                `;
                
                // ÊòæÁ§∫È°∂ÈÉ®Âø´Êç∑ËÆøÈóÆÊ†è
                const quickAccessBar = document.getElementById('quickAccessBar');
                if (quickAccessBar) {
                    quickAccessBar.classList.add('show');
                }
                
                // ÊªöÂä®Âà∞ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂå∫Âüü
                setTimeout(() => {
                    ScrollManager.scrollTo(inspectorDiv, { offset: window.innerHeight / 3 });
                }, 500);
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showMessage('üéâ ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂÆåÊàêÔºÅÂ∑≤ÂàáÂâ≤ ' + allKnowledgePoints.length + ' ‰∏™Áü•ËØÜÁÇπÔºåËØ∑Êü•ÁúãÈ°∂ÈÉ®Âø´Êç∑Ê†èÊàñ‰∏ãÊñπÊåâÈíÆÔºÅ', 'success');

            } catch (error) {
                console.error('ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂ∑•‰ΩúÂ§±Ë¥•:', error);
                const inspectorHeader = inspectorDiv.querySelector('.material-header span');
                if (inspectorHeader) {
                    inspectorHeader.textContent = '‚ùå Áü•ËØÜÁÇπÂàáÂâ≤Â§±Ë¥•';
                }
                // ‰ΩøÁî®Â§ñÈÉ®Â∑≤Â£∞ÊòéÁöÑ progressDivÔºå‰∏çÈáçÂ§çÂ£∞Êòé
                if (progressDiv) {
                    progressDiv.innerHTML = `<div style="color: #ff4d4f;">ÈîôËØØÔºö${error.message}</div>`;
                }
            }
        }

        // Ëá™Âä®ÂàáÂâ≤Áü•ËØÜÁÇπÔºàÂ§áÁî®ÊñπÊ°àÔºâ
        function autoSplitKnowledgePoints(html, materialTitle) {
            console.log(`üìê ‰ΩøÁî®Â§áÁî®Ëá™Âä®ÂàáÂâ≤ÊñπÊ°àÂàÜÊûê: ${materialTitle}`);
            const knowledgePoints = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Êü•ÊâæÊâÄÊúâÂèØËÉΩÁöÑÁü•ËØÜÁÇπÂÆπÂô®
            const sections = tempDiv.querySelectorAll('section, .knowledge-point, .card, article, .chapter, div[class*="point"], div[class*="section"]');
            
            console.log(`  ÊâæÂà∞ ${sections.length} ‰∏™ÂèØËÉΩÁöÑÁ´†ËäÇÂÆπÂô®`);
            
            if (sections.length === 0) {
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÁªìÊûÑÔºåÂ∞ùËØïÊåâÊÆµËêΩÂàÜÂâ≤
                const paragraphs = tempDiv.querySelectorAll('p, div');
                const validParagraphs = Array.from(paragraphs).filter(p => {
                    const text = p.textContent?.trim() || '';
                    return text.length > 50 && text.length < 500;
                });
                
                console.log(`  ÊâæÂà∞ ${validParagraphs.length} ‰∏™ÊúâÊïàÊÆµËêΩ`);
                
                if (validParagraphs.length > 0) {
                    // ÊåâÊÆµËêΩÁîüÊàêÁü•ËØÜÁÇπÔºàÊúÄÂ§öÂèñ5‰∏™Ôºâ
                    validParagraphs.slice(0, 5).forEach((para, index) => {
                        const text = para.textContent.trim();
                        const title = text.substring(0, 30).replace(/\n/g, ' ') + '...';
                        knowledgePoints.push({
                            title: title,
                            order: index + 1,
                            content: text.substring(0, 200),
                            keyPoints: [text.substring(0, 80)],
                            examples: '',
                            exercises: ''
                        });
                    });
                } else {
                    // ÂÆåÂÖ®Êó†Ê≥ïËØÜÂà´ÔºåÂàõÂª∫Âçï‰∏™ÈªòËÆ§Áü•ËØÜÁÇπ
                    console.warn(`  ‚ö†Ô∏è Êó†Ê≥ïËØÜÂà´HTMLÁªìÊûÑÔºåÁîüÊàêÂçï‰∏™ÈªòËÆ§Áü•ËØÜÁÇπ`);
                    return [{
                        title: materialTitle || 'ËØæÁ®ãÂÜÖÂÆπ',
                        order: 1,
                        content: 'ËøôÊòØËØæÁ®ãÁöÑÂÆåÊï¥ÂÜÖÂÆπ„ÄÇËØ∑Êü•ÁúãÂéüÂßãÊïôÊùêËé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ',
                        keyPoints: ['ËØæÁ®ãÊ†∏ÂøÉÂÜÖÂÆπ', 'ÊïôÂ≠¶ÁõÆÊ†á', 'Â≠¶‰π†Ë¶ÅÁÇπ'],
                        examples: 'ÂèÇËÄÉÊïôÊùê‰∏≠ÁöÑÂÖ∑‰ΩìÁ§∫‰æã',
                        exercises: 'ÂÆåÊàêÊïôÊùê‰∏≠ÁöÑÁªÉ‰π†È¢ò'
                    }];
                }
            } else {
                // ÊåâÁÖßÊâæÂà∞ÁöÑÁ´†ËäÇÂÆπÂô®ÂàÜÂâ≤
                sections.forEach((section, index) => {
                    const title = section.querySelector('h1, h2, h3, h4, h5, .title, [class*="title"]')?.textContent?.trim() 
                                 || `Á¨¨ ${index + 1} ÈÉ®ÂàÜ`;
                    const content = section.textContent?.trim().substring(0, 200) || 'ÂÜÖÂÆπËØ¶ËßÅÊïôÊùê';
                    
                    // Â∞ùËØïÊèêÂèñÂÖ≥ÈîÆÁÇπ
                    const listItems = section.querySelectorAll('li, .point, [class*="key"]');
                    const keyPoints = listItems.length > 0 
                        ? Array.from(listItems).slice(0, 5).map(li => li.textContent?.trim().substring(0, 50))
                        : ['Êü•ÁúãÊïôÊùêËØ¶ÁªÜÂÜÖÂÆπ'];
                    
                    knowledgePoints.push({
                        title: title.substring(0, 50),
                        order: index + 1,
                        content: content,
                        keyPoints: keyPoints.filter(k => k && k.length > 0),
                        examples: '',
                        exercises: ''
                    });
                });
            }

            console.log(`  ‚úÖ Â§áÁî®ÊñπÊ°àÁîüÊàê‰∫Ü ${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπ`);
            return knowledgePoints.slice(0, 8); // ÊúÄÂ§öËøîÂõû8‰∏™Áü•ËØÜÁÇπ
        }

        // ‰∏∫Âçï‰∏™Áü•ËØÜÁÇπÁîüÊàêHTML
        async function generateKnowledgePointHTML(knowledgePoint, materialTitle) {
            const kpPrompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÂ≠¶ÂÜÖÂÆπËÆæËÆ°Â∏àÂíåÂâçÁ´ØÂºÄÂèë‰∏ìÂÆ∂ÔºåËØ∑‰∏∫‰ª•‰∏ãÁü•ËØÜÁÇπÁîüÊàê‰∏Ä‰∏™Á≤æÁæé„ÄÅ‰∫§‰∫íÂºè„ÄÅÂäüËÉΩÂÆåÊï¥ÁöÑÁã¨Á´ãHTMLÈ°µÈù¢„ÄÇ

„ÄêÁü•ËØÜÁÇπ‰ø°ÊÅØ„ÄëÔºö
- üìå Ê†áÈ¢òÔºö${knowledgePoint.title}
- üî¢ È°∫Â∫èÔºöÁ¨¨${knowledgePoint.order}‰∏™Áü•ËØÜÁÇπ
- üìö Êù•Ê∫êÔºö${materialTitle}
- üìñ Ê†∏ÂøÉÂÜÖÂÆπÔºö${knowledgePoint.content}
- üéØ ÂÖ≥ÈîÆË¶ÅÁÇπÔºö${knowledgePoint.keyPoints.join(' | ')}
- üí° Á§∫‰æãÔºö${knowledgePoint.examples}
- üî¨ ÁªÉ‰π†Ôºö${knowledgePoint.exercises}

„ÄêÈ°µÈù¢ËÆæËÆ°Ë¶ÅÊ±Ç„ÄëÔºö

**1. ÂÆåÊï¥ÁöÑHTML5ÁªìÊûÑ**
\`\`\`html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${knowledgePoint.title}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
    /* ‰Ω†ÁöÑÁ≤æÁæéCSSÊ†∑Âºè */
    </style>
</head>
<body>
    <!-- ‰Ω†ÁöÑÁ≤æÁæéÂÜÖÂÆπ -->
</body>
</html>
\`\`\`

**2. Áé∞‰ª£ÂåñËßÜËßâËÆæËÆ°**
- Ê∏êÂèòËÉåÊôØÔºölinear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)
- Âç°ÁâáËÆæËÆ°ÔºöÁôΩËâ≤ÂçäÈÄèÊòéËÉåÊôØ(rgba(255,255,255,0.95))ÔºåÂúÜËßí20pxÔºåÈò¥ÂΩ±ÊïàÊûú
- Âä®ÁîªÊïàÊûúÔºöÊ∑°ÂÖ•„ÄÅ‰∏äÊµÆ„ÄÅhover‰∫§‰∫í
- ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÔºöÁßªÂä®Á´Ø„ÄÅÂπ≥Êùø„ÄÅÊ°åÈù¢Á´ØÂÆåÁæéÈÄÇÈÖç
- ÈÖçËâ≤ÊñπÊ°àÔºö‰∏ªËâ≤#667eeaÔºåËæÖËâ≤#764ba2ÔºåÂº∫Ë∞ÉËâ≤#eb2f96

**3. È°µÈù¢ÂÜÖÂÆπÁªìÊûÑ**Ôºà‰ªé‰∏äÂà∞‰∏ãÔºâ
- Áü•ËØÜÁÇπÂæΩÁ´†ÔºàÂ∞èÂõæÊ†á+Â∫èÂè∑Ôºâ
- Â§ßÊ†áÈ¢òÔºà40pxÔºåÁ≤ó‰ΩìÔºåÂ±Ö‰∏≠Ôºâ
- ÂàÜÈöîÁ∫ø
- Ê†∏ÂøÉÂÜÖÂÆπÂç°ÁâáÔºàÊÆµËêΩÂΩ¢ÂºèÔºå18pxÔºåË°åÈ´ò1.8Ôºâ
- ÂÖ≥ÈîÆË¶ÅÁÇπÂç°Áâá
  - Ë¶ÅÁÇπ1ÔºàÂ∏¶ÂõæÊ†áÔºâ
  - Ë¶ÅÁÇπ2ÔºàÂ∏¶ÂõæÊ†áÔºâ
  - Ë¶ÅÁÇπ3ÔºàÂ∏¶ÂõæÊ†áÔºâ
- Á§∫‰æãÂ∫îÁî®Âç°ÁâáÔºàÂ¶ÇÊûúÊúâÔºâ
  - ÁîüÂä®Ê°à‰æãÔºåÂ∏¶ÊèíÂõæÊïàÊûú
- ‰∫íÂä®ÁªÉ‰π†Âç°ÁâáÔºàÂ¶ÇÊûúÊúâÔºâ
  - ÂèØÁÇπÂáªÊòæÁ§∫Á≠îÊ°àÁöÑÊåâÈíÆ
- Áü•ËØÜÊãìÂ±ïÂå∫Âüü
  - Áõ∏ÂÖ≥ÈìæÊé•ÊàñÊâ©Â±ïÂÜÖÂÆπ
- Â∫ïÈÉ®ÊèêÁ§∫Ê†è
  - Â∑¶Âè≥ÁÆ≠Â§¥ÂàáÊç¢ÊèêÁ§∫

**4. ‰∫§‰∫íÂäüËÉΩÂÆûÁé∞**
- È°µÈù¢Âä†ËΩΩÂä®ÁîªÔºöfadeIn + slideUp (0.8s)
- Âç°ÁâáÊÇ¨ÂÅúÊïàÊûúÔºötransform: translateY(-5px) + Èò¥ÂΩ±Âä†Ê∑±
- ÁªÉ‰π†Á≠îÊ°àÊåâÈíÆÔºöÁÇπÂáªÂàáÊç¢ÊòæÁ§∫/ÈöêËóèÔºåÂ∏¶Ê∏êÂèòÂä®Áîª
- ÊªöÂä®Âä®ÁîªÔºöÂÜÖÂÆπÈÄê‰∏™Ê∑°ÂÖ•ÔºàÂèØÈÄâÔºâ
- Âπ≥ÊªëÊªöÂä®Ôºöscroll-behavior: smooth

**5. Ê†∑ÂºèÁªÜËäÇË¶ÅÊ±Ç**
- Â≠ó‰ΩìÔºöInter, -apple-system, PingFang SC, Microsoft YaHei
- Ê†áÈ¢òÂ±ÇÁ∫ßÔºöh1(40px) > h2(28px) > h3(22px)
- Ë°åÈ´òÔºöÊ†áÈ¢ò1.4ÔºåÊ≠£Êñá1.8
- Èó¥Ë∑ùÔºösection‰πãÈó¥30pxÔºåÂÖÉÁ¥†‰πãÈó¥15px
- ËæπÊ°ÜÔºö‰ΩøÁî®rgba(255,255,255,0.3)ÂçäÈÄèÊòéÁôΩËâ≤
- Èò¥ÂΩ±Ôºö0 10px 40px rgba(0,0,0,0.15)

**6. ÂøÖÈ°ªÂåÖÂê´ÁöÑCSSÁ±ª**
- .container: ‰∏ªÂÆπÂô®ÔºåÂ±Ö‰∏≠ÔºåÊúÄÂ§ßÂÆΩÂ∫¶1000px
- .card: ÂÜÖÂÆπÂç°ÁâáÔºåÁôΩËâ≤ËÉåÊôØÔºåÂúÜËßíÔºåÈò¥ÂΩ±
- .badge: ÂæΩÁ´†Ê†áÁ≠æÔºåÊ∏êÂèòËÉåÊôØ
- .key-point: ÂÖ≥ÈîÆË¶ÅÁÇπÈ°πÔºåÂ∏¶ÂõæÊ†á
- .interactive-box: ‰∫íÂä®Âå∫ÂüüÔºåÁâπÊÆäÊ†∑Âºè
- .hint-text: ÊèêÁ§∫ÊñáÂ≠óÔºåÂ∫ïÈÉ®Â±Ö‰∏≠

**7. ‰ª£Á†ÅË¥®ÈáèË¶ÅÊ±Ç**
- ÊâÄÊúâCSSÂÜôÂú®<style>Ê†áÁ≠æÂÜÖ
- ‰ª£Á†ÅÊ†ºÂºèÊï¥ÈΩêÔºåÈÄÇÂΩìÁº©Ëøõ
- Ê∑ªÂä†‰∏≠ÊñáÊ≥®ÈáäËØ¥ÊòéÂêÑÈÉ®ÂàÜÂäüËÉΩ
- Á°Æ‰øùÊâÄÊúâÊåâÈíÆÂíå‰∫§‰∫íÂäüËÉΩÊ≠£Â∏∏Â∑•‰Ωú
- Ê≤°ÊúâÊéßÂà∂Âè∞ÈîôËØØ

**8. ÁâπÂà´Âº∫Ë∞É**
- È°µÈù¢ÂøÖÈ°ªÁæéËßÇÂ§ßÊñπÔºåÈÄÇÂêàÂ∞èÂ≠¶ÁîüËßÇÁúã
- ÂÜÖÂÆπÊéíÁâàÊ∏ÖÊô∞ÔºåÈáçÁÇπÁ™ÅÂá∫
- È¢úËâ≤Êê≠ÈÖçÂíåË∞êÔºå‰∏çÂà∫Áúº
- ÊâÄÊúâ‰∫§‰∫íÂÖÉÁ¥†ÈÉΩË¶ÅÊúâÊòéÊòæÁöÑËßÜËßâÂèçÈ¶à
- Á°Æ‰øùÂú®ÁøªÈ°µÊµèËßàÂô®‰∏≠ÊòæÁ§∫ÂÆåÁæé

ËØ∑Áõ¥Êé•ËæìÂá∫ÂÆåÊï¥ÁöÑHTML‰ª£Á†ÅÔºå‰ªé<!DOCTYPE html>ÂºÄÂßãÂà∞</html>ÁªìÊùüÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïmarkdownÊ†áËÆ∞ÊàñËß£ÈáäÊñáÂ≠ó„ÄÇ`;

            try {
                // ‰ΩøÁî®Qwen APIÁîüÊàêHTMLÔºàÊõ¥ÈÄÇÂêàÈïøÂÜÖÂÆπÁîüÊàêÔºâ
                const html = await callQwenAPI(kpPrompt);
                return html;
            } catch (error) {
                console.error('Áü•ËØÜÁÇπHTMLÁîüÊàêÂ§±Ë¥•:', error);
                // ËøîÂõû‰∏Ä‰∏™Âü∫Á°ÄÁöÑHTMLÊ®°Êùø
                return generateBasicKnowledgePointHTML(knowledgePoint, materialTitle);
            }
        }

        // Âü∫Á°ÄÁü•ËØÜÁÇπHTMLÊ®°ÊùøÔºàÂ§áÁî®Ôºâ- ‰ºòÂåñÁæéÂåñÁâà
        function generateBasicKnowledgePointHTML(kp, materialTitle) {
            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${kp.title}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            animation: gradientShift 15s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 50px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.25);
            animation: fadeInUp 0.8s ease;
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideIn 0.8s ease 0.2s both;
        }
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        h1 {
            color: #2c3e50;
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            line-height: 1.3;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 1rem;
            margin-top: 10px;
        }
        .divider {
            height: 3px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 30px 0;
            border-radius: 2px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            animation: slideIn 0.8s ease 0.4s both;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .card-header i {
            font-size: 1.8rem;
        }
        .content-text {
            color: #34495e;
            line-height: 1.9;
            font-size: 1.15rem;
            text-align: justify;
        }
        .key-points {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            padding: 25px;
            border-radius: 16px;
            border-left: 4px solid #667eea;
        }
        .key-points h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .key-points ul {
            list-style: none;
        }
        .key-points li {
            margin: 15px 0;
            padding-left: 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.6s ease calc(0.6s + var(--delay)) both;
        }
        .key-points li:nth-child(1) { --delay: 0.1s; }
        .key-points li:nth-child(2) { --delay: 0.2s; }
        .key-points li:nth-child(3) { --delay: 0.3s; }
        .key-points li:nth-child(4) { --delay: 0.4s; }
        .key-points li:nth-child(5) { --delay: 0.5s; }
        .key-points li i {
            color: #52c41a;
            font-size: 1.2rem;
            margin-top: 3px;
        }
        .example-box, .exercise-box {
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8dc 100%);
            padding: 25px;
            border-radius: 16px;
            margin: 25px 0;
            border-left: 4px solid #eb2f96;
            animation: slideIn 0.8s ease 0.6s both;
        }
        .example-box h3, .exercise-box h3 {
            color: #eb2f96;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .example-box p, .exercise-box p {
            color: #5a3825;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .exercise-box {
            background: linear-gradient(135deg, #f0fff0 0%, #dcffe4 100%);
            border-left-color: #52c41a;
        }
        .exercise-box h3 {
            color: #52c41a;
        }
        .exercise-box p {
            color: #2d4a2b;
        }
        .navigation-hint {
            text-align: center;
            color: #7f8c8d;
            margin-top: 50px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            font-size: 1rem;
            animation: slideIn 0.8s ease 0.8s both;
        }
        .navigation-hint i {
            font-size: 1.5rem;
            margin-bottom: 10px;
            display: block;
            color: #667eea;
        }
        @media (max-width: 768px) {
            .container { padding: 30px 20px; }
            h1 { font-size: 2rem; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="badge">
                <i class="fas fa-book-reader"></i> Á¨¨${kp.order}‰∏™Áü•ËØÜÁÇπ
            </div>
            <h1><i class="fas fa-graduation-cap"></i> ${kp.title}</h1>
            <div class="subtitle">üìö Êù•Ê∫êÔºö${materialTitle}</div>
        </div>
        
        <div class="divider"></div>
        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-book-open"></i>
                <span>Ê†∏ÂøÉÂÜÖÂÆπ</span>
            </div>
            <div class="content-text">
                ${kp.content}
            </div>
        </div>
        
        <div class="card key-points">
            <h3><i class="fas fa-lightbulb"></i> ÂÖ≥ÈîÆË¶ÅÁÇπ</h3>
            <ul>
                ${kp.keyPoints.map(point => `<li><i class="fas fa-check-circle"></i> <span>${point}</span></li>`).join('')}
            </ul>
        </div>
        
        ${kp.examples ? `
        <div class="example-box">
            <h3><i class="fas fa-flask"></i> ÂÆû‰æãÂ∫îÁî®</h3>
            <p>${kp.examples}</p>
        </div>` : ''}
        
        ${kp.exercises ? `
        <div class="exercise-box">
            <h3><i class="fas fa-pen-fancy"></i> ‰∫íÂä®ÁªÉ‰π†</h3>
            <p>${kp.exercises}</p>
        </div>` : ''}
        
        <div class="navigation-hint">
            <i class="fas fa-hand-point-left"></i>
            <strong>ÊèêÁ§∫Ôºö</strong>‰ΩøÁî®Â∫ïÈÉ®ÁöÑÂ∑¶Âè≥ÁÆ≠Â§¥ÊåâÈíÆÊàñÈîÆÁõòÊñπÂêëÈîÆÂàáÊç¢Áü•ËØÜÁÇπ
        </div>
    </div>
</body>
</html>`;
        }

        // ÁîüÊàêÂ∏¶ÁøªÈ°µÂäüËÉΩÁöÑÁü•ËØÜÁÇπÊ±áÊÄªHTML
        function generateKnowledgePointSummaryHTML(knowledgePoints) {
            const htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áü•ËØÜÁÇπÊµèËßàÂô® - Êô∫ËÉΩÁøªÈ°µÁ≥ªÁªü</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }
        
        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-nav {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-controls {
            display: flex;
            gap: 10px;
        }
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ÂÜÖÂÆπÂå∫Âüü */
        .content-area {
            height: calc(100vh - 140px);
            position: relative;
        }
        .knowledge-point-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: none;
        }
        .knowledge-point-frame.active {
            display: block;
        }
        
        /* Â∫ïÈÉ®ÂØºËà™ */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }
        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .page-info {
            color: white;
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }
        .page-title {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        /* ËøõÂ∫¶Êù° */
        .progress-bar {
            position: fixed;
            top: 61px;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 999;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #eb2f96);
            transition: width 0.3s ease;
        }
        
        /* ‰æßËæπÊ†èÁõÆÂΩï */
        .sidebar {
            position: fixed;
            right: -320px;
            top: 65px;
            width: 300px;
            height: calc(100vh - 85px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 998;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar.open {
            right: 0;
        }
        .toc-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        .toc-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }
        .toc-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .toc-number {
            font-weight: 600;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <div class="top-nav">
        <div class="nav-title">
            <i class="fas fa-graduation-cap"></i>
            Áü•ËØÜÁÇπÊµèËßàÂô®
        </div>
        <div class="nav-controls">
            <button class="nav-btn" onclick="toggleSidebar()">
                <i class="fas fa-list"></i>
                <span>ÁõÆÂΩï</span>
            </button>
            <button class="nav-btn" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i>
                <span>ÂÖ®Â±è</span>
            </button>
            <button class="nav-btn" onclick="downloadAll()">
                <i class="fas fa-download"></i>
                <span>‰∏ãËΩΩHTML</span>
            </button>
            <button class="nav-btn" onclick="exportCurrentToPDF()" style="background: rgba(235, 47, 150, 0.3);">
                <i class="fas fa-file-pdf"></i>
                <span>ÂΩìÂâçÂØºÂá∫PDF</span>
            </button>
            <button class="nav-btn" onclick="exportAllToPDF()" style="background: rgba(235, 47, 150, 0.4);">
                <i class="fas fa-file-export"></i>
                <span>ÂÖ®ÈÉ®ÂØºÂá∫PDF</span>
            </button>
        </div>
    </div>
    
    <!-- ËøõÂ∫¶Êù° -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <!-- ÂÜÖÂÆπÂå∫Âüü -->
    <div class="content-area" id="contentArea"></div>
    
    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <div class="bottom-nav">
        <button class="control-btn" id="prevBtn" onclick="navigateTo('prev')">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="page-info">
            <div id="pageNumber">1 / \${knowledgePoints.length}</div>
            <div class="page-title" id="pageTitle">Áü•ËØÜÁÇπÊ†áÈ¢ò</div>
        </div>
        <button class="control-btn" id="nextBtn" onclick="navigateTo('next')">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    
    <!-- ‰æßËæπÊ†èÁõÆÂΩï -->
    <div class="sidebar" id="sidebar">
        <h3 style="color: white; margin-bottom: 20px; font-size: 1.2rem;">
            <i class="fas fa-book"></i> Áü•ËØÜÁÇπÁõÆÂΩï
        </h3>
        <div id="tocList"></div>
    </div>
    
    ${'<'}script>
        const knowledgePoints = ${JSON.stringify(knowledgePoints)};
        let currentIndex = 0;
        let sidebarOpen = false;
        
        // ÂàùÂßãÂåñ
        function init() {
            const contentArea = document.getElementById('contentArea');
            
            // ÂàõÂª∫ÊâÄÊúâiframe
            knowledgePoints.forEach((kp, index) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'knowledge-point-frame' + (index === 0 ? ' active' : '');
                iframe.id = 'frame-' + index;
                
                const blob = new Blob([kp.html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                contentArea.appendChild(iframe);
            });
            
            // ÁîüÊàêÁõÆÂΩï
            const tocList = document.getElementById('tocList');
            knowledgePoints.forEach((kp, index) => {
                const tocItem = document.createElement('div');
                tocItem.className = 'toc-item' + (index === 0 ? ' active' : '');
                tocItem.id = 'toc-' + index;
                tocItem.innerHTML = \`
                    <div class="toc-number">\${index + 1}.</div>
                    <div>\${kp.knowledgePoint.title}</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 4px;">
                        Êù•Ëá™: \${kp.materialTitle}
                    </div>
                \`;
                tocItem.onclick = () => navigateToIndex(index);
                tocList.appendChild(tocItem);
            });
            
            updateUI();
        }
        
        // ÂØºËà™ÊéßÂà∂
        function navigateTo(direction) {
            if (direction === 'prev' && currentIndex > 0) {
                currentIndex--;
            } else if (direction === 'next' && currentIndex < knowledgePoints.length - 1) {
                currentIndex++;
            }
            showKnowledgePoint(currentIndex);
        }
        
        function navigateToIndex(index) {
            currentIndex = index;
            showKnowledgePoint(currentIndex);
            if (sidebarOpen) toggleSidebar();
        }
        
        function showKnowledgePoint(index) {
            // ÈöêËóèÊâÄÊúâiframe
            document.querySelectorAll('.knowledge-point-frame').forEach(frame => {
                frame.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÂΩìÂâçiframe
            document.getElementById('frame-' + index).classList.add('active');
            
            // Êõ¥Êñ∞ÁõÆÂΩïÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.toc-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('toc-' + index).classList.add('active');
            
            updateUI();
        }
        
        function updateUI() {
            const kp = knowledgePoints[currentIndex];
            
            // Êõ¥Êñ∞È°µÁ†Å
            document.getElementById('pageNumber').textContent = (currentIndex + 1) + ' / ' + knowledgePoints.length;
            document.getElementById('pageTitle').textContent = kp.knowledgePoint.title;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === knowledgePoints.length - 1;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progress = ((currentIndex + 1) / knowledgePoints.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                navigateTo('prev');
            } else if (e.key === 'ArrowRight') {
                navigateTo('next');
            } else if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
        });
        
        // ‰æßËæπÊ†èÊéßÂà∂
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        // ÂÖ®Â±èÊéßÂà∂
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // ‰∏ãËΩΩÊâÄÊúâÁü•ËØÜÁÇπ
        function downloadAll() {
            knowledgePoints.forEach((kp, index) => {
                setTimeout(() => {
                    const blob = new Blob([kp.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = \`Áü•ËØÜÁÇπ\${index + 1}_\${kp.knowledgePoint.title}.html\`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, index * 300);
            });
        }
        
        // ÂØºÂá∫ÂΩìÂâçÁü•ËØÜÁÇπ‰∏∫PDF
        async function exportCurrentToPDF() {
            if (typeof html2pdf === 'undefined') {
                alert('PDFÂØºÂá∫Â∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                return;
            }
            
            const kp = knowledgePoints[currentIndex];
            const iframe = document.getElementById('frame-' + currentIndex);
            
            if (!iframe || !iframe.contentWindow) {
                alert('Êó†Ê≥ïËé∑ÂèñÂΩìÂâçÈ°µÈù¢ÂÜÖÂÆπ');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentWindow.document;
                const element = iframeDoc.body;
                
                const opt = {
                    margin: [10, 10],
                    filename: \`Áü•ËØÜÁÇπ\${currentIndex + 1}_\${kp.knowledgePoint.title}.pdf\`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        scrollY: 0,
                        scrollX: 0
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                await html2pdf().set(opt).from(element).save();
                alert('PDFÂØºÂá∫ÊàêÂäüÔºÅ');
                
            } catch (error) {
                console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                alert('PDFÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // ÂØºÂá∫ÊâÄÊúâÁü•ËØÜÁÇπ‰∏∫‰∏Ä‰∏™PDF
        async function exportAllToPDF() {
            if (typeof html2pdf === 'undefined') {
                alert('PDFÂØºÂá∫Â∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                return;
            }
            
            if (!confirm(\`Á°ÆÂÆöË¶ÅÂ∞ÜÊâÄÊúâ \${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπÂØºÂá∫‰∏∫‰∏Ä‰∏™PDFÊñá‰ª∂ÂêóÔºüËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥„ÄÇ\`)) {
                return;
            }
            
            try {
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 210mm; background: white;';
                document.body.appendChild(tempContainer);
                
                for (let i = 0; i < knowledgePoints.length; i++) {
                    const iframe = document.getElementById('frame-' + i);
                    
                    if (iframe && iframe.contentWindow) {
                        const iframeDoc = iframe.contentWindow.document;
                        const pageDiv = document.createElement('div');
                        pageDiv.style.cssText = 'page-break-after: always; min-height: 297mm; padding: 20px;';
                        pageDiv.innerHTML = iframeDoc.body.innerHTML;
                        
                        const styles = iframeDoc.querySelectorAll('style');
                        styles.forEach(style => {
                            const newStyle = document.createElement('style');
                            newStyle.textContent = style.textContent;
                            pageDiv.appendChild(newStyle);
                        });
                        
                        tempContainer.appendChild(pageDiv);
                    }
                }
                
                const opt = {
                    margin: [5, 5],
                    filename: \`Áü•ËØÜÁÇπÂêàÈõÜ_ÂÖ±\${knowledgePoints.length}‰∏™.pdf\`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { 
                        scale: 1.5,
                        useCORS: true,
                        letterRendering: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                await html2pdf().set(opt).from(tempContainer).save();
                
                document.body.removeChild(tempContainer);
                alert('PDFÂØºÂá∫ÊàêÂäüÔºÅ');
                
            } catch (error) {
                console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                alert('PDFÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // ÂàùÂßãÂåñÈ°µÈù¢
        init();
    <\/script>
</body>
</html>`;
            
            return htmlContent;
        }

        // Ë∞ÉÁî®DeepSeek API
        async function callDeepSeekAPI(prompt) {
            try {
                const response = await fetch(API_CONFIG.deepseek.baseUrl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.deepseek.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.deepseek.model,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        temperature: 0.7,
                        max_tokens: 4000
                    })
                });

                if (!response.ok) {
                    throw new Error(`DeepSeek APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content?.trim() || '';
                return convertToTraditionalChinese(content);
            } catch (error) {
                console.error('DeepSeek APIË∞ÉÁî®Â§±Ë¥•:', error);
                throw error;
            }
        }

        // Ëé∑Âèñ‰∏ìÂÆ∂APIÈÖçÁΩÆ
        function getExpertAPIConfig(expert) {
            const config = API_CONFIG[expert.key];
            if (!config) {
                throw new Error(`Êú™ÊâæÂà∞‰∏ìÂÆ∂ ${expert.key} ÁöÑAPIÈÖçÁΩÆ`);
            }
            
            // Â§ÑÁêÜ‰∏çÂêåAPIÁöÑURLÊ†ºÂºè
            let baseUrl = config.baseUrl;
            if (expert.key === 'doubao') {
                baseUrl = config.baseUrl + '/chat/completions';
            } else if (expert.key === 'kimi' || expert.key === 'chatglm') {
                baseUrl = config.baseUrl + '/chat/completions';
            }
            
            return {
                apiKey: config.apiKey,
                baseUrl: baseUrl,
                model: config.model
            };
        }

        // ÁîüÊàêÂ∏¶ÁøªÈ°µÂäüËÉΩÁöÑÁü•ËØÜÁÇπÊ±áÊÄªHTML
        function generateKnowledgePointSummaryHTML(knowledgePoints) {
            const htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áü•ËØÜÁÇπÊµèËßàÂô® - Êô∫ËÉΩÁøªÈ°µÁ≥ªÁªü</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }
        
        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-nav {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-controls {
            display: flex;
            gap: 10px;
        }
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ÂÜÖÂÆπÂå∫Âüü */
        .content-area {
            height: calc(100vh - 140px);
            position: relative;
        }
        .knowledge-point-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: none;
        }
        .knowledge-point-frame.active {
            display: block;
        }
        
        /* Â∫ïÈÉ®ÂØºËà™ */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }
        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .page-info {
            color: white;
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }
        .page-title {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        /* ËøõÂ∫¶Êù° */
        .progress-bar {
            position: fixed;
            top: 61px;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 999;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #eb2f96);
            transition: width 0.3s ease;
        }
        
        /* ‰æßËæπÊ†èÁõÆÂΩï */
        .sidebar {
            position: fixed;
            right: -320px;
            top: 65px;
            width: 300px;
            height: calc(100vh - 85px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 998;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar.open {
            right: 0;
        }
        .toc-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        .toc-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }
        .toc-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .toc-number {
            font-weight: 600;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <div class="top-nav">
        <div class="nav-title">
            <i class="fas fa-graduation-cap"></i>
            Áü•ËØÜÁÇπÊµèËßàÂô®
        </div>
        <div class="nav-controls">
            <button class="nav-btn" onclick="toggleSidebar()">
                <i class="fas fa-list"></i>
                <span>ÁõÆÂΩï</span>
            </button>
            <button class="nav-btn" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i>
                <span>ÂÖ®Â±è</span>
            </button>
            <button class="nav-btn" onclick="downloadAll()">
                <i class="fas fa-download"></i>
                <span>‰∏ãËΩΩÂÖ®ÈÉ®</span>
            </button>
        </div>
    </div>
    
    <!-- ËøõÂ∫¶Êù° -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <!-- ÂÜÖÂÆπÂå∫Âüü -->
    <div class="content-area" id="contentArea"></div>
    
    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <div class="bottom-nav">
        <button class="control-btn" id="prevBtn" onclick="navigateTo('prev')">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="page-info">
            <div id="pageNumber">1 / ${knowledgePoints.length}</div>
            <div class="page-title" id="pageTitle">Áü•ËØÜÁÇπÊ†áÈ¢ò</div>
        </div>
        <button class="control-btn" id="nextBtn" onclick="navigateTo('next')">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    
    <!-- ‰æßËæπÊ†èÁõÆÂΩï -->
    <div class="sidebar" id="sidebar">
        <h3 style="color: white; margin-bottom: 20px; font-size: 1.2rem;">
            <i class="fas fa-book"></i> Áü•ËØÜÁÇπÁõÆÂΩï
        </h3>
        <div id="tocList"></div>
    </div>
    
    ${'<'}script>
        const knowledgePoints = ${JSON.stringify(knowledgePoints)};
        let currentIndex = 0;
        let sidebarOpen = false;
        
        // ÂàùÂßãÂåñ
        function init() {
            const contentArea = document.getElementById('contentArea');
            
            // ÂàõÂª∫ÊâÄÊúâiframe
            knowledgePoints.forEach((kp, index) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'knowledge-point-frame' + (index === 0 ? ' active' : '');
                iframe.id = 'frame-' + index;
                
                const blob = new Blob([kp.html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                contentArea.appendChild(iframe);
            });
            
            // ÁîüÊàêÁõÆÂΩï
            const tocList = document.getElementById('tocList');
            knowledgePoints.forEach((kp, index) => {
                const tocItem = document.createElement('div');
                tocItem.className = 'toc-item' + (index === 0 ? ' active' : '');
                tocItem.id = 'toc-' + index;
                tocItem.innerHTML = \`
                    <div class="toc-number">\${index + 1}.</div>
                    <div>\${kp.knowledgePoint.title}</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 4px;">
                        Êù•Ëá™: \${kp.materialTitle}
                    </div>
                \`;
                tocItem.onclick = () => navigateToIndex(index);
                tocList.appendChild(tocItem);
            });
            
            updateUI();
        }
        
        // ÂØºËà™ÊéßÂà∂
        function navigateTo(direction) {
            if (direction === 'prev' && currentIndex > 0) {
                currentIndex--;
            } else if (direction === 'next' && currentIndex < knowledgePoints.length - 1) {
                currentIndex++;
            }
            showKnowledgePoint(currentIndex);
        }
        
        function navigateToIndex(index) {
            currentIndex = index;
            showKnowledgePoint(currentIndex);
            if (sidebarOpen) toggleSidebar();
        }
        
        function showKnowledgePoint(index) {
            // ÈöêËóèÊâÄÊúâiframe
            document.querySelectorAll('.knowledge-point-frame').forEach(frame => {
                frame.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÂΩìÂâçiframe
            document.getElementById('frame-' + index).classList.add('active');
            
            // Êõ¥Êñ∞ÁõÆÂΩïÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.toc-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('toc-' + index).classList.add('active');
            
            updateUI();
        }
        
        function updateUI() {
            const kp = knowledgePoints[currentIndex];
            
            // Êõ¥Êñ∞È°µÁ†Å
            document.getElementById('pageNumber').textContent = (currentIndex + 1) + ' / ' + knowledgePoints.length;
            document.getElementById('pageTitle').textContent = kp.knowledgePoint.title;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === knowledgePoints.length - 1;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progress = ((currentIndex + 1) / knowledgePoints.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                navigateTo('prev');
            } else if (e.key === 'ArrowRight') {
                navigateTo('next');
            } else if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
        });
        
        // ‰æßËæπÊ†èÊéßÂà∂
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        // ÂÖ®Â±èÊéßÂà∂
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // ‰∏ãËΩΩÊâÄÊúâÁü•ËØÜÁÇπ
        function downloadAll() {
            knowledgePoints.forEach((kp, index) => {
                setTimeout(() => {
                    const blob = new Blob([kp.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = \`Áü•ËØÜÁÇπ\${index + 1}_\${kp.knowledgePoint.title}.html\`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, index * 300);
            });
        }
        
        // ÂØºÂá∫ÂΩìÂâçÁü•ËØÜÁÇπ‰∏∫PDF
        async function exportCurrentToPDF() {
            if (typeof html2pdf === 'undefined') {
                alert('PDFÂØºÂá∫Â∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                return;
            }
            
            const kp = knowledgePoints[currentIndex];
            const iframe = document.getElementById('frame-' + currentIndex);
            
            if (!iframe || !iframe.contentWindow) {
                alert('Êó†Ê≥ïËé∑ÂèñÂΩìÂâçÈ°µÈù¢ÂÜÖÂÆπ');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentWindow.document;
                const element = iframeDoc.body;
                
                const opt = {
                    margin: [10, 10],
                    filename: \`Áü•ËØÜÁÇπ\${currentIndex + 1}_\${kp.knowledgePoint.title}.pdf\`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        scrollY: 0,
                        scrollX: 0
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                await html2pdf().set(opt).from(element).save();
                alert('PDFÂØºÂá∫ÊàêÂäüÔºÅ');
                
            } catch (error) {
                console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                alert('PDFÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // ÂØºÂá∫ÊâÄÊúâÁü•ËØÜÁÇπ‰∏∫‰∏Ä‰∏™PDF
        async function exportAllToPDF() {
            if (typeof html2pdf === 'undefined') {
                alert('PDFÂØºÂá∫Â∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                return;
            }
            
            if (!confirm(\`Á°ÆÂÆöË¶ÅÂ∞ÜÊâÄÊúâ \${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπÂØºÂá∫‰∏∫‰∏Ä‰∏™PDFÊñá‰ª∂ÂêóÔºüËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥„ÄÇ\`)) {
                return;
            }
            
            try {
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 210mm; background: white;';
                document.body.appendChild(tempContainer);
                
                for (let i = 0; i < knowledgePoints.length; i++) {
                    const iframe = document.getElementById('frame-' + i);
                    
                    if (iframe && iframe.contentWindow) {
                        const iframeDoc = iframe.contentWindow.document;
                        const pageDiv = document.createElement('div');
                        pageDiv.style.cssText = 'page-break-after: always; min-height: 297mm; padding: 20px;';
                        pageDiv.innerHTML = iframeDoc.body.innerHTML;
                        
                        const styles = iframeDoc.querySelectorAll('style');
                        styles.forEach(style => {
                            const newStyle = document.createElement('style');
                            newStyle.textContent = style.textContent;
                            pageDiv.appendChild(newStyle);
                        });
                        
                        tempContainer.appendChild(pageDiv);
                    }
                }
                
                const opt = {
                    margin: [5, 5],
                    filename: \`Áü•ËØÜÁÇπÂêàÈõÜ_ÂÖ±\${knowledgePoints.length}‰∏™.pdf\`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { 
                        scale: 1.5,
                        useCORS: true,
                        letterRendering: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                await html2pdf().set(opt).from(tempContainer).save();
                
                document.body.removeChild(tempContainer);
                alert('PDFÂØºÂá∫ÊàêÂäüÔºÅ');
                
            } catch (error) {
                console.error('PDFÂØºÂá∫Â§±Ë¥•:', error);
                alert('PDFÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // ÂàùÂßãÂåñÈ°µÈù¢
        init();
    <\/script>
</body>
</html>`;
            
            return htmlContent;
        }

        // ÊâìÂºÄÁü•ËØÜÁÇπÊµèËßàÂô®
        window.openKnowledgePointViewer = function() {
            if (!window.knowledgePointsSummaryHTML) {
                showMessage('‚ùå Áü•ËØÜÁÇπÊµèËßàÂô®Â∞öÊú™ÁîüÊàê', 'error');
                return;
            }
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(window.knowledgePointsSummaryHTML);
            newWindow.document.close();
        };

        // ‰∏ãËΩΩÁü•ËØÜÁÇπÊ±áÊÄª
        window.downloadKnowledgePointSummary = function() {
            if (!window.knowledgePointsSummaryHTML) {
                showMessage('‚ùå Áü•ËØÜÁÇπÊ±áÊÄªÂ∞öÊú™ÁîüÊàê', 'error');
                return;
            }
            
            const blob = new Blob([window.knowledgePointsSummaryHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Áü•ËØÜÁÇπÊµèËßàÂô®_ÂÆåÊï¥Áâà.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('‚úÖ Áü•ËØÜÁÇπÊ±áÊÄªÂ∑≤‰∏ãËΩΩ', 'success');
        };

        // ÁîüÊàêÊâÄÊúâËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁöÑÊ±áÊÄªÈ°µÈù¢
        window.generateSummaryPage = function() {
            if (!window.generatedMaterials || window.generatedMaterials.length === 0) {
                showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑÊºîÁ§∫ÊùêÊñô', 'error');
                return;
            }
            
            const newWindow = window.open('', '_blank');
            const doc = newWindow.document;
            
            // ÂÜôÂÖ•HTMLÂ§¥ÈÉ®ÂíåÊ†∑Âºè
            doc.write('<!DOCTYPE html><html lang="zh-CN"><head>' +
'<meta charset="UTF-8">' +
'<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
'<title>ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÊ±áÊÄª</title>' +
'<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">' +
'<style>' +
        '* { margin: 0; padding: 0; box-sizing: border-box; }' +
        'body {' +
            'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;' +
            'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' +
            'color: white;' +
            'overflow: hidden;' +
        '}' +
        '.header {' +
            'background: rgba(0, 0, 0, 0.3);' +
            'backdrop-filter: blur(10px);' +
            'padding: 20px 40px;' +
            'display: flex;' +
            'justify-content: space-between;' +
            'align-items: center;' +
            'border-bottom: 1px solid rgba(255, 255, 255, 0.1);' +
        '}' +
        '.header h1 {' +
            'font-size: 24px;' +
            'display: flex;' +
            'align-items: center;' +
            'gap: 12px;' +
        '}' +
        '.controls {' +
            'display: flex;' +
            'gap: 10px;' +
        '}' +
        '.btn {' +
            'background: rgba(255, 255, 255, 0.2);' +
            'color: white;' +
            'border: 1px solid rgba(255, 255, 255, 0.3);' +
            'padding: 10px 20px;' +
            'border-radius: 8px;' +
            'cursor: pointer;' +
            'font-size: 14px;' +
            'transition: all 0.3s ease;' +
            'display: flex;' +
            'align-items: center;' +
            'gap: 8px;' +
        '}' +
        '.btn:hover {' +
            'background: rgba(255, 255, 255, 0.3);' +
            'transform: translateY(-2px);' +
            'box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);' +
        '}' +
        '.btn:disabled {' +
            'opacity: 0.5;' +
            'cursor: not-allowed;' +
        '}' +
        '.content {' +
            'height: calc(100vh - 80px);' +
            'padding: 0;' +
            'position: relative;' +
        '}' +
        '.material-frame {' +
            'width: 100%;' +
            'height: 100%;' +
            'border: none;' +
            'background: white;' +
            'display: none;' +
        '}' +
        '.material-frame.active {' +
            'display: block;' +
        '}' +
        '.navigation {' +
            'position: fixed;' +
            'bottom: 30px;' +
            'left: 50%;' +
            'transform: translateX(-50%);' +
            'background: rgba(0, 0, 0, 0.8);' +
            'backdrop-filter: blur(10px);' +
            'padding: 15px 30px;' +
            'border-radius: 50px;' +
            'display: flex;' +
            'align-items: center;' +
            'gap: 20px;' +
            'box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);' +
            'z-index: 1000;' +
        '}' +
        '.nav-btn {' +
            'background: linear-gradient(135deg, #1890ff, #36cfc9);' +
            'color: white;' +
            'border: none;' +
            'padding: 12px 24px;' +
            'border-radius: 25px;' +
            'cursor: pointer;' +
            'font-size: 14px;' +
            'font-weight: 600;' +
            'transition: all 0.3s ease;' +
            'display: flex;' +
            'align-items: center;' +
            'gap: 8px;' +
        '}' +
        '.nav-btn:hover:not(:disabled) {' +
            'transform: scale(1.05);' +
            'box-shadow: 0 4px 16px rgba(24, 144, 255, 0.4);' +
        '}' +
        '.nav-btn:disabled {' +
            'opacity: 0.3;' +
            'cursor: not-allowed;' +
        '}' +
        '.page-indicator {' +
            'color: white;' +
            'font-size: 16px;' +
            'font-weight: 600;' +
            'padding: 0 20px;' +
            'display: flex;' +
            'flex-direction: column;' +
            'align-items: center;' +
            'gap: 5px;' +
        '}' +
        '.page-title {' +
            'font-size: 12px;' +
            'color: rgba(255, 255, 255, 0.7);' +
            'max-width: 300px;' +
            'text-align: center;' +
            'overflow: hidden;' +
            'text-overflow: ellipsis;' +
            'white-space: nowrap;' +
        '}' +
        '.loading {' +
            'position: fixed;' +
            'top: 50%;' +
            'left: 50%;' +
            'transform: translate(-50%, -50%);' +
            'background: rgba(0, 0, 0, 0.9);' +
            'padding: 30px 50px;' +
            'border-radius: 12px;' +
            'display: none;' +
            'align-items: center;' +
            'gap: 15px;' +
            'z-index: 2000;' +
        '}' +
        '.loading.show {' +
            'display: flex;' +
        '}' +
        '.loading i {' +
            'font-size: 24px;' +
            'animation: spin 1s linear infinite;' +
        '}' +
        '@keyframes spin {' +
            'from { transform: rotate(0deg); }' +
            'to { transform: rotate(360deg); }' +
        '}' +
        '.thumbnail-list {' +
            'position: fixed;' +
            'right: 20px;' +
            'top: 100px;' +
            'background: rgba(0, 0, 0, 0.8);' +
            'backdrop-filter: blur(10px);' +
            'padding: 15px;' +
            'border-radius: 12px;' +
            'max-height: calc(100vh - 200px);' +
            'overflow-y: auto;' +
            'display: none;' +
            'flex-direction: column;' +
            'gap: 10px;' +
            'z-index: 999;' +
        '}' +
        '.thumbnail-list.show {' +
            'display: flex;' +
        '}' +
        '.thumbnail {' +
            'padding: 12px;' +
            'background: rgba(255, 255, 255, 0.1);' +
            'border: 2px solid rgba(255, 255, 255, 0.2);' +
            'border-radius: 8px;' +
            'cursor: pointer;' +
            'transition: all 0.3s ease;' +
            'min-width: 200px;' +
        '}' +
        '.thumbnail:hover {' +
            'background: rgba(255, 255, 255, 0.2);' +
            'transform: translateX(-5px);' +
        '}' +
        '.thumbnail.active {' +
            'background: linear-gradient(135deg, #1890ff, #36cfc9);' +
            'border-color: #1890ff;' +
        '}' +
        '.thumbnail-title {' +
            'font-size: 13px;' +
            'font-weight: 600;' +
            'margin-bottom: 5px;' +
        '}' +
        '.thumbnail-info {' +
            'font-size: 11px;' +
            'color: rgba(255, 255, 255, 0.7);' +
        '}' +
'</style></head>');
            
            // ÂÜôÂÖ•body
            doc.write('<body>' +
'<div class="header">' +
'    <h1><i class="fas fa-layer-group"></i>ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÊ±áÊÄª</h1>' +
'    <div class="controls">' +
'        <button class="btn" onclick="toggleThumbnails()">' +
'            <i class="fas fa-list"></i>' +
'            <span id="thumbnailBtnText">ÊòæÁ§∫ÂàóË°®</span>' +
'        </button>' +
'        <button class="btn" onclick="toggleFullscreen()">' +
'            <i class="fas fa-expand"></i>' +
'            ÂÖ®Â±è' +
'        </button>' +
'        <button class="btn" onclick="downloadCurrent()">' +
'            <i class="fas fa-download"></i>' +
'            ‰∏ãËΩΩÂΩìÂâç' +
'        </button>' +
'        <button class="btn" onclick="downloadAll()">' +
'            <i class="fas fa-file-archive"></i>' +
'            ‰∏ãËΩΩÂÖ®ÈÉ®' +
'        </button>' +
'    </div>' +
'</div>' +
'<div class="content" id="contentArea">' +
'    <!-- Âä®ÊÄÅÂä†ËΩΩÊºîÁ§∫ÊùêÊñô -->' +
'</div>' +
'<div class="navigation">' +
'    <button class="nav-btn" id="prevBtn" onclick="navigateTo(\'prev\')">' +
'        <i class="fas fa-chevron-left"></i>' +
'        ‰∏ä‰∏Ä‰∏™' +
'    </button>' +
'    <div class="page-indicator">' +
'        <div id="pageNumber">1 / 1</div>' +
'        <div class="page-title" id="pageTitle">ÊºîÁ§∫ÊùêÊñô</div>' +
'    </div>' +
'    <button class="nav-btn" id="nextBtn" onclick="navigateTo(\'next\')">' +
'        ‰∏ã‰∏Ä‰∏™' +
'        <i class="fas fa-chevron-right"></i>' +
'    </button>' +
'</div>' +
'<div class="thumbnail-list" id="thumbnailList">' +
'    <!-- Âä®ÊÄÅÁîüÊàêÁº©Áï•ÂõæÂàóË°® -->' +
'</div>' +
'<div class="loading" id="loading">' +
'    <i class="fas fa-spinner"></i>' +
'    <span>Âä†ËΩΩ‰∏≠...</span>' +
'</div>');
            
            // ÂÜôÂÖ•scriptÈÉ®ÂàÜ
            doc.write('<scr' + 'ipt>');
            doc.write('const materials = ' + JSON.stringify(window.generatedMaterials.map(m => ({
                title: m.title,
                html: m.html,
                knowledgePoints: m.knowledgePoints,
                timestamp: m.timestamp,
                type: m.type
            }))) + ';');
            // Â∞ÜJavaScript‰ª£Á†Å‰Ωú‰∏∫Â≠óÁ¨¶‰∏≤ÂÜôÂÖ•
            const jsCode = String.raw`
let currentIndex = 0;
let thumbnailsVisible = false;

function init() {
            if (materials.length === 0) {
                document.getElementById('contentArea').innerHTML = 
                    '<div style="display: flex; justify-content: center; align-items: center; height: 100%; font-size: 1.5rem; color: rgba(255,255,255,0.7);">ÊöÇÊó†ÊºîÁ§∫ÊùêÊñô</div>';
                return;
            }

            // ÂàõÂª∫ÊâÄÊúâiframe
            const contentArea = document.getElementById('contentArea');
            materials.forEach((material, index) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'material-frame' + (index === 0 ? ' active' : '');
                iframe.id = 'frame-' + index;
                
                // ÂàõÂª∫blob URLÊù•Âä†ËΩΩHTMLÂÜÖÂÆπ
                const blob = new Blob([material.html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                contentArea.appendChild(iframe);
            });

            // ÁîüÊàêÁº©Áï•ÂõæÂàóË°®
            const thumbnailList = document.getElementById('thumbnailList');
            materials.forEach((material, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'thumbnail' + (index === 0 ? ' active' : '');
                thumbnail.id = 'thumb-' + index;
                thumbnail.onclick = () => jumpTo(index);
                thumbnail.innerHTML = 
                    '<div class="thumbnail-title">' + (index + 1) + '. ' + material.title + '</div>' +
                    '<div class="thumbnail-info">' +
                        '<i class="fas fa-lightbulb"></i> ' + material.knowledgePoints + ' ‰∏™Áü•ËØÜÁÇπ<br>' +
                        '<i class="fas fa-clock"></i> ' + material.timestamp +
                    '</div>';
                thumbnailList.appendChild(thumbnail);
            });

            updateUI();
        }

        // ÂØºËà™Âà∞ÊåáÂÆöÈ°µÈù¢
        function navigateTo(direction) {
            if (direction === 'prev' && currentIndex > 0) {
                currentIndex--;
            } else if (direction === 'next' && currentIndex < materials.length - 1) {
                currentIndex++;
            } else {
                return;
            }

            // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
            document.getElementById('loading').classList.add('show');
            
            setTimeout(() => {
                // ÂàáÊç¢iframe
                document.querySelectorAll('.material-frame').forEach((frame, index) => {
                    frame.classList.toggle('active', index === currentIndex);
                });

                // Êõ¥Êñ∞Áº©Áï•Âõæ
                document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                    thumb.classList.toggle('active', index === currentIndex);
                });

                updateUI();
                document.getElementById('loading').classList.remove('show');
            }, 300);
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÁ¥¢Âºï
        function jumpTo(index) {
            if (index >= 0 && index < materials.length && index !== currentIndex) {
                currentIndex = index;
                
                document.getElementById('loading').classList.add('show');
                
                setTimeout(() => {
                    document.querySelectorAll('.material-frame').forEach((frame, i) => {
                        frame.classList.toggle('active', i === currentIndex);
                    });

                    document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                        thumb.classList.toggle('active', i === currentIndex);
                    });

                    updateUI();
                    document.getElementById('loading').classList.remove('show');
                }, 300);
            }
        }

        // Êõ¥Êñ∞UIÁä∂ÊÄÅ
        function updateUI() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumber = document.getElementById('pageNumber');
            const pageTitle = document.getElementById('pageTitle');

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === materials.length - 1;
            pageNumber.textContent = (currentIndex + 1) + ' / ' + materials.length;
            pageTitle.textContent = materials[currentIndex].title;
        }

        // ÂàáÊç¢Áº©Áï•ÂõæÂàóË°®
        function toggleThumbnails() {
            thumbnailsVisible = !thumbnailsVisible;
            const thumbnailList = document.getElementById('thumbnailList');
            const btnText = document.getElementById('thumbnailBtnText');
            
            thumbnailList.classList.toggle('show', thumbnailsVisible);
            btnText.textContent = thumbnailsVisible ? 'ÈöêËóèÂàóË°®' : 'ÊòæÁ§∫ÂàóË°®';
        }

        // ÂÖ®Â±èÂàáÊç¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // ‰∏ãËΩΩÂΩìÂâçÊºîÁ§∫ÊùêÊñô
        function downloadCurrent() {
            const material = materials[currentIndex];
            const blob = new Blob([material.html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = material.title + '.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ‰∏ãËΩΩÊâÄÊúâÊºîÁ§∫ÊùêÊñô
        function downloadAll() {
            materials.forEach((material, index) => {
                setTimeout(() => {
                    const blob = new Blob([material.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = (index + 1) + '_' + material.title + '.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, index * 500); // Âª∂Ëøü‰∏ãËΩΩÔºåÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢
            });
        }

        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                navigateTo('prev');
            } else if (e.key === 'ArrowRight') {
                navigateTo('next');
            } else if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
        });

        // ÂàùÂßãÂåñÈ°µÈù¢
        init();
`;
            doc.write(jsCode);
            doc.write('</sc' + 'ript></body></html>');
            doc.close();
            
            showMessage('‚úÖ Ê±áÊÄªÈ°µÈù¢Â∑≤ÁîüÊàêÔºÅÂåÖÂê´ ' + window.generatedMaterials.length + ' ‰∏™ÊºîÁ§∫ÊùêÊñô', 'success');
        };

        // ÁîüÊàêËØæÁ®ãÊºîÁ§∫ÊùêÊñôÔºàËÆ®ËÆ∫ÁªìÊùüÂêéÁöÑ‰ºòÂåñÁâàÊú¨Ôºâ
        async function generateCourseMaterial(discussionArea) {
            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ•discussionAreaÔºåÂ∞ùËØïËé∑ÂèñdiscussionRounds
            if (!discussionArea) {
                discussionArea = document.getElementById('discussionRounds');
            }
            
            if (!discussionArea) {
                console.error('Êó†Ê≥ïÊâæÂà∞ËÆ®ËÆ∫Âå∫ÂüüÂÆπÂô®');
                return;
            }
            
            // ÊòæÁ§∫ÁîüÊàêËøõÂ∫¶
            const materialDiv = document.createElement('div');
            materialDiv.className = 'course-material-section';
            materialDiv.id = 'courseMaterialSection';
            materialDiv.innerHTML = `
                <div class="material-header">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>‰ºòÂåñÁâàËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàê‰∏≠...</span>
                </div>
                <div class="material-progress">
                    <i class="fas fa-spinner fa-spin"></i> ËØæÁ®ãÊùêÊñôËÄÅÂ∏àÊ≠£Âú®Ê†πÊçÆ‰∏ìÂÆ∂Âª∫ËÆÆÂíå‰ºòÂåñÂêéÁöÑÊïôÊ°àÔºåÁîüÊàêÂçáÁ∫ßÁâàÊºîÁ§∫‰ª£Á†Å...
                </div>
                <div class="material-content" id="materialContent"></div>
            `;
            discussionArea.appendChild(materialDiv);

            try {
                // ÊèêÂèñÁü•ËØÜÁÇπ
                let knowledgePoints = extractKnowledgePoints(window.finalTeachingPlan);
                
                // Â¶ÇÊûúÊ≤°ÊúâÊèêÂèñÂà∞Áü•ËØÜÁÇπÔºå‰ªéÈááÁ∫≥ÁöÑËßÇÁÇπ‰∏≠ÊèêÂèñ
                if (!knowledgePoints || knowledgePoints.length === 0) {
                    console.log('‰ªéÊïôÊ°à‰∏≠Êú™ËÉΩÊèêÂèñÂà∞Áü•ËØÜÁÇπÔºåÂ∞ùËØï‰ªéÈááÁ∫≥ÁöÑËßÇÁÇπ‰∏≠ÊèêÂèñ...');
                    knowledgePoints = [];
                    
                    // ‰ªéÈááÁ∫≥ÁöÑ‰∏ìÂÆ∂ËßÇÁÇπ‰∏≠ÊèêÂèñÂÖ≥ÈîÆÂÜÖÂÆπ
                    if (window.acceptedOpinions && window.acceptedOpinions.length > 0) {
                        window.acceptedOpinions.forEach(opinion => {
                            // ÊèêÂèñËßÇÁÇπÁöÑÊ†∏ÂøÉÂÜÖÂÆπÔºàÂèñÂâç100‰∏™Â≠óÁ¨¶Ôºâ
                            const content = opinion.content.trim();
                            if (content.length > 0) {
                                knowledgePoints.push(content.substring(0, 100));
                            }
                        });
                    }
                    
                    // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÔºå‰ªéÂéüÂßãÊïôÊ°àÂÜÖÂÆπ‰∏≠ÊèêÂèñ‰∏ªË¶ÅÊÆµËêΩ
                    if (knowledgePoints.length === 0 && window.finalTeachingPlan) {
                        const paragraphs = window.finalTeachingPlan.split('\n').filter(p => p.trim().length > 20);
                        knowledgePoints = paragraphs.slice(0, 5).map(p => p.trim());
                    }
                    
                    if (knowledgePoints.length === 0) {
                        throw new Error('Êú™ËÉΩ‰ªéÊïôÊ°àÊàñËÆ®ËÆ∫ÂÜÖÂÆπ‰∏≠ÊèêÂèñÂà∞ÊúâÊïàÂÜÖÂÆπ');
                    }
                    
                    console.log(`‰ªéËÆ®ËÆ∫ÂÜÖÂÆπ‰∏≠ÊèêÂèñÂà∞ ${knowledgePoints.length} ‰∏™Ë¶ÅÁÇπ`);
                }

                // Ë∞ÉÁî®DeepSeekÁîüÊàêHTMLÊºîÁ§∫È°µÈù¢Ôºà‰ºòÂåñÁâàÔºâ
                const courseMaterialPrompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑËØæÁ®ãÊùêÊñôÂà∂‰ΩúËÄÅÂ∏àÔºåËØ∑‰∏∫ËØæÁ®ã"${lessonTitle}"ÁîüÊàê‰∏Ä‰∏™‰∏∞ÂØå„ÄÅ‰∫§‰∫íÂºèÁöÑHTMLÊºîÁ§∫È°µÈù¢Ôºà‰ºòÂåñÁâàÔºâ„ÄÇ

Ê†∏ÂøÉÁü•ËØÜÁÇπÔºö
${knowledgePoints.join('\n')}

ÂÆåÊï¥ÊïôÊ°àÂÜÖÂÆπÔºö
${window.finalTeachingPlan}

‰∏ìÂÆ∂Âª∫ËÆÆÔºàÂ∑≤Êï¥ÂêàÂà∞ÊïôÊ°à‰∏≠ÔºâÔºö
${window.acceptedOpinions ? window.acceptedOpinions.map(op => `- ${op.expert.name}Ôºö${op.content}`).join('\n') : ''}

Ë¶ÅÊ±ÇÔºö

**1. ÂÆåÊï¥HTMLÁªìÊûÑ + È°∂ÈÉ®ÊéßÂà∂Ê†è**Ôºö
- ÂåÖÂê´<!DOCTYPE html>„ÄÅ<html>„ÄÅ<head>„ÄÅ<body>Á≠âÂÆåÊï¥Ê†áÁ≠æ
- È°µÈù¢È°∂ÈÉ®Âõ∫ÂÆöÊéßÂà∂Ê†èÔºåÂåÖÂê´Ôºö
  * ÂÖ®Â±èÊåâÈíÆÔºà‰ΩøÁî®JavaScript requestFullscreen APIÔºâ
  * Áº©ÊîæÊåâÈíÆÔºàÊîæÂ§ß/Áº©Â∞è/ÈáçÁΩÆÔºå‰ΩøÁî®CSS transform scaleÔºâ
  * ‰∏ªÈ¢òÂàáÊç¢Ôºà‰∫ÆËâ≤/ÊöóËâ≤Ê®°ÂºèÔºâ
  * ÂØºËà™ËèúÂçïÔºàÂø´ÈÄüË∑≥ËΩ¨Âà∞ÂêÑÁü•ËØÜÁÇπÔºâ

**2. ‰∏∞ÂØåÁöÑÁü•ËØÜÁÇπÂç°Áâá**ÔºàÊØè‰∏™Áü•ËØÜÁÇπÂåÖÂê´ÔºâÔºö
- üìñ Áü•ËØÜÁÇπÊ†áÈ¢ò + Font AwesomeÂõæÊ†á
- üìù ËØ¶ÁªÜËØ¥ÊòéÔºà150-300Â≠óÔºâ
- üé® CSS/SVGÁªòÂà∂ÁöÑÁ§∫ÊÑèÂõæÔºàÂÖâÁ∫ø„ÄÅÊ≥¢Á∫π„ÄÅÁâ©‰ΩìÁ≠âÔºâ
- üé¨ CSS3Âä®ÁîªÊºîÁ§∫ÔºàÂ¶ÇÂÖâÁöÑ‰º†Êí≠Âä®Áîª„ÄÅÁâ©‰ΩìÊåØÂä®Á≠âÔºâ
- üî¨ ‰∫íÂä®ÂÆûÈ™åÂå∫ÔºàÊåâÈíÆÁÇπÂáªËß¶ÂèëÂä®Áîª/ÊïàÊûúÔºâ
- üìö Áü•ËØÜÊãìÂ±ïÔºàÁßëÂ≠¶ÂéüÁêÜ„ÄÅÂéÜÂè≤ÊïÖ‰∫ã„ÄÅÁîüÊ¥ªÂ∫îÁî®Ôºâ
- üé• ËßÜÈ¢ëÂµåÂÖ•‰ΩçÁΩÆÔºàiframeÔºåÊ≥®ÈáäÔºöÂèØÊõøÊç¢ÂÆûÈôÖËßÜÈ¢ëÈìæÊé•Ôºâ
- ‚ùì ÊÄùËÄÉÈ¢òÔºà2-3‰∏™Ôºâ+ ÁÇπÂáªÊòæÁ§∫Á≠îÊ°à

**3. ËßÜËßâÂä®ÁîªÂíåÂõæÂΩ¢**Ôºö
- SVGÂä®ÁîªÂ±ïÁ§∫ÁßëÂ≠¶Áé∞Ë±°
- CanvasÂä®ÁîªÊ®°ÊãüÂÆûÈ™å
- CSSÂÖ≥ÈîÆÂ∏ßÂä®Áîª
- ‰∫§‰∫íÂºèÂõæË°®ÂíåÂõæÁ§∫

**4. ‰∫§‰∫í‰ΩìÈ™å**Ôºö
- Âç°ÁâáÂ±ïÂºÄ/Êî∂Ëµ∑Âä®Áîª
- ÊªëÂùóÊãñÂä®ÊîπÂèòÂèÇÊï∞
- ÊåâÈíÆËß¶ÂèëÊºîÁ§∫ÊïàÊûú
- ËøõÂ∫¶ËøΩË∏™ÔºàÂ∑≤Â≠¶‰π†ÁöÑÁü•ËØÜÁÇπÊ†áËÆ∞Ôºâ
- Á≠îÈ¢ò‰∫íÂä®

**5. ÂìçÂ∫îÂºè + ÁæéËßÇÊéíÁâà**Ôºö
- ÁßªÂä®Á´Ø„ÄÅÂπ≥Êùø„ÄÅÊ°åÈù¢ÈÄÇÈÖç
- Ê∏êÂèòËÉåÊôØ„ÄÅÂç°ÁâáÈò¥ÂΩ±
- ÊµÅÁïÖÁöÑÊªöÂä®‰ΩìÈ™å
- Ê∏ÖÊô∞ÁöÑÂ±ÇÊ¨°ÁªìÊûÑ

**6. ÊäÄÊúØË¶ÅÊ±Ç**Ôºö
- ÊâÄÊúâCSS„ÄÅJavaScriptÂÜÖËÅî
- ‰ΩøÁî®Font Awesome CDN
- ‰ª£Á†ÅÂÆåÊï¥ÂèØËøêË°å
- Ê∑ªÂä†ËØ¶ÁªÜÊ≥®Èáä

ËØ∑Áõ¥Êé•ËæìÂá∫ÂÆåÊï¥HTML‰ª£Á†ÅÔºå‰ªé<!DOCTYPE html>ÂºÄÂßãÔºåÂàõÂª∫‰∏Ä‰∏™ÂÜÖÂÆπ‰∏∞ÂØå„ÄÅËßÜËßâÁ≤æÁæé„ÄÅ‰∫§‰∫íÊÄßÂº∫ÁöÑËØæÁ®ãÊºîÁ§∫È°µÈù¢„ÄÇ`;

                const htmlCode = await callCourseMaterialAPI(courseMaterialPrompt);

                if (htmlCode) {
                    // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
                    window.courseMaterialHTML = htmlCode;
                    
                    // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊùêÊñôÂàóË°®
                    if (!window.generatedMaterials) {
                        window.generatedMaterials = [];
                    }
                    
                    // Ëé∑ÂèñËØæÁ®ãÊ†áÈ¢òÔºà‰ªéÊïôÊ°à‰∏≠ÊèêÂèñÊàñ‰ΩøÁî®ÈªòËÆ§ÂÄºÔºâ
                    const courseTitle = window.finalTeachingPlan ? 
                        (window.finalTeachingPlan.match(/‰∏ªÈ¢ò[Ôºö:]\s*(.+)/)?.[1] || 'ËØæÁ®ãÊºîÁ§∫') : 
                        'ËØæÁ®ãÊºîÁ§∫';
                    
                    window.generatedMaterials.push({
                        type: 'optimized',
                        title: `${courseTitle} - ‰ºòÂåñÁâà`,
                        html: htmlCode,
                        knowledgePoints: knowledgePoints.length,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });
                    
                    // Êõ¥Êñ∞ÊùêÊñôÂàóË°®ÊòæÁ§∫
                    updateMaterialsList();

                    // Êõ¥Êñ∞ÊòæÁ§∫
                    const materialHeader = materialDiv.querySelector('.material-header span');
                    materialHeader.textContent = '‚úÖ ‰ºòÂåñÁâàËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàêÂÆåÊàê';
                    
                    const progressDiv = materialDiv.querySelector('.material-progress');
                    progressDiv.innerHTML = `
                        <div style="color: #52c41a; margin: 15px 0;">
                            <i class="fas fa-check-circle"></i> Â∑≤Ê†πÊçÆ‰∏ìÂÆ∂Âª∫ËÆÆÂíå ${knowledgePoints.length} ‰∏™Áü•ËØÜÁÇπÁîüÊàê‰ºòÂåñÁâà‰∫§‰∫íÂºèÊºîÁ§∫È°µÈù¢
                        </div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 10px;">
                            üí° ÊèêÁ§∫ÔºöËøôÊòØÂü∫‰∫éÊïôÁ†îÁªÑËÆ®ËÆ∫‰ºòÂåñÂêéÁöÑÁâàÊú¨„ÄÇÊÇ®‰πüÂèØ‰ª•Êü•Áúã <a href="#" onclick="previewInitialMaterial(); return false;" style="color: #13c2c2; text-decoration: underline;">ÂàùÊ≠•ÁâàÊú¨</a> ËøõË°åÂØπÊØî„ÄÇ
                        </div>
                    `;

                    const materialContent = document.getElementById('materialContent');
                    materialContent.innerHTML = `
                        <div class="material-actions">
                            <button class="material-btn preview-btn" onclick="toggleOptimizedMaterialPreview()" id="toggleOptimizedPreviewBtn">
                                <i class="fas fa-eye"></i> Â±ïÂºÄÈ¢ÑËßà
                            </button>
                            <button class="material-btn open-btn" onclick="openCourseMaterialInNewWindow()">
                                <i class="fas fa-external-link-alt"></i> Âú®Êñ∞Á™óÂè£ÊâìÂºÄ
                            </button>
                            <button class="material-btn download-btn" onclick="downloadCourseMaterial()">
                                <i class="fas fa-download"></i> ‰∏ãËΩΩHTMLÊñá‰ª∂
                            </button>
                        </div>
                        <div id="optimizedMaterialPreviewContainer" style="display: none; margin-top: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; gap: 10px;">
                                <span style="font-size: 1.1rem; font-weight: 600; color: #13c2c2;">üì± ‰ºòÂåñÁâàÊºîÁ§∫È¢ÑËßà</span>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="zoomOptimizedFrame('in')" class="frame-control-btn" title="ÊîæÂ§ß">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button onclick="zoomOptimizedFrame('out')" class="frame-control-btn" title="Áº©Â∞è">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button onclick="zoomOptimizedFrame('reset')" class="frame-control-btn" title="ÈáçÁΩÆ">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <button onclick="toggleFullscreenOptimized()" class="frame-control-btn" title="ÂÖ®Â±è">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                    <button onclick="toggleOptimizedMaterialPreview()" class="close-preview-btn">
                                        <i class="fas fa-times"></i> Êî∂Ëµ∑È¢ÑËßà
                                    </button>
                                </div>
                            </div>
                            <div id="optimizedFrameContainer" style="position: relative; overflow: auto; background: #1a1a1a; border-radius: 8px;">
                                <iframe id="materialPreviewFrame" style="width: 100%; height: 600px; border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.3s ease;"></iframe>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                                <button onclick="navigateOptimizedFrame('prev')" class="frame-nav-btn">
                                    <i class="fas fa-chevron-left"></i> ‰∏ä‰∏ÄÈ°µ
                                </button>
                                <span id="optimizedPageIndicator" style="color: rgba(255,255,255,0.7); padding: 8px 16px;">Á¨¨ 1 È°µ</span>
                                <button onclick="navigateOptimizedFrame('next')" class="frame-nav-btn">
                                    ‰∏ã‰∏ÄÈ°µ <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // ÊùêÊñôÁîüÊàêÂÆåÊàêÂêéÔºåÂêØÂä®ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂàáÂâ≤Áü•ËØÜÁÇπ
                    console.log('ËØæÁ®ãÊºîÁ§∫ÊùêÊñôÁîüÊàêÂÆåÊàêÔºåÂêØÂä®ÊïôÊùêÊ£ÄÊü•ÁªÑÈïø...');
                    setTimeout(() => {
                        materialInspectorChief(discussionArea).catch(err => {
                            console.error('ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÂ∑•‰ΩúÂ§±Ë¥•:', err);
                        });
                    }, 1000);
                } else {
                    throw new Error('HTML‰ª£Á†ÅÁîüÊàêÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ËØæÁ®ãÊùêÊñôÁîüÊàêÂ§±Ë¥•:', error);
                const materialProgress = materialDiv.querySelector('.material-progress');
                materialProgress.innerHTML = `
                    <div style="color: #ff4d4f;">
                        <i class="fas fa-exclamation-circle"></i> ËØæÁ®ãÊùêÊñôÁîüÊàêÂ§±Ë¥•Ôºö${error.message}
                    </div>
                `;
            }
        }

        // ÊèêÂèñÁü•ËØÜÁÇπÔºàÊõ¥Êô∫ËÉΩÔºåÁ°Æ‰øù‰∏éËØæÁ®ãÂÜÖÂÆπÁõ∏ÂÖ≥Ôºâ
        function extractKnowledgePoints(teachingPlan, lessonTitle = '') {
            if (!teachingPlan) return [];

            const knowledgePoints = [];
            
            // 1. ‰ºòÂÖà‰ªé„ÄêÊ†∏ÂøÉÁü•ËØÜÁÇπ„ÄëÈÉ®ÂàÜÊèêÂèñ
            const knowledgeSection = teachingPlan.match(/„ÄêÊ†∏ÂøÉÁü•ËØÜÁÇπ„Äë([\s\S]*?)(?=„Äê|$)/);
            if (knowledgeSection && knowledgeSection[1]) {
                const points = knowledgeSection[1].match(/[-‚Ä¢\d]\s*(.+)/g);
                if (points) {
                    points.forEach(point => {
                        const cleaned = point.replace(/^[-‚Ä¢\d\.]\s*/, '').trim();
                        // ËøáÊª§ÊéâÂ§™Áü≠ÊàñÂ§™ÈïøÁöÑÂÜÖÂÆπ
                        if (cleaned && cleaned.length > 5 && cleaned.length < 200) {
                            knowledgePoints.push(cleaned);
                        }
                    });
                }
            }

            // 2. ‰ªéÊïôÂ≠¶ÁõÆÊ†á‰∏≠ÊèêÂèñÔºàËΩ¨Êç¢‰∏∫Áü•ËØÜÁÇπÂΩ¢ÂºèÔºâ
            if (knowledgePoints.length === 0) {
                const objectiveSection = teachingPlan.match(/„Äê‰ºòÂåñÊïôÂ≠¶ÁõÆÊ†á„Äë([\s\S]*?)(?=„Äê|$)/);
                if (objectiveSection && objectiveSection[1]) {
                    const objectives = objectiveSection[1].match(/[-‚Ä¢\d]\s*(.+)/g);
                    if (objectives) {
                        objectives.forEach(obj => {
                            const cleaned = obj.replace(/^[-‚Ä¢\d\.]\s*/, '').trim();
                            // Â∞Ü"‰∫ÜËß£..."„ÄÅ"ÊéåÊè°..."ËΩ¨Êç¢‰∏∫Áü•ËØÜÁÇπ
                            const knowledge = cleaned
                                .replace(/^(‰∫ÜËß£|ÁêÜËß£|ÊéåÊè°|ËÆ§ËØÜ|Â≠¶‰ºö|ËÉΩÂ§ü)/, '')
                                .trim();
                            if (knowledge && knowledge.length > 5 && knowledge.length < 200) {
                                knowledgePoints.push(knowledge);
                            }
                        });
                    }
                }
            }

            // 3. ‰ªéÊïôÂ≠¶ÈáçÁÇπÂíåÈöæÁÇπ‰∏≠ÊèêÂèñ
            if (knowledgePoints.length < 3) {
                const keyPointSection = teachingPlan.match(/„Äê?ÊïôÂ≠¶ÈáçÁÇπ.*?„Äë([\s\S]*?)(?=„Äê|$)/);
                if (keyPointSection && keyPointSection[1]) {
                    const points = keyPointSection[1].match(/[-‚Ä¢\d]\s*(.+)/g);
                    if (points) {
                        points.forEach(p => {
                            const cleaned = p.replace(/^[-‚Ä¢\d\.]\s*/, '').trim();
                            if (cleaned && cleaned.length > 5 && cleaned.length < 200 && !knowledgePoints.includes(cleaned)) {
                                knowledgePoints.push(cleaned);
                            }
                        });
                    }
                }
            }

            // 4. ‰ªéÊïôÂ≠¶ËøáÁ®ã‰∏≠ÊèêÂèñÂÖ≥ÈîÆÂÜÖÂÆπ
            if (knowledgePoints.length < 3) {
                const processSection = teachingPlan.match(/„Äê?ÊïôÂ≠¶ËøáÁ®ã„Äë([\s\S]*?)(?=„Äê|$)/);
                if (processSection && processSection[1]) {
                    // ÊèêÂèñÂåÖÂê´"ËÆ≤Ëß£"„ÄÅ"ÊºîÁ§∫"„ÄÅ"Êé¢Á©∂"Á≠âÂÖ≥ÈîÆËØçÁöÑÂè•Â≠ê
                    const sentences = processSection[1].match(/[^„ÄÇÔºÅÔºü\n]+[„ÄÇÔºÅÔºü]/g) || [];
                    sentences.forEach(sentence => {
                        if ((sentence.includes('ËÆ≤Ëß£') || sentence.includes('ÊºîÁ§∫') || sentence.includes('Êé¢Á©∂') || 
                             sentence.includes('ËßÇÂØü') || sentence.includes('ÂÆûÈ™å')) && 
                            sentence.length > 10 && sentence.length < 150) {
                            const cleaned = sentence.replace(/^[-‚Ä¢\d\.\s]+/, '').trim();
                            if (!knowledgePoints.includes(cleaned) && knowledgePoints.length < 5) {
                                knowledgePoints.push(cleaned);
                            }
                        }
                    });
                }
            }

            // 5. Â¶ÇÊûúËØæÁ®ãÊ†áÈ¢òÂåÖÂê´ÂÖ≥ÈîÆËØçÔºåÁ°Æ‰øùÊèêÂèñÁõ∏ÂÖ≥ÂÜÖÂÆπ
            if (lessonTitle && knowledgePoints.length < 3) {
                const titleKeywords = lessonTitle.split(/[„ÄÅÔºå,\s]+/);
                titleKeywords.forEach(keyword => {
                    if (keyword.length > 1) {
                        const regex = new RegExp(`[^„ÄÇÔºÅÔºü\n]*${keyword}[^„ÄÇÔºÅÔºü\n]*[„ÄÇÔºÅÔºü]`, 'g');
                        const relatedSentences = teachingPlan.match(regex) || [];
                        relatedSentences.slice(0, 2).forEach(sentence => {
                            const cleaned = sentence.replace(/^[-‚Ä¢\d\.\s]+/, '').trim();
                            if (cleaned.length > 10 && cleaned.length < 150 && !knowledgePoints.includes(cleaned)) {
                                knowledgePoints.push(cleaned);
                            }
                        });
                    }
                });
            }

            // Á°Æ‰øùËá≥Â∞ëÊúâÂÜÖÂÆπÔºå‰ªéÊïôÊ°à‰∏≠ÊèêÂèñÊúâÊïàÊÆµËêΩ
            if (knowledgePoints.length === 0) {
                const paragraphs = teachingPlan
                    .split('\n')
                    .map(p => p.trim())
                    .filter(p => p.length > 15 && p.length < 200 && !p.startsWith('„Äê') && !p.startsWith('#'));
                knowledgePoints.push(...paragraphs.slice(0, 5));
            }

            // ÂéªÈáçÂπ∂ÈôêÂà∂Êï∞Èáè
            const uniquePoints = [...new Set(knowledgePoints)].slice(0, 8);
            return uniquePoints;
        }

        // ÂàáÊç¢‰ºòÂåñÁâàÊùêÊñôÈ¢ÑËßàÊòæÁ§∫
        window.toggleOptimizedMaterialPreview = function() {
            const previewContainer = document.getElementById('optimizedMaterialPreviewContainer');
            const previewFrame = document.getElementById('materialPreviewFrame');
            const toggleBtn = document.getElementById('toggleOptimizedPreviewBtn');
            
            if (!previewContainer) return;
            
            if (previewContainer.style.display === 'none') {
                // Â±ïÂºÄÈ¢ÑËßà
                previewContainer.style.display = 'block';
                if (window.courseMaterialHTML && !previewFrame.src) {
                    const blob = new Blob([window.courseMaterialHTML], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    previewFrame.src = url;
                }
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Êî∂Ëµ∑È¢ÑËßà';
            } else {
                // Êî∂Ëµ∑È¢ÑËßà
                previewContainer.style.display = 'none';
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Â±ïÂºÄÈ¢ÑËßà';
            }
        };

        // È¢ÑËßàËØæÁ®ãÊùêÊñôÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        window.previewCourseMaterial = function() {
            toggleOptimizedMaterialPreview();
        };

        // ÂÖ≥Èó≠È¢ÑËßàÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        window.closeMaterialPreview = function() {
            const previewContainer = document.getElementById('optimizedMaterialPreviewContainer');
            if (previewContainer) {
                previewContainer.style.display = 'none';
                const toggleBtn = document.getElementById('toggleOptimizedPreviewBtn');
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Â±ïÂºÄÈ¢ÑËßà';
            }
        };

        // Âú®Êñ∞Á™óÂè£ÊâìÂºÄËØæÁ®ãÊùêÊñô
        window.openCourseMaterialInNewWindow = function() {
            if (window.courseMaterialHTML) {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(window.courseMaterialHTML);
                newWindow.document.close();
            }
        };

        // ‰∏ãËΩΩËØæÁ®ãÊùêÊñô
        window.downloadCourseMaterial = function() {
            if (window.courseMaterialHTML) {
                const blob = new Blob([window.courseMaterialHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ËØæÁ®ãÊºîÁ§∫ÊùêÊñô.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        // iframeÊéßÂà∂ÂäüËÉΩ - ÂàùÊ≠•ÁâàÊú¨
        let initialZoom = 1;
        let initialPage = 1;

        window.zoomInitialFrame = function(action) {
            const frame = document.getElementById('initialMaterialPreviewFrame');
            if (!frame) return;

            if (action === 'in') {
                initialZoom = Math.min(initialZoom + 0.1, 2);
            } else if (action === 'out') {
                initialZoom = Math.max(initialZoom - 0.1, 0.5);
            } else if (action === 'reset') {
                initialZoom = 1;
            }

            frame.style.transform = `scale(${initialZoom})`;
            frame.style.transformOrigin = 'top left';
            
            const container = document.getElementById('initialFrameContainer');
            if (container) {
                container.style.height = `${500 * initialZoom}px`;
            }
        };

        window.navigateInitialFrame = function(direction) {
            const indicator = document.getElementById('initialPageIndicator');
            if (direction === 'next') {
                initialPage++;
            } else if (direction === 'prev' && initialPage > 1) {
                initialPage--;
            }
            if (indicator) {
                indicator.textContent = `Á¨¨ ${initialPage} È°µ`;
            }
            
            // Â∞ùËØïÂêëiframeÂèëÈÄÅÊªöÂä®Ê∂àÊÅØ
            const frame = document.getElementById('initialMaterialPreviewFrame');
            if (frame && frame.contentWindow) {
                try {
                    frame.contentWindow.scrollBy(0, direction === 'next' ? 600 : -600);
                } catch (e) {
                    console.log('Êó†Ê≥ïÊéßÂà∂iframeÊªöÂä®');
                }
            }
        };

        window.toggleFullscreenInitial = function() {
            const container = document.getElementById('initialFrameContainer');
            if (!container) return;

            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error('ËøõÂÖ•ÂÖ®Â±èÂ§±Ë¥•:', err);
                });
            } else {
                document.exitFullscreen();
            }
        };

        // iframeÊéßÂà∂ÂäüËÉΩ - ‰ºòÂåñÁâàÊú¨
        let optimizedZoom = 1;
        let optimizedPage = 1;

        window.zoomOptimizedFrame = function(action) {
            const frame = document.getElementById('materialPreviewFrame');
            if (!frame) return;

            if (action === 'in') {
                optimizedZoom = Math.min(optimizedZoom + 0.1, 2);
            } else if (action === 'out') {
                optimizedZoom = Math.max(optimizedZoom - 0.1, 0.5);
            } else if (action === 'reset') {
                optimizedZoom = 1;
            }

            frame.style.transform = `scale(${optimizedZoom})`;
            frame.style.transformOrigin = 'top left';
            
            const container = document.getElementById('optimizedFrameContainer');
            if (container) {
                container.style.height = `${600 * optimizedZoom}px`;
            }
        };

        window.navigateOptimizedFrame = function(direction) {
            const indicator = document.getElementById('optimizedPageIndicator');
            if (direction === 'next') {
                optimizedPage++;
            } else if (direction === 'prev' && optimizedPage > 1) {
                optimizedPage--;
            }
            if (indicator) {
                indicator.textContent = `Á¨¨ ${optimizedPage} È°µ`;
            }
            
            // Â∞ùËØïÂêëiframeÂèëÈÄÅÊªöÂä®Ê∂àÊÅØ
            const frame = document.getElementById('materialPreviewFrame');
            if (frame && frame.contentWindow) {
                try {
                    frame.contentWindow.scrollBy(0, direction === 'next' ? 600 : -600);
                } catch (e) {
                    console.log('Êó†Ê≥ïÊéßÂà∂iframeÊªöÂä®');
                }
            }
        };

        window.toggleFullscreenOptimized = function() {
            const container = document.getElementById('optimizedFrameContainer');
            if (!container) return;

            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error('ËøõÂÖ•ÂÖ®Â±èÂ§±Ë¥•:', err);
                });
            } else {
                document.exitFullscreen();
            }
        };

        // Ë∞ÉÁî®ËØæÁ®ãÊùêÊñôÁîüÊàêAPI
        async function callCourseMaterialAPI(prompt) {
            try {
                console.log('Ë∞ÉÁî®ËØæÁ®ãÊùêÊñôÁîüÊàêAPI...');
                const response = await fetch(API_CONFIG.deepseek.baseUrl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.deepseek.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.deepseek.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑËØæÁ®ãÊùêÊñôÂà∂‰ΩúËÄÅÂ∏àÔºåÊìÖÈïøÂ∞ÜÊïôÂ≠¶Áü•ËØÜÁÇπËΩ¨Êç¢‰∏∫‰∫íÂä®Âºè„ÄÅÁæéËßÇÁöÑHTMLÊºîÁ§∫È°µÈù¢„ÄÇ‰Ω†‰ºöÁîüÊàêÂÆåÊï¥ÁöÑ„ÄÅÂèØÁõ¥Êé•ËøêË°åÁöÑHTML‰ª£Á†ÅÔºåÂåÖÂê´Áé∞‰ª£ÂåñÁöÑCSSÊ†∑ÂºèÂíå‰∫§‰∫íÂºèJavaScriptÂäüËÉΩ„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('ËØæÁ®ãÊùêÊñôÁîüÊàêAPIË∞ÉÁî®ÊàêÂäü');
                    let htmlContent = data.choices[0].message.content;

                    // Ê∏ÖÁêÜÂèØËÉΩÁöÑmarkdown‰ª£Á†ÅÂùóÊ†áËÆ∞
                    htmlContent = htmlContent.replace(/```html\n?/g, '').replace(/```\n?/g, '');

                    return convertToTraditionalChinese(htmlContent);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('ËØæÁ®ãÊùêÊñôÁîüÊàêAPIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Ë∞ÉÁî®Gemini API
        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`${API_CONFIG.gemini.baseUrl}/models/${API_CONFIG.gemini.model}:generateContent?key=${API_CONFIG.gemini.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                    console.log('Gemini APIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.candidates[0].content.parts[0].text);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('Gemini APIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Ë∞ÉÁî®DeepSeek APIÔºà‰Ωú‰∏∫HTMLÁîüÊàêÂô®Ôºâ
        async function callHtmlGeneratorAPI(prompt) {
            try {
                const response = await fetch(API_CONFIG.htmlGenerator.baseUrl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.htmlGenerator.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.htmlGenerator.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôËÇ≤ÊäÄÊúØ‰∏ìÂÆ∂ÔºåÊìÖÈïøÂ∞ÜÊïôÊ°àÂÜÖÂÆπËΩ¨Êç¢‰∏∫Áé∞‰ª£ÂåñÁöÑHTMLÊïôÂ≠¶ÊºîÁ§∫È°µÈù¢„ÄÇ‰Ω†‰ºöÁîüÊàêÂìçÂ∫îÂºè„ÄÅ‰∫§‰∫íÊÄßÂº∫ÁöÑHTML‰ª£Á†ÅÔºåÈÄÇÂêàËØæÂ†ÇÊºîÁ§∫ÂíåÂ≠¶ÁîüËá™Â≠¶„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('HTMLÁîüÊàêÂô®APIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('HTMLÁîüÊàêÂô®APIË∞ÉÁî®ÈîôËØØ:', error);
                return null;
            }
        }

        // Ë∞ÉÁî®ÊïôÊ°àÁîüÊàêÂô®APIÔºà‰∏ìÁî®DeepSeekÔºåÂ§±Ë¥•Êó∂ÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆÔºâ
        async function callLessonGeneratorAPI(prompt) {
            try {
                console.log('Ë∞ÉÁî®ÊïôÊ°àÁîüÊàêÂô®API (DeepSeek)...');
                
                // È¶ñÂÖàÂ∞ùËØï‰ΩøÁî®DeepSeek
                const apiUrl = `${API_CONFIG.lessonGenerator.baseUrl}/chat/completions`;
                
                console.log('API URL:', apiUrl);
                console.log('Model:', API_CONFIG.lessonGenerator.model);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.lessonGenerator.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.lessonGenerator.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àËÆæËÆ°‰∏ìÂÆ∂ÔºåÊìÖÈïø‰∏∫ËØæÁ®ãËÆæËÆ°45ÂàÜÈíüÁöÑÂÆåÊï¥ÊïôÊ°à„ÄÇ‰Ω†‰ºöÊ†πÊçÆ‰∏ªÈ¢òÂíåÂÜÖÂÆπË¶ÅÁÇπÁîüÊàêÁªìÊûÑÂÆåÊï¥„ÄÅÊó∂Èó¥ÂàÜÈÖçÂêàÁêÜÁöÑÊïôÊ°àÔºåÂåÖÂê´ÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπ„ÄÅÊïôÂ≠¶ÂáÜÂ§á„ÄÅÊïôÂ≠¶ËøáÁ®ã„ÄÅÊùø‰π¶ËÆæËÆ°„ÄÅ‰Ωú‰∏öÂ∏ÉÁΩÆÂíåÊïôÂ≠¶ËØÑ‰ª∑„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        stream: false
                    })
                });

                console.log('Response status:', response.status);

                // Â¶ÇÊûúÊòØ429ÈîôËØØÔºàÈÖçÈ¢ùÈôêÂà∂ÔºâÔºåÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆ
                if (response.status === 429) {
                    console.warn('DeepSeekÈÖçÈ¢ùÂ∑≤Áî®ÂÆåÔºåÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆ...');
                    showMessage('‚ö†Ô∏è DeepSeekÈÖçÈ¢ùÂ∑≤Áî®ÂÆåÔºåÊ≠£Âú®ÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆÁîüÊàêÊïôÊ°à...', 'info');
                    return await callQwenForLessonGeneration(prompt);
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÖçÈ¢ùÈôêÂà∂ÈîôËØØ
                    if (errorText.includes('SetLimitExceeded') || errorText.includes('TooManyRequests')) {
                        console.warn('Ê£ÄÊµãÂà∞ÈÖçÈ¢ùÈôêÂà∂ÔºåÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆ...');
                        showMessage('‚ö†Ô∏è DeepSeekÈÖçÈ¢ùÂ∑≤Áî®ÂÆåÔºåÊ≠£Âú®ÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆÁîüÊàêÊïôÊ°à...', 'info');
                        return await callQwenForLessonGeneration(prompt);
                    }
                    
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    console.log('ÊïôÊ°àÁîüÊàêÂô®APIË∞ÉÁî®ÊàêÂäü (DeepSeek)');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    console.error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ:', data);
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØÔºöÊú™ÊâæÂà∞contentÂ≠óÊÆµ');
                }
            } catch (error) {
                console.error('ÊïôÊ°àÁîüÊàêÂô®APIË∞ÉÁî®ÈîôËØØ:', error);
                
                // Â¶ÇÊûúÂåÖÂê´ÈÖçÈ¢ùÈîôËØØÔºåÂ∞ùËØïÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆ
                if (error.message.includes('SetLimitExceeded') || error.message.includes('429')) {
                    console.warn('ÊçïËé∑Âà∞ÈÖçÈ¢ùÈîôËØØÔºåÂ∞ùËØïÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆ...');
                    showMessage('‚ö†Ô∏è DeepSeekÈÖçÈ¢ùÂ∑≤Áî®ÂÆåÔºåÊ≠£Âú®ÂàáÊç¢Âà∞ÈÄö‰πâÂçÉÈóÆÁîüÊàêÊïôÊ°à...', 'info');
                    try {
                        return await callQwenForLessonGeneration(prompt);
                    } catch (qwenError) {
                        console.error('ÈÄö‰πâÂçÉÈóÆË∞ÉÁî®‰πüÂ§±Ë¥•:', qwenError);
                        showMessage(`‚ùå ÊïôÊ°àÁîüÊàêÂ§±Ë¥•: ${qwenError.message}`, 'error');
                        return null;
                    }
                }
                
                showMessage(`‚ùå APIË∞ÉÁî®Â§±Ë¥•: ${error.message}`, 'error');
                return null;
            }
        }

        // ‰ΩøÁî®ÈÄö‰πâÂçÉÈóÆÁîüÊàêÊïôÊ°à
        async function callQwenForLessonGeneration(prompt) {
            try {
                console.log('‰ΩøÁî®ÈÄö‰πâÂçÉÈóÆÁîüÊàêÊïôÊ°à...');
                
                const response = await fetch(API_CONFIG.qwen.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.qwen.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.qwen.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àËÆæËÆ°‰∏ìÂÆ∂ÔºåÊìÖÈïø‰∏∫ËØæÁ®ãËÆæËÆ°45ÂàÜÈíüÁöÑÂÆåÊï¥ÊïôÊ°à„ÄÇ‰Ω†‰ºöÊ†πÊçÆ‰∏ªÈ¢òÂíåÂÜÖÂÆπË¶ÅÁÇπÁîüÊàêÁªìÊûÑÂÆåÊï¥„ÄÅÊó∂Èó¥ÂàÜÈÖçÂêàÁêÜÁöÑÊïôÊ°àÔºåÂåÖÂê´ÊïôÂ≠¶ÁõÆÊ†á„ÄÅÈáçÁÇπÈöæÁÇπ„ÄÅÊïôÂ≠¶ÂáÜÂ§á„ÄÅÊïôÂ≠¶ËøáÁ®ã„ÄÅÊùø‰π¶ËÆæËÆ°„ÄÅ‰Ωú‰∏öÂ∏ÉÁΩÆÂíåÊïôÂ≠¶ËØÑ‰ª∑„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ÈÄö‰πâÂçÉÈóÆAPIË∞ÉÁî®Â§±Ë¥•: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    console.log('ÈÄö‰πâÂçÉÈóÆÊïôÊ°àÁîüÊàêÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('ÈÄö‰πâÂçÉÈóÆAPIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('ÈÄö‰πâÂçÉÈóÆË∞ÉÁî®ÈîôËØØ:', error);
                throw error;
            }
        }

        // ‰ΩøÁî®qwenÂ∞ÜÊïôÊ°àÊ†ºÂºèÂåñ‰∏∫HTMLÔºàÂèÇËÄÉPDFÊ†ºÂºèÔºâ
        async function formatLessonPlanToHTML(lessonContent) {
            try {
                console.log('ÂºÄÂßã‰ΩøÁî®qwenÊ†ºÂºèÂåñÊïôÊ°à‰∏∫HTML...');

                // ËØªÂèñPDFÊ†ºÂºè‰Ωú‰∏∫ÂèÇËÄÉ
                const pdfFormatReference = `Ë´ãÂèÉËÄÉ‰ª•‰∏ãÊæ≥ÈñÄÊïôÊ°àPDFÁöÑÊ†ºÂºèÂíåÁµêÊßãÔºåÂ∞áÊèê‰æõÁöÑÊïôÊ°àÂÖßÂÆπËΩâÊèõÁÇ∫Â∞çÊáâÁöÑHTMLÊ†ºÂºè„ÄÇ

**ÈáçË¶ÅË¶ÅÊ±ÇÔºöÁîüÊàêÁöÑHTMLÊ†ºÂºèÂøÖÈ†àËàáPDFÁâàÈù¢ÂÆåÂÖ®‰∏ÄËá¥ÔºåÂåÖÊã¨Ë°®Ê†ºÁµêÊßã„ÄÅÂ≠óÈ´îÂ§ßÂ∞è„ÄÅÈÇäÊ°ÜÊ®£Âºè„ÄÅÂ∞çÈΩäÊñπÂºèÁ≠âÊâÄÊúâÁ¥∞ÁØÄ„ÄÇ**

Êæ≥ÈñÄÊïôÊ°àÊ†ºÂºèÁµêÊßãÔºàÂøÖÈ†àËàáPDFÁâàÈù¢ÂÆåÂÖ®‰∏ÄËá¥ÔºâÔºö

**1. Ë°®È†≠‰ø°ÊÅØÂçÄÂüüÔºà‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºâ**Ôºö
   - ÂøÖÈ†à‰ΩøÁî®<table>Ê®ôÁ±§ÔºåÈÇäÊ°ÜÊ∏ÖÊô∞ÂèØË¶ã
   - Ë°®Ê†ºÂåÖÂê´ÂÖ©ÂàóÔºöÈ†ÖÁõÆÂàóÂíåÂÖßÂÆπÂàó
   - È†ÖÁõÆÂàóÔºöË™≤È°åÂêçÁ®±„ÄÅÁè≠Á¥ö„ÄÅ‰∫∫Êï∏„ÄÅÊïôÊùê‰æÜÊ∫ê„ÄÅË®≠Ë®àËÄÖ„ÄÅÊôÇÈñì
   - ÂÖßÂÆπÂàóÔºöÂ∞çÊáâÁöÑÂÖ∑È´îÂÖßÂÆπ
   - Ë°®Ê†ºÊ®£ÂºèÔºöÈÇäÊ°Ü1pxÂØ¶Á∑öÈªëËâ≤ÔºåË°®È†≠Âä†Á≤óÔºåÂÖßÂÆπÂ∑¶Â∞çÈΩä

**2. Â≠∏ÁîüËÉåÊôØÂàÜÊûê**Ôºö
   - ‰ΩøÁî®<h2>Êàñ<h3>Ê®ôÁ±§‰ΩúÁÇ∫Ê®ôÈ°å
   - ÂÖßÂÆπ‰ΩøÁî®<p>Ê®ôÁ±§ÔºåÊÆµËêΩÈñìË∑ùÈÅ©Áï∂
   - Ë©≥Á¥∞ÊèèËø∞Â≠∏ÁîüÂ∑≤ÊúâÁü•Ë≠òÂü∫Á§é„ÄÅÂ≠∏ÁøíÁâπÈªû„ÄÅË™çÁü•Ê∞¥Âπ≥Á≠â

**3. ÊîøÁ≠ñË¶èÂÆöÁöÑ‰∏ä‰ΩçÁõÆÊ®ôÔºàÁõ∏ÈóúÁöÑÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±ÇÔºâ**Ôºö
   - ‰ΩøÁî®<h2>Êàñ<h3>Ê®ôÁ±§‰ΩúÁÇ∫Ê®ôÈ°å
   - ÂÖßÂÆπ‰ΩøÁî®<p>Êàñ<ul>Ê®ôÁ±§
   - ÂàóÂá∫Áõ∏ÈóúÁöÑÊîøÁ≠ñÊñá‰ª∂„ÄÅÂü∫Êú¨Â≠∏ÂäõË¶ÅÊ±Ç„ÄÅË™≤Á®ãÊ®ôÊ∫ñÁ≠â‰∏ä‰ΩçÁõÆÊ®ô

**4. Êú¨Ë™≤ÁõÆÊ®ô**Ôºö
   - ‰ΩøÁî®<h2>Êàñ<h3>Ê®ôÁ±§‰ΩúÁÇ∫Ê®ôÈ°å
   - ÂÖßÂÆπ‰ΩøÁî®<p>Ê®ôÁ±§
   - Ê¶ÇËø∞Êú¨ÁØÄË™≤ÁöÑÊï¥È´îÁõÆÊ®ô

**5. ÊïôÂ≠∏ÁõÆÊ®ô**Ôºö
   - ‰ΩøÁî®<h2>Êàñ<h3>Ê®ôÁ±§‰ΩúÁÇ∫Ê®ôÈ°å
   - ‰ΩøÁî®ÊúâÂ∫èÂàóË°®<ol>ÊàñÁÑ°Â∫èÂàóË°®<ul>
   - ÂåÖÂê´ÔºöÁü•Ë≠òËàáÊäÄËÉΩ„ÄÅÈÅéÁ®ãËàáÊñπÊ≥ï„ÄÅÊÉÖÊÑüÊÖãÂ∫¶ËàáÂÉπÂÄºËßÄ

**6. ÂÖ∑È´îÁõÆÊ®ô**Ôºö
   - ‰ΩøÁî®<h2>Êàñ<h3>Ê®ôÁ±§‰ΩúÁÇ∫Ê®ôÈ°å
   - ‰ΩøÁî®ÊúâÂ∫èÂàóË°®<ol>ÔºåÁ∑®ËôüÊ†ºÂºèÁÇ∫1„ÄÅ2„ÄÅ3...
   - ÂàóÂá∫3-5ÂÄãÂÖ∑È´îÁöÑ„ÄÅÂèØÊ∏¨ÈáèÁöÑÂ≠∏ÁøíÁõÆÊ®ô

**7. ÊïôÂ≠∏Á†îÁ©∂ÔºàÊ≠§Â§ßÊ®ôÈ°å‰∏ãÂåÖÂê´‰ª•‰∏ãÂ≠êÊ¨ÑÁõÆÔºåÊåâÂá∫ÁèæÈ†ÜÂ∫èÔºâ**Ôºö
   - ‰∏ªÊ®ôÈ°å‰ΩøÁî®<h2>Ê®ôÁ±§
   - Â≠êÊ¨ÑÁõÆ‰ΩøÁî®<h3>Ê®ôÁ±§Ôºö
     * ‰∏Ä„ÄÅË®≠Ë®àÁêÜÂøµËàáÁõÆÊ®ô
     * ‰∫å„ÄÅÂ≠∏ÁîüÁöÑÂàÜÊûê
     * ‰∏â„ÄÅË™≤Á®ãÊû∂Êßã
     * Âõõ„ÄÅÁØÄÊ¨°ÂàÜÈÖç
     * ‰∫î„ÄÅÊïôÂ≠∏ÊñπÊ≥ïËàáË©ïÈáè
     * ÂÖ≠„ÄÅÂèÉËÄÉË≥áÊ∫ê
   - ÊØèÂÄãÂ≠êÊ¨ÑÁõÆÂÖßÂÆπ‰ΩøÁî®<p>Ê®ôÁ±§

**8. ÊïôÂ≠∏ÊµÅÁ®ãÔºàÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåËàáPDFÁâàÈù¢ÂÆåÂÖ®‰∏ÄËá¥Ôºâ**Ôºö
   - **ÂøÖÈ†à‰ΩøÁî®<table>Ê®ôÁ±§**ÔºåÈÇäÊ°ÜÊ∏ÖÊô∞ÂèØË¶ã
   - Ë°®Ê†ºÂøÖÈ†àÂåÖÂê´‰ª•‰∏ã‰∫îÂàóÔºàÈ†ÜÂ∫è‰∏çËÉΩÊîπËÆäÔºâÔºö
     1. ÁõÆÊ®ô‰ª£ËôüÔºàÈ¶ñÂàóÔºåÂ∞çÊáâÂÖ∑È´îÁõÆÊ®ôÁöÑ‰ª£ËôüÔºåÂ¶ÇÔºö1„ÄÅ2„ÄÅ3Êàñ1„ÄÅ2Á≠âÔºâ
     2. Ê¥ªÂãïÊµÅÁ®ãÔºàÊïôÂ≠∏ÊµÅÁ®ã‰∏ªÈ´îÔºåË©≥Á¥∞ÊèèËø∞ÊïôÂ≠∏Ê¥ªÂãïÁöÑÂÖ∑È´îÊ≠•È©üÔºâ
     3. ÊôÇÈñìÔºàÂ∞çÊáâÊ¥ªÂãïÊµÅÁ®ãÁöÑÊôÇÈñìÂàÜÈÖçÔºåÂ¶ÇÔºö5ÂàÜÈêò„ÄÅ10ÂàÜÈêòÔºâ
     4. ÊïôÂ≠∏Ë≥áÊ∫êÔºà‰ΩøÁî®ÁöÑÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅÊïôÂÖ∑„ÄÅÊùêÊñôÁ≠âÔºâ
     5. Ë©ïÈáèÔºàË©ïÂÉπÊñπÂºèÂíåÊ®ôÊ∫ñÔºâ
   - Ë°®È†≠ÂøÖÈ†àÂä†Á≤ó‰∏¶Â±Ö‰∏≠Â∞çÈΩä
   - Ë°®Ê†ºÈÇäÊ°ÜÂøÖÈ†àÊòØ1pxÂØ¶Á∑öÈªëËâ≤
   - ÁõÆÊ®ô‰ª£ËôüÂàóÔºöÂ∑¶Â∞çÈΩäÊàñÂ±Ö‰∏≠
   - Ê¥ªÂãïÊµÅÁ®ãÂàóÔºöÂ∑¶Â∞çÈΩäÔºåÂÖßÂÆπË©≥Á¥∞
   - ÊôÇÈñìÂàóÔºöÂ±Ö‰∏≠Â∞çÈΩä
   - ÊïôÂ≠∏Ë≥áÊ∫êÂàóÔºöÂ∑¶Â∞çÈΩä
   - Ë©ïÈáèÂàóÔºöÂ∑¶Â∞çÈΩä
   - ÊØèË°å‰ª£Ë°®‰∏ÄÂÄãÊïôÂ≠∏Ê¥ªÂãïÁí∞ÁØÄ

**9. Ë©ïÂÉπÊñπÂºè**Ôºö
   - ‰ΩøÁî®<h2>Êàñ<h3>Ê®ôÁ±§‰ΩúÁÇ∫Ê®ôÈ°å
   - ‰ΩøÁî®ÊúâÂ∫èÂàóË°®<ol>ÊàñÁÑ°Â∫èÂàóË°®<ul>
   - ÂåÖÂê´ÔºöÈÅéÁ®ãÊÄßË©ïÂÉπ„ÄÅÁ∏ΩÁµêÊÄßË©ïÂÉπ

**HTMLÊ®£ÂºèË¶ÅÊ±ÇÔºàÂøÖÈ†àÂö¥Ê†ºÈÅµÂæ™Ôºâ**Ôºö
- ‰ΩøÁî®ÂÆåÊï¥ÁöÑHTML5ÊñáÊ™îÁµêÊßãÔºà<!DOCTYPE html>„ÄÅ<html lang="zh-TW">„ÄÅ<head>„ÄÅ<body>Ôºâ
- Âú®<head>‰∏≠Ê∑ªÂä†ÂÆåÊï¥ÁöÑ<style>Ê®ôÁ±§ÂÆöÁæ©ÊâÄÊúâÊ®£Âºè
- Â≠óÈ´îÔºöÂÑ™ÂÖà‰ΩøÁî®"Microsoft YaHei"„ÄÅ"SimHei"„ÄÅ"Microsoft JhengHei"Á≠â‰∏≠ÊñáÂ≠óÈ´îÔºåÁ¢∫‰øùÁπÅÈ´î‰∏≠ÊñáÊ≠£Á¢∫È°ØÁ§∫
- Â≠óÈ´îÂ§ßÂ∞èÔºö
  * ‰∏ÄÁ¥öÊ®ôÈ°åÔºàË™≤È°åÂêçÁ®±ÔºâÔºö24pxÔºåÂä†Á≤óÔºåÂ±Ö‰∏≠
  * ‰∫åÁ¥öÊ®ôÈ°åÔºàÂêÑÁ´†ÁØÄÊ®ôÈ°åÔºâÔºö18pxÔºåÂä†Á≤óÔºåÂ∑¶Â∞çÈΩäÔºåÂ∏∂‰∏ãÂäÉÁ∑öÊàñÈÇäÊ°Ü
  * ‰∏âÁ¥öÊ®ôÈ°åÔºàÂ≠êÁ´†ÁØÄÔºâÔºö16pxÔºåÂä†Á≤óÔºåÂ∑¶Â∞çÈΩä
  * Ê≠£ÊñáÔºö14pxÔºåÂ∏∏Ë¶èÂ≠óÈáç
- Ë°åË∑ùÔºö1.8ÂÄçË°åË∑ùÔºàline-height: 1.8Ôºâ
- È†ÅÈÇäË∑ùÔºö‰∏ä‰∏ãÂ∑¶Âè≥20-30pxÔºàmargin: 20px 30pxÔºâ
- Ë°®Ê†ºÊ®£ÂºèÔºö
  * ÈÇäÊ°ÜÔºö1pxÂØ¶Á∑öÈªëËâ≤Ôºàborder: 1px solid #000Ôºâ
  * ÈÇäÊ°ÜÂêà‰ΩµÔºöborder-collapse: collapse
  * Ë°®Ê†ºÂØ¨Â∫¶Ôºö100%Ôºàwidth: 100%Ôºâ
  * ÂñÆÂÖÉÊ†ºÂÖßÈÇäË∑ùÔºö8-10pxÔºàpadding: 8px 10pxÔºâ
  * Ë°®È†≠ÔºöËÉåÊôØËâ≤#f0f0f0ÔºåÂ≠óÈ´îÂä†Á≤óÔºåÊñáÂ≠óÂ±Ö‰∏≠
  * Â•áÂÅ∂Ë°åÔºöÂèØÈÅ∏ËÉåÊôØËâ≤ÂçÄÂàÜÔºàtr:nth-child(even) { background-color: #fafafa; }Ôºâ
- Ê®ôÈ°åÊ®£ÂºèÔºö
  * Âä†Á≤óÔºàfont-weight: boldÔºâ
  * ÈÅ©Áï∂ÁöÑÂ≠óÈ´îÂ§ßÂ∞è
  * ‰∏ãÂäÉÁ∑öÊàñÂ∫ïÈÉ®ÈÇäÊ°ÜÔºàborder-bottom: 2px solid #333Ôºâ
  * ÈÅ©Áï∂ÁöÑ‰∏ä‰∏ãÈÇäË∑ùÔºàmargin: 15px 0 10px 0Ôºâ
- ÊÆµËêΩÊ®£ÂºèÔºö
  * ÊÆµËêΩÈñìË∑ùÔºö8pxÔºàmargin: 8px 0Ôºâ
  * ÊñáÊú¨Â∞çÈΩäÔºöÂÖ©Á´ØÂ∞çÈΩäÔºàtext-align: justifyÔºâ
  * Ë°åË∑ùÔºö1.8ÂÄç
- ÂàóË°®Ê®£ÂºèÔºö
  * ÊúâÂ∫èÂàóË°®Ôºö‰ΩøÁî®<ol>ÔºåÁ∑®ËôüÊ†ºÂºèÁÇ∫1„ÄÅ2„ÄÅ3...
  * ÁÑ°Â∫èÂàóË°®Ôºö‰ΩøÁî®<ul>ÔºåÈ†ÖÁõÆÁ¨¶ËôüÁÇ∫ÂúìÈªûÊàñÊñπÂ°ä
  * ÂàóË°®È†ÖÈñìË∑ùÔºö5pxÔºàmargin: 5px 0Ôºâ
  * ÂàóË°®Â∑¶ÈÇäË∑ùÔºö25pxÔºàmargin-left: 25pxÔºâ
- ÊâìÂç∞Ê®£ÂºèÔºö
  * ‰ΩøÁî®@media printÂÆöÁæ©ÊâìÂç∞ÊôÇÁöÑÊ®£Âºè
  * È†ÅÈù¢Â§ßÂ∞èÔºöA4Ôºà@page { size: A4; }Ôºâ
  * È†ÅÈÇäË∑ùÔºö15mmÔºàmargin: 15mmÔºâ
  * ÈÅøÂÖçË°®Ê†ºÂíåÊ®ôÈ°åË∑®È†ÅÊñ∑ÈñãÔºàpage-break-inside: avoidÔºâ

Ë´ãÂ∞á‰ª•‰∏ãÊïôÊ°àÂÖßÂÆπÊåâÁÖß‰∏äËø∞Êæ≥ÈñÄÊïôÊ°àPDFÊ†ºÂºèËΩâÊèõÁÇ∫ÂÆåÊï¥ÁöÑHTMLÈ†ÅÈù¢Ôºö
${lessonContent}

**Âö¥Ê†ºË¶ÅÊ±Ç**Ôºö
1. Ê†ºÂºèÂíåÁâàÈù¢ÂøÖÈ†àËàá‰∏äÂÇ≥ÁöÑPDFÁâàÈù¢ÂÆåÂÖ®‰∏ÄËá¥
2. ‰ΩøÁî®Ë°®Ê†ºÂ∏ÉÂ±ÄÔºåË°®Ê†ºÁµêÊßãÂøÖÈ†àËàáPDF‰∏≠ÁöÑË°®Ê†ºÁµêÊßã‰∏ÄÊ®°‰∏ÄÊ®£
3. ‰øùÊåÅÁπÅÈ´îÂ≠óËº∏Âá∫
4. ÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÁöÑÊ†ºÂºèÂåñÂÖÉÁ¥†ÂíåCSSÊ®£Âºè
5. ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´ÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè‰∫îÂàó
6. ÁîüÊàêÂÆåÊï¥ÁöÑHTMLÈ†ÅÈù¢‰ª£Á¢ºÔºåÂèØ‰ª•Áõ¥Êé•Âú®ÁÄèË¶ΩÂô®‰∏≠ÊâìÈñã
7. Á¢∫‰øùÊâÄÊúâÂÖßÂÆπÁµêÊßãÈÉΩÂåÖÂê´Âú®ÂÖß
8. HTML‰ª£Á¢ºÂøÖÈ†àË™ûÊ≥ïÊ≠£Á¢∫ÔºåÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®

Ë´ãÁõ¥Êé•Ëº∏Âá∫ÂÆåÊï¥ÁöÑHTML‰ª£Á¢ºÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïËß£ÈáãÊñáÂ≠ó„ÄÇ`;

                const response = await fetch(API_CONFIG.qwen.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.qwen.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.qwen.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àÊ†ºÂºèÂåñ‰∏ìÂÆ∂ÔºåÊìÖÈïøÂ∞ÜÊïôÊ°àÂÜÖÂÆπËΩ¨Êç¢‰∏∫Êæ≥Èó®Âú∞Âå∫Ê†áÂáÜÁöÑHTMLÊ†ºÂºè„ÄÇËØ∑‰∏•Ê†ºÊåâÁÖßÊèê‰æõÁöÑPDFÊ†ºÂºèÂèÇËÄÉÊù•ÁîüÊàêHTMLÔºåÁ°Æ‰øùÁªìÊûÑÂÆåÊï¥„ÄÅÁæéËßÇ„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: pdfFormatReference
                            }
                        ],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('qwen HTMLÊ†ºÂºèÂåñAPIÈîôËØØ:', errorText);
                    throw new Error(`qwen HTMLÊ†ºÂºèÂåñÂ§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();

                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    console.log('qwen HTMLÊ†ºÂºèÂåñÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('qwen HTMLÊ†ºÂºèÂåñÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('qwen HTMLÊ†ºÂºèÂåñË∞ÉÁî®ÈîôËØØ:', error);
                throw error;
            }
        }

        // ‰øùÂ≠òÊïôÊ°à‰∏∫PDF
        async function saveLessonPlanAsPDF(htmlContent, lessonTitle) {
            try {
                console.log('ÂºÄÂßãÁîüÊàêPDF...');

                // ÂàõÂª∫Êñ∞ÁöÑHTMLÈ°µÈù¢
                const newWindow = window.open('', '_blank', 'width=1200,height=800');

                if (!newWindow) {
                    throw new Error('Êó†Ê≥ïÊâìÂºÄÊñ∞Á™óÂè£ÔºåËØ∑ÂÖÅËÆ∏ÂºπÂá∫Á™óÂè£');
                }

                // ËÆæÁΩÆÈ°µÈù¢ÂÜÖÂÆπ
                const formattedTitle = lessonTitle.replace(/[^\w\u4e00-\u9fff]/g, '_');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);

                newWindow.document.write(`
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${lessonTitle} - ÊïôÊ°à</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            line-height: 1.6;
            margin: 20px;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 20px;
        }
        .header-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .activity-section {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
        }
        @media print {
            body { margin: 0; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="no-print" style="background: #e8f5e8; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <h3>üìÑ PDF‰øùÂ≠òËØ¥Êòé</h3>
        <p>1. Âè≥ÈîÆÁÇπÂáªÈ°µÈù¢Á©∫ÁôΩÂ§ÑÔºåÈÄâÊã©"ÊâìÂç∞"ÊàñÊåâCtrl+P</p>
        <p>2. Âú®ÊâìÂç∞ÂØπËØùÊ°Ü‰∏≠ÔºåÈÄâÊã©"ÁõÆÊ†áÊâìÂç∞Êú∫"‰∏∫"Âè¶Â≠ò‰∏∫PDF"</p>
        <p>3. ‰øùÂ≠ò‰ΩçÁΩÆÈÄâÊã©: <strong>E:\\desktop\\Êï∞ËØ¥\\proto\\learning_plan_pdf</strong></p>
        <p>4. Êñá‰ª∂ÂêçÂª∫ËÆÆ: <strong>${formattedTitle}_${timestamp}.pdf</strong></p>
        <p>5. ÁÇπÂáª"‰øùÂ≠ò"ÂÆåÊàêPDFÂØºÂá∫</p>
    </div>

    ${htmlContent}
</body>
</html>`);

                newWindow.document.close();

                // Ëá™Âä®Ëß¶ÂèëÊâìÂç∞ÂØπËØùÊ°Ü
                setTimeout(() => {
                    newWindow.print();
                }, 1000);

                showMessage('‚úÖ HTMLÊ†ºÂºèÂåñÂÆåÊàêÔºÅËØ∑ÊåâÈ°µÈù¢ËØ¥Êòé‰øùÂ≠ò‰∏∫PDF', 'success');

                console.log('PDFÁîüÊàêÂáÜÂ§áÂÆåÊàê');

            } catch (error) {
                console.error('PDFÁîüÊàêÂ§±Ë¥•:', error);
                showMessage(`‚ùå PDFÁîüÊàêÂ§±Ë¥•: ${error.message}`, 'error');
                throw error;
            }
        }

        // Ë∞ÉÁî®ÁßëÂ§ßËÆØÈ£ûSpark API
        async function callSparkAPI(prompt) {
            try {
                // Áî±‰∫éSpark‰ΩøÁî®WebSocketÔºåËøôÈáå‰ΩøÁî®Ê®°ÊãüÁöÑHTTPË∞ÉÁî®
                const response = await fetch('https://spark-api.xf-yun.com/v3.5/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.spark.apiKey}`,
                        'X-App-Id': API_CONFIG.spark.appId,
                        'X-API-Secret': API_CONFIG.spark.apiSecret
                    },
                    body: JSON.stringify({
                        model: 'spark-max',
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    console.log('ÁßëÂ§ßËÆØÈ£ûSpark APIË∞ÉÁî®ÊàêÂäü');
                    return convertToTraditionalChinese(data.choices[0].message.content);
                } else {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('ÁßëÂ§ßËÆØÈ£ûSpark APIË∞ÉÁî®ÈîôËØØ:', error);
                // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåËøîÂõûÊ®°ÊãüÂìçÂ∫î
                return `Âü∫‰∫éÊïôÊ°àÂÜÖÂÆπÁöÑËØ≠Èü≥‰∫§‰∫íÊïôÂ≠¶Âª∫ËÆÆÔºöÂ¢ûÂä†ËØ≠Èü≥‰∫íÂä®ÁéØËäÇÔºåÊèêÂçáÂ≠¶ÁîüÂè£ËØ≠Ë°®ËææËÉΩÂäõ„ÄÇ‰∏ì‰∏öËØÑÂàÜÔºö8.5/10`;
            }
        }

        // ÊµãËØïQwen APIËøûÊé•
        async function testQwenAPI() {
            const testBtn = document.getElementById('testQwenBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callQwenAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ ÈÄö‰πâÂçÉÈóÆAPIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå ÈÄö‰πâÂçÉÈóÆAPIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïÈÄö‰πâÂçÉÈóÆ';
            }
        }

        // ÊµãËØïË±ÜÂåÖAPIËøûÊé•
        async function testDoubaoAPI() {
            const testBtn = document.getElementById('testDoubaoBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callDoubaoAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ Ë±ÜÂåÖAPIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå Ë±ÜÂåÖAPIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïË±ÜÂåÖ';
            }
        }

        // ÊµãËØïKimi APIËøûÊé•
        async function testKimiAPI() {
            const testBtn = document.getElementById('testKimiBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callKimiAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ Kimi APIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå Kimi APIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïKimi';
            }
        }

        // ÊµãËØïÊô∫Ë∞±Ê∏ÖË®ÄAPIËøûÊé•
        async function testChatGLMAPI() {
            const testBtn = document.getElementById('testChatGLMBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callChatGLMAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ Êô∫Ë∞±Ê∏ÖË®ÄAPIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå Êô∫Ë∞±Ê∏ÖË®ÄAPIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïÊô∫Ë∞±Ê∏ÖË®Ä';
            }
        }

        // ÊµãËØïGemini APIËøûÊé•
        async function testGeminiAPI() {
            const testBtn = document.getElementById('testGeminiBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callGeminiAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ Gemini APIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå Gemini APIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïGemini';
            }
        }

        // ÊµãËØïDeepSeek APIËøûÊé•
        async function testDeepSeekAPI() {
            const testBtn = document.getElementById('testDeepSeekBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callDeepSeekAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ DeepSeek APIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå DeepSeek APIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïDeepSeek';
            }
        }

        // ÊµãËØïÁßëÂ§ßËÆØÈ£ûSpark APIËøûÊé•
        async function testSparkAPI() {
            const testBtn = document.getElementById('testSparkBtn');
            const resultDiv = document.getElementById('apiTestResult');

            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊµãËØï‰∏≠...';
            resultDiv.innerHTML = '';

            try {
                const testPrompt = 'ËØ∑ÁÆÄÂçïÂõûÂ§ç"APIËøûÊé•Ê≠£Â∏∏"ÔºåËØÅÊòé‰Ω†ËÉΩÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ';
                const response = await callSparkAPI(testPrompt);

                if (response) {
                    resultDiv.innerHTML = `
                        <div style="color: #52c41a; background: rgba(82, 196, 26, 0.1); border: 1px solid rgba(82, 196, 26, 0.3); padding: 10px; border-radius: 6px;">
                            <strong>‚úÖ ÁßëÂ§ßËÆØÈ£ûSpark APIËøûÊé•ÊàêÂäüÔºÅ</strong><br>
                            <span style="font-size: 0.9rem;">ÂìçÂ∫îÔºö${response}</span>
                        </div>
                    `;
                } else {
                    throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ff4d4f; background: rgba(255, 77, 79, 0.1); border: 1px solid rgba(255, 77, 79, 0.3); padding: 10px; border-radius: 6px;">
                        <strong>‚ùå ÁßëÂ§ßËÆØÈ£ûSpark APIËøûÊé•Â§±Ë¥•</strong><br>
                        <span style="font-size: 0.9rem;">ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</span><br>
                        <span style="font-size: 0.8rem;">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÈÖçÁΩÆ</span>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-wifi"></i> ÊµãËØïÁßëÂ§ßËÆØÈ£û';
            }
        }

        // ‰∏ãËΩΩ‰ºòÂåñÊïôÊ°à
        function downloadOptimizedLesson() {
            const content = generateLessonContent();
            downloadFile(content, '‰ºòÂåñÊïôÊ°à.txt', 'text/plain');
        }

        // ‰∏ãËΩΩËØÑ‰ª∑ÈáèË°®
        function downloadEvaluationForm() {
            const content = generateEvaluationContent();
            downloadFile(content, 'Â≠¶ÁîüËØÑ‰ª∑ÈáèË°®.txt', 'text/plain');
        }

        // ‰∏ãËΩΩÂÆåÊï¥Êä•Âëä
        function downloadFullReport() {
            const content = generateFullReport();
            downloadFile(content, 'ÂÆåÊï¥ÂàÜÊûêÊä•Âëä.txt', 'text/plain');
        }

        // ÁîüÊàêÊïôÊ°àÂÜÖÂÆπ
        function generateLessonContent() {
            const lessonTitle = extractLessonTitle(fileContent);
            const results = generateFinalResults();

            return `‰ºòÂåñÊïôÊ°àÔºö${lessonTitle}

=== ‰ºòÂåñÊïôÂ≠¶ÁõÆÊ†á ===
${results.objectives.map((obj, i) => `${i+1}. ${obj}`).join('\n')}

=== ÊîπËøõÊïôÂ≠¶ÊµÅÁ®ã ===
${results.procedures.map((proc, i) => `${i+1}. ${proc}`).join('\n')}

=== ÂàõÊñ∞ÊïôÂ≠¶Ê¥ªÂä® ===
${results.activities.map((act, i) => `${i+1}. ${act}`).join('\n')}

=== ËØÑ‰ª∑ÈáèË°® ===
${Object.entries(results.evaluationDimensions).map(([dim, indicators]) =>
    `${dim}Ôºö${indicators.join('„ÄÅ')}`).join('\n')}
`;
        }

        // ÁîüÊàêËØÑ‰ª∑ÂÜÖÂÆπ
        function generateEvaluationContent() {
            const results = generateFinalResults();

            return `Â≠¶ÁîüËØÑ‰ª∑ÈáèË°®

=== ËØÑ‰ª∑Áª¥Â∫¶ ===

${Object.entries(results.evaluationDimensions).map(([dim, indicators]) =>
    `„Äê${dim}„Äë
${indicators.map((indicator, i) => `${i+1}. ${indicator}`).join('\n')}

`).join('\n')}

=== ËØÑ‰ª∑Ê†áÂáÜ ===
‰ºòÁßÄÔºà9-10ÂàÜÔºâÔºöÂÆåÂÖ®ËææÂà∞Ë¶ÅÊ±ÇÔºåË°®Áé∞Âá∫Ëâ≤
ËâØÂ•ΩÔºà7-8ÂàÜÔºâÔºöÂü∫Êú¨ËææÂà∞Ë¶ÅÊ±ÇÔºåÊúâÂæÖÊèêÈ´ò
ÂêàÊ†ºÔºà5-6ÂàÜÔºâÔºöÂü∫Êú¨Á¨¶ÂêàË¶ÅÊ±ÇÔºåÈúÄË¶ÅÊîπËøõ
ÂæÖÊîπËøõÔºà<5ÂàÜÔºâÔºöÈúÄË¶ÅÈáçÁÇπÂÖ≥Ê≥®ÂíåËæÖÂØº
`;
        }

        // ÁîüÊàêÂÆåÊï¥Êä•Âëä
        function generateFullReport() {
            const lessonTitle = extractLessonTitle(fileContent);
            const results = generateFinalResults();

            return `ÂÆåÊï¥ÂàÜÊûêÊä•ÂëäÔºö${lessonTitle}

=== ÂéüÂßãÊïôÊ°àÂàÜÊûê ===
${fileContent.substring(0, 500)}...

=== ÊïôÊ°àËß£ÊûêÁªìÊûú ===
${parsedFileContent || 'Ëß£ÊûêÂÜÖÂÆπ...'}

=== ‰∏ìÂÆ∂ÂàÜÊûêÁªìÊûú ===
${agents.map(agent => `„Äê${agent.name}„Äë
ÂÖ≥ÈîÆÂèëÁé∞Ôºö${analysisResults[agent.key]?.keyFindings || 'ÂàÜÊûê‰∏≠...'}
‰∏ªË¶ÅÂª∫ËÆÆÔºö${analysisResults[agent.key]?.mainRecommendation || 'ÂàÜÊûê‰∏≠...'}
‰∏ì‰∏öËØÑÂàÜÔºö${analysisResults[agent.key]?.score || 'N/A'}/10

`).join('\n')}

=== ‰ºòÂåñÊïôÂ≠¶ÁõÆÊ†á ===
${results.objectives.map((obj, i) => `${i+1}. ${obj}`).join('\n')}

=== ÊîπËøõÊïôÂ≠¶ÊµÅÁ®ã ===
${results.procedures.map((proc, i) => `${i+1}. ${proc}`).join('\n')}

=== ÂàõÊñ∞ÊïôÂ≠¶Ê¥ªÂä® ===
${results.activities.map((act, i) => `${i+1}. ${act}`).join('\n')}

=== Â≠¶ÁîüËØÑ‰ª∑ÈáèË°® ===
${Object.entries(results.evaluationDimensions).map(([dim, indicators]) =>
    `${dim}Ôºö${indicators.join('„ÄÅ')}`).join('\n')}

=== Ë¥®ÈáèÊåáÊ†á ===
‰∏ìÂÆ∂ÂÖ±ËØÜÂ∫¶Ôºö85%
ÂàõÊñ∞Á®ãÂ∫¶Ôºö88%
ÂÆûÁî®ÊÄßÔºö92%
ÊÄª‰ΩìË¥®ÈáèÔºö89%

ÂàÜÊûêÂÆåÊàêÊó∂Èó¥Ôºö${new Date().toLocaleString()}
`;
        }

        // ‰∏ãËΩΩÊñá‰ª∂
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage(`${filename} ‰∏ãËΩΩÊàêÂäüÔºÅ`, 'success');
        }

        // ÈáçÁΩÆÁ≥ªÁªü
        function resetSystem() {
            // ÈáçÁΩÆÂèòÈáè
            currentFile = null;
            fileContent = '';
            parsedFileContent = '';
            analysisInProgress = false;
            analysisResults = {};

            // ÈöêËóèÊâÄÊúâÈò∂ÊÆµÂÆπÂô®
            const stage1Container = document.getElementById('stage1Container');
            const stage2Container = document.getElementById('stage2Container');
            const stage3Container = document.getElementById('stage3Container');
            const parsedContentPreview = document.getElementById('parsedContentPreview');
            const filePreview = document.getElementById('filePreview');
            const messageBox = document.getElementById('messageBox');

            if (stage1Container) stage1Container.remove();
            if (stage2Container) stage2Container.remove();
            if (stage3Container) stage3Container.remove();
            if (parsedContentPreview) parsedContentPreview.remove();
            if (filePreview) filePreview.style.display = 'none';
            if (messageBox) messageBox.style.display = 'none';

            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            document.getElementById('fileInput').value = '';

            // ÊªöÂä®Âà∞È°∂ÈÉ®
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showMessage('Á≥ªÁªüÂ∑≤ÈáçÁΩÆÔºåÂèØ‰ª•‰∏ä‰º†Êñ∞ÁöÑÊïôÊ°àÊñá‰ª∂', 'info');
        }

        // ========== PDFËΩ¨ÂõæÁâáÂäüËÉΩ ==========
        async function pdfToImage(pdfFile) {
            try {
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('pdf.jsÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËΩ¨Êç¢PDF');
                }
                
                showMessage('üìÑ Ê≠£Âú®Â∞ÜPDFËΩ¨Êç¢‰∏∫ÂõæÁâá...', 'info');
                
                // ËØªÂèñPDFÊñá‰ª∂
                const arrayBuffer = await pdfFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                
                // Ëé∑ÂèñÁ¨¨‰∏ÄÈ°µÔºàÈÄöÂ∏∏Á¨¨‰∏ÄÈ°µÂåÖÂê´ÂÆåÊï¥ÁöÑÊ†ºÂºè‰ø°ÊÅØÔºâ
                const page = await pdf.getPage(1);
                
                // ËÆæÁΩÆÊ∏≤ÊüìÈÄâÈ°πÔºàÊèêÈ´òÊ∏ÖÊô∞Â∫¶Ôºâ
                const viewport = page.getViewport({scale: 2.0});
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Ê∏≤ÊüìPDFÈ°µÈù¢Âà∞canvas
                const renderTask = page.render({
                    canvasContext: context,
                    viewport: viewport
                });
                await renderTask.promise;
                
                // Â∞ÜcanvasËΩ¨Êç¢‰∏∫base64ÂõæÁâá
                const imageBase64 = canvas.toDataURL('image/png');
                
                showMessage('‚úÖ PDFÂ∑≤ËΩ¨Êç¢‰∏∫ÂõæÁâá', 'success');
                return imageBase64;
            } catch (error) {
                console.error('PDFËΩ¨ÂõæÁâáÂ§±Ë¥•:', error);
                throw new Error('PDFËΩ¨ÂõæÁâáÂ§±Ë¥•Ôºö' + error.message);
            }
        }

        // ========== ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àPDFÂäüËÉΩÔºàÂÆåÂÖ®Ëá™Âä®ÂåñÁâàÊú¨Ôºâ==========
        
        // ÂÖ®Â±ÄÂèòÈáèÔºö‰øùÂ≠òÁî®Êà∑ÈÄâÊã©ÁöÑÁõÆÂΩïÂè•ÊüÑ
        window.savedDirectoryHandle = null;
        
        window.exportLocalStylePDF = async function(planType = 'optimized') {
            try {
                // Ê†πÊçÆplanTypeÁ°ÆÂÆö‰ΩøÁî®Âì™‰∏™ÊïôÊ°àÂÜÖÂÆπ
                let lessonPlanText = null;
                let planName = '';
                
                if (planType === 'initial') {
                    // ÂàùÊ≠•ÊïôÊ°à
                    if (!window.initialTeachingPlan || window.initialTeachingPlan.trim().length < 50) {
                        showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑÂàùÊ≠•ÊïôÊ°àÂÜÖÂÆπ', 'error');
                        return;
                    }
                    lessonPlanText = window.initialTeachingPlan;
                    planName = 'ÂàùÊ≠•ÊïôÊ°à';
                } else {
                    // ‰ºòÂåñÊïôÊ°àÔºàÈªòËÆ§Ôºâ
                    if (!window.finalTeachingPlanClean || window.finalTeachingPlanClean.trim().length < 50) {
                        showMessage('‚ùå Ê≤°ÊúâÂèØÁî®ÁöÑ‰ºòÂåñÊïôÊ°àÂÜÖÂÆπ', 'error');
                        return;
                    }
                    lessonPlanText = window.finalTeachingPlanClean;
                    planName = '‰ºòÂåñÊïôÊ°à';
                }

                showMessage(`üîÑ Ê≠•È™§1/3ÔºöËØ∑ÈÄâÊã©ÂèÇËÄÉPDFÊñá‰ª∂ÔºàÁî®‰∫éÊ†ºÂºèÂèÇËÄÉÔºâ...`, 'info');
                
                // Ê≠•È™§1ÔºöËÆ©Áî®Êà∑ÈÄâÊã©ÂèÇËÄÉPDFÊñá‰ª∂ÔºàÁªôAIÂ§ßÊ®°ÂûãÂèÇËÄÉÔºâ
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        showMessage('‚ùå Êú™ÈÄâÊã©Êñá‰ª∂', 'error');
                        return;
                    }
                    
                    try {
                        showMessage('üîÑ Ê≠•È™§2/3ÔºöÊ≠£Âú®ÂàÜÊûêÂèÇËÄÉÊ†ºÂºè...', 'info');
                        
                        // Â∞ÜPDFËΩ¨Êç¢‰∏∫ÂõæÁâá
                        const imageBase64 = await pdfToImage(file);
                        
                        // Ë∞ÉÁî®AIÁîüÊàêHTMLÔºåÂπ∂Ëá™Âä®‰øùÂ≠ò‰∏∫PDF
                        await generateHTMLByAIAndAutoSavePDF(lessonPlanText, imageBase64, planName);
                    } catch (error) {
                        console.error('Â§ÑÁêÜPDFÊñá‰ª∂Â§±Ë¥•:', error);
                        showMessage('‚ùå Â§ÑÁêÜÂ§±Ë¥•Ôºö' + error.message, 'error');
                    }
                };
                input.click();
                
            } catch (error) {
                console.error('ÂØºÂá∫Êú¨Âú∞È£éÊ†ºÊïôÊ°àÂ§±Ë¥•:', error);
                showMessage('‚ùå ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        };
        
        // ÁîüÊàêÊ†áÂáÜÊæ≥Èó®ÊïôÊ°àHTMLÊ®°ÊùøÔºàÂÜÖÁΩÆÊ®°ÊùøÔºå‰∏çÈúÄË¶ÅÂèÇËÄÉPDFÔºâ
        function generateStandardMacauHTMLTemplate(lessonPlanText, planName) {
            // Â∞ÜÊñáÊú¨ÂÜÖÂÆπËΩ¨Êç¢‰∏∫HTMLÊ†ºÂºè
            let htmlBody = lessonPlanText;
            
            // ÂÖàÂ§ÑÁêÜË°®Ê†ºÔºàMarkdownË°®Ê†ºÊ†ºÂºèÔºâ
            const tableRegex = /(\|.+\|[\s\S]*?)(?=\n\n|$)/gm;
            htmlBody = htmlBody.replace(tableRegex, function(tableText) {
                const lines = tableText.trim().split('\n');
                if (lines.length < 2) return tableText;
                
                let tableHTML = '<table style="border-collapse: collapse; width: 100%; margin: 15px 0; border: 1px solid #000;">\n';
                
                lines.forEach((line, index) => {
                    // Ë∑≥ËøáÂàÜÈöîÁ∫øÔºàÂ¶Ç|---|---|Ôºâ
                    if (line.includes('---')) return;
                    
                    const cells = line.split('|').filter(cell => cell.trim() !== '');
                    const tag = index === 0 ? 'th' : 'td';
                    const style = index === 0 ? 
                        'border: 1px solid #000; padding: 8px 10px; background-color: #f0f0f0; font-weight: bold; text-align: center;' : 
                        'border: 1px solid #000; padding: 8px 10px; text-align: left; vertical-align: top;';
                    
                    tableHTML += '  <tr>\n';
                    cells.forEach(cell => {
                        tableHTML += `    <${tag} style="${style}">${cell.trim()}</${tag}>\n`;
                    });
                    tableHTML += '  </tr>\n';
                });
                
                tableHTML += '</table>';
                return tableHTML;
            });
            
            // Êô∫ËÉΩÊ†ºÂºèÂåñÔºöÂ∞ÜÂ∏∏ËßÅÁöÑÊïôÊ°àÊ†áËÆ∞ËΩ¨Êç¢‰∏∫HTML
            htmlBody = htmlBody
                // Â§ÑÁêÜ‰∏ªÊ†áÈ¢òÔºàÂ∏¶„Äê„ÄëÁöÑÔºâ
                .replace(/„Äê([^„Äë]+)„Äë/g, '<h2 style="color: #333; font-size: 18px; font-weight: bold; margin: 15px 0 10px 0; border-bottom: 2px solid #333; padding-bottom: 5px;">„Äê$1„Äë</h2>')
                // Â§ÑÁêÜÂ∞èÊ†áÈ¢òÔºà‰∏Ä„ÄÅ‰∫å„ÄÅ‰∏âÁ≠âÔºâ
                .replace(/^([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]+„ÄÅ.+)$/gm, '<h3 style="color: #333; font-size: 16px; font-weight: bold; margin: 12px 0 8px 0;">$1</h3>')
                // Â§ÑÁêÜÂàóË°®È°πÔºàÊï∞Â≠ó+ÁÇπÔºâ
                .replace(/^(\d+\.|[‚≠êüî∏üí°üìöüë•])\s*(.+)$/gm, '<p style="margin: 8px 0 8px 20px; line-height: 1.8;">$1 $2</p>')
                // Â§ÑÁêÜÊÆµËêΩ
                .replace(/\n\n/g, '</p><p style="margin: 8px 0; text-align: justify; line-height: 1.8;">')
                // Â§ÑÁêÜÂçï‰∏™Êç¢Ë°å
                .replace(/\n/g, '<br>');
            
            // ÁîüÊàêÂÆåÊï¥ÁöÑHTMLÊñáÊ°£
            const htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${planName} - Êæ≥Èó®Ê†áÂáÜÊïôÊ°à</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", "SimHei", "Microsoft JhengHei", "PingFang SC", Arial, sans-serif;
            line-height: 1.8;
            margin: 20mm 25mm;
            color: #000;
            background: #fff;
            font-size: 14px;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #000;
        }
        h2 {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #000;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        h3 {
            font-size: 16px;
            font-weight: bold;
            margin: 12px 0 8px 0;
            color: #000;
        }
        p {
            margin: 8px 0;
            text-align: justify;
            line-height: 1.8;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            border: 1px solid #000;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        ul, ol {
            margin: 10px 0 10px 25px;
            line-height: 1.8;
        }
        li {
            margin: 5px 0;
        }
        .header-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 30px 0;
            color: #000;
        }
        @media print {
            body {
                margin: 15mm 20mm;
            }
            @page {
                size: A4;
                margin: 15mm;
            }
            table {
                page-break-inside: avoid;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header-title">${planName}</div>
    <div class="content">
        ${htmlBody}
    </div>
    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; color: #666; font-size: 12px;">
        Áî±EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªüÁîüÊàê | Ë®≠Ë®àËÄÖÔºöAIÊïôÂ∏´
    </div>
</body>
</html>`;
            
            return htmlContent;
        }
        
        // Ëá™Âä®ÊâìÂºÄÊâìÂç∞ÂØπËØùÊ°Ü
        function autoOpenPrintDialog(htmlContent, planName) {
            try {
                const printWindow = window.open('', '_blank', 'width=900,height=700');
                if (!printWindow) {
                    showMessage('‚ùå Êó†Ê≥ïÊâìÂºÄÊâìÂç∞Á™óÂè£ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÂºπÁ™óËÆæÁΩÆ', 'error');
                    return;
                }
                
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // Á≠âÂæÖÂÜÖÂÆπÂä†ËΩΩÂÆåÊØïÂêéËá™Âä®Ëß¶ÂèëÊâìÂç∞
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    
                    console.log('‚úÖ ÊâìÂç∞ÂØπËØùÊ°ÜÂ∑≤ÊâìÂºÄ');
                    
                    // ÁõëÂê¨ÊâìÂç∞Á™óÂè£ÂÖ≥Èó≠
                    const checkClosed = setInterval(() => {
                        if (printWindow.closed) {
                            clearInterval(checkClosed);
                            console.log('‚úÖ ÊâìÂç∞Á™óÂè£Â∑≤ÂÖ≥Èó≠');
                        }
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error('ÊâìÂºÄÊâìÂç∞ÂØπËØùÊ°ÜÂ§±Ë¥•:', error);
                showMessage('‚ùå ÊâìÂç∞Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // AIÁîüÊàêHTMLÂπ∂Ëá™Âä®‰øùÂ≠ò‰∏∫PDFÔºàÂÆåÂÖ®Ëá™Âä®ÂåñÔºâ
        async function generateHTMLByAIAndAutoSavePDF(lessonPlanText, imageBase64, planName) {
            try {
                showMessage('ü§ñ AIÊ≠£Âú®Ê†πÊçÆÂèÇËÄÉÊ†ºÂºèÁîüÊàêHTML...', 'info');
                
                // ÊûÑÂª∫ÊèêÁ§∫ËØçÔºà‰∏é‰πãÂâçÁõ∏ÂêåÔºâ
                const prompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àÊ†ºÂºèËΩ¨Êç¢‰∏ìÂÆ∂„ÄÇËØ∑Ê†πÊçÆ‰ª•‰∏ãÂÜÖÂÆπÔºö

1. „ÄêÂΩìÂâçÊïôÊ°àÂÜÖÂÆπ„ÄëÔºàtxtÊ†ºÂºèÔºâÔºö
${lessonPlanText}

2. „ÄêÂèÇËÄÉÊ†ºÂºèÂõæÁâá„ÄëÔºàPDFÁ¨¨‰∏ÄÈ°µÁöÑÊà™ÂõæÔºâÔºö
ËøôÊòØ‰∏Ä‰ªΩÊæ≥Èó®Âú∞Âå∫Ê†áÂáÜÊïôÊ°àÁöÑÂèÇËÄÉÊ†ºÂºèÂõæÁâáÔºåËØ∑‰ªîÁªÜÂàÜÊûêÂÖ∂Ê†ºÂºèÂíåÊ†∑ÂºèÔºåÂåÖÊã¨Ôºö

**Ë°®Ê†ºÁªìÊûÑË¶ÅÊ±Ç**Ôºö
- Ë°®Ê†ºËæπÊ°ÜÊ†∑ÂºèÔºàÂÆûÁ∫ø„ÄÅÁ≤óÁªÜ„ÄÅÈ¢úËâ≤Ôºâ
- ÂçïÂÖÉÊ†ºÂØπÈΩêÊñπÂºèÔºàÂ∑¶ÂØπÈΩê„ÄÅÂ±Ö‰∏≠„ÄÅÂè≥ÂØπÈΩêÔºâ
- ÂçïÂÖÉÊ†ºÂêàÂπ∂Ôºàcolspan„ÄÅrowspanÔºâ
- Ë°®Â§¥Ê†∑ÂºèÔºàËÉåÊôØËâ≤„ÄÅÂ≠ó‰ΩìÂä†Á≤ó„ÄÅÂ±Ö‰∏≠Á≠âÔºâ
- Ë°®Ê†ºÂÆΩÂ∫¶ÂíåÂàóÂÆΩÊØî‰æã
- ÂçïÂÖÉÊ†ºÂÜÖËæπË∑ùÔºàpaddingÔºâ

**Ê†áÈ¢òÂ±ÇÁ∫ßË¶ÅÊ±Ç**Ôºö
- ‰∏ÄÁ∫ßÊ†áÈ¢òÔºàËØæÈ¢òÂêçÁß∞ÔºâÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤ó„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè
- ‰∫åÁ∫ßÊ†áÈ¢òÔºàÂêÑÁ´†ËäÇÊ†áÈ¢òÔºâÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤ó„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè
- ‰∏âÁ∫ßÊ†áÈ¢òÔºàÂ≠êÁ´†ËäÇÔºâÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤ó„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè
- Ê†áÈ¢òÂâçÂêéÁöÑÈó¥Ë∑ù

**ÊÆµËêΩÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
- ÊÆµËêΩÁº©ËøõÔºàÈ¶ñË°åÁº©Ëøõ„ÄÅÊï¥‰ΩìÁº©ËøõÔºâ
- Ë°åË∑ùÔºàline-heightÔºâ
- ÊÆµËêΩÈó¥Ë∑ùÔºàmarginÔºâ
- ÂØπÈΩêÊñπÂºèÔºàÂ∑¶ÂØπÈΩê„ÄÅ‰∏§Á´ØÂØπÈΩêÔºâ
- Â≠ó‰ΩìÂ§ßÂ∞èÂíåÈ¢úËâ≤

**Êï¥‰ΩìÂ∏ÉÂ±ÄË¶ÅÊ±Ç**Ôºö
- È°µËæπË∑ùÔºà‰∏ä‰∏ãÂ∑¶Âè≥Ôºâ
- È°µÈù¢ÂÆΩÂ∫¶ÂíåÊúÄÂ§ßÂÆΩÂ∫¶
- ÂàÜÊ†èÂ∏ÉÂ±ÄÔºàÂ¶ÇÊûúÊúâÔºâ
- ËÉåÊôØËâ≤ÂíåÊñáÂ≠óÈ¢úËâ≤
- ÊâìÂç∞Êó∂ÁöÑÈ°µÈù¢ËÆæÁΩÆ

**ÁâπÊÆäÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
- ÂàóË°®Ê†∑ÂºèÔºàÊúâÂ∫èÂàóË°®„ÄÅÊó†Â∫èÂàóË°®Ôºâ
- Âº∫Ë∞ÉÊñáÊú¨ÔºàÂä†Á≤ó„ÄÅÊñú‰Ωì„ÄÅ‰∏ãÂàíÁ∫øÔºâ
- ÁºñÂè∑Ê†ºÂºèÔºàÂ¶ÇÔºö‰∏Ä„ÄÅ‰∫å„ÄÅ‰∏â Êàñ 1„ÄÅ2„ÄÅ3Ôºâ
- Ë°®Ê†º‰∏≠ÁöÑÁõÆÊ†á‰ª£Âè∑Ê†ºÂºè
- Êó∂Èó¥„ÄÅÊïôÂ≠¶ËµÑÊ∫ê„ÄÅËØÑÈáèÁ≠âÂàóÁöÑÊ†ºÂºè

ËØ∑Ê†πÊçÆÂèÇËÄÉÂõæÁâáÁöÑÊ†ºÂºèÂíåÊ†∑ÂºèÔºåÂ∞ÜÂΩìÂâçÊïôÊ°àÂÜÖÂÆπËΩ¨Êç¢‰∏∫ÂØπÂ∫îÁöÑHTMLÊ†ºÂºè„ÄÇ

**‚ö†Ô∏è ‰∏•Ê†ºË¶ÅÊ±ÇÔºöÁîüÊàêÁöÑHTMLÊ†ºÂºèÂøÖÈ°ª‰∏éÂèÇËÄÉPDFÂõæÁâáÁöÑÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥ÔºåÂåÖÊã¨ÊØè‰∏Ä‰∏™ÁªÜËäÇÔºÅ**

**Ê†ºÂºèË¶ÅÊ±ÇËØ¶ÁªÜËØ¥Êòé**Ôºö

1. **HTMLÊ†ºÂºèÂøÖÈ°ª‰∏éÂèÇËÄÉÂõæÁâáÁöÑÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥**ÔºåÂåÖÊã¨Ôºö
   - **Ë°®Ê†ºÁªìÊûÑ**ÔºöË°®Ê†ºËæπÊ°ÜÊ†∑Âºè„ÄÅÂçïÂÖÉÊ†ºÂêàÂπ∂„ÄÅÂàóÂÆΩÊØî‰æãÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **Ë°®Ê†ºÂØπÈΩê**ÔºöË°®Â§¥Â±Ö‰∏≠„ÄÅÂÜÖÂÆπÂ∑¶ÂØπÈΩê/Â±Ö‰∏≠/Âè≥ÂØπÈΩêÂøÖÈ°ª‰∏éPDF‰∏ÄËá¥
   - **Ê†áÈ¢òÂ±ÇÁ∫ß**ÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤óÁ®ãÂ∫¶„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºèÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **ÊÆµËêΩÊ†ºÂºè**ÔºöÁº©Ëøõ„ÄÅË°åË∑ù„ÄÅÊÆµËêΩÈó¥Ë∑ùÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **Êï¥‰ΩìÂ∏ÉÂ±Ä**ÔºöÈ°µËæπË∑ù„ÄÅÈ°µÈù¢ÂÆΩÂ∫¶„ÄÅÂàÜÊ†èÂ∏ÉÂ±ÄÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **Â≠ó‰ΩìÊ†∑Âºè**ÔºöÂ≠ó‰ΩìÁ±ªÂûã„ÄÅÂ§ßÂ∞è„ÄÅÈ¢úËâ≤ÂøÖÈ°ª‰∏éPDFÂÆåÂÖ®‰∏ÄËá¥

2. **‰ΩøÁî®Á≤æÁ°ÆÁöÑCSSÊ†∑Âºè**ÔºàÂøÖÈ°ªÂåÖÂê´Âú®<style>Ê†áÁ≠æ‰∏≠ÔºâÔºö
   - ‰ΩøÁî®ÂÆåÊï¥ÁöÑCSSÊ†∑ÂºèÂÆö‰πâÔºå‰∏çË¶Å‰ΩøÁî®ÂÜÖËÅîÊ†∑ÂºèÔºàÈô§ÈùûÂøÖË¶ÅÔºâ
   - Á°Æ‰øùÊâìÂç∞Êó∂Ê†ºÂºèÁæéËßÇÔºà‰ΩøÁî®@media printÂÆö‰πâÊâìÂç∞Ê†∑ÂºèÔºâ
   - Â≠ó‰ΩìÔºö‰ºòÂÖà‰ΩøÁî®"Microsoft YaHei"„ÄÅ"SimHei"„ÄÅ"Microsoft JhengHei"Á≠â‰∏≠ÊñáÂ≠ó‰Ωì
   - È¢úËâ≤Ôºö‰ΩøÁî®ÂçÅÂÖ≠ËøõÂà∂ÂÄºÔºàÂ¶Ç#000000„ÄÅ#333333ÔºâÔºåÁ°Æ‰øù‰∏éPDF‰∏ÄËá¥
   - ÊâÄÊúâÊ†∑ÂºèÂøÖÈ°ªÊòéÁ°ÆÂÆö‰πâÔºå‰∏çË¶Å‰æùËµñÊµèËßàÂô®ÈªòËÆ§Ê†∑Âºè

3. **Ë°®Ê†ºÊ†ºÂºèË¶ÅÊ±ÇÔºàÊïôÂ≠¶ÊµÅÁ®ãË°®Ê†ºÔºâ**Ôºö
   - **ÂøÖÈ°ªÂåÖÂê´‰∫îÂàó**ÔºöÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè
   - **Ë°®Ê†ºËæπÊ°Ü**Ôºö1pxÂÆûÁ∫øÈªëËâ≤Ôºàborder: 1px solid #000Ôºâ
   - **ËæπÊ°ÜÂêàÂπ∂**Ôºöborder-collapse: collapse
   - **Ë°®Â§¥Ê†∑Âºè**ÔºöËÉåÊôØËâ≤#f0f0f0ÔºåÂ≠ó‰ΩìÂä†Á≤óÔºåÊñáÂ≠óÂ±Ö‰∏≠
   - **ÂçïÂÖÉÊ†ºÂØπÈΩê**Ôºö
     * ÁõÆÊ®ô‰ª£ËôüÂàóÔºöÂ±Ö‰∏≠ÊàñÂ∑¶ÂØπÈΩê
     * Ê¥ªÂãïÊµÅÁ®ãÂàóÔºöÂ∑¶ÂØπÈΩê
     * ÊôÇÈñìÂàóÔºöÂ±Ö‰∏≠
     * ÊïôÂ≠∏Ë≥áÊ∫êÂàóÔºöÂ∑¶ÂØπÈΩê
     * Ë©ïÈáèÂàóÔºöÂ∑¶ÂØπÈΩê
   - **ÂçïÂÖÉÊ†ºÂÜÖËæπË∑ù**Ôºö8-10pxÔºàpadding: 8px 10pxÔºâ
   - **Ë°®Ê†ºÂÆΩÂ∫¶**Ôºö100%Ôºàwidth: 100%Ôºâ

4. **Ê†áÈ¢òÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
   - **‰∏ÄÁ∫ßÊ†áÈ¢òÔºàËØæÈ¢òÂêçÁß∞Ôºâ**Ôºö24pxÔºåÂä†Á≤óÔºåÂ±Ö‰∏≠Ôºå‰∏ä‰∏ãËæπË∑ù20px
   - **‰∫åÁ∫ßÊ†áÈ¢òÔºàÁ´†ËäÇÊ†áÈ¢òÔºâ**Ôºö18pxÔºåÂä†Á≤óÔºåÂ∑¶ÂØπÈΩêÔºåÂ∫ïÈÉ®ËæπÊ°Ü2pxÂÆûÁ∫øÔºå‰∏ä‰∏ãËæπË∑ù15px/10px
   - **‰∏âÁ∫ßÊ†áÈ¢òÔºàÂ≠êÁ´†ËäÇÔºâ**Ôºö16pxÔºåÂä†Á≤óÔºåÂ∑¶ÂØπÈΩêÔºå‰∏ä‰∏ãËæπË∑ù12px/8px

5. **ÊÆµËêΩÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
   - Â≠ó‰ΩìÂ§ßÂ∞èÔºö14px
   - Ë°åË∑ùÔºö1.8ÂÄçÔºàline-height: 1.8Ôºâ
   - ÊÆµËêΩÈó¥Ë∑ùÔºö8pxÔºàmargin: 8px 0Ôºâ
   - ÊñáÊú¨ÂØπÈΩêÔºö‰∏§Á´ØÂØπÈΩêÔºàtext-align: justifyÔºâ

6. **ËæìÂá∫ÂÆåÊï¥ÁöÑHTMLÊñáÊ°£**Ôºö
   - ÂåÖÂê´<!DOCTYPE html>Â£∞Êòé
   - ÂåÖÂê´<html lang="zh-TW">Ê†áÁ≠æ
   - ÂåÖÂê´ÂÆåÊï¥ÁöÑ<head>Ê†áÁ≠æÔºö
     * <meta charset="UTF-8">
     * <meta name="viewport" content="width=device-width, initial-scale=1.0">
     * <title>ÊïôÊ°à</title>
     * <style>...</style>ÔºàÂåÖÂê´ÊâÄÊúâCSSÊ†∑ÂºèÔºâ
   - ÂåÖÂê´ÂÆåÊï¥ÁöÑ<body>Ê†áÁ≠æ
   - Á°Æ‰øùHTMLÁªìÊûÑÂÆåÊï¥„ÄÅËØ≠Ê≥ïÊ≠£Á°ÆÔºåÂèØ‰ª•Áõ¥Êé•Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄ

7. **Êæ≥Èó®Âú∞Âå∫ÊïôÊ°àÁâπÊÆäË¶ÅÊ±Ç**Ôºö
   - ‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÔºàlang="zh-TW"Ôºâ
   - Ë°®È†≠‰ø°ÊÅØÂçÄÂüü‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºà‰∏§ÂàóË°®Ê†ºÔºöÈ†ÖÁõÆ„ÄÅÂÖßÂÆπÔºâ
   - ÊïôÂ≠∏Á†îÁ©∂ÈÉ®ÂàÜÂåÖÂê´ÊâÄÊúâÂ≠êÊ¨ÑÁõÆÔºà‰∏Ä„ÄÅË®≠Ë®àÁêÜÂøµËàáÁõÆÊ®ôÔºõ‰∫å„ÄÅÂ≠∏ÁîüÁöÑÂàÜÊûêÔºõ‰∏â„ÄÅË™≤Á®ãÊû∂ÊßãÔºõÂõõ„ÄÅÁØÄÊ¨°ÂàÜÈÖçÔºõ‰∫î„ÄÅÊïôÂ≠∏ÊñπÊ≥ïËàáË©ïÈáèÔºõÂÖ≠„ÄÅÂèÉËÄÉË≥áÊ∫êÔºâ
   - ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´‰∫îÂàó

8. **ÊâìÂç∞Ê†∑ÂºèË¶ÅÊ±Ç**Ôºö
   - ‰ΩøÁî®@media printÂÆö‰πâÊâìÂç∞Ê†∑Âºè
   - È°µÈù¢Â§ßÂ∞èÔºöA4Ôºà@page { size: A4; }Ôºâ
   - È°µËæπË∑ùÔºö15mmÔºàmargin: 15mmÔºâ
   - ÈÅøÂÖçË°®Ê†ºÂíåÊ†áÈ¢òË∑®È°µÊñ≠ÂºÄÔºàpage-break-inside: avoidÔºâ

**‚ö†Ô∏è ÈáçË¶ÅÊèêÁ§∫**Ôºö
- ‰ªîÁªÜÂØπÊØîÂèÇËÄÉÂõæÁâá‰∏≠ÁöÑÊØè‰∏Ä‰∏™Ê†ºÂºèÁªÜËäÇ
- Á°Æ‰øùË°®Ê†ºËæπÊ°Ü„ÄÅÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè‰∏éPDFÂÆåÂÖ®‰∏ÄËá¥
- ÁîüÊàêÁöÑHTMLÂøÖÈ°ªÂèØ‰ª•Áõ¥Êé•Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄÂπ∂ÊâìÂç∞
- ÊâìÂç∞ÊïàÊûúÂøÖÈ°ª‰∏éPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥

ËØ∑Áõ¥Êé•ËæìÂá∫ÂÆåÊï¥ÁöÑHTML‰ª£Á†ÅÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïËß£ÈáäÊñáÂ≠ó„ÄÇÁ°Æ‰øùÁîüÊàêÁöÑHTMLÂú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄÂíåÊâìÂç∞Êó∂ÔºåÊ†ºÂºè‰∏éÂèÇËÄÉPDFÂÆåÂÖ®‰∏ÄËá¥„ÄÇ`;

                // Ë∞ÉÁî®QwenÂ§öÊ®°ÊÄÅAPI
                const messages = [
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: prompt
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: imageBase64
                                }
                            }
                        ]
                    }
                ];

                const response = await fetch(API_CONFIG.parser.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.parser.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.parser.model,
                        messages: messages,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    let errorMessage = `APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMessage += ` - ${errorData.error.message}`;
                        } else if (errorData.message) {
                            errorMessage += ` - ${errorData.message}`;
                        }
                    } catch (e) {}
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }

                let htmlContent = data.choices[0].message.content.trim();
                
                // Ê∏ÖÁêÜHTMLÂÜÖÂÆπ
                htmlContent = htmlContent.replace(/```html\n?/g, '').replace(/```\n?/g, '').trim();
                
                // Â¶ÇÊûúHTML‰∏çÂÆåÊï¥ÔºåÊ∑ªÂä†Âü∫Êú¨ÁªìÊûÑ
                if (!htmlContent.includes('<!DOCTYPE') && !htmlContent.includes('<html')) {
                    htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊïôÊ°à</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", "SimHei", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.8;
            margin: 20px 30px;
            color: #000;
            background: #fff;
            font-size: 14px;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #000;
        }
        h2 {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #000;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        h3 {
            font-size: 16px;
            font-weight: bold;
            margin: 12px 0 8px 0;
            color: #000;
        }
        p {
            margin: 8px 0;
            text-align: justify;
            line-height: 1.8;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            border: 1px solid #000;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        ul, ol {
            margin: 10px 0 10px 25px;
            line-height: 1.8;
        }
        li {
            margin: 5px 0;
        }
        .header-info {
            margin: 20px 0;
        }
        .header-info table {
            margin: 10px 0;
        }
        @media print {
            body {
                margin: 15mm;
            }
            @page {
                size: A4;
                margin: 15mm;
            }
            table {
                page-break-inside: avoid;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
${htmlContent}
</body>
</html>`;
                }

                showMessage('‚úÖ HTMLÁîüÊàêÊàêÂäüÔºÅÊ≠£Âú®ËΩ¨Êç¢‰∏∫PDF...', 'success', 3000);
                
                // Ê≠•È™§3ÔºöËá™Âä®ËΩ¨Êç¢‰∏∫PDFÂπ∂‰øùÂ≠ò
                await autoSavePDF(htmlContent, planName);
                
            } catch (error) {
                console.error('ÁîüÊàêHTMLÂ§±Ë¥•:', error);
                showMessage('‚ùå ÁîüÊàêHTMLÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // Êñ∞Â¢ûÔºöËá™Âä®‰øùÂ≠òPDFÂà∞Êú¨Âú∞
        async function autoSavePDF(htmlContent, planName) {
            try {
                // Ê£ÄÊü•html2pdfÊòØÂê¶ÂèØÁî®
                if (typeof html2pdf === 'undefined') {
                    throw new Error('PDFÁîüÊàêÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                }
                
                showMessage('üîÑ Ê≠•È™§3/3ÔºöÊ≠£Âú®ÁîüÊàêPDFÊñá‰ª∂...', 'info');
                
                // ÂàõÂª∫‰∏¥Êó∂ÂÆπÂô®
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = 'position: absolute; left: -9999px; top: 0;';
                tempDiv.innerHTML = htmlContent;
                document.body.appendChild(tempDiv);
                
                // ÈÖçÁΩÆhtml2pdfÈÄâÈ°π
                const opt = {
                    margin: [15, 15, 15, 15],
                    filename: `${planName}_${new Date().toISOString().slice(0,10)}_${Date.now()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                // ÁîüÊàêPDF Blob
                const pdfBlob = await html2pdf().set(opt).from(tempDiv).outputPdf('blob');
                
                // Ê∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                document.body.removeChild(tempDiv);
                
                // ‰ΩøÁî®File System Access APIËá™Âä®‰øùÂ≠ò
                await saveFileAutomatically(pdfBlob, opt.filename);
                
            } catch (error) {
                console.error('Ëá™Âä®‰øùÂ≠òPDFÂ§±Ë¥•:', error);
                showMessage('‚ùå Ëá™Âä®‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // Êñ∞Â¢ûÔºö‰ΩøÁî®File System Access APIËá™Âä®‰øùÂ≠òÊñá‰ª∂
        async function saveFileAutomatically(blob, suggestedFilename) {
            try {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òËøáÁõÆÂΩïÔºåÊàñËÄÖÁî®Êà∑ÊÉ≥ÈÄâÊã©Êñ∞ÁõÆÂΩï
                if (!window.savedDirectoryHandle) {
                    showMessage('üìÅ ËØ∑ÈÄâÊã©PDF‰øùÂ≠òÊñá‰ª∂Â§πÔºàÂè™ÈúÄÈÄâÊã©‰∏ÄÊ¨°ÔºåÂêéÁª≠Ëá™Âä®‰øùÂ≠òÂà∞ËØ•Êñá‰ª∂Â§πÔºâ', 'info', 5000);
                    
                    // ËÆ©Áî®Êà∑ÈÄâÊã©ÁõÆÂΩï
                    window.savedDirectoryHandle = await window.showDirectoryPicker({
                        mode: 'readwrite',
                        startIn: 'desktop'
                    });
                }
                
                // Ê£ÄÊü•ÊùÉÈôê
                const permission = await window.savedDirectoryHandle.queryPermission({ mode: 'readwrite' });
                if (permission !== 'granted') {
                    const requestPermission = await window.savedDirectoryHandle.requestPermission({ mode: 'readwrite' });
                    if (requestPermission !== 'granted') {
                        throw new Error('Êú™Ëé∑ÂæóÊñá‰ª∂Â§πÂÜôÂÖ•ÊùÉÈôê');
                    }
                }
                
                // ÂàõÂª∫Êñá‰ª∂
                const fileHandle = await window.savedDirectoryHandle.getFileHandle(suggestedFilename, { create: true });
                
                // ÂÜôÂÖ•Êñá‰ª∂
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                showMessage(`
                    <div style="text-align: left; line-height: 2;">
                        <strong style="font-size: 16px; color: #52c41a;">‚úÖ PDFÂ∑≤Ëá™Âä®‰øùÂ≠òÊàêÂäüÔºÅ</strong><br><br>
                        üìÅ <strong>‰øùÂ≠ò‰ΩçÁΩÆÔºö</strong>${window.savedDirectoryHandle.name}Êñá‰ª∂Â§π<br>
                        üìÑ <strong>Êñá‰ª∂ÂêçÔºö</strong>${suggestedFilename}<br><br>
                        üí° ‰∏ãÊ¨°ÂØºÂá∫Êó∂Â∞Ü<strong style="color: #52c41a;">Ëá™Âä®‰øùÂ≠òÂà∞Âêå‰∏ÄÊñá‰ª∂Â§π</strong>ÔºåÊó†ÈúÄÂÜçÊ¨°ÈÄâÊã©ÔºÅ<br>
                        üí° Â¶ÇÈúÄÊõ¥Êîπ‰øùÂ≠ò‰ΩçÁΩÆÔºåËØ∑<strong onclick="window.resetSaveDirectory()" style="cursor: pointer; color: #1890ff; text-decoration: underline;">ÁÇπÂáªËøôÈáåÈáçÁΩÆ</strong>
                    </div>
                `, 'success', 10000);
                
                console.log('‚úÖ PDFÂ∑≤Ëá™Âä®‰øùÂ≠òÂà∞:', window.savedDirectoryHandle.name, '/', suggestedFilename);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('‚ùå Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂Â§πÈÄâÊã©', 'warning');
                } else {
                    console.error('Ëá™Âä®‰øùÂ≠òÂ§±Ë¥•:', error);
                    showMessage('‚ùå Ëá™Âä®‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message + '\n\nÂ∞Ü‰ΩøÁî®‰º†Áªü‰∏ãËΩΩÊñπÂºè...', 'error');
                    
                    // ÈôçÁ∫ßÊñπÊ°àÔºö‰º†Áªü‰∏ãËΩΩ
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = suggestedFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showMessage('‚úÖ Â∑≤‰ΩøÁî®‰º†ÁªüÊñπÂºè‰∏ãËΩΩPDFÂà∞ÊµèËßàÂô®ÈªòËÆ§‰∏ãËΩΩÊñá‰ª∂Â§π', 'success', 5000);
                }
            }
        }
        
        // Êñ∞Â¢ûÔºöÈáçÁΩÆ‰øùÂ≠òÁõÆÂΩï
        window.resetSaveDirectory = function() {
            window.savedDirectoryHandle = null;
            showMessage('‚úÖ ‰øùÂ≠òÁõÆÂΩïÂ∑≤ÈáçÁΩÆÔºå‰∏ãÊ¨°ÂØºÂá∫Êó∂Â∞ÜÈáçÊñ∞ÈÄâÊã©Êñá‰ª∂Â§π', 'success');
            console.log('üîÑ ‰øùÂ≠òÁõÆÂΩïÂ∑≤ÈáçÁΩÆ');
        };
        
        // ÈôçÁ∫ßÊñπÊ°àÔºö‰º†ÁªüÊâìÂç∞ÊñπÂºèÔºàÁî®‰∫é‰∏çÊîØÊåÅFile System Access APIÁöÑÊµèËßàÂô®Ôºâ
        async function exportLocalStylePDF_Legacy(planType = 'optimized') {
            try {
                let lessonPlanText = null;
                let planName = '';
                
                if (planType === 'initial') {
                    lessonPlanText = window.initialTeachingPlan;
                    planName = 'ÂàùÊ≠•ÊïôÊ°à';
                } else {
                    lessonPlanText = window.finalTeachingPlanClean;
                    planName = '‰ºòÂåñÊïôÊ°à';
                }

                showMessage(`üîÑ ËØ∑ÈÄâÊã©ÂèÇËÄÉPDFÊñá‰ª∂ÔºàÁî®‰∫éÊ†ºÂºèÂèÇËÄÉÔºâ...`, 'info');
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) {
                        showMessage('‚ùå Êú™ÈÄâÊã©Êñá‰ª∂', 'error');
                        return;
                    }
                    
                    try {
                        const imageBase64 = await pdfToImage(file);
                        await generateLocalStyleHTML(lessonPlanText, imageBase64);
                    } catch (error) {
                        console.error('Â§ÑÁêÜPDFÊñá‰ª∂Â§±Ë¥•:', error);
                        showMessage('‚ùå Â§ÑÁêÜÂ§±Ë¥•Ôºö' + error.message, 'error');
                    }
                };
                input.click();
                
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showMessage('‚ùå ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }

        // ÁîüÊàêÊú¨Âú∞È£éÊ†ºHTML
        async function generateLocalStyleHTML(lessonPlanText, imageBase64) {
            try {
                showMessage('ü§ñ AIÊ≠£Âú®Ê†πÊçÆÂèÇËÄÉÊ†ºÂºèÁîüÊàêHTML...', 'info');
                
                // ÊûÑÂª∫ÊèêÁ§∫ËØç
                const prompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊïôÊ°àÊ†ºÂºèËΩ¨Êç¢‰∏ìÂÆ∂„ÄÇËØ∑Ê†πÊçÆ‰ª•‰∏ãÂÜÖÂÆπÔºö

1. „ÄêÂΩìÂâçÊïôÊ°àÂÜÖÂÆπ„ÄëÔºàtxtÊ†ºÂºèÔºâÔºö
${lessonPlanText}

2. „ÄêÂèÇËÄÉÊ†ºÂºèÂõæÁâá„ÄëÔºàPDFÁ¨¨‰∏ÄÈ°µÁöÑÊà™ÂõæÔºâÔºö
ËøôÊòØ‰∏Ä‰ªΩÊæ≥Èó®Âú∞Âå∫Ê†áÂáÜÊïôÊ°àÁöÑÂèÇËÄÉÊ†ºÂºèÂõæÁâáÔºåËØ∑‰ªîÁªÜÂàÜÊûêÂÖ∂Ê†ºÂºèÂíåÊ†∑ÂºèÔºåÂåÖÊã¨Ôºö

**Ë°®Ê†ºÁªìÊûÑË¶ÅÊ±Ç**Ôºö
- Ë°®Ê†ºËæπÊ°ÜÊ†∑ÂºèÔºàÂÆûÁ∫ø„ÄÅÁ≤óÁªÜ„ÄÅÈ¢úËâ≤Ôºâ
- ÂçïÂÖÉÊ†ºÂØπÈΩêÊñπÂºèÔºàÂ∑¶ÂØπÈΩê„ÄÅÂ±Ö‰∏≠„ÄÅÂè≥ÂØπÈΩêÔºâ
- ÂçïÂÖÉÊ†ºÂêàÂπ∂Ôºàcolspan„ÄÅrowspanÔºâ
- Ë°®Â§¥Ê†∑ÂºèÔºàËÉåÊôØËâ≤„ÄÅÂ≠ó‰ΩìÂä†Á≤ó„ÄÅÂ±Ö‰∏≠Á≠âÔºâ
- Ë°®Ê†ºÂÆΩÂ∫¶ÂíåÂàóÂÆΩÊØî‰æã
- ÂçïÂÖÉÊ†ºÂÜÖËæπË∑ùÔºàpaddingÔºâ

**Ê†áÈ¢òÂ±ÇÁ∫ßË¶ÅÊ±Ç**Ôºö
- ‰∏ÄÁ∫ßÊ†áÈ¢òÔºàËØæÈ¢òÂêçÁß∞ÔºâÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤ó„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè
- ‰∫åÁ∫ßÊ†áÈ¢òÔºàÂêÑÁ´†ËäÇÊ†áÈ¢òÔºâÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤ó„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè
- ‰∏âÁ∫ßÊ†áÈ¢òÔºàÂ≠êÁ´†ËäÇÔºâÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤ó„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè
- Ê†áÈ¢òÂâçÂêéÁöÑÈó¥Ë∑ù

**ÊÆµËêΩÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
- ÊÆµËêΩÁº©ËøõÔºàÈ¶ñË°åÁº©Ëøõ„ÄÅÊï¥‰ΩìÁº©ËøõÔºâ
- Ë°åË∑ùÔºàline-heightÔºâ
- ÊÆµËêΩÈó¥Ë∑ùÔºàmarginÔºâ
- ÂØπÈΩêÊñπÂºèÔºàÂ∑¶ÂØπÈΩê„ÄÅ‰∏§Á´ØÂØπÈΩêÔºâ
- Â≠ó‰ΩìÂ§ßÂ∞èÂíåÈ¢úËâ≤

**Êï¥‰ΩìÂ∏ÉÂ±ÄË¶ÅÊ±Ç**Ôºö
- È°µËæπË∑ùÔºà‰∏ä‰∏ãÂ∑¶Âè≥Ôºâ
- È°µÈù¢ÂÆΩÂ∫¶ÂíåÊúÄÂ§ßÂÆΩÂ∫¶
- ÂàÜÊ†èÂ∏ÉÂ±ÄÔºàÂ¶ÇÊûúÊúâÔºâ
- ËÉåÊôØËâ≤ÂíåÊñáÂ≠óÈ¢úËâ≤
- ÊâìÂç∞Êó∂ÁöÑÈ°µÈù¢ËÆæÁΩÆ

**ÁâπÊÆäÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
- ÂàóË°®Ê†∑ÂºèÔºàÊúâÂ∫èÂàóË°®„ÄÅÊó†Â∫èÂàóË°®Ôºâ
- Âº∫Ë∞ÉÊñáÊú¨ÔºàÂä†Á≤ó„ÄÅÊñú‰Ωì„ÄÅ‰∏ãÂàíÁ∫øÔºâ
- ÁºñÂè∑Ê†ºÂºèÔºàÂ¶ÇÔºö‰∏Ä„ÄÅ‰∫å„ÄÅ‰∏â Êàñ 1„ÄÅ2„ÄÅ3Ôºâ
- Ë°®Ê†º‰∏≠ÁöÑÁõÆÊ†á‰ª£Âè∑Ê†ºÂºè
- Êó∂Èó¥„ÄÅÊïôÂ≠¶ËµÑÊ∫ê„ÄÅËØÑÈáèÁ≠âÂàóÁöÑÊ†ºÂºè

ËØ∑Ê†πÊçÆÂèÇËÄÉÂõæÁâáÁöÑÊ†ºÂºèÂíåÊ†∑ÂºèÔºåÂ∞ÜÂΩìÂâçÊïôÊ°àÂÜÖÂÆπËΩ¨Êç¢‰∏∫ÂØπÂ∫îÁöÑHTMLÊ†ºÂºè„ÄÇ

**‚ö†Ô∏è ‰∏•Ê†ºË¶ÅÊ±ÇÔºöÁîüÊàêÁöÑHTMLÊ†ºÂºèÂøÖÈ°ª‰∏éÂèÇËÄÉPDFÂõæÁâáÁöÑÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥ÔºåÂåÖÊã¨ÊØè‰∏Ä‰∏™ÁªÜËäÇÔºÅ**

**Ê†ºÂºèË¶ÅÊ±ÇËØ¶ÁªÜËØ¥Êòé**Ôºö

1. **HTMLÊ†ºÂºèÂøÖÈ°ª‰∏éÂèÇËÄÉÂõæÁâáÁöÑÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥**ÔºåÂåÖÊã¨Ôºö
   - **Ë°®Ê†ºÁªìÊûÑ**ÔºöË°®Ê†ºËæπÊ°ÜÊ†∑Âºè„ÄÅÂçïÂÖÉÊ†ºÂêàÂπ∂„ÄÅÂàóÂÆΩÊØî‰æãÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **Ë°®Ê†ºÂØπÈΩê**ÔºöË°®Â§¥Â±Ö‰∏≠„ÄÅÂÜÖÂÆπÂ∑¶ÂØπÈΩê/Â±Ö‰∏≠/Âè≥ÂØπÈΩêÂøÖÈ°ª‰∏éPDF‰∏ÄËá¥
   - **Ê†áÈ¢òÂ±ÇÁ∫ß**ÔºöÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÂä†Á≤óÁ®ãÂ∫¶„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºèÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **ÊÆµËêΩÊ†ºÂºè**ÔºöÁº©Ëøõ„ÄÅË°åË∑ù„ÄÅÊÆµËêΩÈó¥Ë∑ùÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **Êï¥‰ΩìÂ∏ÉÂ±Ä**ÔºöÈ°µËæπË∑ù„ÄÅÈ°µÈù¢ÂÆΩÂ∫¶„ÄÅÂàÜÊ†èÂ∏ÉÂ±ÄÂøÖÈ°ª‰∏ÄÊ®°‰∏ÄÊ†∑
   - **Â≠ó‰ΩìÊ†∑Âºè**ÔºöÂ≠ó‰ΩìÁ±ªÂûã„ÄÅÂ§ßÂ∞è„ÄÅÈ¢úËâ≤ÂøÖÈ°ª‰∏éPDFÂÆåÂÖ®‰∏ÄËá¥

2. **‰ΩøÁî®Á≤æÁ°ÆÁöÑCSSÊ†∑Âºè**ÔºàÂøÖÈ°ªÂåÖÂê´Âú®<style>Ê†áÁ≠æ‰∏≠ÔºâÔºö
   - ‰ΩøÁî®ÂÆåÊï¥ÁöÑCSSÊ†∑ÂºèÂÆö‰πâÔºå‰∏çË¶Å‰ΩøÁî®ÂÜÖËÅîÊ†∑ÂºèÔºàÈô§ÈùûÂøÖË¶ÅÔºâ
   - Á°Æ‰øùÊâìÂç∞Êó∂Ê†ºÂºèÁæéËßÇÔºà‰ΩøÁî®@media printÂÆö‰πâÊâìÂç∞Ê†∑ÂºèÔºâ
   - Â≠ó‰ΩìÔºö‰ºòÂÖà‰ΩøÁî®"Microsoft YaHei"„ÄÅ"SimHei"„ÄÅ"Microsoft JhengHei"Á≠â‰∏≠ÊñáÂ≠ó‰Ωì
   - È¢úËâ≤Ôºö‰ΩøÁî®ÂçÅÂÖ≠ËøõÂà∂ÂÄºÔºàÂ¶Ç#000000„ÄÅ#333333ÔºâÔºåÁ°Æ‰øù‰∏éPDF‰∏ÄËá¥
   - ÊâÄÊúâÊ†∑ÂºèÂøÖÈ°ªÊòéÁ°ÆÂÆö‰πâÔºå‰∏çË¶Å‰æùËµñÊµèËßàÂô®ÈªòËÆ§Ê†∑Âºè

3. **Ë°®Ê†ºÊ†ºÂºèË¶ÅÊ±ÇÔºàÊïôÂ≠¶ÊµÅÁ®ãË°®Ê†ºÔºâ**Ôºö
   - **ÂøÖÈ°ªÂåÖÂê´‰∫îÂàó**ÔºöÁõÆÊ®ô‰ª£Ëôü„ÄÅÊ¥ªÂãïÊµÅÁ®ã„ÄÅÊôÇÈñì„ÄÅÊïôÂ≠∏Ë≥áÊ∫ê„ÄÅË©ïÈáè
   - **Ë°®Ê†ºËæπÊ°Ü**Ôºö1pxÂÆûÁ∫øÈªëËâ≤Ôºàborder: 1px solid #000Ôºâ
   - **ËæπÊ°ÜÂêàÂπ∂**Ôºöborder-collapse: collapse
   - **Ë°®Â§¥Ê†∑Âºè**ÔºöËÉåÊôØËâ≤#f0f0f0ÔºåÂ≠ó‰ΩìÂä†Á≤óÔºåÊñáÂ≠óÂ±Ö‰∏≠
   - **ÂçïÂÖÉÊ†ºÂØπÈΩê**Ôºö
     * ÁõÆÊ®ô‰ª£ËôüÂàóÔºöÂ±Ö‰∏≠ÊàñÂ∑¶ÂØπÈΩê
     * Ê¥ªÂãïÊµÅÁ®ãÂàóÔºöÂ∑¶ÂØπÈΩê
     * ÊôÇÈñìÂàóÔºöÂ±Ö‰∏≠
     * ÊïôÂ≠∏Ë≥áÊ∫êÂàóÔºöÂ∑¶ÂØπÈΩê
     * Ë©ïÈáèÂàóÔºöÂ∑¶ÂØπÈΩê
   - **ÂçïÂÖÉÊ†ºÂÜÖËæπË∑ù**Ôºö8-10pxÔºàpadding: 8px 10pxÔºâ
   - **Ë°®Ê†ºÂÆΩÂ∫¶**Ôºö100%Ôºàwidth: 100%Ôºâ

4. **Ê†áÈ¢òÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
   - **‰∏ÄÁ∫ßÊ†áÈ¢òÔºàËØæÈ¢òÂêçÁß∞Ôºâ**Ôºö24pxÔºåÂä†Á≤óÔºåÂ±Ö‰∏≠Ôºå‰∏ä‰∏ãËæπË∑ù20px
   - **‰∫åÁ∫ßÊ†áÈ¢òÔºàÁ´†ËäÇÊ†áÈ¢òÔºâ**Ôºö18pxÔºåÂä†Á≤óÔºåÂ∑¶ÂØπÈΩêÔºåÂ∫ïÈÉ®ËæπÊ°Ü2pxÂÆûÁ∫øÔºå‰∏ä‰∏ãËæπË∑ù15px/10px
   - **‰∏âÁ∫ßÊ†áÈ¢òÔºàÂ≠êÁ´†ËäÇÔºâ**Ôºö16pxÔºåÂä†Á≤óÔºåÂ∑¶ÂØπÈΩêÔºå‰∏ä‰∏ãËæπË∑ù12px/8px

5. **ÊÆµËêΩÊ†ºÂºèË¶ÅÊ±Ç**Ôºö
   - Â≠ó‰ΩìÂ§ßÂ∞èÔºö14px
   - Ë°åË∑ùÔºö1.8ÂÄçÔºàline-height: 1.8Ôºâ
   - ÊÆµËêΩÈó¥Ë∑ùÔºö8pxÔºàmargin: 8px 0Ôºâ
   - ÊñáÊú¨ÂØπÈΩêÔºö‰∏§Á´ØÂØπÈΩêÔºàtext-align: justifyÔºâ

6. **ËæìÂá∫ÂÆåÊï¥ÁöÑHTMLÊñáÊ°£**Ôºö
   - ÂåÖÂê´<!DOCTYPE html>Â£∞Êòé
   - ÂåÖÂê´<html lang="zh-TW">Ê†áÁ≠æ
   - ÂåÖÂê´ÂÆåÊï¥ÁöÑ<head>Ê†áÁ≠æÔºö
     * <meta charset="UTF-8">
     * <meta name="viewport" content="width=device-width, initial-scale=1.0">
     * <title>ÊïôÊ°à</title>
     * <style>...</style>ÔºàÂåÖÂê´ÊâÄÊúâCSSÊ†∑ÂºèÔºâ
   - ÂåÖÂê´ÂÆåÊï¥ÁöÑ<body>Ê†áÁ≠æ
   - Á°Æ‰øùHTMLÁªìÊûÑÂÆåÊï¥„ÄÅËØ≠Ê≥ïÊ≠£Á°ÆÔºåÂèØ‰ª•Áõ¥Êé•Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄ

7. **Êæ≥Èó®Âú∞Âå∫ÊïôÊ°àÁâπÊÆäË¶ÅÊ±Ç**Ôºö
   - ‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÔºàlang="zh-TW"Ôºâ
   - Ë°®È†≠‰ø°ÊÅØÂçÄÂüü‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºà‰∏§ÂàóË°®Ê†ºÔºöÈ†ÖÁõÆ„ÄÅÂÖßÂÆπÔºâ
   - ÊïôÂ≠∏Á†îÁ©∂ÈÉ®ÂàÜÂåÖÂê´ÊâÄÊúâÂ≠êÊ¨ÑÁõÆÔºà‰∏Ä„ÄÅË®≠Ë®àÁêÜÂøµËàáÁõÆÊ®ôÔºõ‰∫å„ÄÅÂ≠∏ÁîüÁöÑÂàÜÊûêÔºõ‰∏â„ÄÅË™≤Á®ãÊû∂ÊßãÔºõÂõõ„ÄÅÁØÄÊ¨°ÂàÜÈÖçÔºõ‰∫î„ÄÅÊïôÂ≠∏ÊñπÊ≥ïËàáË©ïÈáèÔºõÂÖ≠„ÄÅÂèÉËÄÉË≥áÊ∫êÔºâ
   - ÊïôÂ≠∏ÊµÅÁ®ãÂøÖÈ†à‰ΩøÁî®Ë°®Ê†ºÂΩ¢ÂºèÔºåÂåÖÂê´‰∫îÂàó

8. **ÊâìÂç∞Ê†∑ÂºèË¶ÅÊ±Ç**Ôºö
   - ‰ΩøÁî®@media printÂÆö‰πâÊâìÂç∞Ê†∑Âºè
   - È°µÈù¢Â§ßÂ∞èÔºöA4Ôºà@page { size: A4; }Ôºâ
   - È°µËæπË∑ùÔºö15mmÔºàmargin: 15mmÔºâ
   - ÈÅøÂÖçË°®Ê†ºÂíåÊ†áÈ¢òË∑®È°µÊñ≠ÂºÄÔºàpage-break-inside: avoidÔºâ

**‚ö†Ô∏è ÈáçË¶ÅÊèêÁ§∫**Ôºö
- ‰ªîÁªÜÂØπÊØîÂèÇËÄÉÂõæÁâá‰∏≠ÁöÑÊØè‰∏Ä‰∏™Ê†ºÂºèÁªÜËäÇ
- Á°Æ‰øùË°®Ê†ºËæπÊ°Ü„ÄÅÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÅÈ¢úËâ≤„ÄÅÂØπÈΩêÊñπÂºè‰∏éPDFÂÆåÂÖ®‰∏ÄËá¥
- ÁîüÊàêÁöÑHTMLÂøÖÈ°ªÂèØ‰ª•Áõ¥Êé•Âú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄÂπ∂ÊâìÂç∞
- ÊâìÂç∞ÊïàÊûúÂøÖÈ°ª‰∏éPDFÊ†ºÂºèÂÆåÂÖ®‰∏ÄËá¥

ËØ∑Áõ¥Êé•ËæìÂá∫ÂÆåÊï¥ÁöÑHTML‰ª£Á†ÅÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïËß£ÈáäÊñáÂ≠ó„ÄÇÁ°Æ‰øùÁîüÊàêÁöÑHTMLÂú®ÊµèËßàÂô®‰∏≠ÊâìÂºÄÂíåÊâìÂç∞Êó∂ÔºåÊ†ºÂºè‰∏éÂèÇËÄÉPDFÂÆåÂÖ®‰∏ÄËá¥„ÄÇ`;

                // Ë∞ÉÁî®QwenÂ§öÊ®°ÊÄÅAPIÔºà‰ΩøÁî®ÂõæÁâáÊ†ºÂºèÔºåËÄå‰∏çÊòØPDFÔºâ
                const messages = [
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: prompt
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: imageBase64  // Â∑≤ÁªèÊòØdata:image/png;base64Ê†ºÂºè
                                }
                            }
                        ]
                    }
                ];

                const response = await fetch(API_CONFIG.parser.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.parser.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.parser.model,
                        messages: messages,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    // Â∞ùËØïËé∑ÂèñËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                    let errorMessage = `APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMessage += ` - ${errorData.error.message}`;
                        } else if (errorData.message) {
                            errorMessage += ` - ${errorData.message}`;
                        }
                    } catch (e) {
                        // Â¶ÇÊûúÊó†Ê≥ïËß£ÊûêÈîôËØØÂìçÂ∫îÔºå‰ΩøÁî®ÈªòËÆ§ÈîôËØØ‰ø°ÊÅØ
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('APIÂìçÂ∫îÊ†ºÂºèÈîôËØØ');
                }

                let htmlContent = data.choices[0].message.content.trim();
                
                // Ê∏ÖÁêÜHTMLÂÜÖÂÆπÔºàÁßªÈô§markdown‰ª£Á†ÅÂùóÊ†áËÆ∞Ôºâ
                htmlContent = htmlContent.replace(/```html\n?/g, '').replace(/```\n?/g, '').trim();
                
                // Â¶ÇÊûúHTML‰∏çÂÆåÊï¥ÔºåÊ∑ªÂä†Âü∫Êú¨ÁªìÊûÑÔºàÊæ≥Èó®Âú∞Âå∫ÊïôÊ°àÊ†áÂáÜÊ†∑ÂºèÔºâ
                if (!htmlContent.includes('<!DOCTYPE') && !htmlContent.includes('<html')) {
                    htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊïôÊ°à</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", "SimHei", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.8;
            margin: 20px 30px;
            color: #000;
            background: #fff;
            font-size: 14px;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #000;
        }
        h2 {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #000;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        h3 {
            font-size: 16px;
            font-weight: bold;
            margin: 12px 0 8px 0;
            color: #000;
        }
        p {
            margin: 8px 0;
            text-align: justify;
            line-height: 1.8;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            border: 1px solid #000;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        ul, ol {
            margin: 10px 0 10px 25px;
            line-height: 1.8;
        }
        li {
            margin: 5px 0;
        }
        .header-info {
            margin: 20px 0;
        }
        .header-info table {
            margin: 10px 0;
        }
        @media print {
            body {
                margin: 15mm;
            }
            @page {
                size: A4;
                margin: 15mm;
            }
            table {
                page-break-inside: avoid;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
${htmlContent}
</body>
</html>`;
                }

                // ÊòæÁ§∫HTMLÈ¢ÑËßàÔºàÂÖ®Â±èÊ®°ÊÄÅÁ™óÂè£Ôºâ
                showLocalStyleHTMLPreview(htmlContent);
                
                showMessage('‚úÖ HTMLÁîüÊàêÊàêÂäüÔºÅÂèØ‰ª•Âú®È¢ÑËßàÁ™óÂè£‰∏≠Êü•ÁúãÂíåÊâìÂç∞', 'success');
                
            } catch (error) {
                console.error('ÁîüÊàêHTMLÂ§±Ë¥•:', error);
                showMessage('‚ùå ÁîüÊàêHTMLÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }

        // ÊòæÁ§∫Êú¨Âú∞È£éÊ†ºHTMLÈ¢ÑËßàÔºàÂÖ®Â±èÊ®°ÊÄÅÁ™óÂè£Ôºâ
        function showLocalStyleHTMLPreview(htmlContent) {
            // ÂàõÂª∫È¢ÑËßàÁ™óÂè£
            const previewDiv = document.createElement('div');
            previewDiv.id = 'localStylePreview';
            previewDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                display: flex;
                flex-direction: column;
            `;
            
            // Â∑•ÂÖ∑Ê†è
            const toolbar = document.createElement('div');
            toolbar.style.cssText = `
                background: #1a1a2e;
                padding: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 2px solid #667eea;
            `;
            
            // Êìç‰ΩúÊèêÁ§∫Âå∫Âüü
            const instructionDiv = document.createElement('div');
            instructionDiv.style.cssText = `
                flex: 1;
                color: white;
                padding: 0 20px;
                font-size: 14px;
                line-height: 1.6;
            `;
            instructionDiv.innerHTML = `
                <div style="background: rgba(24, 144, 255, 0.2); padding: 10px 15px; border-radius: 8px; border-left: 4px solid #1890ff;">
                    <strong style="color: #1890ff;">üìÑ Êìç‰ΩúÊåáÂºïÔºö</strong>
                    <span style="color: rgba(255,255,255,0.9);">
                        Âç≥Â∞ÜËá™Âä®ÂºπÂá∫ÊâìÂç∞ÂØπËØùÊ°Ü ‚Üí 
                        <strong style="color: #52c41a;">ÊâìÂç∞Êú∫ÈÄâÊã©"Âè¶Â≠ò‰∏∫PDF"</strong> ‚Üí 
                        ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆ ‚Üí ÁÇπÂáª‰øùÂ≠ò
                    </span>
                </div>
            `;
            
            const langPack = getCurrentLanguagePack();
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn';
            closeBtn.innerHTML = '<i class="fas fa-times"></i> ' + (langPack['ÂÖ≥Èó≠'] || 'ÂÖ≥Èó≠');
            closeBtn.onclick = () => {
                if (previewDiv && previewDiv.parentNode) {
                    previewDiv.parentNode.removeChild(previewDiv);
                }
            };
            
            const printBtn = document.createElement('button');
            printBtn.className = 'btn';
            printBtn.style.background = 'linear-gradient(135deg, #52c41a, #73d13d)';
            printBtn.innerHTML = '<i class="fas fa-print"></i> ÊâìÂç∞/Âè¶Â≠ò‰∏∫PDF';
            printBtn.onclick = () => {
                triggerPrintDialog(htmlContent);
            };
            
            toolbar.appendChild(instructionDiv);
            toolbar.appendChild(printBtn);
            toolbar.appendChild(closeBtn);
            
            // È¢ÑËßàiframe
            const iframe = document.createElement('iframe');
            iframe.style.cssText = `
                flex: 1;
                border: none;
                background: white;
            `;
            
            previewDiv.appendChild(toolbar);
            previewDiv.appendChild(iframe);
            document.body.appendChild(previewDiv);
            
            // ÂÜôÂÖ•HTMLÂÜÖÂÆπ
            iframe.contentDocument.open();
            iframe.contentDocument.write(htmlContent);
            iframe.contentDocument.close();
            
            // Ëá™Âä®Ëß¶ÂèëÊâìÂç∞ÂØπËØùÊ°Ü
            setTimeout(() => {
                triggerPrintDialog(htmlContent);
            }, 1500);
        }
        
        // Ëß¶ÂèëÊâìÂç∞ÂØπËØùÊ°ÜÁöÑËæÖÂä©ÂáΩÊï∞
        function triggerPrintDialog(htmlContent) {
            try {
                // ÊòæÁ§∫Êìç‰ΩúÊåáÂºï
                showMessage(`
                    <div style="text-align: left; line-height: 2;">
                        <strong style="font-size: 16px; color: #52c41a;">üìÑ ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ≠•È™§Êìç‰ΩúÔºö</strong><br><br>
                        <strong>1Ô∏è‚É£ Âú®ÊâìÂç∞ÂØπËØùÊ°Ü‰∏≠ÔºåÈÄâÊã©ÊâìÂç∞Êú∫‰∏∫"Âè¶Â≠ò‰∏∫PDF"</strong><br>
                        <strong>2Ô∏è‚É£ ÁÇπÂáª"ÊâìÂç∞"Êàñ"‰øùÂ≠ò"ÊåâÈíÆ</strong><br>
                        <strong>3Ô∏è‚É£ ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆÔºàÂª∫ËÆÆ‰øùÂ≠òÂà∞Ê°åÈù¢Êàñ‰∏ìÁî®Êñá‰ª∂Â§πÔºâ</strong><br>
                        <strong>4Ô∏è‚É£ Á°ÆËÆ§Êñá‰ª∂ÂêçÂêéÁÇπÂáª"‰øùÂ≠ò"</strong><br><br>
                        <span style="color: #faad14;">üí° ÊèêÁ§∫ÔºöÊØèÊ¨°‰ºòÂåñÊïôÊ°àÂêéÔºåÈáçÂ§çÊ≠§Êìç‰ΩúÂç≥ÂèØ‰øùÂ≠òÊñ∞ÁâàÊú¨</span>
                    </div>
                `, 'info', 8000);
                
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (printWindow) {
                    printWindow.document.write(htmlContent);
                    printWindow.document.close();
                    
                    // Á≠âÂæÖÂÜÖÂÆπÂä†ËΩΩÂÆåÊØïÂêéËß¶ÂèëÊâìÂç∞
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                        
                        // ÁõëÂê¨ÊâìÂç∞ÂØπËØùÊ°ÜÂÖ≥Èó≠‰∫ã‰ª∂
                        const checkClosed = setInterval(() => {
                            if (printWindow.closed) {
                                clearInterval(checkClosed);
                                console.log('‚úÖ ÊâìÂç∞ÂØπËØùÊ°ÜÂ∑≤ÂÖ≥Èó≠');
                            }
                        }, 500);
                    }, 800);
                } else {
                    showMessage('‚ùå Êó†Ê≥ïÊâìÂºÄÊâìÂç∞Á™óÂè£ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÂºπÁ™óËÆæÁΩÆ', 'error');
                }
            } catch (error) {
                console.error('ÊâìÂç∞Â§±Ë¥•:', error);
                showMessage('‚ùå ÊâìÂç∞Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }

    </script>

    <!-- Á≥ªÁªü‰ªãÁªçÂå∫Âüü -->
    <div class="system-introduction" style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 40px; margin: 40px 0; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
        <h2 style="color: white; font-size: 2.2rem; margin-bottom: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
            <i class="fas fa-star" style="color: #ffd700; margin-right: 15px;"></i>
            EduSymphonyÊïôÊ°àÊïôÁ†îÁ≥ªÁªü
        </h2>

        <div class="introduction-content" style="max-width: 1000px; margin: 0 auto; text-align: left;">
            <div class="feature-section">
                <h3 style="color: #1890ff; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-file-alt" style="margin-right: 10px;"></i>
                    Êô∫ËÉΩÊñá‰ª∂Â§ÑÁêÜ
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>‚úÖ <strong>Â§öÊ†ºÂºèÊîØÊåÅ</strong>ÔºöTXT„ÄÅDOC„ÄÅDOCX„ÄÅRTF„ÄÅPDF„ÄÅPPT„ÄÅPPTX„ÄÅPNG„ÄÅJPG„ÄÅJPEG„ÄÅGIF„ÄÅBMP</li>
                    <li>‚úÖ <strong>Êô∫ËÉΩÁºñÁ†ÅÊ£ÄÊµã</strong>ÔºöËá™Âä®Â§ÑÁêÜ‰∏≠Êñá‰π±Á†ÅÈóÆÈ¢ò</li>
                    <li>‚úÖ <strong>OCRËØÜÂà´</strong>Ôºö‰ΩøÁî®Tesseract.jsËØÜÂà´ÂõæÁâá‰∏≠ÁöÑÊñáÂ≠ó</li>
                    <li>‚úÖ <strong>ÊñáÊ°£Ëß£Êûê</strong>Ôºö‰ΩøÁî®mammoth.jsÂíåpdf.jsÊèêÂèñÊñáÊ°£ÂÜÖÂÆπ</li>
                </ul>
            </div>

            <div class="feature-section">
                <h3 style="color: #52c41a; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-robot" style="margin-right: 10px;"></i>
                    Â§öÊ®°ÊÄÅAIËß£Êûê
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>‚úÖ <strong>QwenÂ§öÊ®°ÊÄÅ</strong>ÔºöËß£ÊûêÂõæÁâáÂíåÂ§çÊùÇÊñáÊ°£</li>
                    <li>‚úÖ <strong>ÊñáÊú¨ÂàÜÊûê</strong>ÔºöÊèêÂèñÊïôÊ°àÁªìÊûÑÂåñ‰ø°ÊÅØ</li>
                    <li>‚úÖ <strong>Êô∫ËÉΩÈôçÁ∫ß</strong>ÔºöÊñáÊú¨ÊèêÂèñÂ§±Ë¥•Êó∂Ëá™Âä®ËΩ¨‰∏∫OCRÊàñÂ§öÊ®°ÊÄÅÂ§ÑÁêÜ</li>
                </ul>
            </div>

            <div class="feature-section">
                <h3 style="color: #fa8c16; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-users" style="margin-right: 10px;"></i>
                    5‰ΩçAI‰∏ìÂÆ∂Âçè‰Ωú
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>ü§ñ <strong>ÈÄö‰πâÂçÉÈóÆ</strong>ÔºöÊïôÊ°à‰ºòÂåñ‰∏ìÂÆ∂</li>
                    <li>üß† <strong>Ë±ÜÂåÖ</strong>ÔºöÂàõÊñ∞ÊïôÂ≠¶‰∏ìÂÆ∂</li>
                    <li>üéØ <strong>Kimi</strong>ÔºöÂ≠¶ÁîüÂèÇ‰∏é‰∏ìÂÆ∂</li>
                    <li>üß¨ <strong>Êô∫Ë∞±Ê∏ÖË®Ä</strong>ÔºöËÆ§Áü•ÂèëÂ±ï‰∏ìÂÆ∂</li>
                    <li>üßÆ <strong>DeepSeek</strong>ÔºöÊ∑±Â∫¶Â≠¶‰π†‰∏ìÂÆ∂</li>
                </ul>
            </div>

            <div class="feature-section">
                <h3 style="color: #722ed1; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-microphone" style="margin-right: 10px;"></i>
                    ‰∏ªÊåÅ‰∫∫Êô∫ËÉΩÁÆ°ÁêÜ
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>‚úÖ <strong>ÊïôÁ†î‰∏ªÊåÅ‰∫∫</strong>Ôºö‰ΩøÁî®QwenÊ®°ÂûãÂçèË∞ÉËÆ®ËÆ∫</li>
                    <li>‚úÖ <strong>Ë¥®ÈáèÁõëÊéß</strong>ÔºöÂÆûÊó∂ËØÑ‰º∞‰∏ìÂÆ∂Âª∫ËÆÆË¥®Èáè</li>
                    <li>‚úÖ <strong>Êô∫ËÉΩÂπ≤È¢Ñ</strong>ÔºöÂØπÁêÜËÆ∫ÂåñÂª∫ËÆÆËøõË°å"pua"ÂºèÊåáÂØº</li>
                    <li>‚úÖ <strong>Ê∞ë‰∏ªÂÜ≥Á≠ñ</strong>ÔºöÂ§öËΩÆÊäïÁ•®Êú∫Âà∂</li>
                </ul>
            </div>

            <div class="feature-section">
                <h3 style="color: #eb2f96; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-user-check" style="margin-right: 10px;"></i>
                    ÊïôÊùêÊ£ÄÊü•ÁªÑÈïøÔºàÊñ∞Â¢ûÔºâ
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>ü§ñ <strong>Qwen AIÈ©±Âä®</strong>Ôºö‰ΩøÁî®ÈòøÈáåÈÄö‰πâÂçÉÈóÆQwenÊ®°ÂûãÂàÜÊûêÊïôÊùê</li>
                    <li>‚úÇÔ∏è <strong>Êô∫ËÉΩÂàáÂâ≤</strong>ÔºöËá™Âä®ËØÜÂà´Âπ∂ÂàáÂâ≤ÊïôÊùê‰∏≠ÁöÑÁã¨Á´ãÁü•ËØÜÁÇπ</li>
                    <li>üìÑ <strong>Áã¨Á´ãHTMLÈ°µÈù¢</strong>ÔºöÊØè‰∏™Áü•ËØÜÁÇπÁîüÊàêÁ≤æÁæéÁöÑ‰∫§‰∫íÂºèHTML</li>
                    <li>üé® <strong>ÁæéËßÇËÆæËÆ°</strong>ÔºöÁé∞‰ª£ÂåñUIÔºåÊ∏êÂèòËÉåÊôØÔºåÊµÅÁïÖÂä®Áîª</li>
                    <li>‚å®Ô∏è <strong>ÁøªÈ°µÊµèËßàÂô®</strong>ÔºöÂ∑¶Âè≥ÁÆ≠Â§¥ÈîÆÂø´ÈÄüÂàáÊç¢Áü•ËØÜÁÇπ</li>
                    <li>üìä <strong>ËøõÂ∫¶ËøΩË∏™</strong>ÔºöÂÆûÊó∂ÊòæÁ§∫Â≠¶‰π†ËøõÂ∫¶Êù°</li>
                    <li>üìë <strong>‰æßËæπÊ†èÁõÆÂΩï</strong>ÔºöÂø´ÈÄüÂÆö‰Ωç‰ªªÊÑèÁü•ËØÜÁÇπ</li>
                    <li>üíæ <strong>ÊâπÈáè‰∏ãËΩΩ</strong>Ôºö‰∏ÄÈîÆ‰∏ãËΩΩÊâÄÊúâÁü•ËØÜÁÇπHTML</li>
                </ul>
            </div>

            <div class="feature-section">
                <h3 style="color: #13c2c2; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-balance-scale" style="margin-right: 10px;"></i>
                    ÂàõÊñ∞ÊäïÁ•®ÂÜ≥Á≠ñÁ≥ªÁªü
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>üó≥Ô∏è <strong>ËßÇÁÇπÊäïÁ•®</strong>Ôºö‰∏ìÂÆ∂ÂØπÊØè‰∏™ËßÇÁÇπËøõË°åÊäïÁ•®ÔºàÂêåÊÑè/ÂèçÂØπÔºâ</li>
                    <li>üìà <strong>Á•®Êï∞Á≠õÈÄâ</strong>ÔºöË∂ÖËøáÂçäÊï∞ÁöÑËßÇÁÇπË¢´ÈááÁ∫≥</li>
                    <li>üîÑ <strong>Â§öËΩÆËÆ®ËÆ∫</strong>ÔºöÊú™ÈÄöËøáÊó∂‰øùÁïô‰ºòÁßÄËßÇÁÇπÈáçÊñ∞ËÆ®ËÆ∫</li>
                    <li>‚úÖ <strong>ÊúÄÁªàÊäïÁ•®</strong>Ôºö80%ÂêåÊÑèÁéáÁ°Æ‰øùÈõÜ‰ΩìÂÖ±ËØÜ</li>
                </ul>
            </div>
            
            <div class="feature-section">
                <h3 style="color: #fa8c16; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-database" style="margin-right: 10px;"></i>
                    Êô∫ËÉΩÊñá‰ª∂ÁÆ°ÁêÜÁ≥ªÁªüÔºàÂ¢ûÂº∫Ôºâ
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>üíæ <strong>ÂÆûÊó∂‰øùÂ≠ò</strong>ÔºöÊØè‰∏™ËßÇÁÇπÁîüÊàêÂêéÁ´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Êñá‰ª∂</li>
                    <li>üìÅ <strong>ÂàÜËΩÆÊ¨°‰øùÂ≠ò</strong>ÔºöÊØèËΩÆËÆ®ËÆ∫Ëá™Âä®ÁîüÊàêÁã¨Á´ãÁöÑËßÇÁÇπËÆ∞ÂΩïÊñá‰ª∂</li>
                    <li>üóÇÔ∏è <strong>Êñá‰ª∂Â§πÁªìÊûÑ</strong>ÔºöÊé®Ëçê"ËÆ®ËÆ∫ÁªìÊûú/[ËØæÁ®ãÂêç]_[Êó∂Èó¥]/"ÁªÑÁªáÊâÄÊúâÊñá‰ª∂</li>
                    <li>üìÇ <strong>Êô∫ËÉΩÂëΩÂêç</strong>ÔºöÊñá‰ª∂ÂêçÂåÖÂê´Êó∂Èó¥Êà≥„ÄÅ‰∏ªÈ¢ò„ÄÅËΩÆÊ¨°Á≠â‰ø°ÊÅØ</li>
                    <li>üìä <strong>ÂÆåÊï¥ËÆ∞ÂΩï</strong>ÔºöÂåÖÂê´ËßÇÁÇπÂÜÖÂÆπ„ÄÅÊäïÁ•®ÊÉÖÂÜµ„ÄÅÈÄöËøáÁéáÁªüËÆ°„ÄÅ‰∏ìÂÆ∂‰ø°ÊÅØ</li>
                    <li>ü§ñ <strong>AIËûçÂêà‰ΩøÁî®</strong>ÔºöÁîüÊàê‰ºòÂåñÊïôÊ°àÊó∂ÔºåËÆ∞ÂΩïÊñá‰ª∂Ëá™Âä®‰º†ÈÄíÁªôAI</li>
                    <li>üîÑ <strong>ÊåÅ‰πÖÂåñÂ§á‰ªΩ</strong>ÔºölocalStorage + Êñá‰ª∂‰∏ãËΩΩÂèåÈáç‰øùÈöú</li>
                    <li>üõ°Ô∏è <strong>Êï∞ÊçÆ‰øùÊä§</strong>ÔºöËá™Âä®ÁõëÊéßÊï∞ÊçÆÂèòÂåñÔºåÈò≤Ê≠¢ÊÑèÂ§ñÊ∏ÖÁ©∫ÔºåÊîØÊåÅËá™Âä®ÊÅ¢Â§ç</li>
                    <li>üìà <strong>ÁªüËÆ°ÂàÜÊûê</strong>ÔºöËá™Âä®ÁîüÊàê‰∏ìÂÆ∂Ë¥°ÁåÆÊéíË°å„ÄÅÁ´†ËäÇÂàÜÂ∏ÉÁ≠â</li>
                    <li>üéØ <strong>ÂèØËøΩÊ∫ØÊÄß</strong>ÔºöÊØè‰∏™‰ºòÂåñÁÇπÈÉΩËÉΩËøΩÊ∫ØÂà∞ÂéüÂßãËßÇÁÇπÂíåÊäïÁ•®</li>
                    <li>üìç <strong>ÂÆûÊó∂ÊòæÁ§∫</strong>ÔºöÈ°µÈù¢Âè≥‰∏äËßíÊòæÁ§∫Â∑≤‰øùÂ≠òËßÇÁÇπÊï∞ÈáèÔºàÁÇπÂáªÂèØÊü•ÁúãÔºâ</li>
                    <li>‚¨áÔ∏è <strong>‰∏ÄÈîÆ‰∏ãËΩΩ</strong>ÔºöÊîØÊåÅÊâπÈáè‰∏ãËΩΩÊâÄÊúâËÆ®ËÆ∫Êñá‰ª∂Âà∞Áªü‰∏ÄÊñá‰ª∂Â§π</li>
                    <li>üîç <strong>Ë∞ÉËØïÂ∑•ÂÖ∑</strong>ÔºöÊéßÂà∂Âè∞ËæìÂÖ• checkOpinionsData() Ê£ÄÊü•Êï∞ÊçÆÁä∂ÊÄÅ</li>
                </ul>
                <div style="background: rgba(24,144,255,0.2); border: 2px solid rgba(24,144,255,0.3); border-radius: 12px; padding: 15px; margin-top: 15px;">
                    <div style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.8;">
                        <strong style="color: #1890ff;"><i class="fas fa-folder-open"></i> Ëá™Âä®ÁîüÊàêÁöÑÊñá‰ª∂ÂàóË°®Ôºö</strong><br>
                        ‚Ä¢ ÂàùÊ≠•ÊïôÊ°à.txtÔºàÁ¨¨‰∏ÄÈò∂ÊÆµÁîüÊàêÔºâ<br>
                        ‚Ä¢ Á¨¨NËΩÆ_[‰∏ªÈ¢ò]_ËßÇÁÇπ.txtÔºàÊØèËΩÆËÆ®ËÆ∫ÂêéÁîüÊàêÔºâ<br>
                        ‚Ä¢ ÂÆåÊï¥ËßÇÁÇπËÆ∞ÂΩï.json + .txtÔºàÊâÄÊúâËΩÆÊ¨°Ê±áÊÄªÔºâ<br>
                        ‚Ä¢ ‰ºòÂåñÊïôÊ°à_Á∫ØÂáÄÁâà.txtÔºàËûçÂêàÂêéÁöÑÊúÄÁªàÁâàÊú¨Ôºâ<br>
                        ‚Ä¢ ‰ºòÂåñÊïôÊ°à_Ê†áÊ≥®Áâà.txtÔºàÂ∏¶ÂØπÊØîÊ†áÊ≥®ÁâàÊú¨Ôºâ<br>
                        ‚Ä¢ ÊïôÁ†îÁªÑËÆ®ËÆ∫ËÆ∞ÂΩï.txtÔºàÂÆåÊï¥ËÆ®ËÆ∫ËøáÁ®ãÔºâ
                    </div>
                </div>
            </div>
            
            <div class="feature-section" style="background: rgba(82, 196, 26, 0.1); border: 2px solid rgba(82, 196, 26, 0.3); border-radius: 12px; padding: 20px; margin-top: 30px;">
                <h3 style="color: #52c41a; font-size: 1.3rem; margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fas fa-shield-alt" style="margin-right: 10px;"></i>
                    Êï∞ÊçÆÂÆâÂÖ®‰øùÈöúÊú∫Âà∂
                </h3>
                <div style="color: rgba(255, 255, 255, 0.95); line-height: 2; font-size: 1rem;">
                    <p style="margin-bottom: 15px;"><strong>‰∏âÈáç‰øùÊä§ÔºåÁ°Æ‰øùËßÇÁÇπ‰∏ç‰∏¢Â§±Ôºö</strong></p>
                    <ol style="padding-left: 25px; margin-bottom: 15px;">
                        <li><strong>ÂÜÖÂ≠ò‰øùÊä§</strong>Ôºö‰ΩøÁî®Object.definePropertyÁõëÊéßÊï∞ÊçÆÂèòÂåñÔºåÊ£ÄÊµãÂà∞Ê∏ÖÁ©∫Êó∂Ëá™Âä®ÊÅ¢Â§ç</li>
                        <li><strong>Êú¨Âú∞Â§á‰ªΩ</strong>ÔºöÊØèÊ¨°‰øùÂ≠òÈÉΩÂêåÊ≠•Âà∞localStorageÔºåÈ°µÈù¢Âà∑Êñ∞ÂêéËá™Âä®ÊÅ¢Â§ç</li>
                        <li><strong>Êñá‰ª∂‰∏ãËΩΩ</strong>ÔºöJSON+TXTÂèåÊ†ºÂºèËá™Âä®‰∏ãËΩΩÂà∞Êú¨Âú∞ÔºåÊ∞∏‰πÖ‰øùÂ≠ò</li>
                    </ol>
                    <p style="margin-bottom: 15px;"><strong>Â§ö‰∏™Ê£ÄÊü•ÁÇπÔºåÁ°Æ‰øùÊï∞ÊçÆ‰º†ÈÄíÔºö</strong></p>
                    <ul style="padding-left: 25px;">
                        <li>‚úì ÊØèËΩÆËÆ®ËÆ∫ÁªìÊùüÔºöÈ™åËØÅËßÇÁÇπÊòØÂê¶‰øùÂ≠ò</li>
                        <li>‚úì ‰∏ªÊåÅ‰∫∫ÊÄªÁªìÂâçÔºöÊ£ÄÊü•Âπ∂ÊÅ¢Â§çÊï∞ÊçÆ</li>
                        <li>‚úì ÁîüÊàê‰ºòÂåñÊïôÊ°àÂâçÔºöÂº∫Âà∂È™åËØÅÂíåÊÅ¢Â§ç</li>
                        <li>‚úì ÂÆûÊó∂ÁõëÊéßÔºöÈ°µÈù¢Âè≥‰∏äËßíÊòæÁ§∫Â∑≤‰øùÂ≠òÊï∞Èáè</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 12px; background: rgba(24,144,255,0.2); border-radius: 8px; border-left: 4px solid #1890ff;">
                        <strong style="color: #1890ff;">üí° Ë∞ÉËØïÊèêÁ§∫Ôºö</strong><br>
                        Â¶ÇÂèëÁé∞ËßÇÁÇπÊú™‰øùÂ≠òÔºåÂèØÂú®ÊéßÂà∂Âè∞ËøêË°åÔºö<br>
                        ‚Ä¢ <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; color: #52c41a;">checkOpinionsData()</code> - Ê£ÄÊü•Êï∞ÊçÆÁä∂ÊÄÅ<br>
                        ‚Ä¢ <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; color: #52c41a;">viewSavedOpinions()</code> - Êü•ÁúãÊâÄÊúâËßÇÁÇπ<br>
                        ‚Ä¢ <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; color: #52c41a;">downloadCurrentOpinionsRecord()</code> - ÈáçÊñ∞‰∏ãËΩΩ
                    </p>
                </div>
            </div>

            <div class="feature-section">
                <h3 style="color: #13c2c2; font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center;">
                    <i class="fas fa-file-export" style="margin-right: 10px;"></i>
                    Â§öÊ†ºÂºèÁªìÊûúËæìÂá∫
                </h3>
                <ul style="color: rgba(255, 255, 255, 0.9); line-height: 2; font-size: 1.1rem;">
                    <li>üìù <strong>TXTÊ†ºÂºè</strong>ÔºöÁ∫ØÊñáÊú¨Ê†ºÂºèÔºåÂÖºÂÆπÊÄßÊúÄÂ•Ω</li>
                    <li>üìÑ <strong>DOCXÊ†ºÂºè</strong>ÔºöWordÊñáÊ°£Ê†ºÂºèÔºåÊîØÊåÅÂØåÊñáÊú¨ÂíåÊ†∑Âºè</li>
                    <li>üìë <strong>MarkdownÊ†ºÂºè</strong>ÔºöÈÄÇÂêàÊäÄÊúØÊñáÊ°£ÂíåÁâàÊú¨ÊéßÂà∂</li>
                    <li>üìï <strong>PDFÊ†ºÂºè</strong>Ôºö‰∏§ÁßçÊñπÂºè
                        <ul style="margin-left: 30px; margin-top: 5px;">
                            <li style="font-size: 0.95rem; color: rgba(255,255,255,0.85);">‚Ä¢ Áõ¥Êé•ÂØºÂá∫ÔºöÊµèËßàÂô®html2pdfËΩ¨Êç¢ÔºàÂø´ÈÄü‰ΩÜÂèØËÉΩÊúâÊ†ºÂºèÈôêÂà∂Ôºâ</li>
                            <li style="font-size: 0.95rem; color: rgba(255,255,255,0.85);">‚Ä¢ <strong style="color: #52c41a;">Êé®ËçêÊñπÂºè</strong>ÔºöÂÖà‰∏ãËΩΩDOCX ‚Üí Word/WPSÊâìÂºÄ ‚Üí Âè¶Â≠ò‰∏∫PDFÔºàË¥®ÈáèÊúÄ‰Ω≥ÔºåÂèÇËÄÉPython doc2pdfÊ†áÂáÜÊµÅÁ®ãÔºâ</li>
                        </ul>
                    </li>
                    <li>üìö <strong>ÂÆåÊï¥ËÆ∞ÂΩï</strong>ÔºöÊïôÁ†îËÆ®ËÆ∫ËÆ∞ÂΩï„ÄÅ‰∏ìÂÆ∂Ë¥°ÁåÆË°®„ÄÅËûçÂêàË¥®ÈáèÊä•Âëä</li>
                </ul>
            </div>

            <div class="team-info" style="margin-top: 50px; padding: 30px; background: rgba(0, 0, 0, 0.2); border-radius: 12px; text-align: center;">
                <h3 style="color: #ffd700; font-size: 1.3rem; margin-bottom: 15px;">
                    <i class="fas fa-users" style="margin-right: 10px;"></i>
                    ÂºÄÂèëÂõ¢Èòü
                </h3>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; line-height: 1.8;">
                    <strong>ÈªÑÊµ∑ÂçöÂ£´</strong> ‚Ä¢ <strong>Èíü‰∏ΩÈúûÂçöÂ£´</strong> ‚Ä¢<strong>Ê¢ÅÂ±ïÂ∏ÜÂõ¢Èòü</strong><br>
                    Ëá¥Âäõ‰∫éÊïôËÇ≤ÊäÄÊúØÂàõÊñ∞ÔºåÊûÑÂª∫Êô∫ËÉΩÂåñÊïôÂ≠¶ÊîØÊåÅÁ≥ªÁªü
                </p>
                <div class="tech-stack" style="margin-top: 20px;">
                    <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                        <strong>ÊäÄÊúØÊ†àÔºö</strong> HTML5 + JavaScript + Â§öAIÈõÜÊàê ‚Ä¢ <strong>UIÂ∫ìÔºö</strong> Font Awesome ‚Ä¢ <strong>Â≠ó‰ΩìÔºö</strong> Inter
                    </span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

