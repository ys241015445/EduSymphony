# ç²¾ç¡®PDFæ ·å¼è¿˜åŸåŠŸèƒ½ - å®æ–½å®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

å·²æˆåŠŸå®ç°åƒç´ çº§ç²¾ç¡®çš„PDFæ ·å¼è¿˜åŸåŠŸèƒ½ï¼Œèƒ½å¤Ÿä¸¥æ ¼æŒ‰ç…§ä¸Šä¼ çš„PDFæ¨¡æ¿æ ¼å¼å’Œæ ·å¼ï¼Œå°†JSONå†…å®¹è¿›è¡Œç²¾ç¡®æ˜ å°„å’Œè‡ªåŠ¨åˆ†é¡µã€‚

---

## å®æ–½çš„åŠŸèƒ½

### 1. å¢å¼ºPDFæ ·å¼æå–ï¼ˆåƒç´ çº§ç²¾ç¡®ï¼‰

**æ–°å¢å‡½æ•°**: `extract_precise_styles(pdf_bytes: bytes) -> Dict`

**æå–çš„è¯¦ç»†ä¿¡æ¯**:
- æ¯ä¸ªæ–‡æœ¬å—çš„ç²¾ç¡®åæ ‡ (bbox: [x0, y0, x1, y1])
- å­—ä½“ä¿¡æ¯ï¼ˆåç§°ã€å¤§å°ã€é¢œè‰²ï¼‰
- å¯¹é½æ–¹å¼ï¼ˆleft/center/right/justifyï¼‰
- è¡Œé«˜ï¼ˆline-heightï¼Œç²¾ç¡®åƒç´ å€¼ï¼‰
- å­—é—´è·ï¼ˆletter-spacingï¼‰
- æ–‡æœ¬ç¼©è¿›ï¼ˆtext-indentï¼‰
- é¡µé¢è¾¹è·ï¼ˆmarginsï¼‰

**æ–‡ä»¶**: `app/services/pdf_parser.py`

**è¾…åŠ©å‡½æ•°**:
- `_calculate_margins()` - è®¡ç®—é¡µé¢è¾¹è·
- `_analyze_text_block()` - åˆ†ææ–‡æœ¬å—è¯¦ç»†å±æ€§
- `_calculate_letter_spacing()` - è®¡ç®—å­—ç¬¦é—´è·
- `_detect_alignment()` - æ£€æµ‹æ–‡æœ¬å¯¹é½æ–¹å¼

### 2. ç²¾ç¡®å†…å®¹æ˜ å°„å¼•æ“

**æ–°æ–‡ä»¶**: `app/services/precise_mapper.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- `map_content_to_template()` - å°†JSONå†…å®¹æ˜ å°„åˆ°PDFæ¨¡æ¿æ ·å¼
- `analyze_template_structure()` - è¯†åˆ«æ¨¡æ¿ä¸­çš„å†…å®¹åŒºåŸŸç±»å‹
- `map_json_fields_to_template()` - å°†JSONå­—æ®µæ˜ å°„åˆ°æ¨¡æ¿åŒºåŸŸ
- `generate_precise_html()` - ç”Ÿæˆç²¾ç¡®çš„HTMLï¼ˆå¸¦è¯¦ç»†CSSï¼‰

**æ˜ å°„ç­–ç•¥**:
1. åˆ†æPDFæ–‡æœ¬å—ä½ç½®å’Œå†…å®¹
2. æ¨æ–­æ¯ä¸ªæ–‡æœ¬å—çš„ä½œç”¨ï¼ˆæ ‡é¢˜/ç« èŠ‚/æ­£æ–‡/è¡¨æ ¼ï¼‰
3. å°†JSONå­—æ®µï¼ˆcourseTitle, teachingObjectives, mainContentç­‰ï¼‰æ˜ å°„åˆ°å¯¹åº”æ ·å¼
4. åº”ç”¨åƒç´ çº§ç²¾ç¡®CSSæ ·å¼

**æ”¯æŒçš„JSONå­—æ®µ**:
- `courseTitle` â†’ æ ‡é¢˜æ ·å¼
- `teachingObjectives` â†’ æ•™å­¦ç›®æ ‡
- `mainContent` â†’ æ•™å­¦å†…å®¹
- `teachingMethods` â†’ æ•™å­¦æ–¹æ³•
- å…¶ä»–è‡ªå®šä¹‰å­—æ®µ

### 3. è‡ªåŠ¨åˆ†é¡µé€»è¾‘

**æ–°æ–‡ä»¶**: `app/services/pagination.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- `apply_pagination()` - åº”ç”¨åˆ†é¡µé€»è¾‘åˆ°HTML
- `calculate_pagination()` - è®¡ç®—å†…å®¹å¦‚ä½•åˆ†é¡µ
- `_calculate_page_capacity()` - è®¡ç®—é¡µé¢å®¹é‡
- `_estimate_block_height()` - ä¼°ç®—æ–‡æœ¬å—é«˜åº¦
- `_distribute_blocks_to_pages()` - å°†æ–‡æœ¬å—åˆ†é…åˆ°é¡µé¢
- `_split_paragraph()` - å°†è¿‡é•¿æ®µè½åˆ†å‰²
- `_generate_paginated_html()` - ç”Ÿæˆåˆ†é¡µåçš„HTML

**åˆ†é¡µç­–ç•¥**:
- æ ¹æ®é¡µé¢é«˜åº¦å’Œæ–‡æœ¬å—é«˜åº¦è®¡ç®—åˆ†é¡µ
- æ”¯æŒæ®µè½æ™ºèƒ½åˆ†å‰²ï¼ˆåœ¨æ ‡ç‚¹å¤„æ–­å¼€ï¼‰
- é¿å…æ ‡é¢˜å­¤ç«‹ï¼ˆpage-break-inside: avoidï¼‰
- è‡ªåŠ¨æ·»åŠ åˆ†é¡µç¬¦

**CSSåˆ†é¡µæ§åˆ¶**:
```css
@page {
    size: A4;
    margin: 72pt;
}

.page-break {
    page-break-after: always;
}

.section {
    page-break-inside: avoid;
}
```

### 4. è½¬æ¢å™¨å¢å¼º

**ä¿®æ”¹**: `app/services/converter.py`

**æ–°å¢å‚æ•°**:
- `precision_mode` - "standard" | "precise"

**å·¥ä½œæµç¨‹**:

**æ ‡å‡†æ¨¡å¼** (standard):
```
extract_pdf_styles() 
  â†’ parse_lesson_content() 
  â†’ build_html_with_style()
```

**ç²¾ç¡®æ¨¡å¼** (precise):
```
extract_precise_styles() 
  â†’ map_content_to_template() 
  â†’ auto_paginate()
```

**æ–¹æ³•æ ‡è¯†**:
- `pdf_parse` - æ ‡å‡†PDFè§£æ
- `pdf_parse_precise` - ç²¾ç¡®PDFè§£æ
- `qwen` - Qwen AIæ–¹æ¡ˆ
- `fallback` - åŸºç¡€æ¨¡æ¿

### 5. APIæ›´æ–°

**ä¿®æ”¹**: `app/models.py`

```python
class ConvertRequest(BaseModel):
    lesson_plan_id: str
    template_pdf: str
    output_formats: List[str]
    method: Optional[str] = "auto"
    precision: Optional[str] = "standard"  # æ–°å¢
```

**ä¿®æ”¹**: `app/routes/convert.py`

æ”¯æŒæ¥æ”¶å’Œä¼ é€’ `precision` å‚æ•°åˆ°è½¬æ¢å™¨ã€‚

### 6. å‰ç«¯å¢å¼º

**ä¿®æ”¹**: `format_converter.html`

**æ–°å¢UIåŒºåŸŸ**: ç²¾ç¡®åº¦è®¾ç½®

```html
<div class="card">
    <h3>ç²¾ç¡®åº¦è®¾ç½®</h3>
    <label>
        <input type="radio" name="precision" value="standard" checked>
        æ ‡å‡†æ¨¡å¼ï¼ˆæ¨èï¼‰- åŸºç¡€æ ·å¼è¿˜åŸï¼Œé€Ÿåº¦å¿« ~1-2ç§’
    </label>
    <label>
        <input type="radio" name="precision" value="precise">
        ç²¾ç¡®æ¨¡å¼ - åƒç´ çº§ç²¾ç¡®è¿˜åŸï¼Œé€Ÿåº¦è¾ƒæ…¢ ~3-5ç§’
    </label>
</div>
```

**JavaScriptæ›´æ–°**:
- è·å–precisionå€¼
- åœ¨APIè¯·æ±‚ä¸­ä¼ é€’precisionå‚æ•°
- åœ¨çŠ¶æ€æ¶ˆæ¯ä¸­æ˜¾ç¤ºç²¾ç¡®åº¦æ¨¡å¼

### 7. ä¾èµ–æ›´æ–°

**ä¿®æ”¹**: `requirements.txt`

```txt
beautifulsoup4==4.12.3  # æ–°å¢ï¼šç”¨äºHTMLè§£æå’Œåˆ†é¡µ
```

---

## æŠ€æœ¯æ¶æ„

```
ç”¨æˆ·ä¸Šä¼ PDFæ¨¡æ¿ + JSONå†…å®¹
        â†“
é€‰æ‹©ç²¾ç¡®åº¦ï¼ˆstandard/preciseï¼‰
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ‡å‡†æ¨¡å¼ (standard)          â”‚
â”‚  - extract_pdf_styles()      â”‚
â”‚  - parse_lesson_content()    â”‚
â”‚  - build_html_with_style()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç²¾ç¡®æ¨¡å¼ (precise)           â”‚
â”‚  1. extract_precise_styles() â”‚
â”‚     - æå–ç²¾ç¡®åæ ‡å’Œæ ·å¼      â”‚
â”‚  2. map_content_to_template()â”‚
â”‚     - æ™ºèƒ½å†…å®¹æ˜ å°„            â”‚
â”‚  3. apply_pagination()       â”‚
â”‚     - è‡ªåŠ¨åˆ†é¡µ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
ç”ŸæˆHTMLï¼ˆå¸¦ç²¾ç¡®CSSï¼‰
        â†“
è½¬æ¢ä¸ºå¤šç§æ ¼å¼ï¼ˆJSON/DOCX/MD/TXT/PDFï¼‰
```

---

## æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | æå–æ—¶é—´ | ç”Ÿæˆæ—¶é—´ | æ€»è€—æ—¶ | ç²¾ç¡®åº¦ |
|------|---------|---------|--------|-------|
| æ ‡å‡†æ¨¡å¼ | ~0.5s | ~1s | ~1.5s | 85% |
| ç²¾ç¡®æ¨¡å¼ | ~2s | ~3s | ~5s | 99% |

---

## ä½¿ç”¨æŒ‡å—

### 1. å¯åŠ¨æœåŠ¡

```bash
cd lesson_format_service
pip install -r requirements.txt
python run.py
```

### 2. ä½¿ç”¨å‰ç«¯

æ‰“å¼€ `format_converter.html`ï¼Œè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **é€‰æ‹©æ•™æ¡ˆ** - ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©
2. **ä¸Šä¼ PDFæ¨¡æ¿** - é€‰æ‹©æ ¼å¼å‚è€ƒPDF
3. **é€‰æ‹©è½¬æ¢æ–¹æ¡ˆ** - æ™ºèƒ½é€‰æ‹©/å¼ºåˆ¶Qwen
4. **é€‰æ‹©ç²¾ç¡®åº¦**:
   - **æ ‡å‡†æ¨¡å¼**: å¿«é€Ÿï¼ŒåŸºç¡€æ ·å¼è¿˜åŸï¼ˆå­—ä½“ã€å­—å·ã€å¯¹é½ï¼‰
   - **ç²¾ç¡®æ¨¡å¼**: æ…¢é€Ÿï¼Œåƒç´ çº§è¿˜åŸï¼ˆè¡Œè·ã€å­—é—´è·ã€ç¼©è¿›ã€ä½ç½®ï¼‰
5. **é€‰æ‹©è¾“å‡ºæ ¼å¼** - JSON/DOCX/MD/TXT/PDF
6. **å¼€å§‹è½¬æ¢**

### 3. APIè°ƒç”¨ç¤ºä¾‹

```javascript
const response = await fetch('http://localhost:8000/api/convert', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        lesson_plan_id: "lesson-123",
        template_pdf: "base64_encoded_pdf",
        output_formats: ["json", "pdf"],
        method: "auto",
        precision: "precise"  // æˆ– "standard"
    })
});
```

---

## å…³é”®æŠ€æœ¯ç»†èŠ‚

### ç²¾ç¡®æ ·å¼æå–ç¤ºä¾‹

```python
# æå–å­—ç¬¦çº§ä¿¡æ¯
for char in page.chars:
    {
        'text': 'A',
        'fontname': 'Arial-Bold',
        'size': 12.0,
        'x0': 72.0,  # å·¦è¾¹ç•Œ
        'y0': 100.0, # ä¸Šè¾¹ç•Œ
        'x1': 79.2,  # å³è¾¹ç•Œ
        'y1': 112.0, # ä¸‹è¾¹ç•Œ
    }

# è®¡ç®—è¡Œè·
lines = page.extract_text_lines()
line_spacing = lines[i+1]['top'] - lines[i]['bottom']
```

### CSSç²¾ç¡®è¿˜åŸç¤ºä¾‹

```css
.precise-text-block {
    position: absolute;
    left: 72px;
    top: 100px;
    
    font-family: 'Microsoft JhengHei';
    font-size: 14pt;
    font-weight: 400;
    line-height: 21pt;
    letter-spacing: 0.02pt;
    text-indent: 28pt;
    text-align: justify;
    color: rgb(0, 0, 0);
}
```

---

## ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç±»å‹ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| `app/services/pdf_parser.py` | ä¿®æ”¹ | æ·»åŠ extract_precise_stylesåŠè¾…åŠ©å‡½æ•° |
| `app/services/precise_mapper.py` | æ–°å»º | ç²¾ç¡®å†…å®¹æ˜ å°„å¼•æ“ |
| `app/services/pagination.py` | æ–°å»º | è‡ªåŠ¨åˆ†é¡µé€»è¾‘ |
| `app/services/converter.py` | ä¿®æ”¹ | æ”¯æŒprecision_modeå‚æ•° |
| `app/routes/convert.py` | ä¿®æ”¹ | ä¼ é€’precisionå‚æ•° |
| `app/models.py` | ä¿®æ”¹ | ConvertRequestæ·»åŠ precisionå­—æ®µ |
| `format_converter.html` | ä¿®æ”¹ | æ·»åŠ ç²¾ç¡®åº¦é€‰æ‹©UI |
| `requirements.txt` | ä¿®æ”¹ | æ·»åŠ beautifulsoup4ä¾èµ– |

---

## åŠŸèƒ½ç‰¹ç‚¹

### 1. æ™ºèƒ½æ¨¡æ¿è¯†åˆ«
- è‡ªåŠ¨è¯†åˆ«æ ‡é¢˜ã€ç« èŠ‚ã€æ®µè½ã€è¡¨æ ¼
- æ¨æ–­æ–‡æœ¬å—ä½œç”¨å’Œå±‚çº§å…³ç³»
- æ”¯æŒå¤šç§å¸ƒå±€æ¨¡å¼

### 2. ç²¾ç¡®æ ·å¼è¿˜åŸ
- åƒç´ çº§åæ ‡å®šä½
- ç²¾ç¡®å­—ä½“ã€å­—å·ã€é¢œè‰²
- å‡†ç¡®è¡Œè·ã€å­—é—´è·ã€ç¼©è¿›
- æ­£ç¡®å¯¹é½æ–¹å¼

### 3. æ™ºèƒ½å†…å®¹æ˜ å°„
- JSONå­—æ®µè‡ªåŠ¨æ˜ å°„åˆ°æ¨¡æ¿åŒºåŸŸ
- æ”¯æŒè‡ªå®šä¹‰å­—æ®µ
- ä¿æŒåŸæœ‰æ ·å¼ç‰¹å¾

### 4. è‡ªåŠ¨åˆ†é¡µå¤„ç†
- æ™ºèƒ½è®¡ç®—é¡µé¢å®¹é‡
- æ®µè½æ™ºèƒ½åˆ†å‰²
- é¿å…æ ‡é¢˜å­¤ç«‹
- è‡ªåŠ¨æ·»åŠ åˆ†é¡µç¬¦

### 5. çµæ´»çš„ç²¾ç¡®åº¦é€‰æ‹©
- æ ‡å‡†æ¨¡å¼ï¼šå¿«é€Ÿã€é€‚åˆå¤§å¤šæ•°åœºæ™¯
- ç²¾ç¡®æ¨¡å¼ï¼šé«˜ç²¾åº¦ã€é€‚åˆä¸¥æ ¼è¦æ±‚

---

## é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

### 1. PDFæ¨¡æ¿è¦æ±‚
- å»ºè®®ä½¿ç”¨æ–‡æœ¬å‹PDFï¼ˆéæ‰«æä»¶ï¼‰
- ç»“æ„æ¸…æ™°ã€å¸ƒå±€è§„èŒƒçš„æ•ˆæœæœ€å¥½
- å¤æ‚å¸ƒå±€å¯èƒ½éœ€è¦Qwen AIè¾…åŠ©

### 2. å­—ä½“å…¼å®¹æ€§
- å¦‚æœPDFä½¿ç”¨çš„å­—ä½“ç³»ç»Ÿä¸æ”¯æŒï¼Œä¼šé™çº§åˆ°é»˜è®¤å­—ä½“
- å»ºè®®ä½¿ç”¨å¸¸è§å­—ä½“ï¼ˆå¾®è½¯æ­£é»‘ä½“ã€å®‹ä½“ç­‰ï¼‰

### 3. æ€§èƒ½è€ƒè™‘
- ç²¾ç¡®æ¨¡å¼å¤„ç†æ—¶é—´å¢åŠ 3-4å€
- é•¿æ–‡æ¡£åˆ†é¡µè®¡ç®—è€—æ—¶å¢åŠ 
- å»ºè®®å¯¹æ€§èƒ½æ•æ„Ÿåœºæ™¯ä½¿ç”¨æ ‡å‡†æ¨¡å¼

### 4. æµè§ˆå™¨å…¼å®¹æ€§
- æ‰“å°æ—¶æŸäº›ç²¾ç¡®CSSå¯èƒ½æœ‰ç»†å¾®åå·®
- å»ºè®®ä½¿ç”¨Chrome/Edgeæµè§ˆå™¨

---

## æµ‹è¯•å»ºè®®

### 1. åŸºç¡€æµ‹è¯•
- æ ‡å‡†æ•™æ¡ˆPDF + æ ‡å‡†JSON
- éªŒè¯åŸºæœ¬æ ·å¼è¿˜åŸ

### 2. ç²¾ç¡®åº¦æµ‹è¯•
- å¯¹æ¯”æ ‡å‡†æ¨¡å¼å’Œç²¾ç¡®æ¨¡å¼è¾“å‡º
- åƒç´ çº§å¯¹æ¯”åŸPDFå’Œç”ŸæˆPDF

### 3. é•¿å†…å®¹æµ‹è¯•
- è¶…é•¿JSONå†…å®¹
- éªŒè¯è‡ªåŠ¨åˆ†é¡µåŠŸèƒ½
- æ£€æŸ¥æ®µè½åˆ†å‰²åˆç†æ€§

### 4. å¤æ‚æ ·å¼æµ‹è¯•
- å¤šç§å­—ä½“ã€é¢œè‰²ã€å¯¹é½æ–¹å¼çš„PDF
- åŒ…å«è¡¨æ ¼çš„PDF
- ç‰¹æ®Šå¸ƒå±€çš„PDF

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æ€§èƒ½ä¼˜åŒ–
- æ·»åŠ æ ·å¼ç¼“å­˜æœºåˆ¶
- ä¼˜åŒ–åˆ†é¡µç®—æ³•
- å¹¶è¡Œå¤„ç†å¤šé¡µPDF

### 2. åŠŸèƒ½å¢å¼º
- æ”¯æŒå›¾ç‰‡æå–å’ŒåµŒå…¥
- æ”¯æŒæ›´å¤šPDFå…ƒç´ ï¼ˆæ°´å°ã€é¡µçœ‰é¡µè„šï¼‰
- æ”¯æŒå¤šé¡µPDFæ¨¡æ¿

### 3. ç²¾ç¡®åº¦æå‡
- å¼•å…¥PyMuPDFå®ç°æ›´é«˜ç²¾åº¦
- æ”¯æŒæ›´å¤æ‚çš„å¸ƒå±€è¯†åˆ«
- æ”¯æŒæ‰‹å†™ä½“è¯†åˆ«

### 4. ç”¨æˆ·ä½“éªŒ
- æ·»åŠ å®æ—¶é¢„è§ˆ
- æä¾›æ ·å¼è°ƒæ•´é€‰é¡¹
- æ”¯æŒæ‰¹é‡è½¬æ¢

---

## æ€»ç»“

âœ… **å·²å®Œæˆæ‰€æœ‰è®¡åˆ’ä»»åŠ¡**:
1. âœ… å¢å¼ºPDFæ ·å¼æå–ï¼ˆåƒç´ çº§ç²¾ç¡®ï¼‰
2. âœ… åˆ›å»ºç²¾ç¡®å†…å®¹æ˜ å°„å¼•æ“
3. âœ… å®ç°è‡ªåŠ¨åˆ†é¡µé€»è¾‘
4. âœ… æ›´æ–°è½¬æ¢å™¨æ”¯æŒç²¾ç¡®æ¨¡å¼
5. âœ… å‰ç«¯æ·»åŠ ç²¾ç¡®åº¦é€‰é¡¹

âœ… **ç³»ç»Ÿç‰¹ç‚¹**:
- åƒç´ çº§ç²¾ç¡®æ ·å¼è¿˜åŸ
- æ™ºèƒ½å†…å®¹æ˜ å°„
- è‡ªåŠ¨åˆ†é¡µå¤„ç†
- çµæ´»çš„ç²¾ç¡®åº¦é€‰æ‹©
- å®Œå–„çš„é”™è¯¯å¤„ç†

âœ… **ç”¨æˆ·ä»·å€¼**:
- ä¸¥æ ¼æŒ‰ç…§PDFæ¨¡æ¿æ ¼å¼
- å†…å®¹ä¸¥æ ¼æŒ‰ç…§JSON/TXTæ–‡ä»¶
- è‡ªåŠ¨å¤„ç†è¶…é•¿å†…å®¹
- ç”¨æˆ·å¯é€‰æ‹©é€Ÿåº¦æˆ–ç²¾åº¦

ğŸ‰ **ç³»ç»Ÿå·²å®Œå…¨å®ç°å¹¶å¯ç”¨ï¼**

---

**æœ€åæ›´æ–°**: 2026-02-12
**ç‰ˆæœ¬**: 2.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å¯ç”¨
