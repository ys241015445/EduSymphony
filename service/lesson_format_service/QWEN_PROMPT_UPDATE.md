# Qwen API Prompt优化 - 强调格式和样式严格性

## 更新日期
2026-02-12

## 更新内容

已优化Qwen API的prompt提示词，明确强调格式和样式必须**严格按照**上传的PDF模板，而不是"尽量接近"。

---

## 修改对比

### 修改前（温和措辞）

```
以我上传的教案PDF的格式和要点为参考，以下面的内容为主要内容，生成一个完整的HTML文档。

要求：
1. HTML必须包含完整的DOCTYPE、html、head、body标签
2. 样式写在<style>标签中，确保打印友好
3. 字体使用繁体中文字体（Microsoft JhengHei、PMingLiU等）
4. 格式尽量接近PDF模版的布局和样式          ← 问题：措辞太温和
5. 包含适当的表格、标题、段落格式              ← 问题：不够明确
6. 确保内容完整，不要遗漏任何章节
```

### 修改后（强调严格性）

```
以我上传的教案PDF为标准模板，严格按照该PDF的格式和样式，使用下面的教案内容生成HTML文档。

严格要求：
1. 格式必须严格按照上传PDF的布局结构（标题位置、段落缩进、行间距等）
2. 样式必须严格还原PDF中的样式（字体、字号、颜色、对齐方式、边距等）
3. 所有文本使用繁体中文字体（Microsoft JhengHei、PMingLiU等），字体大小和样式与PDF完全一致
4. 如果PDF有表格，必须按相同的表格样式和布局生成
5. 标题、小标题、正文的层级关系必须与PDF保持完全一致
6. 行距、段间距、页边距必须精确还原PDF的设置
7. HTML必须包含完整的DOCTYPE、html、head、body标签，样式写在<style>标签中
8. 确保内容完整，不得遗漏任何章节或段落

教案内容（严格填充到PDF模板格式中）：
{lesson_content}

重要提醒：
- 格式和样式的严格程度是最高优先级
- 不要自由发挥或改变PDF的任何格式设计
- 输出的HTML打印成PDF后应与原模板PDF在视觉上完全一致（内容不同但格式相同）
```

---

## 关键改进点

| 方面 | 修改前 | 修改后 |
|------|--------|--------|
| **总体指令** | "格式和要点为参考" | "严格按照该PDF的格式和样式" |
| **格式要求** | "格式尽量接近" | "格式必须严格按照" |
| **样式要求** | 未明确说明 | "样式必须严格还原" |
| **表格要求** | "包含适当的表格" | "必须按相同的表格样式和布局" |
| **层级关系** | 未提及 | "必须与PDF保持完全一致" |
| **行距段距** | 未提及 | "必须精确还原PDF的设置" |
| **优先级** | 未说明 | "格式和样式严格程度是最高优先级" |
| **最终效果** | 未说明 | "视觉上完全一致（内容不同但格式相同）" |

---

## 详细改进说明

### 1. 标题和开场白
- **之前**: "格式和要点为参考" → 暗示可以灵活处理
- **现在**: "严格按照该PDF的格式和样式" → 明确必须遵循

### 2. 要求清单
- **之前**: "要求"（普通语气）
- **现在**: "严格要求"（强调性语气）

### 3. 格式描述
- **之前**: "格式尽量接近" → AI可能理解为"接近即可"
- **现在**: "格式必须严格按照" → 明确要求精确还原
- 新增具体说明：标题位置、段落缩进、行间距等

### 4. 样式描述
- **之前**: 未单独提及样式
- **现在**: "样式必须严格还原" + 具体说明字体、字号、颜色、对齐、边距

### 5. 表格处理
- **之前**: "包含适当的表格" → 模糊不清
- **现在**: "必须按相同的表格样式和布局生成" → 明确要求复制样式

### 6. 层级关系
- **新增**: "标题、小标题、正文的层级关系必须与PDF保持完全一致"

### 7. 间距要求
- **新增**: "行距、段间距、页边距必须精确还原PDF的设置"

### 8. 重要提醒部分（全新）
添加三条强调性提醒：
- 格式和样式的严格程度是最高优先级
- 不要自由发挥或改变PDF的任何格式设计
- 视觉上完全一致的最终目标

---

## 预期效果

### AI行为改进

修改后，Qwen AI应该会：

1. **更加重视格式精确性**
   - 不会随意调整布局
   - 严格遵循PDF的结构

2. **严格遵循样式设置**
   - 精确复制字体、字号
   - 准确还原颜色、对齐
   - 保持边距和间距

3. **避免自由发挥**
   - 不会"优化"或"改进"格式
   - 不会添加额外的装饰元素
   - 专注于格式复制而非创新

4. **提高还原度**
   - 生成的HTML应该与原PDF在视觉上高度一致
   - 只有内容不同，格式完全相同

---

## 使用说明

### 自动生效

修改已应用到 `app/services/qwen_service.py`，当使用Qwen方案时会自动使用新的prompt：

1. 在前端选择"强制使用Qwen AI"
2. 或者当PDF解析失败时自动降级到Qwen
3. 新prompt会自动发送给Qwen API

### 测试建议

**对比测试**：
1. 使用相同的PDF模板和内容
2. 对比新旧prompt生成的结果
3. 检查格式还原的精确度

**评估标准**：
- ✅ 标题位置和样式是否一致
- ✅ 段落缩进是否精确
- ✅ 行距和段间距是否准确
- ✅ 字体、字号、颜色是否匹配
- ✅ 表格样式是否还原
- ✅ 整体视觉效果是否接近原PDF

---

## 技术细节

### 修改文件
- **文件**: `app/services/qwen_service.py`
- **函数**: `convert_with_qwen_base64()`
- **行数**: 第36-63行（原第36-49行）

### 兼容性
- ✅ 不影响API接口
- ✅ 不影响其他转换方案（PDF解析、基础模板）
- ✅ 向后兼容，无需修改前端代码

### 相关配置
无需修改配置文件，prompt已内置在代码中。

---

## 进一步优化建议

### 可选：添加System Prompt

如果需要进一步强化，可以在messages中添加system角色：

```python
messages = [
    {
        "role": "system",
        "content": "你是一个专业的文档格式转换专家，你的核心能力是精确复制文档的格式和样式。在处理任务时，格式和样式的精确性永远是第一优先级，必须做到像素级的还原。"
    },
    {
        "role": "user",
        "content": [...]
    }
]
```

**注意**：当前实现已经足够强调严格性，system prompt可作为未来优化选项。

---

## 问题排查

### 如果格式还原仍不理想

1. **检查PDF质量**
   - 确保PDF是文本型（非扫描件）
   - 确保PDF结构清晰

2. **检查内容长度**
   - 过长内容可能导致AI省略细节
   - 考虑分段处理

3. **尝试精确模式**
   - 使用前端的"精确模式"
   - 精确模式使用PDF解析而非AI

4. **调整temperature**
   - 当前设置为0.3（较低，更稳定）
   - 可尝试降到0.1以获得更一致的输出

---

## 版本信息

- **修改版本**: v1.1.1
- **修改日期**: 2026-02-12
- **修改类型**: Prompt优化
- **影响范围**: Qwen AI转换方案

---

## 总结

✅ **已完成**:
- 修改prompt，使用"必须"、"严格"等强硬措辞
- 新增8条详细要求
- 添加"重要提醒"部分强调优先级
- 明确最终目标：视觉上完全一致

✅ **预期改进**:
- AI更重视格式精确性
- 减少自由发挥
- 提高格式还原度
- 更符合用户的严格要求

🎯 **核心理念**:
格式和样式必须**严格按照**PDF模板，内容严格按照输入的JSON/TXT，不允许任何自由发挥或格式改变。
