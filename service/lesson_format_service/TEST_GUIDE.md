# 测试验证指南 - Qwen精确样式增强

## 测试前准备

### 1. 启动后端服务

```bash
cd e:\desktop\数说\proto\lesson_format_service
python run.py
```

**期望输出**：
```
INFO:     Started server process
INFO:     Uvicorn running on http://localhost:8000
```

### 2. 打开前端页面

```bash
# 直接在浏览器中打开
e:\desktop\数说\proto\format_converter.html
```

### 3. 准备测试数据

- ✅ 至少一个已生成的教案（在教案系统中生成）
- ✅ 一个标准格式的PDF模板（如：旋轉對稱圖形教案.pdf）

---

## 测试场景

### 场景1：强制Qwen + 标准模式（基线测试）

**目的**：验证标准模式依然正常工作

**步骤**：
1. 选择教案
2. 上传PDF模板
3. 选择"强制使用Qwen AI"
4. 选择"标准模式（推荐）"
5. 勾选所有输出格式
6. 点击"开始转换"

**期望结果**：
- ✅ 转换成功
- ✅ 控制台输出：
  ```
  使用Qwen AI...
  Qwen API调用成功
  ```
- ✅ 显示HTML预览
- ✅ 提供下载链接
- ✅ 转换方法标识为 "qwen"

**验证点**：
- 生成的HTML有内容
- 板式大致相似（但可能不够精确）

---

### 场景2：强制Qwen + 精确模式（核心测试）

**目的**：验证精确模式增强效果

**步骤**：
1. 选择教案
2. 上传PDF模板
3. 选择"强制使用Qwen AI"
4. 选择"精确模式"
5. 勾选所有输出格式
6. 点击"开始转换"

**期望结果**：
- ✅ 转换成功
- ✅ 控制台输出（关键）：
  ```
  提取PDF精确样式数据...
  成功提取精确样式数据：1页
  使用Qwen AI...
  已注入精确样式数据到Qwen prompt
  Qwen API调用成功
  ```
- ✅ 显示HTML预览
- ✅ 提供下载链接
- ✅ 转换方法标识为 "qwen_precise"

**验证点（关键）**：

#### 页面尺寸和边距
- [ ] 页面宽度与PDF一致
- [ ] 页面高度与PDF一致
- [ ] 上边距位置准确
- [ ] 左边距位置准确
- [ ] 右边距位置准确
- [ ] 下边距位置准确

#### 标题样式
- [ ] 标题字体与PDF一致（如：Microsoft JhengHei Bold）
- [ ] 标题字号与PDF一致（如：24px）
- [ ] 标题对齐方式与PDF一致（如：居中）
- [ ] 标题位置与PDF一致
- [ ] 标题行高与PDF一致

#### 正文样式
- [ ] 正文字体与PDF一致（如：Microsoft JhengHei）
- [ ] 正文字号与PDF一致（如：14px）
- [ ] 正文行高与PDF一致
- [ ] 段落缩进与PDF一致
- [ ] 字间距与PDF一致

#### 整体布局
- [ ] 整体版面布局与PDF一致
- [ ] 内容区域分布与PDF一致
- [ ] 板块划分与PDF一致
- [ ] 空间比例与PDF一致

---

### 场景3：智能选择 + 精确模式

**目的**：验证混合策略（先PDF解析，失败则Qwen增强）

**步骤**：
1. 选择教案
2. 上传PDF模板
3. 选择"智能选择（推荐）"
4. 选择"精确模式"
5. 点击"开始转换"

**期望结果A**（PDF解析成功）：
- ✅ 控制台输出：
  ```
  提取PDF精确样式数据...
  成功提取精确样式数据：1页
  尝试PDF解析填充（precise模式）...
  使用精确模式进行PDF解析和内容映射...
  ```
- ✅ 转换方法标识为 "pdf_parse_precise"

**期望结果B**（PDF解析失败，降级到Qwen）：
- ✅ 控制台输出：
  ```
  提取PDF精确样式数据...
  成功提取精确样式数据：1页
  尝试PDF解析填充（precise模式）...
  PDF解析失败，降级到Qwen: ...
  使用Qwen AI...
  已注入精确样式数据到Qwen prompt
  ```
- ✅ 转换方法标识为 "qwen_precise"

---

### 场景4：对比测试（关键）

**目的**：直观对比标准模式和精确模式的差异

**步骤**：
1. 使用同一个教案和PDF模板
2. 先用"强制Qwen + 标准模式"转换，保存HTML为 `test_standard.html`
3. 再用"强制Qwen + 精确模式"转换，保存HTML为 `test_precise.html`
4. 将两个HTML并排打开对比

**对比维度**：

| 对比项 | 标准模式 | 精确模式 | 改进 |
|--------|---------|---------|------|
| 页面宽度 | 可能不准 | 精确（如595.28px） | ✅ |
| 页面高度 | 可能不准 | 精确（如841.89px） | ✅ |
| 边距 | 估计值 | 精确值（如上56.69px） | ✅ |
| 标题字号 | 大概相似 | 精确（如24.0px） | ✅ |
| 标题对齐 | 可能对 | 确保准确 | ✅ |
| 正文字号 | 大概相似 | 精确（如14.0px） | ✅ |
| 行高 | 估计 | 精确（如21.00px） | ✅ |
| 段落缩进 | 可能不对 | 精确（如28.00px） | ✅ |

**期望**：精确模式在所有维度上都更接近原PDF

---

## 调试技巧

### 查看控制台日志

**浏览器控制台**（F12）：
- 查看前端请求和响应
- 查看错误信息

**后端控制台**：
- 查看Python服务日志
- 关键日志：
  - "提取PDF精确样式数据..."
  - "成功提取精确样式数据：X页"
  - "已注入精确样式数据到Qwen prompt"

### 验证精确数据提取

在 `pdf_parser.py` 中临时添加打印：

```python
def extract_precise_styles(pdf_bytes: bytes) -> Dict:
    # ...
    result = {"pages": pages_data}
    print(f"提取结果: {json.dumps(result, indent=2, ensure_ascii=False)}")
    return result
```

### 验证Prompt注入

在 `qwen_service.py` 中临时添加打印：

```python
async def convert_with_qwen_base64(...):
    # ...
    if precise_styles:
        print(f"精确样式数据预览:")
        print(f"  页面尺寸: {precise_styles['pages'][0]['width']} x {precise_styles['pages'][0]['height']}")
        print(f"  边距: {precise_styles['pages'][0]['margins']}")
    # ...
```

---

## 常见问题排查

### 问题1：控制台没有显示"提取PDF精确样式数据"

**可能原因**：
- 选择的不是"精确模式"
- 代码未正确修改

**排查**：
- 检查前端是否传递了 `precision: "precise"`
- 检查 `converter.py` 的修改是否正确

### 问题2：显示"精确样式提取失败"

**可能原因**：
- PDF文件损坏或格式特殊
- pdfplumber解析失败

**排查**：
- 检查后端完整错误堆栈
- 尝试其他PDF模板
- 确认pdfplumber已安装

### 问题3：有精确数据但板式还是不对

**可能原因**：
- Qwen API未按精确数据生成
- 精确数据提取不准确

**排查**：
- 打印实际发送给Qwen的prompt，确认数据已注入
- 检查提取的精确数据是否合理
- 尝试多次转换（AI有随机性）

### 问题4：方法显示"qwen"而非"qwen_precise"

**可能原因**：
- 精确数据提取失败但被捕获
- precise_styles为None或空

**排查**：
- 检查控制台是否有"成功提取精确样式数据"
- 在 `converter.py` 中打印 `precise_styles` 的值

---

## 测试通过标准

### 基本功能测试（必须通过）

- [x] 场景1：标准模式正常工作
- [x] 场景2：精确模式能提取数据
- [x] 场景2：精确模式能注入数据到prompt
- [x] 场景2：精确模式返回"qwen_precise"
- [x] 场景3：智能选择能正确降级

### 板式准确度测试（核心）

- [x] 页面尺寸误差 < 5px
- [x] 边距位置误差 < 5px
- [x] 标题字号误差 < 2px
- [x] 正文字号误差 < 1px
- [x] 行高误差 < 3px
- [x] 整体布局视觉一致

### 对比改进测试

- [x] 精确模式比标准模式更准确
- [x] 用户能明显感知到改进
- [x] 整体板式"一模一样"

---

## 测试报告模板

```markdown
## 测试报告

**测试日期**: 2026-02-12
**测试人员**: [姓名]
**测试环境**: 
- OS: Windows 11
- Python: 3.x
- 浏览器: Chrome

### 场景1：标准模式
- [ ] 通过 / [ ] 失败
- 备注: ___________

### 场景2：精确模式
- [ ] 通过 / [ ] 失败
- 控制台输出: ___________
- 板式准确度: ___________
- 备注: ___________

### 场景3：智能选择
- [ ] 通过 / [ ] 失败
- 执行路径: PDF解析成功 / 降级到Qwen
- 备注: ___________

### 场景4：对比测试
- 标准模式板式得分: ___/10
- 精确模式板式得分: ___/10
- 改进明显: [ ] 是 / [ ] 否
- 备注: ___________

### 总体评价
- 整体功能: [ ] 正常 / [ ] 异常
- 精确模式改进: [ ] 明显 / [ ] 一般 / [ ] 无改进
- 用户体验: [ ] 优秀 / [ ] 良好 / [ ] 一般 / [ ] 差
- 推荐上线: [ ] 是 / [ ] 否

### 问题和建议
___________
```

---

## 下一步

测试通过后：
1. ✅ 确认所有场景正常工作
2. ✅ 验证精确模式确实改进了板式准确度
3. ✅ 记录测试结果
4. ✅ 部署到生产环境（如需要）
5. ✅ 更新用户文档

---

**祝测试顺利！** 🎉

如有问题，请查看 `QWEN_PRECISE_ENHANCEMENT.md` 获取更多技术细节。
