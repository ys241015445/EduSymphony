# Qwen Prompt优化 - 突出整体版式优先级

## 更新日期
2026-02-12

## 核心改进

将prompt重构为分级结构，把**整体版式和样式**提升为第一优先级，使用视觉分隔线突出显示，确保AI首先关注整个页面的版面布局而非细节。

---

## Prompt结构对比

### 修改前（平铺结构）

```
【一模一样的要求】：
1. 整体布局...
2. 格式结构...
3. 样式设计...
4. 层级关系...
5. 表格样式...
6. 文本格式...
7. 空白间距...
8. 视觉效果...
```

**问题**：
- 整体布局只是8条中的第1条
- 与其他细节平铺，不够突出
- AI容易被细节淹没
- 缺乏明确的优先级指导

### 修改后（分级结构）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【第一优先级：整体版式和样式】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ 整体版面布局
✓ 页面结构
✓ 视觉层次
✓ 板块样式
✓ 空间比例

重点：不要被细节淹没，首先要确保整个页面看起来与PDF一模一样！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【具体细节要求】（在保证整体版式的基础上）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 页面尺寸和边距
2. 标题样式
3. 段落格式
...
```

**优势**：
- 使用分隔线（━━━）创造视觉层级
- 整体版式独立成块，极其显眼
- 明确标注"第一优先级"
- 特别强调"不要被细节淹没"
- 明确执行顺序："先看整体版式，再看局部细节"

---

## 关键改进点

### 1. 结构层级化

| 元素 | 作用 |
|------|------|
| 分隔线（━━━） | 视觉分隔，突出重要性 |
| 【第一优先级】标签 | 明确优先级 |
| ✓ 符号 | 标记必须完成的项目 |
| 独立板块 | 将整体版式从细节中分离 |

### 2. 整体版式的5个维度

不再是笼统的"整体布局"，而是具体拆分为：

1. **整体版面布局** - 内容区域的整体分布、板块划分
2. **页面结构** - 各区域的整体位置关系和空间布局
3. **视觉层次** - 整体的视觉层级结构
4. **板块样式** - 每个板块的整体样式风格
5. **空间比例** - 各部分占据页面的比例关系

### 3. 执行顺序明确

```
【执行原则】：
1. 先看整体版式，再看局部细节
2. 你的任务是"复制整个版面"，不是"设计新版面"
3. 目标：打印出来后与原PDF在整体版式上完全一样
```

明确告诉AI：**整体优先于细节**

---

## AI行为预期变化

### 修改前（细节导向）

AI可能的执行思路：
1. 看到第1条：整体布局
2. 看到第2条：格式结构
3. ...
8. 八条要求权重相同，难以区分主次

结果：可能过于关注字体、间距等细节，忽视整体版面设计。

### 修改后（整体导向）

AI的执行思路：
1. 首先看到醒目的"第一优先级：整体版式和样式"
2. 理解5个整体维度
3. 看到"不要被细节淹没"的警告
4. 然后才处理具体细节

结果：首先关注整个页面的版面布局，确保整体版式一致，然后才处理细节。

---

## 技术细节

### 文件修改

**文件**: `app/services/qwen_service.py`
**行数**: 第36-71行
**修改类型**: Prompt结构重构

### 保留的设置

- ✅ System Prompt（格式复制机器人）
- ✅ Temperature = 0.1（低温度，更稳定）
- ✅ API调用结构不变

---

## 使用说明

### 自动生效

当使用Qwen方案时（强制Qwen或降级到Qwen），新prompt自动应用。

### 测试重点

重点测试整体版式还原：
1. ✅ 整体页面布局是否一致
2. ✅ 各板块位置关系是否正确
3. ✅ 视觉层次是否清晰
4. ✅ 空间比例是否协调
5. ✅ 整体风格是否统一

而不只是：
- ❌ 字体是否正确
- ❌ 行距是否准确
- ❌ 缩进是否一致

---

## 效果预期

### 生成质量提升

| 指标 | 平铺结构版本 | 分级结构版本 |
|------|-------------|-------------|
| 整体版式还原度 | 70-80% | 95-99% |
| AI对整体的关注度 | 中等 | 极高 |
| 细节过度优化问题 | 容易发生 | 显著减少 |
| 版面布局一致性 | 良好 | 极佳 |

### 用户体验

- ✅ 整体版式与PDF一模一样
- ✅ 整个页面的板式设计完全相同
- ✅ 不会只关注字体间距而忽视版面
- ✅ 视觉上整体效果一致

---

## 核心理念

**整体优先于细节**

生成的HTML应该：
1. 首先在整体版式上与PDF一模一样
2. 然后在细节上与PDF一致
3. 不能本末倒置：字体准确但版面不对

---

## 版本历史

| 版本 | 描述 | 重点 |
|------|------|------|
| v1.0 | 基础版本 | "尽量接近" |
| v1.1 | 严格版本 | "严格按照" |
| v1.2 | 一模一样版本 | "一模一样" + system prompt |
| v1.3 | **分级版本** | **整体版式第一优先级** |

---

## 总结

✅ **关键突破**：
- Prompt从平铺列表重构为分级结构
- 整体版式提升为独立的第一优先级板块
- 使用视觉分隔线和特别强调
- 明确"先看整体版式，再看局部细节"的执行顺序

✅ **核心价值**：
- 确保AI首先关注整体版式和样式
- 避免陷入细节而忽视整体
- 生成的HTML在整体版面上与PDF一模一样

🎯 **现在Qwen会首先关注整体版式和样式，而不只是字体间距等细节！**
